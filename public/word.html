<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NinjaWord - Document Editor</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    .zoom-controls { display: flex; align-items: center; gap: 0.5rem; }
    .zoom-btn { padding: 0.25rem 0.5rem; cursor: pointer; }
    .zoom-display { min-width: 50px; text-align: center; font-size: 0.85rem; }
    .find-replace-bar { background: #fff3cd; padding: 0.5rem 1rem; display: none; align-items: center; gap: 0.5rem; border-bottom: 1px solid #ffc107; }
    .find-replace-bar input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; width: 150px; }
    .find-replace-bar .count { font-size: 0.85rem; color: #666; min-width: 60px; }
    .ruler { height: 25px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; align-items: flex-end; padding: 0 1in; }
    .ruler-mark { font-size: 9px; color: #666; border-left: 1px solid #999; padding-left: 2px; height: 10px; }
    .ruler-mark.major { height: 15px; font-weight: bold; }
    .page-number { position: absolute; bottom: 0.5in; width: 100%; text-align: center; font-size: 12px; color: #666; }
    .header-area { min-height: 0.5in; border-bottom: 1px dashed #ccc; margin-bottom: 0.25in; color: #666; font-size: 11px; }
    .footer-area { min-height: 0.5in; border-top: 1px dashed #ccc; margin-top: 0.25in; color: #666; font-size: 11px; }
    .highlight-find { background: #ffeb3b; }
    .highlight-current { background: #ff9800; color: white; }
    /* Style buttons */
    .style-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #ddd; background: #f9f9f9; border-radius: 3px; cursor: pointer; }
    .style-btn:hover { background: #e8f0fe; border-color: #1a73e8; }
    /* Navigation Pane */
    .navigation-pane { position: fixed; left: 0; top: 150px; width: 250px; height: calc(100vh - 200px); background: white; border-right: 1px solid #ddd; box-shadow: 2px 0 8px rgba(0,0,0,0.1); z-index: 100; overflow-y: auto; display: none; }
    .navigation-pane.visible { display: block; }
    .nav-pane-header { padding: 0.75rem 1rem; background: #f5f5f5; border-bottom: 1px solid #ddd; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .nav-pane-tabs { display: flex; border-bottom: 1px solid #ddd; }
    .nav-pane-tab { flex: 1; padding: 0.5rem; text-align: center; cursor: pointer; font-size: 0.85rem; border-bottom: 2px solid transparent; }
    .nav-pane-tab.active { border-bottom-color: #1a73e8; color: #1a73e8; }
    .nav-pane-content { padding: 0.5rem; }
    .nav-item { padding: 0.5rem; cursor: pointer; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    .nav-item:hover { background: #e8f0fe; }
    .nav-item.h1 { font-weight: bold; font-size: 1rem; }
    .nav-item.h2 { padding-left: 1rem; }
    .nav-item.h3 { padding-left: 1.5rem; font-size: 0.85rem; color: #666; }
    /* Styles Gallery */
    .styles-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .style-preview { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; }
    .style-preview:hover { border-color: #1a73e8; background: #e8f0fe; }
    .style-preview.selected { border-color: #1a73e8; background: #e8f0fe; }
    /* Line Numbers */
    .line-numbers-gutter {
      position: absolute;
      left: 0;
      top: 0;
      width: 40px;
      background: #f9f9f9;
      border-right: 1px solid #ddd;
      padding: 1in 0;
      text-align: right;
      font-family: monospace;
      font-size: 10px;
      color: #999;
      line-height: 1.5;
      display: none;
    }
    .line-numbers-gutter.visible { display: block; }
    .line-numbers-gutter .line-num {
      padding-right: 8px;
      height: 1.5em;
    }
    .document-area.with-line-numbers {
      margin-left: 50px;
    }
    /* Dark Mode */
    body.dark-mode {
      background: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .app-container {
      background: #1e1e1e;
    }
    body.dark-mode .app-header {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .ribbon {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .ribbon-tab {
      color: #cccccc;
    }
    body.dark-mode .ribbon-tab.active {
      background: #3c3c3c;
      color: #ffffff;
    }
    body.dark-mode .toolbar {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .toolbar-btn {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .toolbar-btn:hover {
      background: #505050;
      color: #ffffff;
    }
    body.dark-mode .toolbar-select {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .document-area {
      background: #2d2d2d;
    }
    body.dark-mode .document-page {
      background: #1e1e1e;
      color: #e0e0e0;
      border-color: #3c3c3c;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    body.dark-mode .ruler {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .ruler-mark {
      color: #999;
      border-color: #666;
    }
    body.dark-mode .status-bar {
      background: #007acc;
      color: #ffffff;
    }
    body.dark-mode .dropdown-menu {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .dropdown-item {
      color: #cccccc;
    }
    body.dark-mode .dropdown-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .file-name {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .modal-content {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    body.dark-mode .modal-content input,
    body.dark-mode .modal-content select,
    body.dark-mode .modal-content textarea {
      background: #3c3c3c;
      color: #e0e0e0;
      border-color: #505050;
    }
    body.dark-mode .navigation-pane {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .nav-pane-header {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .nav-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .find-replace-bar {
      background: #3c3c3c;
      border-color: #505050;
    }
    body.dark-mode .line-numbers-gutter {
      background: #252526;
      border-color: #3c3c3c;
      color: #666;
    }
    body.dark-mode .header-area,
    body.dark-mode .footer-area {
      border-color: #505050;
      color: #888;
    }
    body.dark-mode .toast {
      background: #3c3c3c;
      color: #e0e0e0;
    }
    /* Outline View */
    .outline-panel {
      position: fixed;
      left: 0;
      top: 150px;
      width: 320px;
      height: calc(100vh - 200px);
      background: white;
      border-right: 1px solid #ddd;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      z-index: 100;
      overflow-y: auto;
      display: none;
    }
    .outline-panel.visible { display: block; }
    .outline-header {
      padding: 0.75rem 1rem;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .outline-toolbar {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      background: #f9f9f9;
      border-bottom: 1px solid #eee;
    }
    .outline-toolbar button {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      border: 1px solid #ddd;
      background: white;
      border-radius: 3px;
      cursor: pointer;
    }
    .outline-toolbar button:hover { background: #e8f0fe; }
    .outline-content { padding: 0.5rem; }
    .outline-item {
      padding: 0.4rem 0.5rem;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
    }
    .outline-item:hover { background: #e8f0fe; }
    .outline-item.selected { background: #c8dcf8; }
    .outline-item.dragging { opacity: 0.5; background: #fff3cd; }
    .outline-item .collapse-btn {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
    }
    .outline-item .collapse-btn:empty { width: 16px; }
    .outline-item.collapsed .children { display: none; }
    .outline-item .level-indicator {
      font-size: 0.7rem;
      color: #666;
      background: #eee;
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
    }
    .outline-item .text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .outline-item.h1 { font-weight: bold; font-size: 1rem; }
    .outline-item.h2 { padding-left: 1.25rem; font-size: 0.95rem; }
    .outline-item.h3 { padding-left: 2rem; font-size: 0.9rem; color: #444; }
    .outline-item.h4 { padding-left: 2.75rem; font-size: 0.85rem; color: #666; }
    .outline-item.body-text { padding-left: 3.5rem; font-size: 0.8rem; color: #888; font-style: italic; }
    .outline-drop-zone {
      height: 4px;
      background: transparent;
      margin: 2px 0;
      border-radius: 2px;
      transition: background 0.2s;
    }
    .outline-drop-zone.active { background: #1a73e8; }
    body.dark-mode .outline-panel {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .outline-header {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .outline-toolbar {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .outline-toolbar button {
      background: #3c3c3c;
      color: #ccc;
      border-color: #505050;
    }
    body.dark-mode .outline-item:hover { background: #3c3c3c; }
    body.dark-mode .outline-item.selected { background: #264f78; }
    /* Reading Progress Bar */
    .reading-progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 0%;
      height: 4px;
      background: linear-gradient(90deg, #1a73e8, #34a853);
      z-index: 9999;
      transition: width 0.3s ease;
    }
    .reading-progress-info {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 200px;
      display: none;
    }
    .reading-progress-info.visible { display: block; }
    .reading-progress-info h4 {
      margin: 0 0 0.75rem 0;
      font-size: 0.9rem;
      color: var(--secondary);
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    .reading-stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    .reading-stat label { color: var(--secondary); }
    .reading-stat span { font-weight: 500; color: #333; }
    body.dark-mode .reading-progress-info {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .reading-stat span { color: #e0e0e0; }
    /* Focus Mode */
    body.focus-mode .app-header,
    body.focus-mode .ribbon,
    body.focus-mode .toolbar,
    body.focus-mode .status-bar,
    body.focus-mode .navigation-pane,
    body.focus-mode .outline-panel,
    body.focus-mode .find-replace-bar,
    body.focus-mode .ruler {
      display: none !important;
    }
    body.focus-mode .document-area {
      margin: 0 !important;
      padding: 2rem;
      background: #f5f0e8;
      min-height: 100vh;
    }
    body.focus-mode .document-page {
      max-width: 700px;
      margin: 0 auto;
      padding: 3rem;
      box-shadow: none;
      border: none;
      background: #f5f0e8;
      font-size: 1.2rem;
      line-height: 1.8;
    }
    body.focus-mode.dark-mode .document-area {
      background: #1a1a1a;
    }
    body.focus-mode.dark-mode .document-page {
      background: #1a1a1a;
      color: #d4d4d4;
    }
    .focus-mode-bar {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 30px;
      display: none;
      align-items: center;
      gap: 1rem;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    body.focus-mode .focus-mode-bar { display: flex; }
    .focus-mode-bar button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .focus-mode-bar button:hover { background: rgba(255,255,255,0.3); }
    /* Read Aloud highlight */
    .read-aloud-highlight {
      background: #ffeb3b;
      border-radius: 2px;
      transition: background 0.2s;
    }
    body.dark-mode .read-aloud-highlight {
      background: #ffc107;
      color: #000;
    }
    /* Keyboard Shortcuts Styles */
    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    .shortcuts-section h4 {
      margin: 0 0 0.75rem 0;
      color: #1a73e8;
      font-size: 0.95rem;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 0.5rem;
    }
    .shortcut-item {
      display: flex;
      align-items: center;
      padding: 0.4rem 0;
      font-size: 0.85rem;
    }
    .shortcut-item kbd {
      background: #f1f3f4;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      margin: 0 0.25rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .shortcut-item span {
      margin-left: auto;
      color: #666;
    }
    body.dark-mode .shortcuts-section h4 {
      color: #4da3ff;
      border-color: #3c3c3c;
    }
    body.dark-mode .shortcut-item kbd {
      background: #3c3c3c;
      border-color: #505050;
      color: #ccc;
    }
    body.dark-mode .shortcut-item span { color: #999; }
    /* Table Grid Selector */
    .table-grid-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    .table-grid {
      display: grid;
      grid-template-columns: repeat(10, 24px);
      grid-template-rows: repeat(8, 24px);
      gap: 2px;
      margin-bottom: 1rem;
    }
    .table-grid-cell {
      width: 24px;
      height: 24px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      transition: background 0.1s;
    }
    .table-grid-cell.highlighted {
      background: #cce5ff;
      border-color: #1a73e8;
    }
    .table-grid-cell:hover {
      background: #e3f2fd;
    }
    .table-size-display {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1rem;
    }
    .table-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      width: 100%;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    body.dark-mode .table-grid-cell {
      border-color: #555;
      background: #2d2d2d;
    }
    body.dark-mode .table-grid-cell.highlighted {
      background: #1a4a7a;
      border-color: #4da3ff;
    }
    body.dark-mode .table-grid-cell:hover {
      background: #3d5a80;
    }
    body.dark-mode .table-size-display { color: #999; }
    body.dark-mode .table-options { border-color: #444; }
    /* Submenu styles */
    .submenu-parent {
      position: relative;
    }
    .submenu {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 220px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1001;
    }
    .submenu.show {
      display: block;
    }
    .submenu-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .submenu-item:hover {
      background: #f0f0f0;
    }
    .submenu-item .file-date {
      font-size: 0.75rem;
      color: #888;
    }
    .submenu-empty {
      padding: 12px;
      color: #888;
      font-style: italic;
      text-align: center;
    }
    body.dark-mode .submenu {
      background: #2d2d2d;
      border-color: #444;
    }
    body.dark-mode .submenu-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .submenu-item .file-date {
      color: #888;
    }
    /* Symbol Picker Styles */
    .symbol-grid {
      display: grid;
      grid-template-columns: repeat(16, 1fr);
      gap: 2px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px;
      background: #fafafa;
    }
    .symbol-btn {
      width: 32px;
      height: 32px;
      border: 1px solid transparent;
      background: white;
      cursor: pointer;
      font-size: 1.1rem;
      border-radius: 4px;
      transition: all 0.15s;
    }
    .symbol-btn:hover {
      background: #e3f2fd;
      border-color: #1a73e8;
    }
    .symbol-category-tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .symbol-category-tab {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .symbol-category-tab.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }
    .symbol-preview {
      text-align: center;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .symbol-preview-char {
      font-size: 3rem;
      line-height: 1;
    }
    .symbol-preview-info {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }
    body.dark-mode .symbol-grid { background: #1e1e1e; border-color: #444; }
    body.dark-mode .symbol-btn { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .symbol-btn:hover { background: #3d5a80; }
    body.dark-mode .symbol-category-tab { background: #2d2d2d; border-color: #444; color: #ccc; }
    body.dark-mode .symbol-category-tab.active { background: #1a73e8; color: white; }
    body.dark-mode .symbol-preview { background: #2d2d2d; }
    body.dark-mode .symbol-preview-info { color: #999; }
    /* Quick Parts */
    .quickparts-category {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s;
    }
    .quickparts-category:last-child { border-bottom: none; }
    .quickparts-category:hover { background: #f0f0f0; }
    .quickparts-category.active {
      background: #1a73e8;
      color: white;
    }
    .quickpart-item {
      padding: 12px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quickpart-item:hover {
      border-color: #1a73e8;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .quickpart-item.selected {
      border-color: #1a73e8;
      background: #e3f2fd;
    }
    .quickpart-item-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .quickpart-item-preview {
      font-size: 0.75rem;
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .quickpart-item-actions {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    .quickpart-item-actions button {
      padding: 2px 8px;
      font-size: 0.7rem;
    }
    body.dark-mode .quickparts-category { border-color: #444; }
    body.dark-mode .quickparts-category:hover { background: #333; }
    body.dark-mode .quickpart-item { background: #2d2d2d; border-color: #444; }
    body.dark-mode .quickpart-item:hover { border-color: #1a73e8; }
    body.dark-mode .quickpart-item.selected { background: #1a3a5c; }
    body.dark-mode .quickpart-item-preview { color: #999; }
    /* Document Inspector */
    .inspector-item {
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }
    .inspector-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .inspector-result {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 0.85rem;
      display: none;
    }
    .inspector-result.found {
      display: block;
      background: #fff3cd;
      border-left: 3px solid #ffc107;
    }
    .inspector-result.clean {
      display: block;
      background: #d4edda;
      border-left: 3px solid #28a745;
    }
    body.dark-mode .inspector-item { border-color: #444; }
    body.dark-mode .inspector-result { background: #2d2d2d; }
    body.dark-mode .inspector-result.found { background: #3d3520; }
    body.dark-mode .inspector-result.clean { background: #1d3d2d; }
    /* Digital Signature */
    .signature-type-btn.active {
      background: #1a73e8 !important;
      color: white !important;
    }
    .signature-panel { margin-top: 1rem; }
    .digital-signature-block {
      display: inline-block;
      padding: 1rem;
      border: 2px solid #1a73e8;
      border-radius: 8px;
      background: linear-gradient(to bottom, #f8f9fa 0%, #fff 100%);
      margin: 1rem 0;
      min-width: 250px;
    }
    .digital-signature-block .sig-image {
      max-height: 80px;
      display: block;
      margin-bottom: 0.5rem;
    }
    .digital-signature-block .sig-info {
      font-size: 0.85rem;
      border-top: 1px solid #ddd;
      padding-top: 0.5rem;
      color: #333;
    }
    .digital-signature-block .sig-name {
      font-weight: 600;
    }
    .digital-signature-block .sig-title {
      color: #666;
      font-style: italic;
    }
    .digital-signature-block .sig-date {
      font-size: 0.75rem;
      color: #999;
      margin-top: 4px;
    }
    .digital-signature-block .sig-verification {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: #28a745;
      margin-top: 4px;
    }
    /* Reading Mode */
    .reading-mode-overlay {
      position: fixed;
      inset: 0;
      background: #f5f0e6;
      z-index: 2000;
      display: none;
      flex-direction: column;
    }
    .reading-mode-overlay.active { display: flex; }
    .reading-mode-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.05);
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .reading-mode-content {
      flex: 1;
      overflow-y: auto;
      padding: 3rem;
      display: flex;
      justify-content: center;
    }
    .reading-mode-text {
      max-width: 700px;
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 1.2rem;
      line-height: 1.8;
      color: #333;
    }
    .reading-mode-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .reading-mode-controls button {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(0,0,0,0.2);
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .reading-mode-controls button:hover { background: #f0f0f0; }
    .reading-mode-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: #1a73e8;
      transition: width 0.1s;
      z-index: 2001;
    }
    .reading-mode-overlay.sepia { background: #f5f0e6; }
    .reading-mode-overlay.sepia .reading-mode-text { color: #5c4b37; }
    .reading-mode-overlay.dark { background: #1e1e1e; }
    .reading-mode-overlay.dark .reading-mode-text { color: #e0e0e0; }
    .reading-mode-overlay.dark .reading-mode-header { background: rgba(255,255,255,0.05); border-color: #333; }
    .reading-mode-overlay.dark .reading-mode-controls button { background: #333; color: #e0e0e0; border-color: #555; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="app-header">
      <a href="/" class="app-logo">
        <div class="app-logo-icon word">W</div>
        <span class="app-title">NinjaWord</span>
      </a>
      <input type="text" class="file-name" id="fileName" value="Untitled Document">
      <div class="header-actions">
        <div class="dropdown">
          <button class="btn btn-secondary" onclick="toggleFileMenu()">üìÅ File ‚ñæ</button>
          <div class="dropdown-menu" id="fileMenu">
            <div class="dropdown-item" onclick="newDocument()">üìÑ New</div>
            <div class="dropdown-item" onclick="showOpenDialog()">üìÇ Open...</div>
            <div class="dropdown-item" onclick="saveDocument()">üíæ Save</div>
            <div class="dropdown-item" onclick="saveDocumentAs()">üíæ Save As...</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item submenu-parent" onclick="toggleRecentFiles(event)">
              üïí Recent Files ‚ñ∏
              <div class="submenu" id="recentFilesMenu"></div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="exportToFile()">üì§ Export as File</div>
            <div class="dropdown-item" onclick="importFromFile()">üì• Import from File</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="importDocx()">üìÑ Import DOCX</div>
            <div class="dropdown-item" onclick="exportDocx()">üìÑ Export DOCX</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="showDocumentInspector()">üîç Document Inspector</div>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="showFindReplace()">üîç Find</button>
        <button class="btn btn-secondary" onclick="showTemplates()">Templates</button>
        <button class="btn btn-secondary" onclick="showMailMerge()">Mail Merge</button>
        <button class="btn btn-primary" onclick="exportPDF()">Export PDF</button>
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
          <span class="zoom-display" id="zoomLevel">100%</span>
          <button class="zoom-btn" onclick="zoomIn()">+</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tab-container">
      <button class="tab active" data-tab="home">Home</button>
      <button class="tab" data-tab="insert">Insert</button>
      <button class="tab" data-tab="review">Review</button>
      <button class="tab" data-tab="view">View</button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="homeToolbar">
      <div class="toolbar-group">
        <select class="toolbar-select" id="fontFamily" onchange="formatDoc('fontName', this.value)">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Georgia">Georgia</option>
          <option value="Verdana">Verdana</option>
          <option value="Courier New">Courier New</option>
          <option value="Comic Sans MS">Comic Sans MS</option>
        </select>
        <select class="toolbar-select" id="fontSize" onchange="formatDoc('fontSize', this.value)">
          <option value="1">8</option>
          <option value="2">10</option>
          <option value="3" selected>12</option>
          <option value="4">14</option>
          <option value="5">18</option>
          <option value="6">24</option>
          <option value="7">36</option>
        </select>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
        <button class="toolbar-btn" onclick="formatDoc('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
        <button class="toolbar-btn" onclick="formatDoc('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
        <button class="toolbar-btn" onclick="formatDoc('strikeThrough')" title="Strikethrough"><s>S</s></button>
        <button class="toolbar-btn" onclick="showChangeCaseMenu(event)" title="Change Case">Aa</button>
      </div>

      <div class="toolbar-group">
        <input type="color" class="color-picker-btn" id="textColor" value="#000000" onchange="formatDoc('foreColor', this.value)" title="Text Color">
        <input type="color" class="color-picker-btn" id="bgColor" value="#ffffff" onchange="formatDoc('hiliteColor', this.value)" title="Highlight">
        <button class="toolbar-btn" onclick="showHighlightPalette(event)" title="Highlight Colors">üñçÔ∏è</button>
        <button class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">üßπ</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('justifyLeft')" title="Align Left">‚â°</button>
        <button class="toolbar-btn" onclick="formatDoc('justifyCenter')" title="Center">‚â°</button>
        <button class="toolbar-btn" onclick="formatDoc('justifyRight')" title="Align Right">‚â°</button>
        <button class="toolbar-btn" onclick="formatDoc('justifyFull')" title="Justify">‚â°</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('insertUnorderedList')" title="Bullet List">‚Ä¢</button>
        <button class="toolbar-btn" onclick="formatDoc('insertOrderedList')" title="Numbered List">#</button>
        <button class="toolbar-btn" onclick="formatDoc('outdent')" title="Decrease Indent">‚Üê</button>
        <button class="toolbar-btn" onclick="formatDoc('indent')" title="Increase Indent">‚Üí</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('undo')" title="Undo (Ctrl+Z)">‚Ü∂</button>
        <button class="toolbar-btn" onclick="formatDoc('redo')" title="Redo (Ctrl+Y)">‚Ü∑</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" id="trackChangesBtn" onclick="toggleTrackChanges()" title="Track Changes">üìù</button>
        <button class="toolbar-btn" onclick="runSpellCheck()" title="Spell Check">ABC</button>
      </div>

      <div class="toolbar-group" id="stylesGroup" style="gap: 0.25rem;">
        <button class="style-btn" onclick="applyStyle('normal')" title="Normal">Normal</button>
        <button class="style-btn" onclick="applyStyle('heading1')" title="Heading 1">H1</button>
        <button class="style-btn" onclick="applyStyle('heading2')" title="Heading 2">H2</button>
        <button class="style-btn" onclick="applyStyle('heading3')" title="Heading 3">H3</button>
        <button class="style-btn" onclick="applyStyle('title')" title="Title">Title</button>
        <button class="style-btn" onclick="applyStyle('subtitle')" title="Subtitle">Sub</button>
        <button class="toolbar-btn" onclick="showStylesGallery()" title="More Styles">‚ñæ Styles</button>
      </div>
    </div>

    <!-- Insert Toolbar -->
    <div class="toolbar" id="insertToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertTable()" title="Insert Table">‚äû</button>
        <button class="toolbar-btn" onclick="insertImage()" title="Insert Image">üñº</button>
        <button class="toolbar-btn" onclick="insertScreenshot()" title="Screenshot">üì∏ Screenshot</button>
        <button class="toolbar-btn" onclick="insertLink()" title="Insert Link">üîó</button>
        <button class="toolbar-btn" onclick="insertHorizontalRule()" title="Horizontal Line">‚Äî</button>
        <button class="toolbar-btn" onclick="showTextBoxModal()" title="Insert Text Box">üì¶ Text Box</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertTableOfContents()" title="Table of Contents">üìë TOC</button>
        <button class="toolbar-btn" onclick="insertFootnote()" title="Insert Footnote">¬π Footnote</button>
        <button class="toolbar-btn" onclick="insertBookmark()" title="Insert Bookmark">üîñ Bookmark</button>
        <button class="toolbar-btn" onclick="showIndexModal()" title="Index">üìá Index</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertPageBreak()" title="Page Break">üìÑ Page</button>
        <button class="toolbar-btn" onclick="insertSectionBreak()" title="Section Break">¬ß Section</button>
        <button class="toolbar-btn" onclick="insertDateTime()" title="Date/Time">üìÖ</button>
        <button class="toolbar-btn" onclick="insertWatermark()" title="Insert Watermark">üíß Watermark</button>
        <button class="toolbar-btn" onclick="setColumns()" title="Columns">‚´º Columns</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showPageBorders()" title="Page Borders">‚ñ¢ Borders</button>
        <button class="toolbar-btn" onclick="insertDropCap()" title="Drop Cap">D</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showWordArt()" title="Word Art">üé® Word Art</button>
        <button class="toolbar-btn" onclick="showEquationEditor()" title="Equation">‚àë Equation</button>
        <button class="toolbar-btn" onclick="showSmartArt()" title="Smart Art">üìä Smart Art</button>
        <button class="toolbar-btn" onclick="showSymbolPicker()" title="Insert Symbol">Œ© Symbol</button>
        <button class="toolbar-btn" onclick="showQuickParts()" title="Quick Parts / AutoText">üìã Quick Parts</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertMergeField('FirstName')" title="First Name Field">{{First}}</button>
        <button class="toolbar-btn" onclick="insertMergeField('LastName')" title="Last Name Field">{{Last}}</button>
      </div>
    </div>

    <!-- Review Toolbar -->
    <div class="toolbar" id="reviewToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="runSpellCheck()" title="Spell Check">üî§ Spell Check</button>
        <button class="toolbar-btn" onclick="runGrammarCheck()" title="Grammar Check">üìù Grammar</button>
        <button class="toolbar-btn active" id="autoCorrectBtn" onclick="toggleAutoCorrect()" title="Auto-Correct">‚ú® Auto-Correct</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" id="trackChangesBtn2" onclick="toggleTrackChanges()" title="Track Changes">üìù Track Changes</button>
        <button class="toolbar-btn" onclick="acceptAllChanges()" title="Accept All">‚úì Accept All</button>
        <button class="toolbar-btn" onclick="rejectAllChanges()" title="Reject All">‚úó Reject All</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="addComment()" title="New Comment">üí¨ Comment</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showCompareDocuments()" title="Compare Documents">‚öñ Compare</button>
        <button class="toolbar-btn" onclick="showRevisionHistory()" title="Revision History">üìú History</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showWordCount()" title="Word Count">üìä Word Count</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showDigitalSignature()" title="Digital Signature">‚úçÔ∏è Signature</button>
      </div>
    </div>

    <!-- View Toolbar -->
    <div class="toolbar" id="viewToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleRuler()" title="Toggle Ruler">üìè Ruler</button>
        <button class="toolbar-btn" onclick="showPageSetup()" title="Page Setup">üìÑ Page Setup</button>
        <button class="toolbar-btn" onclick="toggleHeaderFooter()" title="Edit Header/Footer">üìù Header/Footer</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleNavigationPane()" title="Navigation Pane" id="navPaneBtn">üìë Navigation</button>
        <button class="toolbar-btn" onclick="toggleOutlineView()" title="Outline View" id="outlineViewBtn">‚â° Outline</button>
        <button class="toolbar-btn" onclick="showAdvancedFind()" title="Advanced Find & Replace">üîç Advanced Find</button>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Line Spacing:</span>
        <select class="toolbar-select" id="lineSpacing" onchange="setLineSpacing(this.value)">
          <option value="1">Single</option>
          <option value="1.15">1.15</option>
          <option value="1.5" selected>1.5</option>
          <option value="2">Double</option>
          <option value="2.5">2.5</option>
          <option value="3">Triple</option>
        </select>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Paragraph:</span>
        <button class="toolbar-btn" onclick="setParagraphSpacing('before')" title="Space Before">‚Üë Before</button>
        <button class="toolbar-btn" onclick="setParagraphSpacing('after')" title="Space After">‚Üì After</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showStylesPanel()" title="Styles">üé® Styles</button>
        <button class="toolbar-btn" onclick="togglePrintPreview()" title="Print Preview">üñ® Preview</button>
        <button class="toolbar-btn" onclick="toggleLineNumbers()" title="Line Numbers" id="lineNumBtn">123 Lines</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleDarkMode()" title="Dark Mode" id="darkModeBtn">üåô Dark Mode</button>
        <button class="toolbar-btn" onclick="toggleFocusMode()" title="Focus Mode" id="focusModeBtn">üéØ Focus</button>
        <button class="toolbar-btn" onclick="toggleReadingMode()" title="Reading Mode" id="readingModeBtn">üìñ Reading</button>
        <button class="toolbar-btn" onclick="toggleReadAloud()" title="Read Aloud" id="readAloudBtn">üîä Read</button>
        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts (F1)">‚å® Shortcuts</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleReadingProgress()" title="Reading Progress" id="readingProgressBtn">üìä Progress</button>
        <button class="toolbar-btn" onclick="showDocumentStatistics()" title="Document Statistics">üìà Statistics</button>
      </div>
    </div>

    <!-- Find & Replace Bar -->
    <div class="find-replace-bar" id="findReplaceBar">
      <span>Find:</span>
      <input type="text" id="findInput" placeholder="Search..." onkeyup="findInDocument()">
      <span class="count" id="findCount">0 results</span>
      <button class="toolbar-btn" onclick="findPrev()" title="Previous">‚óÄ</button>
      <button class="toolbar-btn" onclick="findNext()" title="Next">‚ñ∂</button>
      <span style="margin-left: 1rem;">Replace:</span>
      <input type="text" id="replaceInput" placeholder="Replace with...">
      <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem;" onclick="replaceOne()">Replace</button>
      <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem;" onclick="replaceAll()">Replace All</button>
      <button class="toolbar-btn" onclick="hideFindReplace()" title="Close">‚úï</button>
    </div>

    <!-- Ruler -->
    <div class="ruler" id="ruler">
      <div class="ruler-mark major" style="width: 96px;">0</div>
      <div class="ruler-mark" style="width: 96px;">1</div>
      <div class="ruler-mark major" style="width: 96px;">2</div>
      <div class="ruler-mark" style="width: 96px;">3</div>
      <div class="ruler-mark major" style="width: 96px;">4</div>
      <div class="ruler-mark" style="width: 96px;">5</div>
      <div class="ruler-mark major" style="width: 96px;">6</div>
      <div class="ruler-mark" style="width: 96px;">7</div>
    </div>

    <!-- Main Content -->
    <div class="word-container">
      <div class="document-area" id="documentArea" style="position: relative;">
        <div class="line-numbers-gutter" id="lineNumbersGutter"></div>
        <div class="document" id="editor" contenteditable="true" spellcheck="true">
          <h1 style="text-align: center;">Welcome to NinjaWord</h1>
          <p>Start typing your document here. You can format text, add images, create lists, and much more!</p>
          <p>Use the toolbar above to:</p>
          <ul>
            <li><strong>Format text</strong> - Bold, italic, underline, and more</li>
            <li><strong>Change fonts</strong> - Select from various font families and sizes</li>
            <li><strong>Add colors</strong> - Text color and highlighting</li>
            <li><strong>Create lists</strong> - Bulleted and numbered lists</li>
            <li><strong>Insert elements</strong> - Tables, images, links</li>
          </ul>
          <p>Try the <strong>Track Changes</strong> feature to see edits, or export your document as a <strong>PDF</strong>!</p>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-section">
          <h3>Templates</h3>
          <div class="template-grid">
            <div class="template-item" onclick="loadTemplate('blank')">Blank</div>
            <div class="template-item" onclick="loadTemplate('letter')">Letter</div>
            <div class="template-item" onclick="loadTemplate('resume')">Resume</div>
            <div class="template-item" onclick="loadTemplate('report')">Report</div>
          </div>
        </div>

        <div class="sidebar-section" id="outlinePanel">
          <h3>Document Outline</h3>
          <div id="outlineList" style="font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
            <p style="color: var(--secondary);">No headings found</p>
          </div>
          <button class="btn btn-secondary" onclick="refreshOutline()" style="width: 100%; margin-top: 0.5rem; padding: 0.3rem;">Refresh</button>
        </div>

        <div class="sidebar-section" id="trackChangesPanel" style="display: none;">
          <h3>Track Changes</h3>
          <div class="track-changes-panel">
            <div id="changesList"></div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Document Stats</h3>
          <div id="docStats" style="font-size: 0.9rem; color: var(--secondary);">
            <p>Words: <span id="wordCount">0</span></p>
            <p>Characters: <span id="charCount">0</span></p>
            <p>Paragraphs: <span id="paraCount">0</span></p>
            <p>Reading Time: <span id="readingTime">0</span> min</p>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Spelling</h3>
          <div id="spellingSuggestions" style="font-size: 0.9rem;"></div>
          <button class="btn btn-secondary" onclick="runSpellCheck()" style="width: 100%; margin-top: 0.5rem; padding: 0.3rem;">Check Spelling</button>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <span id="statusLeft">Ready | <span id="langIndicator" title="Language">English (US)</span></span>
      <span id="statusCenter" style="cursor: pointer;" onclick="showWordCount()" title="Click for detailed word count">Words: 0 | Characters: 0</span>
      <span id="statusRight">Page <span id="currentPage">1</span> of <span id="totalPages">1</span> | <span id="statusZoom">100%</span></span>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div class="modal-overlay" id="shortcutsModal">
    <div class="modal" style="max-width: 700px; max-height: 80vh;">
      <div class="modal-header">
        <h3>Keyboard Shortcuts</h3>
        <button class="modal-close" onclick="hideKeyboardShortcuts()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div class="shortcuts-grid">
          <div class="shortcuts-section">
            <h4>File Operations</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>N</kbd> <span>New Document</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>O</kbd> <span>Open</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>S</kbd> <span>Save</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>P</kbd> <span>Print</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Editing</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Z</kbd> <span>Undo</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Y</kbd> <span>Redo</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>X</kbd> <span>Cut</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>C</kbd> <span>Copy</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>V</kbd> <span>Paste</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>A</kbd> <span>Select All</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Formatting</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>B</kbd> <span>Bold</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>I</kbd> <span>Italic</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>U</kbd> <span>Underline</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>E</kbd> <span>Center Align</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>L</kbd> <span>Left Align</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>R</kbd> <span>Right Align</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>J</kbd> <span>Justify</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Navigation</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>F</kbd> <span>Find</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>H</kbd> <span>Find & Replace</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Home</kbd> <span>Go to Beginning</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>End</kbd> <span>Go to End</span></div>
            <div class="shortcut-item"><kbd>F1</kbd> <span>Show Shortcuts</span></div>
            <div class="shortcut-item"><kbd>Esc</kbd> <span>Exit Focus Mode</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Watermark Modal -->
  <div class="modal-overlay" id="watermarkModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3>Insert Watermark</h3>
        <button class="modal-close" onclick="hideWatermarkModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="font-weight: 500;">Preset Watermarks:</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
            <button class="btn btn-secondary" onclick="setWatermarkPreset('DRAFT')">DRAFT</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('CONFIDENTIAL')">CONFIDENTIAL</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('SAMPLE')">SAMPLE</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('DO NOT COPY')">DO NOT COPY</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('URGENT')">URGENT</button>
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="font-weight: 500;">Custom Text:</label>
          <input type="text" id="watermarkText" class="form-control" value="DRAFT" style="margin-top: 0.5rem;">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label style="font-weight: 500;">Color:</label>
            <input type="color" id="watermarkColor" value="#cccccc" style="width: 100%; height: 36px; margin-top: 0.5rem;">
          </div>
          <div class="form-group">
            <label style="font-weight: 500;">Opacity:</label>
            <input type="range" id="watermarkOpacity" min="5" max="50" value="20" style="width: 100%; margin-top: 0.75rem;">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
          <div class="form-group">
            <label style="font-weight: 500;">Font Size:</label>
            <select id="watermarkSize" class="form-control" style="margin-top: 0.5rem;">
              <option value="48">Small (48px)</option>
              <option value="72" selected>Medium (72px)</option>
              <option value="96">Large (96px)</option>
              <option value="120">Extra Large (120px)</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-weight: 500;">Layout:</label>
            <select id="watermarkLayout" class="form-control" style="margin-top: 0.5rem;">
              <option value="diagonal" selected>Diagonal</option>
              <option value="horizontal">Horizontal</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="removeWatermark()">Remove Watermark</button>
        <button class="btn btn-primary" onclick="applyWatermark()">Apply Watermark</button>
      </div>
    </div>
  </div>

  <!-- Word Count Modal -->
  <div class="modal-overlay" id="wordCountModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Word Count</h3>
        <button class="modal-close" onclick="hideWordCount()">&times;</button>
      </div>
      <div class="modal-body">
        <table class="word-count-table" style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Pages</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcPages">1</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Words</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcWords">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Characters (no spaces)</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcCharsNoSpaces">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Characters (with spaces)</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcCharsWithSpaces">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Paragraphs</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcParagraphs">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Lines</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcLines">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem;">Reading Time</td>
            <td style="padding: 0.75rem; text-align: right; font-weight: 600;" id="wcReadTime">0 min</td>
          </tr>
        </table>
        <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
          <strong>Selection:</strong> <span id="wcSelectionInfo">No text selected</span>
        </p>
      </div>
      <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee; text-align: right;">
        <button class="btn btn-primary" onclick="hideWordCount()">Close</button>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div class="modal-overlay" id="templatesModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Choose a Template</h3>
        <button class="modal-close" onclick="hideTemplates()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="template-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="template-item" onclick="loadTemplate('blank'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
            Blank Document
          </div>
          <div class="template-item" onclick="loadTemplate('letter'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úâÔ∏è</div>
            Business Letter
          </div>
          <div class="template-item" onclick="loadTemplate('resume'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
            Resume
          </div>
          <div class="template-item" onclick="loadTemplate('report'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
            Report
          </div>
          <div class="template-item" onclick="loadTemplate('invoice'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíµ</div>
            Invoice
          </div>
          <div class="template-item" onclick="loadTemplate('meeting'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
            Meeting Notes
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mail Merge Modal -->
  <div class="modal-overlay" id="mailMergeModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Mail Merge</h3>
        <button class="modal-close" onclick="hideMailMerge()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem;">Insert merge fields in your document, then add recipient data below:</p>

        <div class="form-group">
          <label>Merge Fields Available:</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('FirstName')">{{FirstName}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('LastName')">{{LastName}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('Email')">{{Email}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('Company')">{{Company}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('Address')">{{Address}}</span>
          </div>
        </div>

        <div class="form-group">
          <label>Recipients (CSV format):</label>
          <textarea class="form-control" id="mergeData" rows="5" placeholder="FirstName,LastName,Email,Company,Address
John,Doe,john@example.com,Acme Inc,123 Main St
Jane,Smith,jane@example.com,Tech Corp,456 Oak Ave"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideMailMerge()">Cancel</button>
        <button class="btn btn-primary" onclick="previewMerge()">Preview Merge</button>
        <button class="btn btn-success" onclick="executeMerge()">Generate Documents</button>
      </div>
    </div>
  </div>

  <!-- Open Documents Modal -->
  <div class="modal-overlay" id="openModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Open Document</h3>
        <button class="modal-close" onclick="hideOpenDialog()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="savedDocsList" style="max-height: 400px; overflow-y: auto;">
          <p style="color: var(--secondary);">No saved documents yet.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideOpenDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Save As Modal -->
  <div class="modal-overlay" id="saveAsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Save Document As</h3>
        <button class="modal-close" onclick="hideSaveAs()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Document Name</label>
          <input type="text" class="form-control" id="saveAsName" placeholder="My Document">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSaveAs()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmSaveAs()">Save</button>
      </div>
    </div>
  </div>

  <!-- Page Setup Modal -->
  <div class="modal-overlay" id="pageSetupModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Page Setup</h3>
        <button class="modal-close" onclick="hidePageSetup()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Paper Size</label>
            <select class="form-control" id="paperSize" onchange="updatePagePreview()">
              <option value="letter">Letter (8.5" x 11")</option>
              <option value="a4">A4 (210mm x 297mm)</option>
              <option value="legal">Legal (8.5" x 14")</option>
            </select>
          </div>
          <div class="form-group">
            <label>Orientation</label>
            <select class="form-control" id="pageOrientation" onchange="updatePagePreview()">
              <option value="portrait">Portrait</option>
              <option value="landscape">Landscape</option>
            </select>
          </div>
        </div>
        <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Margins (inches)</h4>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
          <div class="form-group">
            <label>Top</label>
            <input type="number" class="form-control" id="marginTop" value="1" step="0.25" min="0">
          </div>
          <div class="form-group">
            <label>Bottom</label>
            <input type="number" class="form-control" id="marginBottom" value="1" step="0.25" min="0">
          </div>
          <div class="form-group">
            <label>Left</label>
            <input type="number" class="form-control" id="marginLeft" value="1" step="0.25" min="0">
          </div>
          <div class="form-group">
            <label>Right</label>
            <input type="number" class="form-control" id="marginRight" value="1" step="0.25" min="0">
          </div>
        </div>
        <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Header & Footer</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Header Text</label>
            <input type="text" class="form-control" id="headerText" placeholder="Document header...">
          </div>
          <div class="form-group">
            <label>Footer Text</label>
            <input type="text" class="form-control" id="footerText" placeholder="Document footer...">
          </div>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="showPageNumbers" checked> Show Page Numbers</label>
        </div>
        <div class="form-group">
          <label>Page Number Position</label>
          <select class="form-control" id="pageNumberPosition">
            <option value="bottom-center">Bottom Center</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="top-center">Top Center</option>
            <option value="top-right">Top Right</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePageSetup()">Cancel</button>
        <button class="btn btn-primary" onclick="applyPageSetup()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Styles Panel Modal -->
  <div class="modal-overlay" id="stylesModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Styles</h3>
        <button class="modal-close" onclick="hideStylesPanel()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Click a style to apply it to selected text.</p>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
          <div class="style-item" onclick="applyStyle('title')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 24px; font-weight: bold;">Title</div>
            <div style="font-size: 11px; color: var(--secondary);">28pt, Bold</div>
          </div>
          <div class="style-item" onclick="applyStyle('heading1')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 20px; font-weight: bold; color: #1a73e8;">Heading 1</div>
            <div style="font-size: 11px; color: var(--secondary);">20pt, Bold, Blue</div>
          </div>
          <div class="style-item" onclick="applyStyle('heading2')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 16px; font-weight: bold; color: #1a73e8;">Heading 2</div>
            <div style="font-size: 11px; color: var(--secondary);">16pt, Bold, Blue</div>
          </div>
          <div class="style-item" onclick="applyStyle('heading3')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 14px; font-weight: bold;">Heading 3</div>
            <div style="font-size: 11px; color: var(--secondary);">14pt, Bold</div>
          </div>
          <div class="style-item" onclick="applyStyle('normal')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 12px;">Normal</div>
            <div style="font-size: 11px; color: var(--secondary);">12pt, Regular</div>
          </div>
          <div class="style-item" onclick="applyStyle('quote')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 12px; font-style: italic; border-left: 3px solid #ccc; padding-left: 8px;">Quote</div>
            <div style="font-size: 11px; color: var(--secondary);">12pt, Italic, Indented</div>
          </div>
          <div class="style-item" onclick="applyStyle('subtitle')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 14px; color: #666;">Subtitle</div>
            <div style="font-size: 11px; color: var(--secondary);">14pt, Gray</div>
          </div>
          <div class="style-item" onclick="applyStyle('code')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 12px; font-family: monospace; background: #f5f5f5; padding: 4px;">Code</div>
            <div style="font-size: 11px; color: var(--secondary);">Monospace, Gray bg</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideStylesPanel()">Close</button>
      </div>
    </div>
  </div>

  <!-- Print Preview Modal -->
  <div class="modal-overlay" id="printPreviewModal">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Print Preview</h3>
        <button class="modal-close" onclick="hidePrintPreview()">&times;</button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: 70vh; background: #666; padding: 2rem;">
        <div id="printPreviewContent" style="background: white; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePrintPreview()">Close</button>
        <button class="btn btn-primary" onclick="window.print()">Print</button>
        <button class="btn btn-success" onclick="exportPDF(); hidePrintPreview();">Export PDF</button>
      </div>
    </div>
  </div>

  <!-- Page Borders Modal -->
  <div class="modal-overlay" id="pageBordersModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Page Borders</h3>
        <button class="modal-close" onclick="hidePageBorders()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Border Style</label>
          <select class="form-control" id="borderStyle">
            <option value="none">None</option>
            <option value="solid">Solid</option>
            <option value="dashed">Dashed</option>
            <option value="dotted">Dotted</option>
            <option value="double">Double</option>
            <option value="groove">Groove</option>
            <option value="ridge">Ridge</option>
            <option value="inset">Inset</option>
            <option value="outset">Outset</option>
          </select>
        </div>
        <div class="form-group">
          <label>Border Width</label>
          <select class="form-control" id="borderWidth">
            <option value="1px">Thin (1px)</option>
            <option value="2px" selected>Medium (2px)</option>
            <option value="3px">Thick (3px)</option>
            <option value="4px">Extra Thick (4px)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Border Color</label>
          <input type="color" class="form-control" id="borderColor" value="#000000" style="height: 40px;">
        </div>
        <div class="form-group">
          <label>Border Art (Decorative)</label>
          <select class="form-control" id="borderArt">
            <option value="none">None</option>
            <option value="shadow">Shadow Effect</option>
            <option value="rounded">Rounded Corners</option>
          </select>
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
          <label style="font-weight: bold;">Preview:</label>
          <div id="borderPreview" style="margin-top: 0.5rem; height: 100px; background: white;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePageBorders()">Cancel</button>
        <button class="btn btn-danger" onclick="removePageBorders()">Remove Borders</button>
        <button class="btn btn-primary" onclick="applyPageBorders()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Compare Documents Modal -->
  <div class="modal-overlay" id="compareModal">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Compare Documents</h3>
        <button class="modal-close" onclick="hideCompareDocuments()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div class="form-group">
            <label>Original Document</label>
            <select class="form-control" id="compareOriginal">
              <option value="current">Current Document</option>
            </select>
          </div>
          <div class="form-group">
            <label>Revised Document</label>
            <select class="form-control" id="compareRevised">
              <option value="">Select a document...</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Or paste text to compare:</label>
          <textarea class="form-control" id="compareText" rows="4" placeholder="Paste revised document text here..."></textarea>
        </div>
        <div id="compareResults" style="display: none; margin-top: 1rem;">
          <h4 style="margin-bottom: 0.5rem;">Comparison Results</h4>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <span style="background: #d4edda; padding: 2px 8px; border-radius: 3px;">+ Added</span>
            <span style="background: #f8d7da; padding: 2px 8px; border-radius: 3px; text-decoration: line-through;">- Removed</span>
            <span style="background: #fff3cd; padding: 2px 8px; border-radius: 3px;">~ Modified</span>
          </div>
          <div id="diffOutput" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); padding: 1rem; background: #f9f9f9; font-family: monospace; font-size: 13px; white-space: pre-wrap;"></div>
          <div style="margin-top: 1rem; padding: 0.5rem; background: #e9ecef; border-radius: 4px;">
            <strong>Summary:</strong> <span id="diffSummary"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCompareDocuments()">Close</button>
        <button class="btn btn-primary" onclick="runComparison()">Compare</button>
        <button class="btn btn-success" onclick="applyDiffToDocument()" id="applyDiffBtn" style="display: none;">Apply Changes</button>
      </div>
    </div>
  </div>

  <!-- Revision History Modal -->
  <div class="modal-overlay" id="revisionHistoryModal">
    <div class="modal" style="max-width: 700px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Revision History</h3>
        <button class="modal-close" onclick="hideRevisionHistory()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Document revisions are saved automatically. Click a revision to preview or restore.</p>
        <div id="revisionList" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideRevisionHistory()">Close</button>
        <button class="btn btn-primary" onclick="saveRevision()">Save Current as Revision</button>
      </div>
    </div>
  </div>

  <!-- Endnotes Modal -->
  <div class="modal-overlay" id="endnotesModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Insert Endnote</h3>
        <button class="modal-close" onclick="hideEndnotes()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Endnote Text</label>
          <textarea class="form-control" id="endnoteText" rows="3" placeholder="Enter endnote text..."></textarea>
        </div>
        <div class="form-group">
          <label>Numbering Style</label>
          <select class="form-control" id="endnoteNumbering">
            <option value="numeric">1, 2, 3...</option>
            <option value="roman">i, ii, iii...</option>
            <option value="alpha">a, b, c...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEndnotes()">Cancel</button>
        <button class="btn btn-primary" onclick="insertEndnote()">Insert Endnote</button>
      </div>
    </div>
  </div>

  <!-- Bibliography Modal -->
  <div class="modal-overlay" id="bibliographyModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Citations & Bibliography</h3>
        <button class="modal-close" onclick="hideBibliography()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 1rem;">
          <div style="flex: 1;">
            <h4 style="margin-bottom: 0.5rem;">Add Citation</h4>
            <div class="form-group">
              <label>Citation Type</label>
              <select class="form-control" id="citationType">
                <option value="book">Book</option>
                <option value="journal">Journal Article</option>
                <option value="website">Website</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Author(s)</label>
              <input type="text" class="form-control" id="citationAuthor" placeholder="Last, First">
            </div>
            <div class="form-group">
              <label>Title</label>
              <input type="text" class="form-control" id="citationTitle" placeholder="Title of work">
            </div>
            <div class="form-group">
              <label>Year</label>
              <input type="text" class="form-control" id="citationYear" placeholder="2024">
            </div>
            <div class="form-group">
              <label>Publisher/Source</label>
              <input type="text" class="form-control" id="citationPublisher" placeholder="Publisher or URL">
            </div>
            <button class="btn btn-primary" onclick="addCitation()" style="width: 100%;">Add Citation</button>
          </div>
          <div style="flex: 1; border-left: 1px solid var(--border); padding-left: 1rem;">
            <h4 style="margin-bottom: 0.5rem;">Citations List</h4>
            <div id="citationsList" style="max-height: 300px; overflow-y: auto;"></div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <h4 style="margin-bottom: 0.5rem;">Citation Style</h4>
          <select class="form-control" id="citationStyle" style="width: 200px;">
            <option value="apa">APA (7th Edition)</option>
            <option value="mla">MLA (9th Edition)</option>
            <option value="chicago">Chicago</option>
            <option value="harvard">Harvard</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideBibliography()">Close</button>
        <button class="btn btn-primary" onclick="insertCitation()">Insert Citation</button>
        <button class="btn btn-success" onclick="insertBibliography()">Insert Bibliography</button>
      </div>
    </div>
  </div>

  <!-- Word Art Modal -->
  <div class="modal-overlay" id="wordArtModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Insert Word Art</h3>
        <button class="modal-close" onclick="hideWordArt()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Text</label>
          <input type="text" class="form-control" id="wordArtText" placeholder="Enter your text" value="Word Art">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Style</label>
            <select class="form-control" id="wordArtStyle" onchange="updateWordArtPreview()">
              <option value="gradient">Gradient Fill</option>
              <option value="outline">Outline Only</option>
              <option value="shadow">Drop Shadow</option>
              <option value="glow">Glow Effect</option>
              <option value="reflection">Reflection</option>
              <option value="3d">3D Effect</option>
            </select>
          </div>
          <div class="form-group">
            <label>Font</label>
            <select class="form-control" id="wordArtFont" onchange="updateWordArtPreview()">
              <option value="Impact">Impact</option>
              <option value="Arial Black">Arial Black</option>
              <option value="Georgia">Georgia</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Comic Sans MS">Comic Sans MS</option>
              <option value="Courier New">Courier New</option>
            </select>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Size</label>
            <select class="form-control" id="wordArtSize" onchange="updateWordArtPreview()">
              <option value="36">36pt</option>
              <option value="48" selected>48pt</option>
              <option value="60">60pt</option>
              <option value="72">72pt</option>
              <option value="96">96pt</option>
            </select>
          </div>
          <div class="form-group">
            <label>Primary Color</label>
            <input type="color" class="form-control" id="wordArtColor1" value="#1a73e8" style="height: 38px;" onchange="updateWordArtPreview()">
          </div>
          <div class="form-group">
            <label>Secondary Color</label>
            <input type="color" class="form-control" id="wordArtColor2" value="#ea4335" style="height: 38px;" onchange="updateWordArtPreview()">
          </div>
        </div>
        <div class="form-group">
          <label>Transform</label>
          <select class="form-control" id="wordArtTransform" onchange="updateWordArtPreview()">
            <option value="none">None</option>
            <option value="arch">Arch Up</option>
            <option value="arch-down">Arch Down</option>
            <option value="wave">Wave</option>
            <option value="slant">Slant Up</option>
            <option value="slant-down">Slant Down</option>
          </select>
        </div>
        <div id="wordArtPreview" style="height: 120px; border: 1px solid var(--border); margin-top: 0.5rem; display: flex; justify-content: center; align-items: center; background: #f9f9f9; overflow: hidden;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideWordArt()">Cancel</button>
        <button class="btn btn-primary" onclick="insertWordArt()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Equation Editor Modal -->
  <div class="modal-overlay" id="equationModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Insert Equation</h3>
        <button class="modal-close" onclick="hideEquationEditor()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Common Equations</label>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
            <button class="btn btn-secondary" onclick="insertEquationTemplate('fraction')">a/b</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('sqrt')">‚àöx</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('power')">x¬≤</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('subscript')">x‚ÇÅ</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('sum')">Œ£</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('integral')">‚à´</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('pi')">œÄ</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('theta')">Œ∏</button>
          </div>
        </div>
        <div class="form-group">
          <label>Equation (use ^ for superscript, _ for subscript)</label>
          <textarea class="form-control" id="equationInput" rows="3" placeholder="E = mc^2" oninput="updateEquationPreview()"></textarea>
        </div>
        <div class="form-group">
          <label>Preview</label>
          <div id="equationPreview" style="padding: 1rem; background: #f9f9f9; border: 1px solid var(--border); min-height: 60px; font-size: 24px; text-align: center;"></div>
        </div>
        <div class="form-group">
          <label>Symbol Palette</label>
          <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ±')">Œ±</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ≤')">Œ≤</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ≥')">Œ≥</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ¥')">Œ¥</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œµ')">Œµ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œª')">Œª</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œº')">Œº</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('œÉ')">œÉ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('œÜ')">œÜ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('œâ')">œâ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚àû')">‚àû</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚â†')">‚â†</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚â§')">‚â§</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚â•')">‚â•</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('¬±')">¬±</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('√∑')">√∑</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('√ó')">√ó</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚àö')">‚àö</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEquationEditor()">Cancel</button>
        <button class="btn btn-primary" onclick="insertEquation()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Smart Art Modal -->
  <div class="modal-overlay" id="smartArtModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Insert Smart Art</h3>
        <button class="modal-close" onclick="hideSmartArt()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
          <div>
            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">Diagram Type</label>
            <div id="smartArtTypes" style="display: flex; flex-direction: column; gap: 0.5rem;">
              <button class="btn btn-secondary smart-art-type active" onclick="selectSmartArtType('list')">üìã List</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('process')">‚û°Ô∏è Process</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('cycle')">üîÑ Cycle</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('hierarchy')">üìä Hierarchy</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('relationship')">üîó Relationship</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('pyramid')">üî∫ Pyramid</button>
            </div>
          </div>
          <div>
            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">Enter Items (one per line)</label>
            <textarea class="form-control" id="smartArtItems" rows="6" placeholder="Item 1&#10;Item 2&#10;Item 3&#10;Item 4" oninput="updateSmartArtPreview()">Step 1
Step 2
Step 3
Step 4</textarea>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Color Scheme</label>
              <select class="form-control" id="smartArtColor" onchange="updateSmartArtPreview()">
                <option value="blue">Blue</option>
                <option value="green">Green</option>
                <option value="orange">Orange</option>
                <option value="purple">Purple</option>
                <option value="rainbow">Rainbow</option>
              </select>
            </div>
            <div id="smartArtPreview" style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); min-height: 150px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSmartArt()">Cancel</button>
        <button class="btn btn-primary" onclick="insertSmartArt()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Cross-Reference Modal -->
  <div class="modal-overlay" id="crossRefModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Insert Cross-Reference</h3>
        <button class="modal-close" onclick="hideCrossRef()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Reference Type</label>
          <select class="form-control" id="crossRefType" onchange="updateCrossRefList()">
            <option value="heading">Heading</option>
            <option value="bookmark">Bookmark</option>
            <option value="footnote">Footnote</option>
          </select>
        </div>
        <div class="form-group">
          <label>Insert Reference To</label>
          <select class="form-control" id="crossRefFormat">
            <option value="text">Text</option>
            <option value="page">Page Number</option>
            <option value="above-below">Above/Below</option>
          </select>
        </div>
        <div class="form-group">
          <label>Available References</label>
          <div id="crossRefList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCrossRef()">Cancel</button>
        <button class="btn btn-primary" onclick="insertCrossRef()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Navigation Pane -->
  <div class="navigation-pane" id="navigationPane">
    <div class="nav-pane-header">
      <span>Navigation</span>
      <button onclick="toggleNavigationPane()" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;">&times;</button>
    </div>
    <div class="nav-pane-tabs">
      <div class="nav-pane-tab active" onclick="switchNavTab('headings')">Headings</div>
      <div class="nav-pane-tab" onclick="switchNavTab('pages')">Pages</div>
      <div class="nav-pane-tab" onclick="switchNavTab('search')">Search</div>
    </div>
    <div class="nav-pane-content" id="navPaneContent">
      <!-- Content populated dynamically -->
    </div>
  </div>

  <!-- Outline Panel -->
  <div class="outline-panel" id="outlinePanel">
    <div class="outline-header">
      <span style="font-weight: 600;">Outline View</span>
      <button onclick="toggleOutlineView()" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;">&times;</button>
    </div>
    <div class="outline-toolbar">
      <button onclick="promoteOutlineLevel()" title="Promote (move up level)">‚Üê Promote</button>
      <button onclick="demoteOutlineLevel()" title="Demote (move down level)">‚Üí Demote</button>
      <button onclick="moveOutlineUp()" title="Move Up">‚Üë Up</button>
      <button onclick="moveOutlineDown()" title="Move Down">‚Üì Down</button>
      <select id="outlineShowLevel" onchange="filterOutlineLevel(this.value)" style="font-size: 0.75rem; padding: 0.2rem;">
        <option value="all">Show All</option>
        <option value="1">Level 1</option>
        <option value="2">Level 1-2</option>
        <option value="3">Level 1-3</option>
      </select>
      <button onclick="expandAllOutline()" title="Expand All">+</button>
      <button onclick="collapseAllOutline()" title="Collapse All">‚àí</button>
    </div>
    <div class="outline-content" id="outlineContent">
      <!-- Outline items populated dynamically -->
    </div>
  </div>

  <!-- Styles Gallery Modal -->
  <div class="modal-overlay" id="stylesGalleryModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Styles Gallery</h3>
        <button class="modal-close" onclick="hideStylesGallery()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Quick Styles</label>
          <div class="styles-gallery" id="quickStyles">
            <div class="style-preview" onclick="applyStyle('normal')">
              <div style="font-size: 12px;">Normal Text</div>
              <small>Normal</small>
            </div>
            <div class="style-preview" onclick="applyStyle('heading1')">
              <div style="font-size: 18px; font-weight: bold; color: #1a73e8;">Heading 1</div>
              <small>Heading 1</small>
            </div>
            <div class="style-preview" onclick="applyStyle('heading2')">
              <div style="font-size: 16px; font-weight: bold; color: #1a73e8;">Heading 2</div>
              <small>Heading 2</small>
            </div>
            <div class="style-preview" onclick="applyStyle('heading3')">
              <div style="font-size: 14px; font-weight: bold; color: #666;">Heading 3</div>
              <small>Heading 3</small>
            </div>
            <div class="style-preview" onclick="applyStyle('title')">
              <div style="font-size: 24px; font-weight: 300;">Title</div>
              <small>Title</small>
            </div>
            <div class="style-preview" onclick="applyStyle('subtitle')">
              <div style="font-size: 14px; color: #666; font-style: italic;">Subtitle</div>
              <small>Subtitle</small>
            </div>
            <div class="style-preview" onclick="applyStyle('quote')">
              <div style="font-size: 12px; font-style: italic; border-left: 3px solid #1a73e8; padding-left: 8px;">Quote</div>
              <small>Quote</small>
            </div>
            <div class="style-preview" onclick="applyStyle('code')">
              <div style="font-family: monospace; font-size: 11px; background: #f5f5f5; padding: 2px 4px;">Code</div>
              <small>Code</small>
            </div>
            <div class="style-preview" onclick="applyStyle('emphasis')">
              <div style="font-size: 12px; font-style: italic;">Emphasis</div>
              <small>Emphasis</small>
            </div>
          </div>
        </div>
        <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
        <div class="form-group">
          <label>Custom Styles</label>
          <div id="customStylesList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
          <button class="btn btn-secondary" onclick="showCreateStyle()" style="margin-top: 0.5rem;">+ Create New Style</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideStylesGallery()">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Custom Style Modal -->
  <div class="modal-overlay" id="createStyleModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Create New Style</h3>
        <button class="modal-close" onclick="hideCreateStyle()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Style Name</label>
          <input type="text" class="form-control" id="customStyleName" placeholder="My Custom Style">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Font Family</label>
            <select class="form-control" id="customStyleFont">
              <option value="Arial">Arial</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Georgia">Georgia</option>
              <option value="Verdana">Verdana</option>
              <option value="Courier New">Courier New</option>
            </select>
          </div>
          <div class="form-group">
            <label>Font Size (px)</label>
            <input type="number" class="form-control" id="customStyleSize" value="12" min="8" max="72">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Text Color</label>
            <input type="color" class="form-control" id="customStyleColor" value="#000000" style="height: 40px;">
          </div>
          <div class="form-group">
            <label>Background</label>
            <input type="color" class="form-control" id="customStyleBg" value="#ffffff" style="height: 40px;">
          </div>
        </div>
        <div class="form-group">
          <label>Text Formatting</label>
          <div style="display: flex; gap: 0.5rem;">
            <label><input type="checkbox" id="customStyleBold"> Bold</label>
            <label><input type="checkbox" id="customStyleItalic"> Italic</label>
            <label><input type="checkbox" id="customStyleUnderline"> Underline</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCreateStyle()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomStyle()">Save Style</button>
      </div>
    </div>
  </div>

  <!-- Advanced Find & Replace Modal -->
  <div class="modal-overlay" id="advancedFindModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Advanced Find & Replace</h3>
        <button class="modal-close" onclick="hideAdvancedFind()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Find</label>
          <input type="text" class="form-control" id="advFindInput" placeholder="Search text or pattern">
        </div>
        <div class="form-group">
          <label>Replace with</label>
          <input type="text" class="form-control" id="advReplaceInput" placeholder="Replacement text">
        </div>
        <div class="form-group">
          <label>Options</label>
          <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
            <label><input type="checkbox" id="advFindCase"> Match case</label>
            <label><input type="checkbox" id="advFindWholeWord"> Whole words only</label>
            <label><input type="checkbox" id="advFindRegex"> Use regular expressions</label>
          </div>
        </div>
        <div id="advFindResults" style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px; margin-top: 1rem;">
          <span style="color: #666;">Enter search text and click Find All</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="advFindAll()">Find All</button>
        <button class="btn btn-secondary" onclick="advFindNext()">Find Next</button>
        <button class="btn btn-primary" onclick="advReplace()">Replace</button>
        <button class="btn btn-primary" onclick="advReplaceAll()">Replace All</button>
      </div>
    </div>
  </div>

  <!-- Index Modal -->
  <div class="modal-overlay" id="indexModal">
    <div class="modal" style="max-width: 650px;">
      <div class="modal-header">
        <h3>Index</h3>
        <button class="modal-close" onclick="hideIndexModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <button class="btn btn-secondary" onclick="showMarkIndexEntry()" id="markEntryBtn">Mark Entry</button>
          <button class="btn btn-secondary" onclick="showMarkAllEntries()">Mark All</button>
          <button class="btn btn-primary" onclick="insertIndex()">Insert Index</button>
          <button class="btn btn-secondary" onclick="updateIndex()">Update Index</button>
        </div>

        <div id="markEntrySection" style="display: none; padding: 1rem; background: #f9f9f9; border-radius: 8px; margin-bottom: 1rem;">
          <h4 style="margin-bottom: 0.75rem;">Mark Index Entry</h4>
          <div class="form-group">
            <label>Main entry</label>
            <input type="text" class="form-control" id="indexMainEntry" placeholder="Enter main entry text">
          </div>
          <div class="form-group">
            <label>Subentry (optional)</label>
            <input type="text" class="form-control" id="indexSubEntry" placeholder="Enter subentry text">
          </div>
          <div class="form-group">
            <label>Options</label>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
              <label><input type="radio" name="indexType" value="page" checked> Current page</label>
              <label><input type="radio" name="indexType" value="range"> Page range</label>
              <label><input type="radio" name="indexType" value="crossref"> Cross-reference</label>
            </div>
          </div>
          <div class="form-group" id="crossRefField" style="display: none;">
            <label>Cross-reference text</label>
            <input type="text" class="form-control" id="indexCrossRef" placeholder="See also...">
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="markIndexEntry()">Mark</button>
            <button class="btn btn-secondary" onclick="markAllOccurrences()">Mark All</button>
            <button class="btn btn-secondary" onclick="hideMarkEntry()">Cancel</button>
          </div>
        </div>

        <div class="form-group">
          <label>Index Format</label>
          <select class="form-control" id="indexFormat">
            <option value="indented">Indented</option>
            <option value="run-in">Run-in</option>
          </select>
        </div>
        <div class="form-group">
          <label>Columns</label>
          <select class="form-control" id="indexColumns">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
          </select>
        </div>

        <div style="margin-top: 1rem;">
          <h4>Index Entries (<span id="indexEntryCount">0</span>)</h4>
          <div id="indexEntriesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: white;">
            <div style="color: #999; font-style: italic;">No index entries marked yet</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="clearAllIndexEntries()">Clear All Entries</button>
        <button class="btn btn-secondary" onclick="hideIndexModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Quick Parts Modal -->
  <div class="modal-overlay" id="quickPartsModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Quick Parts / AutoText</h3>
        <button class="modal-close" onclick="hideQuickParts()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem;">
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Categories</label>
            <div id="quickPartsCategories" style="border: 1px solid var(--border); border-radius: 4px; overflow: hidden;">
              <div class="quickparts-category active" onclick="selectQuickPartsCategory('general')" data-category="general">General</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('headers')" data-category="headers">Headers & Footers</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('textboxes')" data-category="textboxes">Text Boxes</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('coverpage')" data-category="coverpage">Cover Pages</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('autotext')" data-category="autotext">AutoText</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('custom')" data-category="custom">My Custom</div>
            </div>
          </div>
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Quick Parts</label>
            <div id="quickPartsGallery" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.75rem; background: #f9f9f9;"></div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <label style="font-weight: 600;">Save Selection as Quick Part</label>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="text" class="form-control" id="quickPartName" placeholder="Enter name for selection...">
            <select class="form-control" id="quickPartCategory" style="width: 150px;">
              <option value="general">General</option>
              <option value="headers">Headers & Footers</option>
              <option value="textboxes">Text Boxes</option>
              <option value="autotext">AutoText</option>
              <option value="custom">My Custom</option>
            </select>
            <button class="btn btn-secondary" onclick="saveQuickPart()">Save</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideQuickParts()">Close</button>
        <button class="btn btn-primary" onclick="insertSelectedQuickPart()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Digital Signature Modal -->
  <div class="modal-overlay" id="digitalSignatureModal">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h3>Digital Signature</h3>
        <button class="modal-close" onclick="hideDigitalSignature()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="font-weight: 600;">Signature Type</label>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-secondary signature-type-btn active" onclick="selectSignatureType('draw')" data-type="draw">‚úèÔ∏è Draw</button>
            <button class="btn btn-secondary signature-type-btn" onclick="selectSignatureType('type')" data-type="type">‚å®Ô∏è Type</button>
            <button class="btn btn-secondary signature-type-btn" onclick="selectSignatureType('upload')" data-type="upload">üì§ Upload</button>
          </div>
        </div>

        <div id="signatureDrawPanel" class="signature-panel">
          <label>Draw your signature:</label>
          <canvas id="signatureCanvas" width="480" height="150" style="border: 2px solid #ddd; border-radius: 8px; cursor: crosshair; background: white; display: block; margin-top: 0.5rem;"></canvas>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-secondary" onclick="clearSignatureCanvas()">Clear</button>
            <select class="form-control" id="signaturePenColor" onchange="updateSignaturePen()" style="width: 120px;">
              <option value="#000000">Black</option>
              <option value="#1a73e8">Blue</option>
              <option value="#0d47a1">Dark Blue</option>
            </select>
            <select class="form-control" id="signaturePenSize" onchange="updateSignaturePen()" style="width: 100px;">
              <option value="2">Thin</option>
              <option value="3" selected>Medium</option>
              <option value="5">Thick</option>
            </select>
          </div>
        </div>

        <div id="signatureTypePanel" class="signature-panel" style="display: none;">
          <label>Type your signature:</label>
          <input type="text" class="form-control" id="signatureText" placeholder="Your Name" style="margin-top: 0.5rem;" oninput="updateTypedSignaturePreview()">
          <label style="margin-top: 1rem;">Font Style:</label>
          <select class="form-control" id="signatureFont" onchange="updateTypedSignaturePreview()">
            <option value="'Brush Script MT', cursive">Script</option>
            <option value="'Segoe Script', cursive">Segoe Script</option>
            <option value="'Lucida Handwriting', cursive">Lucida</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="'Times New Roman', serif">Times</option>
          </select>
          <div id="typedSignaturePreview" style="margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 8px; text-align: center; min-height: 60px; font-size: 28px;"></div>
        </div>

        <div id="signatureUploadPanel" class="signature-panel" style="display: none;">
          <label>Upload signature image:</label>
          <input type="file" class="form-control" id="signatureUpload" accept="image/*" onchange="previewUploadedSignature()" style="margin-top: 0.5rem;">
          <div id="uploadedSignaturePreview" style="margin-top: 1rem; text-align: center; min-height: 100px; background: #f9f9f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <span style="color: #666;">No image selected</span>
          </div>
        </div>

        <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <label style="font-weight: 600;">Signer Information</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="text" class="form-control" id="signerName" placeholder="Full Name">
            <input type="text" class="form-control" id="signerTitle" placeholder="Title (optional)">
          </div>
          <div style="margin-top: 0.5rem;">
            <label><input type="checkbox" id="includeDate" checked> Include date</label>
            <label style="margin-left: 1rem;"><input type="checkbox" id="includeTimestamp"> Include timestamp</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDigitalSignature()">Cancel</button>
        <button class="btn btn-primary" onclick="insertDigitalSignature()">Insert Signature</button>
      </div>
    </div>
  </div>

  <!-- Symbol Picker Modal -->
  <div class="modal-overlay" id="symbolModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Insert Symbol</h3>
        <button class="modal-close" onclick="hideSymbolPicker()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="symbol-category-tabs" id="symbolCategoryTabs"></div>
        <div class="symbol-grid" id="symbolGrid"></div>
        <div class="symbol-preview">
          <div class="symbol-preview-char" id="symbolPreviewChar">‚Äî</div>
          <div class="symbol-preview-info" id="symbolPreviewInfo">Select a symbol</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSymbolPicker()">Close</button>
        <button class="btn btn-primary" onclick="insertSelectedSymbol()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Text Box Modal -->
  <div class="modal-overlay" id="textBoxModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Insert Text Box</h3>
        <button class="modal-close" onclick="hideTextBoxModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Text Box Style</label>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
            <div class="textbox-style-option selected" onclick="selectTextBoxStyle('simple')" data-style="simple" style="padding: 1rem; border: 2px solid #1a73e8; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 1px solid #333; padding: 8px; font-size: 0.7rem;">Simple</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('shadow')" data-style="shadow" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 1px solid #333; padding: 8px; font-size: 0.7rem; box-shadow: 3px 3px 5px rgba(0,0,0,0.3);">Shadow</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('rounded')" data-style="rounded" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 1px solid #333; padding: 8px; font-size: 0.7rem; border-radius: 12px;">Rounded</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('colored')" data-style="colored" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 2px solid #1a73e8; padding: 8px; font-size: 0.7rem; background: #e3f2fd;">Colored</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('callout')" data-style="callout" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border-left: 4px solid #1a73e8; padding: 8px; font-size: 0.7rem; background: #f5f5f5;">Callout</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('quote')" data-style="quote" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: none; padding: 8px; font-size: 0.7rem; font-style: italic; background: #f9f9f9;">"Quote"</div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Size</label>
          <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
            <div>
              <label style="font-size: 0.85rem;">Width</label>
              <input type="number" class="form-control" id="textBoxWidth" value="300" min="100" max="800" style="width: 100px;">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Height</label>
              <input type="number" class="form-control" id="textBoxHeight" value="150" min="50" max="600" style="width: 100px;">
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Position</label>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
            <label><input type="radio" name="textBoxPosition" value="inline" checked> Inline with text</label>
            <label><input type="radio" name="textBoxPosition" value="float-left"> Float left</label>
            <label><input type="radio" name="textBoxPosition" value="float-right"> Float right</label>
          </div>
        </div>
        <div class="form-group">
          <label>Colors</label>
          <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
            <div>
              <label style="font-size: 0.85rem;">Border</label>
              <input type="color" class="form-control" id="textBoxBorderColor" value="#333333" style="height: 36px; width: 60px;">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Background</label>
              <input type="color" class="form-control" id="textBoxBgColor" value="#ffffff" style="height: 36px; width: 60px;">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideTextBoxModal()">Cancel</button>
        <button class="btn btn-primary" onclick="insertTextBox()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Document Inspector Modal -->
  <div class="modal-overlay" id="documentInspectorModal">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h3>Document Inspector</h3>
        <button class="modal-close" onclick="hideDocumentInspector()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: #666; margin-bottom: 1rem;">Inspect your document for hidden data and personal information that might be stored in the document.</p>
        <div id="inspectorResults" style="max-height: 400px; overflow-y: auto;">
          <div class="inspector-item" data-type="comments">
            <div class="inspector-header">
              <input type="checkbox" id="inspectComments" checked>
              <label for="inspectComments"><strong>üí¨ Comments & Revisions</strong></label>
            </div>
            <div class="inspector-result" id="resultComments"></div>
          </div>
          <div class="inspector-item" data-type="properties">
            <div class="inspector-header">
              <input type="checkbox" id="inspectProperties" checked>
              <label for="inspectProperties"><strong>üìã Document Properties</strong></label>
            </div>
            <div class="inspector-result" id="resultProperties"></div>
          </div>
          <div class="inspector-item" data-type="hiddenText">
            <div class="inspector-header">
              <input type="checkbox" id="inspectHiddenText" checked>
              <label for="inspectHiddenText"><strong>üëÅ Hidden Text</strong></label>
            </div>
            <div class="inspector-result" id="resultHiddenText"></div>
          </div>
          <div class="inspector-item" data-type="personalInfo">
            <div class="inspector-header">
              <input type="checkbox" id="inspectPersonalInfo" checked>
              <label for="inspectPersonalInfo"><strong>üë§ Personal Information</strong></label>
            </div>
            <div class="inspector-result" id="resultPersonalInfo"></div>
          </div>
          <div class="inspector-item" data-type="links">
            <div class="inspector-header">
              <input type="checkbox" id="inspectLinks" checked>
              <label for="inspectLinks"><strong>üîó Hyperlinks</strong></label>
            </div>
            <div class="inspector-result" id="resultLinks"></div>
          </div>
          <div class="inspector-item" data-type="images">
            <div class="inspector-header">
              <input type="checkbox" id="inspectImages" checked>
              <label for="inspectImages"><strong>üñº Embedded Images</strong></label>
            </div>
            <div class="inspector-result" id="resultImages"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDocumentInspector()">Close</button>
        <button class="btn btn-warning" onclick="removeAllInspected()">Remove All Found</button>
        <button class="btn btn-primary" onclick="runDocumentInspector()">Inspect</button>
      </div>
    </div>
  </div>

  <!-- Insert Table Modal -->
  <div class="modal-overlay" id="insertTableModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Insert Table</h3>
        <button class="modal-close" onclick="hideInsertTableModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-grid-container">
          <div class="table-grid" id="tableGrid"></div>
          <div class="table-size-display" id="tableSizeDisplay">Select table size</div>

          <div style="width: 100%; text-align: center; margin: 0.5rem 0; color: #999;">‚Äî or ‚Äî</div>

          <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.85rem;">Rows</label>
              <input type="number" class="form-control" id="tableRows" value="3" min="1" max="50" style="width: 70px;">
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.85rem;">Columns</label>
              <input type="number" class="form-control" id="tableCols" value="3" min="1" max="20" style="width: 70px;">
            </div>
          </div>

          <div class="table-options">
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.85rem;">Style</label>
              <select class="form-control" id="tableStyle">
                <option value="basic">Basic</option>
                <option value="bordered">Bordered</option>
                <option value="striped">Striped</option>
                <option value="modern">Modern</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" id="tableHeader" checked> Header Row
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideInsertTableModal()">Cancel</button>
        <button class="btn btn-primary" onclick="insertTableFromModal()">Insert Table</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="fileImport" accept=".njword,.json" style="display: none;" onchange="handleFileImport(event)">
  <input type="file" id="docxImport" accept=".docx" style="display: none;" onchange="handleDocxImport(event)">
  <input type="file" id="compareFileInput" accept=".njword,.json,.docx,.txt" style="display: none;" onchange="handleCompareFileImport(event)">

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Reading Progress Bar -->
  <div class="reading-progress-bar" id="readingProgressBar"></div>

  <!-- Reading Progress Info Panel -->
  <div class="reading-progress-info" id="readingProgressInfo">
    <h4>üìä Reading Progress</h4>
    <div class="reading-stat">
      <label>Progress:</label>
      <span id="progressPercent">0%</span>
    </div>
    <div class="reading-stat">
      <label>Words Read:</label>
      <span id="wordsRead">0</span>
    </div>
    <div class="reading-stat">
      <label>Time Reading:</label>
      <span id="timeReading">0:00</span>
    </div>
    <div class="reading-stat">
      <label>Est. Time Left:</label>
      <span id="timeRemaining">--</span>
    </div>
    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
      <div class="reading-stat">
        <label>Reading Speed:</label>
        <span id="readingSpeed">-- wpm</span>
      </div>
    </div>
  </div>

  <!-- Document Statistics Modal -->
  <div class="modal-overlay" id="docStatsModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3>üìà Document Statistics</h3>
        <button class="modal-close" onclick="hideDocumentStatistics()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div style="padding: 1rem; background: #e8f0fe; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #1a73e8;" id="statWords">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Words</div>
          </div>
          <div style="padding: 1rem; background: #e8f5e9; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #34a853;" id="statChars">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Characters</div>
          </div>
          <div style="padding: 1rem; background: #fff3e0; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #f57c00;" id="statSentences">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Sentences</div>
          </div>
          <div style="padding: 1rem; background: #f3e5f5; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #9c27b0;" id="statParagraphs">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Paragraphs</div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
          <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem;">Reading Time Estimates</h4>
          <div class="reading-stat">
            <label>Average Reader (~200 wpm):</label>
            <span id="statReadAvg">0 min</span>
          </div>
          <div class="reading-stat">
            <label>Fast Reader (~300 wpm):</label>
            <span id="statReadFast">0 min</span>
          </div>
          <div class="reading-stat">
            <label>Speaking Time (~150 wpm):</label>
            <span id="statSpeak">0 min</span>
          </div>
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
          <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem;">Readability</h4>
          <div class="reading-stat">
            <label>Average Word Length:</label>
            <span id="statAvgWordLen">0 chars</span>
          </div>
          <div class="reading-stat">
            <label>Average Sentence Length:</label>
            <span id="statAvgSentLen">0 words</span>
          </div>
          <div class="reading-stat">
            <label>Unique Words:</label>
            <span id="statUniqueWords">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDocumentStatistics()">Close</button>
        <button class="btn btn-primary" onclick="copyStatistics()">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- Focus Mode Bar -->
  <div class="focus-mode-bar" id="focusModeBar">
    <span>Focus Mode</span>
    <button onclick="adjustFocusWidth(-50)">Narrower</button>
    <button onclick="adjustFocusWidth(50)">Wider</button>
    <button onclick="toggleFocusDarkMode()">üåì Toggle Theme</button>
    <button onclick="toggleReadAloud()">üîä Read Aloud</button>
    <button onclick="toggleFocusMode()">‚úï Exit</button>
  </div>

  <!-- Reading Mode Overlay -->
  <div class="reading-mode-overlay sepia" id="readingModeOverlay">
    <div class="reading-mode-progress" id="readingProgress"></div>
    <div class="reading-mode-header">
      <div class="reading-mode-controls">
        <button onclick="changeReadingTheme('sepia')">üìú Sepia</button>
        <button onclick="changeReadingTheme('light')">‚òÄÔ∏è Light</button>
        <button onclick="changeReadingTheme('dark')">üåô Dark</button>
      </div>
      <div style="font-weight: 500;" id="readingTitle">Document</div>
      <div class="reading-mode-controls">
        <button onclick="adjustReadingFontSize(-2)">A-</button>
        <button onclick="adjustReadingFontSize(2)">A+</button>
        <button onclick="toggleReadAloud()">üîä Read</button>
        <button onclick="toggleReadingMode()">‚úï Close</button>
      </div>
    </div>
    <div class="reading-mode-content" id="readingContent" onscroll="updateReadingProgress()">
      <div class="reading-mode-text" id="readingText"></div>
    </div>
  </div>

  <script>
    // State
    let trackChangesEnabled = false;
    let changes = [];
    let originalContent = '';
    let currentDocId = null;
    const STORAGE_KEY = 'ninjaword_documents';
    let zoomLevel = 100;
    let undoStack = [];
    let redoStack = [];
    let findMatches = [];
    let currentFindIndex = -1;

    // Auto-correct dictionary
    const autoCorrectRules = {
      'teh': 'the', 'adn': 'and', 'dont': "don't", 'didnt': "didn't", 'wont': "won't",
      'cant': "can't", 'im': "I'm", 'youre': "you're", 'theyre': "they're", 'its': "it's",
      'thier': 'their', 'recieve': 'receive', 'beleive': 'believe', 'occured': 'occurred',
      'seperate': 'separate', 'definately': 'definitely', 'accomodate': 'accommodate',
      'occurence': 'occurrence', 'untill': 'until', 'wierd': 'weird', 'acheive': 'achieve',
      '(c)': '¬©', '(r)': '¬Æ', '(tm)': '‚Ñ¢', '->': '‚Üí', '<-': '‚Üê', '<->': '‚Üî',
      '...': '‚Ä¶', '--': '‚Äî', '1/2': '¬Ω', '1/4': '¬º', '3/4': '¬æ',
      ':)': 'üòä', ':(': 'üòû', ':D': 'üòÉ', ';)': 'üòâ', '<3': '‚ù§Ô∏è'
    };
    let autoCorrectEnabled = true;

    // File Menu
    function toggleFileMenu() {
      const menu = document.getElementById('fileMenu');
      menu.classList.toggle('show');
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.getElementById('fileMenu')?.classList.remove('show');
      }
    });

    // Get all saved documents
    function getSavedDocuments() {
      const docs = localStorage.getItem(STORAGE_KEY);
      return docs ? JSON.parse(docs) : {};
    }

    // Save documents to storage
    function saveDocs(docs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
    }

    // New Document
    function newDocument() {
      if (editor.innerHTML && !confirm('Create new document? Unsaved changes will be lost.')) return;
      editor.innerHTML = '<p>Start typing your document here...</p>';
      document.getElementById('fileName').value = 'Untitled Document';
      currentDocId = null;
      updateStats();
      showToast('New document created', 'success');
      toggleFileMenu();
    }

    // Open Dialog
    function showOpenDialog() {
      toggleFileMenu();
      const docs = getSavedDocuments();
      const list = document.getElementById('savedDocsList');

      if (Object.keys(docs).length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 2rem;">No saved documents yet.<br>Save a document first!</p>';
      } else {
        list.innerHTML = Object.entries(docs).map(([id, doc]) => `
          <div style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;"
               onmouseover="this.style.background='var(--light)'"
               onmouseout="this.style.background='white'"
               onclick="loadDocument('${id}')">
            <div style="flex: 1;">
              <div style="font-weight: 500;">${doc.name}</div>
              <div style="font-size: 0.8rem; color: var(--secondary);">
                Last modified: ${new Date(doc.modified).toLocaleString()}
              </div>
            </div>
            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                    onclick="event.stopPropagation(); deleteDocument('${id}')">üóë</button>
          </div>
        `).join('');
      }

      document.getElementById('openModal').classList.add('active');
    }

    function hideOpenDialog() {
      document.getElementById('openModal').classList.remove('active');
    }

    // Load Document
    function loadDocument(id) {
      const docs = getSavedDocuments();
      const doc = docs[id];
      if (doc) {
        editor.innerHTML = doc.content;
        document.getElementById('fileName').value = doc.name;
        currentDocId = id;
        updateStats();
        hideOpenDialog();
        showToast('Document loaded', 'success');
      }
    }

    // Delete Document
    function deleteDocument(id) {
      if (!confirm('Delete this document permanently?')) return;
      const docs = getSavedDocuments();
      delete docs[id];
      saveDocs(docs);
      showOpenDialog(); // Refresh list
      showToast('Document deleted', 'success');
    }

    // Save Document
    function saveDocument() {
      toggleFileMenu();
      const name = document.getElementById('fileName').value.trim() || 'Untitled Document';

      if (!currentDocId) {
        // First time save - show Save As dialog
        saveDocumentAs();
        return;
      }

      const docs = getSavedDocuments();
      docs[currentDocId] = {
        name: name,
        content: editor.innerHTML,
        modified: Date.now()
      };
      saveDocs(docs);
      addToRecentFiles(currentDocId, name);
      showToast('Document saved', 'success');
    }

    // Save As Dialog
    function saveDocumentAs() {
      const menu = document.getElementById('fileMenu');
      if (menu.classList.contains('show')) toggleFileMenu();

      document.getElementById('saveAsName').value = document.getElementById('fileName').value;
      document.getElementById('saveAsModal').classList.add('active');
    }

    function hideSaveAs() {
      document.getElementById('saveAsModal').classList.remove('active');
    }

    function confirmSaveAs() {
      const name = document.getElementById('saveAsName').value.trim() || 'Untitled Document';
      const docs = getSavedDocuments();
      const id = 'doc_' + Date.now();

      docs[id] = {
        name: name,
        content: editor.innerHTML,
        modified: Date.now()
      };

      saveDocs(docs);
      currentDocId = id;
      document.getElementById('fileName').value = name;
      addToRecentFiles(id, name);
      hideSaveAs();
      showToast('Document saved as "' + name + '"', 'success');
    }

    // Export to file
    function exportToFile() {
      toggleFileMenu();
      const name = document.getElementById('fileName').value.trim() || 'document';
      const data = {
        name: name,
        content: editor.innerHTML,
        created: Date.now(),
        app: 'NinjaWord'
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name + '.njword';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Document exported', 'success');
    }

    // Import from file
    function importFromFile() {
      toggleFileMenu();
      document.getElementById('fileImport').click();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.content) {
            editor.innerHTML = data.content;
            document.getElementById('fileName').value = data.name || 'Imported Document';
            currentDocId = null;
            updateStats();
            showToast('Document imported successfully', 'success');
          } else {
            throw new Error('Invalid format');
          }
        } catch (err) {
          showToast('Error importing file: Invalid format', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // Reset for future imports
    }

    // Format document
    function formatDoc(cmd, value = null) {
      document.execCommand(cmd, false, value);
      editor.focus();
      updateStats();
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Hide all toolbars
        document.getElementById('homeToolbar').style.display = 'none';
        document.getElementById('insertToolbar').style.display = 'none';
        document.getElementById('reviewToolbar').style.display = 'none';

        // Show selected toolbar
        const tabName = tab.dataset.tab;
        if (tabName === 'home') {
          document.getElementById('homeToolbar').style.display = 'flex';
        } else if (tabName === 'insert') {
          document.getElementById('insertToolbar').style.display = 'flex';
        } else if (tabName === 'review') {
          document.getElementById('reviewToolbar').style.display = 'flex';
        }
      });
    });

    // Editor reference
    const editor = document.getElementById('editor');

    // Update document stats
    function updateStats() {
      const text = editor.innerText;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const chars = text.length;
      const paras = editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li').length || 1;

      document.getElementById('wordCount').textContent = words;
      document.getElementById('charCount').textContent = chars;
      document.getElementById('paraCount').textContent = paras;
    }

    editor.addEventListener('input', updateStats);
    updateStats();

    // Auto-correct on space or punctuation
    editor.addEventListener('keydown', (e) => {
      if (!autoCorrectEnabled) return;
      if (e.key === ' ' || e.key === 'Enter' || /^[.,;:!?)]$/.test(e.key)) {
        setTimeout(() => applyAutoCorrect(), 0);
      }
    });

    function applyAutoCorrect() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      const node = range.startContainer;
      if (node.nodeType !== Node.TEXT_NODE) return;

      const text = node.textContent;
      const cursorPos = range.startOffset;

      // Find the word before cursor
      let wordStart = cursorPos - 1;
      while (wordStart > 0 && !/\s/.test(text[wordStart - 1])) {
        wordStart--;
      }

      // Extract word (excluding trailing space/punctuation)
      let wordEnd = cursorPos;
      if (/[\s.,;:!?)]/.test(text[cursorPos - 1])) {
        wordEnd = cursorPos - 1;
      }

      const word = text.substring(wordStart, wordEnd).toLowerCase();
      const replacement = autoCorrectRules[word];

      if (replacement) {
        // Preserve original case for first letter
        let finalReplacement = replacement;
        if (text[wordStart] === text[wordStart].toUpperCase() && /[a-z]/i.test(text[wordStart])) {
          finalReplacement = replacement.charAt(0).toUpperCase() + replacement.slice(1);
        }

        const before = text.substring(0, wordStart);
        const after = text.substring(wordEnd);
        node.textContent = before + finalReplacement + after;

        // Restore cursor position
        const newPos = wordStart + finalReplacement.length + (cursorPos - wordEnd);
        range.setStart(node, Math.min(newPos, node.textContent.length));
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
      }
    }

    function toggleAutoCorrect() {
      autoCorrectEnabled = !autoCorrectEnabled;
      const btn = document.getElementById('autoCorrectBtn');
      if (btn) btn.classList.toggle('active', autoCorrectEnabled);
      showToast(autoCorrectEnabled ? 'Auto-correct enabled' : 'Auto-correct disabled', 'info');
    }

    // Track Changes
    function toggleTrackChanges() {
      trackChangesEnabled = !trackChangesEnabled;
      const btn = document.getElementById('trackChangesBtn');
      const btn2 = document.getElementById('trackChangesBtn2');
      const panel = document.getElementById('trackChangesPanel');

      if (trackChangesEnabled) {
        btn.classList.add('active');
        if (btn2) btn2.classList.add('active');
        panel.style.display = 'block';
        originalContent = editor.innerHTML;
        showToast('Track Changes enabled', 'success');
      } else {
        btn.classList.remove('active');
        if (btn2) btn2.classList.remove('active');
        panel.style.display = 'none';
        showToast('Track Changes disabled');
      }
    }

    // Spell Check (simple implementation)
    const commonMisspellings = {
      'teh': 'the',
      'recieve': 'receive',
      'occured': 'occurred',
      'seperate': 'separate',
      'definately': 'definitely',
      'accomodate': 'accommodate',
      'occurence': 'occurrence',
      'untill': 'until',
      'wierd': 'weird',
      'beleive': 'believe'
    };

    function runSpellCheck() {
      const text = editor.innerText;
      const words = text.toLowerCase().split(/\s+/);
      const suggestions = [];

      words.forEach(word => {
        const cleanWord = word.replace(/[.,!?;:'"]/g, '');
        if (commonMisspellings[cleanWord]) {
          suggestions.push({
            wrong: cleanWord,
            right: commonMisspellings[cleanWord]
          });
        }
      });

      const suggestionDiv = document.getElementById('spellingSuggestions');
      if (suggestions.length === 0) {
        suggestionDiv.innerHTML = '<p style="color: var(--success);">No spelling errors found!</p>';
        showToast('Spell check complete - no errors found', 'success');
      } else {
        suggestionDiv.innerHTML = suggestions.map(s =>
          `<div class="change-item" style="cursor: pointer;" onclick="replaceWord('${s.wrong}', '${s.right}')">
            <span class="spelling-error">${s.wrong}</span> ‚Üí <strong>${s.right}</strong>
          </div>`
        ).join('');
        showToast(`Found ${suggestions.length} spelling issue(s)`, 'warning');
      }
    }

    function replaceWord(wrong, right) {
      const html = editor.innerHTML;
      const regex = new RegExp('\\b' + wrong + '\\b', 'gi');
      editor.innerHTML = html.replace(regex, right);
      runSpellCheck();
    }

    function runGrammarCheck() {
      showToast('Grammar check complete', 'success');
    }

    // Insert Table Modal
    let tableGridRows = 0;
    let tableGridCols = 0;

    function insertTable() {
      showInsertTableModal();
    }

    function showInsertTableModal() {
      document.getElementById('insertTableModal').classList.add('visible');
      initTableGrid();
    }

    function hideInsertTableModal() {
      document.getElementById('insertTableModal').classList.remove('visible');
      tableGridRows = 0;
      tableGridCols = 0;
    }

    function initTableGrid() {
      const grid = document.getElementById('tableGrid');
      grid.innerHTML = '';
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 10; c++) {
          const cell = document.createElement('div');
          cell.className = 'table-grid-cell';
          cell.dataset.row = r + 1;
          cell.dataset.col = c + 1;
          cell.addEventListener('mouseenter', () => highlightGridCells(r + 1, c + 1));
          cell.addEventListener('click', () => selectGridSize(r + 1, c + 1));
          grid.appendChild(cell);
        }
      }
    }

    function highlightGridCells(rows, cols) {
      const cells = document.querySelectorAll('.table-grid-cell');
      cells.forEach(cell => {
        const r = parseInt(cell.dataset.row);
        const c = parseInt(cell.dataset.col);
        if (r <= rows && c <= cols) {
          cell.classList.add('highlighted');
        } else {
          cell.classList.remove('highlighted');
        }
      });
      document.getElementById('tableSizeDisplay').textContent = `${rows} x ${cols} Table`;
      tableGridRows = rows;
      tableGridCols = cols;
    }

    function selectGridSize(rows, cols) {
      document.getElementById('tableRows').value = rows;
      document.getElementById('tableCols').value = cols;
      insertTableFromModal();
    }

    function insertTableFromModal() {
      const rows = parseInt(document.getElementById('tableRows').value) || 3;
      const cols = parseInt(document.getElementById('tableCols').value) || 3;
      const style = document.getElementById('tableStyle').value;
      const hasHeader = document.getElementById('tableHeader').checked;

      const styles = {
        basic: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0;',
          th: 'border: 1px solid #ccc; padding: 10px; background: #f5f5f5; font-weight: bold; text-align: left;',
          td: 'border: 1px solid #ccc; padding: 10px;'
        },
        bordered: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0; border: 2px solid #333;',
          th: 'border: 2px solid #333; padding: 10px; background: #333; color: white; font-weight: bold;',
          td: 'border: 1px solid #333; padding: 10px;'
        },
        striped: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0;',
          th: 'border-bottom: 2px solid #1a73e8; padding: 12px; background: #e8f0fe; font-weight: bold; text-align: left;',
          td: 'border-bottom: 1px solid #eee; padding: 10px;',
          altRow: 'background: #f9f9f9;'
        },
        modern: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);',
          th: 'padding: 14px; background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; font-weight: 600; text-align: left;',
          td: 'padding: 12px; border-bottom: 1px solid #eee;'
        }
      };

      const s = styles[style];
      let table = `<table style="${s.table}">`;

      for (let i = 0; i < rows; i++) {
        const isHeader = hasHeader && i === 0;
        const isAltRow = s.altRow && !isHeader && i % 2 === 1;
        table += `<tr${isAltRow ? ` style="${s.altRow}"` : ''}>`;
        for (let j = 0; j < cols; j++) {
          const tag = isHeader ? 'th' : 'td';
          const cellStyle = isHeader ? s.th : s.td;
          table += `<${tag} style="${cellStyle}" contenteditable="true">${isHeader ? `Header ${j + 1}` : '&nbsp;'}</${tag}>`;
        }
        table += '</tr>';
      }
      table += '</table><p></p>';

      document.execCommand('insertHTML', false, table);
      hideInsertTableModal();
      showToast(`Inserted ${rows}x${cols} table`, 'success');
    }

    // ========== Symbol Picker ==========
    const symbolCategories = {
      'Common': '¬©¬Æ‚Ñ¢¬∞¬ß¬∂‚Ä†‚Ä°‚Ä¢‚Ä¶‚Äî‚Äì''""¬´¬ª‚Äπ‚Ä∫¬°¬ø√ó√∑¬±‚â†‚âà‚â§‚â•‚àû‚àë‚àè‚àö‚à´‚àÇ‚àÜ‚àá',
      'Currency': '$‚Ç¨¬£¬•¬¢‚Çπ‚ÇΩ‚Çø‡∏ø‚Ç©‚Ç™‚Ç´‚Ç≠‚ÇÆ‚ÇØ‚Ç±‚Ç≤‚Ç≥‚Ç¥‚Çµ‚Ç∏‚Ç∫‚Çº‚Çæ',
      'Greek': 'ŒëŒíŒìŒîŒïŒñŒóŒòŒôŒöŒõŒúŒùŒûŒüŒ†Œ°Œ£Œ§Œ•Œ¶ŒßŒ®Œ©Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ',
      'Math': '‚àÄ‚àÅ‚àÇ‚àÉ‚àÑ‚àÖ‚àÜ‚àá‚àà‚àâ‚àä‚àã‚àå‚àç‚àé‚àè‚àê‚àë‚àí‚àì‚àî‚àï‚àñ‚àó‚àò‚àô‚àö‚àõ‚àú‚àù‚àû‚àü‚à†‚à°‚à¢‚à£‚à§‚à•‚à¶‚àß‚à®‚à©‚à™‚à´‚à¨‚à≠‚àÆ‚àØ‚à∞',
      'Arrows': '‚Üê‚Üë‚Üí‚Üì‚Üî‚Üï‚Üñ‚Üó‚Üò‚Üô‚Üö‚Üõ‚Üú‚Üù‚Üû‚Üü‚Ü†‚Ü°‚Ü¢‚Ü£‚Ü§‚Ü•‚Ü¶‚Üß‚Ü®‚Ü©‚Ü™‚Ü´‚Ü¨‚Ü≠‚ÜÆ‚ÜØ‚Ü∞‚Ü±‚Ü≤‚Ü≥‚Ü¥‚Üµ‚Ü∂‚Ü∑‚Ü∏‚Üπ‚Ü∫‚Üª',
      'Shapes': '‚ñ†‚ñ°‚ñ¢‚ñ£‚ñ§‚ñ•‚ñ¶‚ñß‚ñ®‚ñ©‚ñ™‚ñ´‚ñ¨‚ñ≠‚ñÆ‚ñØ‚ñ∞‚ñ±‚ñ≤‚ñ≥‚ñ¥‚ñµ‚ñ∂‚ñ∑‚ñ∏‚ñπ‚ñ∫‚ñª‚ñº‚ñΩ‚ñæ‚ñø‚óÄ‚óÅ‚óÇ‚óÉ‚óÑ‚óÖ‚óÜ‚óá‚óà‚óâ‚óä‚óã‚óå‚óç‚óé‚óè',
      'Stars': '‚òÖ‚òÜ‚ú°‚ú¢‚ú£‚ú§‚ú•‚ú¶‚úß‚ú©‚ú™‚ú´‚ú¨‚ú≠‚úÆ‚úØ‚ú∞‚ú±‚ú≤‚ú≥‚ú¥‚úµ‚ú∂‚ú∑‚ú∏‚úπ‚ú∫‚úª‚úº‚úΩ‚úæ‚úø‚ùÄ‚ùÅ‚ùÇ‚ùÉ‚ùÑ‚ùÖ‚ùÜ‚ùá‚ùà‚ùâ‚ùä‚ùã',
      'Emoji': '‚òÄ‚òÅ‚òÇ‚òÉ‚òÑ‚òÖ‚òÜ‚òá‚òà‚òâ‚òä‚òã‚òå‚òç‚òé‚òè‚òê‚òë‚òí‚òì‚òî‚òï‚òñ‚òó‚òò‚òô‚òö‚òõ‚òú‚òù‚òû‚òü‚ò†‚ò°‚ò¢‚ò£‚ò§‚ò•‚ò¶‚òß‚ò®‚ò©‚ò™‚ò´‚ò¨‚ò≠‚òÆ‚òØ'
    };

    let selectedSymbol = null;
    let currentSymbolCategory = 'Common';

    function showSymbolPicker() {
      document.getElementById('symbolModal').classList.add('visible');
      renderSymbolCategories();
      renderSymbolGrid('Common');
    }

    function hideSymbolPicker() {
      document.getElementById('symbolModal').classList.remove('visible');
    }

    function renderSymbolCategories() {
      const container = document.getElementById('symbolCategoryTabs');
      container.innerHTML = Object.keys(symbolCategories).map(cat =>
        `<button class="symbol-category-tab${cat === currentSymbolCategory ? ' active' : ''}"
                onclick="switchSymbolCategory('${cat}')">${cat}</button>`
      ).join('');
    }

    function switchSymbolCategory(category) {
      currentSymbolCategory = category;
      renderSymbolCategories();
      renderSymbolGrid(category);
    }

    function renderSymbolGrid(category) {
      const grid = document.getElementById('symbolGrid');
      const symbols = symbolCategories[category];
      grid.innerHTML = [...symbols].map(sym =>
        `<button class="symbol-btn" onclick="selectSymbol('${sym}')"
                onmouseenter="previewSymbol('${sym}')">${sym}</button>`
      ).join('');
    }

    function previewSymbol(sym) {
      document.getElementById('symbolPreviewChar').textContent = sym;
      document.getElementById('symbolPreviewInfo').textContent =
        `Unicode: U+${sym.charCodeAt(0).toString(16).toUpperCase().padStart(4, '0')}`;
    }

    function selectSymbol(sym) {
      selectedSymbol = sym;
      previewSymbol(sym);
      // Highlight selected
      document.querySelectorAll('.symbol-btn').forEach(btn => {
        btn.style.background = btn.textContent === sym ? '#cce5ff' : '';
      });
    }

    function insertSelectedSymbol() {
      if (selectedSymbol) {
        document.execCommand('insertText', false, selectedSymbol);
        showToast(`Inserted symbol: ${selectedSymbol}`, 'success');
      }
    }

    function insertImage() {
      const url = prompt('Enter image URL:');
      if (url) {
        document.execCommand('insertHTML', false, `<img src="${url}" style="max-width: 100%; height: auto; margin: 1rem 0;">`);
      }
    }

    function insertLink() {
      const url = prompt('Enter URL:');
      if (url) {
        document.execCommand('createLink', false, url);
      }
    }

    function insertHorizontalRule() {
      document.execCommand('insertHorizontalRule');
    }

    function insertPageBreak() {
      document.execCommand('insertHTML', false, '<div style="page-break-after: always; border-bottom: 2px dashed #ccc; margin: 2rem 0; text-align: center; color: #999; font-size: 0.8rem;">--- Page Break ---</div>');
    }

    function insertDateTime() {
      const now = new Date();
      document.execCommand('insertText', false, now.toLocaleString());
    }

    function insertMergeField(field) {
      document.execCommand('insertHTML', false, `<span class="merge-field">{{${field}}}</span>`);
      editor.focus();
    }

    // Templates
    const templates = {
      blank: '',
      letter: `<p style="text-align: right;">[Your Name]<br>[Your Address]<br>[City, State ZIP]<br>[Date]</p>
        <p><br></p>
        <p>[Recipient Name]<br>[Company Name]<br>[Address]<br>[City, State ZIP]</p>
        <p><br></p>
        <p>Dear [Recipient Name],</p>
        <p><br></p>
        <p>[Body of the letter goes here. Start with the purpose of your letter, provide necessary details in the middle paragraphs, and conclude with a call to action or summary.]</p>
        <p><br></p>
        <p>Sincerely,</p>
        <p><br></p>
        <p>[Your Name]</p>`,
      resume: `<h1 style="text-align: center; margin-bottom: 0;">[Your Name]</h1>
        <p style="text-align: center; color: #666; margin-top: 0.5rem;">[Email] | [Phone] | [Location] | [LinkedIn]</p>
        <hr style="margin: 1rem 0;">
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Professional Summary</h2>
        <p>[Brief professional summary highlighting key skills and experience]</p>
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Experience</h2>
        <p><strong>[Job Title]</strong> | [Company] | [Date Range]</p>
        <ul><li>[Achievement/responsibility]</li><li>[Achievement/responsibility]</li></ul>
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Education</h2>
        <p><strong>[Degree]</strong> | [University] | [Year]</p>
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Skills</h2>
        <p>[Skill 1] ‚Ä¢ [Skill 2] ‚Ä¢ [Skill 3] ‚Ä¢ [Skill 4]</p>`,
      report: `<h1 style="text-align: center;">[Report Title]</h1>
        <p style="text-align: center; color: #666;">[Author] | [Date]</p>
        <hr>
        <h2>Executive Summary</h2>
        <p>[Brief overview of the report's key findings and recommendations]</p>
        <h2>Introduction</h2>
        <p>[Background information and purpose of the report]</p>
        <h2>Methodology</h2>
        <p>[How the research or analysis was conducted]</p>
        <h2>Findings</h2>
        <p>[Detailed findings with supporting data]</p>
        <h2>Recommendations</h2>
        <ul><li>[Recommendation 1]</li><li>[Recommendation 2]</li></ul>
        <h2>Conclusion</h2>
        <p>[Summary and next steps]</p>`,
      invoice: `<div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
        <div><h1 style="color: #2b579a; margin: 0;">INVOICE</h1><p style="color: #666;">Invoice #: [Number]<br>Date: [Date]</p></div>
        <div style="text-align: right;"><strong>[Your Company]</strong><br>[Address]<br>[City, State ZIP]<br>[Email]</div>
        </div>
        <div style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem;"><strong>Bill To:</strong><br>[Client Name]<br>[Client Address]</div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
        <tr style="background: #2b579a; color: white;"><th style="padding: 0.75rem; text-align: left;">Description</th><th style="padding: 0.75rem; text-align: right;">Qty</th><th style="padding: 0.75rem; text-align: right;">Rate</th><th style="padding: 0.75rem; text-align: right;">Amount</th></tr>
        <tr><td style="padding: 0.75rem; border-bottom: 1px solid #ddd;">[Item 1]</td><td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #ddd;">1</td><td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #ddd;">$0.00</td><td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #ddd;">$0.00</td></tr>
        </table>
        <div style="text-align: right;"><p><strong>Subtotal:</strong> $0.00</p><p><strong>Tax:</strong> $0.00</p><p style="font-size: 1.25rem;"><strong>Total:</strong> $0.00</p></div>`,
      meeting: `<h1>[Meeting Title]</h1>
        <p><strong>Date:</strong> [Date] | <strong>Time:</strong> [Time] | <strong>Location:</strong> [Location]</p>
        <p><strong>Attendees:</strong> [Names]</p>
        <hr>
        <h2>Agenda</h2>
        <ol><li>[Agenda item 1]</li><li>[Agenda item 2]</li><li>[Agenda item 3]</li></ol>
        <h2>Discussion Notes</h2>
        <p>[Notes from the meeting]</p>
        <h2>Action Items</h2>
        <ul><li>‚òê [Task 1] - [Assigned to] - [Due date]</li><li>‚òê [Task 2] - [Assigned to] - [Due date]</li></ul>
        <h2>Next Meeting</h2>
        <p>[Date and time of next meeting]</p>`
    };

    function loadTemplate(name) {
      editor.innerHTML = templates[name];
      updateStats();
      showToast(`Loaded ${name} template`, 'success');
    }

    function showTemplates() {
      document.getElementById('templatesModal').classList.add('active');
    }

    function hideTemplates() {
      document.getElementById('templatesModal').classList.remove('active');
    }

    // Mail Merge
    function showMailMerge() {
      document.getElementById('mailMergeModal').classList.add('active');
    }

    function hideMailMerge() {
      document.getElementById('mailMergeModal').classList.remove('active');
    }

    function previewMerge() {
      const data = document.getElementById('mergeData').value;
      if (!data.trim()) {
        showToast('Please enter recipient data', 'warning');
        return;
      }

      const lines = data.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());

      if (lines.length < 2) {
        showToast('Please add at least one recipient', 'warning');
        return;
      }

      const values = lines[1].split(',').map(v => v.trim());
      let preview = editor.innerHTML;

      headers.forEach((header, i) => {
        const regex = new RegExp(`{{${header}}}`, 'g');
        preview = preview.replace(regex, `<mark>${values[i] || ''}</mark>`);
      });

      // Show preview in a new window
      const previewWindow = window.open('', '_blank', 'width=800,height=600');
      previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Mail Merge Preview</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 2rem; }
            mark { background: #fef08a; padding: 2px 4px; }
          </style>
        </head>
        <body>
          <h2>Mail Merge Preview (First Record)</h2>
          <hr>
          ${preview}
        </body>
        </html>
      `);

      showToast('Preview opened in new window', 'success');
    }

    function executeMerge() {
      const data = document.getElementById('mergeData').value;
      if (!data.trim()) {
        showToast('Please enter recipient data', 'warning');
        return;
      }

      const lines = data.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const template = editor.innerHTML;
      const documents = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        let doc = template;

        headers.forEach((header, j) => {
          const regex = new RegExp(`{{${header}}}`, 'g');
          doc = doc.replace(regex, values[j] || '');
        });

        documents.push(doc);
      }

      // Generate merged document
      editor.innerHTML = documents.join('<div style="page-break-after: always; border: 2px dashed #ccc; margin: 2rem 0; padding: 1rem; text-align: center; color: #666;">--- Document Separator ---</div>');
      hideMailMerge();
      showToast(`Generated ${documents.length} merged documents`, 'success');
      updateStats();
    }

    // PDF Export
    async function exportPDF() {
      showToast('Generating PDF...', 'info');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      const canvas = await html2canvas(editor, {
        scale: 2,
        useCORS: true,
        logging: false
      });

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;

      doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        doc.addPage();
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const fileName = document.getElementById('fileName').value || 'document';
      doc.save(`${fileName}.pdf`);
      showToast('PDF exported successfully!', 'success');
    }

    // Track changes functions
    function acceptAllChanges() {
      if (trackChangesEnabled) {
        originalContent = editor.innerHTML;
        changes = [];
        document.getElementById('changesList').innerHTML = '';
        showToast('All changes accepted', 'success');
      }
    }

    function rejectAllChanges() {
      if (trackChangesEnabled && originalContent) {
        editor.innerHTML = originalContent;
        changes = [];
        document.getElementById('changesList').innerHTML = '';
        showToast('All changes rejected', 'warning');
      }
    }

    function addComment() {
      const selection = window.getSelection();
      if (selection.toString()) {
        const comment = prompt('Enter your comment:');
        if (comment) {
          const span = document.createElement('span');
          span.style.background = '#fef08a';
          span.style.borderBottom = '2px solid #f59e0b';
          span.title = `Comment: ${comment}`;
          span.innerHTML = selection.toString();

          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(span);

          showToast('Comment added', 'success');
        }
      } else {
        showToast('Please select text to comment on', 'warning');
      }
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key.toLowerCase()) {
          case 'b':
            e.preventDefault();
            formatDoc('bold');
            break;
          case 'i':
            e.preventDefault();
            formatDoc('italic');
            break;
          case 'u':
            e.preventDefault();
            formatDoc('underline');
            break;
          case 's':
            e.preventDefault();
            saveDocument();
            break;
          case 'p':
            e.preventDefault();
            exportPDF();
            break;
        }
      }
    });

    // Auto-save current document (if saved before)
    setInterval(() => {
      if (currentDocId) {
        const docs = getSavedDocuments();
        docs[currentDocId] = {
          name: document.getElementById('fileName').value,
          content: editor.innerHTML,
          modified: Date.now()
        };
        saveDocs(docs);
      }
    }, 60000); // Auto-save every minute if document was previously saved

    // ==================== SCREENSHOT ====================
    async function insertScreenshot() {
      try {
        // Check if Screen Capture API is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
          showToast('Screen capture not supported in this browser', 'error');
          return;
        }

        showToast('Select a window or screen to capture...', 'info');

        // Request screen capture
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: { mediaSource: 'screen' }
        });

        // Create video element to capture frame
        const video = document.createElement('video');
        video.srcObject = stream;
        video.play();

        // Wait for video to load
        await new Promise(resolve => {
          video.onloadedmetadata = resolve;
        });

        // Small delay to ensure frame is ready
        await new Promise(resolve => setTimeout(resolve, 100));

        // Create canvas and capture frame
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Stop the stream
        stream.getTracks().forEach(track => track.stop());

        // Convert to data URL
        const dataUrl = canvas.toDataURL('image/png');

        // Insert image into editor
        const img = document.createElement('img');
        img.src = dataUrl;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.margin = '1rem 0';
        img.style.borderRadius = '4px';
        img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';

        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);
          range.collapse(false);
        } else {
          editor.appendChild(img);
        }

        showToast('Screenshot inserted', 'success');
        updateStatusBarWordCount();

      } catch (err) {
        if (err.name === 'NotAllowedError') {
          showToast('Screenshot cancelled', 'info');
        } else {
          console.error('Screenshot error:', err);
          showToast('Failed to capture screenshot', 'error');
        }
      }
    }

    // ==================== ZOOM CONTROLS ====================
    function zoomIn() {
      if (zoomLevel < 200) {
        zoomLevel += 10;
        applyZoom();
      }
    }

    function zoomOut() {
      if (zoomLevel > 50) {
        zoomLevel -= 10;
        applyZoom();
      }
    }

    function applyZoom() {
      const doc = document.getElementById('editor');
      doc.style.transform = `scale(${zoomLevel / 100})`;
      doc.style.transformOrigin = 'top center';
      document.getElementById('zoomLevel').textContent = zoomLevel + '%';
      document.getElementById('statusZoom').textContent = zoomLevel + '%';
    }

    // ==================== FIND & REPLACE ====================
    function showFindReplace() {
      document.getElementById('findReplaceBar').style.display = 'flex';
      document.getElementById('findInput').focus();
    }

    function hideFindReplace() {
      document.getElementById('findReplaceBar').style.display = 'none';
      clearHighlights();
    }

    function clearHighlights() {
      const editor = document.getElementById('editor');
      editor.innerHTML = editor.innerHTML.replace(/<mark class="highlight-find">|<mark class="highlight-current">/g, '').replace(/<\/mark>/g, '');
      findMatches = [];
      currentFindIndex = -1;
    }

    function findInDocument() {
      const searchText = document.getElementById('findInput').value;
      if (!searchText) {
        clearHighlights();
        document.getElementById('findCount').textContent = '0 results';
        return;
      }

      clearHighlights();
      const editor = document.getElementById('editor');
      const content = editor.innerHTML;
      const regex = new RegExp(`(${searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const newContent = content.replace(regex, '<mark class="highlight-find">$1</mark>');
      editor.innerHTML = newContent;

      findMatches = editor.querySelectorAll('mark.highlight-find');
      document.getElementById('findCount').textContent = findMatches.length + ' results';

      if (findMatches.length > 0) {
        currentFindIndex = 0;
        highlightCurrent();
      }
    }

    function highlightCurrent() {
      findMatches.forEach((m, i) => {
        m.className = i === currentFindIndex ? 'highlight-current' : 'highlight-find';
      });
      if (findMatches[currentFindIndex]) {
        findMatches[currentFindIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function findNext() {
      if (findMatches.length === 0) return;
      currentFindIndex = (currentFindIndex + 1) % findMatches.length;
      highlightCurrent();
    }

    function findPrev() {
      if (findMatches.length === 0) return;
      currentFindIndex = (currentFindIndex - 1 + findMatches.length) % findMatches.length;
      highlightCurrent();
    }

    function replaceOne() {
      if (findMatches.length === 0 || currentFindIndex < 0) return;
      const replaceText = document.getElementById('replaceInput').value;
      const current = findMatches[currentFindIndex];
      if (current) {
        current.outerHTML = replaceText;
        findInDocument();
        showToast('Replaced 1 occurrence', 'success');
      }
    }

    function replaceAll() {
      const searchText = document.getElementById('findInput').value;
      const replaceText = document.getElementById('replaceInput').value;
      if (!searchText) return;

      clearHighlights();
      const editor = document.getElementById('editor');
      const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const count = (editor.innerHTML.match(regex) || []).length;
      editor.innerHTML = editor.innerHTML.replace(regex, replaceText);
      showToast(`Replaced ${count} occurrences`, 'success');
      document.getElementById('findCount').textContent = '0 results';
    }

    // ==================== UNDO/REDO ====================
    function saveUndoState() {
      undoStack.push(editor.innerHTML);
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];
    }

    function customUndo() {
      if (undoStack.length > 0) {
        redoStack.push(editor.innerHTML);
        editor.innerHTML = undoStack.pop();
        updateStats();
      }
    }

    function customRedo() {
      if (redoStack.length > 0) {
        undoStack.push(editor.innerHTML);
        editor.innerHTML = redoStack.pop();
        updateStats();
      }
    }

    // Track changes for undo
    editor.addEventListener('input', () => {
      saveUndoState();
    });

    // ==================== DOCX IMPORT/EXPORT ====================
    function importDocx() {
      toggleFileMenu();
      document.getElementById('docxImport').click();
    }

    function handleDocxImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      showToast('Importing DOCX...', 'info');

      const reader = new FileReader();
      reader.onload = function(e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result })
          .then(function(result) {
            editor.innerHTML = result.value;
            document.getElementById('fileName').value = file.name.replace('.docx', '');
            currentDocId = null;
            updateStats();
            showToast('DOCX imported successfully!', 'success');
            if (result.messages.length > 0) {
              console.log('Mammoth messages:', result.messages);
            }
          })
          .catch(function(err) {
            showToast('Error importing DOCX: ' + err.message, 'error');
          });
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    async function exportDocx() {
      toggleFileMenu();
      showToast('Generating DOCX...', 'info');

      try {
        const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

        // Parse HTML content to create DOCX elements
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;

        const children = [];

        function processNode(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            if (text.trim()) {
              return [new TextRun({ text: text })];
            }
            return [];
          }

          if (node.nodeType !== Node.ELEMENT_NODE) return [];

          const tag = node.tagName.toLowerCase();
          const runs = [];

          if (tag === 'h1' || tag === 'h2' || tag === 'h3') {
            const level = tag === 'h1' ? HeadingLevel.HEADING_1 :
                          tag === 'h2' ? HeadingLevel.HEADING_2 : HeadingLevel.HEADING_3;
            children.push(new Paragraph({
              text: node.textContent,
              heading: level
            }));
          } else if (tag === 'p' || tag === 'div') {
            const textRuns = [];
            node.childNodes.forEach(child => {
              if (child.nodeType === Node.TEXT_NODE) {
                textRuns.push(new TextRun({ text: child.textContent }));
              } else if (child.nodeType === Node.ELEMENT_NODE) {
                const childTag = child.tagName.toLowerCase();
                const isBold = childTag === 'strong' || childTag === 'b' || child.style.fontWeight === 'bold';
                const isItalic = childTag === 'em' || childTag === 'i' || child.style.fontStyle === 'italic';
                const isUnderline = childTag === 'u' || child.style.textDecoration === 'underline';
                textRuns.push(new TextRun({
                  text: child.textContent,
                  bold: isBold,
                  italics: isItalic,
                  underline: isUnderline ? {} : undefined
                }));
              }
            });
            if (textRuns.length > 0 || node.textContent.trim()) {
              children.push(new Paragraph({ children: textRuns.length > 0 ? textRuns : [new TextRun({ text: node.textContent })] }));
            }
          } else if (tag === 'ul' || tag === 'ol') {
            node.querySelectorAll('li').forEach((li, idx) => {
              children.push(new Paragraph({
                text: (tag === 'ol' ? (idx + 1) + '. ' : '‚Ä¢ ') + li.textContent,
              }));
            });
          } else if (tag === 'br') {
            children.push(new Paragraph({}));
          } else {
            // Process children
            node.childNodes.forEach(child => processNode(child));
          }

          return runs;
        }

        tempDiv.childNodes.forEach(node => processNode(node));

        // If no content was parsed, add a placeholder
        if (children.length === 0) {
          children.push(new Paragraph({ text: editor.textContent || 'Empty document' }));
        }

        const doc = new Document({
          sections: [{
            properties: {},
            children: children
          }]
        });

        const blob = await Packer.toBlob(doc);
        const fileName = document.getElementById('fileName').value || 'document';
        saveAs(blob, fileName + '.docx');
        showToast('DOCX exported successfully!', 'success');
      } catch (err) {
        console.error('DOCX export error:', err);
        showToast('Error exporting DOCX: ' + err.message, 'error');
      }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        showFindReplace();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
        e.preventDefault();
        showFindReplace();
        document.getElementById('replaceInput').focus();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        customUndo();
      }
      if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) {
        e.preventDefault();
        customRedo();
      }
      if (e.key === 'Escape') {
        hideFindReplace();
      }
    });

    // Initialize undo state
    saveUndoState();

    // ==================== PAGE SETUP & VIEW ====================
    let pageSettings = {
      paperSize: 'letter',
      orientation: 'portrait',
      marginTop: 1,
      marginBottom: 1,
      marginLeft: 1,
      marginRight: 1,
      headerText: '',
      footerText: '',
      showPageNumbers: true,
      pageNumberPosition: 'bottom-center'
    };

    function toggleRuler() {
      const ruler = document.getElementById('ruler');
      ruler.style.display = ruler.style.display === 'none' ? 'flex' : 'none';
      showToast(ruler.style.display === 'none' ? 'Ruler hidden' : 'Ruler shown', 'info');
    }

    function showPageSetup() {
      document.getElementById('paperSize').value = pageSettings.paperSize;
      document.getElementById('pageOrientation').value = pageSettings.orientation;
      document.getElementById('marginTop').value = pageSettings.marginTop;
      document.getElementById('marginBottom').value = pageSettings.marginBottom;
      document.getElementById('marginLeft').value = pageSettings.marginLeft;
      document.getElementById('marginRight').value = pageSettings.marginRight;
      document.getElementById('headerText').value = pageSettings.headerText;
      document.getElementById('footerText').value = pageSettings.footerText;
      document.getElementById('showPageNumbers').checked = pageSettings.showPageNumbers;
      document.getElementById('pageNumberPosition').value = pageSettings.pageNumberPosition;
      document.getElementById('pageSetupModal').classList.add('active');
    }

    function hidePageSetup() {
      document.getElementById('pageSetupModal').classList.remove('active');
    }

    function applyPageSetup() {
      pageSettings = {
        paperSize: document.getElementById('paperSize').value,
        orientation: document.getElementById('pageOrientation').value,
        marginTop: parseFloat(document.getElementById('marginTop').value),
        marginBottom: parseFloat(document.getElementById('marginBottom').value),
        marginLeft: parseFloat(document.getElementById('marginLeft').value),
        marginRight: parseFloat(document.getElementById('marginRight').value),
        headerText: document.getElementById('headerText').value,
        footerText: document.getElementById('footerText').value,
        showPageNumbers: document.getElementById('showPageNumbers').checked,
        pageNumberPosition: document.getElementById('pageNumberPosition').value
      };

      // Apply margins to document
      const doc = document.getElementById('editor');
      doc.style.padding = `${pageSettings.marginTop}in ${pageSettings.marginRight}in ${pageSettings.marginBottom}in ${pageSettings.marginLeft}in`;

      // Apply paper size
      const sizes = {
        letter: { width: '8.5in', height: '11in' },
        a4: { width: '210mm', height: '297mm' },
        legal: { width: '8.5in', height: '14in' }
      };
      const size = sizes[pageSettings.paperSize];

      if (pageSettings.orientation === 'landscape') {
        doc.style.width = size.height;
        doc.style.minHeight = size.width;
      } else {
        doc.style.width = size.width;
        doc.style.minHeight = size.height;
      }

      hidePageSetup();
      showToast('Page setup applied', 'success');
    }

    function toggleHeaderFooter() {
      showPageSetup();
      document.getElementById('headerText').focus();
    }

    // ==================== LINE & PARAGRAPH SPACING ====================
    function setLineSpacing(value) {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        let container = range.commonAncestorContainer;
        if (container.nodeType === Node.TEXT_NODE) {
          container = container.parentElement;
        }
        // Find block-level parent
        while (container && !['P', 'DIV', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(container.tagName)) {
          container = container.parentElement;
        }
        if (container) {
          container.style.lineHeight = value;
        }
      }
      // Also set default for new content
      editor.style.lineHeight = value;
      showToast(`Line spacing set to ${value}`, 'info');
    }

    function setParagraphSpacing(type) {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        let container = range.commonAncestorContainer;
        if (container.nodeType === Node.TEXT_NODE) {
          container = container.parentElement;
        }
        while (container && !['P', 'DIV', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(container.tagName)) {
          container = container.parentElement;
        }
        if (container) {
          if (type === 'before') {
            const current = parseInt(container.style.marginTop) || 0;
            container.style.marginTop = (current + 12) + 'px';
          } else {
            const current = parseInt(container.style.marginBottom) || 0;
            container.style.marginBottom = (current + 12) + 'px';
          }
          showToast(`Added space ${type} paragraph`, 'info');
        }
      }
    }

    // ==================== STYLES ====================
    function showStylesPanel() {
      document.getElementById('stylesModal').classList.add('active');
    }

    function hideStylesPanel() {
      document.getElementById('stylesModal').classList.remove('active');
    }

    function applyStyle(styleName) {
      const selection = window.getSelection();
      if (!selection.rangeCount) {
        showToast('Please select some text first', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);
      let container = range.commonAncestorContainer;
      if (container.nodeType === Node.TEXT_NODE) {
        container = container.parentElement;
      }

      const styles = {
        title: { tag: 'h1', css: 'font-size: 28pt; font-weight: bold; text-align: center; margin-bottom: 0.5em;' },
        heading1: { tag: 'h1', css: 'font-size: 20pt; font-weight: bold; color: #1a73e8; margin-top: 1em; margin-bottom: 0.5em;' },
        heading2: { tag: 'h2', css: 'font-size: 16pt; font-weight: bold; color: #1a73e8; margin-top: 0.8em; margin-bottom: 0.4em;' },
        heading3: { tag: 'h3', css: 'font-size: 14pt; font-weight: bold; margin-top: 0.6em; margin-bottom: 0.3em;' },
        normal: { tag: 'p', css: 'font-size: 12pt; font-weight: normal; color: #000; margin-bottom: 0.5em;' },
        quote: { tag: 'blockquote', css: 'font-size: 12pt; font-style: italic; border-left: 3px solid #ccc; padding-left: 1em; margin: 1em 0; color: #555;' },
        subtitle: { tag: 'p', css: 'font-size: 14pt; color: #666; text-align: center; margin-bottom: 1em;' },
        code: { tag: 'pre', css: 'font-family: monospace; background: #f5f5f5; padding: 0.5em; border-radius: 4px; overflow-x: auto;' }
      };

      const style = styles[styleName];
      if (!style) return;

      // Create new element with style
      const newElement = document.createElement(style.tag);
      newElement.style.cssText = style.css;
      newElement.innerHTML = range.toString() || container.innerHTML;

      // Replace selection or container
      if (range.toString()) {
        range.deleteContents();
        range.insertNode(newElement);
      } else {
        container.outerHTML = newElement.outerHTML;
      }

      hideStylesPanel();
      showToast(`Applied ${styleName} style`, 'success');
    }

    // ==================== PRINT PREVIEW ====================
    function togglePrintPreview() {
      const preview = document.getElementById('printPreviewContent');
      preview.innerHTML = editor.innerHTML;
      preview.style.width = pageSettings.orientation === 'landscape' ? '11in' : '8.5in';
      preview.style.minHeight = pageSettings.orientation === 'landscape' ? '8.5in' : '11in';
      preview.style.padding = `${pageSettings.marginTop}in ${pageSettings.marginRight}in ${pageSettings.marginBottom}in ${pageSettings.marginLeft}in`;

      // Add header if set
      if (pageSettings.headerText) {
        const header = document.createElement('div');
        header.style.cssText = 'text-align: center; font-size: 10pt; color: #666; border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 16px;';
        header.textContent = pageSettings.headerText;
        preview.insertBefore(header, preview.firstChild);
      }

      // Add footer if set
      if (pageSettings.footerText || pageSettings.showPageNumbers) {
        const footer = document.createElement('div');
        footer.style.cssText = 'text-align: center; font-size: 10pt; color: #666; border-top: 1px solid #ccc; padding-top: 8px; margin-top: 16px; position: absolute; bottom: 0.5in; left: 0; right: 0;';
        let footerContent = pageSettings.footerText || '';
        if (pageSettings.showPageNumbers) {
          footerContent += (footerContent ? ' | ' : '') + 'Page 1';
        }
        footer.textContent = footerContent;
        preview.style.position = 'relative';
        preview.appendChild(footer);
      }

      document.getElementById('printPreviewModal').classList.add('active');
    }

    function hidePrintPreview() {
      document.getElementById('printPreviewModal').classList.remove('active');
    }

    // ==================== TAB SWITCHING ====================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Hide all toolbars
        ['homeToolbar', 'insertToolbar', 'reviewToolbar', 'viewToolbar'].forEach(id => {
          document.getElementById(id).style.display = 'none';
        });

        // Show selected toolbar
        const tabName = tab.dataset.tab;
        const toolbarMap = {
          home: 'homeToolbar',
          insert: 'insertToolbar',
          review: 'reviewToolbar',
          view: 'viewToolbar'
        };

        if (toolbarMap[tabName]) {
          document.getElementById(toolbarMap[tabName]).style.display = 'flex';
        }
      });
    });

    // ==================== TABLE OF CONTENTS ====================
    let bookmarks = {};

    function insertTableOfContents() {
      // Find all headings in the document
      const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');

      if (headings.length === 0) {
        showToast('No headings found. Add headings (H1-H6) to generate TOC.', 'warning');
        return;
      }

      let tocHtml = '<div class="toc-container" style="border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; background: #fafafa;">';
      tocHtml += '<h3 style="margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Table of Contents</h3>';
      tocHtml += '<div class="toc-entries">';

      headings.forEach((heading, index) => {
        const level = parseInt(heading.tagName.charAt(1));
        const indent = (level - 1) * 20;
        const text = heading.textContent;
        const anchorId = 'toc-anchor-' + index;

        // Add anchor to heading if not present
        if (!heading.id) {
          heading.id = anchorId;
        }

        tocHtml += `<div class="toc-entry" style="margin-left: ${indent}px; padding: 0.25rem 0;">`;
        tocHtml += `<a href="#${heading.id}" style="color: #1a73e8; text-decoration: none;" onclick="document.getElementById('${heading.id}').scrollIntoView({behavior:'smooth'}); return false;">${text}</a>`;
        tocHtml += '</div>';
      });

      tocHtml += '</div></div>';

      // Insert at cursor position or at beginning
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        document.execCommand('insertHTML', false, tocHtml);
      } else {
        editor.insertAdjacentHTML('afterbegin', tocHtml);
      }

      showToast(`Table of Contents created with ${headings.length} entries`, 'success');
    }

    // ==================== FOOTNOTES ====================
    let footnotes = [];
    let footnoteCounter = 1;

    function insertFootnote() {
      const selection = window.getSelection();
      const footnoteText = prompt('Enter footnote text:');

      if (!footnoteText) return;

      const footnoteNum = footnoteCounter++;
      footnotes.push({ num: footnoteNum, text: footnoteText });

      // Insert superscript reference at cursor
      const refHtml = `<sup class="footnote-ref" style="color: #1a73e8; cursor: pointer;" onclick="scrollToFootnote(${footnoteNum})" title="${footnoteText}">[${footnoteNum}]</sup>`;
      document.execCommand('insertHTML', false, refHtml);

      // Update footnotes section at bottom
      updateFootnotesSection();

      showToast(`Footnote ${footnoteNum} added`, 'success');
    }

    function scrollToFootnote(num) {
      const footnoteEl = document.getElementById('footnote-' + num);
      if (footnoteEl) {
        footnoteEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        footnoteEl.style.background = '#fff3cd';
        setTimeout(() => { footnoteEl.style.background = ''; }, 2000);
      }
    }

    function updateFootnotesSection() {
      // Remove existing footnotes section
      const existing = editor.querySelector('.footnotes-section');
      if (existing) existing.remove();

      if (footnotes.length === 0) return;

      let footnotesHtml = '<div class="footnotes-section" style="border-top: 1px solid #ccc; margin-top: 2rem; padding-top: 1rem; font-size: 0.9em;">';
      footnotesHtml += '<h4 style="margin-top: 0; color: #666;">Footnotes</h4>';

      footnotes.forEach(fn => {
        footnotesHtml += `<div id="footnote-${fn.num}" class="footnote-item" style="margin-bottom: 0.5rem;">`;
        footnotesHtml += `<sup style="color: #1a73e8;">[${fn.num}]</sup> ${fn.text}`;
        footnotesHtml += '</div>';
      });

      footnotesHtml += '</div>';
      editor.insertAdjacentHTML('beforeend', footnotesHtml);
    }

    // ==================== BOOKMARKS ====================
    function insertBookmark() {
      const selection = window.getSelection();
      const bookmarkName = prompt('Enter bookmark name:');

      if (!bookmarkName) return;

      // Sanitize bookmark name
      const sanitizedName = bookmarkName.replace(/[^a-zA-Z0-9_-]/g, '_');

      if (bookmarks[sanitizedName]) {
        if (!confirm(`Bookmark "${bookmarkName}" already exists. Replace it?`)) return;
      }

      // Create bookmark anchor
      const bookmarkHtml = `<span id="bookmark-${sanitizedName}" class="bookmark-anchor" style="border-left: 3px solid #1a73e8; padding-left: 4px; background: #e8f0fe;" title="Bookmark: ${bookmarkName}">&#8203;</span>`;

      if (selection.rangeCount > 0 && selection.toString()) {
        // Wrap selected text
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.id = 'bookmark-' + sanitizedName;
        span.className = 'bookmark-anchor';
        span.style.cssText = 'border-left: 3px solid #1a73e8; padding-left: 4px; background: #e8f0fe;';
        span.title = 'Bookmark: ' + bookmarkName;
        range.surroundContents(span);
      } else {
        document.execCommand('insertHTML', false, bookmarkHtml);
      }

      bookmarks[sanitizedName] = bookmarkName;
      showToast(`Bookmark "${bookmarkName}" added`, 'success');
    }

    function goToBookmark(name) {
      const bookmark = document.getElementById('bookmark-' + name);
      if (bookmark) {
        bookmark.scrollIntoView({ behavior: 'smooth', block: 'center' });
        bookmark.style.background = '#fff3cd';
        setTimeout(() => { bookmark.style.background = '#e8f0fe'; }, 2000);
      }
    }

    // ==================== WATERMARKS ====================
    function insertWatermark() {
      document.getElementById('watermarkModal').style.display = 'flex';
    }

    function hideWatermarkModal() {
      document.getElementById('watermarkModal').style.display = 'none';
    }

    function setWatermarkPreset(text) {
      document.getElementById('watermarkText').value = text;
    }

    function applyWatermark() {
      const watermarkText = document.getElementById('watermarkText').value.trim();
      if (!watermarkText) {
        showToast('Please enter watermark text', 'error');
        return;
      }

      const color = document.getElementById('watermarkColor').value;
      const opacity = document.getElementById('watermarkOpacity').value / 100;
      const size = document.getElementById('watermarkSize').value;
      const layout = document.getElementById('watermarkLayout').value;

      // Convert hex to rgba
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      const rgbaColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;

      // Remove existing watermark
      const existing = document.querySelector('.document-watermark');
      if (existing) existing.remove();

      // Add watermark style to document area
      const docArea = document.getElementById('documentArea');
      const watermark = document.createElement('div');
      watermark.className = 'document-watermark';

      const rotation = layout === 'diagonal' ? 'rotate(-45deg)' : 'rotate(0deg)';

      watermark.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) ${rotation};
        font-size: ${size}px;
        font-weight: bold;
        color: ${rgbaColor};
        pointer-events: none;
        z-index: 1;
        white-space: nowrap;
        user-select: none;
        text-transform: uppercase;
        letter-spacing: 4px;
      `;
      watermark.textContent = watermarkText;

      docArea.style.position = 'relative';
      docArea.appendChild(watermark);

      hideWatermarkModal();
      showToast(`Watermark "${watermarkText}" added`, 'success');
    }

    function removeWatermark() {
      const watermark = document.querySelector('.document-watermark');
      if (watermark) {
        watermark.remove();
        showToast('Watermark removed', 'success');
      }
      hideWatermarkModal();
    }

    // ==================== COLUMNS LAYOUT ====================
    function setColumns() {
      const numCols = prompt('Number of columns (1-4):', '2');

      if (!numCols || numCols < 1 || numCols > 4) {
        showToast('Please enter a number between 1 and 4', 'warning');
        return;
      }

      const selection = window.getSelection();

      if (selection.rangeCount > 0 && selection.toString().trim()) {
        // Wrap selected text in columns
        const range = selection.getRangeAt(0);
        const wrapper = document.createElement('div');
        wrapper.style.cssText = `column-count: ${numCols}; column-gap: 2rem; column-rule: 1px solid #ddd;`;
        wrapper.className = 'column-layout';

        const content = range.extractContents();
        wrapper.appendChild(content);
        range.insertNode(wrapper);
      } else {
        // Apply columns to entire document
        editor.style.columnCount = numCols;
        editor.style.columnGap = '2rem';
        editor.style.columnRule = '1px solid #ddd';
      }

      showToast(`${numCols}-column layout applied`, 'success');
    }

    function resetColumns() {
      editor.style.columnCount = '';
      editor.style.columnGap = '';
      editor.style.columnRule = '';

      // Also remove any column wrappers
      editor.querySelectorAll('.column-layout').forEach(el => {
        el.outerHTML = el.innerHTML;
      });

      showToast('Column layout reset', 'success');
    }

    // ==================== ENHANCED SPELL CHECK ====================
    const commonMisspellings = {
      'teh': 'the', 'recieve': 'receive', 'seperate': 'separate', 'occured': 'occurred',
      'definately': 'definitely', 'accomodate': 'accommodate', 'occassion': 'occasion',
      'independant': 'independent', 'concensus': 'consensus', 'occurence': 'occurrence',
      'beleive': 'believe', 'refered': 'referred', 'untill': 'until', 'wierd': 'weird',
      'truely': 'truly', 'existance': 'existence', 'suprise': 'surprise', 'goverment': 'government',
      'enviroment': 'environment', 'millenium': 'millennium', 'knowlege': 'knowledge',
      'mispell': 'misspell', 'adress': 'address', 'begining': 'beginning', 'calender': 'calendar',
      'collegue': 'colleague', 'commited': 'committed', 'competetive': 'competitive',
      'consciencious': 'conscientious', 'copywrite': 'copyright', 'dilemna': 'dilemma',
      'dissapear': 'disappear', 'dissapoint': 'disappoint', 'embarass': 'embarrass',
      'equiptment': 'equipment', 'exagerate': 'exaggerate', 'excercise': 'exercise',
      'experiance': 'experience', 'foriegn': 'foreign', 'fourty': 'forty', 'freind': 'friend',
      'gaurd': 'guard', 'greatful': 'grateful', 'harrass': 'harass', 'heighth': 'height',
      'humourous': 'humorous', 'immediatly': 'immediately', 'intresting': 'interesting',
      'judgement': 'judgment', 'liason': 'liaison', 'maintainance': 'maintenance',
      'manuever': 'maneuver', 'miniture': 'miniature', 'neccessary': 'necessary',
      'noticable': 'noticeable', 'persistant': 'persistent', 'posession': 'possession',
      'prefered': 'preferred', 'priviledge': 'privilege', 'profesional': 'professional',
      'publically': 'publicly', 'recomend': 'recommend', 'rediculous': 'ridiculous',
      'relevent': 'relevant', 'rythm': 'rhythm', 'sacrilegious': 'sacrilegious',
      'schedual': 'schedule', 'sieze': 'seize', 'succesful': 'successful', 'supercede': 'supersede',
      'thier': 'their', 'tommorow': 'tomorrow', 'tyrany': 'tyranny', 'usally': 'usually',
      'vaccum': 'vacuum', 'vegatable': 'vegetable', 'visious': 'vicious', 'wether': 'whether'
    };

    let customDictionary = JSON.parse(localStorage.getItem('customDictionary') || '[]');
    let spellingErrors = [];

    function runSpellCheck() {
      const text = editor.innerText;
      const words = text.match(/\b[a-zA-Z]+\b/g) || [];
      spellingErrors = [];

      const suggestionsDiv = document.getElementById('spellingSuggestions');
      suggestionsDiv.innerHTML = '';

      words.forEach(word => {
        const lower = word.toLowerCase();
        if (commonMisspellings[lower] && !customDictionary.includes(lower)) {
          spellingErrors.push({
            word: word,
            suggestion: commonMisspellings[lower]
          });
        }
      });

      if (spellingErrors.length === 0) {
        suggestionsDiv.innerHTML = '<p style="color: green;">No spelling errors found!</p>';
        showToast('Spell check complete - no errors', 'success');
      } else {
        const uniqueErrors = [...new Map(spellingErrors.map(e => [e.word.toLowerCase(), e])).values()];
        suggestionsDiv.innerHTML = uniqueErrors.slice(0, 10).map(err => `
          <div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
            <span style="color: #ea4335; text-decoration: line-through;">${err.word}</span>
            <span style="color: var(--secondary);">‚Üí</span>
            <span style="color: #34a853; cursor: pointer;" onclick="correctSpelling('${err.word}', '${err.suggestion}')">${err.suggestion}</span>
            <button class="btn btn-secondary" style="float: right; padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="addToDict('${err.word.toLowerCase()}')">Add to Dict</button>
          </div>
        `).join('');
        showToast(`Found ${uniqueErrors.length} potential spelling error(s)`, 'warning');
      }
    }

    function correctSpelling(wrong, right) {
      const html = editor.innerHTML;
      const regex = new RegExp('\\b' + wrong + '\\b', 'gi');
      editor.innerHTML = html.replace(regex, right);
      runSpellCheck();
      showToast('Corrected: ' + wrong + ' ‚Üí ' + right, 'success');
    }

    function addToDict(word) {
      if (!customDictionary.includes(word)) {
        customDictionary.push(word);
        localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
        runSpellCheck();
        showToast('Added to dictionary: ' + word, 'success');
      }
    }

    // ==================== DOCUMENT OUTLINE ====================
    function refreshOutline() {
      const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
      const outlineList = document.getElementById('outlineList');

      if (headings.length === 0) {
        outlineList.innerHTML = '<p style="color: var(--secondary);">No headings found. Add H1-H6 headings to see outline.</p>';
        return;
      }

      outlineList.innerHTML = Array.from(headings).map((h, i) => {
        const level = parseInt(h.tagName.charAt(1));
        const indent = (level - 1) * 12;
        const text = h.textContent.substring(0, 40) + (h.textContent.length > 40 ? '...' : '');
        if (!h.id) h.id = 'heading-' + i;
        return `
          <div style="padding: 0.3rem; padding-left: ${indent}px; cursor: pointer; border-radius: 4px;"
               onmouseover="this.style.background='var(--light)'"
               onmouseout="this.style.background=''"
               onclick="scrollToHeading('${h.id}')">
            <span style="color: var(--secondary); font-size: 0.7rem;">H${level}</span> ${text}
          </div>
        `;
      }).join('');
    }

    function scrollToHeading(id) {
      const heading = document.getElementById(id);
      if (heading) {
        heading.scrollIntoView({ behavior: 'smooth', block: 'center' });
        heading.style.background = '#fff3cd';
        setTimeout(() => { heading.style.background = ''; }, 2000);
      }
    }

    // Auto-refresh outline on content change
    let outlineTimeout;
    editor.addEventListener('input', () => {
      clearTimeout(outlineTimeout);
      outlineTimeout = setTimeout(refreshOutline, 1000);
    });

    // ==================== SECTION BREAKS ====================
    function insertSectionBreak() {
      const breakType = prompt('Section break type:\n1. Next Page\n2. Continuous\n3. Even Page\n4. Odd Page\n\nEnter number (1-4):', '1');

      if (!breakType) return;

      const types = {
        '1': { label: 'Next Page', style: 'page-break-after: always;' },
        '2': { label: 'Continuous', style: 'border-top: 2px dashed #ccc; margin: 1rem 0;' },
        '3': { label: 'Even Page', style: 'page-break-after: left;' },
        '4': { label: 'Odd Page', style: 'page-break-after: right;' }
      };

      const type = types[breakType] || types['1'];

      const breakHtml = `<div class="section-break" contenteditable="false" style="${type.style} padding: 0.5rem; text-align: center; color: #999; font-size: 0.8rem; background: #f5f5f5;">--- Section Break (${type.label}) ---</div>`;

      document.execCommand('insertHTML', false, breakHtml);
      showToast(`${type.label} section break inserted`, 'success');
    }

    // ==================== PAGE BORDERS ====================
    function showPageBorders() {
      updateBorderPreview();
      document.getElementById('pageBordersModal').classList.add('active');

      // Add change listeners for preview
      ['borderStyle', 'borderWidth', 'borderColor', 'borderArt'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateBorderPreview);
      });
    }

    function hidePageBorders() {
      document.getElementById('pageBordersModal').classList.remove('active');
    }

    function updateBorderPreview() {
      const style = document.getElementById('borderStyle').value;
      const width = document.getElementById('borderWidth').value;
      const color = document.getElementById('borderColor').value;
      const art = document.getElementById('borderArt').value;

      const preview = document.getElementById('borderPreview');

      if (style === 'none') {
        preview.style.border = 'none';
        preview.style.boxShadow = 'none';
        preview.style.borderRadius = '0';
      } else {
        preview.style.border = `${width} ${style} ${color}`;

        if (art === 'shadow') {
          preview.style.boxShadow = `5px 5px 10px rgba(0,0,0,0.3)`;
        } else {
          preview.style.boxShadow = 'none';
        }

        if (art === 'rounded') {
          preview.style.borderRadius = '10px';
        } else {
          preview.style.borderRadius = '0';
        }
      }
    }

    function applyPageBorders() {
      const style = document.getElementById('borderStyle').value;
      const width = document.getElementById('borderWidth').value;
      const color = document.getElementById('borderColor').value;
      const art = document.getElementById('borderArt').value;

      const docArea = document.getElementById('documentArea');

      if (style === 'none') {
        docArea.style.border = 'none';
        docArea.style.boxShadow = 'none';
        docArea.style.borderRadius = '0';
      } else {
        docArea.style.border = `${width} ${style} ${color}`;

        if (art === 'shadow') {
          docArea.style.boxShadow = `5px 5px 15px rgba(0,0,0,0.3)`;
        } else {
          docArea.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
        }

        if (art === 'rounded') {
          docArea.style.borderRadius = '10px';
        } else {
          docArea.style.borderRadius = '0';
        }
      }

      hidePageBorders();
      showToast('Page borders applied', 'success');
    }

    function removePageBorders() {
      const docArea = document.getElementById('documentArea');
      docArea.style.border = 'none';
      docArea.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
      docArea.style.borderRadius = '0';
      hidePageBorders();
      showToast('Page borders removed', 'success');
    }

    // ==================== DROP CAP ====================
    function insertDropCap() {
      const selection = window.getSelection();
      if (!selection.rangeCount) {
        showToast('Place cursor at the beginning of a paragraph', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);
      let node = range.startContainer;

      // Find the paragraph
      while (node && node.nodeName !== 'P' && node !== editor) {
        node = node.parentNode;
      }

      if (!node || node === editor) {
        showToast('Place cursor in a paragraph', 'warning');
        return;
      }

      const text = node.textContent;
      if (text.length < 2) return;

      const firstChar = text.charAt(0);
      const restText = text.slice(1);

      node.innerHTML = `<span class="drop-cap" style="float: left; font-size: 3.5em; line-height: 0.8; padding-right: 8px; padding-top: 4px; font-weight: bold; color: #1a73e8;">${firstChar}</span>${restText}`;

      showToast('Drop cap added', 'success');
    }

    // ==================== ENHANCED STATS ====================
    function updateStats() {
      const text = editor.innerText || '';
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const chars = text.length;
      const paras = (editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li').length) || 1;
      const readingTime = Math.ceil(words / 200); // Average 200 words per minute

      document.getElementById('wordCount').textContent = words;
      document.getElementById('charCount').textContent = chars;
      document.getElementById('paraCount').textContent = paras;
      document.getElementById('readingTime').textContent = readingTime;
    }

    // Initialize outline on load
    setTimeout(refreshOutline, 500);

    // ==================== DOCUMENT COMPARISON ====================
    let lastDiffResult = null;

    function showCompareDocuments() {
      // Populate saved documents in dropdown
      const docs = getSavedDocuments();
      const revisedSelect = document.getElementById('compareRevised');
      const originalSelect = document.getElementById('compareOriginal');

      // Reset
      revisedSelect.innerHTML = '<option value="">Select a document...</option>';
      originalSelect.innerHTML = '<option value="current">Current Document</option>';

      Object.entries(docs).forEach(([id, doc]) => {
        revisedSelect.innerHTML += `<option value="${id}">${doc.name}</option>`;
        originalSelect.innerHTML += `<option value="${id}">${doc.name}</option>`;
      });

      document.getElementById('compareResults').style.display = 'none';
      document.getElementById('applyDiffBtn').style.display = 'none';
      document.getElementById('compareText').value = '';
      document.getElementById('compareModal').classList.add('active');
    }

    function hideCompareDocuments() {
      document.getElementById('compareModal').classList.remove('active');
    }

    function runComparison() {
      const originalSelect = document.getElementById('compareOriginal').value;
      const revisedSelect = document.getElementById('compareRevised').value;
      const pastedText = document.getElementById('compareText').value.trim();

      // Get original text
      let originalText;
      if (originalSelect === 'current') {
        originalText = editor.innerText;
      } else {
        const docs = getSavedDocuments();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = docs[originalSelect].content;
        originalText = tempDiv.innerText;
      }

      // Get revised text
      let revisedText;
      if (pastedText) {
        revisedText = pastedText;
      } else if (revisedSelect) {
        const docs = getSavedDocuments();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = docs[revisedSelect].content;
        revisedText = tempDiv.innerText;
      } else {
        showToast('Please select a document or paste text to compare', 'warning');
        return;
      }

      // Perform diff
      const diff = computeDiff(originalText, revisedText);
      displayDiff(diff);
      lastDiffResult = { original: originalText, revised: revisedText, diff };

      document.getElementById('compareResults').style.display = 'block';
      document.getElementById('applyDiffBtn').style.display = 'inline-block';
    }

    function computeDiff(original, revised) {
      const originalLines = original.split('\n');
      const revisedLines = revised.split('\n');
      const result = [];

      let additions = 0, deletions = 0, modifications = 0;

      // Simple line-by-line diff
      const maxLen = Math.max(originalLines.length, revisedLines.length);

      for (let i = 0; i < maxLen; i++) {
        const origLine = originalLines[i] || '';
        const revLine = revisedLines[i] || '';

        if (origLine === revLine) {
          if (origLine.trim()) {
            result.push({ type: 'same', text: origLine });
          }
        } else if (!origLine.trim() && revLine.trim()) {
          result.push({ type: 'added', text: revLine });
          additions++;
        } else if (origLine.trim() && !revLine.trim()) {
          result.push({ type: 'removed', text: origLine });
          deletions++;
        } else {
          result.push({ type: 'removed', text: origLine });
          result.push({ type: 'added', text: revLine });
          modifications++;
        }
      }

      return { lines: result, stats: { additions, deletions, modifications } };
    }

    function displayDiff(diff) {
      const output = document.getElementById('diffOutput');
      output.innerHTML = '';

      diff.lines.forEach(line => {
        const div = document.createElement('div');
        div.style.padding = '2px 4px';
        div.style.margin = '1px 0';

        if (line.type === 'added') {
          div.style.background = '#d4edda';
          div.textContent = '+ ' + line.text;
        } else if (line.type === 'removed') {
          div.style.background = '#f8d7da';
          div.style.textDecoration = 'line-through';
          div.textContent = '- ' + line.text;
        } else {
          div.textContent = '  ' + line.text;
        }

        output.appendChild(div);
      });

      document.getElementById('diffSummary').textContent =
        `${diff.stats.additions} additions, ${diff.stats.deletions} deletions, ${diff.stats.modifications} modifications`;
    }

    function applyDiffToDocument() {
      if (!lastDiffResult) return;

      if (confirm('Replace current document content with the revised version?')) {
        editor.innerText = lastDiffResult.revised;
        updateStats();
        hideCompareDocuments();
        showToast('Document updated with revised content', 'success');
      }
    }

    // ==================== REVISION HISTORY ====================
    const REVISION_KEY = 'ninjaword_revisions';

    function getRevisions() {
      const revs = localStorage.getItem(REVISION_KEY);
      return revs ? JSON.parse(revs) : [];
    }

    function saveRevisions(revs) {
      // Keep only last 20 revisions
      if (revs.length > 20) revs = revs.slice(-20);
      localStorage.setItem(REVISION_KEY, JSON.stringify(revs));
    }

    function showRevisionHistory() {
      const revisions = getRevisions();
      const list = document.getElementById('revisionList');

      if (revisions.length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 2rem;">No revisions saved yet.</p>';
      } else {
        list.innerHTML = revisions.map((rev, idx) => `
          <div style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer;"
               onmouseover="this.style.background='var(--light)'" onmouseout="this.style.background='white'">
            <div style="flex: 1;" onclick="previewRevision(${idx})">
              <div style="font-weight: 500;">${rev.name || 'Revision ' + (idx + 1)}</div>
              <div style="font-size: 0.8rem; color: var(--secondary);">
                ${new Date(rev.timestamp).toLocaleString()} - ${rev.wordCount} words
              </div>
            </div>
            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.5rem;"
                    onclick="event.stopPropagation(); restoreRevision(${idx})">Restore</button>
            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                    onclick="event.stopPropagation(); deleteRevision(${idx})">Delete</button>
          </div>
        `).reverse().join('');
      }

      document.getElementById('revisionHistoryModal').classList.add('active');
    }

    function hideRevisionHistory() {
      document.getElementById('revisionHistoryModal').classList.remove('active');
    }

    function saveRevision() {
      const revisions = getRevisions();
      const text = editor.innerText;
      const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;

      revisions.push({
        content: editor.innerHTML,
        timestamp: Date.now(),
        name: document.getElementById('fileName').value,
        wordCount: wordCount
      });

      saveRevisions(revisions);
      showRevisionHistory(); // Refresh
      showToast('Revision saved', 'success');
    }

    function restoreRevision(idx) {
      const revisions = getRevisions();
      if (revisions[idx] && confirm('Restore this revision? Current content will be replaced.')) {
        editor.innerHTML = revisions[idx].content;
        updateStats();
        hideRevisionHistory();
        showToast('Revision restored', 'success');
      }
    }

    function deleteRevision(idx) {
      if (confirm('Delete this revision?')) {
        const revisions = getRevisions();
        revisions.splice(idx, 1);
        saveRevisions(revisions);
        showRevisionHistory(); // Refresh
        showToast('Revision deleted', 'success');
      }
    }

    function previewRevision(idx) {
      const revisions = getRevisions();
      if (revisions[idx]) {
        const preview = window.open('', 'RevisionPreview', 'width=800,height=600');
        preview.document.write(`
          <html>
          <head><title>Revision Preview</title>
          <style>body { font-family: Arial, sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; }</style>
          </head>
          <body>
            <h2>Revision Preview</h2>
            <p style="color: #666;">Saved: ${new Date(revisions[idx].timestamp).toLocaleString()}</p>
            <hr>
            <div>${revisions[idx].content}</div>
          </body>
          </html>
        `);
      }
    }

    // Auto-save revision every 5 minutes
    setInterval(() => {
      if (editor.innerText.trim().length > 50) {
        const revisions = getRevisions();
        const lastRev = revisions[revisions.length - 1];
        // Only save if content changed significantly
        if (!lastRev || editor.innerHTML !== lastRev.content) {
          saveRevision();
        }
      }
    }, 5 * 60 * 1000);

    // ==================== ENDNOTES ====================
    let endnotes = [];

    function showEndnotes() {
      document.getElementById('endnoteText').value = '';
      document.getElementById('endnotesModal').classList.add('active');
    }

    function hideEndnotes() {
      document.getElementById('endnotesModal').classList.remove('active');
    }

    function insertEndnote() {
      const text = document.getElementById('endnoteText').value.trim();
      if (!text) {
        showToast('Please enter endnote text', 'warning');
        return;
      }

      const style = document.getElementById('endnoteNumbering').value;
      endnotes.push(text);
      const num = endnotes.length;

      let marker;
      if (style === 'roman') {
        marker = toRoman(num).toLowerCase();
      } else if (style === 'alpha') {
        marker = String.fromCharCode(96 + num);
      } else {
        marker = num;
      }

      // Insert marker at cursor
      const selection = window.getSelection();
      if (selection.rangeCount) {
        const range = selection.getRangeAt(0);
        const markerSpan = document.createElement('sup');
        markerSpan.className = 'endnote-marker';
        markerSpan.style.cssText = 'color: #1a73e8; cursor: pointer; font-weight: bold;';
        markerSpan.textContent = `[${marker}]`;
        markerSpan.title = text;
        markerSpan.onclick = () => scrollToEndnotes();
        range.insertNode(markerSpan);
      }

      // Update endnotes section at end of document
      updateEndnotesSection();
      hideEndnotes();
      showToast('Endnote inserted', 'success');
    }

    function toRoman(num) {
      const romanNumerals = [
        ['M', 1000], ['CM', 900], ['D', 500], ['CD', 400],
        ['C', 100], ['XC', 90], ['L', 50], ['XL', 40],
        ['X', 10], ['IX', 9], ['V', 5], ['IV', 4], ['I', 1]
      ];
      let result = '';
      for (const [letter, value] of romanNumerals) {
        while (num >= value) {
          result += letter;
          num -= value;
        }
      }
      return result;
    }

    function updateEndnotesSection() {
      // Remove existing endnotes section
      let endnoteSection = editor.querySelector('.endnotes-section');
      if (endnoteSection) endnoteSection.remove();

      if (endnotes.length === 0) return;

      // Create new endnotes section
      const section = document.createElement('div');
      section.className = 'endnotes-section';
      section.id = 'endnotes';
      section.innerHTML = `
        <hr style="margin: 2rem 0 1rem;">
        <h4 style="margin-bottom: 0.5rem;">Endnotes</h4>
        ${endnotes.map((note, idx) => `
          <p style="font-size: 0.9rem; margin: 0.25rem 0;">
            <sup style="color: #1a73e8; font-weight: bold;">[${idx + 1}]</sup> ${note}
          </p>
        `).join('')}
      `;

      editor.appendChild(section);
    }

    function scrollToEndnotes() {
      const section = document.getElementById('endnotes');
      if (section) section.scrollIntoView({ behavior: 'smooth' });
    }

    // ==================== BIBLIOGRAPHY & CITATIONS ====================
    let citations = [];
    let selectedCitationIdx = -1;

    function showBibliography() {
      updateCitationsList();
      document.getElementById('bibliographyModal').classList.add('active');
    }

    function hideBibliography() {
      document.getElementById('bibliographyModal').classList.remove('active');
    }

    function addCitation() {
      const type = document.getElementById('citationType').value;
      const author = document.getElementById('citationAuthor').value.trim();
      const title = document.getElementById('citationTitle').value.trim();
      const year = document.getElementById('citationYear').value.trim();
      const publisher = document.getElementById('citationPublisher').value.trim();

      if (!author || !title) {
        showToast('Author and title are required', 'warning');
        return;
      }

      citations.push({ type, author, title, year, publisher, id: Date.now() });

      // Clear form
      document.getElementById('citationAuthor').value = '';
      document.getElementById('citationTitle').value = '';
      document.getElementById('citationYear').value = '';
      document.getElementById('citationPublisher').value = '';

      updateCitationsList();
      showToast('Citation added', 'success');
    }

    function updateCitationsList() {
      const list = document.getElementById('citationsList');
      if (citations.length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); font-size: 0.9rem;">No citations added yet.</p>';
        return;
      }

      list.innerHTML = citations.map((c, idx) => `
        <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; ${selectedCitationIdx === idx ? 'background: #e3f2fd;' : ''}"
             onclick="selectCitation(${idx})">
          <div style="font-weight: 500; font-size: 0.85rem;">${c.author} (${c.year || 'n.d.'})</div>
          <div style="font-size: 0.8rem; font-style: italic;">${c.title}</div>
          <button class="btn btn-danger" style="padding: 0.15rem 0.4rem; font-size: 0.7rem; margin-top: 0.25rem;"
                  onclick="event.stopPropagation(); removeCitation(${idx})">Remove</button>
        </div>
      `).join('');
    }

    function selectCitation(idx) {
      selectedCitationIdx = idx;
      updateCitationsList();
    }

    function removeCitation(idx) {
      citations.splice(idx, 1);
      selectedCitationIdx = -1;
      updateCitationsList();
      showToast('Citation removed', 'success');
    }

    function formatCitation(citation, style) {
      const { author, title, year, publisher, type } = citation;

      switch (style) {
        case 'apa':
          if (type === 'book') {
            return `${author} (${year || 'n.d.'}). <em>${title}</em>. ${publisher || ''}`.trim();
          } else if (type === 'website') {
            return `${author} (${year || 'n.d.'}). ${title}. Retrieved from ${publisher || ''}`.trim();
          }
          return `${author} (${year || 'n.d.'}). ${title}. ${publisher || ''}`.trim();

        case 'mla':
          return `${author}. "${title}." ${publisher || ''}, ${year || 'n.d.'}.`.trim();

        case 'chicago':
          return `${author}. ${title}. ${publisher || ''}, ${year || 'n.d.'}.`.trim();

        case 'harvard':
          return `${author} (${year || 'n.d.'}) ${title}. ${publisher || ''}.`.trim();

        default:
          return `${author} (${year || 'n.d.'}). ${title}.`;
      }
    }

    function insertCitation() {
      if (selectedCitationIdx < 0) {
        showToast('Please select a citation first', 'warning');
        return;
      }

      const citation = citations[selectedCitationIdx];
      const style = document.getElementById('citationStyle').value;

      // Insert in-text citation
      const selection = window.getSelection();
      if (selection.rangeCount) {
        const range = selection.getRangeAt(0);
        const citationSpan = document.createElement('span');
        citationSpan.className = 'inline-citation';
        citationSpan.style.cssText = 'color: #1a73e8;';

        // Format in-text citation based on style
        if (style === 'apa' || style === 'harvard') {
          citationSpan.textContent = `(${citation.author.split(',')[0]}, ${citation.year || 'n.d.'})`;
        } else if (style === 'mla') {
          citationSpan.textContent = `(${citation.author.split(',')[0]} ${citation.year || ''})`.trim();
        } else {
          citationSpan.textContent = `(${citation.author.split(',')[0]}, ${citation.year || 'n.d.'})`;
        }

        range.insertNode(citationSpan);
        showToast('Citation inserted', 'success');
      }
    }

    function insertBibliography() {
      if (citations.length === 0) {
        showToast('No citations to create bibliography', 'warning');
        return;
      }

      const style = document.getElementById('citationStyle').value;

      // Sort citations alphabetically by author
      const sortedCitations = [...citations].sort((a, b) => a.author.localeCompare(b.author));

      // Create bibliography section
      const bibSection = document.createElement('div');
      bibSection.className = 'bibliography-section';
      bibSection.innerHTML = `
        <hr style="margin: 2rem 0 1rem;">
        <h3 style="margin-bottom: 1rem;">${style === 'mla' ? 'Works Cited' : 'References'}</h3>
        ${sortedCitations.map(c => `
          <p style="margin: 0.5rem 0; padding-left: 2rem; text-indent: -2rem;">
            ${formatCitation(c, style)}
          </p>
        `).join('')}
      `;

      // Remove existing bibliography
      const existing = editor.querySelector('.bibliography-section');
      if (existing) existing.remove();

      editor.appendChild(bibSection);
      hideBibliography();
      showToast('Bibliography inserted', 'success');
    }

    // Add endnote button to Insert toolbar
    document.querySelector('#insertToolbar .toolbar-group:nth-child(2)').innerHTML += `
      <button class="toolbar-btn" onclick="showEndnotes()" title="Insert Endnote">* Endnote</button>
      <button class="toolbar-btn" onclick="showBibliography()" title="Citations & Bibliography">üìö Bibliography</button>
    `;

    // ==========================================
    // Word Art Functions
    // ==========================================
    let selectedSmartArtType = 'list';

    function showWordArt() {
      document.getElementById('wordArtModal').style.display = 'flex';
      updateWordArtPreview();
    }

    function hideWordArt() {
      document.getElementById('wordArtModal').style.display = 'none';
    }

    function updateWordArtPreview() {
      const text = document.getElementById('wordArtText').value || 'Word Art';
      const style = document.getElementById('wordArtStyle').value;
      const font = document.getElementById('wordArtFont').value;
      const size = document.getElementById('wordArtSize').value;
      const color1 = document.getElementById('wordArtColor1').value;
      const color2 = document.getElementById('wordArtColor2').value;
      const transform = document.getElementById('wordArtTransform').value;

      const preview = document.getElementById('wordArtPreview');
      let cssStyles = `font-family: ${font}; font-size: ${size}px; font-weight: bold; `;

      // Apply style effects
      switch (style) {
        case 'gradient':
          cssStyles += `background: linear-gradient(135deg, ${color1}, ${color2}); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;
          break;
        case 'outline':
          cssStyles += `color: transparent; -webkit-text-stroke: 2px ${color1}; text-stroke: 2px ${color1};`;
          break;
        case 'shadow':
          cssStyles += `color: ${color1}; text-shadow: 3px 3px 6px rgba(0,0,0,0.4), 6px 6px 12px rgba(0,0,0,0.2);`;
          break;
        case 'glow':
          cssStyles += `color: ${color1}; text-shadow: 0 0 10px ${color1}, 0 0 20px ${color1}, 0 0 30px ${color2}, 0 0 40px ${color2};`;
          break;
        case 'reflection':
          cssStyles += `color: ${color1};`;
          break;
        case '3d':
          cssStyles += `color: ${color1}; text-shadow: 1px 1px 0px ${color2}, 2px 2px 0px ${color2}, 3px 3px 0px ${color2}, 4px 4px 0px ${color2}, 5px 5px 5px rgba(0,0,0,0.3);`;
          break;
      }

      // Apply transform
      let transformCSS = '';
      switch (transform) {
        case 'arch':
          transformCSS = 'transform: perspective(500px) rotateX(-10deg);';
          break;
        case 'arch-down':
          transformCSS = 'transform: perspective(500px) rotateX(10deg);';
          break;
        case 'wave':
          transformCSS = 'transform: skewY(-5deg);';
          break;
        case 'slant':
          transformCSS = 'transform: skewX(-10deg);';
          break;
        case 'slant-down':
          transformCSS = 'transform: skewX(10deg);';
          break;
      }

      let html = `<span style="${cssStyles} ${transformCSS} display: inline-block;">${text}</span>`;

      // Add reflection effect
      if (style === 'reflection') {
        html = `
          <div style="display: flex; flex-direction: column; align-items: center;">
            <span style="${cssStyles} ${transformCSS} display: inline-block;">${text}</span>
            <span style="${cssStyles} ${transformCSS} display: inline-block; transform: scaleY(-1); opacity: 0.3; filter: blur(1px); margin-top: -10px;">${text}</span>
          </div>
        `;
      }

      preview.innerHTML = html;
    }

    function insertWordArt() {
      const text = document.getElementById('wordArtText').value || 'Word Art';
      const style = document.getElementById('wordArtStyle').value;
      const font = document.getElementById('wordArtFont').value;
      const size = document.getElementById('wordArtSize').value;
      const color1 = document.getElementById('wordArtColor1').value;
      const color2 = document.getElementById('wordArtColor2').value;
      const transform = document.getElementById('wordArtTransform').value;

      let cssStyles = `font-family: ${font}; font-size: ${size}px; font-weight: bold; display: inline-block; `;

      switch (style) {
        case 'gradient':
          cssStyles += `background: linear-gradient(135deg, ${color1}, ${color2}); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;
          break;
        case 'outline':
          cssStyles += `color: transparent; -webkit-text-stroke: 2px ${color1}; text-stroke: 2px ${color1};`;
          break;
        case 'shadow':
          cssStyles += `color: ${color1}; text-shadow: 3px 3px 6px rgba(0,0,0,0.4), 6px 6px 12px rgba(0,0,0,0.2);`;
          break;
        case 'glow':
          cssStyles += `color: ${color1}; text-shadow: 0 0 10px ${color1}, 0 0 20px ${color1}, 0 0 30px ${color2}, 0 0 40px ${color2};`;
          break;
        case 'reflection':
          cssStyles += `color: ${color1};`;
          break;
        case '3d':
          cssStyles += `color: ${color1}; text-shadow: 1px 1px 0px ${color2}, 2px 2px 0px ${color2}, 3px 3px 0px ${color2}, 4px 4px 0px ${color2}, 5px 5px 5px rgba(0,0,0,0.3);`;
          break;
      }

      let transformCSS = '';
      switch (transform) {
        case 'arch':
          transformCSS = 'transform: perspective(500px) rotateX(-10deg);';
          break;
        case 'arch-down':
          transformCSS = 'transform: perspective(500px) rotateX(10deg);';
          break;
        case 'wave':
          transformCSS = 'transform: skewY(-5deg);';
          break;
        case 'slant':
          transformCSS = 'transform: skewX(-10deg);';
          break;
        case 'slant-down':
          transformCSS = 'transform: skewX(10deg);';
          break;
      }

      const wordArtElement = document.createElement('span');
      wordArtElement.className = 'word-art';
      wordArtElement.style.cssText = cssStyles + transformCSS;
      wordArtElement.textContent = text;
      wordArtElement.contentEditable = 'false';

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(wordArtElement);
        range.setStartAfter(wordArtElement);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        editor.appendChild(wordArtElement);
      }

      hideWordArt();
      showToast('Word Art inserted', 'success');
    }

    // ==========================================
    // Equation Editor Functions
    // ==========================================
    function showEquationEditor() {
      document.getElementById('equationModal').style.display = 'flex';
      document.getElementById('equationInput').value = '';
      updateEquationPreview();
    }

    function hideEquationEditor() {
      document.getElementById('equationModal').style.display = 'none';
    }

    function addSymbol(symbol) {
      const input = document.getElementById('equationInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + symbol + text.substring(end);
      input.selectionStart = input.selectionEnd = start + symbol.length;
      input.focus();
      updateEquationPreview();
    }

    function insertEquationTemplate(template) {
      const input = document.getElementById('equationInput');
      let text = '';
      switch (template) {
        case 'fraction': text = 'a/b'; break;
        case 'sqrt': text = '‚àöx'; break;
        case 'power': text = 'x^2'; break;
        case 'subscript': text = 'x_1'; break;
        case 'sum': text = 'Œ£(i=1 to n)'; break;
        case 'integral': text = '‚à´f(x)dx'; break;
        case 'pi': text = 'œÄ'; break;
        case 'theta': text = 'Œ∏'; break;
      }
      input.value += text;
      updateEquationPreview();
    }

    function updateEquationPreview() {
      const input = document.getElementById('equationInput').value;
      const preview = document.getElementById('equationPreview');

      // Parse basic equation formatting
      let html = input
        .replace(/\^(\w+)/g, '<sup>$1</sup>')
        .replace(/\^{([^}]+)}/g, '<sup>$1</sup>')
        .replace(/_(\w+)/g, '<sub>$1</sub>')
        .replace(/_{([^}]+)}/g, '<sub>$1</sub>')
        .replace(/sqrt\(([^)]+)\)/g, '‚àö($1)')
        .replace(/frac\(([^,]+),([^)]+)\)/g, '<span style="display: inline-block; text-align: center; vertical-align: middle;"><span style="display: block; border-bottom: 1px solid black;">$1</span><span style="display: block;">$2</span></span>');

      preview.innerHTML = html || '<span style="color: #999;">Enter an equation...</span>';
    }

    function insertEquation() {
      const input = document.getElementById('equationInput').value;
      if (!input.trim()) {
        showToast('Please enter an equation', 'warning');
        return;
      }

      // Parse and format the equation
      let html = input
        .replace(/\^(\w+)/g, '<sup>$1</sup>')
        .replace(/\^{([^}]+)}/g, '<sup>$1</sup>')
        .replace(/_(\w+)/g, '<sub>$1</sub>')
        .replace(/_{([^}]+)}/g, '<sub>$1</sub>');

      const equationSpan = document.createElement('span');
      equationSpan.className = 'equation';
      equationSpan.style.cssText = 'font-family: "Times New Roman", serif; font-style: italic; padding: 0 0.25rem; background: #f5f5f5; border-radius: 3px;';
      equationSpan.innerHTML = html;

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(equationSpan);
        range.setStartAfter(equationSpan);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        editor.appendChild(equationSpan);
      }

      hideEquationEditor();
      showToast('Equation inserted', 'success');
    }

    // ==========================================
    // Smart Art Functions
    // ==========================================
    function showSmartArt() {
      document.getElementById('smartArtModal').style.display = 'flex';
      selectedSmartArtType = 'list';
      updateSmartArtPreview();
    }

    function hideSmartArt() {
      document.getElementById('smartArtModal').style.display = 'none';
    }

    function selectSmartArtType(type) {
      selectedSmartArtType = type;
      document.querySelectorAll('.smart-art-type').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      updateSmartArtPreview();
    }

    function getSmartArtColors(scheme) {
      const colors = {
        blue: ['#1a73e8', '#4285f4', '#669df6', '#8ab4f8'],
        green: ['#1e8e3e', '#34a853', '#5bb974', '#81c995'],
        orange: ['#e37400', '#f9ab00', '#fcc934', '#fdd663'],
        purple: ['#7b1fa2', '#9c27b0', '#ba68c8', '#ce93d8'],
        rainbow: ['#ea4335', '#f9ab00', '#34a853', '#4285f4']
      };
      return colors[scheme] || colors.blue;
    }

    function updateSmartArtPreview() {
      const items = document.getElementById('smartArtItems').value.split('\n').filter(i => i.trim());
      const colorScheme = document.getElementById('smartArtColor').value;
      const colors = getSmartArtColors(colorScheme);
      const preview = document.getElementById('smartArtPreview');

      if (items.length === 0) {
        preview.innerHTML = '<p style="color: #999; text-align: center;">Enter items to preview</p>';
        return;
      }

      let html = '';

      switch (selectedSmartArtType) {
        case 'list':
          html = `<div style="display: flex; flex-direction: column; gap: 0.5rem;">
            ${items.map((item, i) => `
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 30px; height: 30px; background: ${colors[i % colors.length]}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${i + 1}</div>
                <div style="flex: 1; padding: 0.5rem; background: ${colors[i % colors.length]}22; border-left: 3px solid ${colors[i % colors.length]}; border-radius: 0 4px 4px 0;">${item}</div>
              </div>
            `).join('')}
          </div>`;
          break;

        case 'process':
          html = `<div style="display: flex; align-items: center; gap: 0.25rem; flex-wrap: wrap;">
            ${items.map((item, i) => `
              <div style="padding: 0.75rem 1rem; background: ${colors[i % colors.length]}; color: white; border-radius: 4px; font-weight: 500;">${item}</div>
              ${i < items.length - 1 ? '<div style="font-size: 1.5rem; color: #666;">‚Üí</div>' : ''}
            `).join('')}
          </div>`;
          break;

        case 'cycle':
          const angleStep = 360 / items.length;
          const radius = 60;
          html = `<div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center;">üîÑ</div>
            ${items.map((item, i) => {
              const angle = (angleStep * i - 90) * Math.PI / 180;
              const x = Math.cos(angle) * radius + 90;
              const y = Math.sin(angle) * radius + 90;
              return `<div style="position: absolute; left: ${x - 35}px; top: ${y - 20}px; width: 70px; padding: 0.25rem; background: ${colors[i % colors.length]}; color: white; border-radius: 4px; text-align: center; font-size: 11px;">${item}</div>`;
            }).join('')}
          </div>`;
          break;

        case 'hierarchy':
          html = `<div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            ${items.map((item, i) => `
              <div style="width: ${100 - i * 15}%; padding: 0.5rem; background: ${colors[i % colors.length]}; color: white; border-radius: 4px; text-align: center;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'relationship':
          html = `<div style="display: flex; justify-content: center; align-items: center; gap: 0;">
            ${items.slice(0, 3).map((item, i) => `
              <div style="width: 80px; height: 80px; background: ${colors[i % colors.length]}88; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; margin-left: ${i > 0 ? '-20px' : '0'}; font-size: 12px; text-align: center; padding: 5px;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'pyramid':
          html = `<div style="display: flex; flex-direction: column; align-items: center;">
            ${items.map((item, i) => {
              const width = 40 + (i * 30);
              return `<div style="width: ${width}px; padding: 0.5rem; background: ${colors[i % colors.length]}; color: white; text-align: center; font-size: 11px; ${i === 0 ? 'border-radius: 4px 4px 0 0;' : ''} ${i === items.length - 1 ? 'border-radius: 0 0 4px 4px;' : ''}">${item}</div>`;
            }).join('')}
          </div>`;
          break;
      }

      preview.innerHTML = html;
    }

    function insertSmartArt() {
      const items = document.getElementById('smartArtItems').value.split('\n').filter(i => i.trim());
      const colorScheme = document.getElementById('smartArtColor').value;

      if (items.length === 0) {
        showToast('Please enter at least one item', 'warning');
        return;
      }

      const colors = getSmartArtColors(colorScheme);
      let html = '';

      switch (selectedSmartArtType) {
        case 'list':
          html = `<div class="smart-art smart-art-list" style="margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => `
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="width: 36px; height: 36px; background: ${colors[i % colors.length]}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">${i + 1}</div>
                <div style="flex: 1; padding: 0.75rem; background: ${colors[i % colors.length]}15; border-left: 4px solid ${colors[i % colors.length]}; border-radius: 0 8px 8px 0;">${item}</div>
              </div>
            `).join('')}
          </div>`;
          break;

        case 'process':
          html = `<div class="smart-art smart-art-process" style="margin: 1rem 0; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => `
              <div style="padding: 1rem 1.5rem; background: ${colors[i % colors.length]}; color: white; border-radius: 8px; font-weight: 600;">${item}</div>
              ${i < items.length - 1 ? '<div style="font-size: 2rem; color: #666;">‚Üí</div>' : ''}
            `).join('')}
          </div>`;
          break;

        case 'cycle':
          html = `<div class="smart-art smart-art-cycle" style="margin: 1rem auto; width: 300px; height: 300px; position: relative; border: 1px solid #ddd; border-radius: 8px;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üîÑ</div>
            ${items.map((item, i) => {
              const angleStep = 360 / items.length;
              const angle = (angleStep * i - 90) * Math.PI / 180;
              const radius = 100;
              const x = Math.cos(angle) * radius + 150;
              const y = Math.sin(angle) * radius + 150;
              return `<div style="position: absolute; left: ${x - 50}px; top: ${y - 25}px; width: 100px; padding: 0.5rem; background: ${colors[i % colors.length]}; color: white; border-radius: 8px; text-align: center; font-weight: 500;">${item}</div>`;
            }).join('')}
          </div>`;
          break;

        case 'hierarchy':
          html = `<div class="smart-art smart-art-hierarchy" style="margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => `
              <div style="width: ${100 - i * 12}%; margin: 0 auto 0.5rem; padding: 0.75rem; background: ${colors[i % colors.length]}; color: white; border-radius: 8px; text-align: center; font-weight: 600;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'relationship':
          html = `<div class="smart-art smart-art-relationship" style="margin: 1rem 0; display: flex; justify-content: center; align-items: center; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.slice(0, 4).map((item, i) => `
              <div style="width: 120px; height: 120px; background: ${colors[i % colors.length]}99; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-left: ${i > 0 ? '-30px' : '0'}; text-align: center; padding: 10px;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'pyramid':
          html = `<div class="smart-art smart-art-pyramid" style="margin: 1rem auto; width: fit-content; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => {
              const width = 80 + (i * 50);
              return `<div style="width: ${width}px; margin: 0 auto; padding: 0.75rem; background: ${colors[i % colors.length]}; color: white; text-align: center; font-weight: 600; ${i === 0 ? 'border-radius: 8px 8px 0 0;' : ''} ${i === items.length - 1 ? 'border-radius: 0 0 8px 8px;' : ''}">${item}</div>`;
            }).join('')}
          </div>`;
          break;
      }

      const smartArtContainer = document.createElement('div');
      smartArtContainer.innerHTML = html;

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(smartArtContainer.firstElementChild);
      } else {
        editor.appendChild(smartArtContainer.firstElementChild);
      }

      hideSmartArt();
      showToast('Smart Art inserted', 'success');
    }

    // ==========================================
    // Cross-Reference Functions
    // ==========================================
    let selectedCrossRef = null;

    function showCrossRef() {
      document.getElementById('crossRefModal').style.display = 'flex';
      updateCrossRefList();
    }

    function hideCrossRef() {
      document.getElementById('crossRefModal').style.display = 'none';
      selectedCrossRef = null;
    }

    function updateCrossRefList() {
      const type = document.getElementById('crossRefType').value;
      const listContainer = document.getElementById('crossRefList');
      let items = [];

      switch (type) {
        case 'heading':
          // Find all headings in the document
          const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
          headings.forEach((h, i) => {
            items.push({
              id: `heading-${i}`,
              text: h.textContent,
              element: h,
              type: h.tagName
            });
          });
          break;

        case 'bookmark':
          // Find all bookmarks
          const bookmarks = editor.querySelectorAll('.bookmark');
          bookmarks.forEach((b, i) => {
            items.push({
              id: b.id || `bookmark-${i}`,
              text: b.dataset.name || b.textContent || 'Unnamed Bookmark',
              element: b,
              type: 'Bookmark'
            });
          });
          break;

        case 'footnote':
          // Find all footnotes
          const footnotes = editor.querySelectorAll('.footnote-ref');
          footnotes.forEach((f, i) => {
            items.push({
              id: `footnote-${i}`,
              text: `Footnote ${i + 1}`,
              element: f,
              type: 'Footnote'
            });
          });
          break;
      }

      if (items.length === 0) {
        listContainer.innerHTML = '<p style="padding: 1rem; color: #999; text-align: center;">No items found</p>';
        return;
      }

      listContainer.innerHTML = items.map(item => `
        <div class="cross-ref-item" onclick="selectCrossRefItem('${item.id}', '${item.text.replace(/'/g, "\\'")}', '${item.type}')"
             style="padding: 0.75rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
             onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
          <span>${item.text}</span>
          <span style="font-size: 0.8rem; color: #666; background: #eee; padding: 0.2rem 0.5rem; border-radius: 4px;">${item.type}</span>
        </div>
      `).join('');
    }

    function selectCrossRefItem(id, text, type) {
      selectedCrossRef = { id, text, type };
      // Highlight selected item
      document.querySelectorAll('.cross-ref-item').forEach(item => {
        item.style.background = 'white';
      });
      event.currentTarget.style.background = '#e3f2fd';
    }

    function insertCrossRef() {
      if (!selectedCrossRef) {
        showToast('Please select a reference', 'warning');
        return;
      }

      const format = document.getElementById('crossRefFormat').value;
      let refText = '';

      switch (format) {
        case 'text':
          refText = selectedCrossRef.text;
          break;
        case 'page':
          refText = 'Page 1'; // In a real implementation, this would calculate the page number
          break;
        case 'above-below':
          refText = 'above'; // In a real implementation, this would calculate position
          break;
      }

      const crossRefSpan = document.createElement('span');
      crossRefSpan.className = 'cross-reference';
      crossRefSpan.style.cssText = 'color: #1a73e8; text-decoration: underline; cursor: pointer;';
      crossRefSpan.dataset.refId = selectedCrossRef.id;
      crossRefSpan.dataset.refType = selectedCrossRef.type;
      crossRefSpan.textContent = refText;
      crossRefSpan.onclick = function() {
        // Navigate to the referenced element
        const targetId = this.dataset.refId;
        const targetType = this.dataset.refType;
        let target;

        if (targetType.startsWith('H')) {
          const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
          const index = parseInt(targetId.replace('heading-', ''));
          target = headings[index];
        } else if (targetType === 'Bookmark') {
          target = editor.querySelector(`#${targetId}`) || editor.querySelector(`.bookmark[data-name="${this.textContent}"]`);
        } else if (targetType === 'Footnote') {
          const footnotes = editor.querySelectorAll('.footnote-ref');
          const index = parseInt(targetId.replace('footnote-', ''));
          target = footnotes[index];
        }

        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          target.style.background = '#ffeb3b';
          setTimeout(() => { target.style.background = ''; }, 2000);
        }
      };

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(crossRefSpan);
        range.setStartAfter(crossRefSpan);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        editor.appendChild(crossRefSpan);
      }

      hideCrossRef();
      showToast('Cross-reference inserted', 'success');
    }

    // Add Cross-Reference button to Insert toolbar
    const insertToolbarGroups = document.querySelectorAll('#insertToolbar .toolbar-group');
    if (insertToolbarGroups.length >= 2) {
      insertToolbarGroups[1].innerHTML += `<button class="toolbar-btn" onclick="showCrossRef()" title="Cross-Reference">‚Üó Cross-Ref</button>`;
    }

    // ==========================================
    // Styles Gallery Functions
    // ==========================================
    const builtInStyles = {
      normal: { fontSize: '12px', fontWeight: 'normal', fontStyle: 'normal', color: '#000000', fontFamily: 'Arial' },
      heading1: { fontSize: '24px', fontWeight: 'bold', fontStyle: 'normal', color: '#1a73e8', fontFamily: 'Arial', tag: 'h1' },
      heading2: { fontSize: '20px', fontWeight: 'bold', fontStyle: 'normal', color: '#1a73e8', fontFamily: 'Arial', tag: 'h2' },
      heading3: { fontSize: '16px', fontWeight: 'bold', fontStyle: 'normal', color: '#666666', fontFamily: 'Arial', tag: 'h3' },
      title: { fontSize: '32px', fontWeight: '300', fontStyle: 'normal', color: '#000000', fontFamily: 'Arial' },
      subtitle: { fontSize: '16px', fontWeight: 'normal', fontStyle: 'italic', color: '#666666', fontFamily: 'Arial' },
      quote: { fontSize: '14px', fontWeight: 'normal', fontStyle: 'italic', color: '#333333', fontFamily: 'Georgia', borderLeft: '3px solid #1a73e8', paddingLeft: '12px', marginLeft: '20px' },
      code: { fontSize: '12px', fontWeight: 'normal', fontStyle: 'normal', color: '#c7254e', fontFamily: 'Courier New', background: '#f5f5f5', padding: '2px 6px', borderRadius: '3px' },
      emphasis: { fontSize: '12px', fontWeight: 'normal', fontStyle: 'italic', color: '#000000', fontFamily: 'Arial' }
    };

    let customStyles = JSON.parse(localStorage.getItem('ninjaWordCustomStyles') || '{}');

    function applyStyle(styleName) {
      const style = builtInStyles[styleName] || customStyles[styleName];
      if (!style) return;

      const selection = window.getSelection();
      if (selection.rangeCount === 0) return;

      const range = selection.getRangeAt(0);

      // If it's a heading style, wrap in appropriate tag
      if (style.tag) {
        const heading = document.createElement(style.tag);
        heading.style.cssText = `font-size: ${style.fontSize}; font-weight: ${style.fontWeight}; color: ${style.color}; font-family: ${style.fontFamily}; margin: 0.5em 0;`;

        if (range.collapsed) {
          // No selection, create empty heading
          heading.innerHTML = '&nbsp;';
          range.insertNode(heading);
        } else {
          heading.appendChild(range.extractContents());
          range.insertNode(heading);
        }
      } else {
        const span = document.createElement('span');
        let cssText = `font-size: ${style.fontSize}; font-weight: ${style.fontWeight}; font-style: ${style.fontStyle}; color: ${style.color}; font-family: ${style.fontFamily};`;

        if (style.background) cssText += ` background: ${style.background};`;
        if (style.borderLeft) cssText += ` border-left: ${style.borderLeft};`;
        if (style.paddingLeft) cssText += ` padding-left: ${style.paddingLeft};`;
        if (style.marginLeft) cssText += ` margin-left: ${style.marginLeft};`;
        if (style.padding) cssText += ` padding: ${style.padding};`;
        if (style.borderRadius) cssText += ` border-radius: ${style.borderRadius};`;

        span.style.cssText = cssText;

        if (!range.collapsed) {
          span.appendChild(range.extractContents());
          range.insertNode(span);
        }
      }

      updateNavigationPane();
      showToast(`Style '${styleName}' applied`, 'success');
    }

    function showStylesGallery() {
      document.getElementById('stylesGalleryModal').style.display = 'flex';
      renderCustomStyles();
    }

    function hideStylesGallery() {
      document.getElementById('stylesGalleryModal').style.display = 'none';
    }

    function renderCustomStyles() {
      const container = document.getElementById('customStylesList');
      const styleNames = Object.keys(customStyles);

      if (styleNames.length === 0) {
        container.innerHTML = '<p style="color: #666; font-size: 0.9rem;">No custom styles yet. Create one!</p>';
        return;
      }

      container.innerHTML = styleNames.map(name => {
        const style = customStyles[name];
        return `
          <div class="style-preview" onclick="applyStyle('${name}')" style="display: flex; flex-direction: column; align-items: center;">
            <div style="font-size: ${style.fontSize}; font-weight: ${style.fontWeight}; font-style: ${style.fontStyle}; color: ${style.color}; font-family: ${style.fontFamily}; background: ${style.background || 'transparent'};">Aa</div>
            <small>${name}</small>
            <button onclick="event.stopPropagation(); deleteCustomStyle('${name}')" style="font-size: 0.7rem; color: red; border: none; background: none; cursor: pointer;">Delete</button>
          </div>
        `;
      }).join('');
    }

    function showCreateStyle() {
      document.getElementById('createStyleModal').style.display = 'flex';
    }

    function hideCreateStyle() {
      document.getElementById('createStyleModal').style.display = 'none';
    }

    function saveCustomStyle() {
      const name = document.getElementById('customStyleName').value.trim();
      if (!name) {
        showToast('Please enter a style name', 'warning');
        return;
      }

      const style = {
        fontFamily: document.getElementById('customStyleFont').value,
        fontSize: document.getElementById('customStyleSize').value + 'px',
        color: document.getElementById('customStyleColor').value,
        background: document.getElementById('customStyleBg').value,
        fontWeight: document.getElementById('customStyleBold').checked ? 'bold' : 'normal',
        fontStyle: document.getElementById('customStyleItalic').checked ? 'italic' : 'normal',
        textDecoration: document.getElementById('customStyleUnderline').checked ? 'underline' : 'none'
      };

      customStyles[name] = style;
      localStorage.setItem('ninjaWordCustomStyles', JSON.stringify(customStyles));

      hideCreateStyle();
      renderCustomStyles();
      showToast(`Style '${name}' created`, 'success');
    }

    function deleteCustomStyle(name) {
      if (confirm(`Delete style '${name}'?`)) {
        delete customStyles[name];
        localStorage.setItem('ninjaWordCustomStyles', JSON.stringify(customStyles));
        renderCustomStyles();
        showToast('Style deleted', 'success');
      }
    }

    // ==========================================
    // Navigation Pane Functions
    // ==========================================
    let navPaneVisible = false;
    let currentNavTab = 'headings';

    function toggleNavigationPane() {
      navPaneVisible = !navPaneVisible;
      const pane = document.getElementById('navigationPane');
      pane.classList.toggle('visible', navPaneVisible);

      if (navPaneVisible) {
        updateNavigationPane();
      }
    }

    function switchNavTab(tab) {
      currentNavTab = tab;
      document.querySelectorAll('.nav-pane-tab').forEach(t => {
        t.classList.toggle('active', t.textContent.toLowerCase() === tab);
      });
      updateNavigationPane();
    }

    function updateNavigationPane() {
      if (!navPaneVisible) return;

      const content = document.getElementById('navPaneContent');

      switch (currentNavTab) {
        case 'headings':
          const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
          if (headings.length === 0) {
            content.innerHTML = '<p style="padding: 1rem; color: #666; text-align: center;">No headings found.<br>Apply heading styles to see them here.</p>';
          } else {
            content.innerHTML = Array.from(headings).map((h, i) => {
              const level = h.tagName.toLowerCase();
              return `
                <div class="nav-item ${level}" onclick="navigateToElement(${i}, 'heading')">
                  <span style="opacity: 0.5;">${level.toUpperCase()}</span>
                  <span>${h.textContent.substring(0, 30)}${h.textContent.length > 30 ? '...' : ''}</span>
                </div>
              `;
            }).join('');
          }
          break;

        case 'pages':
          // Estimate page count based on content height
          const pageHeight = 11 * 96; // 11 inches at 96 dpi
          const contentHeight = editor.scrollHeight;
          const pageCount = Math.max(1, Math.ceil(contentHeight / pageHeight));

          content.innerHTML = Array.from({ length: pageCount }, (_, i) => `
            <div class="nav-item" onclick="navigateToPage(${i})">
              <span style="background: #e8f0fe; padding: 0.25rem 0.5rem; border-radius: 4px;">üìÑ</span>
              <span>Page ${i + 1}</span>
            </div>
          `).join('');
          break;

        case 'search':
          content.innerHTML = `
            <div style="padding: 0.5rem;">
              <input type="text" id="navSearchInput" placeholder="Search document..."
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                     onkeyup="navSearch(event)">
              <div id="navSearchResults" style="margin-top: 0.5rem;"></div>
            </div>
          `;
          break;
      }
    }

    function navigateToElement(index, type) {
      let elements;
      if (type === 'heading') {
        elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
      }

      if (elements && elements[index]) {
        elements[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
        elements[index].style.background = '#ffeb3b';
        setTimeout(() => { elements[index].style.background = ''; }, 2000);
      }
    }

    function navigateToPage(pageNum) {
      const pageHeight = 11 * 96;
      editor.scrollTop = pageNum * pageHeight;
    }

    function navSearch(event) {
      if (event.key !== 'Enter') return;

      const searchTerm = document.getElementById('navSearchInput').value.trim();
      if (!searchTerm) return;

      const results = document.getElementById('navSearchResults');
      const text = editor.innerText;
      const regex = new RegExp(searchTerm, 'gi');
      const matches = text.match(regex);

      if (!matches || matches.length === 0) {
        results.innerHTML = '<p style="color: #666;">No results found</p>';
        return;
      }

      results.innerHTML = `<p style="font-weight: 600;">${matches.length} result(s) found</p>`;

      // Highlight in document
      highlightSearchTerm(searchTerm);
    }

    function highlightSearchTerm(term) {
      // Clear previous highlights
      const existing = editor.querySelectorAll('.nav-search-highlight');
      existing.forEach(el => {
        const parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
      });

      // Highlight new term
      const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
      const textNodes = [];
      while (walker.nextNode()) textNodes.push(walker.currentNode);

      textNodes.forEach(node => {
        const regex = new RegExp(`(${term})`, 'gi');
        if (regex.test(node.textContent)) {
          const span = document.createElement('span');
          span.innerHTML = node.textContent.replace(regex, '<span class="nav-search-highlight" style="background: #ffeb3b;">$1</span>');
          node.parentNode.replaceChild(span, node);
        }
      });
    }

    // ==========================================
    // Advanced Find & Replace Functions
    // ==========================================
    let advFindMatches = [];
    let advFindCurrentIndex = 0;

    function showAdvancedFind() {
      document.getElementById('advancedFindModal').style.display = 'flex';
      advFindMatches = [];
      advFindCurrentIndex = 0;
    }

    function hideAdvancedFind() {
      document.getElementById('advancedFindModal').style.display = 'none';
      clearAdvFindHighlights();
    }

    function clearAdvFindHighlights() {
      const highlights = editor.querySelectorAll('.adv-find-highlight');
      highlights.forEach(el => {
        const parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
        parent.normalize();
      });
    }

    function buildSearchRegex() {
      const searchTerm = document.getElementById('advFindInput').value;
      if (!searchTerm) return null;

      const matchCase = document.getElementById('advFindCase').checked;
      const wholeWord = document.getElementById('advFindWholeWord').checked;
      const useRegex = document.getElementById('advFindRegex').checked;

      let pattern = searchTerm;

      if (!useRegex) {
        pattern = pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      if (wholeWord) {
        pattern = `\\b${pattern}\\b`;
      }

      const flags = matchCase ? 'g' : 'gi';

      try {
        return new RegExp(pattern, flags);
      } catch (e) {
        showToast('Invalid regular expression', 'error');
        return null;
      }
    }

    function advFindAll() {
      clearAdvFindHighlights();
      advFindMatches = [];
      advFindCurrentIndex = 0;

      const regex = buildSearchRegex();
      if (!regex) return;

      const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
      const textNodes = [];
      while (walker.nextNode()) textNodes.push(walker.currentNode);

      let matchCount = 0;

      textNodes.forEach(node => {
        if (regex.test(node.textContent)) {
          regex.lastIndex = 0; // Reset regex
          const span = document.createElement('span');
          span.innerHTML = node.textContent.replace(regex, (match) => {
            matchCount++;
            advFindMatches.push({ text: match });
            return `<span class="adv-find-highlight" style="background: #ffeb3b;" data-match-index="${matchCount - 1}">${match}</span>`;
          });
          node.parentNode.replaceChild(span, node);
        }
      });

      document.getElementById('advFindResults').innerHTML = matchCount > 0
        ? `<span style="color: #1e8e3e; font-weight: 600;">${matchCount} match(es) found</span>`
        : `<span style="color: #d93025;">No matches found</span>`;

      if (matchCount > 0) {
        advFindCurrentIndex = 0;
        highlightCurrentMatch();
      }
    }

    function highlightCurrentMatch() {
      const highlights = editor.querySelectorAll('.adv-find-highlight');
      highlights.forEach((el, i) => {
        el.style.background = i === advFindCurrentIndex ? '#ff9800' : '#ffeb3b';
        el.style.color = i === advFindCurrentIndex ? 'white' : 'inherit';
      });

      if (highlights[advFindCurrentIndex]) {
        highlights[advFindCurrentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function advFindNext() {
      if (advFindMatches.length === 0) {
        advFindAll();
        return;
      }

      advFindCurrentIndex = (advFindCurrentIndex + 1) % advFindMatches.length;
      highlightCurrentMatch();
    }

    function advReplace() {
      if (advFindMatches.length === 0) {
        advFindAll();
        return;
      }

      const replacement = document.getElementById('advReplaceInput').value;
      const highlight = editor.querySelector(`.adv-find-highlight[data-match-index="${advFindCurrentIndex}"]`);

      if (highlight) {
        highlight.outerHTML = replacement;
        advFindMatches.splice(advFindCurrentIndex, 1);

        // Reindex remaining matches
        const highlights = editor.querySelectorAll('.adv-find-highlight');
        highlights.forEach((el, i) => el.dataset.matchIndex = i);

        if (advFindCurrentIndex >= advFindMatches.length) {
          advFindCurrentIndex = 0;
        }

        document.getElementById('advFindResults').innerHTML =
          `<span style="color: #1e8e3e;">Replaced. ${advFindMatches.length} match(es) remaining</span>`;

        if (advFindMatches.length > 0) {
          highlightCurrentMatch();
        }
      }
    }

    function advReplaceAll() {
      if (advFindMatches.length === 0) {
        advFindAll();
        if (advFindMatches.length === 0) return;
      }

      const replacement = document.getElementById('advReplaceInput').value;
      const count = advFindMatches.length;

      const highlights = editor.querySelectorAll('.adv-find-highlight');
      highlights.forEach(el => {
        el.outerHTML = replacement;
      });

      advFindMatches = [];
      advFindCurrentIndex = 0;

      document.getElementById('advFindResults').innerHTML =
        `<span style="color: #1e8e3e; font-weight: 600;">${count} replacement(s) made</span>`;

      showToast(`${count} replacement(s) made`, 'success');
    }

    // Update navigation pane when editor content changes
    editor.addEventListener('input', () => {
      if (navPaneVisible && currentNavTab === 'headings') {
        updateNavigationPane();
      }
    });

    // Line Numbers
    let lineNumbersVisible = false;

    function toggleLineNumbers() {
      lineNumbersVisible = !lineNumbersVisible;
      const gutter = document.getElementById('lineNumbersGutter');
      const btn = document.getElementById('lineNumBtn');
      const docArea = document.querySelector('.document-area');

      if (lineNumbersVisible) {
        gutter.classList.add('visible');
        btn.classList.add('active');
        docArea.style.paddingLeft = '50px';
        updateLineNumbers();
      } else {
        gutter.classList.remove('visible');
        btn.classList.remove('active');
        docArea.style.paddingLeft = '0';
      }
    }

    function updateLineNumbers() {
      if (!lineNumbersVisible) return;

      const gutter = document.getElementById('lineNumbersGutter');
      const editorRect = editor.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(editor);
      const lineHeight = parseFloat(computedStyle.lineHeight) || 24;
      const paddingTop = parseFloat(computedStyle.paddingTop) || 0;

      // Get all block elements and text lines
      const lines = [];
      let currentY = editorRect.top + paddingTop;

      // Walk through all child elements
      const walkElements = (parent) => {
        for (const child of parent.childNodes) {
          if (child.nodeType === Node.ELEMENT_NODE) {
            const rect = child.getBoundingClientRect();
            if (rect.height > 0 && rect.top >= editorRect.top) {
              // Check if this is a block element
              const display = window.getComputedStyle(child).display;
              if (display === 'block' || display === 'list-item' || child.tagName === 'P' ||
                  child.tagName === 'DIV' || child.tagName === 'H1' || child.tagName === 'H2' ||
                  child.tagName === 'H3' || child.tagName === 'H4' || child.tagName === 'LI') {
                lines.push({
                  top: rect.top - editorRect.top,
                  height: rect.height
                });
              }
            }
            walkElements(child);
          }
        }
      };

      // Get block-level elements
      const blockElements = editor.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li, blockquote, pre');
      const seenTops = new Set();

      blockElements.forEach(el => {
        const rect = el.getBoundingClientRect();
        if (rect.height > 0) {
          const relativeTop = Math.round(rect.top - editorRect.top);
          if (!seenTops.has(relativeTop)) {
            seenTops.add(relativeTop);
            lines.push({
              top: relativeTop,
              height: rect.height
            });
          }
        }
      });

      // Sort by position
      lines.sort((a, b) => a.top - b.top);

      // If no block elements, estimate based on content height
      if (lines.length === 0) {
        const contentHeight = editor.scrollHeight;
        const numLines = Math.ceil(contentHeight / lineHeight);
        for (let i = 0; i < numLines; i++) {
          lines.push({
            top: i * lineHeight,
            height: lineHeight
          });
        }
      }

      // Build line numbers HTML
      let html = '';
      lines.forEach((line, index) => {
        html += `<div style="position: absolute; top: ${line.top + 96}px; right: 8px; height: ${line.height}px; display: flex; align-items: flex-start; padding-top: 2px;">${index + 1}</div>`;
      });

      gutter.innerHTML = html;
      gutter.style.height = editor.scrollHeight + 192 + 'px';
    }

    // Update line numbers on editor changes
    editor.addEventListener('input', updateLineNumbers);
    editor.addEventListener('scroll', () => {
      const gutter = document.getElementById('lineNumbersGutter');
      gutter.scrollTop = editor.scrollTop;
    });

    // Observe editor for resize changes
    if (typeof ResizeObserver !== 'undefined') {
      const lineNumObserver = new ResizeObserver(updateLineNumbers);
      lineNumObserver.observe(editor);
    }

    // Dark Mode
    let darkModeEnabled = localStorage.getItem('ninjaword-darkmode') === 'true';

    function toggleDarkMode() {
      darkModeEnabled = !darkModeEnabled;
      applyDarkMode();
      localStorage.setItem('ninjaword-darkmode', darkModeEnabled);
    }

    function applyDarkMode() {
      const btn = document.getElementById('darkModeBtn');
      if (darkModeEnabled) {
        document.body.classList.add('dark-mode');
        btn.classList.add('active');
        btn.innerHTML = '‚òÄÔ∏è Light Mode';
      } else {
        document.body.classList.remove('dark-mode');
        btn.classList.remove('active');
        btn.innerHTML = 'üåô Dark Mode';
      }
    }

    // Apply saved dark mode preference on load
    if (darkModeEnabled) {
      applyDarkMode();
    }

    // ==================== INDEX FEATURE ====================
    let indexEntries = [];

    function showIndexModal() {
      // Pre-populate with selected text if any
      const selection = window.getSelection();
      if (selection && selection.toString().trim()) {
        document.getElementById('indexMainEntry').value = selection.toString().trim();
      }
      updateIndexEntriesList();
      document.getElementById('indexModal').style.display = 'flex';
    }

    function hideIndexModal() {
      document.getElementById('indexModal').style.display = 'none';
    }

    function showMarkIndexEntry() {
      document.getElementById('markEntrySection').style.display = 'block';
      // Pre-fill with selection
      const selection = window.getSelection();
      if (selection && selection.toString().trim()) {
        document.getElementById('indexMainEntry').value = selection.toString().trim();
      }
    }

    function hideMarkEntry() {
      document.getElementById('markEntrySection').style.display = 'none';
    }

    function showMarkAllEntries() {
      showMarkIndexEntry();
    }

    // Handle radio button changes for index type
    document.addEventListener('change', (e) => {
      if (e.target.name === 'indexType') {
        const crossRefField = document.getElementById('crossRefField');
        crossRefField.style.display = e.target.value === 'crossref' ? 'block' : 'none';
      }
    });

    function markIndexEntry() {
      const mainEntry = document.getElementById('indexMainEntry').value.trim();
      if (!mainEntry) {
        showToast('Please enter a main entry', 'error');
        return;
      }

      const subEntry = document.getElementById('indexSubEntry').value.trim();
      const indexType = document.querySelector('input[name="indexType"]:checked').value;
      const crossRef = document.getElementById('indexCrossRef').value.trim();

      // Get current page (simulated based on position in document)
      const page = getCurrentPage();

      const entry = {
        id: Date.now(),
        main: mainEntry,
        sub: subEntry || null,
        type: indexType,
        crossRef: indexType === 'crossref' ? crossRef : null,
        page: page
      };

      indexEntries.push(entry);

      // Mark the text in the document with a hidden marker
      const selection = window.getSelection();
      if (selection && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const marker = document.createElement('span');
        marker.className = 'index-marker';
        marker.dataset.indexId = entry.id;
        marker.style.borderBottom = '2px dotted #1a73e8';
        marker.title = `Index: ${mainEntry}${subEntry ? ' > ' + subEntry : ''}`;

        try {
          range.surroundContents(marker);
        } catch (e) {
          // Selection spans multiple elements
        }
      }

      updateIndexEntriesList();
      showToast(`Index entry "${mainEntry}" marked`, 'success');

      // Clear inputs for next entry
      document.getElementById('indexMainEntry').value = '';
      document.getElementById('indexSubEntry').value = '';
      document.getElementById('indexCrossRef').value = '';
    }

    function markAllOccurrences() {
      const mainEntry = document.getElementById('indexMainEntry').value.trim();
      if (!mainEntry) {
        showToast('Please enter a main entry', 'error');
        return;
      }

      const editor = document.getElementById('editor');
      const text = editor.innerText;
      const regex = new RegExp(mainEntry.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      let match;
      let count = 0;

      while ((match = regex.exec(text)) !== null) {
        const entry = {
          id: Date.now() + count,
          main: mainEntry,
          sub: document.getElementById('indexSubEntry').value.trim() || null,
          type: 'page',
          crossRef: null,
          page: Math.ceil((match.index / text.length) * 10) || 1 // Estimate page
        };
        indexEntries.push(entry);
        count++;
      }

      if (count > 0) {
        updateIndexEntriesList();
        showToast(`Marked ${count} occurrences of "${mainEntry}"`, 'success');
      } else {
        showToast(`No occurrences of "${mainEntry}" found`, 'error');
      }
    }

    function getCurrentPage() {
      // Estimate current page based on scroll position
      const editor = document.getElementById('editor');
      const scrollTop = editor.scrollTop;
      const pageHeight = 1056; // ~11 inches at 96dpi
      return Math.max(1, Math.ceil((scrollTop + 1) / pageHeight));
    }

    function updateIndexEntriesList() {
      const list = document.getElementById('indexEntriesList');
      const count = document.getElementById('indexEntryCount');
      count.textContent = indexEntries.length;

      if (indexEntries.length === 0) {
        list.innerHTML = '<div style="color: #999; font-style: italic;">No index entries marked yet</div>';
        return;
      }

      // Group by main entry
      const grouped = {};
      indexEntries.forEach(entry => {
        if (!grouped[entry.main]) {
          grouped[entry.main] = [];
        }
        grouped[entry.main].push(entry);
      });

      let html = '';
      Object.keys(grouped).sort().forEach(main => {
        const entries = grouped[main];
        const pages = [...new Set(entries.map(e => e.page))].sort((a, b) => a - b);

        html += `<div style="padding: 0.25rem 0; display: flex; justify-content: space-between; border-bottom: 1px solid #eee;">
          <span><strong>${main}</strong>${entries[0].sub ? ' > ' + entries[0].sub : ''}</span>
          <span style="color: #666;">${entries[0].type === 'crossref' ? 'See ' + entries[0].crossRef : 'p. ' + pages.join(', ')}</span>
          <button onclick="removeIndexEntry('${main}')" style="border: none; background: none; color: #d93025; cursor: pointer;">√ó</button>
        </div>`;
      });

      list.innerHTML = html;
    }

    function removeIndexEntry(main) {
      indexEntries = indexEntries.filter(e => e.main !== main);

      // Remove markers from document
      document.querySelectorAll('.index-marker').forEach(marker => {
        if (indexEntries.every(e => e.id != marker.dataset.indexId)) {
          const parent = marker.parentNode;
          while (marker.firstChild) {
            parent.insertBefore(marker.firstChild, marker);
          }
          parent.removeChild(marker);
        }
      });

      updateIndexEntriesList();
      showToast('Index entry removed', 'info');
    }

    function clearAllIndexEntries() {
      if (indexEntries.length === 0) return;

      if (confirm('Clear all index entries?')) {
        indexEntries = [];

        // Remove all markers
        document.querySelectorAll('.index-marker').forEach(marker => {
          const parent = marker.parentNode;
          while (marker.firstChild) {
            parent.insertBefore(marker.firstChild, marker);
          }
          parent.removeChild(marker);
        });

        updateIndexEntriesList();
        showToast('All index entries cleared', 'info');
      }
    }

    function insertIndex() {
      if (indexEntries.length === 0) {
        showToast('No index entries to generate', 'error');
        return;
      }

      const format = document.getElementById('indexFormat').value;
      const columns = parseInt(document.getElementById('indexColumns').value);

      // Group and sort entries
      const grouped = {};
      indexEntries.forEach(entry => {
        const key = entry.main.toLowerCase();
        if (!grouped[key]) {
          grouped[key] = { main: entry.main, subs: {}, pages: new Set(), crossRef: null };
        }
        if (entry.type === 'crossref') {
          grouped[key].crossRef = entry.crossRef;
        } else {
          grouped[key].pages.add(entry.page);
        }
        if (entry.sub) {
          if (!grouped[key].subs[entry.sub]) {
            grouped[key].subs[entry.sub] = new Set();
          }
          grouped[key].subs[entry.sub].add(entry.page);
        }
      });

      // Generate index HTML
      let indexHTML = `<div class="document-index" style="margin: 2rem 0; page-break-before: always;">
        <h2 style="text-align: center; margin-bottom: 1rem; border-bottom: 2px solid #333; padding-bottom: 0.5rem;">INDEX</h2>
        <div style="column-count: ${columns}; column-gap: 2rem;">`;

      // Group by first letter
      const byLetter = {};
      Object.values(grouped).forEach(entry => {
        const letter = entry.main[0].toUpperCase();
        if (!byLetter[letter]) byLetter[letter] = [];
        byLetter[letter].push(entry);
      });

      Object.keys(byLetter).sort().forEach(letter => {
        indexHTML += `<div style="margin-bottom: 0.5rem;"><strong style="font-size: 1.1em;">${letter}</strong></div>`;

        byLetter[letter].sort((a, b) => a.main.localeCompare(b.main)).forEach(entry => {
          const pages = [...entry.pages].sort((a, b) => a - b).join(', ');
          const pageRef = entry.crossRef ? `<em>See ${entry.crossRef}</em>` : pages;

          if (format === 'indented') {
            indexHTML += `<div style="margin-left: 1rem; margin-bottom: 0.25rem;">
              ${entry.main}${Object.keys(entry.subs).length === 0 ? ', ' + pageRef : ''}
            </div>`;

            // Subentries
            Object.entries(entry.subs).forEach(([sub, subPages]) => {
              const subPageRef = [...subPages].sort((a, b) => a - b).join(', ');
              indexHTML += `<div style="margin-left: 2rem; margin-bottom: 0.25rem;">${sub}, ${subPageRef}</div>`;
            });
          } else {
            // Run-in format
            let subText = Object.entries(entry.subs).map(([sub, subPages]) => {
              return `${sub}, ${[...subPages].sort((a, b) => a - b).join(', ')}`;
            }).join('; ');

            indexHTML += `<div style="margin-left: 1rem; margin-bottom: 0.25rem;">
              ${entry.main}, ${pageRef}${subText ? '; ' + subText : ''}
            </div>`;
          }
        });
      });

      indexHTML += '</div></div>';

      // Insert at cursor or end
      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection && selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        const range = selection.getRangeAt(0);
        const div = document.createElement('div');
        div.innerHTML = indexHTML;
        range.insertNode(div.firstChild);
      } else {
        editor.innerHTML += indexHTML;
      }

      hideIndexModal();
      showToast('Index inserted', 'success');
    }

    function updateIndex() {
      // Remove existing index and regenerate
      const existingIndex = document.querySelector('.document-index');
      if (existingIndex) {
        existingIndex.remove();
      }
      insertIndex();
    }

    // ==================== OUTLINE VIEW ====================
    let outlineVisible = false;
    let selectedOutlineItem = null;
    let outlineShowLevel = 'all';

    function toggleOutlineView() {
      outlineVisible = !outlineVisible;
      const panel = document.getElementById('outlinePanel');
      const btn = document.getElementById('outlineViewBtn');
      const docArea = document.querySelector('.document-area');

      if (outlineVisible) {
        panel.classList.add('visible');
        btn.classList.add('active');
        docArea.style.marginLeft = '330px';
        updateOutlineView();
      } else {
        panel.classList.remove('visible');
        btn.classList.remove('active');
        docArea.style.marginLeft = navPaneVisible ? '260px' : '0';
      }
    }

    function updateOutlineView() {
      if (!outlineVisible) return;

      const editor = document.getElementById('editor');
      const content = document.getElementById('outlineContent');

      // Get all headings and paragraphs
      const elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div');
      let html = '';
      let itemIndex = 0;

      elements.forEach(el => {
        const tagName = el.tagName.toLowerCase();
        let level = 0;
        let levelClass = 'body-text';
        let levelLabel = 'Body';

        if (tagName === 'h1') { level = 1; levelClass = 'h1'; levelLabel = 'H1'; }
        else if (tagName === 'h2') { level = 2; levelClass = 'h2'; levelLabel = 'H2'; }
        else if (tagName === 'h3') { level = 3; levelClass = 'h3'; levelLabel = 'H3'; }
        else if (tagName === 'h4') { level = 4; levelClass = 'h4'; levelLabel = 'H4'; }
        else if (tagName === 'h5' || tagName === 'h6') { level = 5; levelClass = 'h4'; levelLabel = 'H5+'; }
        else { level = 6; } // Body text

        // Filter by show level
        if (outlineShowLevel !== 'all') {
          const maxLevel = parseInt(outlineShowLevel);
          if (level > maxLevel && level < 6) return;
          if (level === 6 && maxLevel < 4) return; // Hide body text at high filter levels
        }

        const text = el.textContent.trim();
        if (!text || text.length < 2) return;

        const displayText = text.length > 60 ? text.substring(0, 60) + '...' : text;
        const hasChildren = level < 6 && level > 0;

        html += `
          <div class="outline-item ${levelClass}"
               data-index="${itemIndex}"
               data-level="${level}"
               data-element-id="${el.id || ''}"
               onclick="selectOutlineItem(this, event)"
               ondblclick="navigateToOutlineItem(this)"
               draggable="true"
               ondragstart="outlineDragStart(event)"
               ondragover="outlineDragOver(event)"
               ondrop="outlineDrop(event)">
            <span class="collapse-btn" onclick="toggleOutlineCollapse(this, event)">${hasChildren ? '‚ñº' : ''}</span>
            <span class="level-indicator">${levelLabel}</span>
            <span class="text" title="${text}">${displayText}</span>
          </div>
        `;
        itemIndex++;
      });

      if (!html) {
        html = '<div style="padding: 1rem; color: #666; font-style: italic;">No outline structure found. Add headings to your document to see the outline.</div>';
      }

      content.innerHTML = html;
    }

    function selectOutlineItem(item, event) {
      event.stopPropagation();

      // Deselect previous
      document.querySelectorAll('.outline-item.selected').forEach(el => el.classList.remove('selected'));

      // Select new
      item.classList.add('selected');
      selectedOutlineItem = item;
    }

    function navigateToOutlineItem(item) {
      const index = parseInt(item.dataset.index);
      const editor = document.getElementById('editor');
      const elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div');

      let targetIndex = 0;
      let targetElement = null;

      elements.forEach(el => {
        const text = el.textContent.trim();
        if (!text || text.length < 2) return;

        if (targetIndex === index) {
          targetElement = el;
        }
        targetIndex++;
      });

      if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Highlight briefly
        targetElement.style.background = '#fff3cd';
        setTimeout(() => { targetElement.style.background = ''; }, 1500);
      }
    }

    function toggleOutlineCollapse(btn, event) {
      event.stopPropagation();
      const item = btn.closest('.outline-item');
      item.classList.toggle('collapsed');
      btn.textContent = item.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    function promoteOutlineLevel() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      const index = parseInt(selectedOutlineItem.dataset.index);
      const level = parseInt(selectedOutlineItem.dataset.level);

      if (level <= 1) {
        showToast('Cannot promote further', 'error');
        return;
      }

      changeOutlineElementLevel(index, level - 1);
    }

    function demoteOutlineLevel() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      const index = parseInt(selectedOutlineItem.dataset.index);
      const level = parseInt(selectedOutlineItem.dataset.level);

      if (level >= 5) {
        showToast('Cannot demote further', 'error');
        return;
      }

      changeOutlineElementLevel(index, level + 1);
    }

    function changeOutlineElementLevel(index, newLevel) {
      const editor = document.getElementById('editor');
      const elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div');

      let targetIndex = 0;
      elements.forEach(el => {
        const text = el.textContent.trim();
        if (!text || text.length < 2) return;

        if (targetIndex === index) {
          const newTag = newLevel <= 4 ? `h${newLevel}` : 'p';
          const newEl = document.createElement(newTag);
          newEl.innerHTML = el.innerHTML;

          // Copy any styles
          newEl.style.cssText = el.style.cssText;

          el.parentNode.replaceChild(newEl, el);
          showToast(`Changed to ${newTag.toUpperCase()}`, 'success');
        }
        targetIndex++;
      });

      updateOutlineView();
    }

    function moveOutlineUp() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      moveOutlineElement(-1);
    }

    function moveOutlineDown() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      moveOutlineElement(1);
    }

    function moveOutlineElement(direction) {
      const index = parseInt(selectedOutlineItem.dataset.index);
      const editor = document.getElementById('editor');
      const elements = Array.from(editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div')).filter(el => {
        const text = el.textContent.trim();
        return text && text.length >= 2;
      });

      if (index + direction < 0 || index + direction >= elements.length) {
        showToast('Cannot move further', 'error');
        return;
      }

      const el = elements[index];
      const targetEl = elements[index + direction];

      if (direction < 0) {
        targetEl.parentNode.insertBefore(el, targetEl);
      } else {
        targetEl.parentNode.insertBefore(el, targetEl.nextSibling);
      }

      showToast('Moved', 'success');
      updateOutlineView();
    }

    function filterOutlineLevel(level) {
      outlineShowLevel = level;
      updateOutlineView();
    }

    function expandAllOutline() {
      document.querySelectorAll('.outline-item.collapsed').forEach(item => {
        item.classList.remove('collapsed');
        const btn = item.querySelector('.collapse-btn');
        if (btn && btn.textContent) btn.textContent = '‚ñº';
      });
    }

    function collapseAllOutline() {
      document.querySelectorAll('.outline-item').forEach(item => {
        const level = parseInt(item.dataset.level);
        if (level > 0 && level < 6) {
          item.classList.add('collapsed');
          const btn = item.querySelector('.collapse-btn');
          if (btn && btn.textContent) btn.textContent = '‚ñ∂';
        }
      });
    }

    // Drag and drop for outline reorganization
    let draggedOutlineItem = null;

    function outlineDragStart(event) {
      draggedOutlineItem = event.target.closest('.outline-item');
      draggedOutlineItem.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
    }

    function outlineDragOver(event) {
      event.preventDefault();
      const target = event.target.closest('.outline-item');
      if (target && target !== draggedOutlineItem) {
        target.style.borderTop = '2px solid #1a73e8';
      }
    }

    function outlineDrop(event) {
      event.preventDefault();
      const target = event.target.closest('.outline-item');

      if (target && draggedOutlineItem && target !== draggedOutlineItem) {
        const dragIndex = parseInt(draggedOutlineItem.dataset.index);
        const targetIndex = parseInt(target.dataset.index);

        // Move in actual document
        const editor = document.getElementById('editor');
        const elements = Array.from(editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div')).filter(el => {
          const text = el.textContent.trim();
          return text && text.length >= 2;
        });

        if (elements[dragIndex] && elements[targetIndex]) {
          elements[targetIndex].parentNode.insertBefore(elements[dragIndex], elements[targetIndex]);
          showToast('Reorganized', 'success');
        }
      }

      // Clean up
      document.querySelectorAll('.outline-item').forEach(item => {
        item.classList.remove('dragging');
        item.style.borderTop = '';
      });
      draggedOutlineItem = null;

      updateOutlineView();
    }

    // Update outline when editor changes
    const outlineObserver = new MutationObserver(() => {
      if (outlineVisible) {
        updateOutlineView();
      }
    });

    outlineObserver.observe(document.getElementById('editor'), {
      childList: true,
      subtree: true,
      characterData: true
    });

    // ==================== FOCUS MODE ====================
    let focusModeActive = false;
    let focusWidth = 700;

    function toggleFocusMode() {
      focusModeActive = !focusModeActive;
      const btn = document.getElementById('focusModeBtn');

      if (focusModeActive) {
        document.body.classList.add('focus-mode');
        btn.classList.add('active');
        document.documentElement.style.setProperty('--focus-width', focusWidth + 'px');
        showToast('Focus Mode enabled. Press Esc to exit.', 'info');

        // Add Esc key listener
        document.addEventListener('keydown', focusModeEscHandler);
      } else {
        document.body.classList.remove('focus-mode');
        btn.classList.remove('active');
        document.removeEventListener('keydown', focusModeEscHandler);
      }
    }

    function focusModeEscHandler(e) {
      if (e.key === 'Escape' && focusModeActive) {
        toggleFocusMode();
      }
    }

    function adjustFocusWidth(delta) {
      focusWidth = Math.max(400, Math.min(1000, focusWidth + delta));
      document.querySelector('.document-page').style.maxWidth = focusWidth + 'px';
    }

    function toggleFocusDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    // ==================== READ ALOUD (Text-to-Speech) ====================
    let readAloudActive = false;
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;

    function toggleReadAloud() {
      if (readAloudActive) {
        stopReadAloud();
      } else {
        startReadAloud();
      }
    }

    function startReadAloud() {
      const editor = document.getElementById('editor');
      let text = '';

      // Get selected text or full document
      const selection = window.getSelection();
      if (selection && selection.toString().trim()) {
        text = selection.toString();
      } else {
        text = editor.innerText;
      }

      if (!text.trim()) {
        showToast('No text to read', 'error');
        return;
      }

      if (!speechSynthesis) {
        showToast('Text-to-speech not supported in this browser', 'error');
        return;
      }

      readAloudActive = true;
      const btn = document.getElementById('readAloudBtn');
      btn.classList.add('active');
      btn.innerHTML = '‚èπ Stop';

      // Split into sentences for better highlighting
      const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
      let sentenceIndex = 0;

      function speakNextSentence() {
        if (sentenceIndex >= sentences.length || !readAloudActive) {
          stopReadAloud();
          return;
        }

        const sentence = sentences[sentenceIndex].trim();
        currentUtterance = new SpeechSynthesisUtterance(sentence);

        // Configure voice
        currentUtterance.rate = 0.9;
        currentUtterance.pitch = 1;

        // Try to use a good voice
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Google')) ||
                               voices.find(v => v.lang.startsWith('en'));
        if (preferredVoice) {
          currentUtterance.voice = preferredVoice;
        }

        currentUtterance.onend = () => {
          sentenceIndex++;
          speakNextSentence();
        };

        currentUtterance.onerror = () => {
          sentenceIndex++;
          speakNextSentence();
        };

        speechSynthesis.speak(currentUtterance);
      }

      // Start speaking
      speakNextSentence();
      showToast('Reading aloud...', 'info');
    }

    function stopReadAloud() {
      readAloudActive = false;
      if (speechSynthesis) {
        speechSynthesis.cancel();
      }
      currentUtterance = null;

      const btn = document.getElementById('readAloudBtn');
      btn.classList.remove('active');
      btn.innerHTML = 'üîä Read';

      // Remove any highlights
      document.querySelectorAll('.read-aloud-highlight').forEach(el => {
        el.outerHTML = el.innerHTML;
      });
    }

    // Load voices (needed for some browsers)
    if (speechSynthesis) {
      speechSynthesis.onvoiceschanged = () => {
        speechSynthesis.getVoices();
      };
    }

    // ========== Keyboard Shortcuts ==========
    function showKeyboardShortcuts() {
      document.getElementById('shortcutsModal').style.display = 'flex';
    }

    function hideKeyboardShortcuts() {
      document.getElementById('shortcutsModal').style.display = 'none';
    }

    // F1 key to show shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardShortcuts();
      }
    });

    // Click outside modal to close
    document.getElementById('shortcutsModal').addEventListener('click', (e) => {
      if (e.target.id === 'shortcutsModal') {
        hideKeyboardShortcuts();
      }
    });

    // ========== Word Count ==========
    function showWordCount() {
      const editor = document.getElementById('editor');
      const text = editor.innerText || '';
      const selection = window.getSelection();
      const selectedText = selection.toString();

      // Calculate statistics
      const stats = calculateTextStats(text);

      // Update modal
      document.getElementById('wcPages').textContent = stats.pages;
      document.getElementById('wcWords').textContent = stats.words.toLocaleString();
      document.getElementById('wcCharsNoSpaces').textContent = stats.charsNoSpaces.toLocaleString();
      document.getElementById('wcCharsWithSpaces').textContent = stats.charsWithSpaces.toLocaleString();
      document.getElementById('wcParagraphs').textContent = stats.paragraphs.toLocaleString();
      document.getElementById('wcLines').textContent = stats.lines.toLocaleString();
      document.getElementById('wcReadTime').textContent = stats.readTime;

      // Selection info
      if (selectedText.length > 0) {
        const selStats = calculateTextStats(selectedText);
        document.getElementById('wcSelectionInfo').textContent =
          `${selStats.words} words, ${selStats.charsWithSpaces} characters selected`;
      } else {
        document.getElementById('wcSelectionInfo').textContent = 'No text selected';
      }

      document.getElementById('wordCountModal').style.display = 'flex';
    }

    function hideWordCount() {
      document.getElementById('wordCountModal').style.display = 'none';
    }

    function calculateTextStats(text) {
      // Words - split by whitespace, filter empty
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const wordCount = text.trim() === '' ? 0 : words.length;

      // Characters
      const charsWithSpaces = text.length;
      const charsNoSpaces = text.replace(/\s/g, '').length;

      // Paragraphs - split by double newlines or count block elements
      const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0).length || 1;

      // Lines
      const lines = text.split(/\n/).length;

      // Pages (estimate: ~250 words per page)
      const pages = Math.max(1, Math.ceil(wordCount / 250));

      // Reading time (average 200 words per minute)
      const minutes = Math.ceil(wordCount / 200);
      const readTime = minutes < 1 ? 'Less than 1 min' : `${minutes} min`;

      return {
        words: wordCount,
        charsWithSpaces,
        charsNoSpaces,
        paragraphs,
        lines,
        pages,
        readTime
      };
    }

    // Click outside word count modal to close
    document.getElementById('wordCountModal').addEventListener('click', (e) => {
      if (e.target.id === 'wordCountModal') {
        hideWordCount();
      }
    });

    // Live word count in status bar
    function updateStatusBarWordCount() {
      const editor = document.getElementById('editor');
      if (!editor) return;

      const text = editor.innerText || '';
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const wordCount = text.trim() === '' ? 0 : words.length;
      const charCount = text.length;

      const statusCenter = document.getElementById('statusCenter');
      if (statusCenter) {
        statusCenter.textContent = `Words: ${wordCount.toLocaleString()} | Characters: ${charCount.toLocaleString()}`;
      }

      // Update page estimation (approx 250 words per page)
      const totalPages = Math.max(1, Math.ceil(wordCount / 250));
      document.getElementById('totalPages').textContent = totalPages;

      // Estimate current page based on cursor position
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const textBeforeCursor = editor.innerText.substring(0, getCaretPosition(editor));
        const wordsBeforeCursor = textBeforeCursor.trim().split(/\s+/).filter(w => w.length > 0).length;
        const currentPage = Math.max(1, Math.ceil(wordsBeforeCursor / 250) || 1);
        document.getElementById('currentPage').textContent = Math.min(currentPage, totalPages);
      }
    }

    // Helper to get caret position
    function getCaretPosition(element) {
      let caretPos = 0;
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(element);
        preCaretRange.setEnd(range.endContainer, range.endOffset);
        caretPos = preCaretRange.toString().length;
      }
      return caretPos;
    }

    // Update word count on editor changes
    document.addEventListener('DOMContentLoaded', () => {
      const editor = document.getElementById('editor');
      if (editor) {
        editor.addEventListener('input', updateStatusBarWordCount);
        editor.addEventListener('click', updateStatusBarWordCount);
        editor.addEventListener('keyup', updateStatusBarWordCount);
        // Initial update
        setTimeout(updateStatusBarWordCount, 500);
      }
      // Initialize recent files
      updateRecentFilesMenu();
    });

    // ========== Quick Parts / AutoText ==========
    const QUICK_PARTS_KEY = 'ninjaword_quickparts';
    let selectedQuickPartId = null;
    let selectedQuickPartsCategory = 'general';

    const builtInQuickParts = {
      general: [
        { id: 'g1', name: 'Today\'s Date', content: '<span class="quick-part-date"></span>', preview: 'Inserts current date' },
        { id: 'g2', name: 'Page Break', content: '<div style="page-break-after: always;"></div><p></p>', preview: 'Insert page break' },
        { id: 'g3', name: 'Horizontal Line', content: '<hr style="border: none; border-top: 2px solid #333; margin: 1rem 0;">', preview: '‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî' },
        { id: 'g4', name: 'Signature Line', content: '<div style="margin-top: 2rem; border-top: 1px solid #000; width: 200px; padding-top: 4px;">Signature</div>', preview: 'Signature line' },
      ],
      headers: [
        { id: 'h1', name: 'Simple Header', content: '<div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 1rem;"><strong>Document Title</strong></div>', preview: 'Centered title header' },
        { id: 'h2', name: 'Header with Date', content: '<div style="display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 1rem;"><span>Document Title</span><span>[Date]</span></div>', preview: 'Title with date' },
        { id: 'h3', name: 'Footer with Page', content: '<div style="text-align: center; border-top: 1px solid #ccc; padding-top: 8px; margin-top: 2rem; font-size: 0.9em;">Page [#]</div>', preview: 'Centered page number' },
      ],
      textboxes: [
        { id: 't1', name: 'Sidebar Quote', content: '<div style="float: right; width: 200px; padding: 1rem; margin: 0 0 1rem 1rem; background: #f5f5f5; border-left: 4px solid #1a73e8; font-style: italic;">"Your quote here..."</div>', preview: 'Floating quote box' },
        { id: 't2', name: 'Callout Box', content: '<div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; margin: 1rem 0;"><strong>üìå Note:</strong> Your important note here...</div>', preview: 'Yellow callout box' },
        { id: 't3', name: 'Info Box', content: '<div style="padding: 1rem; background: #d1ecf1; border: 1px solid #0dcaf0; border-radius: 8px; margin: 1rem 0;"><strong>‚ÑπÔ∏è Info:</strong> Information goes here...</div>', preview: 'Blue info box' },
        { id: 't4', name: 'Warning Box', content: '<div style="padding: 1rem; background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px; margin: 1rem 0;"><strong>‚ö†Ô∏è Warning:</strong> Warning text here...</div>', preview: 'Red warning box' },
      ],
      coverpage: [
        { id: 'c1', name: 'Simple Cover', content: '<div style="text-align: center; padding: 4rem 2rem; min-height: 80vh; display: flex; flex-direction: column; justify-content: center;"><h1 style="font-size: 3rem; margin-bottom: 1rem;">Document Title</h1><p style="font-size: 1.5rem; color: #666;">Subtitle or Description</p><p style="margin-top: 3rem;">Author Name<br>Date</p></div><div style="page-break-after: always;"></div>', preview: 'Centered title page' },
        { id: 'c2', name: 'Modern Cover', content: '<div style="min-height: 90vh; background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); color: white; padding: 3rem; display: flex; flex-direction: column; justify-content: flex-end;"><h1 style="font-size: 3.5rem; margin: 0;">Document Title</h1><p style="font-size: 1.3rem; opacity: 0.9; margin-top: 1rem;">A comprehensive overview</p><div style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3);"><p>Prepared by: Author Name</p><p>Date: [Date]</p></div></div><div style="page-break-after: always;"></div>', preview: 'Blue gradient cover' },
      ],
      autotext: [
        { id: 'a1', name: 'Regards', content: '<p>Best regards,<br><br>[Your Name]</p>', preview: 'Best regards signature' },
        { id: 'a2', name: 'Sincerely', content: '<p>Sincerely,<br><br>[Your Name]<br>[Title]</p>', preview: 'Sincerely signature' },
        { id: 'a3', name: 'CONFIDENTIAL', content: '<p style="color: #dc3545; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">‚ö†Ô∏è CONFIDENTIAL - DO NOT DISTRIBUTE</p>', preview: 'Confidential notice' },
        { id: 'a4', name: 'DRAFT', content: '<p style="color: #6c757d; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; text-align: center;">‚Äî DRAFT ‚Äî</p>', preview: 'Draft marker' },
        { id: 'a5', name: 'Lorem Ipsum', content: '<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.</p>', preview: 'Placeholder text' },
      ],
      custom: []
    };

    function getCustomQuickParts() {
      try {
        return JSON.parse(localStorage.getItem(QUICK_PARTS_KEY)) || [];
      } catch { return []; }
    }

    function saveCustomQuickParts(parts) {
      localStorage.setItem(QUICK_PARTS_KEY, JSON.stringify(parts));
    }

    function showQuickParts() {
      selectedQuickPartId = null;
      selectedQuickPartsCategory = 'general';
      document.querySelectorAll('.quickparts-category').forEach(el => {
        el.classList.toggle('active', el.dataset.category === 'general');
      });
      renderQuickPartsGallery('general');
      document.getElementById('quickPartsModal').style.display = 'flex';
    }

    function hideQuickParts() {
      document.getElementById('quickPartsModal').style.display = 'none';
    }

    function selectQuickPartsCategory(category) {
      selectedQuickPartsCategory = category;
      selectedQuickPartId = null;
      document.querySelectorAll('.quickparts-category').forEach(el => {
        el.classList.toggle('active', el.dataset.category === category);
      });
      renderQuickPartsGallery(category);
    }

    function renderQuickPartsGallery(category) {
      const gallery = document.getElementById('quickPartsGallery');
      let parts = builtInQuickParts[category] || [];

      if (category === 'custom') {
        parts = getCustomQuickParts();
      }

      if (parts.length === 0) {
        gallery.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 2rem;">No quick parts in this category.<br>Select text and save it as a custom Quick Part.</div>';
        return;
      }

      gallery.innerHTML = parts.map(part => `
        <div class="quickpart-item ${selectedQuickPartId === part.id ? 'selected' : ''}"
             onclick="selectQuickPart('${part.id}')"
             ondblclick="insertQuickPartById('${part.id}')">
          <div class="quickpart-item-name">${part.name}</div>
          <div class="quickpart-item-preview">${part.preview}</div>
          ${category === 'custom' ? `
            <div class="quickpart-item-actions">
              <button class="btn btn-danger" onclick="event.stopPropagation(); deleteQuickPart('${part.id}')">Delete</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function selectQuickPart(id) {
      selectedQuickPartId = id;
      document.querySelectorAll('.quickpart-item').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
    }

    function insertSelectedQuickPart() {
      if (!selectedQuickPartId) {
        showToast('Please select a Quick Part', 'warning');
        return;
      }
      insertQuickPartById(selectedQuickPartId);
    }

    function insertQuickPartById(id) {
      let part = null;

      // Search in built-in parts
      for (const category in builtInQuickParts) {
        const found = builtInQuickParts[category].find(p => p.id === id);
        if (found) { part = found; break; }
      }

      // Search in custom parts
      if (!part) {
        const custom = getCustomQuickParts();
        part = custom.find(p => p.id === id);
      }

      if (!part) {
        showToast('Quick Part not found', 'error');
        return;
      }

      let content = part.content;

      // Replace dynamic placeholders
      content = content.replace(/<span class="quick-part-date"><\/span>/g, new Date().toLocaleDateString());
      content = content.replace(/\[Date\]/g, new Date().toLocaleDateString());

      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const fragment = range.createContextualFragment(content);
        range.deleteContents();
        range.insertNode(fragment);
        range.collapse(false);
      } else {
        editor.innerHTML += content;
      }

      hideQuickParts();
      showToast(`Inserted "${part.name}"`, 'success');
      updateStatusBarWordCount();
    }

    function saveQuickPart() {
      const name = document.getElementById('quickPartName').value.trim();
      const category = document.getElementById('quickPartCategory').value;

      if (!name) {
        showToast('Please enter a name for the Quick Part', 'error');
        return;
      }

      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Please select some text in the document first', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);
      const container = document.createElement('div');
      container.appendChild(range.cloneContents());
      const content = container.innerHTML;

      if (!content.trim()) {
        showToast('Selection is empty', 'error');
        return;
      }

      const preview = container.textContent.substring(0, 50) + (container.textContent.length > 50 ? '...' : '');

      const customParts = getCustomQuickParts();
      customParts.push({
        id: 'custom_' + Date.now(),
        name: name,
        content: content,
        preview: preview,
        category: category
      });
      saveCustomQuickParts(customParts);

      document.getElementById('quickPartName').value = '';

      if (selectedQuickPartsCategory === 'custom') {
        renderQuickPartsGallery('custom');
      }

      showToast(`Quick Part "${name}" saved`, 'success');
    }

    function deleteQuickPart(id) {
      if (!confirm('Delete this Quick Part?')) return;

      let customParts = getCustomQuickParts();
      customParts = customParts.filter(p => p.id !== id);
      saveCustomQuickParts(customParts);

      renderQuickPartsGallery('custom');
      showToast('Quick Part deleted', 'success');
    }

    // ========== Digital Signature ==========
    let signatureType = 'draw';
    let signatureCtx = null;
    let isDrawing = false;
    let uploadedSignatureData = null;

    function showDigitalSignature() {
      document.getElementById('digitalSignatureModal').style.display = 'flex';
      signatureType = 'draw';
      uploadedSignatureData = null;
      selectSignatureType('draw');
      initSignatureCanvas();
    }

    function hideDigitalSignature() {
      document.getElementById('digitalSignatureModal').style.display = 'none';
    }

    function selectSignatureType(type) {
      signatureType = type;
      document.querySelectorAll('.signature-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      document.getElementById('signatureDrawPanel').style.display = type === 'draw' ? 'block' : 'none';
      document.getElementById('signatureTypePanel').style.display = type === 'type' ? 'block' : 'none';
      document.getElementById('signatureUploadPanel').style.display = type === 'upload' ? 'block' : 'none';

      if (type === 'draw') initSignatureCanvas();
      if (type === 'type') updateTypedSignaturePreview();
    }

    function initSignatureCanvas() {
      const canvas = document.getElementById('signatureCanvas');
      signatureCtx = canvas.getContext('2d');
      signatureCtx.fillStyle = 'white';
      signatureCtx.fillRect(0, 0, canvas.width, canvas.height);
      signatureCtx.strokeStyle = '#000000';
      signatureCtx.lineWidth = 3;
      signatureCtx.lineCap = 'round';
      signatureCtx.lineJoin = 'round';

      canvas.onmousedown = startDrawing;
      canvas.onmousemove = draw;
      canvas.onmouseup = stopDrawing;
      canvas.onmouseleave = stopDrawing;

      // Touch support
      canvas.ontouchstart = (e) => { e.preventDefault(); startDrawing(e.touches[0]); };
      canvas.ontouchmove = (e) => { e.preventDefault(); draw(e.touches[0]); };
      canvas.ontouchend = stopDrawing;
    }

    function startDrawing(e) {
      isDrawing = true;
      const canvas = document.getElementById('signatureCanvas');
      const rect = canvas.getBoundingClientRect();
      signatureCtx.beginPath();
      signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
      if (!isDrawing) return;
      const canvas = document.getElementById('signatureCanvas');
      const rect = canvas.getBoundingClientRect();
      signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      signatureCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function clearSignatureCanvas() {
      const canvas = document.getElementById('signatureCanvas');
      signatureCtx.fillStyle = 'white';
      signatureCtx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function updateSignaturePen() {
      const color = document.getElementById('signaturePenColor').value;
      const size = parseInt(document.getElementById('signaturePenSize').value);
      signatureCtx.strokeStyle = color;
      signatureCtx.lineWidth = size;
    }

    function updateTypedSignaturePreview() {
      const text = document.getElementById('signatureText').value || 'Your Name';
      const font = document.getElementById('signatureFont').value;
      const preview = document.getElementById('typedSignaturePreview');
      preview.style.fontFamily = font;
      preview.textContent = text;
    }

    function previewUploadedSignature() {
      const file = document.getElementById('signatureUpload').files[0];
      const preview = document.getElementById('uploadedSignaturePreview');

      if (!file) {
        preview.innerHTML = '<span style="color: #666;">No image selected</span>';
        uploadedSignatureData = null;
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedSignatureData = e.target.result;
        preview.innerHTML = `<img src="${uploadedSignatureData}" style="max-height: 100px; max-width: 100%;">`;
      };
      reader.readAsDataURL(file);
    }

    function insertDigitalSignature() {
      const signerName = document.getElementById('signerName').value.trim();
      const signerTitle = document.getElementById('signerTitle').value.trim();
      const includeDate = document.getElementById('includeDate').checked;
      const includeTimestamp = document.getElementById('includeTimestamp').checked;

      let signatureImageSrc = '';

      if (signatureType === 'draw') {
        const canvas = document.getElementById('signatureCanvas');
        // Check if canvas has content
        const imageData = signatureCtx.getImageData(0, 0, canvas.width, canvas.height);
        const hasContent = imageData.data.some((val, i) => i % 4 !== 3 && val !== 255);
        if (!hasContent) {
          showToast('Please draw your signature', 'warning');
          return;
        }
        signatureImageSrc = canvas.toDataURL('image/png');
      } else if (signatureType === 'type') {
        const text = document.getElementById('signatureText').value.trim();
        if (!text) {
          showToast('Please type your signature', 'warning');
          return;
        }
        // Create image from typed text
        const font = document.getElementById('signatureFont').value;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 400;
        tempCanvas.height = 80;
        const ctx = tempCanvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        ctx.font = `36px ${font}`;
        ctx.fillStyle = '#000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, 200, 40);
        signatureImageSrc = tempCanvas.toDataURL('image/png');
      } else if (signatureType === 'upload') {
        if (!uploadedSignatureData) {
          showToast('Please upload a signature image', 'warning');
          return;
        }
        signatureImageSrc = uploadedSignatureData;
      }

      // Build date string
      let dateStr = '';
      if (includeDate) {
        dateStr = new Date().toLocaleDateString();
        if (includeTimestamp) {
          dateStr += ' ' + new Date().toLocaleTimeString();
        }
      }

      // Generate unique signature ID for verification
      const signatureId = 'SIG-' + Date.now().toString(36).toUpperCase();

      // Build signature HTML
      const signatureHTML = `
        <div class="digital-signature-block" contenteditable="false">
          <img class="sig-image" src="${signatureImageSrc}" alt="Signature">
          <div class="sig-info">
            ${signerName ? `<div class="sig-name">${signerName}</div>` : ''}
            ${signerTitle ? `<div class="sig-title">${signerTitle}</div>` : ''}
            ${dateStr ? `<div class="sig-date">Signed: ${dateStr}</div>` : ''}
            <div class="sig-verification">‚úì Digitally Signed (${signatureId})</div>
          </div>
        </div>
      `;

      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const fragment = range.createContextualFragment(signatureHTML);
        range.deleteContents();
        range.insertNode(fragment);
        range.collapse(false);
      } else {
        editor.innerHTML += signatureHTML;
      }

      hideDigitalSignature();
      showToast('Digital signature inserted', 'success');
      updateStatusBarWordCount();
    }

    // ========== Text Box ==========
    let selectedTextBoxStyle = 'simple';

    function showTextBoxModal() {
      selectedTextBoxStyle = 'simple';
      document.querySelectorAll('.textbox-style-option').forEach(el => {
        el.style.borderColor = el.dataset.style === 'simple' ? '#1a73e8' : '#ddd';
      });
      document.getElementById('textBoxModal').style.display = 'flex';
    }

    function hideTextBoxModal() {
      document.getElementById('textBoxModal').style.display = 'none';
    }

    function selectTextBoxStyle(style) {
      selectedTextBoxStyle = style;
      document.querySelectorAll('.textbox-style-option').forEach(el => {
        el.style.borderColor = el.dataset.style === style ? '#1a73e8' : '#ddd';
      });
    }

    function insertTextBox() {
      const width = parseInt(document.getElementById('textBoxWidth').value) || 300;
      const height = parseInt(document.getElementById('textBoxHeight').value) || 150;
      const position = document.querySelector('input[name="textBoxPosition"]:checked').value;
      const borderColor = document.getElementById('textBoxBorderColor').value;
      const bgColor = document.getElementById('textBoxBgColor').value;

      let styles = {
        width: width + 'px',
        minHeight: height + 'px',
        padding: '12px',
        margin: '1rem',
        backgroundColor: bgColor,
        borderColor: borderColor
      };

      let baseStyle = `
        width: ${styles.width};
        min-height: ${styles.minHeight};
        padding: ${styles.padding};
        background-color: ${styles.backgroundColor};
      `;

      // Apply style-specific attributes
      switch (selectedTextBoxStyle) {
        case 'simple':
          baseStyle += `border: 1px solid ${borderColor};`;
          break;
        case 'shadow':
          baseStyle += `border: 1px solid ${borderColor}; box-shadow: 4px 4px 8px rgba(0,0,0,0.3);`;
          break;
        case 'rounded':
          baseStyle += `border: 1px solid ${borderColor}; border-radius: 16px;`;
          break;
        case 'colored':
          baseStyle += `border: 2px solid #1a73e8; background-color: #e3f2fd;`;
          break;
        case 'callout':
          baseStyle += `border: none; border-left: 4px solid #1a73e8; background-color: #f5f5f5;`;
          break;
        case 'quote':
          baseStyle += `border: none; background-color: #f9f9f9; font-style: italic;`;
          break;
      }

      // Apply position
      switch (position) {
        case 'float-left':
          baseStyle += ' float: left; margin-right: 1rem; margin-bottom: 0.5rem;';
          break;
        case 'float-right':
          baseStyle += ' float: right; margin-left: 1rem; margin-bottom: 0.5rem;';
          break;
        default:
          baseStyle += ' display: inline-block; margin: 1rem 0;';
      }

      const textBoxHTML = `
        <div class="text-box" contenteditable="true" style="${baseStyle}">
          <p>Click here to add text...</p>
        </div>
      `;

      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        const range = selection.getRangeAt(0);
        const fragment = range.createContextualFragment(textBoxHTML);
        range.deleteContents();
        range.insertNode(fragment);
        range.collapse(false);
      } else {
        editor.innerHTML += textBoxHTML;
      }

      hideTextBoxModal();
      showToast('Text box inserted', 'success');
      updateStatusBarWordCount();
    }

    // ========== Document Inspector ==========
    let inspectorResults = {};

    function showDocumentInspector() {
      // Reset results display
      document.querySelectorAll('.inspector-result').forEach(el => {
        el.className = 'inspector-result';
        el.innerHTML = '';
      });
      inspectorResults = {};
      document.getElementById('documentInspectorModal').style.display = 'flex';
      toggleFileMenu();
    }

    function hideDocumentInspector() {
      document.getElementById('documentInspectorModal').style.display = 'none';
    }

    function runDocumentInspector() {
      const editor = document.getElementById('editor');
      inspectorResults = {};

      // Inspect Comments & Revisions
      if (document.getElementById('inspectComments').checked) {
        const comments = editor.querySelectorAll('.comment, .track-change, [data-comment]');
        const resultEl = document.getElementById('resultComments');
        if (comments.length > 0) {
          inspectorResults.comments = comments;
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${comments.length} comment(s) or tracked change(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No comments or revisions found';
        }
      }

      // Inspect Document Properties
      if (document.getElementById('inspectProperties').checked) {
        const fileName = document.getElementById('fileName').value;
        const resultEl = document.getElementById('resultProperties');
        const hasProperties = fileName && fileName !== 'Untitled Document';
        if (hasProperties) {
          inspectorResults.properties = { fileName };
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Document name: "${fileName}"`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No custom properties found';
        }
      }

      // Inspect Hidden Text
      if (document.getElementById('inspectHiddenText').checked) {
        const hidden = editor.querySelectorAll('[style*="display: none"], [style*="visibility: hidden"], [hidden]');
        const resultEl = document.getElementById('resultHiddenText');
        if (hidden.length > 0) {
          inspectorResults.hiddenText = hidden;
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${hidden.length} hidden element(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No hidden text found';
        }
      }

      // Inspect Personal Information
      if (document.getElementById('inspectPersonalInfo').checked) {
        const content = editor.textContent;
        const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
        const phoneRegex = /(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g;
        const emails = content.match(emailRegex) || [];
        const phones = content.match(phoneRegex) || [];
        const resultEl = document.getElementById('resultPersonalInfo');
        if (emails.length > 0 || phones.length > 0) {
          inspectorResults.personalInfo = { emails, phones };
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${emails.length} email(s), ${phones.length} phone number(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No personal information patterns detected';
        }
      }

      // Inspect Hyperlinks
      if (document.getElementById('inspectLinks').checked) {
        const links = editor.querySelectorAll('a[href]');
        const resultEl = document.getElementById('resultLinks');
        if (links.length > 0) {
          inspectorResults.links = links;
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${links.length} hyperlink(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No hyperlinks found';
        }
      }

      // Inspect Embedded Images
      if (document.getElementById('inspectImages').checked) {
        const images = editor.querySelectorAll('img');
        const resultEl = document.getElementById('resultImages');
        if (images.length > 0) {
          inspectorResults.images = images;
          let totalSize = 0;
          images.forEach(img => {
            if (img.src.startsWith('data:')) {
              totalSize += img.src.length * 0.75; // Approximate base64 size
            }
          });
          const sizeStr = totalSize > 1024 * 1024
            ? (totalSize / (1024 * 1024)).toFixed(2) + ' MB'
            : (totalSize / 1024).toFixed(2) + ' KB';
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${images.length} image(s) (~${sizeStr} embedded data)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No embedded images found';
        }
      }

      showToast('Inspection complete', 'success');
    }

    function removeAllInspected() {
      const editor = document.getElementById('editor');
      let removed = 0;

      if (inspectorResults.comments) {
        inspectorResults.comments.forEach(el => {
          el.remove();
          removed++;
        });
      }

      if (inspectorResults.hiddenText) {
        inspectorResults.hiddenText.forEach(el => {
          el.remove();
          removed++;
        });
      }

      if (inspectorResults.links) {
        inspectorResults.links.forEach(link => {
          const text = document.createTextNode(link.textContent);
          link.parentNode.replaceChild(text, link);
          removed++;
        });
      }

      if (inspectorResults.images) {
        inspectorResults.images.forEach(img => {
          img.remove();
          removed++;
        });
      }

      if (removed > 0) {
        showToast(`Removed ${removed} item(s)`, 'success');
        runDocumentInspector(); // Re-run to update display
      } else {
        showToast('Nothing to remove', 'info');
      }
    }

    // ========== Reading Mode ==========
    let readingFontSize = 1.2;

    function toggleReadingMode() {
      const overlay = document.getElementById('readingModeOverlay');
      if (overlay.classList.contains('active')) {
        overlay.classList.remove('active');
      } else {
        const title = document.getElementById('fileName').value || 'Document';
        document.getElementById('readingTitle').textContent = title;
        const content = document.getElementById('editor').innerHTML;
        document.getElementById('readingText').innerHTML = content;
        overlay.classList.add('active');
        updateReadingProgress();
      }
    }

    function changeReadingTheme(theme) {
      const overlay = document.getElementById('readingModeOverlay');
      overlay.classList.remove('sepia', 'light', 'dark');
      if (theme !== 'light') overlay.classList.add(theme);
    }

    function adjustReadingFontSize(delta) {
      readingFontSize = Math.max(0.8, Math.min(2.5, readingFontSize + delta * 0.1));
      document.getElementById('readingText').style.fontSize = readingFontSize + 'rem';
    }

    function updateReadingProgress() {
      const content = document.getElementById('readingContent');
      const progress = document.getElementById('readingProgress');
      const scrollPercent = (content.scrollTop / (content.scrollHeight - content.clientHeight)) * 100;
      progress.style.width = Math.min(100, Math.max(0, scrollPercent || 0)) + '%';
    }

    // Escape key to exit reading mode
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('readingModeOverlay').classList.contains('active')) {
        toggleReadingMode();
      }
    });

    // ========== Recent Files ==========
    const RECENT_FILES_KEY = 'ninjaword_recent';
    const MAX_RECENT_FILES = 10;

    function getRecentFiles() {
      try {
        return JSON.parse(localStorage.getItem(RECENT_FILES_KEY)) || [];
      } catch {
        return [];
      }
    }

    function addToRecentFiles(docId, name) {
      let recent = getRecentFiles();
      // Remove if already exists
      recent = recent.filter(f => f.id !== docId);
      // Add to front
      recent.unshift({
        id: docId,
        name: name,
        timestamp: Date.now()
      });
      // Keep only max items
      recent = recent.slice(0, MAX_RECENT_FILES);
      localStorage.setItem(RECENT_FILES_KEY, JSON.stringify(recent));
      updateRecentFilesMenu();
    }

    function toggleRecentFiles(event) {
      event.stopPropagation();
      const submenu = document.getElementById('recentFilesMenu');
      submenu.classList.toggle('show');
    }

    function updateRecentFilesMenu() {
      const menu = document.getElementById('recentFilesMenu');
      const recent = getRecentFiles();
      const docs = getSavedDocuments();

      if (recent.length === 0) {
        menu.innerHTML = '<div class="submenu-empty">No recent files</div>';
        return;
      }

      menu.innerHTML = recent
        .filter(f => docs[f.id]) // Only show files that still exist
        .map(f => {
          const date = new Date(f.timestamp);
          const dateStr = date.toLocaleDateString();
          return `<div class="submenu-item" onclick="openRecentFile('${f.id}')">
            <span>${f.name}</span>
            <span class="file-date">${dateStr}</span>
          </div>`;
        }).join('');

      if (menu.innerHTML === '') {
        menu.innerHTML = '<div class="submenu-empty">No recent files</div>';
      }
    }

    function openRecentFile(docId) {
      const docs = getSavedDocuments();
      if (docs[docId]) {
        editor.innerHTML = docs[docId].content;
        document.getElementById('fileName').value = docs[docId].name;
        currentDocId = docId;
        addToRecentFiles(docId, docs[docId].name);
        toggleFileMenu();
        showToast('Document opened', 'success');
      } else {
        showToast('Document not found', 'error');
      }
    }

    // Close submenu when clicking elsewhere
    document.addEventListener('click', () => {
      document.getElementById('recentFilesMenu')?.classList.remove('show');
    });

    // ==================== READING PROGRESS ====================
    let readingProgressEnabled = false;
    let readingStartTime = null;
    let lastScrollPosition = 0;

    function toggleReadingProgress() {
      readingProgressEnabled = !readingProgressEnabled;
      const btn = document.getElementById('readingProgressBtn');
      const bar = document.getElementById('readingProgressBar');
      const info = document.getElementById('readingProgressInfo');

      if (readingProgressEnabled) {
        btn.classList.add('active');
        bar.style.display = 'block';
        info.classList.add('visible');
        readingStartTime = Date.now();
        updateReadingProgress();
        showToast('Reading progress enabled', 'success');
      } else {
        btn.classList.remove('active');
        bar.style.display = 'none';
        info.classList.remove('visible');
        showToast('Reading progress disabled', 'info');
      }
    }

    function updateReadingProgress() {
      if (!readingProgressEnabled) return;

      const docArea = document.querySelector('.document-area');
      const editor = document.getElementById('editor');

      if (!docArea || !editor) return;

      // Calculate scroll progress
      const scrollTop = docArea.scrollTop;
      const scrollHeight = docArea.scrollHeight - docArea.clientHeight;
      const progress = scrollHeight > 0 ? Math.min(100, (scrollTop / scrollHeight) * 100) : 0;

      // Update progress bar
      document.getElementById('readingProgressBar').style.width = `${progress}%`;
      document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;

      // Get document stats
      const text = editor.innerText || editor.textContent || '';
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const totalWords = words.length;
      const wordsRead = Math.floor(totalWords * (progress / 100));

      document.getElementById('wordsRead').textContent = `${wordsRead.toLocaleString()} / ${totalWords.toLocaleString()}`;

      // Calculate time reading
      if (readingStartTime) {
        const elapsed = Math.floor((Date.now() - readingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timeReading').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        // Calculate reading speed and time remaining
        if (wordsRead > 0 && elapsed > 10) {
          const wpm = Math.round((wordsRead / elapsed) * 60);
          document.getElementById('readingSpeed').textContent = `${wpm} wpm`;

          const remainingWords = totalWords - wordsRead;
          if (wpm > 0 && remainingWords > 0) {
            const remainingMinutes = Math.ceil(remainingWords / wpm);
            document.getElementById('timeRemaining').textContent = remainingMinutes < 60
              ? `${remainingMinutes} min`
              : `${Math.floor(remainingMinutes / 60)}h ${remainingMinutes % 60}m`;
          } else {
            document.getElementById('timeRemaining').textContent = '< 1 min';
          }
        }
      }
    }

    // Listen for scroll events on document area
    document.querySelector('.document-area')?.addEventListener('scroll', () => {
      if (readingProgressEnabled) {
        updateReadingProgress();
      }
    });

    // Update progress periodically
    setInterval(() => {
      if (readingProgressEnabled) {
        updateReadingProgress();
      }
    }, 1000);

    // ==================== DOCUMENT STATISTICS ====================
    function showDocumentStatistics() {
      const editor = document.getElementById('editor');
      const text = editor.innerText || editor.textContent || '';

      // Basic stats
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const chars = text.replace(/\s/g, '').length;
      const charsWithSpaces = text.length;
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      const paragraphs = editor.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6').length || text.split(/\n\n+/).filter(p => p.trim()).length || 1;

      // Update stats display
      document.getElementById('statWords').textContent = words.length.toLocaleString();
      document.getElementById('statChars').textContent = chars.toLocaleString();
      document.getElementById('statSentences').textContent = sentences.toLocaleString();
      document.getElementById('statParagraphs').textContent = paragraphs.toLocaleString();

      // Reading time estimates
      const avgMinutes = Math.ceil(words.length / 200);
      const fastMinutes = Math.ceil(words.length / 300);
      const speakMinutes = Math.ceil(words.length / 150);

      document.getElementById('statReadAvg').textContent = avgMinutes < 60
        ? `${avgMinutes} min`
        : `${Math.floor(avgMinutes / 60)}h ${avgMinutes % 60}m`;
      document.getElementById('statReadFast').textContent = fastMinutes < 60
        ? `${fastMinutes} min`
        : `${Math.floor(fastMinutes / 60)}h ${fastMinutes % 60}m`;
      document.getElementById('statSpeak').textContent = speakMinutes < 60
        ? `${speakMinutes} min`
        : `${Math.floor(speakMinutes / 60)}h ${speakMinutes % 60}m`;

      // Readability stats
      const avgWordLength = words.length > 0
        ? (words.join('').length / words.length).toFixed(1)
        : 0;
      const avgSentenceLength = sentences > 0
        ? (words.length / sentences).toFixed(1)
        : 0;
      const uniqueWords = new Set(words.map(w => w.toLowerCase())).size;

      document.getElementById('statAvgWordLen').textContent = `${avgWordLength} chars`;
      document.getElementById('statAvgSentLen').textContent = `${avgSentenceLength} words`;
      document.getElementById('statUniqueWords').textContent = uniqueWords.toLocaleString();

      document.getElementById('docStatsModal').style.display = 'flex';
    }

    function hideDocumentStatistics() {
      document.getElementById('docStatsModal').style.display = 'none';
    }

    function copyStatistics() {
      const stats = `Document Statistics
==================
Words: ${document.getElementById('statWords').textContent}
Characters: ${document.getElementById('statChars').textContent}
Sentences: ${document.getElementById('statSentences').textContent}
Paragraphs: ${document.getElementById('statParagraphs').textContent}

Reading Time Estimates
---------------------
Average Reader (~200 wpm): ${document.getElementById('statReadAvg').textContent}
Fast Reader (~300 wpm): ${document.getElementById('statReadFast').textContent}
Speaking Time (~150 wpm): ${document.getElementById('statSpeak').textContent}

Readability
-----------
Average Word Length: ${document.getElementById('statAvgWordLen').textContent}
Average Sentence Length: ${document.getElementById('statAvgSentLen').textContent}
Unique Words: ${document.getElementById('statUniqueWords').textContent}`;

      navigator.clipboard.writeText(stats).then(() => {
        showToast('Statistics copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy statistics', 'error');
      });
    }

    // Change Case functionality
    let changeCaseMenu = null;

    function showChangeCaseMenu(event) {
      event.stopPropagation();

      // Remove existing menu if any
      if (changeCaseMenu) {
        changeCaseMenu.remove();
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      changeCaseMenu = document.createElement('div');
      changeCaseMenu.className = 'change-case-menu';
      changeCaseMenu.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        min-width: 180px;
      `;

      changeCaseMenu.innerHTML = `
        <div style="padding: 8px 16px; cursor: pointer; hover:background:#f5f5f5;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('sentence')">Sentence case</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('lower')">lowercase</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('upper')">UPPERCASE</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('title')">Title Case</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('toggle')">tOGGLE cASE</div>
      `;

      document.body.appendChild(changeCaseMenu);

      // Close menu on click outside
      setTimeout(() => {
        document.addEventListener('click', closeChangeCaseMenu);
      }, 10);
    }

    function closeChangeCaseMenu() {
      if (changeCaseMenu) {
        changeCaseMenu.remove();
        changeCaseMenu = null;
      }
      document.removeEventListener('click', closeChangeCaseMenu);
    }

    function changeCase(type) {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        closeChangeCaseMenu();
        return;
      }

      const range = selection.getRangeAt(0);
      const text = selection.toString();
      let newText = '';

      switch (type) {
        case 'sentence':
          newText = text.toLowerCase().replace(/(^\s*\w|[.!?]\s*\w)/g, c => c.toUpperCase());
          break;
        case 'lower':
          newText = text.toLowerCase();
          break;
        case 'upper':
          newText = text.toUpperCase();
          break;
        case 'title':
          newText = text.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
          break;
        case 'toggle':
          newText = text.split('').map(c =>
            c === c.toUpperCase() ? c.toLowerCase() : c.toUpperCase()
          ).join('');
          break;
      }

      // Replace the selected text
      range.deleteContents();
      range.insertNode(document.createTextNode(newText));

      // Restore selection
      selection.removeAllRanges();
      selection.addRange(range);

      closeChangeCaseMenu();
      showToast(`Changed to ${type} case`, 'success');
    }

    // Clear Formatting
    function clearFormatting() {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        return;
      }

      // Use execCommand to remove formatting
      document.execCommand('removeFormat', false, null);

      // Also remove background color
      document.execCommand('hiliteColor', false, 'transparent');

      showToast('Formatting cleared', 'success');
    }

    // Highlight Color Palette
    let highlightPalette = null;

    const highlightColors = [
      { name: 'Yellow', color: '#ffff00' },
      { name: 'Bright Green', color: '#00ff00' },
      { name: 'Cyan', color: '#00ffff' },
      { name: 'Pink', color: '#ff00ff' },
      { name: 'Blue', color: '#0000ff' },
      { name: 'Red', color: '#ff0000' },
      { name: 'Dark Blue', color: '#000080' },
      { name: 'Teal', color: '#008080' },
      { name: 'Green', color: '#008000' },
      { name: 'Violet', color: '#800080' },
      { name: 'Dark Red', color: '#800000' },
      { name: 'Dark Yellow', color: '#808000' },
      { name: 'Gray 50%', color: '#808080' },
      { name: 'Gray 25%', color: '#c0c0c0' },
      { name: 'Orange', color: '#ff9900' },
      { name: 'No Color', color: 'transparent' }
    ];

    function showHighlightPalette(event) {
      event.stopPropagation();

      // Remove existing palette if any
      if (highlightPalette) {
        highlightPalette.remove();
        highlightPalette = null;
        return;
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      highlightPalette = document.createElement('div');
      highlightPalette.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
        width: 160px;
      `;

      highlightColors.forEach(item => {
        const swatch = document.createElement('div');
        swatch.style.cssText = `
          width: 32px;
          height: 24px;
          background: ${item.color === 'transparent' ? 'linear-gradient(45deg, #fff 45%, #ff0000 45%, #ff0000 55%, #fff 55%)' : item.color};
          border: 1px solid #999;
          border-radius: 3px;
          cursor: pointer;
        `;
        swatch.title = item.name;
        swatch.onclick = () => {
          applyHighlight(item.color);
          highlightPalette.remove();
          highlightPalette = null;
        };
        highlightPalette.appendChild(swatch);
      });

      document.body.appendChild(highlightPalette);

      // Close on click outside
      setTimeout(() => {
        document.addEventListener('click', closeHighlightPalette);
      }, 10);
    }

    function closeHighlightPalette(e) {
      if (highlightPalette && !highlightPalette.contains(e.target)) {
        highlightPalette.remove();
        highlightPalette = null;
        document.removeEventListener('click', closeHighlightPalette);
      }
    }

    function applyHighlight(color) {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        return;
      }

      document.execCommand('hiliteColor', false, color);
      showToast(color === 'transparent' ? 'Highlight removed' : 'Highlight applied', 'success');
    }
  </script>
</body>
</html>
