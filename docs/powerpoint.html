<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="theme-color" content="#d24726">
  <meta name="description" content="NinjaSlides - Create stunning presentations with animations, transitions and templates">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>NinjaSlides - Presentations</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/officeninja.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.bundle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    .slide-canvas {
      position: relative;
      overflow: hidden;
    }
    .slide-element {
      position: absolute;
      cursor: move;
      user-select: none;
    }
    .slide-element:hover {
      outline: 1px dashed #1a73e8;
    }
    .slide-element.selected {
      outline: 2px solid #1a73e8;
    }
    .slide-element.multi-selected {
      outline: 2px dashed #ff9800;
      background: rgba(255, 152, 0, 0.1) !important;
    }
    .slide-element.locked {
      cursor: not-allowed !important;
    }
    .slide-element.locked::after {
      content: 'ðŸ”’';
      position: absolute;
      top: -18px;
      right: 2px;
      font-size: 12px;
      background: rgba(255,255,255,0.9);
      padding: 1px 4px;
      border-radius: 3px;
    }
    .slide-element.editing {
      cursor: text;
    }
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #1a73e8;
      border: 2px solid white;
      border-radius: 50%;
    }
    .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
    .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
    .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
    .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

    .transition-preview {
      width: 120px;
      height: 68px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .transition-preview:hover {
      transform: scale(1.05);
    }
    .transition-preview.selected {
      border-color: #1a73e8;
    }

    .animation-timeline {
      background: #1e1e1e;
      padding: 1rem;
      border-top: 1px solid var(--border);
    }
    .timeline-track {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #2d2d2d;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    .timeline-item {
      background: #4285f4;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      color: white;
    }

    .slide-thumbnail-inner {
      width: 100%;
      height: 100%;
      padding: 8px;
      font-size: 6px;
      overflow: hidden;
      background: white;
    }

    .template-slide {
      aspect-ratio: 16/9;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      padding: 0.5rem;
    }
    .template-slide:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Fullscreen presenter mode */
    .fullscreen-presenter {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fullscreen-slide {
      background: white;
      width: 100%;
      max-width: 1920px;
      aspect-ratio: 16/9;
      position: relative;
    }

    /* Laser Pointer */
    .laser-pointer {
      position: fixed;
      width: 12px;
      height: 12px;
      background: radial-gradient(circle, #ff0000 0%, #ff0000 40%, rgba(255,0,0,0.5) 60%, transparent 100%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 100000;
      display: none;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px 3px rgba(255, 0, 0, 0.6);
    }
    .laser-pointer.active {
      display: block;
    }
    .laser-pointer.green {
      background: radial-gradient(circle, #00ff00 0%, #00ff00 40%, rgba(0,255,0,0.5) 60%, transparent 100%);
      box-shadow: 0 0 10px 3px rgba(0, 255, 0, 0.6);
    }
    .laser-pointer.blue {
      background: radial-gradient(circle, #0066ff 0%, #0066ff 40%, rgba(0,102,255,0.5) 60%, transparent 100%);
      box-shadow: 0 0 10px 3px rgba(0, 102, 255, 0.6);
    }
    .slideshow-toolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      padding: 8px 16px;
      display: flex;
      gap: 10px;
      z-index: 100001;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .slideshow-toolbar:hover, .slideshow-toolbar.visible {
      opacity: 1;
    }
    .slideshow-toolbar button {
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
    }
    .slideshow-toolbar button:hover {
      background: rgba(255,255,255,0.2);
    }
    .slideshow-toolbar button.active {
      background: rgba(255,255,255,0.3);
    }

    /* Media elements */
    .media-container {
      position: relative;
    }
    .media-container video,
    .media-container audio {
      max-width: 100%;
    }

    /* Find bar */
    .find-bar {
      display: none;
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      flex-direction: column;
      gap: 10px;
      min-width: 320px;
    }
    .find-bar.show {
      display: flex;
    }
    .find-bar .find-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .find-bar input {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      flex: 1;
    }
    .find-bar button {
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .find-bar .close-btn {
      background: transparent;
      color: var(--secondary);
      font-size: 18px;
      padding: 4px 8px;
    }
    .find-bar .nav-btn {
      background: var(--light);
      color: var(--dark);
      padding: 4px 10px;
    }
    .find-bar .replace-btn {
      background: #4caf50;
    }
    .find-bar .replace-all-btn {
      background: #ff9800;
    }
    .find-results {
      font-size: 12px;
      color: var(--secondary);
      min-width: 60px;
    }
    .highlight-find {
      background: #ffeb3b;
      padding: 2px;
      border-radius: 2px;
    }

    /* Grid and Guides */
    .slide-canvas.show-grid {
      background-image:
        linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .slide-canvas.show-guides::before,
    .slide-canvas.show-guides::after {
      content: '';
      position: absolute;
      background: #1a73e8;
      z-index: 100;
      pointer-events: none;
    }
    .slide-canvas.show-guides::before {
      width: 1px;
      height: 100%;
      left: 50%;
      top: 0;
    }
    .slide-canvas.show-guides::after {
      height: 1px;
      width: 100%;
      top: 50%;
      left: 0;
    }
    .slide-rulers {
      display: none;
    }
    .slide-rulers.show {
      display: block;
    }
    .ruler-h {
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
      font-size: 9px;
      display: flex;
    }
    .ruler-v {
      position: absolute;
      left: -20px;
      top: 0;
      bottom: 0;
      width: 20px;
      background: #f5f5f5;
      border-right: 1px solid #ccc;
      font-size: 9px;
    }
    .sorter-slide {
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      aspect-ratio: 16/9;
      overflow: hidden;
      position: relative;
      transition: all 0.2s;
    }
    .sorter-slide:hover {
      border-color: #1a73e8;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .sorter-slide.selected {
      border-color: #1a73e8;
      border-width: 3px;
    }
    .sorter-slide-num {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Zoom controls */
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      border-left: 1px solid var(--border);
      margin-left: auto;
    }
    .zoom-controls button {
      padding: 4px 10px;
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }
    .zoom-controls button:hover {
      background: var(--border);
    }
    .zoom-controls select {
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    /* Undo/Redo buttons */
    .history-controls {
      display: flex;
      gap: 4px;
      padding: 0 8px;
      border-right: 1px solid var(--border);
      margin-right: 8px;
    }
    .history-controls button {
      padding: 6px 10px;
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .history-controls button:hover:not(:disabled) {
      background: var(--border);
    }
    .history-controls button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* SmartArt Styles */
    .smartart-category {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    .smartart-category:hover {
      background: var(--light);
    }
    .smartart-category.active {
      background: var(--primary);
      color: white;
    }
    .smartart-category:last-child {
      border-bottom: none;
    }
    .smartart-item {
      aspect-ratio: 16/10;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9f9f9;
      padding: 8px;
      transition: all 0.2s;
    }
    .smartart-item:hover {
      border-color: var(--primary);
      transform: scale(1.02);
    }
    .smartart-item.selected {
      border-color: var(--primary);
      border-width: 3px;
      background: #e3f2fd;
    }
    .smartart-item svg {
      max-width: 100%;
      max-height: 100%;
    }

    /* Custom Shows Styles */
    .custom-show-item {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .custom-show-item:hover {
      background: var(--light);
    }
    .custom-show-item.selected {
      border-color: var(--primary);
      background: #e3f2fd;
    }
    .slide-list-item {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }
    .slide-list-item:hover {
      background: var(--light);
    }
    .slide-list-item.selected {
      background: #e3f2fd;
      border-color: var(--primary);
    }
    .slide-list-item input[type="checkbox"] {
      margin: 0;
    }

    /* Zoom Thumbnails */
    .zoom-slide-thumb {
      aspect-ratio: 16/9;
      border: 2px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      background: white;
      transition: all 0.2s;
    }
    .zoom-slide-thumb:hover {
      border-color: var(--primary);
      transform: scale(1.02);
    }
    .zoom-slide-thumb.selected {
      border-color: var(--primary);
      border-width: 3px;
    }
    .zoom-slide-thumb .slide-num {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
    }
    .zoom-slide-thumb .check-mark {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .zoom-slide-thumb.selected .check-mark {
      display: flex;
    }

    /* Design Ideas */
    .design-idea-card {
      aspect-ratio: 16/9;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      transition: all 0.2s;
    }
    .design-idea-card:hover {
      border-color: var(--primary);
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .design-idea-card .idea-preview {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
    }
    .design-idea-card .idea-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 11px;
      padding: 4px 8px;
      text-align: center;
    }

    /* Slide Zoom Element */
    .slide-zoom-element {
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      overflow: hidden;
    }
    .slide-zoom-element:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .slide-zoom-element.border-thin {
      border: 2px solid #1a73e8;
    }
    .slide-zoom-element.border-thick {
      border: 4px solid #1a73e8;
    }
    .slide-zoom-element.border-shadow {
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    /* Drawing/Ink Tools Styles */
    .draw-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
    .draw-canvas.active {
      pointer-events: auto;
      cursor: crosshair;
    }
    .draw-canvas.eraser {
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Crect fill='%23fff' stroke='%23000' x='2' y='2' width='20' height='20' rx='2'/%3E%3C/svg%3E") 12 12, auto;
    }
    .draw-tool-btn.active {
      background: #e8f0fe !important;
      border-color: #1a73e8 !important;
      color: #1a73e8 !important;
    }
    .ink-color {
      width: 24px !important;
      height: 24px !important;
      min-width: 24px !important;
      border-radius: 50% !important;
      padding: 0 !important;
      border: 2px solid white !important;
      box-shadow: 0 0 0 1px #ccc;
    }
    .ink-color:hover {
      transform: scale(1.1);
    }
    #drawModeBtn.active {
      background: #34a853 !important;
      color: white !important;
    }
    /* Keyboard Shortcuts Styles */
    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    .shortcuts-section h4 {
      margin: 0 0 0.75rem 0;
      color: #1a73e8;
      font-size: 0.95rem;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 0.5rem;
    }
    .shortcut-item {
      display: flex;
      align-items: center;
      padding: 0.4rem 0;
      font-size: 0.85rem;
    }
    .shortcut-item kbd {
      background: #f1f3f4;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      margin: 0 0.25rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .shortcut-item span {
      margin-left: auto;
      color: #666;
    }
    body.dark-mode .shortcuts-section h4 {
      color: #4da3ff;
      border-color: #3c3c3c;
    }
    body.dark-mode .shortcut-item kbd {
      background: #3c3c3c;
      border-color: #505050;
      color: #ccc;
    }
    body.dark-mode .shortcut-item span { color: #999; }
    /* Submenu styles */
    .submenu-parent { position: relative; }
    .submenu {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 220px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1001;
    }
    .submenu.show { display: block; }
    .submenu-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .submenu-item:hover { background: #f0f0f0; }
    .submenu-item .file-date { font-size: 0.75rem; color: #888; }
    .submenu-empty { padding: 12px; color: #888; font-style: italic; text-align: center; }
    body.dark-mode .submenu { background: #2d2d2d; border-color: #444; }
    body.dark-mode .submenu-item:hover { background: #3c3c3c; }
    /* Speaker View Styles */
    .speaker-view {
      position: fixed;
      inset: 0;
      background: #1e1e1e;
      z-index: 3000;
      display: none;
      padding: 1rem;
    }
    .speaker-view.visible { display: grid; }
    .speaker-view-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: auto 1fr auto;
      gap: 1rem;
      height: 100%;
    }
    .sv-header {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      background: #2d2d2d;
      border-radius: 8px;
      color: white;
    }
    .sv-timer {
      font-size: 2rem;
      font-weight: bold;
      font-family: monospace;
    }
    .sv-current-slide {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .sv-current-slide h4 { color: #4da3ff; margin: 0 0 0.5rem 0; }
    .sv-slide-preview {
      flex: 1;
      background: white;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .sv-right-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .sv-next-slide {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 1rem;
      flex: 1;
    }
    .sv-next-slide h4 { color: #999; margin: 0 0 0.5rem 0; font-size: 0.85rem; }
    .sv-next-preview {
      background: white;
      border-radius: 4px;
      aspect-ratio: 16/9;
      overflow: hidden;
      position: relative;
    }
    .sv-notes {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 1rem;
      flex: 1;
      overflow-y: auto;
    }
    .sv-notes h4 { color: #4da3ff; margin: 0 0 0.5rem 0; }
    .sv-notes-content {
      color: #e0e0e0;
      font-size: 1.1rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .sv-controls {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.5rem;
    }
    .sv-controls button {
      padding: 0.75rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .sv-btn-nav { background: #4285f4; color: white; }
    .sv-btn-nav:hover { background: #3367d6; }
    .sv-btn-end { background: #ea4335; color: white; }
    .sv-btn-end:hover { background: #c5221f; }
    /* Dark Mode */
    body.dark-mode {
      background: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .app-container {
      background: #1e1e1e;
    }
    body.dark-mode .app-header {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .ribbon {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .ribbon-tab {
      color: #cccccc;
    }
    body.dark-mode .ribbon-tab.active {
      background: #3c3c3c;
      color: #ffffff;
    }
    body.dark-mode .toolbar {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .toolbar-btn {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .toolbar-btn:hover {
      background: #505050;
      color: #ffffff;
    }
    body.dark-mode .toolbar-select {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .ppt-container {
      background: #1e1e1e;
    }
    body.dark-mode .slide-panel {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .slide-thumbnail {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .slide-thumbnail.active {
      border-color: #1a73e8;
    }
    body.dark-mode .slide-canvas-container {
      background: #1e1e1e;
    }
    body.dark-mode .notes-panel {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .notes-panel textarea {
      background: #1e1e1e;
      color: #e0e0e0;
      border-color: #3c3c3c;
    }
    body.dark-mode .status-bar {
      background: #d24726;
      color: #ffffff;
    }
    body.dark-mode .dropdown-menu {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .dropdown-item {
      color: #cccccc;
    }
    body.dark-mode .dropdown-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .file-name {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .modal-content {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    body.dark-mode .modal-content input,
    body.dark-mode .modal-content select,
    body.dark-mode .modal-content textarea {
      background: #3c3c3c;
      color: #e0e0e0;
      border-color: #505050;
    }
    body.dark-mode .toast {
      background: #3c3c3c;
      color: #e0e0e0;
    }
    body.dark-mode .shape-panel {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .properties-panel {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .smartart-category,
    body.dark-mode .smartart-layout {
      background: #3c3c3c;
      border-color: #505050;
      color: #cccccc;
    }
    body.dark-mode .smartart-category:hover,
    body.dark-mode .smartart-layout:hover {
      background: #505050;
    }
    body.dark-mode .zoom-slide-item {
      background: #3c3c3c;
      border-color: #505050;
    }
    body.dark-mode .design-idea-card {
      background: #3c3c3c;
      border-color: #505050;
    }
    /* Quick Access Toolbar */
    .quick-access-toolbar {
      background: #f0f0f0;
      padding: 2px 8px;
      display: flex;
      align-items: center;
      gap: 2px;
      border-bottom: 1px solid #ddd;
      font-size: 0.75rem;
    }
    .quick-access-toolbar .qat-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 3px;
      font-size: 14px;
      opacity: 0.8;
    }
    .quick-access-toolbar .qat-btn:hover {
      background: #e0e0e0;
      opacity: 1;
    }
    .quick-access-toolbar .qat-separator {
      width: 1px;
      height: 16px;
      background: #ccc;
      margin: 0 4px;
    }
    .quick-access-toolbar .qat-customize {
      margin-left: auto;
      font-size: 10px;
      color: #666;
    }
    body.dark-mode .quick-access-toolbar {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .quick-access-toolbar .qat-btn:hover {
      background: #3c3c3c;
    }
    .qat-modal-items {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.5rem;
    }
    .qat-modal-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .qat-modal-item:hover {
      background: #e8f0fe;
    }
    /* Context Menu Styles */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 50000;
      display: none;
      padding: 6px 0;
      animation: contextMenuIn 0.12s ease-out;
    }
    @keyframes contextMenuIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .context-menu.visible { display: block; }
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      transition: background 0.1s;
    }
    .context-menu-item:hover { background: #e8f0fe; }
    .context-menu-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .context-menu-item-icon {
      width: 20px;
      text-align: center;
    }
    .context-menu-item-shortcut {
      margin-left: auto;
      color: #888;
      font-size: 11px;
    }
    .context-menu-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 6px 0;
    }
    body.dark-mode .context-menu {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .context-menu-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .context-menu-item {
      color: #e0e0e0;
    }
    body.dark-mode .context-menu-divider {
      background: #3c3c3c;
    }
    /* Drag & Drop Overlay */
    .drop-overlay {
      position: fixed;
      inset: 0;
      background: rgba(26, 115, 232, 0.9);
      z-index: 100000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1rem;
    }
    .drop-overlay.visible { display: flex; }
    .drop-overlay-icon {
      font-size: 80px;
      animation: dropBounce 0.5s ease infinite alternate;
    }
    @keyframes dropBounce {
      from { transform: translateY(0); }
      to { transform: translateY(-10px); }
    }
    .drop-overlay-text { font-size: 24px; color: white; font-weight: 500; }
    .drop-overlay-subtext { font-size: 14px; color: rgba(255,255,255,0.8); }
    /* Auto-save indicator */
    .autosave-indicator {
      position: fixed;
      bottom: 40px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 10000;
    }
    .autosave-indicator.visible { display: flex; }
    .autosave-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Global Search Spotlight */
    .spotlight-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100000;
      display: none;
      justify-content: center;
      padding-top: 15vh;
    }
    .spotlight-overlay.visible { display: flex; }
    .spotlight-container {
      width: 600px;
      max-width: 90vw;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.3);
      overflow: hidden;
      animation: spotlightIn 0.2s ease-out;
      max-height: 60vh;
      display: flex;
      flex-direction: column;
    }
    @keyframes spotlightIn {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .spotlight-input-wrapper {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .spotlight-search-icon { font-size: 20px; color: #666; }
    .spotlight-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 18px;
      background: transparent;
    }
    .spotlight-results {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .spotlight-section-title {
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: #666;
      letter-spacing: 0.5px;
    }
    .spotlight-item {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.1s;
    }
    .spotlight-item:hover, .spotlight-item.selected { background: #e8f0fe; }
    .spotlight-item-icon { font-size: 18px; width: 24px; text-align: center; }
    .spotlight-item-content { flex: 1; }
    .spotlight-item-title { font-size: 14px; font-weight: 500; }
    .spotlight-item-desc { font-size: 12px; color: #666; }
    .spotlight-item-shortcut {
      font-size: 11px;
      color: #888;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
    }
    .spotlight-footer {
      padding: 10px 16px;
      background: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 16px;
      font-size: 11px;
      color: #666;
    }
    body.dark-mode .spotlight-container { background: #2d2d2d; }
    body.dark-mode .spotlight-input-wrapper { border-color: #444; }
    body.dark-mode .spotlight-input { color: #e0e0e0; }
    body.dark-mode .spotlight-section-title { color: #888; }
    body.dark-mode .spotlight-item:hover, body.dark-mode .spotlight-item.selected { background: #3c3c3c; }
    body.dark-mode .spotlight-item-desc { color: #999; }
    body.dark-mode .spotlight-footer { background: #252525; border-color: #444; }
    /* Floating Action Button */
    .fab-container {
      position: fixed;
      bottom: 80px;
      right: 30px;
      z-index: 9999;
    }
    .fab-main {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #d93025;
      color: white;
      border: none;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(217, 48, 37, 0.4);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fab-main:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(217, 48, 37, 0.5);
    }
    .fab-main.active {
      transform: rotate(45deg);
      background: #666;
    }
    .fab-menu {
      position: absolute;
      bottom: 70px;
      right: 0;
      display: none;
      flex-direction: column;
      gap: 12px;
    }
    .fab-menu.visible { display: flex; }
    .fab-item {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-end;
      animation: fabItemIn 0.2s ease-out backwards;
    }
    .fab-item:nth-child(1) { animation-delay: 0.05s; }
    .fab-item:nth-child(2) { animation-delay: 0.1s; }
    .fab-item:nth-child(3) { animation-delay: 0.15s; }
    .fab-item:nth-child(4) { animation-delay: 0.2s; }
    .fab-item:nth-child(5) { animation-delay: 0.25s; }
    @keyframes fabItemIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fab-item-label {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
      white-space: nowrap;
    }
    .fab-item-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: transform 0.2s;
    }
    .fab-item-btn:hover { transform: scale(1.1); }
    /* Interactive Status Bar */
    .status-bar-item {
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 4px;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .status-bar-item:hover {
      background: rgba(217, 48, 37, 0.1);
      color: #d93025;
    }
    .status-bar-item:active { transform: scale(0.98); }
    .status-bar-item .status-icon { font-size: 12px; }
    body.dark-mode .status-bar-item:hover {
      background: rgba(242, 139, 130, 0.15);
      color: #f28b82;
    }
    /* Zoom Popup */
    .zoom-popup {
      position: fixed;
      bottom: 40px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 16px;
      z-index: 10001;
      display: none;
      flex-direction: column;
      gap: 12px;
      min-width: 220px;
      animation: popupSlideUp 0.2s ease-out;
    }
    .zoom-popup.visible { display: flex; }
    @keyframes popupSlideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .zoom-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
    }
    .zoom-popup-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
    }
    .zoom-slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .zoom-slider {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      background: #e0e0e0;
      border-radius: 2px;
      outline: none;
    }
    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #d93025;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .zoom-presets {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .zoom-preset-btn {
      padding: 4px 10px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.15s;
    }
    .zoom-preset-btn:hover { background: #fce8e6; border-color: #d93025; color: #d93025; }
    .zoom-preset-btn.active { background: #d93025; color: white; border-color: #d93025; }
    body.dark-mode .zoom-popup { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .zoom-slider { background: #444; }
    body.dark-mode .zoom-preset-btn { background: #3c3c3c; border-color: #555; color: #e0e0e0; }
    body.dark-mode .zoom-preset-btn:hover { background: #4a4a4a; border-color: #f28b82; color: #f28b82; }
    /* Transition Popup */
    .transition-popup {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 12px;
      z-index: 10001;
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 200px;
      animation: popupSlideUp 0.2s ease-out;
    }
    .transition-popup.visible { display: flex; }
    .transition-popup-header {
      font-weight: 600;
      font-size: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .transition-option {
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }
    .transition-option:hover { background: #f0f0f0; }
    .transition-option.active { background: #fce8e6; color: #d93025; }
    body.dark-mode .transition-popup { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .transition-popup-header { border-color: #444; }
    body.dark-mode .transition-option:hover { background: #3c3c3c; }
    body.dark-mode .transition-option.active { background: rgba(242, 139, 130, 0.15); color: #f28b82; }

    /* Welcome Modal */
    .welcome-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 100001;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }
    .welcome-modal.visible { display: flex; }
    .welcome-container {
      width: 550px;
      max-width: 90vw;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: welcomeSlide 0.4s ease;
    }
    @keyframes welcomeSlide {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .welcome-header {
      background: linear-gradient(135deg, #d93025, #ea4335);
      color: white;
      padding: 32px;
      text-align: center;
    }
    .welcome-header h2 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .welcome-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 16px;
    }
    .welcome-tips {
      padding: 24px 32px;
    }
    .welcome-tip {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .welcome-tip:last-child { border-bottom: none; }
    .welcome-tip-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #fce8e6, #fff);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .welcome-tip-content h4 {
      margin: 0 0 4px 0;
      font-size: 15px;
      font-weight: 600;
      color: #333;
    }
    .welcome-tip-content p {
      margin: 0;
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }
    .welcome-footer {
      padding: 20px 32px;
      background: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .welcome-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #666;
      cursor: pointer;
    }
    .welcome-checkbox input { cursor: pointer; }
    .welcome-btn {
      background: linear-gradient(135deg, #d93025, #ea4335);
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .welcome-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(217, 48, 37, 0.3);
    }
    body.dark-mode .welcome-container { background: #2d2d2d; }
    body.dark-mode .welcome-tips { background: #2d2d2d; }
    body.dark-mode .welcome-tip { border-color: #444; }
    body.dark-mode .welcome-tip-icon { background: linear-gradient(135deg, rgba(217, 48, 37, 0.2), rgba(217, 48, 37, 0.1)); }
    body.dark-mode .welcome-tip-content h4 { color: #e0e0e0; }
    body.dark-mode .welcome-tip-content p { color: #aaa; }
    body.dark-mode .welcome-footer { background: #252525; }
    body.dark-mode .welcome-checkbox { color: #aaa; }

    /* Laser Pointer Mode */
    .laser-pointer-active {
      cursor: none !important;
    }
    .laser-pointer-active * {
      cursor: none !important;
    }
    .laser-dot {
      position: fixed;
      width: 12px;
      height: 12px;
      background: radial-gradient(circle, #ff0000 0%, #ff0000 40%, rgba(255, 0, 0, 0.6) 60%, transparent 100%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 100000;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px 4px rgba(255, 0, 0, 0.5), 0 0 20px 8px rgba(255, 0, 0, 0.3);
      display: none;
      animation: laserPulse 0.8s ease-in-out infinite;
    }
    .laser-dot.visible {
      display: block;
    }
    @keyframes laserPulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
    }
    .laser-trail {
      position: fixed;
      width: 6px;
      height: 6px;
      background: rgba(255, 0, 0, 0.4);
      border-radius: 50%;
      pointer-events: none;
      z-index: 99999;
      animation: laserTrailFade 0.5s ease-out forwards;
    }
    @keyframes laserTrailFade {
      from { opacity: 0.6; transform: scale(1); }
      to { opacity: 0; transform: scale(0.3); }
    }
    .laser-indicator {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #ff4444;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      z-index: 100001;
      display: none;
      align-items: center;
      gap: 8px;
    }
    .laser-indicator.visible {
      display: flex;
    }
    .laser-indicator-dot {
      width: 8px;
      height: 8px;
      background: #ff0000;
      border-radius: 50%;
      animation: laserPulse 0.8s ease-in-out infinite;
    }

    /* Slide Timer */
    .slide-timer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      font-size: 1.5rem;
      z-index: 100001;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 120px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .slide-timer.visible {
      display: flex;
    }
    .slide-timer-label {
      font-size: 0.7rem;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .slide-timer-time {
      font-weight: 600;
    }
    .slide-timer-time.warning {
      color: #ffc107;
    }
    .slide-timer-time.danger {
      color: #ff4444;
      animation: timerBlink 1s infinite;
    }
    @keyframes timerBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .slide-timer-controls {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .slide-timer-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .slide-timer-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Quick Shapes Toolbar */
    .quick-shapes-bar {
      position: fixed;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: white;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 4px;
      z-index: 1000;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .quick-shapes-bar.visible {
      display: flex;
    }
    .quick-shape-btn {
      width: 36px;
      height: 36px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.15s;
    }
    .quick-shape-btn:hover {
      background: #f1f3f4;
      border-color: #1a73e8;
    }
    .quick-shape-btn.active {
      background: #e8f0fe;
      border-color: #1a73e8;
      color: #1a73e8;
    }
    .quick-shapes-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 4px 0;
    }
    body.dark-mode .quick-shapes-bar {
      background: #292a2d;
      border-color: #3c4043;
    }
    body.dark-mode .quick-shape-btn {
      background: #292a2d;
      border-color: #3c4043;
      color: #e8eaed;
    }
    body.dark-mode .quick-shape-btn:hover {
      background: #3c4043;
    }
    body.dark-mode .quick-shapes-divider {
      background: #3c4043;
    }

    /* Enhanced Drawing Tools */
    .draw-shape-btn {
      min-width: 36px;
      height: 32px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: all 0.15s;
    }
    .draw-shape-btn:hover {
      background: #f1f3f4;
      border-color: #1a73e8;
    }
    .draw-shape-btn.active {
      background: #e8f0fe;
      border-color: #1a73e8;
      color: #1a73e8;
    }
    body.dark-mode .draw-shape-btn {
      background: #292a2d;
      border-color: #3c4043;
      color: #e8eaed;
    }
    body.dark-mode .draw-shape-btn:hover {
      background: #3c4043;
    }
    body.dark-mode .draw-shape-btn.active {
      background: #394457;
      border-color: #8ab4f8;
      color: #8ab4f8;
    }

    /* Drawing Mode Panel */
    .draw-mode-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      width: 400px;
      max-height: 80vh;
      z-index: 100003;
      display: none;
      overflow: hidden;
    }
    .draw-mode-panel.visible {
      display: block;
    }
    .draw-mode-panel-header {
      background: linear-gradient(135deg, #d93025, #ea4335);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .draw-mode-panel-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .draw-mode-panel-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .draw-mode-panel-close:hover {
      background: rgba(255,255,255,0.3);
    }
    .draw-mode-panel-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .draw-tool-section {
      margin-bottom: 20px;
    }
    .draw-tool-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #5f6368;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .draw-tool-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }
    .draw-tool-item {
      width: 52px;
      height: 52px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      transition: all 0.15s;
    }
    .draw-tool-item:hover {
      background: #f8f9fa;
      border-color: #1a73e8;
    }
    .draw-tool-item.active {
      background: #e8f0fe;
      border-color: #1a73e8;
    }
    .draw-tool-item-icon {
      font-size: 1.3rem;
    }
    .draw-tool-item-label {
      font-size: 0.65rem;
      color: #5f6368;
    }
    body.dark-mode .draw-mode-panel {
      background: #292a2d;
    }
    body.dark-mode .draw-tool-section-title {
      color: #9aa0a6;
    }
    body.dark-mode .draw-tool-item {
      background: #292a2d;
      border-color: #3c4043;
    }
    body.dark-mode .draw-tool-item:hover {
      background: #3c4043;
      border-color: #8ab4f8;
    }
    body.dark-mode .draw-tool-item.active {
      background: #394457;
      border-color: #8ab4f8;
    }
    body.dark-mode .draw-tool-item-label {
      color: #9aa0a6;
    }

    /* Brush Styles Popup */
    .brush-styles-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .brush-style-btn {
      flex: 1;
      padding: 8px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .brush-style-btn:hover {
      background: #f8f9fa;
      border-color: #1a73e8;
    }
    .brush-style-btn.active {
      background: #e8f0fe;
      border-color: #1a73e8;
    }
    .brush-preview {
      width: 100%;
      height: 12px;
      background: currentColor;
      border-radius: 2px;
    }
    .brush-preview.dotted {
      background: repeating-linear-gradient(90deg, currentColor 0px, currentColor 4px, transparent 4px, transparent 8px);
    }
    .brush-preview.dashed {
      background: repeating-linear-gradient(90deg, currentColor 0px, currentColor 10px, transparent 10px, transparent 16px);
    }
    .brush-preview.soft {
      background: linear-gradient(90deg, rgba(0,0,0,0.1), currentColor, rgba(0,0,0,0.1));
      filter: blur(1px);
    }
    body.dark-mode .brush-style-btn {
      background: #292a2d;
      border-color: #3c4043;
    }
    body.dark-mode .brush-style-btn:hover {
      background: #3c4043;
    }
    body.dark-mode .brush-style-btn.active {
      background: #394457;
      border-color: #8ab4f8;
    }

    /* Fill Toggle */
    .fill-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-top: 10px;
    }
    .fill-toggle-label {
      font-size: 0.85rem;
      color: #5f6368;
    }
    .fill-toggle-switch {
      position: relative;
      width: 40px;
      height: 22px;
    }
    .fill-toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .fill-toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #ccc;
      border-radius: 22px;
      transition: 0.2s;
    }
    .fill-toggle-slider::before {
      position: absolute;
      content: '';
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.2s;
    }
    .fill-toggle-switch input:checked + .fill-toggle-slider {
      background: #1a73e8;
    }
    .fill-toggle-switch input:checked + .fill-toggle-slider::before {
      transform: translateX(18px);
    }
    body.dark-mode .fill-toggle {
      background: #3c4043;
    }
    body.dark-mode .fill-toggle-label {
      color: #9aa0a6;
    }

    /* Shape Preview Canvas */
    .shape-preview-canvas {
      width: 100%;
      height: 80px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-top: 12px;
    }
    body.dark-mode .shape-preview-canvas {
      background: #202124;
      border-color: #3c4043;
    }

    /* Drawing Canvas Enhanced Cursors */
    .drawing-canvas.shape-line {
      cursor: crosshair;
    }
    .drawing-canvas.shape-arrow {
      cursor: crosshair;
    }
    .drawing-canvas.shape-rect {
      cursor: crosshair;
    }
    .drawing-canvas.shape-ellipse {
      cursor: crosshair;
    }
    .drawing-canvas.shape-triangle {
      cursor: crosshair;
    }
    .drawing-canvas.eyedropper {
      cursor: crosshair;
    }
    .drawing-canvas.text-annotation {
      cursor: text;
    }

    /* Line Assist Indicator */
    .line-assist-indicator {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #4285f4;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      z-index: 100001;
      display: none;
      align-items: center;
      gap: 8px;
    }
    .line-assist-indicator.visible {
      display: flex;
    }
    .line-assist-indicator kbd {
      background: rgba(255,255,255,0.2);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: inherit;
    }

    /* Eyedropper Preview */
    .eyedropper-preview {
      position: fixed;
      width: 60px;
      height: 60px;
      border: 3px solid white;
      border-radius: 50%;
      pointer-events: none;
      z-index: 100002;
      display: none;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      transform: translate(-50%, -100%) translateY(-10px);
    }
    .eyedropper-preview.visible {
      display: block;
    }
    .eyedropper-preview::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid white;
    }

    /* Recent Colors */
    .recent-colors {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .recent-color {
      width: 24px;
      height: 24px;
      border: 2px solid #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .recent-color:hover {
      transform: scale(1.1);
      border-color: #1a73e8;
    }
    body.dark-mode .recent-color {
      border-color: #3c4043;
    }

    /* Opacity Slider */
    .opacity-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .opacity-control label {
      font-size: 0.85rem;
      color: #5f6368;
      min-width: 60px;
    }
    .opacity-control input[type="range"] {
      flex: 1;
    }
    .opacity-value {
      min-width: 40px;
      text-align: right;
      font-size: 0.85rem;
      color: #5f6368;
    }
    body.dark-mode .opacity-control label,
    body.dark-mode .opacity-value {
      color: #9aa0a6;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Quick Access Toolbar -->
    <div class="quick-access-toolbar" id="quickAccessToolbar">
      <button class="qat-btn" onclick="savePresentation()" title="Save (Ctrl+S)">ðŸ’¾</button>
      <button class="qat-btn" onclick="undo()" title="Undo (Ctrl+Z)">â†¶</button>
      <button class="qat-btn" onclick="redo()" title="Redo (Ctrl+Y)">â†·</button>
      <span class="qat-separator"></span>
      <button class="qat-btn" onclick="exportPDF()" title="Export PDF">ðŸ“„</button>
      <button class="qat-btn" onclick="startSlideshow()" title="Start Slideshow">â–¶ï¸</button>
      <button class="qat-btn qat-customize" onclick="showQATCustomization()" title="Customize Quick Access Toolbar">â–¼ Customize</button>
    </div>

    <!-- Header -->
    <div class="app-header">
      <a href="index.html" class="app-logo">
        <div class="app-logo-icon powerpoint">P</div>
        <span class="app-title">NinjaSlides</span>
      </a>
      <input type="text" class="file-name" id="fileName" value="Untitled Presentation">
      <div class="header-actions">
        <div class="dropdown">
          <button class="btn btn-secondary" onclick="toggleFileMenu()">ðŸ“ File â–¾</button>
          <div class="dropdown-menu" id="fileMenu">
            <div class="dropdown-item" onclick="newPresentation()">ðŸ“„ New</div>
            <div class="dropdown-item" onclick="showOpenDialog()">ðŸ“‚ Open...</div>
            <div class="dropdown-item" onclick="savePresentation()">ðŸ’¾ Save</div>
            <div class="dropdown-item" onclick="savePresentationAs()">ðŸ’¾ Save As...</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item submenu-parent" onclick="toggleRecentFiles(event)">
              ðŸ•’ Recent Files â–¸
              <div class="submenu" id="recentFilesMenu"></div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="exportToFile()">ðŸ“¤ Export as .njslides</div>
            <div class="dropdown-item" onclick="importFromFile()">ðŸ“¥ Import .njslides</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="exportPptx()">ðŸ“¤ Export as PPTX</div>
            <div class="dropdown-item" onclick="importPptx()">ðŸ“¥ Import PPTX</div>
            <div class="dropdown-item" onclick="exportHTML()">ðŸŒ Export as HTML</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="exportSpeakerNotes()">ðŸ“ Export Speaker Notes</div>
            <div class="dropdown-item" onclick="toggleFindBar()">ðŸ” Find (Ctrl+F)</div>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="showTemplates()">Templates</button>
        <button class="btn btn-secondary" onclick="showRecentPresentations()">ðŸ“‚ Recent</button>
        <button class="btn btn-secondary" onclick="showSlideMaster()">Slide Master</button>
        <button class="btn btn-secondary" onclick="startPresentation()">â–¶ Present</button>
        <button class="btn btn-secondary" onclick="showPresenterView()">Presenter View</button>
        <button class="btn btn-primary" onclick="exportPDF()">Export PDF</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tab-container">
      <button class="tab active" data-tab="home">Home</button>
      <button class="tab" data-tab="insert">Insert</button>
      <button class="tab" data-tab="draw">Draw</button>
      <button class="tab" data-tab="design">Design</button>
      <button class="tab" data-tab="transitions">Transitions</button>
      <button class="tab" data-tab="animations">Animations</button>
      <button class="tab" data-tab="view">View</button>
    </div>

    <!-- Home Toolbar -->
    <div class="toolbar" id="homeToolbar">
      <div class="history-controls">
        <button onclick="undo()" title="Undo (Ctrl+Z)" id="undoBtn" disabled>â†©</button>
        <button onclick="redo()" title="Redo (Ctrl+Y)" id="redoBtn" disabled>â†ª</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="addSlide()" title="New Slide">+ Slide</button>
        <button class="toolbar-btn" onclick="duplicateSlide()" title="Duplicate">âŽ˜</button>
        <button class="toolbar-btn" onclick="copySlide()" title="Copy Slide">ðŸ“‹</button>
        <button class="toolbar-btn" onclick="pasteSlide()" title="Paste Slide">ðŸ“„</button>
        <button class="toolbar-btn" onclick="moveSlideUp()" title="Move Slide Up">â¬†</button>
        <button class="toolbar-btn" onclick="moveSlideDown()" title="Move Slide Down">â¬‡</button>
        <button class="toolbar-btn" onclick="deleteSlide()" title="Delete Slide">ðŸ—‘</button>
        <button class="toolbar-btn" onclick="clearSlideElements()" title="Clear All Elements">ðŸ§¹</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="addText()" title="Add Text Box">T</button>
        <button class="toolbar-btn" onclick="showIconPicker()" title="Insert Icon/Emoji">ðŸ˜€</button>
        <button class="toolbar-btn" onclick="addShape('rectangle')" title="Rectangle">â–¢</button>
        <button class="toolbar-btn" onclick="addShape('circle')" title="Circle">â—‹</button>
        <button class="toolbar-btn" onclick="addShape('arrow')" title="Arrow">â†’</button>
      </div>
      <div class="toolbar-group">
        <select class="toolbar-select" id="fontFamily" onchange="formatText('fontFamily', this.value)">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Georgia">Georgia</option>
          <option value="Verdana">Verdana</option>
          <option value="Impact">Impact</option>
        </select>
        <select class="toolbar-select" id="fontSize" onchange="formatText('fontSize', this.value)">
          <option value="14">14</option>
          <option value="18">18</option>
          <option value="24" selected>24</option>
          <option value="32">32</option>
          <option value="48">48</option>
          <option value="64">64</option>
          <option value="72">72</option>
        </select>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatText('fontWeight', 'bold')" title="Bold"><b>B</b></button>
        <button class="toolbar-btn" onclick="formatText('fontStyle', 'italic')" title="Italic"><i>I</i></button>
        <button class="toolbar-btn" onclick="formatText('textDecoration', 'underline')" title="Underline"><u>U</u></button>
        <button class="toolbar-btn" onclick="formatText('textDecoration', 'line-through')" title="Strikethrough"><s>S</s></button>
        <button class="toolbar-btn" onclick="toggleTextShadow()" id="textShadowBtn" title="Text Shadow">ðŸ’« Shadow</button>
      </div>
      <div class="toolbar-group">
        <input type="color" class="color-picker-btn" id="textColor" value="#000000" onchange="formatText('color', this.value)" title="Text Color">
        <input type="color" class="color-picker-btn" id="fillColor" value="#4285f4" onchange="formatElement('background', this.value)" title="Fill Color">
        <button class="toolbar-btn" onclick="showGradientFill(event)" title="Gradient Fill">ðŸŒˆ Gradient</button>
        <select class="toolbar-select" id="elementOpacity" onchange="setElementOpacity(this.value)" title="Opacity" style="width: 70px;">
          <option value="1">100%</option>
          <option value="0.9">90%</option>
          <option value="0.8">80%</option>
          <option value="0.7">70%</option>
          <option value="0.6">60%</option>
          <option value="0.5">50%</option>
          <option value="0.4">40%</option>
          <option value="0.3">30%</option>
          <option value="0.2">20%</option>
          <option value="0.1">10%</option>
        </select>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="alignElement('left')" title="Align Left">âŠ£</button>
        <button class="toolbar-btn" onclick="alignElement('center')" title="Center Horizontally">âŠ¡</button>
        <button class="toolbar-btn" onclick="alignElement('right')" title="Align Right">âŠ¢</button>
        <button class="toolbar-btn" onclick="alignElement('top')" title="Align Top">âŠ¤</button>
        <button class="toolbar-btn" onclick="alignElement('middle')" title="Center Vertically">âŠž</button>
        <button class="toolbar-btn" onclick="alignElement('bottom')" title="Align Bottom">âŠ¥</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="distributeElements('horizontal')" title="Distribute Horizontally">â‡”</button>
        <button class="toolbar-btn" onclick="distributeElements('vertical')" title="Distribute Vertically">â‡•</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="bringToFront()" title="Bring to Front">â¤’</button>
        <button class="toolbar-btn" onclick="bringForward()" title="Bring Forward">â†‘</button>
        <button class="toolbar-btn" onclick="sendBackward()" title="Send Backward">â†“</button>
        <button class="toolbar-btn" onclick="sendToBack()" title="Send to Back">â¤“</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="copyElementStyle()" id="copyStyleBtn" title="Copy Style (Format Painter)">ðŸ–Œï¸ Copy Style</button>
        <button class="toolbar-btn" onclick="pasteElementStyle()" id="pasteStyleBtn" title="Paste Style" disabled>ðŸ“‹ Paste Style</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="groupSelectedElements()" title="Group Elements (Ctrl+G)">âŠž Group</button>
        <button class="toolbar-btn" onclick="ungroupElement()" title="Ungroup (Ctrl+Shift+G)">âŠŸ Ungroup</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleDictation()" title="Dictation (Voice Input)" id="dictationBtn">ðŸŽ¤ Dictate</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="flipElement('horizontal')" title="Flip Horizontal">â†”</button>
        <button class="toolbar-btn" onclick="flipElement('vertical')" title="Flip Vertical">â†•</button>
        <button class="toolbar-btn" onclick="rotateElement(90)" title="Rotate 90Â°">â†»</button>
        <button class="toolbar-btn" onclick="duplicateElement()" title="Duplicate Element">âŽ˜</button>
        <button class="toolbar-btn" id="shadowToggleBtn" onclick="toggleElementShadow()" title="Toggle Shadow">ðŸŒ‘ Shadow</button>
        <button class="toolbar-btn" onclick="showElementBorder(event)" title="Element Border">ðŸ”² Border</button>
        <button class="toolbar-btn" id="lockToggleBtn" onclick="toggleElementLock()" title="Lock/Unlock Element">ðŸ”’ Lock</button>
      </div>
      <div class="zoom-controls">
        <button onclick="zoomOut()" title="Zoom Out">âˆ’</button>
        <select id="zoomLevel" onchange="setZoom(this.value)">
          <option value="50">50%</option>
          <option value="75">75%</option>
          <option value="100" selected>100%</option>
          <option value="125">125%</option>
          <option value="150">150%</option>
          <option value="200">200%</option>
        </select>
        <button onclick="zoomIn()" title="Zoom In">+</button>
      </div>
    </div>

    <!-- Insert Toolbar -->
    <div class="toolbar" id="insertToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="addText()">ðŸ“ Text Box</button>
        <button class="toolbar-btn" onclick="insertImage()">ðŸ–¼ Image</button>
        <button class="toolbar-btn" onclick="showStockImages()">ðŸŒ Stock Images</button>
        <button class="toolbar-btn" onclick="showPhotoAlbum()">ðŸ“· Photo Album</button>
        <button class="toolbar-btn" onclick="showVideoControls()">ðŸŽ¬ Video</button>
        <button class="toolbar-btn" onclick="insertAudio()">ðŸ”Š Audio</button>
        <button class="toolbar-btn" onclick="showScreenRecording()">ðŸŽ¥ Screen Recording</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="addShape('rectangle')">â–¢ Rectangle</button>
        <button class="toolbar-btn" onclick="addShape('circle')">â—‹ Circle</button>
        <button class="toolbar-btn" onclick="addShape('triangle')">â–³ Triangle</button>
        <button class="toolbar-btn" onclick="addShape('arrow')">â†’ Arrow</button>
        <button class="toolbar-btn" onclick="addShape('star')">â˜† Star</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertTable()">âŠž Table</button>
        <button class="toolbar-btn" onclick="insertChart()">ðŸ“Š Chart</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertHyperlink()">ðŸ”— Hyperlink</button>
        <button class="toolbar-btn" onclick="showImageCrop()">âœ‚ Crop Image</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showActionButtons()">ðŸ”˜ Action Buttons</button>
        <button class="toolbar-btn" onclick="showSmartArt()">ðŸ”· SmartArt</button>
        <button class="toolbar-btn" onclick="showQRCodeGenerator()">â–£ QR Code</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showSummaryZoom()">ðŸ” Summary Zoom</button>
        <button class="toolbar-btn" onclick="showSlideZoom()">ðŸ–¼ Slide Zoom</button>
      </div>
    </div>

    <!-- Draw Toolbar -->
    <div class="toolbar" id="drawToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn draw-tool-btn active" id="penBtn" onclick="selectDrawTool('pen')" title="Pen">ðŸ–Š Pen</button>
        <button class="toolbar-btn draw-tool-btn" id="highlighterBtn" onclick="selectDrawTool('highlighter')" title="Highlighter">ðŸ–Œ Highlighter</button>
        <button class="toolbar-btn draw-tool-btn" id="eraserBtn" onclick="selectDrawTool('eraser')" title="Eraser">ðŸ§¹ Eraser</button>
        <button class="toolbar-btn draw-tool-btn" id="selectToolBtn" onclick="selectDrawTool('select')" title="Select">â¬š Select</button>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Shapes:</span>
        <button class="draw-shape-btn" id="lineBtn" onclick="selectDrawShape('line')" title="Line">â•±</button>
        <button class="draw-shape-btn" id="arrowBtn" onclick="selectDrawShape('arrow')" title="Arrow">â†’</button>
        <button class="draw-shape-btn" id="rectBtn" onclick="selectDrawShape('rect')" title="Rectangle">â–­</button>
        <button class="draw-shape-btn" id="ellipseBtn" onclick="selectDrawShape('ellipse')" title="Ellipse">â—¯</button>
        <button class="draw-shape-btn" id="triangleBtn" onclick="selectDrawShape('triangle')" title="Triangle">â–³</button>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Color:</span>
        <input type="color" class="color-picker-btn" id="drawColor" value="#000000" onchange="setDrawColor(this.value)" title="Ink Color">
        <button class="toolbar-btn ink-color" onclick="setDrawColor('#000000')" style="background: #000000;" title="Black"></button>
        <button class="toolbar-btn ink-color" onclick="setDrawColor('#d93025')" style="background: #d93025;" title="Red"></button>
        <button class="toolbar-btn ink-color" onclick="setDrawColor('#1a73e8')" style="background: #1a73e8;" title="Blue"></button>
        <button class="toolbar-btn ink-color" onclick="setDrawColor('#34a853')" style="background: #34a853;" title="Green"></button>
        <button class="toolbar-btn ink-color" onclick="setDrawColor('#fbbc04')" style="background: #fbbc04;" title="Yellow"></button>
        <button class="toolbar-btn draw-tool-btn" id="eyedropperBtn" onclick="selectDrawTool('eyedropper')" title="Eyedropper">ðŸ’§</button>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Size:</span>
        <input type="range" id="drawSize" min="1" max="20" value="3" oninput="setDrawSize(this.value)" title="Stroke Size" style="width: 80px;">
        <span id="drawSizeValue" style="min-width: 25px;">3</span>
        <span style="padding: 0 0.5rem; color: var(--secondary);">Opacity:</span>
        <input type="range" id="drawOpacity" min="10" max="100" value="100" oninput="setDrawOpacity(this.value)" title="Opacity" style="width: 60px;">
        <span id="drawOpacityValue" style="min-width: 30px;">100%</span>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Style:</span>
        <button class="draw-shape-btn" id="brushSolidBtn" onclick="setBrushStyle('solid')" title="Solid" style="font-size: 0.7rem;">â”â”</button>
        <button class="draw-shape-btn" id="brushDashedBtn" onclick="setBrushStyle('dashed')" title="Dashed" style="font-size: 0.7rem;">â”… â”…</button>
        <button class="draw-shape-btn" id="brushDottedBtn" onclick="setBrushStyle('dotted')" title="Dotted" style="font-size: 0.7rem;">Â· Â· Â·</button>
        <label style="display: flex; align-items: center; gap: 4px; margin-left: 8px; font-size: 0.85rem; color: var(--secondary);">
          <input type="checkbox" id="shapeFillToggle" onchange="toggleShapeFill(this.checked)"> Fill
        </label>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="undoDrawing()" title="Undo Drawing">â†© Undo</button>
        <button class="toolbar-btn" onclick="clearAllDrawings()" title="Clear All">ðŸ—‘ Clear All</button>
        <button class="toolbar-btn" onclick="convertToShape()" title="Convert to Shape">â¬¡ To Shape</button>
        <button class="toolbar-btn" onclick="showDrawingPanel()" title="Advanced Drawing Options">âš™ï¸ More</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleDrawMode()" id="drawModeBtn" title="Toggle Drawing Mode">âœï¸ Draw Mode: OFF</button>
      </div>
    </div>

    <!-- Design Toolbar -->
    <div class="toolbar" id="designToolbar" style="display: none;">
      <div class="toolbar-group">
        <span style="padding: 0.5rem; font-size: 0.9rem; color: var(--secondary);">Slide Background:</span>
        <input type="color" class="color-picker-btn" id="slideBg" value="#ffffff" onchange="setSlideBackground(this.value)">
        <button class="toolbar-btn" onclick="setGradientBg('blue')">Blue</button>
        <button class="toolbar-btn" onclick="setGradientBg('purple')">Purple</button>
        <button class="toolbar-btn" onclick="setGradientBg('green')">Green</button>
        <button class="toolbar-btn" onclick="setGradientBg('dark')">Dark</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="applyTheme('modern')">Modern</button>
        <button class="toolbar-btn" onclick="applyTheme('classic')">Classic</button>
        <button class="toolbar-btn" onclick="applyTheme('minimal')">Minimal</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showLayoutsPanel()">ðŸ“ Slide Layouts</button>
        <button class="toolbar-btn" onclick="showShapeEffects()">âœ¨ Shape Effects</button>
        <button class="toolbar-btn" onclick="showDesignIdeas()">ðŸ’¡ Design Ideas</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showSlideSizeModal()">ðŸ“ Slide Size</button>
      </div>
    </div>

    <!-- Slide Size Modal -->
    <div class="modal-overlay" id="slideSizeModal">
      <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
          <h3>ðŸ“ Slide Size</h3>
          <button class="modal-close" onclick="hideSlideSizeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Preset Sizes:</label>
            <select class="form-control" id="slideSizePreset" onchange="applySlideSizePreset()">
              <option value="widescreen">Widescreen (16:9) - 960 Ã— 540</option>
              <option value="standard">Standard (4:3) - 960 Ã— 720</option>
              <option value="wide169">Wide (16:9) - 1280 Ã— 720</option>
              <option value="wide1610">Wide (16:10) - 1280 Ã— 800</option>
              <option value="a4landscape">A4 Landscape - 1122 Ã— 793</option>
              <option value="a4portrait">A4 Portrait - 793 Ã— 1122</option>
              <option value="letter">Letter - 1056 Ã— 816</option>
              <option value="custom">Custom...</option>
            </select>
          </div>
          <div class="form-group" id="customSizeGroup" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label>Width (px)</label>
                <input type="number" class="form-control" id="slideWidth" value="960" min="400" max="2000">
              </div>
              <div>
                <label>Height (px)</label>
                <input type="number" class="form-control" id="slideHeight" value="540" min="300" max="1500">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Orientation:</label>
            <div style="display: flex; gap: 1rem;">
              <label><input type="radio" name="slideOrientation" value="landscape" checked> Landscape</label>
              <label><input type="radio" name="slideOrientation" value="portrait"> Portrait</label>
            </div>
          </div>
          <div style="padding: 0.75rem; background: #fff3cd; border-radius: 4px; margin-top: 1rem;">
            <strong>Note:</strong> Changing slide size will apply to all slides. Element positions may need adjustment.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideSlideSizeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="applySlideSize()">Apply</button>
        </div>
      </div>
    </div>

    <!-- Icon/Emoji Picker Modal -->
    <div class="modal-overlay" id="iconPickerModal">
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <h3>ðŸ˜€ Insert Icon/Emoji</h3>
          <button class="modal-close" onclick="hideIconPicker()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <input type="text" class="form-control" id="iconSearch" placeholder="Search icons..." oninput="filterIcons()">
          </div>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <button class="btn btn-secondary btn-sm icon-cat active" onclick="setIconCategory('faces')">ðŸ˜€ Faces</button>
            <button class="btn btn-secondary btn-sm icon-cat" onclick="setIconCategory('objects')">ðŸ“¦ Objects</button>
            <button class="btn btn-secondary btn-sm icon-cat" onclick="setIconCategory('symbols')">â­ Symbols</button>
            <button class="btn btn-secondary btn-sm icon-cat" onclick="setIconCategory('arrows')">âž¡ï¸ Arrows</button>
            <button class="btn btn-secondary btn-sm icon-cat" onclick="setIconCategory('business')">ðŸ’¼ Business</button>
          </div>
          <div id="iconGrid" style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; max-height: 250px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;"></div>
          <div class="form-group" style="margin-top: 1rem;">
            <label>Size:</label>
            <select class="form-control" id="iconSize">
              <option value="32">Small (32px)</option>
              <option value="48" selected>Medium (48px)</option>
              <option value="64">Large (64px)</option>
              <option value="96">Extra Large (96px)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideIconPicker()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Transitions Toolbar -->
    <div class="toolbar" id="transitionsToolbar" style="display: none;">
      <div class="toolbar-group" style="gap: 0.75rem; flex-wrap: wrap; padding: 0.5rem;">
        <div class="transition-preview" onclick="setTransition('none')" data-transition="none">None</div>
        <div class="transition-preview" onclick="setTransition('fade')" data-transition="fade">Fade</div>
        <div class="transition-preview" onclick="setTransition('slide')" data-transition="slide">Slide</div>
        <div class="transition-preview" onclick="setTransition('zoom')" data-transition="zoom">Zoom</div>
        <div class="transition-preview" onclick="setTransition('flip')" data-transition="flip">Flip</div>
        <div class="transition-preview" onclick="setTransition('cube')" data-transition="cube">Cube</div>
        <div class="transition-preview" onclick="setTransition('morph')" data-transition="morph" style="background: linear-gradient(135deg, #00c6ff, #0072ff);">âœ¨ Morph</div>
        <div class="transition-preview" onclick="setTransition('push')" data-transition="push">Push</div>
        <div class="transition-preview" onclick="setTransition('wipe')" data-transition="wipe">Wipe</div>
        <div class="transition-preview" onclick="setTransition('reveal')" data-transition="reveal">Reveal</div>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0.5rem;">Duration:</span>
        <select class="toolbar-select" id="transitionDuration" onchange="setTransitionDuration(this.value)">
          <option value="0.3">Fast (0.3s)</option>
          <option value="0.5" selected>Normal (0.5s)</option>
          <option value="1">Slow (1s)</option>
          <option value="2">Very Slow (2s)</option>
        </select>
      </div>
      <div class="toolbar-group">
        <button class="btn btn-secondary" onclick="applyToAll()">Apply to All Slides</button>
      </div>
    </div>

    <!-- Animations Toolbar -->
    <div class="toolbar" id="animationsToolbar" style="display: none;">
      <div class="toolbar-group">
        <span style="padding: 0.5rem; color: var(--secondary);">Entrance:</span>
        <button class="toolbar-btn" onclick="showAnimationPicker('entrance')">+ More</button>
        <button class="toolbar-btn" onclick="addAnimation('fadeIn')">Fade</button>
        <button class="toolbar-btn" onclick="addAnimation('slideIn')">Slide</button>
        <button class="toolbar-btn" onclick="addAnimation('zoomIn')">Zoom</button>
        <button class="toolbar-btn" onclick="addAnimation('flyIn')">Fly In</button>
        <button class="toolbar-btn" onclick="addAnimation('bounceIn')">Bounce</button>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0.5rem; color: var(--secondary);">Emphasis:</span>
        <button class="toolbar-btn" onclick="showAnimationPicker('emphasis')">+ More</button>
        <button class="toolbar-btn" onclick="addAnimation('pulse')">Pulse</button>
        <button class="toolbar-btn" onclick="addAnimation('shake')">Shake</button>
        <button class="toolbar-btn" onclick="addAnimation('spin')">Spin</button>
        <button class="toolbar-btn" onclick="addAnimation('wobble')">Wobble</button>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0.5rem; color: var(--secondary);">Exit:</span>
        <button class="toolbar-btn" onclick="showAnimationPicker('exit')">+ More</button>
        <button class="toolbar-btn" onclick="addAnimation('fadeOut')">Fade</button>
        <button class="toolbar-btn" onclick="addAnimation('slideOut')">Slide</button>
        <button class="toolbar-btn" onclick="addAnimation('zoomOut')">Zoom</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showMotionPathEditor()">ðŸ“ Motion Path</button>
        <button class="toolbar-btn" onclick="removeAnimation()">ðŸ—‘ Remove</button>
        <button class="toolbar-btn" onclick="previewAnimation()">â–¶ Preview</button>
        <button class="toolbar-btn" onclick="showAnimationTiming()">â± Timing</button>
      </div>
    </div>

    <!-- View Toolbar -->
    <div class="toolbar" id="viewToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleGrid()" id="gridBtn">âŠž Show Grid</button>
        <button class="toolbar-btn" onclick="toggleGuides()" id="guidesBtn">â”¼ Show Guides</button>
        <button class="toolbar-btn" onclick="toggleSnapToGrid()" id="snapBtn">âŒ– Snap to Grid</button>
        <button class="toolbar-btn" onclick="toggleSmartGuides()" id="smartGuidesBtn" style="background: #e8f0fe;">ðŸ“ Smart Guides</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showSlideSorter()">âŠŸ Slide Sorter</button>
        <button class="toolbar-btn" onclick="showOutlineView()">â‰¡ Outline View</button>
        <button class="toolbar-btn" onclick="showNotesPage()">ðŸ“ Notes Page</button>
        <button class="toolbar-btn" onclick="showHandoutMaster()">ðŸ“„ Handout Master</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleRulers()" id="rulersBtn">ðŸ“ Rulers</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="startRehearseTiming()">â± Rehearse Timings</button>
        <button class="toolbar-btn" onclick="showRecordedTimings()">ðŸ“‹ View Timings</button>
        <button class="toolbar-btn" onclick="showSlideTimer()">â² Slide Timer</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showCustomShows()">ðŸŽ­ Custom Shows</button>
        <button class="toolbar-btn" onclick="startPresenterCoach()">ðŸŽ¤ Presenter Coach</button>
        <button class="toolbar-btn" onclick="startSpeakerView()">ðŸŽ¬ Speaker View</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showPrintPreview()">ðŸ–¨ Print Preview</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleDarkMode()" title="Dark Mode" id="darkModeBtn">ðŸŒ™ Dark Mode</button>
        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts (F1)">âŒ¨ Shortcuts</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showAccessibilityChecker()" title="Accessibility Checker">â™¿ Accessibility</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleAutoSave()" title="Auto-Save" id="autoSaveBtn">ðŸ’¾ Auto-Save: Off</button>
        <button class="toolbar-btn" onclick="showVersionHistory()" title="Version History">ðŸ“œ Versions</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="ppt-container">
      <!-- Slide Panel -->
      <div class="slide-panel" id="slidePanel">
        <button class="btn btn-primary" onclick="addSlide()" style="width: 100%; margin-bottom: 1rem;">+ New Slide</button>
        <div id="slideThumbnails"></div>
      </div>

      <!-- Slide Editor -->
      <div class="slide-editor">
        <div class="slide-canvas" id="slideCanvas" onclick="deselectAll(event)">
          <!-- Slide elements rendered here -->
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="ppt-sidebar" id="sidebar">
        <div class="sidebar-section">
          <h3>Element Properties</h3>
          <div id="elementProps">
            <p style="color: var(--secondary); font-size: 0.9rem;">Select an element to edit its properties</p>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Animations</h3>
          <div id="animationList">
            <p style="color: var(--secondary); font-size: 0.9rem;">No animations on this slide</p>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Slide Layout</h3>
          <div class="template-grid">
            <div class="template-item" onclick="applyLayout('title')">Title</div>
            <div class="template-item" onclick="applyLayout('titleContent')">Title + Content</div>
            <div class="template-item" onclick="applyLayout('twoColumn')">Two Column</div>
            <div class="template-item" onclick="applyLayout('blank')">Blank</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Speaker Notes -->
    <div class="speaker-notes">
      <textarea id="speakerNotes" placeholder="Click to add speaker notes for this slide..."></textarea>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <span id="statusLeft">
        <span class="status-bar-item" onclick="showSlideNavigator()" title="Click to navigate slides">
          <span class="status-icon">ðŸ“„</span>
          Slide <span id="currentSlideNum">1</span> of <span id="totalSlides">1</span>
        </span>
        <span style="margin: 0 6px;">|</span>
        <span class="status-bar-item" onclick="toggleAutoSaveStatus()" title="Click to toggle auto-save">
          <span class="status-icon" id="autoSaveStatusIcon">ðŸ’¾</span>
          <span id="autoSaveStatusText">Auto-save On</span>
        </span>
      </span>
      <span id="statusCenter">
        <span class="status-bar-item" title="Elements on current slide">
          <span class="status-icon">âŠž</span>
          Elements: <span id="elementCount">0</span>
        </span>
        <span style="margin: 0 6px;">|</span>
        <span class="status-bar-item" onclick="showTransitionPopup()" title="Click to change transition">
          <span class="status-icon">âœ¨</span>
          Transition: <span id="currentTransition">None</span>
        </span>
      </span>
      <span id="statusRight">
        <span class="status-bar-item" onclick="showZoomPopup()" title="Click to adjust zoom">
          <span class="status-icon">ðŸ”</span>
          <span id="statusZoom">100%</span>
        </span>
        <span style="margin: 0 6px;">|</span>
        <span class="status-bar-item" onclick="startSlideshow()" title="Click to start presentation (F5)">
          <span class="status-icon">â–¶ï¸</span>
          Present
        </span>
      </span>
    </div>
  </div>

  <!-- Zoom Popup -->
  <div class="zoom-popup" id="zoomPopup">
    <div class="zoom-popup-header">
      <span>Zoom Level</span>
      <button class="zoom-popup-close" onclick="hideZoomPopup()">&times;</button>
    </div>
    <div class="zoom-slider-container">
      <span>50%</span>
      <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="200" value="100" oninput="setZoomFromSlider(this.value)">
      <span>200%</span>
    </div>
    <div class="zoom-presets" id="zoomPresets">
      <button class="zoom-preset-btn" onclick="setZoomLevel(50)">50%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(75)">75%</button>
      <button class="zoom-preset-btn active" onclick="setZoomLevel(100)">100%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(125)">125%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(150)">150%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(200)">200%</button>
    </div>
  </div>

  <!-- Transition Popup -->
  <div class="transition-popup" id="transitionPopup">
    <div class="transition-popup-header">
      <span>âœ¨ Slide Transition</span>
      <button class="zoom-popup-close" onclick="hideTransitionPopup()">&times;</button>
    </div>
    <div class="transition-option active" onclick="setTransition('none')">
      <span>â¹ï¸</span>
      <span>None</span>
    </div>
    <div class="transition-option" onclick="setTransition('fade')">
      <span>ðŸŒ«ï¸</span>
      <span>Fade</span>
    </div>
    <div class="transition-option" onclick="setTransition('slide')">
      <span>âž¡ï¸</span>
      <span>Slide</span>
    </div>
    <div class="transition-option" onclick="setTransition('zoom')">
      <span>ðŸ”</span>
      <span>Zoom</span>
    </div>
    <div class="transition-option" onclick="setTransition('flip')">
      <span>ðŸ”„</span>
      <span>Flip</span>
    </div>
  </div>

  <!-- Drag & Drop Overlay -->
  <div class="drop-overlay" id="dropOverlay">
    <div class="drop-overlay-icon">ðŸŽ¬</div>
    <div class="drop-overlay-text">Drop file to open</div>
    <div class="drop-overlay-subtext">Supported: .pptx, .png, .jpg (images added to slide)</div>
  </div>

  <!-- Auto-save Indicator -->
  <div class="autosave-indicator" id="autosaveIndicator">
    <div class="autosave-spinner"></div>
    <span>Auto-saving...</span>
  </div>

  <!-- Global Search Spotlight -->
  <div class="spotlight-overlay" id="spotlightOverlay" onclick="if(event.target === this) hideSpotlight();">
    <div class="spotlight-container">
      <div class="spotlight-input-wrapper">
        <span class="spotlight-search-icon">ðŸ”</span>
        <input type="text" class="spotlight-input" id="spotlightInput" placeholder="Search actions, slides, or elements..." oninput="renderSpotlight(this.value)" onkeydown="handleSpotlightKeydown(event)">
      </div>
      <div class="spotlight-results">
        <div class="spotlight-section-title">Actions</div>
        <div id="spotlightActions"></div>
        <div class="spotlight-section-title">Slides</div>
        <div id="spotlightSlides"></div>
      </div>
      <div class="spotlight-footer">
        <span>â†‘â†“ Navigate</span>
        <span>â†µ Select</span>
        <span>Esc Close</span>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <div class="fab-container" id="fabContainer">
    <div class="fab-menu" id="fabMenu">
      <div class="fab-item">
        <span class="fab-item-label">New Slide</span>
        <button class="fab-item-btn" onclick="addSlide(); toggleFab();" title="Add New Slide">âž•</button>
      </div>
      <div class="fab-item">
        <span class="fab-item-label">Add Text</span>
        <button class="fab-item-btn" onclick="addTextBox(); toggleFab();" title="Add Text Box">T</button>
      </div>
      <div class="fab-item">
        <span class="fab-item-label">Add Image</span>
        <button class="fab-item-btn" onclick="addImage(); toggleFab();" title="Add Image">ðŸ–¼ï¸</button>
      </div>
      <div class="fab-item">
        <span class="fab-item-label">Add Shape</span>
        <button class="fab-item-btn" onclick="showShapeMenu && showShapeMenu(); toggleFab();" title="Add Shape">â¬¡</button>
      </div>
      <div class="fab-item">
        <span class="fab-item-label">Command Palette</span>
        <button class="fab-item-btn" onclick="showSpotlight(); toggleFab();" title="Search (Ctrl+K)">âŒ˜</button>
      </div>
    </div>
    <button class="fab-main" id="fabMain" onclick="toggleFab()" title="Quick Actions">+</button>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="contextMenuAction('cut')">
      <span class="context-menu-item-icon">âœ‚ï¸</span>
      <span>Cut</span>
      <span class="context-menu-item-shortcut">Ctrl+X</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('copy')">
      <span class="context-menu-item-icon">ðŸ“‹</span>
      <span>Copy</span>
      <span class="context-menu-item-shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('paste')">
      <span class="context-menu-item-icon">ðŸ“„</span>
      <span>Paste</span>
      <span class="context-menu-item-shortcut">Ctrl+V</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('duplicate')">
      <span class="context-menu-item-icon">â§‰</span>
      <span>Duplicate</span>
      <span class="context-menu-item-shortcut">Ctrl+D</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="contextMenuAction('bringFront')">
      <span class="context-menu-item-icon">â¬†ï¸</span>
      <span>Bring to Front</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('sendBack')">
      <span class="context-menu-item-icon">â¬‡ï¸</span>
      <span>Send to Back</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="contextMenuAction('addText')">
      <span class="context-menu-item-icon">T</span>
      <span>Add Text Box</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('addShape')">
      <span class="context-menu-item-icon">â–¢</span>
      <span>Add Shape</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('addImage')">
      <span class="context-menu-item-icon">ðŸ–¼ï¸</span>
      <span>Add Image</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="contextMenuAction('lock')">
      <span class="context-menu-item-icon">ðŸ”’</span>
      <span>Lock/Unlock Element</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('group')">
      <span class="context-menu-item-icon">âŠž</span>
      <span>Group Elements</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('animation')">
      <span class="context-menu-item-icon">âœ¨</span>
      <span>Add Animation</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="contextMenuAction('delete')">
      <span class="context-menu-item-icon">ðŸ—‘ï¸</span>
      <span>Delete</span>
      <span class="context-menu-item-shortcut">Delete</span>
    </div>
  </div>

  <!-- Quick Access Toolbar Customization Modal -->
  <div class="modal-overlay" id="qatModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>âš¡ Customize Quick Access Toolbar</h3>
        <button class="modal-close" onclick="hideQATCustomization()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Select commands to add to your Quick Access Toolbar:</p>
        <div class="qat-modal-items" id="qatCommandsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="resetQAT()">Reset to Default</button>
        <button class="btn btn-secondary" onclick="hideQATCustomization()">Cancel</button>
        <button class="btn btn-primary" onclick="saveQATCustomization()">Save</button>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div class="modal-overlay" id="shortcutsModal">
    <div class="modal" style="max-width: 700px; max-height: 80vh;">
      <div class="modal-header">
        <h3>Keyboard Shortcuts</h3>
        <button class="modal-close" onclick="hideKeyboardShortcuts()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div class="shortcuts-grid">
          <div class="shortcuts-section">
            <h4>Slides</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>M</kbd> <span>New Slide</span></div>
            <div class="shortcut-item"><kbd>Page Down</kbd> <span>Next Slide</span></div>
            <div class="shortcut-item"><kbd>Page Up</kbd> <span>Previous Slide</span></div>
            <div class="shortcut-item"><kbd>Home</kbd> <span>First Slide</span></div>
            <div class="shortcut-item"><kbd>End</kbd> <span>Last Slide</span></div>
            <div class="shortcut-item"><kbd>Delete</kbd> <span>Delete Slide</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Presentation</h4>
            <div class="shortcut-item"><kbd>F5</kbd> <span>Start from Beginning</span></div>
            <div class="shortcut-item"><kbd>Shift</kbd> + <kbd>F5</kbd> <span>Start from Current</span></div>
            <div class="shortcut-item"><kbd>Esc</kbd> <span>End Presentation</span></div>
            <div class="shortcut-item"><kbd>Space</kbd> / <kbd>Enter</kbd> <span>Next Slide/Animation</span></div>
            <div class="shortcut-item"><kbd>B</kbd> <span>Black Screen</span></div>
            <div class="shortcut-item"><kbd>W</kbd> <span>White Screen</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Editing</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Z</kbd> <span>Undo</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Y</kbd> <span>Redo</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>X</kbd> <span>Cut</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>C</kbd> <span>Copy</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>V</kbd> <span>Paste</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>D</kbd> <span>Duplicate</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Formatting</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>B</kbd> <span>Bold</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>I</kbd> <span>Italic</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>U</kbd> <span>Underline</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>G</kbd> <span>Group</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>S</kbd> <span>Save</span></div>
            <div class="shortcut-item"><kbd>F1</kbd> <span>Show Shortcuts</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div class="modal-overlay" id="templatesModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Presentation Templates</h3>
        <button class="modal-close" onclick="hideTemplates()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
          <div class="template-slide" onclick="loadTemplate('business')" style="background: linear-gradient(135deg, #1a73e8, #174ea6);">
            <div>ðŸ“Š<br>Business</div>
          </div>
          <div class="template-slide" onclick="loadTemplate('creative')" style="background: linear-gradient(135deg, #ea4335, #c5221f);">
            <div>ðŸŽ¨<br>Creative</div>
          </div>
          <div class="template-slide" onclick="loadTemplate('minimal')" style="background: linear-gradient(135deg, #5f6368, #3c4043);">
            <div>âœ¨<br>Minimal</div>
          </div>
          <div class="template-slide" onclick="loadTemplate('education')" style="background: linear-gradient(135deg, #34a853, #188038);">
            <div>ðŸ“š<br>Education</div>
          </div>
          <div class="template-slide" onclick="loadTemplate('pitch')" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
            <div>ðŸš€<br>Pitch Deck</div>
          </div>
          <div class="template-slide" onclick="loadTemplate('portfolio')" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
            <div>ðŸ’¼<br>Portfolio</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Presenter View Modal -->
  <div class="presenter-view" id="presenterView" style="display: none;">
    <div class="presenter-current" id="presenterCurrentSlide"></div>
    <div class="presenter-sidebar">
      <div class="presenter-timer">
        <div id="presenterTime">00:00:00</div>
        <div style="font-size: 0.9rem; margin-top: 0.5rem;">
          <button class="btn btn-secondary" onclick="resetTimer()">Reset</button>
        </div>
      </div>
      <div class="presenter-next">
        <h4 style="margin-bottom: 0.5rem; color: white;">Next Slide</h4>
        <div id="presenterNextSlide" style="background: white; border-radius: 4px; aspect-ratio: 16/9;"></div>
      </div>
      <div class="presenter-notes">
        <h4 style="margin-bottom: 0.5rem;">Speaker Notes</h4>
        <div id="presenterNotesContent" style="font-size: 1.1rem; line-height: 1.6;"></div>
      </div>
      <div style="text-align: center; padding: 1rem;">
        <button class="btn btn-secondary" onclick="prevSlidePresenter()">â† Previous</button>
        <button class="btn btn-secondary" onclick="nextSlidePresenter()">Next â†’</button>
        <button class="btn btn-danger" onclick="exitPresenterView()">Exit</button>
      </div>
    </div>
  </div>

  <!-- Fullscreen Presentation -->
  <div class="fullscreen-presenter" id="fullscreenPresenter" style="display: none;">
    <div class="fullscreen-slide" id="fullscreenSlide"></div>
    <div class="laser-pointer" id="laserPointer"></div>
    <div class="slideshow-toolbar" id="slideshowToolbar">
      <button onclick="prevSlideshow()" title="Previous Slide">â—€</button>
      <button onclick="nextSlideshow()" title="Next Slide">â–¶</button>
      <button onclick="toggleLaserPointer()" id="laserBtn" title="Laser Pointer (L)">ðŸ”´</button>
      <button onclick="cycleLaserColor()" id="laserColorBtn" title="Change Laser Color">ðŸŽ¨</button>
      <button onclick="toggleBlackScreen()" id="blackScreenBtn" title="Black Screen (B)">â¬›</button>
      <button onclick="exitSlideshow()" title="Exit (ESC)">âœ•</button>
    </div>
    <div style="position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); color: white; opacity: 0.5; font-size: 0.9rem;">
      Press ESC to exit | â† â†’ to navigate | L for laser | B for black screen
    </div>
  </div>

  <!-- Speaker View -->
  <div class="speaker-view" id="speakerView">
    <div class="speaker-view-grid">
      <div class="sv-header">
        <div>
          <strong>Speaker View</strong>
          <span style="margin-left: 1rem; opacity: 0.7;">Slide <span id="svSlideNum">1</span> of <span id="svTotalSlides">1</span></span>
        </div>
        <div class="sv-timer" id="svTimer">00:00:00</div>
        <div>
          <button class="sv-btn-nav" onclick="svResetTimer()" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">Reset Timer</button>
          <button class="sv-btn-end" onclick="endSpeakerView()">End</button>
        </div>
      </div>
      <div class="sv-current-slide">
        <h4>Current Slide</h4>
        <div class="sv-slide-preview" id="svCurrentSlide"></div>
      </div>
      <div class="sv-right-panel">
        <div class="sv-next-slide">
          <h4>Next Slide</h4>
          <div class="sv-next-preview" id="svNextSlide"></div>
        </div>
        <div class="sv-notes">
          <h4>Speaker Notes</h4>
          <div class="sv-notes-content" id="svNotes">No notes for this slide</div>
        </div>
      </div>
      <div class="sv-controls">
        <button class="sv-btn-nav" onclick="svPrevSlide()">â—€ Previous</button>
        <button class="sv-btn-nav" onclick="svNextSlide()">Next â–¶</button>
      </div>
    </div>
  </div>

  <!-- Open Presentations Modal -->
  <div class="modal-overlay" id="openModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Open Presentation</h3>
        <button class="modal-close" onclick="hideOpenDialog()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="savedDocsList" style="max-height: 400px; overflow-y: auto;">
          <p style="color: var(--secondary);">No saved presentations yet.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideOpenDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Save As Modal -->
  <div class="modal-overlay" id="saveAsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Save Presentation As</h3>
        <button class="modal-close" onclick="hideSaveAs()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Presentation Name</label>
          <input type="text" class="form-control" id="saveAsName" placeholder="My Presentation">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSaveAs()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmSaveAs()">Save</button>
      </div>
    </div>
  </div>

  <!-- Slide Master Modal -->
  <div class="modal-overlay" id="slideMasterModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Slide Master</h3>
        <button class="modal-close" onclick="hideSlideMaster()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Define master elements that appear on all slides.</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Background Color</label>
            <input type="color" class="form-control" id="masterBgColor" value="#ffffff" style="height: 40px;">
          </div>
          <div class="form-group">
            <label>Background Gradient</label>
            <select class="form-control" id="masterBgGradient">
              <option value="">None</option>
              <option value="linear-gradient(135deg, #667eea 0%, #764ba2 100%)">Purple Haze</option>
              <option value="linear-gradient(135deg, #1a73e8, #174ea6)">Blue Professional</option>
              <option value="linear-gradient(135deg, #34a853, #188038)">Green Nature</option>
              <option value="linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)">Dark Mode</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label><input type="checkbox" id="masterShowTitle" checked> Show Title Placeholder</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="masterShowSubtitle" checked> Show Subtitle Placeholder</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="masterShowFooter"> Show Footer</label>
        </div>
        <div class="form-group" id="footerTextGroup" style="display: none;">
          <label>Footer Text</label>
          <input type="text" class="form-control" id="masterFooterText" placeholder="Company Name | Confidential">
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="masterShowPageNum"> Show Slide Numbers</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="masterShowDate"> Show Date</label>
        </div>

        <div style="margin-top: 1rem; padding: 1rem; background: var(--light); border-radius: 8px;">
          <h4 style="margin-bottom: 0.5rem;">Preview</h4>
          <div id="masterPreview" style="width: 100%; aspect-ratio: 16/9; background: white; border-radius: 4px; position: relative; border: 1px solid var(--border); overflow: hidden;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSlideMaster()">Cancel</button>
        <button class="btn btn-primary" onclick="applySlideMaster()">Apply to All Slides</button>
        <button class="btn btn-primary" onclick="applySlideMasterToNew()">Apply to New Slides Only</button>
      </div>
    </div>
  </div>

  <!-- Slide Sorter Modal -->
  <div class="modal-overlay" id="slideSorterModal">
    <div class="modal" style="max-width: 90vw; max-height: 90vh;">
      <div class="modal-header">
        <h3>Slide Sorter</h3>
        <button class="modal-close" onclick="hideSlideSorter()">&times;</button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Drag slides to reorder. Click to select.</p>
        <div id="slideSorterGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSlideSorter()">Close</button>
        <button class="btn btn-danger" onclick="deleteSelectedSorterSlide()">Delete Selected</button>
        <button class="btn btn-primary" onclick="applySorterOrder()">Apply Order</button>
      </div>
    </div>
  </div>

  <!-- Outline View Modal -->
  <div class="modal-overlay" id="outlineViewModal">
    <div class="modal" style="max-width: 700px; max-height: 80vh;">
      <div class="modal-header">
        <h3>Outline View</h3>
        <button class="modal-close" onclick="hideOutlineView()">&times;</button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
        <div id="outlineContent" style="font-family: inherit;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideOutlineView()">Close</button>
      </div>
    </div>
  </div>

  <!-- Notes Page Modal -->
  <div class="modal-overlay" id="notesPageModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Notes Page - Slide <span id="notesSlideNum">1</span></h3>
        <button class="modal-close" onclick="hideNotesPage()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 1rem;">
          <div id="notesSlidePreview" style="flex: 1; background: #f5f5f5; border: 1px solid var(--border); aspect-ratio: 16/9; border-radius: 4px; overflow: hidden;"></div>
          <div style="flex: 1;">
            <label>Speaker Notes</label>
            <textarea id="notesPageEditor" class="form-control" rows="12" placeholder="Enter speaker notes..." onchange="saveNotesFromPage()"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="prevNotesPage()">â—„ Previous</button>
        <button class="btn btn-secondary" onclick="nextNotesPage()">Next â–º</button>
        <button class="btn btn-primary" onclick="hideNotesPage()">Done</button>
      </div>
    </div>
  </div>

  <!-- Handout Master Modal -->
  <div class="modal-overlay" id="handoutMasterModal">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Handout Master</h3>
        <button class="modal-close" onclick="hideHandoutMaster()">&times;</button>
      </div>
      <div class="modal-body" style="display: flex; gap: 1.5rem;">
        <!-- Left: Settings -->
        <div style="flex: 0 0 250px;">
          <div class="form-group">
            <label style="font-weight: 600;">Page Setup</label>
            <select class="form-control" id="handoutOrientation" onchange="updateHandoutPreview()">
              <option value="portrait">Portrait</option>
              <option value="landscape">Landscape</option>
            </select>
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label style="font-weight: 600;">Slides Per Page</label>
            <select class="form-control" id="handoutSlidesPerPage" onchange="updateHandoutPreview()">
              <option value="1">1 Slide</option>
              <option value="2">2 Slides</option>
              <option value="3" selected>3 Slides</option>
              <option value="4">4 Slides</option>
              <option value="6">6 Slides</option>
              <option value="9">9 Slides</option>
            </select>
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label style="font-weight: 600;">Include</label>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
              <label><input type="checkbox" id="handoutShowHeader" checked onchange="updateHandoutPreview()"> Header</label>
              <label><input type="checkbox" id="handoutShowFooter" checked onchange="updateHandoutPreview()"> Footer</label>
              <label><input type="checkbox" id="handoutShowDate" checked onchange="updateHandoutPreview()"> Date</label>
              <label><input type="checkbox" id="handoutShowPageNum" checked onchange="updateHandoutPreview()"> Page Number</label>
              <label><input type="checkbox" id="handoutShowNotes" onchange="updateHandoutPreview()"> Notes Lines</label>
            </div>
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label style="font-weight: 600;">Header Text</label>
            <input type="text" class="form-control" id="handoutHeaderText" placeholder="Enter header text" onchange="updateHandoutPreview()">
          </div>

          <div class="form-group" style="margin-top: 0.5rem;">
            <label style="font-weight: 600;">Footer Text</label>
            <input type="text" class="form-control" id="handoutFooterText" placeholder="Enter footer text" onchange="updateHandoutPreview()">
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label style="font-weight: 600;">Background</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input type="color" id="handoutBgColor" value="#ffffff" onchange="updateHandoutPreview()" style="width: 50px; height: 30px;">
              <span style="font-size: 0.85rem; color: #666;">Page background</span>
            </div>
          </div>
        </div>

        <!-- Right: Preview -->
        <div style="flex: 1; background: #e0e0e0; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 65vh;">
          <div id="handoutPreviewContainer" style="display: flex; justify-content: center;">
            <div id="handoutPreview" style="background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); width: 400px; min-height: 500px; padding: 20px; position: relative;">
              <!-- Preview content rendered here -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideHandoutMaster()">Cancel</button>
        <button class="btn btn-secondary" onclick="resetHandoutDefaults()">Reset to Defaults</button>
        <button class="btn btn-primary" onclick="applyHandoutMaster()">Apply to All Handouts</button>
      </div>
    </div>
  </div>

  <!-- Hyperlink Modal -->
  <div class="modal-overlay" id="hyperlinkModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Insert Hyperlink</h3>
        <button class="modal-close" onclick="hideHyperlinkModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Link Type</label>
          <select class="form-control" id="linkType" onchange="updateLinkFields()">
            <option value="url">Web URL</option>
            <option value="slide">Slide in Presentation</option>
            <option value="email">Email Address</option>
          </select>
        </div>
        <div class="form-group" id="urlField">
          <label>URL</label>
          <input type="text" class="form-control" id="linkUrl" placeholder="https://example.com">
        </div>
        <div class="form-group" id="slideField" style="display: none;">
          <label>Target Slide</label>
          <select class="form-control" id="linkSlide"></select>
        </div>
        <div class="form-group" id="emailField" style="display: none;">
          <label>Email Address</label>
          <input type="email" class="form-control" id="linkEmail" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>Display Text (optional)</label>
          <input type="text" class="form-control" id="linkText" placeholder="Click here">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideHyperlinkModal()">Cancel</button>
        <button class="btn btn-danger" onclick="removeHyperlink()">Remove Link</button>
        <button class="btn btn-primary" onclick="applyHyperlink()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Print Preview Modal -->
  <div class="modal-overlay" id="printPreviewModal">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Print Preview</h3>
        <button class="modal-close" onclick="hidePrintPreview()">&times;</button>
      </div>
      <div class="modal-body" style="display: flex; gap: 1rem; max-height: 70vh;">
        <div style="flex: 0 0 200px;">
          <div class="form-group">
            <label>Print Layout</label>
            <select class="form-control" id="printLayout" onchange="updatePrintPreview()">
              <option value="full">Full Page Slides</option>
              <option value="notes">Notes Pages</option>
              <option value="outline">Outline</option>
              <option value="handouts2">Handouts (2 per page)</option>
              <option value="handouts4">Handouts (4 per page)</option>
              <option value="handouts6">Handouts (6 per page)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Print Range</label>
            <select class="form-control" id="printRange" onchange="updatePrintPreview()">
              <option value="all">All Slides</option>
              <option value="current">Current Slide</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div class="form-group" id="customRangeGroup" style="display: none;">
            <label>Slides (e.g., 1-3, 5)</label>
            <input type="text" class="form-control" id="customPrintRange" placeholder="1-3, 5" onchange="updatePrintPreview()">
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="printBorders" onchange="updatePrintPreview()"> Frame Slides</label>
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="printGrayscale" onchange="updatePrintPreview()"> Grayscale</label>
          </div>
        </div>
        <div style="flex: 1; overflow-y: auto; background: #666; padding: 1rem; border-radius: 4px;">
          <div id="printPreviewContent" style="display: flex; flex-direction: column; align-items: center; gap: 1rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePrintPreview()">Close</button>
        <button class="btn btn-primary" onclick="window.print()">ðŸ–¨ Print</button>
        <button class="btn btn-success" onclick="exportPDF(); hidePrintPreview();">Export PDF</button>
      </div>
    </div>
  </div>

  <!-- Image Crop Modal -->
  <div class="modal-overlay" id="imageCropModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Crop Image</h3>
        <button class="modal-close" onclick="hideImageCrop()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="cropPreviewContainer" style="position: relative; width: 100%; max-height: 400px; overflow: hidden; background: #f0f0f0; border-radius: 4px;">
          <img id="cropPreviewImage" style="max-width: 100%; display: block;">
          <div id="cropOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 2px dashed #1a73e8; cursor: move;"></div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 1rem;">
          <div class="form-group">
            <label>Top %</label>
            <input type="number" class="form-control" id="cropTop" value="0" min="0" max="100" onchange="updateCropPreview()">
          </div>
          <div class="form-group">
            <label>Right %</label>
            <input type="number" class="form-control" id="cropRight" value="0" min="0" max="100" onchange="updateCropPreview()">
          </div>
          <div class="form-group">
            <label>Bottom %</label>
            <input type="number" class="form-control" id="cropBottom" value="0" min="0" max="100" onchange="updateCropPreview()">
          </div>
          <div class="form-group">
            <label>Left %</label>
            <input type="number" class="form-control" id="cropLeft" value="0" min="0" max="100" onchange="updateCropPreview()">
          </div>
        </div>
        <div class="toolbar-group" style="justify-content: center; margin-top: 0.5rem;">
          <button class="toolbar-btn" onclick="setCropPreset('16:9')">16:9</button>
          <button class="toolbar-btn" onclick="setCropPreset('4:3')">4:3</button>
          <button class="toolbar-btn" onclick="setCropPreset('1:1')">1:1</button>
          <button class="toolbar-btn" onclick="setCropPreset('reset')">Reset</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideImageCrop()">Cancel</button>
        <button class="btn btn-primary" onclick="applyCrop()">Apply Crop</button>
      </div>
    </div>
  </div>

  <!-- Animation Timing Modal -->
  <div class="modal-overlay" id="animationTimingModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Animation Timing</h3>
        <button class="modal-close" onclick="hideAnimationTiming()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Start</label>
          <select class="form-control" id="animStart">
            <option value="onClick">On Click</option>
            <option value="withPrevious">With Previous</option>
            <option value="afterPrevious">After Previous</option>
          </select>
        </div>
        <div class="form-group">
          <label>Duration (seconds)</label>
          <input type="number" class="form-control" id="animDuration" value="0.5" min="0.1" max="10" step="0.1">
        </div>
        <div class="form-group">
          <label>Delay (seconds)</label>
          <input type="number" class="form-control" id="animDelay" value="0" min="0" max="30" step="0.1">
        </div>
        <div class="form-group">
          <label>Repeat</label>
          <select class="form-control" id="animRepeat">
            <option value="1">1 time</option>
            <option value="2">2 times</option>
            <option value="3">3 times</option>
            <option value="infinite">Until next click</option>
          </select>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="animRewind"> Rewind when done</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAnimationTiming()">Cancel</button>
        <button class="btn btn-primary" onclick="applyAnimationTiming()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Slide Layouts Panel -->
  <div class="modal-overlay" id="layoutsModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Slide Layouts</h3>
        <button class="modal-close" onclick="hideLayoutsPanel()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Click a layout to apply it to the current slide.</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
          <div class="layout-item" onclick="applyLayout('title')" style="border: 2px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center;">
            <div style="background: #f0f0f0; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="width: 60%; height: 20px; background: #999; margin-bottom: 8px;"></div>
              <div style="width: 40%; height: 10px; background: #bbb;"></div>
            </div>
            <span style="font-size: 0.85rem;">Title Slide</span>
          </div>
          <div class="layout-item" onclick="applyLayout('titleContent')" style="border: 2px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center;">
            <div style="background: #f0f0f0; height: 80px; display: flex; flex-direction: column; padding: 8px; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="width: 70%; height: 15px; background: #999; margin-bottom: 8px;"></div>
              <div style="width: 90%; height: 8px; background: #ccc; margin-bottom: 4px;"></div>
              <div style="width: 90%; height: 8px; background: #ccc; margin-bottom: 4px;"></div>
              <div style="width: 70%; height: 8px; background: #ccc;"></div>
            </div>
            <span style="font-size: 0.85rem;">Title + Content</span>
          </div>
          <div class="layout-item" onclick="applyLayout('twoColumn')" style="border: 2px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center;">
            <div style="background: #f0f0f0; height: 80px; padding: 8px; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="width: 60%; height: 12px; background: #999; margin: 0 auto 8px;"></div>
              <div style="display: flex; gap: 8px;">
                <div style="flex: 1; height: 40px; background: #ccc;"></div>
                <div style="flex: 1; height: 40px; background: #ccc;"></div>
              </div>
            </div>
            <span style="font-size: 0.85rem;">Two Columns</span>
          </div>
          <div class="layout-item" onclick="applyLayout('blank')" style="border: 2px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center;">
            <div style="background: #f0f0f0; height: 80px; border-radius: 4px; margin-bottom: 0.5rem;"></div>
            <span style="font-size: 0.85rem;">Blank</span>
          </div>
          <div class="layout-item" onclick="applyLayout('sectionHeader')" style="border: 2px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center;">
            <div style="background: #f0f0f0; height: 80px; display: flex; justify-content: center; align-items: center; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="width: 50%; height: 20px; background: #999;"></div>
            </div>
            <span style="font-size: 0.85rem;">Section Header</span>
          </div>
          <div class="layout-item" onclick="applyLayout('contentWithCaption')" style="border: 2px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center;">
            <div style="background: #f0f0f0; height: 80px; padding: 8px; display: flex; gap: 8px; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="flex: 2; background: #ccc;"></div>
              <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                <div style="width: 100%; height: 10px; background: #999;"></div>
                <div style="width: 100%; height: 6px; background: #bbb;"></div>
                <div style="width: 80%; height: 6px; background: #bbb;"></div>
              </div>
            </div>
            <span style="font-size: 0.85rem;">Content + Caption</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideLayoutsPanel()">Close</button>
      </div>
    </div>
  </div>

  <!-- Shape Effects Modal -->
  <div class="modal-overlay" id="shapeEffectsModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Shape Effects</h3>
        <button class="modal-close" onclick="hideShapeEffects()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Shadow</label>
          <select class="form-control" id="shadowEffect" onchange="updateShapePreview()">
            <option value="none">None</option>
            <option value="small">Small Shadow</option>
            <option value="medium">Medium Shadow</option>
            <option value="large">Large Shadow</option>
            <option value="inner">Inner Shadow</option>
          </select>
        </div>
        <div class="form-group">
          <label>Shadow Color</label>
          <input type="color" class="form-control" id="shadowColor" value="#000000" style="height: 40px;" onchange="updateShapePreview()">
        </div>
        <div class="form-group">
          <label>Opacity</label>
          <input type="range" class="form-control" id="shapeOpacity" min="0" max="100" value="100" onchange="updateShapePreview()">
        </div>
        <div class="form-group">
          <label>Rotation (degrees)</label>
          <input type="number" class="form-control" id="shapeRotation" value="0" min="-360" max="360" onchange="updateShapePreview()">
        </div>
        <div class="form-group">
          <label>Border</label>
          <div style="display: flex; gap: 0.5rem;">
            <select class="form-control" id="shapeBorder" style="flex: 1;">
              <option value="none">None</option>
              <option value="solid">Solid</option>
              <option value="dashed">Dashed</option>
              <option value="dotted">Dotted</option>
            </select>
            <input type="number" class="form-control" id="shapeBorderWidth" value="2" min="1" max="10" style="width: 60px;">
            <input type="color" class="form-control" id="shapeBorderColor" value="#000000" style="width: 60px;">
          </div>
        </div>
        <div class="form-group">
          <label>Glow Effect</label>
          <select class="form-control" id="glowEffect" onchange="updateShapePreview()">
            <option value="none">None</option>
            <option value="small">Small Glow</option>
            <option value="medium">Medium Glow</option>
            <option value="large">Large Glow</option>
          </select>
        </div>
        <div class="form-group">
          <label>Glow Color</label>
          <input type="color" class="form-control" id="glowColor" value="#1a73e8" style="height: 40px;" onchange="updateShapePreview()">
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
          <label style="font-weight: bold;">Preview:</label>
          <div id="shapeEffectPreview" style="margin-top: 0.5rem; height: 100px; display: flex; justify-content: center; align-items: center;">
            <div id="previewShape" style="width: 80px; height: 60px; background: #1a73e8; border-radius: 4px;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideShapeEffects()">Cancel</button>
        <button class="btn btn-danger" onclick="clearShapeEffects()">Clear Effects</button>
        <button class="btn btn-primary" onclick="applyShapeEffects()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Animation Picker Modal -->
  <div class="modal-overlay" id="animationPickerModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="animPickerTitle">Choose Animation</h3>
        <button class="modal-close" onclick="hideAnimationPicker()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="animationPickerContent" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAnimationPicker()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Motion Path Editor Modal -->
  <div class="modal-overlay" id="motionPathModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Motion Path Animation</h3>
        <button class="modal-close" onclick="hideMotionPathEditor()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Path Type</label>
          <select class="form-control" id="motionPathType" onchange="previewMotionPath()">
            <option value="line">Straight Line</option>
            <option value="arc">Arc</option>
            <option value="circle">Circle</option>
            <option value="figure8">Figure 8</option>
            <option value="zigzag">Zigzag</option>
            <option value="wave">Wave</option>
            <option value="spiral">Spiral</option>
            <option value="custom">Custom Points</option>
          </select>
        </div>
        <div class="form-group">
          <label>Path Direction</label>
          <select class="form-control" id="motionDirection">
            <option value="right">Right</option>
            <option value="left">Left</option>
            <option value="up">Up</option>
            <option value="down">Down</option>
          </select>
        </div>
        <div class="form-group">
          <label>Path Distance (pixels)</label>
          <input type="number" class="form-control" id="motionDistance" value="200" min="50" max="500">
        </div>
        <div class="form-group">
          <label>Duration (seconds)</label>
          <input type="number" class="form-control" id="motionDuration" value="1" min="0.1" max="10" step="0.1">
        </div>
        <div id="motionPathPreview" style="height: 150px; border: 1px solid var(--border); margin-top: 0.5rem; position: relative; overflow: hidden; background: #f5f5f5;">
          <div id="motionPreviewDot" style="width: 20px; height: 20px; background: #4285f4; border-radius: 50%; position: absolute;"></div>
          <svg id="motionPreviewPath" style="width: 100%; height: 100%; position: absolute;"></svg>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideMotionPathEditor()">Cancel</button>
        <button class="btn btn-primary" onclick="previewMotionPath()">Preview</button>
        <button class="btn btn-success" onclick="applyMotionPath()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Slide Sections Modal -->
  <div class="modal-overlay" id="sectionsModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Slide Sections</h3>
        <button class="modal-close" onclick="hideSectionsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Organize your slides into sections for better navigation.</p>
        <div class="form-group">
          <label>Section Name</label>
          <input type="text" class="form-control" id="newSectionName" placeholder="e.g., Introduction">
        </div>
        <button class="btn btn-primary" onclick="addSection()" style="width: 100%; margin-bottom: 1rem;">Add Section at Current Slide</button>
        <div class="form-group">
          <label>Existing Sections</label>
          <div id="sectionsList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSectionsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Action Buttons Modal -->
  <div class="modal-overlay" id="actionButtonsModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Insert Action Button</h3>
        <button class="modal-close" onclick="hideActionButtons()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Select a button type and configure its action.</p>
        <div class="form-group">
          <label>Button Type</label>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
            <button class="btn btn-secondary action-btn-type active" onclick="selectActionBtnType('next')" data-type="next">â–¶ Next</button>
            <button class="btn btn-secondary action-btn-type" onclick="selectActionBtnType('previous')" data-type="previous">â—€ Previous</button>
            <button class="btn btn-secondary action-btn-type" onclick="selectActionBtnType('first')" data-type="first">â® First</button>
            <button class="btn btn-secondary action-btn-type" onclick="selectActionBtnType('last')" data-type="last">â­ Last</button>
            <button class="btn btn-secondary action-btn-type" onclick="selectActionBtnType('home')" data-type="home">ðŸ  Home</button>
            <button class="btn btn-secondary action-btn-type" onclick="selectActionBtnType('info')" data-type="info">â„¹ Info</button>
            <button class="btn btn-secondary action-btn-type" onclick="selectActionBtnType('help')" data-type="help">â“ Help</button>
            <button class="btn btn-secondary action-btn-type" onclick="selectActionBtnType('custom')" data-type="custom">âš™ Custom</button>
          </div>
        </div>
        <div class="form-group">
          <label>Action on Click</label>
          <select class="form-control" id="actionBtnAction">
            <option value="next-slide">Go to Next Slide</option>
            <option value="prev-slide">Go to Previous Slide</option>
            <option value="first-slide">Go to First Slide</option>
            <option value="last-slide">Go to Last Slide</option>
            <option value="goto-slide">Go to Specific Slide...</option>
            <option value="hyperlink">Open Hyperlink...</option>
            <option value="end-show">End Slide Show</option>
          </select>
        </div>
        <div class="form-group" id="gotoSlideGroup" style="display: none;">
          <label>Go to Slide Number</label>
          <input type="number" class="form-control" id="gotoSlideNum" min="1" value="1">
        </div>
        <div class="form-group" id="hyperlinkGroup" style="display: none;">
          <label>Hyperlink URL</label>
          <input type="text" class="form-control" id="actionBtnUrl" placeholder="https://example.com">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Button Color</label>
            <input type="color" class="form-control" id="actionBtnColor" value="#1a73e8" style="height: 40px;">
          </div>
          <div class="form-group">
            <label>Text Color</label>
            <input type="color" class="form-control" id="actionBtnTextColor" value="#ffffff" style="height: 40px;">
          </div>
        </div>
        <div class="form-group">
          <label>Button Label (optional)</label>
          <input type="text" class="form-control" id="actionBtnLabel" placeholder="Leave empty for icon only">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideActionButtons()">Cancel</button>
        <button class="btn btn-primary" onclick="insertActionButton()">Insert Button</button>
      </div>
    </div>
  </div>

  <!-- Rehearse Timings Modal -->
  <div class="modal-overlay" id="rehearseTimingsModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Rehearse Timings</h3>
        <button class="modal-close" onclick="stopRehearseTiming()">&times;</button>
      </div>
      <div class="modal-body" style="text-align: center;">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Practice your presentation and record timing for each slide.</p>
        <div id="rehearseSlideInfo" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Slide 1 of 1</div>
        <div id="rehearseTimer" style="font-size: 3rem; font-weight: bold; color: #1a73e8; font-family: monospace;">00:00</div>
        <div id="rehearseTotalTime" style="font-size: 1rem; color: var(--secondary); margin-top: 0.5rem;">Total: 00:00</div>
        <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
          <button class="btn btn-secondary" onclick="rehearsePrevSlide()">â—€ Previous</button>
          <button class="btn btn-danger" onclick="rehearsePause()" id="rehearsePauseBtn">â¸ Pause</button>
          <button class="btn btn-primary" onclick="rehearseNextSlide()">Next â–¶</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="stopRehearseTiming()">Cancel</button>
        <button class="btn btn-success" onclick="saveRehearsedTimings()">Save Timings</button>
      </div>
    </div>
  </div>

  <!-- Recorded Timings Modal -->
  <div class="modal-overlay" id="recordedTimingsModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Recorded Timings</h3>
        <button class="modal-close" onclick="hideRecordedTimings()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">View and manage recorded timings for each slide.</p>
        <div id="timingsList" style="max-height: 300px; overflow-y: auto;"></div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 600;">Total Presentation Time:</span>
            <span id="totalPresentationTime" style="font-size: 1.2rem; font-weight: bold; color: #1a73e8;">00:00</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="clearAllTimings()">Clear All Timings</button>
        <button class="btn btn-secondary" onclick="hideRecordedTimings()">Close</button>
        <button class="btn btn-primary" onclick="applyTimingsToSlideshow()">Use in Slideshow</button>
      </div>
    </div>
  </div>

  <!-- SmartArt Modal -->
  <div class="modal-overlay" id="smartArtModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Insert SmartArt Graphic</h3>
        <button class="modal-close" onclick="hideSmartArt()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem;">
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Category</label>
            <div id="smartArtCategories" style="border: 1px solid var(--border); border-radius: 4px; overflow: hidden;">
              <div class="smartart-category active" onclick="selectSmartArtCategory('list')" data-category="list">List</div>
              <div class="smartart-category" onclick="selectSmartArtCategory('process')" data-category="process">Process</div>
              <div class="smartart-category" onclick="selectSmartArtCategory('cycle')" data-category="cycle">Cycle</div>
              <div class="smartart-category" onclick="selectSmartArtCategory('hierarchy')" data-category="hierarchy">Hierarchy</div>
              <div class="smartart-category" onclick="selectSmartArtCategory('relationship')" data-category="relationship">Relationship</div>
              <div class="smartart-category" onclick="selectSmartArtCategory('matrix')" data-category="matrix">Matrix</div>
              <div class="smartart-category" onclick="selectSmartArtCategory('pyramid')" data-category="pyramid">Pyramid</div>
            </div>
          </div>
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Choose a SmartArt Graphic</label>
            <div id="smartArtGallery" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.75rem;">
            </div>
          </div>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label>Text Items (one per line)</label>
          <textarea class="form-control" id="smartArtText" rows="4" placeholder="Item 1&#10;Item 2&#10;Item 3&#10;Item 4">Item 1
Item 2
Item 3
Item 4</textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Primary Color</label>
            <input type="color" class="form-control" id="smartArtColor1" value="#1a73e8" style="height: 40px;">
          </div>
          <div class="form-group">
            <label>Secondary Color</label>
            <input type="color" class="form-control" id="smartArtColor2" value="#34a853" style="height: 40px;">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSmartArt()">Cancel</button>
        <button class="btn btn-primary" onclick="insertSmartArt()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Custom Shows Modal -->
  <div class="modal-overlay" id="customShowsModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Custom Slide Shows</h3>
        <button class="modal-close" onclick="hideCustomShows()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Create custom shows to present selected slides in a specific order.</p>
        <div class="form-group">
          <label>Custom Shows</label>
          <div id="customShowsList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; min-height: 100px;">
            <p style="color: #666; font-style: italic;">No custom shows defined. Click "New" to create one.</p>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button class="btn btn-primary" onclick="showNewCustomShow()">New</button>
          <button class="btn btn-secondary" onclick="editSelectedCustomShow()">Edit</button>
          <button class="btn btn-danger" onclick="deleteSelectedCustomShow()">Remove</button>
          <button class="btn btn-secondary" onclick="duplicateSelectedCustomShow()">Copy</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCustomShows()">Close</button>
        <button class="btn btn-success" onclick="runSelectedCustomShow()">Show</button>
      </div>
    </div>
  </div>

  <!-- New/Edit Custom Show Modal -->
  <div class="modal-overlay" id="editCustomShowModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="editCustomShowTitle">New Custom Show</h3>
        <button class="modal-close" onclick="hideEditCustomShow()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Show Name</label>
          <input type="text" class="form-control" id="customShowName" placeholder="Enter show name">
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: start;">
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Available Slides</label>
            <div id="availableSlides" style="border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; min-height: 200px; max-height: 300px; overflow-y: auto;">
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; padding-top: 80px;">
            <button class="btn btn-secondary" onclick="addSlidesToShow()" title="Add">â–¶</button>
            <button class="btn btn-secondary" onclick="removeSlidesFromShow()" title="Remove">â—€</button>
          </div>
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Slides in Show</label>
            <div id="showSlides" style="border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; min-height: 200px; max-height: 300px; overflow-y: auto;">
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button class="btn btn-secondary btn-sm" onclick="moveShowSlideUp()">â†‘ Up</button>
              <button class="btn btn-secondary btn-sm" onclick="moveShowSlideDown()">â†“ Down</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEditCustomShow()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomShow()">OK</button>
      </div>
    </div>
  </div>

  <!-- Summary Zoom Modal -->
  <div class="modal-overlay" id="summaryZoomModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Insert Summary Zoom</h3>
        <button class="modal-close" onclick="hideSummaryZoom()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Create a summary slide with clickable thumbnails that navigate to specific slides. Select which slides to include:</p>
        <div id="summaryZoomSlides" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; max-height: 350px; overflow-y: auto; padding: 0.5rem;">
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
          <button class="btn btn-secondary btn-sm" onclick="selectAllZoomSlides()">Select All</button>
          <button class="btn btn-secondary btn-sm" onclick="deselectAllZoomSlides()">Deselect All</button>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label>Summary Slide Title</label>
          <input type="text" class="form-control" id="summaryZoomTitle" value="Summary" placeholder="Enter title for summary slide">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Layout</label>
            <select class="form-control" id="summaryZoomLayout">
              <option value="grid">Grid</option>
              <option value="row">Single Row</option>
              <option value="column">Single Column</option>
            </select>
          </div>
          <div class="form-group">
            <label>Thumbnail Size</label>
            <select class="form-control" id="summaryZoomSize">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSummaryZoom()">Cancel</button>
        <button class="btn btn-primary" onclick="insertSummaryZoom()">Insert Summary Zoom</button>
      </div>
    </div>
  </div>

  <!-- Slide Zoom Modal -->
  <div class="modal-overlay" id="slideZoomModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Insert Slide Zoom</h3>
        <button class="modal-close" onclick="hideSlideZoom()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Insert a clickable thumbnail that zooms to another slide during presentation.</p>
        <div class="form-group">
          <label>Select Target Slide</label>
          <div id="slideZoomTargets" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-height: 250px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Width (px)</label>
            <input type="number" class="form-control" id="slideZoomWidth" value="200" min="100" max="500">
          </div>
          <div class="form-group">
            <label>Height (px)</label>
            <input type="number" class="form-control" id="slideZoomHeight" value="112" min="56" max="280">
          </div>
        </div>
        <div class="form-group">
          <label>Border Style</label>
          <select class="form-control" id="slideZoomBorder">
            <option value="none">None</option>
            <option value="thin" selected>Thin</option>
            <option value="thick">Thick</option>
            <option value="shadow">Shadow</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="slideZoomReturn" checked> Return to this slide after viewing
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSlideZoom()">Cancel</button>
        <button class="btn btn-primary" onclick="insertSlideZoom()">Insert Zoom</button>
      </div>
    </div>
  </div>

  <!-- Design Ideas Modal -->
  <div class="modal-overlay" id="designIdeasModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Design Ideas</h3>
        <button class="modal-close" onclick="hideDesignIdeas()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Choose a design suggestion to apply to your current slide:</p>
        <div id="designIdeasGallery" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; max-height: 400px; overflow-y: auto;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDesignIdeas()">Close</button>
        <button class="btn btn-primary" onclick="refreshDesignIdeas()">ðŸ”„ More Ideas</button>
      </div>
    </div>
  </div>

  <!-- Photo Album Modal -->
  <div class="modal-overlay" id="photoAlbumModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Create Photo Album</h3>
        <button class="modal-close" onclick="hidePhotoAlbum()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Photos</label>
          <input type="file" class="form-control" id="photoAlbumFiles" accept="image/*" multiple onchange="previewPhotoAlbum()">
          <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">Select multiple images to create slides</p>
        </div>
        <div class="form-group">
          <label>Album Layout</label>
          <select class="form-control" id="photoAlbumLayout">
            <option value="1">1 photo per slide (Full)</option>
            <option value="2">2 photos per slide</option>
            <option value="4">4 photos per slide</option>
            <option value="title">Title slide + 1 photo each</option>
          </select>
        </div>
        <div class="form-group">
          <label>Frame Shape</label>
          <select class="form-control" id="photoAlbumFrame">
            <option value="none">No frame</option>
            <option value="simple">Simple border</option>
            <option value="rounded">Rounded corners</option>
            <option value="shadow">Drop shadow</option>
            <option value="polaroid">Polaroid style</option>
          </select>
        </div>
        <div class="form-group">
          <label>Background</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="color" class="form-control" id="photoAlbumBg" value="#ffffff" style="width: 60px; height: 36px;">
            <select class="form-control" id="photoAlbumBgPreset" onchange="applyAlbumBgPreset()" style="flex: 1;">
              <option value="">Custom color</option>
              <option value="#ffffff">White</option>
              <option value="#000000">Black</option>
              <option value="#1a1a2e">Dark Blue</option>
              <option value="#f5f5dc">Beige</option>
              <option value="gradient">Gradient</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="photoAlbumCaptions"> Add captions (filename)</label>
        </div>
        <div id="photoAlbumPreview" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; background: #f9f9f9; display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <p style="color: #666; width: 100%; text-align: center; margin: 2rem 0;">No photos selected</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePhotoAlbum()">Cancel</button>
        <button class="btn btn-primary" onclick="createPhotoAlbum()">Create Album</button>
      </div>
    </div>
  </div>

  <!-- Screen Recording Modal -->
  <div class="modal-overlay" id="screenRecordingModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Screen Recording</h3>
        <button class="modal-close" onclick="hideScreenRecording()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="screenRecordingSetup">
          <p style="color: var(--secondary); margin-bottom: 1rem;">Record your screen and insert it as a video element on the current slide.</p>
          <div class="form-group">
            <label>Recording Source</label>
            <select class="form-control" id="recordingSource">
              <option value="screen">Entire Screen</option>
              <option value="window">Application Window</option>
              <option value="tab">Browser Tab</option>
            </select>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="recordAudio" checked> Include audio
            </label>
          </div>
          <div id="recordingPreview" style="display: none; margin: 1rem 0;">
            <video id="screenPreview" style="width: 100%; max-height: 300px; border: 1px solid var(--border); border-radius: 4px;" muted></video>
          </div>
          <div id="recordingStatus" style="text-align: center; padding: 1rem; background: #f5f5f5; border-radius: 4px; margin-bottom: 1rem;">
            <span style="color: var(--secondary);">Click "Start Recording" to begin</span>
          </div>
          <div id="recordingTimer" style="display: none; text-align: center; font-size: 2rem; font-weight: bold; color: #ea4335; margin-bottom: 1rem;">
            00:00
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideScreenRecording()">Cancel</button>
        <button class="btn btn-danger" id="stopRecordingBtn" onclick="stopScreenRecording()" style="display: none;">â¹ Stop Recording</button>
        <button class="btn btn-primary" id="startRecordingBtn" onclick="startScreenRecording()">ðŸ”´ Start Recording</button>
        <button class="btn btn-primary" id="insertRecordingBtn" onclick="insertScreenRecording()" style="display: none;">Insert Recording</button>
      </div>
    </div>
  </div>

  <!-- Video Controls Modal -->
  <div class="modal-overlay" id="videoControlsModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Video Settings</h3>
        <button class="modal-close" onclick="hideVideoControls()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Video URL (YouTube, Vimeo, or direct URL)</label>
          <input type="text" class="form-control" id="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        <div class="form-group">
          <label>Start Options</label>
          <select class="form-control" id="videoStartOption">
            <option value="click">Start on Click</option>
            <option value="auto">Start Automatically</option>
            <option value="cross-slide">Play Across Slides</option>
          </select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Start Time (seconds)</label>
            <input type="number" class="form-control" id="videoStartTime" value="0" min="0">
          </div>
          <div class="form-group">
            <label>End Time (seconds, 0=full)</label>
            <input type="number" class="form-control" id="videoEndTime" value="0" min="0">
          </div>
        </div>
        <div class="form-group">
          <label>Volume</label>
          <input type="range" class="form-control" id="videoVolume" min="0" max="100" value="100" style="padding: 0;">
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="videoLoop"> Loop until stopped
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="checkbox" id="videoHideControls"> Hide playback controls
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="checkbox" id="videoRewind"> Rewind after playing
          </label>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Width</label>
            <input type="number" class="form-control" id="videoWidth" value="400" min="100">
          </div>
          <div class="form-group">
            <label>Height</label>
            <input type="number" class="form-control" id="videoHeight" value="300" min="100">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideVideoControls()">Cancel</button>
        <button class="btn btn-primary" onclick="insertVideo()">Insert Video</button>
      </div>
    </div>
  </div>

  <!-- Accessibility Checker Modal -->
  <div class="modal-overlay" id="accessibilityModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>â™¿ Accessibility Checker</h3>
        <button class="modal-close" onclick="hideAccessibilityChecker()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Check your presentation for accessibility issues.</p>

        <div style="margin-bottom: 1rem;">
          <button class="btn btn-primary" onclick="runAccessibilityCheck()">Check All Slides</button>
          <button class="btn btn-secondary" onclick="checkCurrentSlide()">Check Current Slide</button>
          <button class="btn btn-secondary" onclick="clearAccessibilityResults()">Clear</button>
        </div>

        <div id="accessibilityResults" style="max-height: 350px; overflow-y: auto;">
          <div id="accessibilityErrors" style="display: none; margin-bottom: 1rem;">
            <h4 style="color: #d93025; margin-bottom: 0.5rem;">âš  Errors</h4>
            <div id="accessibilityErrorList" style="border: 1px solid #fce8e6; border-radius: 4px; background: #fef7f7;"></div>
          </div>

          <div id="accessibilityWarnings" style="display: none; margin-bottom: 1rem;">
            <h4 style="color: #f9ab00; margin-bottom: 0.5rem;">âš¡ Warnings</h4>
            <div id="accessibilityWarningList" style="border: 1px solid #fef3e0; border-radius: 4px; background: #fffcf7;"></div>
          </div>

          <div id="accessibilityTips" style="display: none; margin-bottom: 1rem;">
            <h4 style="color: #1a73e8; margin-bottom: 0.5rem;">ðŸ’¡ Tips</h4>
            <div id="accessibilityTipList" style="border: 1px solid #e8f0fe; border-radius: 4px; background: #f8fbff;"></div>
          </div>

          <div id="accessibilitySuccess" style="display: none; text-align: center; padding: 2rem;">
            <div style="font-size: 48px; margin-bottom: 0.5rem;">âœ“</div>
            <h4 style="color: #34a853;">No accessibility issues found!</h4>
            <p style="color: var(--secondary);">Your presentation is accessible.</p>
          </div>

          <div id="accessibilityEmpty" style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 48px; margin-bottom: 0.5rem;">â™¿</div>
            <p>Click "Check All Slides" to analyze your presentation.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAccessibilityChecker()">Close</button>
      </div>
    </div>
  </div>

  <!-- QR Code Generator Modal -->
  <div class="modal-overlay" id="qrCodeModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>â–£ QR Code Generator</h3>
        <button class="modal-close" onclick="hideQRCodeGenerator()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="font-weight: 600;">Content Type</label>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-secondary qr-type-btn active" onclick="selectQRType('url')" data-type="url">ðŸ”— URL</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('text')" data-type="text">ðŸ“ Text</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('email')" data-type="email">ðŸ“§ Email</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('phone')" data-type="phone">ðŸ“ž Phone</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('wifi')" data-type="wifi">ðŸ“¶ WiFi</button>
          </div>
        </div>

        <div id="qrUrlPanel" class="qr-input-panel">
          <div class="form-group">
            <label>URL:</label>
            <input type="url" class="form-control" id="qrUrl" placeholder="https://example.com" oninput="generateQRPreview()">
          </div>
        </div>

        <div id="qrTextPanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Text Content:</label>
            <textarea class="form-control" id="qrText" rows="3" placeholder="Enter any text..." oninput="generateQRPreview()"></textarea>
          </div>
        </div>

        <div id="qrEmailPanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Email Address:</label>
            <input type="email" class="form-control" id="qrEmail" placeholder="email@example.com" oninput="generateQRPreview()">
          </div>
        </div>

        <div id="qrPhonePanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Phone Number:</label>
            <input type="tel" class="form-control" id="qrPhone" placeholder="+1234567890" oninput="generateQRPreview()">
          </div>
        </div>

        <div id="qrWifiPanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Network Name (SSID):</label>
            <input type="text" class="form-control" id="qrWifiSsid" placeholder="WiFi Network Name" oninput="generateQRPreview()">
          </div>
          <div class="form-group">
            <label>Password:</label>
            <input type="text" class="form-control" id="qrWifiPassword" placeholder="Password" oninput="generateQRPreview()">
          </div>
          <div class="form-group">
            <label>Security:</label>
            <select class="form-control" id="qrWifiSecurity" onchange="generateQRPreview()">
              <option value="WPA">WPA/WPA2</option>
              <option value="WEP">WEP</option>
              <option value="nopass">None</option>
            </select>
          </div>
        </div>

        <div class="form-group" style="margin-top: 1rem;">
          <label style="font-weight: 600;">QR Code Size:</label>
          <select class="form-control" id="qrSize" onchange="generateQRPreview()" style="width: auto;">
            <option value="100">Small (100px)</option>
            <option value="150" selected>Medium (150px)</option>
            <option value="200">Large (200px)</option>
            <option value="250">Extra Large (250px)</option>
          </select>
        </div>

        <div style="margin-top: 1rem; text-align: center;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Preview:</label>
          <div id="qrPreview" style="display: inline-block; padding: 1rem; background: white; border: 1px solid #ddd; border-radius: 8px; min-height: 150px; min-width: 150px;">
            <span style="color: #999;">Enter content to generate QR code</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideQRCodeGenerator()">Cancel</button>
        <button class="btn btn-primary" onclick="insertQRCode()">Insert QR Code</button>
      </div>
    </div>
  </div>

  <!-- Version History Modal -->
  <div class="modal-overlay" id="versionHistoryModal">
    <div class="modal" style="max-width: 600px; max-height: 80vh;">
      <div class="modal-header">
        <h3>ðŸ“œ Version History</h3>
        <button class="modal-close" onclick="hideVersionHistory()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
          <div>
            <strong>Auto-Save:</strong>
            <span id="autoSaveStatus" style="margin-left: 0.5rem; color: #d93025;">Disabled</span>
          </div>
          <label style="font-size: 0.9rem;">
            <input type="checkbox" id="autoSaveCheckbox" onchange="toggleAutoSaveFromModal()"> Enable
          </label>
        </div>
        <div style="margin-bottom: 1rem;">
          <label>Interval:</label>
          <select class="form-control" id="autoSaveInterval" style="width: auto; display: inline-block; margin-left: 0.5rem;" onchange="updateAutoSaveInterval()">
            <option value="30000">30 sec</option>
            <option value="60000" selected>1 min</option>
            <option value="120000">2 min</option>
            <option value="300000">5 min</option>
          </select>
          <button class="btn btn-secondary" onclick="createManualVersion()" style="margin-left: 1rem;">ðŸ“¸ Save Now</button>
        </div>
        <h4 style="margin-bottom: 0.5rem;">Saved Versions</h4>
        <div id="versionList" style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
          <div style="padding: 1rem; text-align: center; color: #666;">No versions saved yet</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="clearVersionHistory()">ðŸ—‘ Clear All</button>
        <button class="btn btn-primary" onclick="hideVersionHistory()">Close</button>
      </div>
    </div>
  </div>

  <!-- Stock Images Modal -->
  <div class="modal-overlay" id="stockImagesModal">
    <div class="modal" style="max-width: 800px; max-height: 90vh;">
      <div class="modal-header">
        <h3>ðŸŒ Stock Images</h3>
        <button class="modal-close" onclick="hideStockImages()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <input type="text" class="form-control" id="stockImageSearch" placeholder="Search images..." style="flex: 1;" onkeyup="if(event.key==='Enter')searchStockImages()">
          <button class="btn btn-primary" onclick="searchStockImages()">ðŸ” Search</button>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
          <button class="btn btn-sm btn-secondary" onclick="searchStockCategory('nature')">ðŸŒ¿ Nature</button>
          <button class="btn btn-sm btn-secondary" onclick="searchStockCategory('business')">ðŸ’¼ Business</button>
          <button class="btn btn-sm btn-secondary" onclick="searchStockCategory('technology')">ðŸ’» Tech</button>
          <button class="btn btn-sm btn-secondary" onclick="searchStockCategory('abstract')">ðŸŽ¨ Abstract</button>
          <button class="btn btn-sm btn-secondary" onclick="searchStockCategory('architecture')">ðŸ› Architecture</button>
        </div>
        <div id="stockImagesGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; max-height: 350px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: #f9f9f9;">
          <div style="grid-column: span 4; text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 36px;">ðŸ–¼ï¸</div>
            <p>Search for images or click a category</p>
          </div>
        </div>
        <div id="stockImagePreview" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #f5f5f5; border-radius: 8px;">
          <div style="display: flex; gap: 1rem; align-items: center;">
            <img id="stockPreviewImg" src="" style="max-width: 150px; max-height: 100px; border-radius: 4px;">
            <div style="flex: 1;">
              <p id="stockImageCredit" style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;"></p>
              <select class="form-control" id="stockImageSize" style="width: auto;">
                <option value="small">Small</option>
                <option value="medium" selected>Medium</option>
                <option value="large">Large</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideStockImages()">Cancel</button>
        <button class="btn btn-primary" onclick="insertStockImage()" id="insertStockBtn" disabled>Insert</button>
      </div>
    </div>
  </div>

  <!-- Recent Presentations Modal -->
  <div class="modal-overlay" id="recentPresentationsModal">
    <div class="modal" style="max-width: 700px; max-height: 85vh;">
      <div class="modal-header">
        <h3>ðŸ“‚ Recent Presentations</h3>
        <button class="modal-close" onclick="hideRecentPresentations()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; align-items: center;">
          <input type="text" class="form-control" id="recentPresentationsSearch" placeholder="Search presentations..." style="flex: 1;" oninput="filterRecentPresentations()">
          <select class="form-control" id="recentPresentationsSort" style="width: auto;" onchange="sortRecentPresentations()">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="name">Name A-Z</option>
            <option value="slides">Most Slides</option>
          </select>
        </div>
        <div id="recentPresentationsList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: #fafafa;">
          <div style="text-align: center; padding: 3rem; color: #666;">
            <div style="font-size: 48px; margin-bottom: 1rem;">ðŸ“Š</div>
            <p>No recent presentations</p>
            <p style="font-size: 0.85rem;">Presentations you work on will appear here</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="clearRecentPresentations()" style="margin-right: auto;">ðŸ—‘ Clear History</button>
        <button class="btn btn-secondary" onclick="hideRecentPresentations()">Close</button>
      </div>
    </div>
  </div>

  <!-- Slide Timer Modal -->
  <div class="modal-overlay" id="slideTimerModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3>â² Presentation Timer</h3>
        <button class="modal-close" onclick="hideSlideTimer()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Timer Mode:</label>
          <select class="form-control" id="timerMode" onchange="updateTimerMode()">
            <option value="countdown">Countdown Timer</option>
            <option value="stopwatch">Stopwatch (Count Up)</option>
            <option value="perSlide">Per-Slide Timer</option>
          </select>
        </div>
        <div id="countdownSettings">
          <div class="form-group">
            <label>Total Presentation Time:</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
              <div>
                <input type="number" class="form-control" id="timerHours" value="0" min="0" max="23">
                <small style="color: var(--secondary);">Hours</small>
              </div>
              <div>
                <input type="number" class="form-control" id="timerMinutes" value="15" min="0" max="59">
                <small style="color: var(--secondary);">Minutes</small>
              </div>
              <div>
                <input type="number" class="form-control" id="timerSeconds" value="0" min="0" max="59">
                <small style="color: var(--secondary);">Seconds</small>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="timerWarning" checked> Show warning at:</label>
            <input type="number" class="form-control" id="warningMinutes" value="2" min="1" style="width: 80px; display: inline-block;"> minutes remaining
          </div>
        </div>
        <div id="perSlideSettings" style="display: none;">
          <div class="form-group">
            <label>Time per slide (seconds):</label>
            <input type="number" class="form-control" id="perSlideTime" value="60" min="10" max="600">
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="autoAdvance"> Auto-advance to next slide</label>
          </div>
        </div>
        <div class="form-group">
          <label>Timer Position:</label>
          <select class="form-control" id="timerPosition">
            <option value="top-right">Top Right</option>
            <option value="top-left">Top Left</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="bottom-left">Bottom Left</option>
            <option value="center-top">Center Top</option>
          </select>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="timerSound"> Play sound on timer end</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSlideTimer()">Cancel</button>
        <button class="btn btn-primary" onclick="startSlideTimer()">Start Timer</button>
      </div>
    </div>
  </div>

  <!-- Timer Display (shown during presentation) -->
  <div id="presentationTimer" style="display: none; position: fixed; padding: 0.75rem 1.5rem; background: rgba(0,0,0,0.8); color: white; font-size: 1.5rem; font-weight: bold; font-family: monospace; border-radius: 8px; z-index: 10000; cursor: move;">
    <span id="timerDisplay">00:00:00</span>
    <button onclick="pauseResumeTimer()" style="background: none; border: none; color: white; cursor: pointer; margin-left: 0.5rem; font-size: 1rem;" id="timerPauseBtn">â¸</button>
    <button onclick="stopPresentationTimer()" style="background: none; border: none; color: #ff6b6b; cursor: pointer; margin-left: 0.25rem; font-size: 1rem;">âœ•</button>
  </div>

  <!-- Find Bar -->
  <div class="find-bar" id="findBar">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
      <strong style="font-size: 14px;">ðŸ” Find & Replace</strong>
      <button class="close-btn" onclick="closeFindBar()">Ã—</button>
    </div>
    <div class="find-row">
      <input type="text" id="findInput" placeholder="Find text..." onkeyup="handleFindKeyup(event)">
      <button class="nav-btn" onclick="findPrev()">â—„</button>
      <button class="nav-btn" onclick="findNext()">â–º</button>
    </div>
    <div class="find-row">
      <input type="text" id="replaceInput" placeholder="Replace with...">
      <button class="replace-btn" onclick="replaceCurrentMatch()">Replace</button>
      <button class="replace-all-btn" onclick="replaceAllMatches()">All</button>
    </div>
    <div style="display: flex; gap: 1rem; font-size: 12px;">
      <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
        <input type="checkbox" id="findMatchCase"> Match case
      </label>
      <span class="find-results" id="findResults"></span>
    </div>
  </div>

  <!-- Presenter Coach Modal -->
  <div class="modal-overlay" id="presenterCoachModal">
    <div class="modal" style="max-width: 800px; height: 85vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #d24726, #ff6b4a);">
        <h3 style="color: white;">Presenter Coach</h3>
        <button class="modal-close" onclick="stopPresenterCoach()" style="color: white;">&times;</button>
      </div>
      <div class="modal-body" style="display: flex; flex-direction: column; height: calc(100% - 120px); padding: 0;">
        <!-- Coach View -->
        <div id="coachView" style="flex: 1; display: flex;">
          <!-- Slide Preview -->
          <div style="flex: 2; background: #1a1a1a; display: flex; align-items: center; justify-content: center; position: relative;">
            <div id="coachSlidePreview" style="width: 80%; aspect-ratio: 16/9; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
              <!-- Slide content rendered here -->
            </div>
            <div id="coachTimer" style="position: absolute; top: 1rem; right: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1.5rem; font-family: monospace;">
              00:00
            </div>
            <div id="coachSlideNumber" style="position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem; border-radius: 4px;">
              Slide 1 of 1
            </div>
          </div>

          <!-- Feedback Panel -->
          <div style="flex: 1; background: #f5f5f5; padding: 1rem; overflow-y: auto; min-width: 280px;">
            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">ðŸŽ¯</span> Real-time Feedback
            </h4>

            <div id="coachFeedback" style="display: flex; flex-direction: column; gap: 0.75rem;">
              <div class="coach-metric">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span>Pacing</span>
                  <span id="pacingValue">--</span>
                </div>
                <div style="height: 8px; background: #ddd; border-radius: 4px; overflow: hidden;">
                  <div id="pacingBar" style="height: 100%; width: 50%; background: #4caf50; transition: all 0.3s;"></div>
                </div>
              </div>

              <div class="coach-metric">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span>Filler Words</span>
                  <span id="fillerValue">0</span>
                </div>
                <div style="height: 8px; background: #ddd; border-radius: 4px; overflow: hidden;">
                  <div id="fillerBar" style="height: 100%; width: 0%; background: #ff9800; transition: all 0.3s;"></div>
                </div>
              </div>

              <div class="coach-metric">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span>Repetition</span>
                  <span id="repetitionValue">Low</span>
                </div>
                <div style="height: 8px; background: #ddd; border-radius: 4px; overflow: hidden;">
                  <div id="repetitionBar" style="height: 100%; width: 10%; background: #2196f3; transition: all 0.3s;"></div>
                </div>
              </div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #1a73e8;">
              <h5 style="margin-bottom: 0.5rem;">ðŸ’¡ Tips</h5>
              <div id="coachTips" style="font-size: 0.9rem; color: #666;">
                <p>Click "Start Practice" to begin your rehearsal session.</p>
              </div>
            </div>

            <div style="margin-top: 1rem;">
              <h5 style="margin-bottom: 0.5rem;">ðŸ“ Notes</h5>
              <div id="coachNotes" style="font-size: 0.85rem; color: #666; padding: 0.75rem; background: white; border-radius: 4px; min-height: 60px;">
                Speaker notes will appear here
              </div>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div style="padding: 1rem; background: #2d2d2d; display: flex; justify-content: center; gap: 1rem; align-items: center;">
          <button class="btn btn-secondary" onclick="coachPrevSlide()" style="padding: 0.75rem 1.5rem;">
            â—„ Previous
          </button>
          <button class="btn btn-primary" id="coachStartBtn" onclick="toggleCoachSession()" style="padding: 0.75rem 2rem; font-size: 1rem;">
            â–¶ Start Practice
          </button>
          <button class="btn btn-secondary" onclick="coachNextSlide()" style="padding: 0.75rem 1.5rem;">
            Next â–º
          </button>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <div style="font-size: 0.85rem; color: #666;">
          Press <kbd>Space</kbd> to advance slides, <kbd>Esc</kbd> to exit
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-secondary" onclick="showCoachReport()">ðŸ“Š View Report</button>
          <button class="btn btn-secondary" onclick="stopPresenterCoach()">Exit Coach</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Coach Report Modal -->
  <div class="modal-overlay" id="coachReportModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Practice Session Report</h3>
        <button class="modal-close" onclick="hideCoachReport()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-size: 3rem;">ðŸ†</div>
          <h2 id="reportOverallScore" style="margin: 0.5rem 0;">Great Job!</h2>
          <p style="color: #666;">Here's your presentation feedback</p>
        </div>

        <div id="reportMetrics" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
          <div style="text-align: center; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold;" id="reportDuration">0:00</div>
            <div style="font-size: 0.85rem; color: #666;">Duration</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold;" id="reportSlides">0</div>
            <div style="font-size: 0.85rem; color: #666;">Slides Covered</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold;" id="reportPace">--</div>
            <div style="font-size: 0.85rem; color: #666;">Avg. Pace</div>
          </div>
        </div>

        <div id="reportSuggestions">
          <h4 style="margin-bottom: 0.5rem;">Suggestions for Improvement</h4>
          <ul style="margin: 0; padding-left: 1.25rem; color: #666;">
            <li>Practice session data will appear here</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCoachReport()">Close</button>
        <button class="btn btn-primary" onclick="hideCoachReport(); startPresenterCoach();">Practice Again</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="fileImport" accept=".njslides,.json" style="display: none;" onchange="handleFileImport(event)">
  <input type="file" id="pptxImport" accept=".pptx" style="display: none;" onchange="handlePptxImport(event)">

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Welcome Modal -->
  <div class="welcome-modal" id="welcomeModal">
    <div class="welcome-container">
      <div class="welcome-header">
        <h2>Welcome to NinjaSlides</h2>
        <p>Your powerful browser-based presentation editor</p>
      </div>
      <div class="welcome-tips">
        <div class="welcome-tip">
          <div class="welcome-tip-icon">âŒ˜</div>
          <div class="welcome-tip-content">
            <h4>Quick Search (Ctrl+K)</h4>
            <p>Press Ctrl+K to open the command palette. Search actions, navigate slides, or add elements quickly.</p>
          </div>
        </div>
        <div class="welcome-tip">
          <div class="welcome-tip-icon">â–¶ï¸</div>
          <div class="welcome-tip-content">
            <h4>Present Your Slides</h4>
            <p>Press F5 to start presenting from the beginning, or Shift+F5 from the current slide.</p>
          </div>
        </div>
        <div class="welcome-tip">
          <div class="welcome-tip-icon">ðŸ“‚</div>
          <div class="welcome-tip-content">
            <h4>Drag & Drop Support</h4>
            <p>Drag images directly onto slides to add them. Import/export as .njslides or .pptx files.</p>
          </div>
        </div>
        <div class="welcome-tip">
          <div class="welcome-tip-icon">âŒ¨ï¸</div>
          <div class="welcome-tip-content">
            <h4>Keyboard Shortcuts</h4>
            <p>Press F1 for all shortcuts. Use Ctrl+M for new slide, arrows to navigate, Delete to remove.</p>
          </div>
        </div>
      </div>
      <div class="welcome-footer">
        <label class="welcome-checkbox">
          <input type="checkbox" id="dontShowAgain">
          Don't show this again
        </label>
        <button class="welcome-btn" onclick="closeWelcome()">Get Started</button>
      </div>
    </div>
  </div>

  <!-- Laser Pointer -->
  <div class="laser-dot" id="laserDot"></div>
  <div class="laser-indicator" id="laserIndicator">
    <div class="laser-indicator-dot"></div>
    <span>Laser Pointer (Press L to toggle)</span>
  </div>

  <!-- Slide Timer -->
  <div class="slide-timer" id="slideTimer">
    <div class="slide-timer-label">Elapsed Time</div>
    <div class="slide-timer-time" id="slideTimerDisplay">00:00</div>
    <div class="slide-timer-controls">
      <button class="slide-timer-btn" onclick="resetSlideTimer()">Reset</button>
      <button class="slide-timer-btn" onclick="toggleSlideTimerPause()" id="slideTimerPauseBtn">Pause</button>
    </div>
  </div>

  <!-- Quick Shapes Toolbar -->
  <div class="quick-shapes-bar" id="quickShapesBar">
    <button class="quick-shape-btn" onclick="quickAddShape('rectangle')" title="Rectangle">â–­</button>
    <button class="quick-shape-btn" onclick="quickAddShape('circle')" title="Circle">â—‹</button>
    <button class="quick-shape-btn" onclick="quickAddShape('triangle')" title="Triangle">â–³</button>
    <button class="quick-shape-btn" onclick="quickAddShape('diamond')" title="Diamond">â—‡</button>
    <div class="quick-shapes-divider"></div>
    <button class="quick-shape-btn" onclick="quickAddShape('arrow-right')" title="Arrow Right">â†’</button>
    <button class="quick-shape-btn" onclick="quickAddShape('arrow-down')" title="Arrow Down">â†“</button>
    <button class="quick-shape-btn" onclick="quickAddShape('star')" title="Star">â˜…</button>
    <div class="quick-shapes-divider"></div>
    <button class="quick-shape-btn" onclick="quickAddText()" title="Text Box">T</button>
    <button class="quick-shape-btn" onclick="quickAddLine()" title="Line">â•±</button>
    <div class="quick-shapes-divider"></div>
    <button class="quick-shape-btn" onclick="toggleQuickShapes()" title="Close">âœ•</button>
  </div>

  <!-- Advanced Drawing Panel -->
  <div class="draw-mode-panel" id="drawingPanel">
    <div class="draw-mode-panel-header">
      <h3>âœï¸ Drawing Tools</h3>
      <button class="draw-mode-panel-close" onclick="hideDrawingPanel()">&times;</button>
    </div>
    <div class="draw-mode-panel-body">
      <div class="draw-tool-section">
        <div class="draw-tool-section-title">Freehand Tools</div>
        <div class="draw-tool-grid">
          <button class="draw-tool-item" id="panelPenBtn" onclick="selectDrawToolFromPanel('pen')">
            <span class="draw-tool-item-icon">ðŸ–Š</span>
            <span class="draw-tool-item-label">Pen</span>
          </button>
          <button class="draw-tool-item" id="panelHighlighterBtn" onclick="selectDrawToolFromPanel('highlighter')">
            <span class="draw-tool-item-icon">ðŸ–Œ</span>
            <span class="draw-tool-item-label">Highlight</span>
          </button>
          <button class="draw-tool-item" id="panelEraserBtn" onclick="selectDrawToolFromPanel('eraser')">
            <span class="draw-tool-item-icon">ðŸ§¹</span>
            <span class="draw-tool-item-label">Eraser</span>
          </button>
          <button class="draw-tool-item" id="panelSprayBtn" onclick="selectDrawToolFromPanel('spray')">
            <span class="draw-tool-item-icon">ðŸŽ¨</span>
            <span class="draw-tool-item-label">Spray</span>
          </button>
          <button class="draw-tool-item" id="panelCalligraphyBtn" onclick="selectDrawToolFromPanel('calligraphy')">
            <span class="draw-tool-item-icon">âœ’ï¸</span>
            <span class="draw-tool-item-label">Calligraphy</span>
          </button>
        </div>
      </div>

      <div class="draw-tool-section">
        <div class="draw-tool-section-title">Shape Tools</div>
        <div class="draw-tool-grid">
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('line')">
            <span class="draw-tool-item-icon">â•±</span>
            <span class="draw-tool-item-label">Line</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('arrow')">
            <span class="draw-tool-item-icon">â†’</span>
            <span class="draw-tool-item-label">Arrow</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('rect')">
            <span class="draw-tool-item-icon">â–­</span>
            <span class="draw-tool-item-label">Rectangle</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('ellipse')">
            <span class="draw-tool-item-icon">â—¯</span>
            <span class="draw-tool-item-label">Ellipse</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('triangle')">
            <span class="draw-tool-item-icon">â–³</span>
            <span class="draw-tool-item-label">Triangle</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('star')">
            <span class="draw-tool-item-icon">â˜…</span>
            <span class="draw-tool-item-label">Star</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('polygon')">
            <span class="draw-tool-item-icon">â¬¡</span>
            <span class="draw-tool-item-label">Polygon</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('heart')">
            <span class="draw-tool-item-icon">â™¡</span>
            <span class="draw-tool-item-label">Heart</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('cloud')">
            <span class="draw-tool-item-icon">â˜</span>
            <span class="draw-tool-item-label">Cloud</span>
          </button>
          <button class="draw-tool-item" onclick="selectDrawShapeFromPanel('speech')">
            <span class="draw-tool-item-icon">ðŸ’¬</span>
            <span class="draw-tool-item-label">Speech</span>
          </button>
        </div>
      </div>

      <div class="draw-tool-section">
        <div class="draw-tool-section-title">Brush Style</div>
        <div class="brush-styles-row">
          <button class="brush-style-btn active" id="panelBrushSolid" onclick="setBrushStyleFromPanel('solid')">
            <div class="brush-preview"></div>
            <span style="font-size: 0.75rem;">Solid</span>
          </button>
          <button class="brush-style-btn" id="panelBrushDashed" onclick="setBrushStyleFromPanel('dashed')">
            <div class="brush-preview dashed"></div>
            <span style="font-size: 0.75rem;">Dashed</span>
          </button>
          <button class="brush-style-btn" id="panelBrushDotted" onclick="setBrushStyleFromPanel('dotted')">
            <div class="brush-preview dotted"></div>
            <span style="font-size: 0.75rem;">Dotted</span>
          </button>
          <button class="brush-style-btn" id="panelBrushSoft" onclick="setBrushStyleFromPanel('soft')">
            <div class="brush-preview soft"></div>
            <span style="font-size: 0.75rem;">Soft</span>
          </button>
        </div>
        <div class="fill-toggle">
          <span class="fill-toggle-label">Fill Shapes:</span>
          <label class="fill-toggle-switch">
            <input type="checkbox" id="panelFillToggle" onchange="toggleShapeFillFromPanel(this.checked)">
            <span class="fill-toggle-slider"></span>
          </label>
          <input type="color" id="fillColorPicker" value="#1a73e8" onchange="setFillColor(this.value)" title="Fill Color" style="width: 30px; height: 24px; border: none; cursor: pointer;">
        </div>
      </div>

      <div class="draw-tool-section">
        <div class="draw-tool-section-title">Recent Colors</div>
        <div class="recent-colors" id="recentDrawColors"></div>
      </div>

      <div class="draw-tool-section">
        <div class="draw-tool-section-title">Line Settings</div>
        <div class="opacity-control">
          <label>Opacity:</label>
          <input type="range" id="panelDrawOpacity" min="10" max="100" value="100" oninput="setDrawOpacityFromPanel(this.value)">
          <span class="opacity-value" id="panelOpacityValue">100%</span>
        </div>
        <div class="opacity-control">
          <label>Smoothing:</label>
          <input type="range" id="lineSmoothing" min="0" max="10" value="3" oninput="setLineSmoothing(this.value)">
          <span class="opacity-value" id="smoothingValue">3</span>
        </div>
      </div>

      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
        <p style="font-size: 0.8rem; color: #5f6368; margin: 0;">
          <strong>Tips:</strong> Hold <kbd>Shift</kbd> for straight lines. Press <kbd>D</kbd> to toggle draw mode.
        </p>
      </div>
    </div>
  </div>

  <!-- Line Assist Indicator -->
  <div class="line-assist-indicator" id="lineAssistIndicator">
    Hold <kbd>Shift</kbd> for straight lines
  </div>

  <!-- Eyedropper Preview -->
  <div class="eyedropper-preview" id="eyedropperPreview"></div>

  <script>
    // State
    let slides = [];
    let currentSlideIndex = 0;
    let selectedElement = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let elementIdCounter = 0;
    let presenterTimerInterval = null;
    let presenterStartTime = null;
    let currentDocId = null;
    const STORAGE_KEY = 'ninjaslides_presentations';

    // Zoom
    let currentZoom = 100;

    // Undo/Redo
    let undoStack = [];
    let redoStack = [];
    const MAX_HISTORY = 50;

    // Find
    let findMatches = [];
    let currentMatchIndex = -1;

    // Slide Master
    let slideMaster = {
      background: '#ffffff',
      showTitle: true,
      showSubtitle: true,
      showFooter: false,
      footerText: '',
      showPageNum: false,
      showDate: false
    };

    // View settings
    let showGrid = false;
    let showGuides = false;
    let snapToGrid = false;
    let showRulers = false;
    let smartGuidesEnabled = true;
    let sorterSelectedSlide = -1;
    let sorterOrder = [];

    // File Menu
    function toggleFileMenu() {
      const menu = document.getElementById('fileMenu');
      menu.classList.toggle('show');
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.getElementById('fileMenu')?.classList.remove('show');
      }
    });

    // Get/Save documents
    function getSavedDocs() {
      const docs = localStorage.getItem(STORAGE_KEY);
      return docs ? JSON.parse(docs) : {};
    }

    function saveDocs(docs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
    }

    // New Presentation
    function newPresentation() {
      if (slides.length > 0 && !confirm('Create new presentation? Unsaved changes will be lost.')) return;
      toggleFileMenu();

      slides = [];
      currentSlideIndex = 0;
      selectedElement = null;
      elementIdCounter = 0;

      addSlide();
      selectSlide(0);
      document.getElementById('fileName').value = 'Untitled Presentation';
      currentDocId = null;
      showToast('New presentation created', 'success');
    }

    // Open Dialog
    function showOpenDialog() {
      toggleFileMenu();
      const docs = getSavedDocs();
      const list = document.getElementById('savedDocsList');

      if (Object.keys(docs).length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 2rem;">No saved presentations yet.<br>Save a presentation first!</p>';
      } else {
        list.innerHTML = Object.entries(docs).map(([id, doc]) => `
          <div style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;"
               onmouseover="this.style.background='var(--light)'"
               onmouseout="this.style.background='white'"
               onclick="loadPresentation('${id}')">
            <div style="flex: 1;">
              <div style="font-weight: 500;">${doc.name}</div>
              <div style="font-size: 0.8rem; color: var(--secondary);">
                ${doc.slides?.length || 0} slides | Last modified: ${new Date(doc.modified).toLocaleString()}
              </div>
            </div>
            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                    onclick="event.stopPropagation(); deletePresentationDoc('${id}')">ðŸ—‘</button>
          </div>
        `).join('');
      }

      document.getElementById('openModal').classList.add('active');
    }

    function hideOpenDialog() {
      document.getElementById('openModal').classList.remove('active');
    }

    // Load Presentation
    function loadPresentation(id) {
      const docs = getSavedDocs();
      const doc = docs[id];
      if (doc) {
        slides = JSON.parse(JSON.stringify(doc.slides || []));
        elementIdCounter = doc.elementIdCounter || 0;
        currentSlideIndex = 0;

        document.getElementById('fileName').value = doc.name;
        currentDocId = id;

        renderThumbnails();
        renderSlide();
        updateStatusBar();

        hideOpenDialog();
        showToast('Presentation loaded', 'success');
      }
    }

    // Delete Presentation
    function deletePresentationDoc(id) {
      if (!confirm('Delete this presentation permanently?')) return;
      const docs = getSavedDocs();
      delete docs[id];
      saveDocs(docs);
      showOpenDialog();
      showToast('Presentation deleted', 'success');
    }

    // Save Presentation
    function savePresentation() {
      toggleFileMenu();
      if (!currentDocId) {
        savePresentationAs();
        return;
      }

      // Save current speaker notes
      slides[currentSlideIndex].speakerNotes = document.getElementById('speakerNotes').value;

      const docs = getSavedDocs();
      const name = document.getElementById('fileName').value;
      docs[currentDocId] = {
        name: name,
        slides: JSON.parse(JSON.stringify(slides)),
        elementIdCounter: elementIdCounter,
        modified: Date.now()
      };
      saveDocs(docs);
      addToRecentFiles(currentDocId, name);
      addToRecentPresentations(name);
      showToast('Presentation saved', 'success');
    }

    // Save As
    function savePresentationAs() {
      const menu = document.getElementById('fileMenu');
      if (menu.classList.contains('show')) toggleFileMenu();
      document.getElementById('saveAsName').value = document.getElementById('fileName').value;
      document.getElementById('saveAsModal').classList.add('active');
    }

    function hideSaveAs() {
      document.getElementById('saveAsModal').classList.remove('active');
    }

    function confirmSaveAs() {
      const name = document.getElementById('saveAsName').value.trim() || 'Untitled Presentation';

      // Save current speaker notes
      slides[currentSlideIndex].speakerNotes = document.getElementById('speakerNotes').value;

      const docs = getSavedDocs();
      const id = 'pres_' + Date.now();

      docs[id] = {
        name: name,
        slides: JSON.parse(JSON.stringify(slides)),
        elementIdCounter: elementIdCounter,
        modified: Date.now()
      };

      saveDocs(docs);
      currentDocId = id;
      document.getElementById('fileName').value = name;
      addToRecentFiles(id, name);
      addToRecentPresentations(name);
      hideSaveAs();
      showToast('Presentation saved as "' + name + '"', 'success');
    }

    // Export to file
    function exportToFile() {
      toggleFileMenu();
      const name = document.getElementById('fileName').value.trim() || 'presentation';

      // Save current speaker notes
      slides[currentSlideIndex].speakerNotes = document.getElementById('speakerNotes').value;

      const fileData = {
        name: name,
        slides: JSON.parse(JSON.stringify(slides)),
        elementIdCounter: elementIdCounter,
        created: Date.now(),
        app: 'NinjaSlides'
      };

      const blob = new Blob([JSON.stringify(fileData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name + '.njslides';
      a.click();
      URL.revokeObjectURL(url);
      addToRecentPresentations(name);
      showToast('Presentation exported', 'success');
    }

    // Import from file
    function importFromFile() {
      toggleFileMenu();
      document.getElementById('fileImport').click();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const fileData = JSON.parse(e.target.result);
          if (fileData.slides) {
            slides = JSON.parse(JSON.stringify(fileData.slides));
            elementIdCounter = fileData.elementIdCounter || 0;
            currentSlideIndex = 0;
            selectedElement = null;

            renderThumbnails();
            renderSlide();
            updateStatusBar();

            document.getElementById('fileName').value = fileData.name || 'Imported Presentation';
            currentDocId = null;
            showToast('Presentation imported successfully', 'success');
          } else {
            throw new Error('Invalid format');
          }
        } catch (err) {
          showToast('Error importing file: Invalid format', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // ========== PPTX IMPORT/EXPORT ==========

    // Export to PPTX
    async function exportPptx() {
      toggleFileMenu();
      showToast('Generating PPTX...', 'info');

      try {
        const pptx = new PptxGenJS();
        const fileName = document.getElementById('fileName').value || 'presentation';

        // Set presentation properties
        pptx.author = 'NinjaSlides';
        pptx.title = fileName;
        pptx.subject = 'Presentation';

        // Process each slide
        for (const slide of slides) {
          const pptSlide = pptx.addSlide();

          // Set background
          if (slide.background.startsWith('linear-gradient')) {
            // Extract colors from gradient
            const colors = slide.background.match(/#[a-fA-F0-9]{6}/g) || ['#FFFFFF'];
            pptSlide.background = { color: colors[0].replace('#', '') };
          } else {
            pptSlide.background = { color: slide.background.replace('#', '') || 'FFFFFF' };
          }

          // Process elements
          for (const el of slide.elements) {
            if (el.type === 'text') {
              // Convert pixels to inches (96 DPI)
              const x = el.x / 96;
              const y = el.y / 96;
              const w = el.width / 96;
              const h = el.height / 96;

              // Clean HTML content to plain text
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = el.content;
              const text = tempDiv.textContent || tempDiv.innerText || '';

              pptSlide.addText(text, {
                x: x,
                y: y,
                w: w,
                h: h,
                fontSize: parseInt(el.style.fontSize) || 24,
                fontFace: el.style.fontFamily || 'Arial',
                color: (el.style.color || '#000000').replace('#', ''),
                bold: el.style.fontWeight === 'bold',
                italic: el.style.fontStyle === 'italic',
                underline: el.style.textDecoration === 'underline',
                align: el.style.textAlign || 'left',
                valign: 'top'
              });
            } else if (el.type === 'shape') {
              const x = el.x / 96;
              const y = el.y / 96;
              const w = el.width / 96;
              const h = el.height / 96;

              let shapeType = 'rect';
              if (el.shape === 'circle') shapeType = 'ellipse';
              else if (el.shape === 'triangle') shapeType = 'triangle';

              pptSlide.addShape(pptx.ShapeType[shapeType] || pptx.ShapeType.rect, {
                x: x,
                y: y,
                w: w,
                h: h,
                fill: { color: (el.style.background || '#4285f4').replace('#', '') }
              });
            } else if (el.type === 'image' && el.src) {
              const x = el.x / 96;
              const y = el.y / 96;
              const w = el.width / 96;
              const h = el.height / 96;

              // Only include http/https images
              if (el.src.startsWith('http')) {
                pptSlide.addImage({
                  path: el.src,
                  x: x,
                  y: y,
                  w: w,
                  h: h
                });
              }
            }
          }

          // Add speaker notes
          if (slide.speakerNotes) {
            pptSlide.addNotes(slide.speakerNotes);
          }
        }

        // Generate and download
        const pptxBlob = await pptx.write({ outputType: 'blob' });
        saveAs(pptxBlob, fileName + '.pptx');
        showToast('PPTX exported successfully!', 'success');
      } catch (err) {
        console.error('PPTX export error:', err);
        showToast('Error exporting PPTX: ' + err.message, 'error');
      }
    }

    // Export to HTML
    function exportHTML() {
      toggleFileMenu();
      const fileName = document.getElementById('fileName').value || 'presentation';

      let htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${fileName}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; }
    .slide-container { max-width: 960px; margin: 0 auto; padding: 2rem; }
    .slide {
      background: white;
      color: #333;
      aspect-ratio: 16 / 9;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    .slide-number {
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 12px;
      color: #999;
    }
    .element {
      position: absolute;
      overflow: hidden;
    }
    .text-element { padding: 8px; }
    .shape-element { border-radius: 4px; }
    .image-element img { width: 100%; height: 100%; object-fit: contain; }
    .speaker-notes {
      background: #2d2d2d;
      color: #ccc;
      padding: 1rem;
      margin-top: -1.5rem;
      margin-bottom: 2rem;
      border-radius: 0 0 8px 8px;
      font-size: 0.9rem;
    }
    .speaker-notes h4 { color: #ff9800; margin-bottom: 0.5rem; }
    h1 { text-align: center; padding: 2rem; color: white; }
    footer { text-align: center; padding: 2rem; color: #666; font-size: 0.8rem; }
    @media print {
      .slide { page-break-after: always; margin: 0; box-shadow: none; }
      .speaker-notes { display: none; }
      body { background: white; }
    }
  </style>
</head>
<body>
<h1>${fileName}</h1>
<div class="slide-container">
`;

      slides.forEach((slide, idx) => {
        htmlContent += `  <div class="slide" style="background: ${slide.background || '#ffffff'};">\n`;
        htmlContent += `    <span class="slide-number">${idx + 1} / ${slides.length}</span>\n`;

        slide.elements.forEach(el => {
          const style = `left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px;`;

          if (el.type === 'text') {
            const textStyle = Object.entries(el.style || {}).map(([k, v]) => {
              const cssKey = k.replace(/([A-Z])/g, '-$1').toLowerCase();
              return `${cssKey}: ${v}`;
            }).join('; ');
            htmlContent += `    <div class="element text-element" style="${style} ${textStyle}">${el.content || ''}</div>\n`;
          } else if (el.type === 'shape') {
            const shapeStyle = el.style?.background ? `background: ${el.style.background};` : 'background: #4285f4;';
            let borderRadius = '';
            if (el.shape === 'circle') borderRadius = 'border-radius: 50%;';
            htmlContent += `    <div class="element shape-element" style="${style} ${shapeStyle} ${borderRadius}"></div>\n`;
          } else if (el.type === 'image' && el.src) {
            htmlContent += `    <div class="element image-element" style="${style}"><img src="${el.src}" alt="Image"></div>\n`;
          }
        });

        htmlContent += `  </div>\n`;

        if (slide.speakerNotes) {
          htmlContent += `  <div class="speaker-notes"><h4>Speaker Notes:</h4><p>${slide.speakerNotes}</p></div>\n`;
        }
      });

      htmlContent += `</div>
<footer>
  <p>Generated by NinjaSlides - ${new Date().toLocaleDateString()}</p>
</footer>
</body>
</html>`;

      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName + '.html';
      a.click();
      URL.revokeObjectURL(url);
      showToast('HTML exported successfully!', 'success');
    }

    // Import PPTX
    function importPptx() {
      toggleFileMenu();
      document.getElementById('pptxImport').click();
    }

    async function handlePptxImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      showToast('Importing PPTX...', 'info');

      try {
        const arrayBuffer = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(arrayBuffer);

        // Reset slides
        slides = [];
        elementIdCounter = 0;
        currentSlideIndex = 0;

        // Read presentation XML
        const presentationXml = await zip.file('ppt/presentation.xml')?.async('string');
        if (!presentationXml) {
          throw new Error('Invalid PPTX file');
        }

        // Parse slide relationships
        const relsXml = await zip.file('ppt/_rels/presentation.xml.rels')?.async('string');
        const slideRefs = [];

        if (relsXml) {
          const relsParser = new DOMParser();
          const relsDoc = relsParser.parseFromString(relsXml, 'text/xml');
          const relationships = relsDoc.querySelectorAll('Relationship');

          relationships.forEach(rel => {
            const type = rel.getAttribute('Type');
            const target = rel.getAttribute('Target');
            if (type && type.includes('slide') && target && target.includes('slide')) {
              slideRefs.push(target.replace(/^\/ppt\//, '').replace(/^\.\.\//, ''));
            }
          });
        }

        // Sort slides by number
        slideRefs.sort((a, b) => {
          const numA = parseInt(a.match(/\d+/)?.[0] || '0');
          const numB = parseInt(b.match(/\d+/)?.[0] || '0');
          return numA - numB;
        });

        // Process each slide
        for (const slideRef of slideRefs) {
          const slideXml = await zip.file('ppt/slides/' + slideRef)?.async('string');
          if (!slideXml) continue;

          const parser = new DOMParser();
          const slideDoc = parser.parseFromString(slideXml, 'text/xml');

          const slide = {
            id: Date.now() + Math.random(),
            background: '#ffffff',
            transition: 'fade',
            transitionDuration: 0.5,
            elements: [],
            speakerNotes: ''
          };

          // Extract text elements
          const textElements = slideDoc.querySelectorAll('p\\:sp, sp');
          textElements.forEach(sp => {
            const txBody = sp.querySelector('p\\:txBody, txBody');
            if (txBody) {
              const textContent = [];
              const paragraphs = txBody.querySelectorAll('a\\:p, p');
              paragraphs.forEach(p => {
                const runs = p.querySelectorAll('a\\:r, r');
                runs.forEach(r => {
                  const t = r.querySelector('a\\:t, t');
                  if (t) textContent.push(t.textContent);
                });
              });

              if (textContent.length > 0) {
                // Get position from xfrm
                const xfrm = sp.querySelector('p\\:spPr a\\:xfrm, spPr xfrm');
                let x = 100, y = 100, width = 400, height = 60;

                if (xfrm) {
                  const off = xfrm.querySelector('a\\:off, off');
                  const ext = xfrm.querySelector('a\\:ext, ext');

                  if (off) {
                    // EMUs to pixels (914400 EMUs = 1 inch, 96 pixels = 1 inch)
                    x = parseInt(off.getAttribute('x') || '0') / 914400 * 96;
                    y = parseInt(off.getAttribute('y') || '0') / 914400 * 96;
                  }
                  if (ext) {
                    width = parseInt(ext.getAttribute('cx') || '0') / 914400 * 96;
                    height = parseInt(ext.getAttribute('cy') || '0') / 914400 * 96;
                  }
                }

                slide.elements.push({
                  id: ++elementIdCounter,
                  type: 'text',
                  x: Math.max(0, x),
                  y: Math.max(0, y),
                  width: Math.max(100, width),
                  height: Math.max(30, height),
                  content: textContent.join(' '),
                  style: {
                    fontSize: '24px',
                    fontWeight: 'normal',
                    fontFamily: 'Arial',
                    color: '#1a1a1a',
                    textAlign: 'left'
                  },
                  animation: null
                });
              }
            }
          });

          // If no elements found, add placeholder
          if (slide.elements.length === 0) {
            slide.elements.push({
              id: ++elementIdCounter,
              type: 'text',
              x: 80,
              y: 200,
              width: 800,
              height: 80,
              content: 'Imported slide',
              style: {
                fontSize: '32px',
                fontWeight: 'normal',
                fontFamily: 'Arial',
                color: '#666666',
                textAlign: 'center'
              },
              animation: null
            });
          }

          slides.push(slide);
        }

        // If no slides were imported, create a default one
        if (slides.length === 0) {
          addSlide();
        }

        // Update UI
        currentSlideIndex = 0;
        renderThumbnails();
        renderSlide();
        updateStatusBar();

        document.getElementById('fileName').value = file.name.replace('.pptx', '');
        currentDocId = null;
        clearHistory();

        showToast(`Imported ${slides.length} slide(s) from PPTX`, 'success');
      } catch (err) {
        console.error('PPTX import error:', err);
        showToast('Error importing PPTX: ' + err.message, 'error');
      }

      event.target.value = '';
    }

    // ========== UNDO/REDO ==========

    function saveState() {
      const state = JSON.stringify({
        slides: slides,
        currentSlideIndex: currentSlideIndex,
        elementIdCounter: elementIdCounter
      });

      undoStack.push(state);
      if (undoStack.length > MAX_HISTORY) {
        undoStack.shift();
      }

      // Clear redo stack when new action is taken
      redoStack = [];
      updateHistoryButtons();
    }

    function undo() {
      if (undoStack.length === 0) return;

      // Save current state to redo stack
      const currentState = JSON.stringify({
        slides: slides,
        currentSlideIndex: currentSlideIndex,
        elementIdCounter: elementIdCounter
      });
      redoStack.push(currentState);

      // Restore previous state
      const state = JSON.parse(undoStack.pop());
      slides = state.slides;
      currentSlideIndex = state.currentSlideIndex;
      elementIdCounter = state.elementIdCounter;
      selectedElement = null;

      renderThumbnails();
      renderSlide();
      updateStatusBar();
      updateHistoryButtons();
      showToast('Undo', 'info');
    }

    function redo() {
      if (redoStack.length === 0) return;

      // Save current state to undo stack
      const currentState = JSON.stringify({
        slides: slides,
        currentSlideIndex: currentSlideIndex,
        elementIdCounter: elementIdCounter
      });
      undoStack.push(currentState);

      // Restore redo state
      const state = JSON.parse(redoStack.pop());
      slides = state.slides;
      currentSlideIndex = state.currentSlideIndex;
      elementIdCounter = state.elementIdCounter;
      selectedElement = null;

      renderThumbnails();
      renderSlide();
      updateStatusBar();
      updateHistoryButtons();
      showToast('Redo', 'info');
    }

    function updateHistoryButtons() {
      document.getElementById('undoBtn').disabled = undoStack.length === 0;
      document.getElementById('redoBtn').disabled = redoStack.length === 0;
    }

    function clearHistory() {
      undoStack = [];
      redoStack = [];
      updateHistoryButtons();
    }

    // ========== ZOOM ==========

    function setZoom(value) {
      currentZoom = parseInt(value);
      document.getElementById('zoomLevel').value = value;
      document.getElementById('statusZoom').textContent = value + '%';
      applyZoom();
    }

    function zoomIn() {
      const levels = [50, 75, 100, 125, 150, 200];
      const currentIndex = levels.indexOf(currentZoom);
      if (currentIndex < levels.length - 1) {
        setZoom(levels[currentIndex + 1]);
      }
    }

    function zoomOut() {
      const levels = [50, 75, 100, 125, 150, 200];
      const currentIndex = levels.indexOf(currentZoom);
      if (currentIndex > 0) {
        setZoom(levels[currentIndex - 1]);
      }
    }

    function applyZoom() {
      const canvas = document.getElementById('slideCanvas');
      const scale = currentZoom / 100;
      canvas.style.transform = `scale(${scale})`;
      canvas.style.transformOrigin = 'top left';
    }

    // ========== FIND ==========

    function toggleFindBar() {
      toggleFileMenu();
      const findBar = document.getElementById('findBar');
      findBar.classList.toggle('show');
      if (findBar.classList.contains('show')) {
        document.getElementById('findInput').focus();
      } else {
        clearFindHighlights();
      }
    }

    function closeFindBar() {
      document.getElementById('findBar').classList.remove('show');
      clearFindHighlights();
      document.getElementById('findInput').value = '';
      document.getElementById('replaceInput').value = '';
      document.getElementById('findResults').textContent = '';
    }

    function handleFindKeyup(event) {
      if (event.key === 'Enter') {
        findNext();
      } else if (event.key === 'Escape') {
        closeFindBar();
      } else {
        performFind();
      }
    }

    function performFind() {
      const searchTextRaw = document.getElementById('findInput').value.trim();
      const matchCase = document.getElementById('findMatchCase').checked;
      const searchText = matchCase ? searchTextRaw : searchTextRaw.toLowerCase();
      findMatches = [];
      currentMatchIndex = -1;

      if (!searchText) {
        document.getElementById('findResults').textContent = '';
        clearFindHighlights();
        return;
      }

      // Search through all slides
      slides.forEach((slide, slideIndex) => {
        slide.elements.forEach((el, elIndex) => {
          if (el.type === 'text') {
            const text = matchCase ? el.content : el.content.toLowerCase();
            if (text.includes(searchText)) {
              findMatches.push({ slideIndex, elIndex, element: el });
            }
          }
        });
      });

      if (findMatches.length > 0) {
        currentMatchIndex = 0;
        highlightCurrentMatch();
        document.getElementById('findResults').textContent = `1 of ${findMatches.length}`;
      } else {
        document.getElementById('findResults').textContent = 'No matches';
        clearFindHighlights();
      }
    }

    function findNext() {
      if (findMatches.length === 0) {
        performFind();
        return;
      }

      currentMatchIndex = (currentMatchIndex + 1) % findMatches.length;
      highlightCurrentMatch();
      document.getElementById('findResults').textContent = `${currentMatchIndex + 1} of ${findMatches.length}`;
    }

    function findPrev() {
      if (findMatches.length === 0) return;

      currentMatchIndex = (currentMatchIndex - 1 + findMatches.length) % findMatches.length;
      highlightCurrentMatch();
      document.getElementById('findResults').textContent = `${currentMatchIndex + 1} of ${findMatches.length}`;
    }

    function highlightCurrentMatch() {
      if (currentMatchIndex < 0 || currentMatchIndex >= findMatches.length) return;

      const match = findMatches[currentMatchIndex];

      // Navigate to the slide if needed
      if (match.slideIndex !== currentSlideIndex) {
        selectSlide(match.slideIndex);
      }

      // Highlight the element
      setTimeout(() => {
        const element = document.getElementById(`element-${match.element.id}`);
        if (element) {
          // Remove previous highlights
          document.querySelectorAll('.highlight-find').forEach(el => {
            el.classList.remove('highlight-find');
          });

          element.classList.add('highlight-find');
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }

    function clearFindHighlights() {
      document.querySelectorAll('.highlight-find').forEach(el => {
        el.classList.remove('highlight-find');
      });
      findMatches = [];
      currentMatchIndex = -1;
    }

    function replaceCurrentMatch() {
      if (findMatches.length === 0 || currentMatchIndex < 0) {
        showToast('No match selected', 'error');
        return;
      }

      const searchText = document.getElementById('findInput').value.trim();
      const replaceText = document.getElementById('replaceInput').value;
      const matchCase = document.getElementById('findMatchCase').checked;

      if (!searchText) return;

      const match = findMatches[currentMatchIndex];
      const element = slides[match.slideIndex].elements[match.elIndex];

      if (element && element.type === 'text') {
        // Create regex for replacement
        const regex = new RegExp(escapeRegex(searchText), matchCase ? 'g' : 'gi');
        element.content = element.content.replace(regex, replaceText);

        // Re-render if on current slide
        if (match.slideIndex === currentSlideIndex) {
          renderCurrentSlide();
        }
        renderSlideThumbnails();

        // Remove this match and update
        findMatches.splice(currentMatchIndex, 1);
        if (findMatches.length === 0) {
          document.getElementById('findResults').textContent = 'All replaced';
          currentMatchIndex = -1;
        } else {
          currentMatchIndex = currentMatchIndex % findMatches.length;
          highlightCurrentMatch();
          document.getElementById('findResults').textContent = `${currentMatchIndex + 1} of ${findMatches.length}`;
        }

        showToast('Replaced', 'success');
      }
    }

    function replaceAllMatches() {
      const searchText = document.getElementById('findInput').value.trim();
      const replaceText = document.getElementById('replaceInput').value;
      const matchCase = document.getElementById('findMatchCase').checked;

      if (!searchText) {
        showToast('Enter text to find', 'error');
        return;
      }

      // Re-run find to get all matches
      performFind();
      if (findMatches.length === 0) {
        showToast('No matches found', 'info');
        return;
      }

      const regex = new RegExp(escapeRegex(searchText), matchCase ? 'g' : 'gi');
      let count = 0;

      // Replace in all slides
      slides.forEach(slide => {
        slide.elements.forEach(element => {
          if (element.type === 'text' && element.content) {
            const originalContent = element.content;
            element.content = element.content.replace(regex, replaceText);
            if (originalContent !== element.content) {
              count++;
            }
          }
        });
      });

      // Re-render
      renderCurrentSlide();
      renderSlideThumbnails();
      clearFindHighlights();
      document.getElementById('findResults').textContent = `Replaced ${count}`;
      showToast(`Replaced ${count} occurrence${count !== 1 ? 's' : ''}`, 'success');
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ========== SLIDE MASTER ==========

    function showSlideMaster() {
      // Load current master settings
      document.getElementById('masterBgColor').value = slideMaster.background.startsWith('#') ? slideMaster.background : '#ffffff';
      document.getElementById('masterBgGradient').value = slideMaster.background.startsWith('linear') ? slideMaster.background : '';
      document.getElementById('masterShowTitle').checked = slideMaster.showTitle;
      document.getElementById('masterShowSubtitle').checked = slideMaster.showSubtitle;
      document.getElementById('masterShowFooter').checked = slideMaster.showFooter;
      document.getElementById('masterFooterText').value = slideMaster.footerText;
      document.getElementById('masterShowPageNum').checked = slideMaster.showPageNum;
      document.getElementById('masterShowDate').checked = slideMaster.showDate;

      // Setup event listeners for preview
      document.getElementById('masterBgColor').onchange = updateMasterPreview;
      document.getElementById('masterBgGradient').onchange = updateMasterPreview;
      document.getElementById('masterShowTitle').onchange = updateMasterPreview;
      document.getElementById('masterShowSubtitle').onchange = updateMasterPreview;
      document.getElementById('masterShowFooter').onchange = () => {
        document.getElementById('footerTextGroup').style.display =
          document.getElementById('masterShowFooter').checked ? 'block' : 'none';
        updateMasterPreview();
      };
      document.getElementById('masterFooterText').oninput = updateMasterPreview;
      document.getElementById('masterShowPageNum').onchange = updateMasterPreview;
      document.getElementById('masterShowDate').onchange = updateMasterPreview;

      // Show/hide footer text input
      document.getElementById('footerTextGroup').style.display =
        slideMaster.showFooter ? 'block' : 'none';

      updateMasterPreview();
      document.getElementById('slideMasterModal').classList.add('active');
    }

    function hideSlideMaster() {
      document.getElementById('slideMasterModal').classList.remove('active');
    }

    function updateMasterPreview() {
      const preview = document.getElementById('masterPreview');
      const bgColor = document.getElementById('masterBgColor').value;
      const bgGradient = document.getElementById('masterBgGradient').value;
      const showTitle = document.getElementById('masterShowTitle').checked;
      const showSubtitle = document.getElementById('masterShowSubtitle').checked;
      const showFooter = document.getElementById('masterShowFooter').checked;
      const footerText = document.getElementById('masterFooterText').value;
      const showPageNum = document.getElementById('masterShowPageNum').checked;
      const showDate = document.getElementById('masterShowDate').checked;

      const bg = bgGradient || bgColor;
      const textColor = bgGradient && bgGradient.includes('dark') ? '#ffffff' : '#1a1a1a';

      let html = '';
      preview.style.background = bg;

      if (showTitle) {
        html += `<div style="position: absolute; top: 15%; left: 10%; width: 80%; text-align: center; font-size: 12px; font-weight: bold; color: ${textColor}; border-bottom: 1px dashed #ccc; padding-bottom: 4px;">Title Placeholder</div>`;
      }

      if (showSubtitle) {
        html += `<div style="position: absolute; top: 30%; left: 10%; width: 80%; text-align: center; font-size: 8px; color: ${textColor}; opacity: 0.7;">Subtitle Placeholder</div>`;
      }

      const footerParts = [];
      if (showDate) footerParts.push(new Date().toLocaleDateString());
      if (showFooter && footerText) footerParts.push(footerText);
      if (showPageNum) footerParts.push('Slide #');

      if (footerParts.length > 0) {
        html += `<div style="position: absolute; bottom: 5%; left: 10%; width: 80%; text-align: center; font-size: 6px; color: ${textColor}; opacity: 0.6;">${footerParts.join(' | ')}</div>`;
      }

      preview.innerHTML = html;
    }

    function getMasterSettings() {
      const bgGradient = document.getElementById('masterBgGradient').value;
      return {
        background: bgGradient || document.getElementById('masterBgColor').value,
        showTitle: document.getElementById('masterShowTitle').checked,
        showSubtitle: document.getElementById('masterShowSubtitle').checked,
        showFooter: document.getElementById('masterShowFooter').checked,
        footerText: document.getElementById('masterFooterText').value,
        showPageNum: document.getElementById('masterShowPageNum').checked,
        showDate: document.getElementById('masterShowDate').checked
      };
    }

    function applySlideMaster() {
      saveState();
      slideMaster = getMasterSettings();

      // Apply to all existing slides
      slides.forEach((slide, index) => {
        applyMasterToSlide(slide, index);
      });

      renderThumbnails();
      renderSlide();
      hideSlideMaster();
      showToast('Slide master applied to all slides', 'success');
    }

    function applySlideMasterToNew() {
      slideMaster = getMasterSettings();
      hideSlideMaster();
      showToast('Slide master will apply to new slides', 'success');
    }

    function applyMasterToSlide(slide, slideIndex) {
      // Set background
      slide.background = slideMaster.background;

      // Determine text color based on background
      const isDark = slideMaster.background.includes('dark') || slideMaster.background.includes('#1a1a');
      const textColor = isDark ? '#ffffff' : '#1a1a1a';
      const subtitleColor = isDark ? '#e0e0e0' : '#666666';

      // Remove existing master elements (footer, page number, date)
      slide.elements = slide.elements.filter(el =>
        !el.isMasterElement
      );

      // Add footer elements
      const footerParts = [];
      if (slideMaster.showDate) {
        footerParts.push(new Date().toLocaleDateString());
      }
      if (slideMaster.showFooter && slideMaster.footerText) {
        footerParts.push(slideMaster.footerText);
      }
      if (slideMaster.showPageNum) {
        footerParts.push(`Slide ${slideIndex + 1}`);
      }

      if (footerParts.length > 0) {
        slide.elements.push({
          id: ++elementIdCounter,
          type: 'text',
          x: 40,
          y: 500,
          width: 880,
          height: 30,
          content: footerParts.join(' | '),
          style: {
            fontSize: '12px',
            fontWeight: 'normal',
            fontFamily: 'Arial',
            color: subtitleColor,
            textAlign: 'center'
          },
          animation: null,
          isMasterElement: true
        });
      }
    }

    // ========== VIEW FEATURES ==========

    function toggleGrid() {
      showGrid = !showGrid;
      const canvas = document.getElementById('slideCanvas');
      canvas.classList.toggle('show-grid', showGrid);
      document.getElementById('gridBtn').textContent = showGrid ? 'âŠž Hide Grid' : 'âŠž Show Grid';
      showToast(showGrid ? 'Grid shown' : 'Grid hidden', 'info');
    }

    function toggleGuides() {
      showGuides = !showGuides;
      const canvas = document.getElementById('slideCanvas');
      canvas.classList.toggle('show-guides', showGuides);
      document.getElementById('guidesBtn').textContent = showGuides ? 'â”¼ Hide Guides' : 'â”¼ Show Guides';
      showToast(showGuides ? 'Guides shown' : 'Guides hidden', 'info');
    }

    function toggleSnapToGrid() {
      snapToGrid = !snapToGrid;
      document.getElementById('snapBtn').textContent = snapToGrid ? 'âŒ– Snap On' : 'âŒ– Snap Off';
      showToast(snapToGrid ? 'Snap to grid enabled' : 'Snap to grid disabled', 'info');
    }

    function toggleSmartGuides() {
      smartGuidesEnabled = !smartGuidesEnabled;
      const btn = document.getElementById('smartGuidesBtn');
      btn.style.background = smartGuidesEnabled ? '#e8f0fe' : '';
      btn.textContent = smartGuidesEnabled ? 'ðŸ“ Smart Guides' : 'ðŸ“ No Guides';
      showToast(smartGuidesEnabled ? 'Smart alignment guides enabled' : 'Smart alignment guides disabled', 'info');
    }

    function toggleRulers() {
      showRulers = !showRulers;
      document.querySelector('.slide-rulers')?.classList.toggle('show', showRulers);
      document.getElementById('rulersBtn').textContent = showRulers ? 'ðŸ“ Hide Rulers' : 'ðŸ“ Rulers';
      showToast(showRulers ? 'Rulers shown' : 'Rulers hidden', 'info');
    }

    // Snap to grid helper
    function snapPosition(value) {
      if (!snapToGrid) return value;
      const gridSize = 20;
      return Math.round(value / gridSize) * gridSize;
    }

    // ========== SLIDE SORTER ==========

    function showSlideSorter() {
      sorterOrder = slides.map((_, i) => i);
      sorterSelectedSlide = -1;
      renderSorterGrid();
      document.getElementById('slideSorterModal').classList.add('active');
    }

    function hideSlideSorter() {
      document.getElementById('slideSorterModal').classList.remove('active');
    }

    function renderSorterGrid() {
      const grid = document.getElementById('slideSorterGrid');
      grid.innerHTML = sorterOrder.map((slideIdx, displayIdx) => {
        const slide = slides[slideIdx];
        const isSelected = sorterSelectedSlide === displayIdx;
        return `
          <div class="sorter-slide ${isSelected ? 'selected' : ''}"
               draggable="true"
               ondragstart="dragSorterSlide(event, ${displayIdx})"
               ondragover="event.preventDefault()"
               ondrop="dropSorterSlide(event, ${displayIdx})"
               onclick="selectSorterSlide(${displayIdx})"
               style="background: ${slide.background};">
            <span class="sorter-slide-num">${slideIdx + 1}</span>
          </div>
        `;
      }).join('');
    }

    function selectSorterSlide(idx) {
      sorterSelectedSlide = sorterSelectedSlide === idx ? -1 : idx;
      renderSorterGrid();
    }

    function dragSorterSlide(e, idx) {
      e.dataTransfer.setData('text/plain', idx);
    }

    function dropSorterSlide(e, targetIdx) {
      e.preventDefault();
      const sourceIdx = parseInt(e.dataTransfer.getData('text/plain'));
      if (sourceIdx === targetIdx) return;

      const [removed] = sorterOrder.splice(sourceIdx, 1);
      sorterOrder.splice(targetIdx, 0, removed);
      renderSorterGrid();
    }

    function deleteSelectedSorterSlide() {
      if (sorterSelectedSlide < 0 || sorterOrder.length <= 1) {
        showToast('Select a slide to delete', 'warning');
        return;
      }
      sorterOrder.splice(sorterSelectedSlide, 1);
      sorterSelectedSlide = -1;
      renderSorterGrid();
      showToast('Slide marked for deletion', 'info');
    }

    function applySorterOrder() {
      saveState();
      const newSlides = sorterOrder.map(idx => slides[idx]);
      slides = newSlides;
      currentSlideIndex = 0;
      renderThumbnails();
      renderSlide();
      hideSlideSorter();
      showToast('Slide order updated', 'success');
    }

    // ========== OUTLINE VIEW ==========

    function showOutlineView() {
      const content = document.getElementById('outlineContent');
      content.innerHTML = slides.map((slide, idx) => {
        const texts = slide.elements
          .filter(el => el.type === 'text')
          .map(el => `<div style="margin-left: 1.5rem; color: var(--secondary); font-size: 0.9rem;">${el.content}</div>`)
          .join('');
        return `
          <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;" onclick="goToSlideFromOutline(${idx})">
            <div style="font-weight: bold; color: var(--primary);">Slide ${idx + 1}</div>
            ${texts || '<div style="margin-left: 1.5rem; color: #999; font-style: italic;">No text content</div>'}
          </div>
        `;
      }).join('');
      document.getElementById('outlineViewModal').classList.add('active');
    }

    function hideOutlineView() {
      document.getElementById('outlineViewModal').classList.remove('active');
    }

    function goToSlideFromOutline(idx) {
      hideOutlineView();
      selectSlide(idx);
    }

    // ========== NOTES PAGE VIEW ==========

    let notesPageIndex = 0;

    function showNotesPage() {
      notesPageIndex = currentSlideIndex;
      renderNotesPage();
      document.getElementById('notesPageModal').classList.add('active');
    }

    function hideNotesPage() {
      document.getElementById('notesPageModal').classList.remove('active');
    }

    function renderNotesPage() {
      document.getElementById('notesSlideNum').textContent = notesPageIndex + 1;
      const slide = slides[notesPageIndex];

      // Render mini preview
      const preview = document.getElementById('notesSlidePreview');
      preview.style.background = slide.background;
      preview.innerHTML = '<div style="padding: 10%; font-size: 10px; text-align: center; color: #666;">Slide ' + (notesPageIndex + 1) + '</div>';

      // Load notes
      document.getElementById('notesPageEditor').value = slide.speakerNotes || '';
    }

    function saveNotesFromPage() {
      slides[notesPageIndex].speakerNotes = document.getElementById('notesPageEditor').value;
    }

    function prevNotesPage() {
      if (notesPageIndex > 0) {
        saveNotesFromPage();
        notesPageIndex--;
        renderNotesPage();
      }
    }

    function nextNotesPage() {
      if (notesPageIndex < slides.length - 1) {
        saveNotesFromPage();
        notesPageIndex++;
        renderNotesPage();
      }
    }

    // Initialize
    function init() {
      // Create first slide
      addSlide();
      selectSlide(0);
      setupKeyboardShortcuts();
      updateHistoryButtons();
    }

    // Slide Management
    function addSlide() {
      saveState();
      const slide = {
        id: Date.now(),
        background: '#ffffff',
        transition: 'fade',
        transitionDuration: 0.5,
        elements: [],
        speakerNotes: ''
      };

      // Add default title if first slide or empty
      if (slides.length === 0) {
        slide.elements.push({
          id: ++elementIdCounter,
          type: 'text',
          x: 80,
          y: 120,
          width: 800,
          height: 80,
          content: 'Click to add title',
          style: {
            fontSize: '48px',
            fontWeight: 'bold',
            fontFamily: 'Arial',
            color: '#1a1a1a',
            textAlign: 'center'
          },
          animation: null
        });

        slide.elements.push({
          id: ++elementIdCounter,
          type: 'text',
          x: 80,
          y: 220,
          width: 800,
          height: 50,
          content: 'Click to add subtitle',
          style: {
            fontSize: '24px',
            fontFamily: 'Arial',
            color: '#666666',
            textAlign: 'center'
          },
          animation: null
        });
      }

      slides.push(slide);
      currentSlideIndex = slides.length - 1;
      renderThumbnails();
      renderSlide();
      updateStatusBar();
    }

    function duplicateSlide() {
      saveState();
      const current = slides[currentSlideIndex];
      const duplicate = JSON.parse(JSON.stringify(current));
      duplicate.id = Date.now();
      duplicate.elements.forEach(el => el.id = ++elementIdCounter);

      slides.splice(currentSlideIndex + 1, 0, duplicate);
      currentSlideIndex++;
      renderThumbnails();
      renderSlide();
      updateStatusBar();
      showToast('Slide duplicated', 'success');
    }

    // Slide clipboard
    let slideClipboard = null;

    function copySlide() {
      const current = slides[currentSlideIndex];
      slideClipboard = JSON.parse(JSON.stringify(current));
      showToast('Slide copied to clipboard', 'success');
    }

    function pasteSlide() {
      if (!slideClipboard) {
        showToast('No slide in clipboard. Copy a slide first.', 'warning');
        return;
      }

      saveState();
      const newSlide = JSON.parse(JSON.stringify(slideClipboard));
      newSlide.id = Date.now();
      newSlide.elements.forEach(el => el.id = ++elementIdCounter);

      // Insert after current slide
      slides.splice(currentSlideIndex + 1, 0, newSlide);
      currentSlideIndex++;

      renderThumbnails();
      renderSlide();
      updateStatusBar();
      showToast('Slide pasted', 'success');
    }

    function moveSlideUp() {
      if (currentSlideIndex === 0) {
        showToast('Already at the first slide', 'warning');
        return;
      }

      saveState();
      // Swap current slide with previous
      const temp = slides[currentSlideIndex];
      slides[currentSlideIndex] = slides[currentSlideIndex - 1];
      slides[currentSlideIndex - 1] = temp;

      currentSlideIndex--;
      renderThumbnails();
      renderSlide();
      updateStatusBar();
      showToast('Slide moved up', 'success');
    }

    function moveSlideDown() {
      if (currentSlideIndex === slides.length - 1) {
        showToast('Already at the last slide', 'warning');
        return;
      }

      saveState();
      // Swap current slide with next
      const temp = slides[currentSlideIndex];
      slides[currentSlideIndex] = slides[currentSlideIndex + 1];
      slides[currentSlideIndex + 1] = temp;

      currentSlideIndex++;
      renderThumbnails();
      renderSlide();
      updateStatusBar();
      showToast('Slide moved down', 'success');
    }

    function clearSlideElements() {
      if (slides[currentSlideIndex].elements.length === 0) {
        showToast('Slide is already empty', 'info');
        return;
      }

      if (!confirm('Remove all elements from this slide?')) return;

      saveState();
      slides[currentSlideIndex].elements = [];
      selectedElement = null;
      renderSlide();
      renderThumbnails();
      updateStatusBar();
      showToast('Slide cleared', 'success');
    }

    // Icon/Emoji Picker
    const iconCategories = {
      faces: 'ðŸ˜€ðŸ˜ƒðŸ˜„ðŸ˜ðŸ˜†ðŸ˜…ðŸ¤£ðŸ˜‚ðŸ™‚ðŸ™ƒðŸ˜‰ðŸ˜ŠðŸ˜‡ðŸ¥°ðŸ˜ðŸ¤©ðŸ˜˜ðŸ˜—â˜ºðŸ˜šðŸ˜™ðŸ¥²ðŸ˜‹ðŸ˜›ðŸ˜œðŸ¤ªðŸ˜ðŸ¤‘ðŸ¤—ðŸ¤­ðŸ¤«ðŸ¤”ðŸ¤ðŸ¤¨ðŸ˜ðŸ˜‘ðŸ˜¶ðŸ˜ðŸ˜’ðŸ™„ðŸ˜¬ðŸ¤¥ðŸ˜ŒðŸ˜”ðŸ˜ªðŸ¤¤ðŸ˜´ðŸ˜·ðŸ¤’ðŸ¤•ðŸ¤¢ðŸ¤®ðŸ¤§ðŸ¥µðŸ¥¶ðŸ¥´ðŸ˜µðŸ¤¯ðŸ¤ ðŸ¥³ðŸ¥¸ðŸ˜ŽðŸ¤“ðŸ§ðŸ˜•ðŸ˜ŸðŸ™â˜¹ðŸ˜®ðŸ˜¯ðŸ˜²ðŸ˜³ðŸ¥ºðŸ˜¦ðŸ˜§ðŸ˜¨ðŸ˜°ðŸ˜¥ðŸ˜¢ðŸ˜­ðŸ˜±ðŸ˜–ðŸ˜£ðŸ˜žðŸ˜“ðŸ˜©ðŸ˜«ðŸ¥±ðŸ˜¤ðŸ˜¡ðŸ˜ ðŸ¤¬',
      objects: 'ðŸ“±ðŸ’»ðŸ–¥ðŸ–¨âŒ¨ðŸ–±ðŸ–²ðŸ’¾ðŸ’¿ðŸ“€ðŸŽ¥ðŸ“·ðŸ“¸ðŸ“¹ðŸŽ¬ðŸ“ºðŸ“»ðŸŽ™ðŸŽšðŸŽ›ðŸ§­â°â²â±ðŸ•°ðŸ“¡ðŸ”‹ðŸ”ŒðŸ’¡ðŸ”¦ðŸ•¯ðŸ§¯ðŸ›¢ðŸ’¸ðŸ’µðŸ’´ðŸ’¶ðŸ’·ðŸ’°ðŸ’³ðŸ’Žâš–ðŸ”§ðŸ”¨âš’ðŸ› âš™ðŸ”©âš—ðŸ§ªðŸ§«ðŸ§¬ðŸ”¬ðŸ”­ðŸ“¡ðŸ©ºðŸ’ŠðŸ’‰ðŸ©¹ðŸ©¼ðŸšªðŸ›ðŸ›‹ðŸª‘ðŸš¿ðŸ›ðŸ§´ðŸ§·ðŸ§¹ðŸ§ºðŸ§»ðŸ§¼ðŸª¥ðŸ§½ðŸª£ðŸ§°ðŸª¤ðŸ“¦',
      symbols: 'â¤ðŸ§¡ðŸ’›ðŸ’šðŸ’™ðŸ’œðŸ–¤ðŸ¤ðŸ¤ŽðŸ’”â£ðŸ’•ðŸ’žðŸ’“ðŸ’—ðŸ’–ðŸ’˜ðŸ’â­ðŸŒŸâœ¨ðŸ’«ðŸ”¥ðŸ’¥ðŸ’¢ðŸ’¦ðŸ’¨ðŸ•³ðŸ’£ðŸ’¬ðŸ‘â€ðŸ—¨ðŸ—¨ðŸ—¯ðŸ’­ðŸ’¤ðŸŽµðŸŽ¶âž•âž–âœ–âž—ðŸ’²ðŸ’±â„¢Â©Â®ðŸ‘ðŸ“›ðŸ”°â­•âœ…â˜‘âœ”âŒâŽâž°âž¿ã€½âœ³âœ´â‡â€¼â‰â“â”â•â—ã€°ðŸ”…ðŸ”†âš ðŸš¸ðŸ”±âšœðŸ”°â™»âœâ˜ªðŸ•‰â˜¸âœ¡ðŸ”¯â˜¯â˜¦ðŸ›â›Žâ™ˆâ™‰â™Šâ™‹â™Œâ™â™Žâ™â™â™‘â™’â™“ðŸ†”âš›ðŸ‰‘â˜¢â˜£ðŸ“´ðŸ“³ðŸˆ¶ðŸˆšðŸˆ¸ðŸˆºðŸˆ·âœ´ðŸ†šðŸ’®ðŸ‰ãŠ™ãŠ—ðŸˆ´ðŸˆµðŸˆ¹ðŸˆ²ðŸ…°ðŸ…±ðŸ†ŽðŸ†‘ðŸ…¾ðŸ†˜âŒâ­•ðŸ›‘â›”ðŸ“›ðŸš«ðŸ’¯ðŸ’¢â™¨ðŸš·ðŸš¯ðŸš³ðŸš±ðŸ”žðŸ“µðŸš­',
      arrows: 'âž¡â¬…â¬†â¬‡â†—â†˜â†™â†–â†•â†”â†©â†ªâ¤´â¤µðŸ”ƒðŸ”„ðŸ”™ðŸ”šðŸ”›ðŸ”œðŸ”â–¶â©â­â¯â—€âªâ®ðŸ”¼â«ðŸ”½â¬â¸â¹âºâðŸŽ¦ðŸ”€ðŸ”ðŸ”‚',
      business: 'ðŸ’¼ðŸ“ðŸ“‚ðŸ—‚ðŸ“…ðŸ“†ðŸ—’ðŸ—“ðŸ“‡ðŸ“ˆðŸ“‰ðŸ“ŠðŸ“‹ðŸ“ŒðŸ“ðŸ“ŽðŸ–‡ðŸ“ðŸ“âœ‚ðŸ—ƒðŸ—„ðŸ—‘ðŸ”’ðŸ”“ðŸ”ðŸ”ðŸ”‘ðŸ—ðŸ›¡ðŸ“§ðŸ“¨ðŸ“©ðŸ“¤ðŸ“¥ðŸ“¦ðŸ“«ðŸ“ªðŸ“¬ðŸ“­ðŸ“®âœ‰ðŸ’ŒðŸ“ðŸ“ƒðŸ“„ðŸ“‘ðŸ§¾ðŸ“°ðŸ—žðŸ““ðŸ“’ðŸ“šðŸ“–ðŸ”–ðŸ§·ðŸ”—ðŸ“âœâœ’ðŸ–‹ðŸ–ŠðŸ–ŒðŸ–ðŸ“'
    };
    let currentIconCategory = 'faces';

    function showIconPicker() {
      document.getElementById('iconPickerModal').style.display = 'flex';
      document.getElementById('iconSearch').value = '';
      renderIconGrid();
    }

    function hideIconPicker() {
      document.getElementById('iconPickerModal').style.display = 'none';
    }

    function setIconCategory(category) {
      currentIconCategory = category;
      document.querySelectorAll('.icon-cat').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('iconSearch').value = '';
      renderIconGrid();
    }

    function renderIconGrid() {
      const grid = document.getElementById('iconGrid');
      const icons = [...iconCategories[currentIconCategory]];
      grid.innerHTML = icons.map(icon =>
        `<button style="font-size: 24px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: white; cursor: pointer;" onclick="insertIcon('${icon}')" title="Click to insert">${icon}</button>`
      ).join('');
    }

    function filterIcons() {
      const search = document.getElementById('iconSearch').value.toLowerCase();
      if (!search) {
        renderIconGrid();
        return;
      }

      // Search all categories
      const allIcons = Object.values(iconCategories).join('');
      const grid = document.getElementById('iconGrid');
      const icons = [...allIcons];
      grid.innerHTML = icons.map(icon =>
        `<button style="font-size: 24px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: white; cursor: pointer;" onclick="insertIcon('${icon}')" title="Click to insert">${icon}</button>`
      ).join('');
    }

    function insertIcon(icon) {
      const size = document.getElementById('iconSize').value;
      saveState();

      const newElement = {
        id: ++elementIdCounter,
        type: 'text',
        x: 400,
        y: 250,
        width: parseInt(size) + 20,
        height: parseInt(size) + 20,
        content: icon,
        style: {
          fontSize: size + 'px',
          fontFamily: 'Arial',
          fontWeight: 'normal',
          color: '#000000',
          textAlign: 'center'
        }
      };

      slides[currentSlideIndex].elements.push(newElement);
      selectedElement = newElement;
      renderSlide();
      renderThumbnails();
      hideIconPicker();
      showToast('Icon inserted', 'success');
    }

    function deleteSlide() {
      if (slides.length <= 1) {
        showToast('Cannot delete the only slide', 'warning');
        return;
      }

      saveState();
      slides.splice(currentSlideIndex, 1);
      if (currentSlideIndex >= slides.length) {
        currentSlideIndex = slides.length - 1;
      }
      renderThumbnails();
      renderSlide();
      updateStatusBar();
      showToast('Slide deleted', 'success');
    }

    function selectSlide(index) {
      // Save current speaker notes
      if (slides[currentSlideIndex]) {
        slides[currentSlideIndex].speakerNotes = document.getElementById('speakerNotes').value;
      }

      currentSlideIndex = index;
      renderSlide();
      renderThumbnails();
      updateStatusBar();

      // Load speaker notes
      document.getElementById('speakerNotes').value = slides[currentSlideIndex].speakerNotes || '';
    }

    function renderThumbnails() {
      const container = document.getElementById('slideThumbnails');
      container.innerHTML = slides.map((slide, index) => `
        <div class="slide-thumbnail ${index === currentSlideIndex ? 'active' : ''}"
             onclick="selectSlide(${index})"
             style="background: ${slide.background};">
          <div class="slide-thumbnail-inner">
            ${slide.elements.map(el => {
              if (el.type === 'text') {
                return `<div style="font-size: 4px; position: absolute; left: ${el.x / 10}px; top: ${el.y / 10}px;">${el.content.substring(0, 20)}</div>`;
              }
              return '';
            }).join('')}
          </div>
          <span class="slide-number">${index + 1}</span>
        </div>
      `).join('');
    }

    function getElementTransform(el) {
      let styles = [];
      let transforms = [];
      if (el.rotation) transforms.push(`rotate(${el.rotation}deg)`);
      if (el.flipH) transforms.push('scaleX(-1)');
      if (el.flipV) transforms.push('scaleY(-1)');
      if (transforms.length > 0) styles.push(`transform: ${transforms.join(' ')}`);
      if (el.opacity !== undefined && el.opacity !== 1) styles.push(`opacity: ${el.opacity}`);
      if (el.shadow) styles.push('box-shadow: 4px 4px 12px rgba(0,0,0,0.3)');
      if (el.border) styles.push(`border: ${el.border}`);
      if (el.borderRadius) styles.push(`border-radius: ${el.borderRadius}`);
      if (el.textShadow) styles.push(`text-shadow: ${el.textShadow}`);
      return styles.length > 0 ? styles.join('; ') + ';' : '';
    }

    function renderSlide() {
      const canvas = document.getElementById('slideCanvas');
      const slide = slides[currentSlideIndex];

      canvas.style.background = slide.background;

      let elementsHtml = '';
      slide.elements.forEach(el => {
        const transformStyle = getElementTransform(el);
        const isMultiSelected = selectedElements.includes(el.id);
        const isLocked = el.locked ? 'locked' : '';
        if (el.type === 'text') {
          elementsHtml += `
            <div class="slide-element ${selectedElement?.id === el.id ? 'selected' : ''} ${isMultiSelected ? 'multi-selected' : ''} ${isLocked}"
                 id="element-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; min-height: ${el.height}px;
                        font-size: ${el.style.fontSize}; font-weight: ${el.style.fontWeight || 'normal'};
                        font-family: ${el.style.fontFamily}; color: ${el.style.color};
                        font-style: ${el.style.fontStyle || 'normal'}; text-decoration: ${el.style.textDecoration || 'none'};
                        text-align: ${el.style.textAlign || 'left'}; background: ${el.style.background || 'transparent'};
                        padding: 8px; border-radius: 4px; ${transformStyle}"
                 onclick="toggleElementSelection(event, ${el.id})"
                 ondblclick="editElement(${el.id})"
                 onmousedown="startDrag(event, ${el.id})"
                 contenteditable="false">
              ${el.content}
              ${selectedElement?.id === el.id ? '<div class="resize-handle se"></div>' : ''}
            </div>
          `;
        } else if (el.type === 'shape') {
          elementsHtml += `
            <div class="slide-element ${selectedElement?.id === el.id ? 'selected' : ''} ${isMultiSelected ? 'multi-selected' : ''} ${isLocked}"
                 id="element-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px;
                        background: ${el.style.background}; border-radius: ${el.shape === 'circle' ? '50%' : el.shape === 'triangle' ? '0' : '4px'};
                        ${el.shape === 'triangle' ? 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);' : ''} ${transformStyle}"
                 onclick="toggleElementSelection(event, ${el.id})"
                 onmousedown="startDrag(event, ${el.id})">
              ${selectedElement?.id === el.id ? '<div class="resize-handle se"></div>' : ''}
            </div>
          `;
        } else if (el.type === 'image') {
          elementsHtml += `
            <div class="slide-element ${selectedElement?.id === el.id ? 'selected' : ''} ${isMultiSelected ? 'multi-selected' : ''} ${isLocked}"
                 id="element-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px; ${transformStyle}"
                 onclick="toggleElementSelection(event, ${el.id})"
                 onmousedown="startDrag(event, ${el.id})">
              <img src="${el.src}" style="width: 100%; height: 100%; object-fit: contain;">
              ${selectedElement?.id === el.id ? '<div class="resize-handle se"></div>' : ''}
            </div>
          `;
        } else if (el.type === 'video') {
          elementsHtml += `
            <div class="slide-element media-container ${selectedElement?.id === el.id ? 'selected' : ''} ${isMultiSelected ? 'multi-selected' : ''} ${isLocked}"
                 id="element-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px; ${transformStyle}"
                 onclick="toggleElementSelection(event, ${el.id})"
                 onmousedown="startDrag(event, ${el.id})">
              <video src="${el.src}" controls style="width: 100%; height: 100%;"></video>
              ${selectedElement?.id === el.id ? '<div class="resize-handle se"></div>' : ''}
            </div>
          `;
        } else if (el.type === 'chart') {
          const chartCanvasId = 'chartCanvas-' + el.id;
          elementsHtml += `
            <div class="slide-element ${selectedElement?.id === el.id ? 'selected' : ''}"
                 id="element-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.w}px; height: ${el.h}px; background: white; border-radius: 4px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); ${transformStyle}"
                 onclick="selectElement(event, '${el.id}')"
                 onmousedown="startDrag(event, '${el.id}')">
              <canvas id="${chartCanvasId}" width="${el.w - 20}" height="${el.h - 20}"></canvas>
              ${selectedElement?.id === el.id ? '<div class="resize-handle se"></div>' : ''}
            </div>
          `;
        } else if (el.type === 'group') {
          // Render group with all children inside
          let childrenHtml = '';
          el.children.forEach(child => {
            const childTransform = getElementTransform(child);
            if (child.type === 'text') {
              childrenHtml += `
                <div style="position: absolute; left: ${child.x}px; top: ${child.y}px; width: ${child.width}px; height: ${child.height}px;
                           font-size: ${child.style.fontSize}; color: ${child.style.color}; text-align: ${child.style.textAlign};
                           font-weight: ${child.style.bold ? 'bold' : 'normal'}; font-style: ${child.style.italic ? 'italic' : 'normal'};
                           text-decoration: ${child.style.underline ? 'underline' : 'none'}; ${childTransform}">
                  ${child.content}
                </div>
              `;
            } else if (child.type === 'shape') {
              childrenHtml += `
                <div style="position: absolute; left: ${child.x}px; top: ${child.y}px; width: ${child.width}px; height: ${child.height}px;
                           background: ${child.style.background}; border-radius: ${child.shape === 'circle' ? '50%' : child.shape === 'triangle' ? '0' : '4px'};
                           ${child.shape === 'triangle' ? 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);' : ''} ${childTransform}">
                </div>
              `;
            } else if (child.type === 'image') {
              childrenHtml += `
                <div style="position: absolute; left: ${child.x}px; top: ${child.y}px; width: ${child.width}px; height: ${child.height}px; ${childTransform}">
                  <img src="${child.src}" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
              `;
            }
          });

          const isSelected = selectedElement?.id === el.id;
          const isMultiSelected = selectedElements.includes(el.id);
          elementsHtml += `
            <div class="slide-element ${isSelected ? 'selected' : ''} ${isMultiSelected ? 'multi-selected' : ''}"
                 id="element-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px;
                        border: 2px dashed ${isSelected ? '#1a73e8' : '#999'}; background: rgba(0,0,0,0.02); ${transformStyle}"
                 onclick="toggleElementSelection(event, '${el.id}')"
                 onmousedown="startDrag(event, '${el.id}')">
              ${childrenHtml}
              ${isSelected ? '<div class="resize-handle se"></div>' : ''}
              <div style="position: absolute; top: -20px; left: 0; font-size: 10px; color: #666; background: white; padding: 2px 4px; border-radius: 2px;">Group (${el.children.length})</div>
            </div>
          `;
        }
      });

      canvas.innerHTML = elementsHtml;

      // Render charts after DOM update
      slide.elements.forEach(el => {
        if (el.type === 'chart') {
          renderChartElement(el);
        }
      });
      updateAnimationList();
      updateStatusBar();
    }

    function updateStatusBar() {
      const slide = slides[currentSlideIndex];
      document.getElementById('currentSlideNum').textContent = currentSlideIndex + 1;
      document.getElementById('totalSlides').textContent = slides.length;
      document.getElementById('elementCount').textContent = slide.elements.length;

      // Capitalize transition name
      const transName = slide.transition || 'none';
      document.getElementById('currentTransition').textContent =
        transName.charAt(0).toUpperCase() + transName.slice(1);
    }

    // Element Management
    function addText() {
      saveState();
      const slide = slides[currentSlideIndex];
      const element = {
        id: ++elementIdCounter,
        type: 'text',
        x: 100,
        y: 200,
        width: 400,
        height: 60,
        content: 'Click to edit text',
        style: {
          fontSize: '24px',
          fontWeight: 'normal',
          fontFamily: 'Arial',
          color: '#1a1a1a',
          textAlign: 'left'
        },
        animation: null
      };

      slide.elements.push(element);
      renderSlide();
      selectElement(null, element.id);
      showToast('Text box added', 'success');
    }

    function addShape(shape) {
      saveState();
      const slide = slides[currentSlideIndex];
      const element = {
        id: ++elementIdCounter,
        type: 'shape',
        shape: shape,
        x: 100,
        y: 200,
        width: shape === 'arrow' ? 200 : 150,
        height: shape === 'arrow' ? 40 : 150,
        style: {
          background: '#4285f4'
        },
        animation: null
      };

      slide.elements.push(element);
      renderSlide();
      selectElement(null, element.id);
      showToast(`${shape} added`, 'success');
    }

    function insertImage() {
      const url = prompt('Enter image URL:');
      if (url) {
        const slide = slides[currentSlideIndex];
        const element = {
          id: ++elementIdCounter,
          type: 'image',
          x: 100,
          y: 150,
          width: 400,
          height: 300,
          src: url,
          animation: null
        };

        slide.elements.push(element);
        renderSlide();
        showToast('Image added', 'success');
      }
    }

    function insertVideo() {
      const url = prompt('Enter video URL (MP4, YouTube embed, etc.):');
      if (url) {
        const slide = slides[currentSlideIndex];
        const element = {
          id: ++elementIdCounter,
          type: 'video',
          x: 100,
          y: 150,
          width: 640,
          height: 360,
          src: url,
          animation: null
        };

        slide.elements.push(element);
        renderSlide();
        showToast('Video added', 'success');
      }
    }

    function insertAudio() {
      const url = prompt('Enter audio URL:');
      if (url) {
        showToast('Audio element added (plays during presentation)', 'success');
      }
    }

    function insertTable() {
      const rows = prompt('Number of rows:', '3');
      const cols = prompt('Number of columns:', '3');
      if (rows && cols) {
        addText();
        const el = slides[currentSlideIndex].elements[slides[currentSlideIndex].elements.length - 1];
        let table = '<table style="border-collapse: collapse; width: 100%;">';
        for (let i = 0; i < parseInt(rows); i++) {
          table += '<tr>';
          for (let j = 0; j < parseInt(cols); j++) {
            table += '<td style="border: 1px solid #ccc; padding: 8px;">Cell</td>';
          }
          table += '</tr>';
        }
        table += '</table>';
        el.content = table;
        el.width = 500;
        el.height = parseInt(rows) * 40 + 20;
        renderSlide();
      }
    }

    function insertChart() {
      showInsertChartModal();
    }

    function showInsertChartModal() {
      // Create chart modal if it doesn't exist
      if (!document.getElementById('chartInsertModal')) {
        const modal = document.createElement('div');
        modal.id = 'chartInsertModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
              <h3>ðŸ“Š Insert Chart</h3>
              <button class="modal-close" onclick="hideInsertChartModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Chart Type:</label>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                  <button class="btn btn-secondary chart-type-btn active" onclick="selectChartType('bar')" data-type="bar">ðŸ“Š Bar</button>
                  <button class="btn btn-secondary chart-type-btn" onclick="selectChartType('line')" data-type="line">ðŸ“ˆ Line</button>
                  <button class="btn btn-secondary chart-type-btn" onclick="selectChartType('pie')" data-type="pie">ðŸ¥§ Pie</button>
                  <button class="btn btn-secondary chart-type-btn" onclick="selectChartType('doughnut')" data-type="doughnut">ðŸ© Doughnut</button>
                </div>
              </div>
              <div class="form-group">
                <label>Chart Title:</label>
                <input type="text" class="form-control" id="chartTitle" value="My Chart">
              </div>
              <div class="form-group">
                <label>Data (comma-separated values per line):</label>
                <textarea class="form-control" id="chartData" rows="4" placeholder="Labels: Jan, Feb, Mar, Apr&#10;Sales: 100, 150, 120, 180&#10;Costs: 80, 90, 85, 110">Labels: Q1, Q2, Q3, Q4
Revenue: 100, 150, 120, 180
Expenses: 80, 90, 85, 110</textarea>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                  <label>Width:</label>
                  <input type="number" class="form-control" id="chartWidth" value="500" min="200" max="900">
                </div>
                <div class="form-group">
                  <label>Height:</label>
                  <input type="number" class="form-control" id="chartHeight" value="350" min="150" max="600">
                </div>
              </div>
              <div class="form-group">
                <label>Color Scheme:</label>
                <select class="form-control" id="chartColors">
                  <option value="default">Default (Blue/Red)</option>
                  <option value="pastel">Pastel</option>
                  <option value="vibrant">Vibrant</option>
                  <option value="monochrome">Monochrome Blue</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="hideInsertChartModal()">Cancel</button>
              <button class="btn btn-primary" onclick="createChartElement()">Insert Chart</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      document.getElementById('chartInsertModal').style.display = 'flex';
    }

    function hideInsertChartModal() {
      document.getElementById('chartInsertModal').style.display = 'none';
    }

    let selectedChartType = 'bar';

    function selectChartType(type) {
      selectedChartType = type;
      document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
    }

    function getChartColors(scheme) {
      const schemes = {
        default: ['rgba(54, 162, 235, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(255, 206, 86, 0.8)'],
        pastel: ['rgba(179, 205, 224, 0.8)', 'rgba(255, 200, 200, 0.8)', 'rgba(200, 230, 200, 0.8)', 'rgba(255, 230, 200, 0.8)'],
        vibrant: ['rgba(231, 76, 60, 0.8)', 'rgba(46, 204, 113, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(241, 196, 15, 0.8)'],
        monochrome: ['rgba(30, 136, 229, 0.9)', 'rgba(30, 136, 229, 0.7)', 'rgba(30, 136, 229, 0.5)', 'rgba(30, 136, 229, 0.3)']
      };
      return schemes[scheme] || schemes.default;
    }

    function createChartElement() {
      const title = document.getElementById('chartTitle').value || 'Chart';
      const dataText = document.getElementById('chartData').value;
      const width = parseInt(document.getElementById('chartWidth').value) || 500;
      const height = parseInt(document.getElementById('chartHeight').value) || 350;
      const colorScheme = document.getElementById('chartColors').value;

      // Parse data
      const lines = dataText.trim().split('\n');
      let labels = [];
      const datasets = [];
      const colors = getChartColors(colorScheme);

      lines.forEach((line, i) => {
        const [name, ...values] = line.split(':').map(s => s.trim());
        if (name.toLowerCase() === 'labels') {
          labels = values.join(':').split(',').map(v => v.trim());
        } else {
          const dataValues = values.join(':').split(',').map(v => parseFloat(v.trim()) || 0);
          datasets.push({
            label: name,
            data: dataValues,
            backgroundColor: selectedChartType === 'pie' || selectedChartType === 'doughnut'
              ? colors
              : colors[datasets.length % colors.length],
            borderColor: selectedChartType === 'line'
              ? colors[datasets.length % colors.length].replace('0.8', '1')
              : 'rgba(255,255,255,0.8)',
            borderWidth: 1,
            fill: selectedChartType === 'line' ? false : true
          });
        }
      });

      if (labels.length === 0) {
        labels = ['A', 'B', 'C', 'D'];
      }

      // Create chart element
      const slide = slides[currentSlideIndex];
      const chartId = 'chart-' + Date.now();

      const chartElement = {
        id: chartId,
        type: 'chart',
        chartType: selectedChartType,
        x: 100,
        y: 80,
        w: width,
        h: height,
        title: title,
        labels: labels,
        datasets: datasets,
        colorScheme: colorScheme
      };

      slide.elements.push(chartElement);
      renderSlide();
      hideInsertChartModal();
      showToast('Chart inserted', 'success');
    }

    function renderChartElement(el) {
      const canvasId = 'chartCanvas-' + el.id;
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;

      // Clear canvas
      ctx.clearRect(0, 0, w, h);

      // Draw title
      ctx.fillStyle = '#333';
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(el.title || 'Chart', w / 2, 25);

      const chartArea = {
        x: 60,
        y: 45,
        w: w - 80,
        h: h - 90
      };

      if (el.chartType === 'bar') {
        renderBarChart(ctx, el, chartArea);
      } else if (el.chartType === 'line') {
        renderLineChart(ctx, el, chartArea);
      } else if (el.chartType === 'pie' || el.chartType === 'doughnut') {
        renderPieChart(ctx, el, chartArea, el.chartType === 'doughnut');
      }

      // Draw legend
      const legendY = h - 25;
      let legendX = chartArea.x;
      ctx.font = '11px Arial';
      ctx.textAlign = 'left';

      el.datasets.forEach((ds, i) => {
        const color = Array.isArray(ds.backgroundColor) ? ds.backgroundColor[0] : ds.backgroundColor;
        ctx.fillStyle = color;
        ctx.fillRect(legendX, legendY - 8, 12, 12);
        ctx.fillStyle = '#333';
        ctx.fillText(ds.label, legendX + 16, legendY);
        legendX += ctx.measureText(ds.label).width + 35;
      });
    }

    function renderBarChart(ctx, el, area) {
      const labels = el.labels || [];
      const datasets = el.datasets || [];

      if (labels.length === 0 || datasets.length === 0) return;

      const barGroupWidth = area.w / labels.length;
      const barWidth = (barGroupWidth * 0.7) / datasets.length;
      const maxVal = Math.max(...datasets.flatMap(ds => ds.data));

      // Draw axes
      ctx.strokeStyle = '#ccc';
      ctx.beginPath();
      ctx.moveTo(area.x, area.y);
      ctx.lineTo(area.x, area.y + area.h);
      ctx.lineTo(area.x + area.w, area.y + area.h);
      ctx.stroke();

      // Draw bars
      labels.forEach((label, i) => {
        const groupX = area.x + i * barGroupWidth + barGroupWidth * 0.15;

        datasets.forEach((ds, j) => {
          const barH = (ds.data[i] / maxVal) * area.h;
          const barX = groupX + j * barWidth;
          const barY = area.y + area.h - barH;

          ctx.fillStyle = Array.isArray(ds.backgroundColor) ? ds.backgroundColor[i % ds.backgroundColor.length] : ds.backgroundColor;
          ctx.fillRect(barX, barY, barWidth - 2, barH);
        });

        // Label
        ctx.fillStyle = '#666';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label, area.x + i * barGroupWidth + barGroupWidth / 2, area.y + area.h + 15);
      });
    }

    function renderLineChart(ctx, el, area) {
      const labels = el.labels || [];
      const datasets = el.datasets || [];

      if (labels.length === 0 || datasets.length === 0) return;

      const maxVal = Math.max(...datasets.flatMap(ds => ds.data));
      const stepX = area.w / (labels.length - 1);

      // Draw axes
      ctx.strokeStyle = '#ccc';
      ctx.beginPath();
      ctx.moveTo(area.x, area.y);
      ctx.lineTo(area.x, area.y + area.h);
      ctx.lineTo(area.x + area.w, area.y + area.h);
      ctx.stroke();

      // Draw lines
      datasets.forEach((ds, j) => {
        ctx.strokeStyle = ds.borderColor || ds.backgroundColor;
        ctx.lineWidth = 2;
        ctx.beginPath();

        ds.data.forEach((val, i) => {
          const x = area.x + i * stepX;
          const y = area.y + area.h - (val / maxVal) * area.h;

          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });

        ctx.stroke();

        // Draw points
        ctx.fillStyle = ds.backgroundColor;
        ds.data.forEach((val, i) => {
          const x = area.x + i * stepX;
          const y = area.y + area.h - (val / maxVal) * area.h;
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
        });
      });

      // Labels
      ctx.fillStyle = '#666';
      ctx.font = '10px Arial';
      ctx.textAlign = 'center';
      labels.forEach((label, i) => {
        ctx.fillText(label, area.x + i * stepX, area.y + area.h + 15);
      });
    }

    function renderPieChart(ctx, el, area, isDoughnut) {
      const ds = el.datasets[0];
      if (!ds || !ds.data) return;

      const total = ds.data.reduce((a, b) => a + b, 0);
      const centerX = area.x + area.w / 2;
      const centerY = area.y + area.h / 2;
      const radius = Math.min(area.w, area.h) / 2 - 10;
      const innerRadius = isDoughnut ? radius * 0.5 : 0;

      let startAngle = -Math.PI / 2;

      ds.data.forEach((val, i) => {
        const sliceAngle = (val / total) * Math.PI * 2;
        const color = Array.isArray(ds.backgroundColor) ? ds.backgroundColor[i % ds.backgroundColor.length] : ds.backgroundColor;

        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();

        if (isDoughnut) {
          ctx.fillStyle = 'white';
          ctx.beginPath();
          ctx.arc(centerX, centerY, innerRadius, 0, Math.PI * 2);
          ctx.fill();
        }

        // Draw label
        const midAngle = startAngle + sliceAngle / 2;
        const labelRadius = radius * 0.7;
        const labelX = centerX + Math.cos(midAngle) * labelRadius;
        const labelY = centerY + Math.sin(midAngle) * labelRadius;

        ctx.fillStyle = '#fff';
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const percent = Math.round((val / total) * 100);
        if (percent > 5) ctx.fillText(percent + '%', labelX, labelY);

        startAngle += sliceAngle;
      });

      // Draw labels outside
      ctx.fillStyle = '#333';
      ctx.font = '10px Arial';
      ctx.textAlign = 'left';
      el.labels.forEach((label, i) => {
        const y = area.y + 10 + i * 14;
        const color = Array.isArray(ds.backgroundColor) ? ds.backgroundColor[i % ds.backgroundColor.length] : ds.backgroundColor;
        ctx.fillStyle = color;
        ctx.fillRect(area.x + area.w - 80, y - 8, 10, 10);
        ctx.fillStyle = '#333';
        ctx.fillText(label, area.x + area.w - 65, y);
      });
    }

    function selectElement(event, id) {
      if (event) event.stopPropagation();

      const slide = slides[currentSlideIndex];
      selectedElement = slide.elements.find(el => el.id === id);
      renderSlide();
      updateElementProps();
      updateShadowToggleButton();
      updateLockToggleButton();
    }

    function deselectAll(event) {
      if (event.target.id === 'slideCanvas') {
        selectedElement = null;
        renderSlide();
        updateElementProps();
        updateShadowToggleButton();
        updateLockToggleButton();
      }
    }

    function editElement(id) {
      // Check if element is locked
      const slide = slides[currentSlideIndex];
      const el = slide.elements.find(e => e.id === id);
      if (el && el.locked) {
        showToast('Element is locked. Unlock it to edit.', 'warning');
        return;
      }

      const element = document.getElementById(`element-${id}`);
      if (element) {
        element.contentEditable = 'true';
        element.classList.add('editing');
        element.focus();

        element.onblur = () => {
          element.contentEditable = 'false';
          element.classList.remove('editing');

          const slide = slides[currentSlideIndex];
          const el = slide.elements.find(e => e.id === id);
          if (el && el.type === 'text') {
            el.content = element.innerHTML;
          }
          renderThumbnails();
        };
      }
    }

    // Drag and Drop
    function startDrag(event, id) {
      if (event.target.classList.contains('resize-handle')) return;

      // Check if element is locked
      const slide = slides[currentSlideIndex];
      const el = slide.elements.find(e => e.id === id);
      if (el && el.locked) {
        showToast('Element is locked. Unlock it to move.', 'warning');
        return;
      }

      isDragging = true;
      selectElement(event, id);

      const element = document.getElementById(`element-${id}`);
      const rect = element.getBoundingClientRect();
      dragOffset.x = event.clientX - rect.left;
      dragOffset.y = event.clientY - rect.top;

      document.addEventListener('mousemove', handleDrag);
      document.addEventListener('mouseup', stopDrag);
    }

    function handleDrag(event) {
      if (!isDragging || !selectedElement) return;

      const canvas = document.getElementById('slideCanvas');
      const canvasRect = canvas.getBoundingClientRect();

      let x = event.clientX - canvasRect.left - dragOffset.x;
      let y = event.clientY - canvasRect.top - dragOffset.y;

      // Smart alignment guides
      const snapResult = checkSmartAlignmentGuides(x, y, selectedElement);
      x = snapResult.x;
      y = snapResult.y;

      selectedElement.x = Math.max(0, Math.min(x, 960 - selectedElement.width));
      selectedElement.y = Math.max(0, Math.min(y, 540 - selectedElement.height));

      const element = document.getElementById(`element-${selectedElement.id}`);
      element.style.left = selectedElement.x + 'px';
      element.style.top = selectedElement.y + 'px';
    }

    // Smart Alignment Guides
    const SNAP_THRESHOLD = 8;

    function checkSmartAlignmentGuides(x, y, draggedEl) {
      if (!smartGuidesEnabled) return { x, y };

      const slide = slides[currentSlideIndex];
      const canvas = document.getElementById('slideCanvas');

      // Remove existing guide lines
      canvas.querySelectorAll('.smart-guide').forEach(g => g.remove());

      let snappedX = x;
      let snappedY = y;
      const guides = [];

      // Dragged element bounds
      const draggedLeft = x;
      const draggedRight = x + draggedEl.width;
      const draggedTop = y;
      const draggedBottom = y + draggedEl.height;
      const draggedCenterX = x + draggedEl.width / 2;
      const draggedCenterY = y + draggedEl.height / 2;

      // Check alignment with other elements
      slide.elements.forEach(el => {
        if (el.id === draggedEl.id) return;

        const elLeft = el.x;
        const elRight = el.x + el.width;
        const elTop = el.y;
        const elBottom = el.y + el.height;
        const elCenterX = el.x + el.width / 2;
        const elCenterY = el.y + el.height / 2;

        // Horizontal alignments
        // Left edge alignment
        if (Math.abs(draggedLeft - elLeft) < SNAP_THRESHOLD) {
          snappedX = elLeft;
          guides.push({ type: 'v', pos: elLeft });
        }
        if (Math.abs(draggedLeft - elRight) < SNAP_THRESHOLD) {
          snappedX = elRight;
          guides.push({ type: 'v', pos: elRight });
        }
        // Right edge alignment
        if (Math.abs(draggedRight - elLeft) < SNAP_THRESHOLD) {
          snappedX = elLeft - draggedEl.width;
          guides.push({ type: 'v', pos: elLeft });
        }
        if (Math.abs(draggedRight - elRight) < SNAP_THRESHOLD) {
          snappedX = elRight - draggedEl.width;
          guides.push({ type: 'v', pos: elRight });
        }
        // Center X alignment
        if (Math.abs(draggedCenterX - elCenterX) < SNAP_THRESHOLD) {
          snappedX = elCenterX - draggedEl.width / 2;
          guides.push({ type: 'v', pos: elCenterX });
        }

        // Vertical alignments
        // Top edge alignment
        if (Math.abs(draggedTop - elTop) < SNAP_THRESHOLD) {
          snappedY = elTop;
          guides.push({ type: 'h', pos: elTop });
        }
        if (Math.abs(draggedTop - elBottom) < SNAP_THRESHOLD) {
          snappedY = elBottom;
          guides.push({ type: 'h', pos: elBottom });
        }
        // Bottom edge alignment
        if (Math.abs(draggedBottom - elTop) < SNAP_THRESHOLD) {
          snappedY = elTop - draggedEl.height;
          guides.push({ type: 'h', pos: elTop });
        }
        if (Math.abs(draggedBottom - elBottom) < SNAP_THRESHOLD) {
          snappedY = elBottom - draggedEl.height;
          guides.push({ type: 'h', pos: elBottom });
        }
        // Center Y alignment
        if (Math.abs(draggedCenterY - elCenterY) < SNAP_THRESHOLD) {
          snappedY = elCenterY - draggedEl.height / 2;
          guides.push({ type: 'h', pos: elCenterY });
        }
      });

      // Also check canvas center
      if (Math.abs(draggedCenterX - 480) < SNAP_THRESHOLD) {
        snappedX = 480 - draggedEl.width / 2;
        guides.push({ type: 'v', pos: 480 });
      }
      if (Math.abs(draggedCenterY - 270) < SNAP_THRESHOLD) {
        snappedY = 270 - draggedEl.height / 2;
        guides.push({ type: 'h', pos: 270 });
      }

      // Draw guide lines
      guides.forEach(guide => {
        const line = document.createElement('div');
        line.className = 'smart-guide';
        if (guide.type === 'v') {
          line.style.cssText = `
            position: absolute;
            left: ${guide.pos}px;
            top: 0;
            width: 1px;
            height: 100%;
            background: #ff6b6b;
            pointer-events: none;
            z-index: 1000;
          `;
        } else {
          line.style.cssText = `
            position: absolute;
            left: 0;
            top: ${guide.pos}px;
            width: 100%;
            height: 1px;
            background: #ff6b6b;
            pointer-events: none;
            z-index: 1000;
          `;
        }
        canvas.appendChild(line);
      });

      return { x: snappedX, y: snappedY };
    }

    function stopDrag() {
      isDragging = false;
      document.removeEventListener('mousemove', handleDrag);
      document.removeEventListener('mouseup', stopDrag);

      // Remove smart guides
      document.querySelectorAll('.smart-guide').forEach(g => g.remove());

      renderThumbnails();
    }

    // Formatting
    function formatText(prop, value) {
      if (!selectedElement || selectedElement.type !== 'text') return;

      if (prop === 'fontWeight') {
        selectedElement.style.fontWeight = selectedElement.style.fontWeight === 'bold' ? 'normal' : 'bold';
      } else if (prop === 'fontStyle') {
        selectedElement.style.fontStyle = selectedElement.style.fontStyle === 'italic' ? 'normal' : 'italic';
      } else if (prop === 'textDecoration') {
        selectedElement.style.textDecoration = selectedElement.style.textDecoration === 'underline' ? 'none' : 'underline';
      } else {
        selectedElement.style[prop] = value + (prop === 'fontSize' ? 'px' : '');
      }

      renderSlide();
    }

    function formatElement(prop, value) {
      if (!selectedElement) return;
      selectedElement.style[prop] = value;
      renderSlide();
    }

    function setElementOpacity(value) {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }
      selectedElement.opacity = parseFloat(value);
      renderSlide();
      showToast(`Opacity set to ${Math.round(value * 100)}%`, 'success');
    }

    function toggleTextShadow() {
      if (!selectedElement || selectedElement.type !== 'text') {
        showToast('Select a text element first', 'warning');
        return;
      }

      if (selectedElement.textShadow) {
        selectedElement.textShadow = null;
        document.getElementById('textShadowBtn').style.background = '';
        showToast('Text shadow removed', 'info');
      } else {
        selectedElement.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
        document.getElementById('textShadowBtn').style.background = '#e8f0fe';
        showToast('Text shadow added', 'success');
      }

      renderSlide();
    }

    function alignElement(align) {
      if (!selectedElement) return;

      const slideWidth = 960;
      const slideHeight = 540;
      const margin = 40;
      const elWidth = selectedElement.w || selectedElement.width || 100;
      const elHeight = selectedElement.h || selectedElement.height || 100;

      // Horizontal alignment
      if (align === 'left') selectedElement.x = margin;
      else if (align === 'center') selectedElement.x = (slideWidth - elWidth) / 2;
      else if (align === 'right') selectedElement.x = slideWidth - elWidth - margin;
      // Vertical alignment
      else if (align === 'top') selectedElement.y = margin;
      else if (align === 'middle') selectedElement.y = (slideHeight - elHeight) / 2;
      else if (align === 'bottom') selectedElement.y = slideHeight - elHeight - margin;

      renderSlide();
    }

    function distributeElements(direction) {
      const slide = slides[currentSlideIndex];
      if (!slide || slide.elements.length < 3) {
        showToast('Need at least 3 elements to distribute', 'warning');
        return;
      }

      const elements = slide.elements;
      const slideWidth = 960;
      const slideHeight = 540;
      const margin = 40;

      if (direction === 'horizontal') {
        // Sort elements by x position
        const sorted = [...elements].sort((a, b) => a.x - b.x);

        // Calculate total width of all elements
        let totalWidth = 0;
        sorted.forEach(el => {
          totalWidth += el.w || el.width || 100;
        });

        // Calculate available space and gap
        const availableSpace = slideWidth - (2 * margin) - totalWidth;
        const gap = availableSpace / (sorted.length - 1);

        // Position elements
        let currentX = margin;
        sorted.forEach((el, index) => {
          const elWidth = el.w || el.width || 100;
          // Find original element and update its position
          const originalEl = elements.find(e => e.id === el.id);
          if (originalEl) {
            originalEl.x = currentX;
          }
          currentX += elWidth + gap;
        });
      } else if (direction === 'vertical') {
        // Sort elements by y position
        const sorted = [...elements].sort((a, b) => a.y - b.y);

        // Calculate total height of all elements
        let totalHeight = 0;
        sorted.forEach(el => {
          totalHeight += el.h || el.height || 100;
        });

        // Calculate available space and gap
        const availableSpace = slideHeight - (2 * margin) - totalHeight;
        const gap = availableSpace / (sorted.length - 1);

        // Position elements
        let currentY = margin;
        sorted.forEach((el, index) => {
          const elHeight = el.h || el.height || 100;
          // Find original element and update its position
          const originalEl = elements.find(e => e.id === el.id);
          if (originalEl) {
            originalEl.y = currentY;
          }
          currentY += elHeight + gap;
        });
      }

      renderSlide();
    }

    function bringToFront() {
      if (!selectedElement) return;
      const slide = slides[currentSlideIndex];
      const index = slide.elements.findIndex(el => el.id === selectedElement.id);
      const [element] = slide.elements.splice(index, 1);
      slide.elements.push(element);
      renderSlide();
      showToast('Brought to front', 'info');
    }

    function sendToBack() {
      if (!selectedElement) return;
      const slide = slides[currentSlideIndex];
      const index = slide.elements.findIndex(el => el.id === selectedElement.id);
      const [element] = slide.elements.splice(index, 1);
      slide.elements.unshift(element);
      renderSlide();
      showToast('Sent to back', 'info');
    }

    function bringForward() {
      if (!selectedElement) return;
      const slide = slides[currentSlideIndex];
      const index = slide.elements.findIndex(el => el.id === selectedElement.id);

      // Already at front
      if (index === slide.elements.length - 1) {
        showToast('Already at front', 'info');
        return;
      }

      // Swap with next element
      const temp = slide.elements[index];
      slide.elements[index] = slide.elements[index + 1];
      slide.elements[index + 1] = temp;

      renderSlide();
      showToast('Brought forward', 'info');
    }

    function sendBackward() {
      if (!selectedElement) return;
      const slide = slides[currentSlideIndex];
      const index = slide.elements.findIndex(el => el.id === selectedElement.id);

      // Already at back
      if (index === 0) {
        showToast('Already at back', 'info');
        return;
      }

      // Swap with previous element
      const temp = slide.elements[index];
      slide.elements[index] = slide.elements[index - 1];
      slide.elements[index - 1] = temp;

      renderSlide();
      showToast('Sent backward', 'info');
    }

    function flipElement(direction) {
      if (!selectedElement) {
        showToast('Select an element to flip', 'warning');
        return;
      }

      // Initialize flip properties if not set
      if (!selectedElement.flipH) selectedElement.flipH = false;
      if (!selectedElement.flipV) selectedElement.flipV = false;

      if (direction === 'horizontal') {
        selectedElement.flipH = !selectedElement.flipH;
      } else if (direction === 'vertical') {
        selectedElement.flipV = !selectedElement.flipV;
      }

      renderSlide();
      showToast(`Flipped ${direction}`, 'success');
    }

    function rotateElement(degrees) {
      if (!selectedElement) {
        showToast('Select an element to rotate', 'warning');
        return;
      }

      // Initialize rotation if not set
      if (!selectedElement.rotation) selectedElement.rotation = 0;

      selectedElement.rotation = (selectedElement.rotation + degrees) % 360;
      renderSlide();
      showToast(`Rotated ${degrees}Â°`, 'success');
    }

    function duplicateElement() {
      if (!selectedElement) {
        showToast('Select an element to duplicate', 'warning');
        return;
      }

      const slide = slides[currentSlideIndex];

      // Deep clone the element
      const newElement = JSON.parse(JSON.stringify(selectedElement));

      // Generate new ID
      newElement.id = 'el-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

      // Offset position slightly
      newElement.x += 20;
      newElement.y += 20;

      // Add to slide
      slide.elements.push(newElement);

      // Select the new element
      selectedElement = newElement;

      renderSlide();
      showToast('Element duplicated', 'success');
    }

    function toggleElementShadow() {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      // Toggle shadow property
      selectedElement.shadow = !selectedElement.shadow;

      renderSlide();
      updateShadowToggleButton();
      showToast(selectedElement.shadow ? 'Shadow added' : 'Shadow removed', 'success');
    }

    function updateShadowToggleButton() {
      const btn = document.getElementById('shadowToggleBtn');
      if (selectedElement && selectedElement.shadow) {
        btn.style.background = '#e8f0fe';
        btn.style.color = '#1a73e8';
      } else {
        btn.style.background = '';
        btn.style.color = '';
      }
    }

    // Lock/Unlock element functionality
    function toggleElementLock() {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      selectedElement.locked = !selectedElement.locked;
      renderSlide();
      updateLockToggleButton();
      showToast(selectedElement.locked ? 'Element locked' : 'Element unlocked', 'success');
    }

    function updateLockToggleButton() {
      const btn = document.getElementById('lockToggleBtn');
      if (selectedElement && selectedElement.locked) {
        btn.innerHTML = 'ðŸ”“ Unlock';
        btn.style.background = '#fce8e6';
        btn.style.color = '#c5221f';
      } else {
        btn.innerHTML = 'ðŸ”’ Lock';
        btn.style.background = '';
        btn.style.color = '';
      }
    }

    // Format Painter (Copy/Paste Style)
    let copiedStyle = null;

    function copyElementStyle() {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      // Copy style properties based on element type
      if (selectedElement.type === 'text') {
        copiedStyle = {
          type: 'text',
          style: { ...selectedElement.style },
          shadow: selectedElement.shadow,
          opacity: selectedElement.opacity,
          rotation: selectedElement.rotation
        };
      } else if (selectedElement.type === 'shape') {
        copiedStyle = {
          type: 'shape',
          style: { ...selectedElement.style },
          shadow: selectedElement.shadow,
          opacity: selectedElement.opacity,
          rotation: selectedElement.rotation
        };
      } else if (selectedElement.type === 'image') {
        copiedStyle = {
          type: 'image',
          shadow: selectedElement.shadow,
          opacity: selectedElement.opacity,
          rotation: selectedElement.rotation,
          crop: selectedElement.crop ? { ...selectedElement.crop } : null
        };
      }

      // Update button states
      document.getElementById('copyStyleBtn').style.background = '#e8f0fe';
      document.getElementById('pasteStyleBtn').disabled = false;

      showToast('Style copied! Click another element and paste.', 'success');
    }

    function pasteElementStyle() {
      if (!copiedStyle) {
        showToast('Copy a style first', 'warning');
        return;
      }

      if (!selectedElement) {
        showToast('Select an element to apply style', 'warning');
        return;
      }

      // Apply style based on copied type and target type
      if (copiedStyle.type === 'text' && selectedElement.type === 'text') {
        // Apply text styles
        selectedElement.style = { ...selectedElement.style, ...copiedStyle.style };
      } else if (copiedStyle.type === 'shape' && selectedElement.type === 'shape') {
        // Apply shape styles
        selectedElement.style = { ...copiedStyle.style };
      }

      // Apply common properties
      if (copiedStyle.shadow !== undefined) selectedElement.shadow = copiedStyle.shadow;
      if (copiedStyle.opacity !== undefined) selectedElement.opacity = copiedStyle.opacity;
      if (copiedStyle.rotation !== undefined) selectedElement.rotation = copiedStyle.rotation;

      // Apply image-specific
      if (copiedStyle.type === 'image' && selectedElement.type === 'image' && copiedStyle.crop) {
        selectedElement.crop = { ...copiedStyle.crop };
      }

      renderSlide();
      showToast('Style applied!', 'success');
    }

    function clearCopiedStyle() {
      copiedStyle = null;
      document.getElementById('copyStyleBtn').style.background = '';
      document.getElementById('pasteStyleBtn').disabled = true;
    }

    // Group/Ungroup functionality
    let selectedElements = []; // For multi-select grouping

    function groupSelectedElements() {
      const slide = slides[currentSlideIndex];

      // Check if we have at least 2 elements selected or use all elements if only one selected
      if (!selectedElement) {
        showToast('Select elements to group first', 'warning');
        return;
      }

      // If single element selected, try to group with adjacent elements
      if (selectedElements.length < 2) {
        // For now, show a message about multi-select
        showToast('Hold Shift and click multiple elements to group them, or select a group to ungroup', 'info');
        return;
      }

      // Calculate bounding box for group
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      const elementsToGroup = [];

      selectedElements.forEach(elId => {
        const el = slide.elements.find(e => e.id === elId);
        if (el) {
          elementsToGroup.push(el);
          minX = Math.min(minX, el.x);
          minY = Math.min(minY, el.y);
          maxX = Math.max(maxX, el.x + el.width);
          maxY = Math.max(maxY, el.y + el.height);
        }
      });

      if (elementsToGroup.length < 2) {
        showToast('Select at least 2 elements to group', 'warning');
        return;
      }

      // Create group element
      const groupId = 'group-' + Date.now();
      const groupElement = {
        id: groupId,
        type: 'group',
        x: minX,
        y: minY,
        width: maxX - minX,
        height: maxY - minY,
        children: elementsToGroup.map(el => ({
          ...el,
          x: el.x - minX, // Relative position within group
          y: el.y - minY
        }))
      };

      // Remove grouped elements from slide
      slide.elements = slide.elements.filter(el => !selectedElements.includes(el.id));

      // Add group element
      slide.elements.push(groupElement);

      selectedElement = groupElement;
      selectedElements = [];
      renderSlide();
      renderThumbnails();
      showToast(`Grouped ${elementsToGroup.length} elements`, 'success');
    }

    function ungroupElement() {
      if (!selectedElement || selectedElement.type !== 'group') {
        showToast('Select a group to ungroup', 'warning');
        return;
      }

      const slide = slides[currentSlideIndex];
      const group = selectedElement;

      // Restore children to slide with absolute positions
      const restoredElements = group.children.map(child => ({
        ...child,
        id: 'el-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        x: group.x + child.x,
        y: group.y + child.y
      }));

      // Remove group from slide
      slide.elements = slide.elements.filter(el => el.id !== group.id);

      // Add restored elements
      slide.elements.push(...restoredElements);

      selectedElement = restoredElements[0];
      selectedElements = [];
      renderSlide();
      renderThumbnails();
      showToast(`Ungrouped ${restoredElements.length} elements`, 'success');
    }

    function toggleElementSelection(event, id) {
      event.stopPropagation();

      if (event.shiftKey) {
        // Multi-select mode
        const index = selectedElements.indexOf(id);
        if (index > -1) {
          selectedElements.splice(index, 1);
        } else {
          selectedElements.push(id);
        }

        // Also set selectedElement to last selected
        const slide = slides[currentSlideIndex];
        selectedElement = slide.elements.find(el => el.id === id);

        renderSlide();
        updateMultiSelectIndicator();
      } else {
        // Single select mode
        selectedElements = [id];
        selectElement(event, id);
      }
    }

    function updateMultiSelectIndicator() {
      if (selectedElements.length > 1) {
        showToast(`${selectedElements.length} elements selected`, 'info');
      }
    }

    // Slide Design
    function setSlideBackground(color) {
      slides[currentSlideIndex].background = color;
      renderSlide();
      renderThumbnails();
    }

    function setGradientBg(type) {
      const gradients = {
        blue: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        purple: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        green: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        dark: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)'
      };

      slides[currentSlideIndex].background = gradients[type];
      renderSlide();
      renderThumbnails();
    }

    // Slide Size functionality
    let slideSize = { width: 960, height: 540 };

    function showSlideSizeModal() {
      document.getElementById('slideSizeModal').style.display = 'flex';
      document.getElementById('slideWidth').value = slideSize.width;
      document.getElementById('slideHeight').value = slideSize.height;
    }

    function hideSlideSizeModal() {
      document.getElementById('slideSizeModal').style.display = 'none';
    }

    function applySlideSizePreset() {
      const preset = document.getElementById('slideSizePreset').value;
      const customGroup = document.getElementById('customSizeGroup');

      const sizes = {
        widescreen: { w: 960, h: 540 },
        standard: { w: 960, h: 720 },
        wide169: { w: 1280, h: 720 },
        wide1610: { w: 1280, h: 800 },
        a4landscape: { w: 1122, h: 793 },
        a4portrait: { w: 793, h: 1122 },
        letter: { w: 1056, h: 816 }
      };

      if (preset === 'custom') {
        customGroup.style.display = 'block';
      } else {
        customGroup.style.display = 'none';
        document.getElementById('slideWidth').value = sizes[preset].w;
        document.getElementById('slideHeight').value = sizes[preset].h;

        // Update orientation radio
        const isPortrait = sizes[preset].h > sizes[preset].w;
        document.querySelector(`input[name="slideOrientation"][value="${isPortrait ? 'portrait' : 'landscape'}"]`).checked = true;
      }
    }

    function applySlideSize() {
      const width = parseInt(document.getElementById('slideWidth').value);
      const height = parseInt(document.getElementById('slideHeight').value);
      const orientation = document.querySelector('input[name="slideOrientation"]:checked').value;

      // Apply orientation swap if needed
      let finalWidth = width;
      let finalHeight = height;

      if (orientation === 'portrait' && width > height) {
        finalWidth = height;
        finalHeight = width;
      } else if (orientation === 'landscape' && height > width) {
        finalWidth = height;
        finalHeight = width;
      }

      slideSize = { width: finalWidth, height: finalHeight };

      // Update slide canvas size
      const canvas = document.getElementById('slideCanvas');
      canvas.style.width = finalWidth + 'px';
      canvas.style.height = finalHeight + 'px';

      // Update all slides' elements to scale if needed (optional repositioning)
      const scaleX = finalWidth / 960;
      const scaleY = finalHeight / 540;

      slides.forEach(slide => {
        slide.elements.forEach(el => {
          // Scale positions proportionally
          el.x = Math.round(el.x * scaleX);
          el.y = Math.round(el.y * scaleY);
          if (el.width) el.width = Math.round(el.width * scaleX);
          if (el.height) el.height = Math.round(el.height * scaleY);
          if (el.w) el.w = Math.round(el.w * scaleX);
          if (el.h) el.h = Math.round(el.h * scaleY);
        });
      });

      renderSlide();
      renderThumbnails();
      hideSlideSizeModal();
      showToast(`Slide size changed to ${finalWidth} Ã— ${finalHeight}`, 'success');
    }

    function applyTheme(theme) {
      const themes = {
        modern: { bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', titleColor: '#ffffff', textColor: '#f0f0f0' },
        classic: { bg: '#ffffff', titleColor: '#1a1a1a', textColor: '#333333' },
        minimal: { bg: '#f5f5f5', titleColor: '#333333', textColor: '#666666' }
      };

      const t = themes[theme];
      slides[currentSlideIndex].background = t.bg;
      slides[currentSlideIndex].elements.forEach(el => {
        if (el.type === 'text') {
          if (el.style.fontSize === '48px' || el.style.fontWeight === 'bold') {
            el.style.color = t.titleColor;
          } else {
            el.style.color = t.textColor;
          }
        }
      });

      renderSlide();
      renderThumbnails();
      showToast(`Applied ${theme} theme`, 'success');
    }

    function applyLayout(layout) {
      const slide = slides[currentSlideIndex];
      slide.elements = [];

      if (layout === 'title') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 80, y: 200, width: 800, height: 80,
          content: 'Title Slide', style: { fontSize: '64px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'center' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 80, y: 300, width: 800, height: 50,
          content: 'Subtitle goes here', style: { fontSize: '28px', fontFamily: 'Arial', color: '#666666', textAlign: 'center' }
        });
      } else if (layout === 'titleContent') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 30, width: 880, height: 60,
          content: 'Slide Title', style: { fontSize: '36px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'left' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 120, width: 880, height: 380,
          content: 'â€¢ First point\nâ€¢ Second point\nâ€¢ Third point', style: { fontSize: '24px', fontFamily: 'Arial', color: '#333333', textAlign: 'left' }
        });
      } else if (layout === 'twoColumn') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 30, width: 880, height: 50,
          content: 'Two Column Layout', style: { fontSize: '36px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'center' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 100, width: 420, height: 400,
          content: 'Left column content', style: { fontSize: '20px', fontFamily: 'Arial', color: '#333333', textAlign: 'left' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 500, y: 100, width: 420, height: 400,
          content: 'Right column content', style: { fontSize: '20px', fontFamily: 'Arial', color: '#333333', textAlign: 'left' }
        });
      }

      renderSlide();
      renderThumbnails();
      showToast(`Applied ${layout} layout`, 'success');
    }

    // Transitions
    function setTransition(type) {
      slides[currentSlideIndex].transition = type;
      document.querySelectorAll('.transition-preview').forEach(el => {
        el.classList.toggle('selected', el.dataset.transition === type);
      });
      showToast(`Transition: ${type}`, 'success');
    }

    function setTransitionDuration(duration) {
      slides[currentSlideIndex].transitionDuration = parseFloat(duration);
    }

    function applyToAll() {
      const current = slides[currentSlideIndex];
      slides.forEach(slide => {
        slide.transition = current.transition;
        slide.transitionDuration = current.transitionDuration;
      });
      showToast('Applied to all slides', 'success');
    }

    // Animations
    function addAnimation(type) {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      selectedElement.animation = {
        type: type,
        duration: 0.5,
        delay: 0,
        order: slides[currentSlideIndex].elements.filter(el => el.animation).length + 1
      };

      updateAnimationList();
      showToast(`Added ${type} animation`, 'success');
    }

    function removeAnimation() {
      if (!selectedElement) return;
      selectedElement.animation = null;
      updateAnimationList();
      showToast('Animation removed', 'success');
    }

    function previewAnimation() {
      if (!selectedElement || !selectedElement.animation) {
        showToast('No animation to preview', 'warning');
        return;
      }

      const element = document.getElementById(`element-${selectedElement.id}`);
      element.style.animation = `${selectedElement.animation.type} ${selectedElement.animation.duration}s`;

      setTimeout(() => {
        element.style.animation = '';
      }, selectedElement.animation.duration * 1000 + 100);
    }

    function updateAnimationList() {
      const slide = slides[currentSlideIndex];
      const animations = slide.elements.filter(el => el.animation);

      const list = document.getElementById('animationList');
      if (animations.length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); font-size: 0.9rem;">No animations on this slide</p>';
      } else {
        list.innerHTML = animations.map((el, i) => `
          <div class="animation-item" onclick="selectElement(null, ${el.id})">
            <div class="animation-icon">${i + 1}</div>
            <div>
              <strong>${el.type === 'text' ? el.content.substring(0, 15) + '...' : el.type}</strong>
              <div style="font-size: 0.75rem; color: var(--secondary);">${el.animation.type}</div>
            </div>
          </div>
        `).join('');
      }
    }

    // Update element properties panel
    function updateElementProps() {
      const props = document.getElementById('elementProps');

      if (!selectedElement) {
        props.innerHTML = '<p style="color: var(--secondary); font-size: 0.9rem;">Select an element to edit its properties</p>';
        return;
      }

      props.innerHTML = `
        <div class="form-group">
          <label>Position</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="number" class="form-control" value="${Math.round(selectedElement.x)}" onchange="updateElementProp('x', this.value)" style="width: 50%;" placeholder="X">
            <input type="number" class="form-control" value="${Math.round(selectedElement.y)}" onchange="updateElementProp('y', this.value)" style="width: 50%;" placeholder="Y">
          </div>
        </div>
        <div class="form-group">
          <label>Size</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="number" class="form-control" value="${selectedElement.width}" onchange="updateElementProp('width', this.value)" style="width: 50%;" placeholder="W">
            <input type="number" class="form-control" value="${selectedElement.height}" onchange="updateElementProp('height', this.value)" style="width: 50%;" placeholder="H">
          </div>
        </div>
        <div class="form-group">
          <button class="btn btn-danger" onclick="deleteElement()" style="width: 100%;">Delete Element</button>
        </div>
      `;
    }

    function updateElementProp(prop, value) {
      if (!selectedElement) return;
      selectedElement[prop] = parseInt(value);
      renderSlide();
    }

    function deleteElement() {
      if (!selectedElement) return;
      saveState();
      const slide = slides[currentSlideIndex];
      slide.elements = slide.elements.filter(el => el.id !== selectedElement.id);
      selectedElement = null;
      renderSlide();
      renderThumbnails();
      updateElementProps();
      showToast('Element deleted', 'success');
    }

    // Presentation Mode
    let presentationIndex = 0;

    function startPresentation() {
      presentationIndex = 0;
      document.getElementById('fullscreenPresenter').style.display = 'flex';
      renderPresentationSlide();
      document.body.style.overflow = 'hidden';
    }

    function renderPresentationSlide() {
      const container = document.getElementById('fullscreenSlide');
      const slide = slides[presentationIndex];

      container.style.background = slide.background;

      // Apply transition
      container.style.animation = `${slide.transition}In ${slide.transitionDuration}s`;

      let html = '';
      slide.elements.forEach((el, i) => {
        const animDelay = el.animation ? el.animation.delay + (el.animation.order * 0.2) : 0;
        const animStyle = el.animation ? `animation: ${el.animation.type} ${el.animation.duration}s ${animDelay}s both;` : '';

        if (el.type === 'text') {
          html += `
            <div style="position: absolute; left: ${el.x * 2}px; top: ${el.y * 2}px;
                        width: ${el.width * 2}px; font-size: calc(${el.style.fontSize} * 2);
                        font-weight: ${el.style.fontWeight}; font-family: ${el.style.fontFamily};
                        color: ${el.style.color}; text-align: ${el.style.textAlign};
                        padding: 16px; ${animStyle}">
              ${el.content}
            </div>
          `;
        } else if (el.type === 'shape') {
          html += `
            <div style="position: absolute; left: ${el.x * 2}px; top: ${el.y * 2}px;
                        width: ${el.width * 2}px; height: ${el.height * 2}px;
                        background: ${el.style.background}; border-radius: ${el.shape === 'circle' ? '50%' : '8px'};
                        ${el.shape === 'triangle' ? 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);' : ''}
                        ${animStyle}">
            </div>
          `;
        } else if (el.type === 'image') {
          html += `
            <div style="position: absolute; left: ${el.x * 2}px; top: ${el.y * 2}px;
                        width: ${el.width * 2}px; height: ${el.height * 2}px; ${animStyle}">
              <img src="${el.src}" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
          `;
        } else if (el.type === 'video') {
          html += `
            <div style="position: absolute; left: ${el.x * 2}px; top: ${el.y * 2}px;
                        width: ${el.width * 2}px; height: ${el.height * 2}px; ${animStyle}">
              <video src="${el.src}" controls style="width: 100%; height: 100%;"></video>
            </div>
          `;
        }
      });

      container.innerHTML = html;
    }

    function exitPresentation() {
      document.getElementById('fullscreenPresenter').style.display = 'none';
      document.body.style.overflow = '';
      // Also cleanup laser pointer
      laserPointerActive = false;
      document.getElementById('laserPointer').classList.remove('active');
      document.getElementById('laserBtn').classList.remove('active');
    }

    // Alias for toolbar button
    function exitSlideshow() {
      exitPresentation();
    }

    function prevSlideshow() {
      if (presentationIndex > 0) {
        presentationIndex--;
        renderPresentationSlide();
      }
    }

    function nextSlideshow() {
      if (presentationIndex < slides.length - 1) {
        presentationIndex++;
        renderPresentationSlide();
      }
    }

    // ==================== LASER POINTER ====================
    let laserPointerActive = false;
    let laserColor = 'red'; // red, green, blue
    let isBlackScreen = false;

    function toggleLaserPointer() {
      laserPointerActive = !laserPointerActive;
      const laser = document.getElementById('laserPointer');
      const btn = document.getElementById('laserBtn');

      if (laserPointerActive) {
        laser.classList.add('active');
        btn.classList.add('active');
        showToast('Laser pointer ON - move mouse to point', 'info');
      } else {
        laser.classList.remove('active');
        btn.classList.remove('active');
      }
    }

    function cycleLaserColor() {
      const laser = document.getElementById('laserPointer');
      const btn = document.getElementById('laserColorBtn');

      // Remove current color class
      laser.classList.remove('green', 'blue');

      if (laserColor === 'red') {
        laserColor = 'green';
        laser.classList.add('green');
        btn.textContent = 'ðŸŸ¢';
      } else if (laserColor === 'green') {
        laserColor = 'blue';
        laser.classList.add('blue');
        btn.textContent = 'ðŸ”µ';
      } else {
        laserColor = 'red';
        btn.textContent = 'ðŸ”´';
      }
      showToast(`Laser color: ${laserColor}`, 'info');
    }

    function toggleBlackScreen() {
      const presenter = document.getElementById('fullscreenPresenter');
      const slide = document.getElementById('fullscreenSlide');
      const btn = document.getElementById('blackScreenBtn');

      isBlackScreen = !isBlackScreen;

      if (isBlackScreen) {
        slide.style.visibility = 'hidden';
        presenter.style.background = 'black';
        btn.classList.add('active');
        btn.textContent = 'â¬œ';
      } else {
        slide.style.visibility = 'visible';
        presenter.style.background = '';
        btn.classList.remove('active');
        btn.textContent = 'â¬›';
      }
    }

    // Track mouse movement for laser pointer
    document.addEventListener('mousemove', function(e) {
      if (!laserPointerActive) return;

      const laser = document.getElementById('laserPointer');
      laser.style.left = e.clientX + 'px';
      laser.style.top = e.clientY + 'px';
    });

    // Keyboard shortcuts for presentation mode
    document.addEventListener('keydown', function(e) {
      const presenter = document.getElementById('fullscreenPresenter');
      if (presenter.style.display !== 'flex') return;

      switch(e.key.toLowerCase()) {
        case 'l':
          toggleLaserPointer();
          break;
        case 'b':
          toggleBlackScreen();
          break;
        case 'arrowleft':
        case 'pageup':
          prevSlideshow();
          break;
        case 'arrowright':
        case 'pagedown':
        case ' ':
          nextSlideshow();
          e.preventDefault();
          break;
        case 'escape':
          exitPresentation();
          break;
      }
    });

    // Show toolbar on mouse move near bottom
    document.addEventListener('mousemove', function(e) {
      const presenter = document.getElementById('fullscreenPresenter');
      if (presenter.style.display !== 'flex') return;

      const toolbar = document.getElementById('slideshowToolbar');
      if (e.clientY > window.innerHeight - 100) {
        toolbar.classList.add('visible');
      } else {
        toolbar.classList.remove('visible');
      }
    });

    // Presenter View
    function showPresenterView() {
      presentationIndex = currentSlideIndex;
      document.getElementById('presenterView').style.display = 'grid';
      presenterStartTime = Date.now();

      if (presenterTimerInterval) clearInterval(presenterTimerInterval);
      presenterTimerInterval = setInterval(updatePresenterTimer, 1000);

      updatePresenterView();
    }

    function exitPresenterView() {
      document.getElementById('presenterView').style.display = 'none';
      if (presenterTimerInterval) clearInterval(presenterTimerInterval);
    }

    function updatePresenterView() {
      // Current slide
      const currentContainer = document.getElementById('presenterCurrentSlide');
      const slide = slides[presentationIndex];
      currentContainer.style.background = slide.background;
      currentContainer.innerHTML = slide.elements.map(el => {
        if (el.type === 'text') {
          return `<div style="position: absolute; left: ${el.x}px; top: ${el.y}px; width: ${el.width}px;
                              font-size: ${el.style.fontSize}; font-weight: ${el.style.fontWeight};
                              font-family: ${el.style.fontFamily}; color: ${el.style.color};
                              text-align: ${el.style.textAlign}; padding: 8px;">${el.content}</div>`;
        }
        return '';
      }).join('');

      // Next slide
      const nextContainer = document.getElementById('presenterNextSlide');
      if (presentationIndex < slides.length - 1) {
        const nextSlide = slides[presentationIndex + 1];
        nextContainer.style.background = nextSlide.background;
        nextContainer.innerHTML = '<div style="padding: 8px; font-size: 8px;">Next slide preview</div>';
      } else {
        nextContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">End of presentation</div>';
      }

      // Speaker notes
      document.getElementById('presenterNotesContent').textContent = slide.speakerNotes || 'No speaker notes for this slide.';
    }

    function updatePresenterTimer() {
      const elapsed = Math.floor((Date.now() - presenterStartTime) / 1000);
      const hours = Math.floor(elapsed / 3600).toString().padStart(2, '0');
      const minutes = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      document.getElementById('presenterTime').textContent = `${hours}:${minutes}:${seconds}`;
    }

    function resetTimer() {
      presenterStartTime = Date.now();
    }

    function prevSlidePresenter() {
      if (presentationIndex > 0) {
        presentationIndex--;
        updatePresenterView();
      }
    }

    function nextSlidePresenter() {
      if (presentationIndex < slides.length - 1) {
        presentationIndex++;
        updatePresenterView();
      }
    }

    // Templates
    function showTemplates() {
      document.getElementById('templatesModal').classList.add('active');
    }

    function hideTemplates() {
      document.getElementById('templatesModal').classList.remove('active');
    }

    function loadTemplate(template) {
      slides = [];

      const templates = {
        business: [
          { bg: 'linear-gradient(135deg, #1a73e8, #174ea6)', elements: [
            { type: 'text', x: 80, y: 180, w: 800, h: 80, content: 'Business Presentation', style: { fontSize: '56px', fontWeight: 'bold', color: '#ffffff', textAlign: 'center' } },
            { type: 'text', x: 80, y: 280, w: 800, h: 50, content: 'Company Name | Date', style: { fontSize: '24px', color: '#e3f2fd', textAlign: 'center' } }
          ]},
          { bg: '#ffffff', elements: [
            { type: 'text', x: 40, y: 30, w: 880, h: 60, content: 'Agenda', style: { fontSize: '36px', fontWeight: 'bold', color: '#1a73e8', textAlign: 'left' } },
            { type: 'text', x: 40, y: 120, w: 880, h: 380, content: '1. Introduction\n2. Market Analysis\n3. Strategy\n4. Financial Projections\n5. Next Steps', style: { fontSize: '28px', color: '#333', textAlign: 'left' } }
          ]}
        ],
        creative: [
          { bg: 'linear-gradient(135deg, #ea4335, #c5221f)', elements: [
            { type: 'text', x: 80, y: 200, w: 800, h: 100, content: 'CREATIVE', style: { fontSize: '72px', fontWeight: 'bold', color: '#ffffff', textAlign: 'center' } },
            { type: 'text', x: 80, y: 320, w: 800, h: 50, content: 'Think Different', style: { fontSize: '28px', color: '#ffcdd2', textAlign: 'center' } }
          ]}
        ],
        minimal: [
          { bg: '#f5f5f5', elements: [
            { type: 'text', x: 80, y: 220, w: 800, h: 80, content: 'Minimal', style: { fontSize: '64px', fontWeight: '300', color: '#333', textAlign: 'center' } }
          ]}
        ],
        education: [
          { bg: 'linear-gradient(135deg, #34a853, #188038)', elements: [
            { type: 'text', x: 80, y: 180, w: 800, h: 80, content: 'Education Template', style: { fontSize: '48px', fontWeight: 'bold', color: '#fff', textAlign: 'center' } },
            { type: 'text', x: 80, y: 280, w: 800, h: 50, content: 'Course Name | Instructor', style: { fontSize: '24px', color: '#c8e6c9', textAlign: 'center' } }
          ]}
        ],
        pitch: [
          { bg: 'linear-gradient(135deg, #9c27b0, #7b1fa2)', elements: [
            { type: 'text', x: 80, y: 160, w: 800, h: 80, content: 'Startup Name', style: { fontSize: '56px', fontWeight: 'bold', color: '#fff', textAlign: 'center' } },
            { type: 'text', x: 80, y: 260, w: 800, h: 50, content: 'The Future of [Industry]', style: { fontSize: '28px', color: '#e1bee7', textAlign: 'center' } },
            { type: 'text', x: 80, y: 400, w: 800, h: 30, content: 'Seed Round | $1M', style: { fontSize: '20px', color: '#ce93d8', textAlign: 'center' } }
          ]}
        ],
        portfolio: [
          { bg: 'linear-gradient(135deg, #ff9800, #f57c00)', elements: [
            { type: 'text', x: 80, y: 200, w: 800, h: 80, content: 'My Portfolio', style: { fontSize: '56px', fontWeight: 'bold', color: '#fff', textAlign: 'center' } },
            { type: 'text', x: 80, y: 300, w: 800, h: 50, content: 'Designer | Developer | Creator', style: { fontSize: '24px', color: '#ffe0b2', textAlign: 'center' } }
          ]}
        ]
      };

      const templateSlides = templates[template] || templates.business;
      templateSlides.forEach(slideData => {
        const slide = {
          id: Date.now() + Math.random(),
          background: slideData.bg,
          transition: 'fade',
          transitionDuration: 0.5,
          elements: slideData.elements.map(el => ({
            id: ++elementIdCounter,
            type: el.type,
            x: el.x,
            y: el.y,
            width: el.w,
            height: el.h,
            content: el.content,
            style: el.style,
            animation: null
          })),
          speakerNotes: ''
        };
        slides.push(slide);
      });

      currentSlideIndex = 0;
      hideTemplates();
      renderThumbnails();
      renderSlide();
      updateStatusBar();
      showToast(`Loaded ${template} template`, 'success');
    }

    // Export
    async function exportPDF() {
      showToast('Generating PDF...', 'info');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', [297, 167]); // 16:9 landscape

      for (let i = 0; i < slides.length; i++) {
        if (i > 0) doc.addPage();

        // Render slide to canvas
        selectSlide(i);
        await new Promise(r => setTimeout(r, 100));

        const canvas = await html2canvas(document.getElementById('slideCanvas'), {
          scale: 2,
          useCORS: true,
          backgroundColor: null
        });

        const imgData = canvas.toDataURL('image/png');
        doc.addImage(imgData, 'PNG', 0, 0, 297, 167);
      }

      const fileName = document.getElementById('fileName').value || 'presentation';
      doc.save(`${fileName}.pdf`);
      showToast('PDF exported!', 'success');
    }

    // Keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Presentation mode navigation
        if (document.getElementById('fullscreenPresenter').style.display === 'flex') {
          if (e.key === 'Escape') {
            exitPresentation();
          } else if (e.key === 'ArrowRight' || e.key === ' ') {
            if (presentationIndex < slides.length - 1) {
              presentationIndex++;
              renderPresentationSlide();
            }
          } else if (e.key === 'ArrowLeft') {
            if (presentationIndex > 0) {
              presentationIndex--;
              renderPresentationSlide();
            }
          }
          return;
        }

        // Delete element
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedElement && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          deleteElement();
        }

        // Ctrl shortcuts
        if (e.ctrlKey || e.metaKey) {
          if (e.key === 's') {
            e.preventDefault();
            savePresentation();
          } else if (e.key === 'd') {
            e.preventDefault();
            duplicateSlide();
          } else if (e.key === 'z') {
            e.preventDefault();
            undo();
          } else if (e.key === 'y') {
            e.preventDefault();
            redo();
          } else if (e.key === 'f') {
            e.preventDefault();
            toggleFindBar();
          }
        }
      });
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        ['homeToolbar', 'insertToolbar', 'designToolbar', 'transitionsToolbar', 'animationsToolbar', 'viewToolbar'].forEach(id => {
          document.getElementById(id).style.display = 'none';
        });

        const tabName = tab.dataset.tab;
        const toolbarMap = {
          home: 'homeToolbar',
          insert: 'insertToolbar',
          design: 'designToolbar',
          transitions: 'transitionsToolbar',
          animations: 'animationsToolbar',
          view: 'viewToolbar'
        };

        if (toolbarMap[tabName]) {
          document.getElementById(toolbarMap[tabName]).style.display = 'flex';
        }
      });
    });

    function updateStatusBar() {
      document.getElementById('currentSlideNum').textContent = currentSlideIndex + 1;
      document.getElementById('totalSlides').textContent = slides.length;
    }

    // Toast
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // CSS Animations - Extended library
    const animationStyles = document.createElement('style');
    animationStyles.textContent = `
      /* Entrance Animations */
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      @keyframes bounceIn { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
      @keyframes flyIn { 0% { transform: translateX(-200%) rotate(-45deg); opacity: 0; } 100% { transform: translateX(0) rotate(0); opacity: 1; } }
      @keyframes flipIn { from { transform: perspective(400px) rotateY(90deg); opacity: 0; } to { transform: perspective(400px) rotateY(0); opacity: 1; } }
      @keyframes swingIn { 0% { transform: rotateX(-90deg); transform-origin: top; opacity: 0; } 100% { transform: rotateX(0); transform-origin: top; opacity: 1; } }
      @keyframes expandIn { 0% { transform: scale(0, 0); } 50% { transform: scale(1.1, 0.1); } 100% { transform: scale(1, 1); } }
      @keyframes wipeIn { 0% { clip-path: inset(0 100% 0 0); } 100% { clip-path: inset(0 0 0 0); } }
      @keyframes splitIn { 0% { clip-path: polygon(50% 0, 50% 0, 50% 100%, 50% 100%); } 100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); } }
      @keyframes floatIn { 0% { transform: translateY(30px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
      @keyframes rotateIn { from { transform: rotate(-180deg) scale(0); opacity: 0; } to { transform: rotate(0) scale(1); opacity: 1; } }

      /* Emphasis Animations */
      @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
      @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      @keyframes grow { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
      @keyframes shrink { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.8); } }
      @keyframes teeter { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
      @keyframes flash { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0; } }
      @keyframes colorPulse { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.5); } }
      @keyframes wobble { 0%, 100% { transform: translateX(0); } 15% { transform: translateX(-25px) rotate(-5deg); } 30% { transform: translateX(20px) rotate(3deg); } 45% { transform: translateX(-15px) rotate(-3deg); } 60% { transform: translateX(10px) rotate(2deg); } 75% { transform: translateX(-5px) rotate(-1deg); } }
      @keyframes heartbeat { 0%, 100% { transform: scale(1); } 14% { transform: scale(1.3); } 28% { transform: scale(1); } 42% { transform: scale(1.3); } 70% { transform: scale(1); } }
      @keyframes jello { 0%, 100% { transform: skewX(0); } 11.1% { transform: skewX(-12deg); } 22.2% { transform: skewX(10deg); } 33.3% { transform: skewX(-6deg); } 44.4% { transform: skewX(4deg); } 55.5% { transform: skewX(-2deg); } }

      /* Exit Animations */
      @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
      @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
      @keyframes slideOutUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
      @keyframes slideOutDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
      @keyframes zoomOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0); opacity: 0; } }
      @keyframes flyOut { 0% { transform: translateX(0) rotate(0); opacity: 1; } 100% { transform: translateX(200%) rotate(45deg); opacity: 0; } }
      @keyframes flipOut { from { transform: perspective(400px) rotateY(0); opacity: 1; } to { transform: perspective(400px) rotateY(90deg); opacity: 0; } }
      @keyframes shrinkOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0); opacity: 0; } }

      /* Slide Transition Animations */
      @keyframes fadeInSlide { from { opacity: 0; } to { opacity: 1; } }
      @keyframes zoomInSlide { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      @keyframes flipInSlide { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0); opacity: 1; } }
      @keyframes cubeInSlide { from { transform: rotateY(-90deg) translateZ(500px); opacity: 0; } to { transform: rotateY(0) translateZ(0); opacity: 1; } }
    `;
    document.head.appendChild(animationStyles);

    // ==================== ELEMENT BORDERS ====================
    let borderPopup = null;

    const borderStyles = [
      { name: 'None', value: 'none', icon: 'â¬œ' },
      { name: 'Thin', value: '1px solid #000', icon: 'â–¢' },
      { name: 'Medium', value: '2px solid #000', icon: 'â–£' },
      { name: 'Thick', value: '4px solid #000', icon: 'â—¼' },
      { name: 'Double', value: '3px double #000', icon: 'â§ˆ' },
      { name: 'Dashed', value: '2px dashed #000', icon: 'â¬š' },
      { name: 'Dotted', value: '2px dotted #000', icon: 'â ¿' },
      { name: 'Groove', value: '3px groove #666', icon: 'â–¤' },
      { name: 'Ridge', value: '3px ridge #666', icon: 'â–¥' },
      { name: 'Inset', value: '3px inset #666', icon: 'â–¦' },
      { name: 'Outset', value: '3px outset #666', icon: 'â–§' }
    ];

    const borderColors = [
      '#000000', '#333333', '#666666', '#999999', '#cccccc', '#ffffff',
      '#ff0000', '#ff6600', '#ffcc00', '#33cc33', '#0066ff', '#9933ff',
      '#ff3366', '#ff9999', '#ffcc99', '#99ff99', '#99ccff', '#cc99ff'
    ];

    const borderRadii = [
      { name: 'None', value: '0', icon: 'â–¢' },
      { name: 'Small', value: '4px', icon: 'â–¢' },
      { name: 'Medium', value: '8px', icon: 'â–¢' },
      { name: 'Large', value: '16px', icon: 'â–¢' },
      { name: 'XL', value: '24px', icon: 'â–¢' },
      { name: 'Round', value: '50%', icon: 'â—‹' }
    ];

    function showElementBorder(event) {
      event.stopPropagation();

      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      if (borderPopup) {
        borderPopup.remove();
        borderPopup = null;
        return;
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      borderPopup = document.createElement('div');
      borderPopup.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${Math.min(rect.left, window.innerWidth - 280)}px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        z-index: 10000;
        width: 260px;
      `;

      // Border Style section
      let html = `<div style="font-weight: bold; margin-bottom: 8px; color: #333;">Border Style</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 12px;">`;
      borderStyles.forEach(style => {
        const isActive = selectedElement.border === style.value || (!selectedElement.border && style.value === 'none');
        html += `
          <div onclick="applyElementBorder('${style.value}')"
               style="padding: 6px; text-align: center; cursor: pointer; border: 1px solid ${isActive ? '#1a73e8' : '#ddd'};
                      border-radius: 4px; background: ${isActive ? '#e8f0fe' : 'white'}; font-size: 14px;"
               title="${style.name}">
            ${style.icon}
          </div>`;
      });
      html += `</div>`;

      // Border Color section
      html += `<div style="font-weight: bold; margin-bottom: 8px; color: #333;">Border Color</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px; margin-bottom: 12px;">`;
      borderColors.forEach(color => {
        html += `
          <div onclick="applyBorderColor('${color}')"
               style="width: 32px; height: 20px; background: ${color}; border: 1px solid #999;
                      border-radius: 3px; cursor: pointer;"
               title="${color}">
          </div>`;
      });
      html += `</div>`;

      // Border Width section
      html += `<div style="font-weight: bold; margin-bottom: 8px; color: #333;">Border Width</div>`;
      html += `<div style="display: flex; gap: 4px; margin-bottom: 12px;">`;
      [1, 2, 3, 4, 5, 6].forEach(width => {
        html += `
          <div onclick="applyBorderWidth(${width})"
               style="flex: 1; padding: 4px; text-align: center; cursor: pointer; border: 1px solid #ddd;
                      border-radius: 4px; font-size: 11px;" title="${width}px">
            ${width}px
          </div>`;
      });
      html += `</div>`;

      // Border Radius section
      html += `<div style="font-weight: bold; margin-bottom: 8px; color: #333;">Corner Radius</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;">`;
      borderRadii.forEach(radius => {
        const isActive = selectedElement.borderRadius === radius.value;
        html += `
          <div onclick="applyBorderRadius('${radius.value}')"
               style="padding: 4px; text-align: center; cursor: pointer; border: 1px solid ${isActive ? '#1a73e8' : '#ddd'};
                      border-radius: 4px; background: ${isActive ? '#e8f0fe' : 'white'}; font-size: 10px;"
               title="${radius.name}">
            ${radius.name}
          </div>`;
      });
      html += `</div>`;

      borderPopup.innerHTML = html;
      document.body.appendChild(borderPopup);

      setTimeout(() => {
        document.addEventListener('click', closeBorderPopup);
      }, 10);
    }

    function closeBorderPopup(e) {
      if (borderPopup && !borderPopup.contains(e.target)) {
        borderPopup.remove();
        borderPopup = null;
        document.removeEventListener('click', closeBorderPopup);
      }
    }

    function applyElementBorder(style) {
      if (!selectedElement) return;
      if (style === 'none') {
        selectedElement.border = null;
      } else {
        selectedElement.border = style;
      }
      renderSlide();
      renderThumbnails();
      showToast('Border applied', 'success');
    }

    function applyBorderColor(color) {
      if (!selectedElement) return;
      if (!selectedElement.border || selectedElement.border === 'none') {
        selectedElement.border = `2px solid ${color}`;
      } else {
        // Replace the color in the existing border
        selectedElement.border = selectedElement.border.replace(/#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|rgba?\([^)]+\)|[a-z]+$/i, color);
      }
      renderSlide();
      renderThumbnails();
      showToast('Border color applied', 'success');
    }

    function applyBorderWidth(width) {
      if (!selectedElement) return;
      if (!selectedElement.border || selectedElement.border === 'none') {
        selectedElement.border = `${width}px solid #000`;
      } else {
        // Replace the width in the existing border
        selectedElement.border = selectedElement.border.replace(/^\d+px/, `${width}px`);
      }
      renderSlide();
      renderThumbnails();
      showToast(`Border width set to ${width}px`, 'success');
    }

    function applyBorderRadius(radius) {
      if (!selectedElement) return;
      if (radius === '0') {
        selectedElement.borderRadius = null;
      } else {
        selectedElement.borderRadius = radius;
      }
      renderSlide();
      renderThumbnails();
      showToast('Corner radius applied', 'success');
    }

    // ==================== GRADIENT FILL ====================
    let gradientPopup = null;

    const gradientPresets = [
      { name: 'Sunset', gradient: 'linear-gradient(135deg, #ff6b6b, #feca57)' },
      { name: 'Ocean', gradient: 'linear-gradient(135deg, #667eea, #764ba2)' },
      { name: 'Forest', gradient: 'linear-gradient(135deg, #11998e, #38ef7d)' },
      { name: 'Fire', gradient: 'linear-gradient(135deg, #f12711, #f5af19)' },
      { name: 'Sky', gradient: 'linear-gradient(135deg, #2193b0, #6dd5ed)' },
      { name: 'Rose', gradient: 'linear-gradient(135deg, #ee9ca7, #ffdde1)' },
      { name: 'Night', gradient: 'linear-gradient(135deg, #232526, #414345)' },
      { name: 'Gold', gradient: 'linear-gradient(135deg, #f7971e, #ffd200)' },
      { name: 'Mint', gradient: 'linear-gradient(135deg, #56ab2f, #a8e063)' },
      { name: 'Berry', gradient: 'linear-gradient(135deg, #8e2de2, #4a00e0)' },
      { name: 'Peach', gradient: 'linear-gradient(135deg, #ed6ea0, #ec8c69)' },
      { name: 'Steel', gradient: 'linear-gradient(135deg, #bdc3c7, #2c3e50)' }
    ];

    const gradientDirections = [
      { name: 'Top to Bottom', value: 'to bottom', icon: 'â†“' },
      { name: 'Bottom to Top', value: 'to top', icon: 'â†‘' },
      { name: 'Left to Right', value: 'to right', icon: 'â†’' },
      { name: 'Right to Left', value: 'to left', icon: 'â†' },
      { name: 'Diagonal â†˜', value: '135deg', icon: 'â†˜' },
      { name: 'Diagonal â†—', value: '45deg', icon: 'â†—' },
      { name: 'Diagonal â†™', value: '225deg', icon: 'â†™' },
      { name: 'Diagonal â†–', value: '315deg', icon: 'â†–' },
      { name: 'Radial', value: 'radial', icon: 'â—‰' }
    ];

    function showGradientFill(event) {
      event.stopPropagation();

      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      if (gradientPopup) {
        gradientPopup.remove();
        gradientPopup = null;
        return;
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      gradientPopup = document.createElement('div');
      gradientPopup.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${Math.min(rect.left, window.innerWidth - 320)}px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        z-index: 10000;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
      `;

      let html = `<div style="font-weight: bold; margin-bottom: 10px; color: #333;">ðŸŒˆ Gradient Fill</div>`;

      // Preset gradients
      html += `<div style="font-size: 12px; color: #666; margin-bottom: 6px;">Presets:</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px;">`;
      gradientPresets.forEach(preset => {
        html += `
          <div onclick="applyGradientPreset('${preset.gradient.replace(/'/g, "\\'")}')"
               style="height: 36px; background: ${preset.gradient}; border-radius: 4px; cursor: pointer;
                      border: 1px solid #ddd; transition: transform 0.2s;"
               onmouseover="this.style.transform='scale(1.05)'"
               onmouseout="this.style.transform='scale(1)'"
               title="${preset.name}">
          </div>`;
      });
      html += `</div>`;

      // Custom gradient builder
      html += `<div style="border-top: 1px solid #eee; padding-top: 10px;">`;
      html += `<div style="font-size: 12px; color: #666; margin-bottom: 6px;">Custom Gradient:</div>`;
      html += `
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <div style="flex: 1;">
            <label style="font-size: 10px; color: #888;">Start Color</label>
            <input type="color" id="gradientColor1" value="#667eea" style="width: 100%; height: 30px; border: none; cursor: pointer;">
          </div>
          <div style="flex: 1;">
            <label style="font-size: 10px; color: #888;">End Color</label>
            <input type="color" id="gradientColor2" value="#764ba2" style="width: 100%; height: 30px; border: none; cursor: pointer;">
          </div>
        </div>
      `;

      // Direction selector
      html += `<div style="font-size: 10px; color: #888; margin-bottom: 4px;">Direction:</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px; margin-bottom: 10px;">`;
      gradientDirections.forEach(dir => {
        html += `
          <div onclick="setGradientDirection('${dir.value}')"
               id="dir-${dir.value.replace(/\s/g, '-')}"
               style="padding: 6px; text-align: center; cursor: pointer; border: 1px solid #ddd;
                      border-radius: 4px; font-size: 14px; transition: all 0.2s;"
               title="${dir.name}">
            ${dir.icon}
          </div>`;
      });
      html += `</div>`;

      // Preview
      html += `
        <div style="margin-bottom: 10px;">
          <div style="font-size: 10px; color: #888; margin-bottom: 4px;">Preview:</div>
          <div id="gradientPreview" style="height: 40px; border-radius: 4px; border: 1px solid #ddd;
                                           background: linear-gradient(135deg, #667eea, #764ba2);"></div>
        </div>
      `;

      // Apply button
      html += `
        <div style="display: flex; gap: 8px;">
          <button onclick="applyCustomGradient()"
                  style="flex: 1; padding: 8px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Apply Gradient
          </button>
          <button onclick="removeFill()"
                  style="padding: 8px 12px; background: #f1f1f1; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            Clear
          </button>
        </div>
      `;
      html += `</div>`;

      gradientPopup.innerHTML = html;
      document.body.appendChild(gradientPopup);

      // Add event listeners for live preview
      setTimeout(() => {
        document.getElementById('gradientColor1').addEventListener('input', updateGradientPreview);
        document.getElementById('gradientColor2').addEventListener('input', updateGradientPreview);
        document.addEventListener('click', closeGradientPopup);
      }, 10);
    }

    let currentGradientDirection = '135deg';

    function setGradientDirection(direction) {
      currentGradientDirection = direction;

      // Update UI
      document.querySelectorAll('[id^="dir-"]').forEach(el => {
        el.style.background = 'white';
        el.style.borderColor = '#ddd';
      });
      const selectedEl = document.getElementById('dir-' + direction.replace(/\s/g, '-'));
      if (selectedEl) {
        selectedEl.style.background = '#e8f0fe';
        selectedEl.style.borderColor = '#1a73e8';
      }

      updateGradientPreview();
    }

    function updateGradientPreview() {
      const color1 = document.getElementById('gradientColor1').value;
      const color2 = document.getElementById('gradientColor2').value;
      const preview = document.getElementById('gradientPreview');

      if (currentGradientDirection === 'radial') {
        preview.style.background = `radial-gradient(circle, ${color1}, ${color2})`;
      } else {
        preview.style.background = `linear-gradient(${currentGradientDirection}, ${color1}, ${color2})`;
      }
    }

    function closeGradientPopup(e) {
      if (gradientPopup && !gradientPopup.contains(e.target)) {
        gradientPopup.remove();
        gradientPopup = null;
        document.removeEventListener('click', closeGradientPopup);
      }
    }

    function applyGradientPreset(gradient) {
      if (!selectedElement) return;

      if (selectedElement.type === 'shape') {
        selectedElement.fill = gradient;
      } else {
        selectedElement.style = selectedElement.style || {};
        selectedElement.style.background = gradient;
      }

      renderSlide();
      renderThumbnails();
      showToast('Gradient applied', 'success');

      if (gradientPopup) {
        gradientPopup.remove();
        gradientPopup = null;
      }
    }

    function applyCustomGradient() {
      if (!selectedElement) return;

      const color1 = document.getElementById('gradientColor1').value;
      const color2 = document.getElementById('gradientColor2').value;

      let gradient;
      if (currentGradientDirection === 'radial') {
        gradient = `radial-gradient(circle, ${color1}, ${color2})`;
      } else {
        gradient = `linear-gradient(${currentGradientDirection}, ${color1}, ${color2})`;
      }

      if (selectedElement.type === 'shape') {
        selectedElement.fill = gradient;
      } else {
        selectedElement.style = selectedElement.style || {};
        selectedElement.style.background = gradient;
      }

      renderSlide();
      renderThumbnails();
      showToast('Gradient applied', 'success');

      if (gradientPopup) {
        gradientPopup.remove();
        gradientPopup = null;
      }
    }

    function removeFill() {
      if (!selectedElement) return;

      if (selectedElement.type === 'shape') {
        selectedElement.fill = 'transparent';
      } else if (selectedElement.style) {
        selectedElement.style.background = 'transparent';
      }

      renderSlide();
      renderThumbnails();
      showToast('Fill removed', 'info');

      if (gradientPopup) {
        gradientPopup.remove();
        gradientPopup = null;
      }
    }

    // ==================== HYPERLINKS ====================
    function insertHyperlink() {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      // Populate slide dropdown
      const slideSelect = document.getElementById('linkSlide');
      slideSelect.innerHTML = slides.map((s, i) =>
        `<option value="${i}">Slide ${i + 1}</option>`
      ).join('');

      // Pre-fill if element already has a link
      if (selectedElement.hyperlink) {
        const link = selectedElement.hyperlink;
        document.getElementById('linkType').value = link.type || 'url';
        document.getElementById('linkUrl').value = link.url || '';
        document.getElementById('linkSlide').value = link.slideIndex || 0;
        document.getElementById('linkEmail').value = link.email || '';
        document.getElementById('linkText').value = link.text || '';
        updateLinkFields();
      } else {
        document.getElementById('linkType').value = 'url';
        document.getElementById('linkUrl').value = '';
        document.getElementById('linkText').value = '';
        updateLinkFields();
      }

      document.getElementById('hyperlinkModal').classList.add('active');
    }

    function hideHyperlinkModal() {
      document.getElementById('hyperlinkModal').classList.remove('active');
    }

    function updateLinkFields() {
      const type = document.getElementById('linkType').value;
      document.getElementById('urlField').style.display = type === 'url' ? 'block' : 'none';
      document.getElementById('slideField').style.display = type === 'slide' ? 'block' : 'none';
      document.getElementById('emailField').style.display = type === 'email' ? 'block' : 'none';
    }

    function applyHyperlink() {
      if (!selectedElement) return;

      const type = document.getElementById('linkType').value;
      const text = document.getElementById('linkText').value;

      let hyperlink = { type, text };

      switch (type) {
        case 'url':
          hyperlink.url = document.getElementById('linkUrl').value;
          if (!hyperlink.url) {
            showToast('Please enter a URL', 'warning');
            return;
          }
          break;
        case 'slide':
          hyperlink.slideIndex = parseInt(document.getElementById('linkSlide').value);
          break;
        case 'email':
          hyperlink.email = document.getElementById('linkEmail').value;
          if (!hyperlink.email) {
            showToast('Please enter an email', 'warning');
            return;
          }
          break;
      }

      saveState();
      selectedElement.hyperlink = hyperlink;

      // Add visual indicator
      if (selectedElement.type === 'text') {
        selectedElement.style.textDecoration = 'underline';
        selectedElement.style.color = '#1a73e8';
      }

      renderSlide();
      hideHyperlinkModal();
      showToast('Hyperlink added', 'success');
    }

    function removeHyperlink() {
      if (!selectedElement) return;

      delete selectedElement.hyperlink;

      if (selectedElement.type === 'text') {
        selectedElement.style.textDecoration = 'none';
      }

      renderSlide();
      hideHyperlinkModal();
      showToast('Hyperlink removed', 'info');
    }

    // Handle hyperlink clicks in presentation mode
    function handleHyperlinkClick(element) {
      if (!element.hyperlink) return;

      const link = element.hyperlink;
      switch (link.type) {
        case 'url':
          window.open(link.url, '_blank');
          break;
        case 'slide':
          presentationIndex = link.slideIndex;
          renderPresentationSlide();
          break;
        case 'email':
          window.location.href = 'mailto:' + link.email;
          break;
      }
    }

    // ==================== IMAGE CROP ====================
    let cropElement = null;

    function showImageCrop() {
      if (!selectedElement || selectedElement.type !== 'image') {
        showToast('Select an image first', 'warning');
        return;
      }

      cropElement = selectedElement;

      // Show image in preview
      document.getElementById('cropPreviewImage').src = selectedElement.src;

      // Reset crop values
      const crop = selectedElement.crop || { top: 0, right: 0, bottom: 0, left: 0 };
      document.getElementById('cropTop').value = crop.top;
      document.getElementById('cropRight').value = crop.right;
      document.getElementById('cropBottom').value = crop.bottom;
      document.getElementById('cropLeft').value = crop.left;

      updateCropPreview();
      document.getElementById('imageCropModal').classList.add('active');
    }

    function hideImageCrop() {
      document.getElementById('imageCropModal').classList.remove('active');
      cropElement = null;
    }

    function updateCropPreview() {
      const top = parseInt(document.getElementById('cropTop').value) || 0;
      const right = parseInt(document.getElementById('cropRight').value) || 0;
      const bottom = parseInt(document.getElementById('cropBottom').value) || 0;
      const left = parseInt(document.getElementById('cropLeft').value) || 0;

      const overlay = document.getElementById('cropOverlay');
      overlay.style.top = `${top}%`;
      overlay.style.right = `${right}%`;
      overlay.style.bottom = `${bottom}%`;
      overlay.style.left = `${left}%`;
      overlay.style.background = 'rgba(26, 115, 232, 0.2)';
    }

    function setCropPreset(preset) {
      const img = document.getElementById('cropPreviewImage');
      const imgRatio = img.naturalWidth / img.naturalHeight;

      let targetRatio;
      switch (preset) {
        case '16:9':
          targetRatio = 16 / 9;
          break;
        case '4:3':
          targetRatio = 4 / 3;
          break;
        case '1:1':
          targetRatio = 1;
          break;
        case 'reset':
          document.getElementById('cropTop').value = 0;
          document.getElementById('cropRight').value = 0;
          document.getElementById('cropBottom').value = 0;
          document.getElementById('cropLeft').value = 0;
          updateCropPreview();
          return;
      }

      // Calculate crop to achieve target ratio
      if (imgRatio > targetRatio) {
        // Image is wider, crop left/right
        const excessWidth = (1 - targetRatio / imgRatio) * 100;
        document.getElementById('cropLeft').value = Math.round(excessWidth / 2);
        document.getElementById('cropRight').value = Math.round(excessWidth / 2);
        document.getElementById('cropTop').value = 0;
        document.getElementById('cropBottom').value = 0;
      } else {
        // Image is taller, crop top/bottom
        const excessHeight = (1 - imgRatio / targetRatio) * 100;
        document.getElementById('cropTop').value = Math.round(excessHeight / 2);
        document.getElementById('cropBottom').value = Math.round(excessHeight / 2);
        document.getElementById('cropLeft').value = 0;
        document.getElementById('cropRight').value = 0;
      }

      updateCropPreview();
    }

    function applyCrop() {
      if (!cropElement) return;

      saveState();

      cropElement.crop = {
        top: parseInt(document.getElementById('cropTop').value) || 0,
        right: parseInt(document.getElementById('cropRight').value) || 0,
        bottom: parseInt(document.getElementById('cropBottom').value) || 0,
        left: parseInt(document.getElementById('cropLeft').value) || 0
      };

      renderSlide();
      renderThumbnails();
      hideImageCrop();
      showToast('Crop applied', 'success');
    }

    // ==================== ANIMATION TIMING ====================
    function showAnimationTiming() {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      if (!selectedElement.animation) {
        showToast('Add an animation first', 'warning');
        return;
      }

      const anim = selectedElement.animation;
      document.getElementById('animStart').value = anim.start || 'onClick';
      document.getElementById('animDuration').value = anim.duration || 0.5;
      document.getElementById('animDelay').value = anim.delay || 0;
      document.getElementById('animRepeat').value = anim.repeat || '1';
      document.getElementById('animRewind').checked = anim.rewind || false;

      document.getElementById('animationTimingModal').classList.add('active');
    }

    function hideAnimationTiming() {
      document.getElementById('animationTimingModal').classList.remove('active');
    }

    function applyAnimationTiming() {
      if (!selectedElement || !selectedElement.animation) return;

      saveState();

      selectedElement.animation.start = document.getElementById('animStart').value;
      selectedElement.animation.duration = parseFloat(document.getElementById('animDuration').value);
      selectedElement.animation.delay = parseFloat(document.getElementById('animDelay').value);
      selectedElement.animation.repeat = document.getElementById('animRepeat').value;
      selectedElement.animation.rewind = document.getElementById('animRewind').checked;

      updateAnimationList();
      hideAnimationTiming();
      showToast('Animation timing updated', 'success');
    }

    // ==================== SLIDE LAYOUTS PANEL ====================
    function showLayoutsPanel() {
      document.getElementById('layoutsModal').classList.add('active');
    }

    function hideLayoutsPanel() {
      document.getElementById('layoutsModal').classList.remove('active');
    }

    // Extended applyLayout function
    const extendedApplyLayout = applyLayout;
    applyLayout = function(layout) {
      const slide = slides[currentSlideIndex];
      slide.elements = [];
      saveState();

      if (layout === 'title') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 80, y: 200, width: 800, height: 80,
          content: 'Title Slide', style: { fontSize: '64px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'center' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 80, y: 300, width: 800, height: 50,
          content: 'Subtitle goes here', style: { fontSize: '28px', fontFamily: 'Arial', color: '#666666', textAlign: 'center' }
        });
      } else if (layout === 'titleContent') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 30, width: 880, height: 60,
          content: 'Slide Title', style: { fontSize: '36px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'left' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 120, width: 880, height: 380,
          content: 'â€¢ First point\nâ€¢ Second point\nâ€¢ Third point', style: { fontSize: '24px', fontFamily: 'Arial', color: '#333333', textAlign: 'left' }
        });
      } else if (layout === 'twoColumn') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 30, width: 880, height: 50,
          content: 'Two Column Layout', style: { fontSize: '36px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'center' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 40, y: 100, width: 420, height: 400,
          content: 'Left column content\nâ€¢ Point 1\nâ€¢ Point 2', style: { fontSize: '20px', fontFamily: 'Arial', color: '#333333', textAlign: 'left' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 500, y: 100, width: 420, height: 400,
          content: 'Right column content\nâ€¢ Point 1\nâ€¢ Point 2', style: { fontSize: '20px', fontFamily: 'Arial', color: '#333333', textAlign: 'left' }
        });
      } else if (layout === 'blank') {
        // Keep slide empty
      } else if (layout === 'sectionHeader') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 80, y: 220, width: 800, height: 80,
          content: 'Section Title', style: { fontSize: '48px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'center' }
        });
      } else if (layout === 'contentWithCaption') {
        slide.elements.push({
          id: ++elementIdCounter, type: 'shape', x: 40, y: 40, width: 580, height: 420, shape: 'rectangle',
          style: { background: '#e8f0fe' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 650, y: 40, width: 280, height: 60,
          content: 'Caption Title', style: { fontSize: '24px', fontWeight: 'bold', fontFamily: 'Arial', color: '#1a1a1a', textAlign: 'left' }
        });
        slide.elements.push({
          id: ++elementIdCounter, type: 'text', x: 650, y: 110, width: 280, height: 350,
          content: 'Description text goes here. Add supporting details for the main content.', style: { fontSize: '16px', fontFamily: 'Arial', color: '#666666', textAlign: 'left' }
        });
      }

      renderSlide();
      renderThumbnails();
      hideLayoutsPanel();
      showToast(`Applied ${layout} layout`, 'success');
    };

    // ==================== SHAPE EFFECTS ====================
    function showShapeEffects() {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      // Pre-fill with existing effects
      if (selectedElement.effects) {
        const e = selectedElement.effects;
        document.getElementById('shadowEffect').value = e.shadow || 'none';
        document.getElementById('shadowColor').value = e.shadowColor || '#000000';
        document.getElementById('shapeOpacity').value = e.opacity !== undefined ? e.opacity : 100;
        document.getElementById('shapeRotation').value = e.rotation || 0;
        document.getElementById('shapeBorder').value = e.border || 'none';
        document.getElementById('shapeBorderWidth').value = e.borderWidth || 2;
        document.getElementById('shapeBorderColor').value = e.borderColor || '#000000';
        document.getElementById('glowEffect').value = e.glow || 'none';
        document.getElementById('glowColor').value = e.glowColor || '#1a73e8';
      } else {
        // Reset to defaults
        document.getElementById('shadowEffect').value = 'none';
        document.getElementById('shadowColor').value = '#000000';
        document.getElementById('shapeOpacity').value = 100;
        document.getElementById('shapeRotation').value = 0;
        document.getElementById('shapeBorder').value = 'none';
        document.getElementById('shapeBorderWidth').value = 2;
        document.getElementById('shapeBorderColor').value = '#000000';
        document.getElementById('glowEffect').value = 'none';
        document.getElementById('glowColor').value = '#1a73e8';
      }

      updateShapePreview();
      document.getElementById('shapeEffectsModal').classList.add('active');
    }

    function hideShapeEffects() {
      document.getElementById('shapeEffectsModal').classList.remove('active');
    }

    function updateShapePreview() {
      const preview = document.getElementById('previewShape');
      const shadow = document.getElementById('shadowEffect').value;
      const shadowColor = document.getElementById('shadowColor').value;
      const opacity = document.getElementById('shapeOpacity').value;
      const rotation = document.getElementById('shapeRotation').value;
      const glow = document.getElementById('glowEffect').value;
      const glowColor = document.getElementById('glowColor').value;

      let boxShadow = '';

      // Shadow
      const shadowSizes = {
        'none': '',
        'small': `3px 3px 6px ${shadowColor}66`,
        'medium': `5px 5px 15px ${shadowColor}88`,
        'large': `8px 8px 25px ${shadowColor}aa`,
        'inner': `inset 3px 3px 10px ${shadowColor}66`
      };
      if (shadow !== 'none') {
        boxShadow = shadowSizes[shadow];
      }

      // Glow
      const glowSizes = {
        'none': '',
        'small': `0 0 10px ${glowColor}`,
        'medium': `0 0 20px ${glowColor}`,
        'large': `0 0 30px ${glowColor}`
      };
      if (glow !== 'none') {
        boxShadow += (boxShadow ? ', ' : '') + glowSizes[glow];
      }

      preview.style.boxShadow = boxShadow;
      preview.style.opacity = opacity / 100;
      preview.style.transform = `rotate(${rotation}deg)`;
    }

    function applyShapeEffects() {
      if (!selectedElement) return;

      saveState();

      selectedElement.effects = {
        shadow: document.getElementById('shadowEffect').value,
        shadowColor: document.getElementById('shadowColor').value,
        opacity: parseInt(document.getElementById('shapeOpacity').value),
        rotation: parseInt(document.getElementById('shapeRotation').value),
        border: document.getElementById('shapeBorder').value,
        borderWidth: parseInt(document.getElementById('shapeBorderWidth').value),
        borderColor: document.getElementById('shapeBorderColor').value,
        glow: document.getElementById('glowEffect').value,
        glowColor: document.getElementById('glowColor').value
      };

      renderSlide();
      hideShapeEffects();
      showToast('Shape effects applied', 'success');
    }

    function clearShapeEffects() {
      if (!selectedElement) return;

      saveState();
      delete selectedElement.effects;

      renderSlide();
      hideShapeEffects();
      showToast('Effects cleared', 'info');
    }

    // ==================== ANIMATION PICKER ====================
    const animationLibrary = {
      entrance: [
        { name: 'fadeIn', label: 'Fade In' },
        { name: 'slideIn', label: 'Slide In Left' },
        { name: 'slideInRight', label: 'Slide In Right' },
        { name: 'slideInUp', label: 'Slide In Up' },
        { name: 'slideInDown', label: 'Slide In Down' },
        { name: 'zoomIn', label: 'Zoom In' },
        { name: 'bounceIn', label: 'Bounce In' },
        { name: 'flyIn', label: 'Fly In' },
        { name: 'flipIn', label: 'Flip In' },
        { name: 'swingIn', label: 'Swing In' },
        { name: 'expandIn', label: 'Expand In' },
        { name: 'wipeIn', label: 'Wipe In' },
        { name: 'splitIn', label: 'Split In' },
        { name: 'floatIn', label: 'Float In' },
        { name: 'rotateIn', label: 'Rotate In' }
      ],
      emphasis: [
        { name: 'pulse', label: 'Pulse' },
        { name: 'shake', label: 'Shake' },
        { name: 'spin', label: 'Spin' },
        { name: 'grow', label: 'Grow/Shrink' },
        { name: 'teeter', label: 'Teeter' },
        { name: 'flash', label: 'Flash' },
        { name: 'colorPulse', label: 'Color Pulse' },
        { name: 'wobble', label: 'Wobble' },
        { name: 'heartbeat', label: 'Heartbeat' },
        { name: 'jello', label: 'Jello' }
      ],
      exit: [
        { name: 'fadeOut', label: 'Fade Out' },
        { name: 'slideOut', label: 'Slide Out Right' },
        { name: 'slideOutLeft', label: 'Slide Out Left' },
        { name: 'slideOutUp', label: 'Slide Out Up' },
        { name: 'slideOutDown', label: 'Slide Out Down' },
        { name: 'zoomOut', label: 'Zoom Out' },
        { name: 'flyOut', label: 'Fly Out' },
        { name: 'flipOut', label: 'Flip Out' },
        { name: 'shrinkOut', label: 'Shrink Out' }
      ]
    };

    function showAnimationPicker(category) {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      const titles = { entrance: 'Entrance Animations', emphasis: 'Emphasis Animations', exit: 'Exit Animations' };
      document.getElementById('animPickerTitle').textContent = titles[category] || 'Choose Animation';

      const content = document.getElementById('animationPickerContent');
      const animations = animationLibrary[category] || [];

      content.innerHTML = animations.map(anim => `
        <button class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.85rem;" onclick="addAnimation('${anim.name}'); hideAnimationPicker();">
          ${anim.label}
        </button>
      `).join('');

      document.getElementById('animationPickerModal').classList.add('active');
    }

    function hideAnimationPicker() {
      document.getElementById('animationPickerModal').classList.remove('active');
    }

    // ==================== MOTION PATHS ====================
    let motionPathAnimationId = null;

    function showMotionPathEditor() {
      if (!selectedElement) {
        showToast('Select an element first', 'warning');
        return;
      }

      // Pre-fill with existing motion path if any
      if (selectedElement.motionPath) {
        document.getElementById('motionPathType').value = selectedElement.motionPath.type || 'line';
        document.getElementById('motionDirection').value = selectedElement.motionPath.direction || 'right';
        document.getElementById('motionDistance').value = selectedElement.motionPath.distance || 200;
        document.getElementById('motionDuration').value = selectedElement.motionPath.duration || 1;
      }

      document.getElementById('motionPathModal').classList.add('active');
      previewMotionPath();
    }

    function hideMotionPathEditor() {
      document.getElementById('motionPathModal').classList.remove('active');
      if (motionPathAnimationId) {
        cancelAnimationFrame(motionPathAnimationId);
        motionPathAnimationId = null;
      }
    }

    function getMotionPathPoints(type, distance, direction) {
      const points = [];
      const startX = direction === 'left' ? distance : 50;
      const startY = direction === 'up' ? distance : 50;
      const endX = direction === 'right' ? distance + 50 : (direction === 'left' ? 50 : startX);
      const endY = direction === 'down' ? distance + 50 : (direction === 'up' ? 50 : startY);

      switch (type) {
        case 'line':
          points.push({ x: startX, y: startY });
          points.push({ x: endX, y: endY });
          break;
        case 'arc':
          for (let t = 0; t <= 1; t += 0.05) {
            const x = startX + (endX - startX) * t;
            const y = startY + Math.sin(t * Math.PI) * distance * 0.5;
            points.push({ x, y });
          }
          break;
        case 'circle':
          for (let angle = 0; angle <= 2 * Math.PI; angle += 0.1) {
            const x = startX + Math.cos(angle) * distance * 0.3;
            const y = startY + Math.sin(angle) * distance * 0.3;
            points.push({ x, y });
          }
          break;
        case 'figure8':
          for (let t = 0; t <= 2 * Math.PI; t += 0.1) {
            const x = startX + Math.sin(t) * distance * 0.3;
            const y = startY + Math.sin(2 * t) * distance * 0.2;
            points.push({ x, y });
          }
          break;
        case 'zigzag':
          const segments = 4;
          for (let i = 0; i <= segments; i++) {
            const x = startX + (i / segments) * (endX - startX);
            const y = startY + (i % 2 === 0 ? 0 : 30);
            points.push({ x, y });
          }
          break;
        case 'wave':
          for (let t = 0; t <= 1; t += 0.02) {
            const x = startX + t * (endX - startX);
            const y = startY + Math.sin(t * Math.PI * 4) * 30;
            points.push({ x, y });
          }
          break;
        case 'spiral':
          for (let angle = 0; angle <= 4 * Math.PI; angle += 0.1) {
            const radius = 10 + angle * 5;
            const x = startX + Math.cos(angle) * radius * 0.3;
            const y = startY + Math.sin(angle) * radius * 0.3;
            points.push({ x, y });
          }
          break;
        default:
          points.push({ x: startX, y: startY });
          points.push({ x: endX, y: endY });
      }
      return points;
    }

    function previewMotionPath() {
      const type = document.getElementById('motionPathType').value;
      const direction = document.getElementById('motionDirection').value;
      const distance = parseInt(document.getElementById('motionDistance').value);
      const duration = parseFloat(document.getElementById('motionDuration').value);

      const points = getMotionPathPoints(type, distance, direction);
      const svg = document.getElementById('motionPreviewPath');
      const dot = document.getElementById('motionPreviewDot');

      // Draw path in SVG
      const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
      svg.innerHTML = `<path d="${pathData}" fill="none" stroke="#4285f4" stroke-width="2" stroke-dasharray="5,5"/>`;

      // Animate the dot
      if (motionPathAnimationId) cancelAnimationFrame(motionPathAnimationId);

      let startTime = null;
      const animate = (timestamp) => {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / (duration * 1000), 1);

        const idx = Math.min(Math.floor(progress * (points.length - 1)), points.length - 1);
        const nextIdx = Math.min(idx + 1, points.length - 1);
        const t = (progress * (points.length - 1)) - idx;

        const x = points[idx].x + (points[nextIdx].x - points[idx].x) * t;
        const y = points[idx].y + (points[nextIdx].y - points[idx].y) * t;

        dot.style.left = `${x - 10}px`;
        dot.style.top = `${y - 10}px`;

        if (progress < 1) {
          motionPathAnimationId = requestAnimationFrame(animate);
        } else {
          startTime = null;
          setTimeout(() => {
            if (document.getElementById('motionPathModal').classList.contains('active')) {
              motionPathAnimationId = requestAnimationFrame(animate);
            }
          }, 500);
        }
      };

      motionPathAnimationId = requestAnimationFrame(animate);
    }

    function applyMotionPath() {
      if (!selectedElement) return;

      const type = document.getElementById('motionPathType').value;
      const direction = document.getElementById('motionDirection').value;
      const distance = parseInt(document.getElementById('motionDistance').value);
      const duration = parseFloat(document.getElementById('motionDuration').value);

      selectedElement.motionPath = { type, direction, distance, duration };

      // Create a custom CSS animation for the motion path
      const animName = `motionPath_${selectedElement.id}`;
      const points = getMotionPathPoints(type, distance, direction);

      // Generate keyframes
      let keyframes = '@keyframes ' + animName + ' {\n';
      points.forEach((p, i) => {
        const pct = Math.round((i / (points.length - 1)) * 100);
        keyframes += `  ${pct}% { transform: translate(${p.x - 50}px, ${p.y - 50}px); }\n`;
      });
      keyframes += '}';

      // Add to document
      const style = document.createElement('style');
      style.textContent = keyframes;
      document.head.appendChild(style);

      // Set the animation on the element
      selectedElement.animation = {
        type: animName,
        duration: duration,
        delay: 0,
        order: 1
      };

      updateAnimationList();
      hideMotionPathEditor();
      showToast('Motion path applied', 'success');
    }

    // ==================== SLIDE SECTIONS ====================
    let slideSections = [];

    function showSectionsModal() {
      updateSectionsList();
      document.getElementById('newSectionName').value = '';
      document.getElementById('sectionsModal').classList.add('active');
    }

    function hideSectionsModal() {
      document.getElementById('sectionsModal').classList.remove('active');
    }

    function addSection() {
      const name = document.getElementById('newSectionName').value.trim();
      if (!name) {
        showToast('Enter a section name', 'warning');
        return;
      }

      slideSections.push({
        name: name,
        startSlide: currentSlideIndex,
        collapsed: false
      });

      // Mark the current slide as a section header
      slides[currentSlideIndex].sectionStart = name;

      updateSectionsList();
      renderThumbnails();
      document.getElementById('newSectionName').value = '';
      showToast(`Section "${name}" created`, 'success');
    }

    function updateSectionsList() {
      const list = document.getElementById('sectionsList');

      if (slideSections.length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); font-size: 0.9rem; text-align: center;">No sections defined yet.</p>';
        return;
      }

      list.innerHTML = slideSections.map((section, idx) => `
        <div style="display: flex; align-items: center; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem;">
          <span style="flex: 1; cursor: pointer;" onclick="goToSection(${idx})">${section.name}</span>
          <span style="color: var(--secondary); margin-right: 0.5rem; font-size: 0.85rem;">Slide ${section.startSlide + 1}</span>
          <button class="btn btn-danger" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="removeSection(${idx})">X</button>
        </div>
      `).join('');
    }

    function goToSection(idx) {
      if (slideSections[idx]) {
        currentSlideIndex = slideSections[idx].startSlide;
        renderSlide();
        renderThumbnails();
        showToast(`Jumped to "${slideSections[idx].name}"`, 'info');
      }
    }

    function removeSection(idx) {
      const section = slideSections[idx];
      if (section) {
        // Remove section marker from slide
        if (slides[section.startSlide]) {
          delete slides[section.startSlide].sectionStart;
        }
        slideSections.splice(idx, 1);
        updateSectionsList();
        renderThumbnails();
        showToast('Section removed', 'success');
      }
    }

    // Add sections button to View toolbar dynamically
    const viewToolbar = document.getElementById('viewToolbar');
    if (viewToolbar) {
      const sectionsBtn = document.createElement('div');
      sectionsBtn.className = 'toolbar-group';
      sectionsBtn.innerHTML = `<button class="toolbar-btn" onclick="showSectionsModal()">ðŸ“‘ Sections</button>`;
      viewToolbar.appendChild(sectionsBtn);
    }

    // Update renderThumbnails to show section headers
    const originalRenderThumbnails = renderThumbnails;
    renderThumbnails = function() {
      originalRenderThumbnails();

      // Add section headers to thumbnail strip
      slideSections.forEach(section => {
        const thumbnail = document.querySelector(`.thumbnail:nth-child(${section.startSlide + 1})`);
        if (thumbnail) {
          // Check if section header already exists
          if (!thumbnail.querySelector('.section-header')) {
            const header = document.createElement('div');
            header.className = 'section-header';
            header.style.cssText = 'position: absolute; top: -20px; left: 0; right: 0; background: #1a73e8; color: white; font-size: 10px; padding: 2px 5px; border-radius: 3px 3px 0 0;';
            header.textContent = section.name;
            thumbnail.style.position = 'relative';
            thumbnail.style.marginTop = '25px';
            thumbnail.appendChild(header);
          }
        }
      });
    };

    // ==========================================
    // Morph Transition Functions
    // ==========================================
    function applyMorphTransition(fromSlide, toSlide, duration) {
      // Morph transitions work by matching elements with same IDs or content
      // and creating smooth transitions between their states

      const canvas = document.getElementById('slideCanvas');
      const fromElements = fromSlide.elements || [];
      const toElements = toSlide.elements || [];

      // Find matching elements
      const matches = [];
      toElements.forEach(toEl => {
        const fromEl = fromElements.find(f =>
          f.id === toEl.id ||
          (f.type === toEl.type && f.content === toEl.content)
        );
        if (fromEl) {
          matches.push({ from: fromEl, to: toEl });
        }
      });

      // Animate matching elements
      matches.forEach(({ from, to }) => {
        const el = document.getElementById(to.id);
        if (el) {
          // Set initial position/size from source
          el.style.transition = 'none';
          el.style.left = from.x + 'px';
          el.style.top = from.y + 'px';
          el.style.width = from.width + 'px';
          el.style.height = from.height + 'px';
          el.style.opacity = '0.5';

          // Force reflow
          el.offsetHeight;

          // Animate to target position/size
          el.style.transition = `all ${duration}s ease-in-out`;
          el.style.left = to.x + 'px';
          el.style.top = to.y + 'px';
          el.style.width = to.width + 'px';
          el.style.height = to.height + 'px';
          el.style.opacity = '1';
        }
      });
    }

    // Enhanced setTransition to handle morph
    const originalSetTransition = setTransition;
    setTransition = function(type) {
      originalSetTransition(type);

      // If morph is selected, show info toast
      if (type === 'morph') {
        showToast('Morph transition: Elements with same content/ID will smoothly transform', 'info');
      }
    };

    // ==========================================
    // Action Buttons Functions
    // ==========================================
    let selectedActionBtnType = 'next';

    function showActionButtons() {
      document.getElementById('actionButtonsModal').style.display = 'flex';

      // Setup action change handler
      document.getElementById('actionBtnAction').onchange = function() {
        document.getElementById('gotoSlideGroup').style.display =
          this.value === 'goto-slide' ? 'block' : 'none';
        document.getElementById('hyperlinkGroup').style.display =
          this.value === 'hyperlink' ? 'block' : 'none';
      };
    }

    function hideActionButtons() {
      document.getElementById('actionButtonsModal').style.display = 'none';
    }

    function selectActionBtnType(type) {
      selectedActionBtnType = type;
      document.querySelectorAll('.action-btn-type').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });

      // Auto-set action based on type
      const actionSelect = document.getElementById('actionBtnAction');
      switch (type) {
        case 'next': actionSelect.value = 'next-slide'; break;
        case 'previous': actionSelect.value = 'prev-slide'; break;
        case 'first': actionSelect.value = 'first-slide'; break;
        case 'last': actionSelect.value = 'last-slide'; break;
        case 'home': actionSelect.value = 'first-slide'; break;
        default: actionSelect.value = 'next-slide';
      }
    }

    function getActionBtnIcon(type) {
      const icons = {
        next: 'â–¶',
        previous: 'â—€',
        first: 'â®',
        last: 'â­',
        home: 'ðŸ ',
        info: 'â„¹',
        help: 'â“',
        custom: 'âš™'
      };
      return icons[type] || 'â–¶';
    }

    function insertActionButton() {
      const action = document.getElementById('actionBtnAction').value;
      const color = document.getElementById('actionBtnColor').value;
      const textColor = document.getElementById('actionBtnTextColor').value;
      const label = document.getElementById('actionBtnLabel').value;
      const gotoSlide = document.getElementById('gotoSlideNum').value;
      const url = document.getElementById('actionBtnUrl').value;

      const canvas = document.getElementById('slideCanvas');
      const id = 'action_' + Date.now();

      const button = document.createElement('div');
      button.className = 'slide-element action-button';
      button.id = id;
      button.style.cssText = `
        left: 50px;
        top: 50px;
        width: ${label ? 'auto' : '60px'};
        min-width: 60px;
        height: 60px;
        background: ${color};
        color: ${textColor};
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: ${label ? '14px' : '24px'};
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        padding: ${label ? '0 1rem' : '0'};
        gap: 0.5rem;
      `;

      button.innerHTML = `
        <span>${getActionBtnIcon(selectedActionBtnType)}</span>
        ${label ? `<span>${label}</span>` : ''}
      `;

      button.dataset.action = action;
      button.dataset.gotoSlide = gotoSlide;
      button.dataset.url = url;

      // Handle click in slideshow mode
      button.onclick = function(e) {
        if (document.fullscreenElement) {
          e.stopPropagation();
          handleActionButtonClick(this);
        }
      };

      canvas.appendChild(button);
      addDragHandlers(button);

      // Save to slide elements
      const slide = slides[currentSlideIndex];
      if (!slide.elements) slide.elements = [];
      slide.elements.push({
        id,
        type: 'action-button',
        x: 50,
        y: 50,
        width: 60,
        height: 60,
        action,
        gotoSlide,
        url,
        color,
        textColor,
        label,
        btnType: selectedActionBtnType
      });

      hideActionButtons();
      showToast('Action button added', 'success');
    }

    function handleActionButtonClick(button) {
      const action = button.dataset.action;

      switch (action) {
        case 'next-slide':
          if (currentSlideIndex < slides.length - 1) {
            goToSlide(currentSlideIndex + 1);
          }
          break;
        case 'prev-slide':
          if (currentSlideIndex > 0) {
            goToSlide(currentSlideIndex - 1);
          }
          break;
        case 'first-slide':
          goToSlide(0);
          break;
        case 'last-slide':
          goToSlide(slides.length - 1);
          break;
        case 'goto-slide':
          const slideNum = parseInt(button.dataset.gotoSlide) - 1;
          if (slideNum >= 0 && slideNum < slides.length) {
            goToSlide(slideNum);
          }
          break;
        case 'hyperlink':
          const url = button.dataset.url;
          if (url) window.open(url, '_blank');
          break;
        case 'end-show':
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
          break;
      }
    }

    // ==========================================
    // Rehearse Timings Functions
    // ==========================================
    let rehearseInterval = null;
    let rehearseStartTime = null;
    let rehearsePaused = false;
    let rehearseSlideIndex = 0;
    let rehearsedTimings = [];
    let slideStartTime = null;
    let totalRehearsedTime = 0;
    let useTimingsInSlideshow = false;

    function startRehearseTiming() {
      rehearseSlideIndex = 0;
      rehearsedTimings = slides.map(() => 0);
      rehearsePaused = false;
      totalRehearsedTime = 0;

      document.getElementById('rehearseTimingsModal').style.display = 'flex';
      goToSlide(0);
      updateRehearseUI();

      rehearseStartTime = Date.now();
      slideStartTime = Date.now();

      rehearseInterval = setInterval(updateRehearseTimer, 100);
      showToast('Rehearsal started - Navigate through slides to record timings', 'info');
    }

    function updateRehearseTimer() {
      if (rehearsePaused) return;

      const now = Date.now();
      const slideTime = now - slideStartTime;
      const totalTime = now - rehearseStartTime;

      document.getElementById('rehearseTimer').textContent = formatTime(slideTime);
      document.getElementById('rehearseTotalTime').textContent = 'Total: ' + formatTime(totalTime);
    }

    function formatTime(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateRehearseUI() {
      document.getElementById('rehearseSlideInfo').textContent =
        `Slide ${rehearseSlideIndex + 1} of ${slides.length}`;
    }

    function rehearseNextSlide() {
      // Record current slide timing
      const slideTime = Date.now() - slideStartTime;
      rehearsedTimings[rehearseSlideIndex] = slideTime;

      if (rehearseSlideIndex < slides.length - 1) {
        rehearseSlideIndex++;
        slideStartTime = Date.now();
        goToSlide(rehearseSlideIndex);
        updateRehearseUI();
      } else {
        // Last slide - save timings
        totalRehearsedTime = Date.now() - rehearseStartTime;
        saveRehearsedTimings();
      }
    }

    function rehearsePrevSlide() {
      // Record current slide timing
      const slideTime = Date.now() - slideStartTime;
      rehearsedTimings[rehearseSlideIndex] = slideTime;

      if (rehearseSlideIndex > 0) {
        rehearseSlideIndex--;
        slideStartTime = Date.now();
        goToSlide(rehearseSlideIndex);
        updateRehearseUI();
      }
    }

    function rehearsePause() {
      rehearsePaused = !rehearsePaused;
      const btn = document.getElementById('rehearsePauseBtn');

      if (rehearsePaused) {
        btn.textContent = 'â–¶ Resume';
        btn.className = 'btn btn-success';
      } else {
        btn.textContent = 'â¸ Pause';
        btn.className = 'btn btn-danger';
        // Adjust start times to account for pause
        slideStartTime = Date.now() - (Date.now() - slideStartTime);
      }
    }

    function stopRehearseTiming() {
      if (rehearseInterval) {
        clearInterval(rehearseInterval);
        rehearseInterval = null;
      }
      document.getElementById('rehearseTimingsModal').style.display = 'none';
    }

    function saveRehearsedTimings() {
      // Save final slide timing
      const slideTime = Date.now() - slideStartTime;
      rehearsedTimings[rehearseSlideIndex] = slideTime;

      // Store timings in slides
      slides.forEach((slide, i) => {
        slide.timing = rehearsedTimings[i] || 0;
      });

      stopRehearseTiming();
      showToast(`Timings saved! Total: ${formatTime(Date.now() - rehearseStartTime)}`, 'success');
    }

    function showRecordedTimings() {
      const timingsList = document.getElementById('timingsList');
      let totalTime = 0;

      if (!slides.some(s => s.timing > 0)) {
        timingsList.innerHTML = '<p style="text-align: center; color: var(--secondary);">No timings recorded yet. Use "Rehearse Timings" to record.</p>';
        document.getElementById('totalPresentationTime').textContent = '00:00';
      } else {
        timingsList.innerHTML = slides.map((slide, i) => {
          const time = slide.timing || 0;
          totalTime += time;
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border);">
              <span>Slide ${i + 1}</span>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="number" value="${Math.round(time / 1000)}" min="1" max="300"
                       style="width: 60px; padding: 0.25rem; border: 1px solid var(--border); border-radius: 4px;"
                       onchange="updateSlideTiming(${i}, this.value)">
                <span style="color: var(--secondary);">sec</span>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('totalPresentationTime').textContent = formatTime(totalTime);
      }

      document.getElementById('recordedTimingsModal').style.display = 'flex';
    }

    function hideRecordedTimings() {
      document.getElementById('recordedTimingsModal').style.display = 'none';
    }

    function updateSlideTiming(slideIndex, seconds) {
      slides[slideIndex].timing = seconds * 1000;

      // Update total time
      let totalTime = slides.reduce((sum, s) => sum + (s.timing || 0), 0);
      document.getElementById('totalPresentationTime').textContent = formatTime(totalTime);
    }

    function clearAllTimings() {
      if (confirm('Clear all recorded timings?')) {
        slides.forEach(slide => delete slide.timing);
        showRecordedTimings();
        showToast('All timings cleared', 'success');
      }
    }

    function applyTimingsToSlideshow() {
      useTimingsInSlideshow = true;
      hideRecordedTimings();
      showToast('Timings will be used in slideshow mode', 'success');
    }

    // Modify startPresentation to use timings
    const originalStartPresentation = startPresentation;
    startPresentation = function() {
      originalStartPresentation();

      if (useTimingsInSlideshow && slides[currentSlideIndex]?.timing > 0) {
        startAutoAdvance();
      }
    };

    let autoAdvanceTimeout = null;

    function startAutoAdvance() {
      const timing = slides[currentSlideIndex]?.timing;
      if (timing && timing > 0) {
        autoAdvanceTimeout = setTimeout(() => {
          if (currentSlideIndex < slides.length - 1) {
            goToSlide(currentSlideIndex + 1);
            startAutoAdvance();
          }
        }, timing);
      }
    }

    function stopAutoAdvance() {
      if (autoAdvanceTimeout) {
        clearTimeout(autoAdvanceTimeout);
        autoAdvanceTimeout = null;
      }
    }

    // ==================== SMARTART GRAPHICS ====================
    let selectedSmartArtType = 'basic-list';
    let selectedSmartArtCategory = 'list';

    const smartArtTypes = {
      list: [
        { id: 'basic-list', name: 'Basic List', icon: 'list-basic' },
        { id: 'lined-list', name: 'Lined List', icon: 'list-lined' },
        { id: 'vertical-bullet', name: 'Vertical Bullets', icon: 'list-vertical' },
        { id: 'horizontal-bullet', name: 'Horizontal Bullets', icon: 'list-horizontal' },
        { id: 'stacked-list', name: 'Stacked List', icon: 'list-stacked' },
        { id: 'grouped-list', name: 'Grouped List', icon: 'list-grouped' }
      ],
      process: [
        { id: 'basic-process', name: 'Basic Process', icon: 'process-basic' },
        { id: 'step-up', name: 'Step Up Process', icon: 'process-step' },
        { id: 'chevron', name: 'Chevron List', icon: 'process-chevron' },
        { id: 'arrow-process', name: 'Arrow Process', icon: 'process-arrow' },
        { id: 'segmented', name: 'Segmented Process', icon: 'process-segment' },
        { id: 'continuous', name: 'Continuous Process', icon: 'process-continuous' }
      ],
      cycle: [
        { id: 'basic-cycle', name: 'Basic Cycle', icon: 'cycle-basic' },
        { id: 'text-cycle', name: 'Text Cycle', icon: 'cycle-text' },
        { id: 'block-cycle', name: 'Block Cycle', icon: 'cycle-block' },
        { id: 'radial-cycle', name: 'Radial Cycle', icon: 'cycle-radial' },
        { id: 'gear', name: 'Gear', icon: 'cycle-gear' },
        { id: 'segmented-cycle', name: 'Segmented Cycle', icon: 'cycle-segment' }
      ],
      hierarchy: [
        { id: 'org-chart', name: 'Organization Chart', icon: 'hier-org' },
        { id: 'hierarchy', name: 'Hierarchy', icon: 'hier-basic' },
        { id: 'labeled-hier', name: 'Labeled Hierarchy', icon: 'hier-label' },
        { id: 'table-hier', name: 'Table Hierarchy', icon: 'hier-table' },
        { id: 'horizontal-org', name: 'Horizontal Org Chart', icon: 'hier-horiz' },
        { id: 'half-circle-org', name: 'Half Circle Org', icon: 'hier-half' }
      ],
      relationship: [
        { id: 'venn', name: 'Basic Venn', icon: 'rel-venn' },
        { id: 'linear-venn', name: 'Linear Venn', icon: 'rel-linear-venn' },
        { id: 'stacked-venn', name: 'Stacked Venn', icon: 'rel-stacked' },
        { id: 'radial', name: 'Basic Radial', icon: 'rel-radial' },
        { id: 'diverging', name: 'Diverging Radial', icon: 'rel-diverge' },
        { id: 'target', name: 'Basic Target', icon: 'rel-target' }
      ],
      matrix: [
        { id: 'basic-matrix', name: 'Basic Matrix', icon: 'matrix-basic' },
        { id: 'titled-matrix', name: 'Titled Matrix', icon: 'matrix-titled' },
        { id: 'grid-matrix', name: 'Grid Matrix', icon: 'matrix-grid' },
        { id: 'cycle-matrix', name: 'Cycle Matrix', icon: 'matrix-cycle' }
      ],
      pyramid: [
        { id: 'basic-pyramid', name: 'Basic Pyramid', icon: 'pyramid-basic' },
        { id: 'inverted-pyramid', name: 'Inverted Pyramid', icon: 'pyramid-invert' },
        { id: 'segmented-pyramid', name: 'Segmented Pyramid', icon: 'pyramid-segment' },
        { id: 'pyramid-list', name: 'Pyramid List', icon: 'pyramid-list' }
      ]
    };

    function showSmartArt() {
      document.getElementById('smartArtModal').style.display = 'flex';
      selectSmartArtCategory('list');
    }

    function hideSmartArt() {
      document.getElementById('smartArtModal').style.display = 'none';
    }

    function selectSmartArtCategory(category) {
      selectedSmartArtCategory = category;
      document.querySelectorAll('.smartart-category').forEach(el => {
        el.classList.toggle('active', el.dataset.category === category);
      });
      renderSmartArtGallery(category);
    }

    function renderSmartArtGallery(category) {
      const gallery = document.getElementById('smartArtGallery');
      const types = smartArtTypes[category] || [];

      gallery.innerHTML = types.map(type => `
        <div class="smartart-item ${type.id === selectedSmartArtType ? 'selected' : ''}"
             onclick="selectSmartArtType('${type.id}')"
             data-type="${type.id}">
          ${getSmartArtPreview(type.id)}
          <div style="font-size: 10px; margin-top: 4px; text-align: center;">${type.name}</div>
        </div>
      `).join('');
    }

    function selectSmartArtType(typeId) {
      selectedSmartArtType = typeId;
      document.querySelectorAll('.smartart-item').forEach(el => {
        el.classList.toggle('selected', el.dataset.type === typeId);
      });
    }

    function getSmartArtPreview(typeId) {
      // Return simple SVG previews for each type
      const color1 = '#1a73e8';
      const color2 = '#34a853';

      switch (typeId) {
        case 'basic-list':
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <rect x="5" y="5" width="90" height="12" fill="${color1}" rx="2"/>
            <rect x="5" y="22" width="90" height="12" fill="${color1}" rx="2" opacity="0.8"/>
            <rect x="5" y="39" width="90" height="12" fill="${color1}" rx="2" opacity="0.6"/>
          </svg>`;
        case 'basic-process':
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <rect x="5" y="15" width="25" height="30" fill="${color1}" rx="2"/>
            <polygon points="32,30 40,22 40,38" fill="${color1}"/>
            <rect x="42" y="15" width="25" height="30" fill="${color1}" rx="2" opacity="0.8"/>
            <polygon points="69,30 77,22 77,38" fill="${color1}" opacity="0.8"/>
            <rect x="79" y="15" width="18" height="30" fill="${color1}" rx="2" opacity="0.6"/>
          </svg>`;
        case 'basic-cycle':
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <circle cx="50" cy="30" r="25" fill="none" stroke="${color1}" stroke-width="3"/>
            <circle cx="50" cy="5" r="8" fill="${color1}"/>
            <circle cx="72" cy="42" r="8" fill="${color2}"/>
            <circle cx="28" cy="42" r="8" fill="${color1}" opacity="0.7"/>
          </svg>`;
        case 'org-chart':
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <rect x="35" y="2" width="30" height="12" fill="${color1}" rx="2"/>
            <line x1="50" y1="14" x2="50" y2="22" stroke="${color1}" stroke-width="2"/>
            <line x1="20" y1="22" x2="80" y2="22" stroke="${color1}" stroke-width="2"/>
            <line x1="20" y1="22" x2="20" y2="28" stroke="${color1}" stroke-width="2"/>
            <line x1="50" y1="22" x2="50" y2="28" stroke="${color1}" stroke-width="2"/>
            <line x1="80" y1="22" x2="80" y2="28" stroke="${color1}" stroke-width="2"/>
            <rect x="5" y="28" width="30" height="12" fill="${color2}" rx="2"/>
            <rect x="35" y="28" width="30" height="12" fill="${color2}" rx="2"/>
            <rect x="65" y="28" width="30" height="12" fill="${color2}" rx="2"/>
          </svg>`;
        case 'venn':
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <circle cx="35" cy="30" r="20" fill="${color1}" opacity="0.6"/>
            <circle cx="65" cy="30" r="20" fill="${color2}" opacity="0.6"/>
          </svg>`;
        case 'basic-matrix':
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <rect x="5" y="5" width="42" height="22" fill="${color1}" rx="2"/>
            <rect x="53" y="5" width="42" height="22" fill="${color2}" rx="2"/>
            <rect x="5" y="33" width="42" height="22" fill="${color2}" rx="2"/>
            <rect x="53" y="33" width="42" height="22" fill="${color1}" rx="2"/>
          </svg>`;
        case 'basic-pyramid':
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <polygon points="50,5 95,55 5,55" fill="${color1}"/>
            <line x1="25" y1="38" x2="75" y2="38" stroke="white" stroke-width="2"/>
            <line x1="35" y1="22" x2="65" y2="22" stroke="white" stroke-width="2"/>
          </svg>`;
        default:
          return `<svg viewBox="0 0 100 60" width="80" height="48">
            <rect x="10" y="10" width="80" height="40" fill="${color1}" rx="4"/>
          </svg>`;
      }
    }

    function insertSmartArt() {
      const textItems = document.getElementById('smartArtText').value.trim().split('\n').filter(t => t);
      const color1 = document.getElementById('smartArtColor1').value;
      const color2 = document.getElementById('smartArtColor2').value;

      if (textItems.length === 0) {
        showToast('Please enter at least one text item', 'error');
        return;
      }

      // Generate SmartArt SVG based on type
      const svgContent = generateSmartArtSVG(selectedSmartArtType, textItems, color1, color2);

      // Create element
      const element = {
        id: 'element-' + (++elementIdCounter),
        type: 'smartart',
        x: 100,
        y: 100,
        width: 500,
        height: 300,
        smartArtType: selectedSmartArtType,
        items: textItems,
        color1: color1,
        color2: color2,
        svg: svgContent
      };

      slides[currentSlideIndex].elements.push(element);
      saveToHistory();
      renderCurrentSlide();
      hideSmartArt();
      showToast('SmartArt inserted', 'success');
    }

    function generateSmartArtSVG(type, items, color1, color2) {
      const width = 500;
      const height = 300;
      let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${height}" width="${width}" height="${height}">`;

      switch (type) {
        case 'basic-list':
        case 'lined-list':
        case 'vertical-bullet':
          const itemHeight = Math.min(50, (height - 20) / items.length);
          items.forEach((item, i) => {
            const y = 10 + i * itemHeight;
            const opacity = 1 - (i * 0.1);
            svg += `<rect x="10" y="${y}" width="${width - 20}" height="${itemHeight - 5}" fill="${color1}" rx="4" opacity="${Math.max(0.5, opacity)}"/>`;
            svg += `<text x="20" y="${y + itemHeight/2 + 5}" fill="white" font-size="14" font-family="Arial">${item}</text>`;
          });
          break;

        case 'basic-process':
        case 'chevron':
        case 'arrow-process':
          const stepWidth = (width - 40 - (items.length - 1) * 30) / items.length;
          items.forEach((item, i) => {
            const x = 10 + i * (stepWidth + 30);
            const colors = [color1, color2];
            svg += `<rect x="${x}" y="100" width="${stepWidth}" height="100" fill="${colors[i % 2]}" rx="4"/>`;
            if (i < items.length - 1) {
              svg += `<polygon points="${x + stepWidth + 5},150 ${x + stepWidth + 25},130 ${x + stepWidth + 25},170" fill="${colors[i % 2]}"/>`;
            }
            svg += `<text x="${x + stepWidth/2}" y="155" fill="white" font-size="12" text-anchor="middle" font-family="Arial">${item}</text>`;
          });
          break;

        case 'basic-cycle':
        case 'text-cycle':
        case 'radial-cycle':
          const centerX = width / 2;
          const centerY = height / 2;
          const radius = Math.min(width, height) / 3;
          items.forEach((item, i) => {
            const angle = (i / items.length) * 2 * Math.PI - Math.PI / 2;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            const colors = [color1, color2];
            svg += `<circle cx="${x}" cy="${y}" r="40" fill="${colors[i % 2]}"/>`;
            svg += `<text x="${x}" y="${y + 5}" fill="white" font-size="11" text-anchor="middle" font-family="Arial">${item.substring(0, 10)}</text>`;
          });
          // Draw connecting lines
          svg += `<circle cx="${centerX}" cy="${centerY}" r="${radius - 20}" fill="none" stroke="${color1}" stroke-width="2" stroke-dasharray="5,5"/>`;
          break;

        case 'org-chart':
        case 'hierarchy':
          // Simple org chart - first item is root
          if (items.length > 0) {
            svg += `<rect x="${width/2 - 60}" y="20" width="120" height="40" fill="${color1}" rx="4"/>`;
            svg += `<text x="${width/2}" y="45" fill="white" font-size="12" text-anchor="middle" font-family="Arial">${items[0]}</text>`;

            if (items.length > 1) {
              svg += `<line x1="${width/2}" y1="60" x2="${width/2}" y2="80" stroke="${color1}" stroke-width="2"/>`;
              const childCount = items.length - 1;
              const childWidth = Math.min(100, (width - 40) / childCount);
              const startX = (width - childCount * childWidth) / 2;

              svg += `<line x1="${startX + childWidth/2}" y1="80" x2="${startX + (childCount - 1) * childWidth + childWidth/2}" y2="80" stroke="${color1}" stroke-width="2"/>`;

              for (let i = 1; i < items.length; i++) {
                const x = startX + (i - 1) * childWidth;
                svg += `<line x1="${x + childWidth/2}" y1="80" x2="${x + childWidth/2}" y2="100" stroke="${color1}" stroke-width="2"/>`;
                svg += `<rect x="${x + 5}" y="100" width="${childWidth - 10}" height="40" fill="${color2}" rx="4"/>`;
                svg += `<text x="${x + childWidth/2}" y="125" fill="white" font-size="10" text-anchor="middle" font-family="Arial">${items[i].substring(0, 12)}</text>`;
              }
            }
          }
          break;

        case 'venn':
        case 'linear-venn':
          const vennRadius = Math.min(width, height) / 4;
          if (items.length >= 2) {
            svg += `<circle cx="${width/2 - vennRadius/2}" cy="${height/2}" r="${vennRadius}" fill="${color1}" opacity="0.6"/>`;
            svg += `<circle cx="${width/2 + vennRadius/2}" cy="${height/2}" r="${vennRadius}" fill="${color2}" opacity="0.6"/>`;
            svg += `<text x="${width/2 - vennRadius}" y="${height/2}" fill="white" font-size="12" text-anchor="middle" font-family="Arial">${items[0]}</text>`;
            svg += `<text x="${width/2 + vennRadius}" y="${height/2}" fill="white" font-size="12" text-anchor="middle" font-family="Arial">${items[1]}</text>`;
          }
          if (items.length >= 3) {
            svg += `<text x="${width/2}" y="${height/2}" fill="black" font-size="10" text-anchor="middle" font-family="Arial">${items[2]}</text>`;
          }
          break;

        case 'basic-matrix':
        case 'titled-matrix':
          const cellW = (width - 30) / 2;
          const cellH = (height - 30) / 2;
          items.slice(0, 4).forEach((item, i) => {
            const col = i % 2;
            const row = Math.floor(i / 2);
            const colors = [[color1, color2], [color2, color1]];
            svg += `<rect x="${10 + col * (cellW + 10)}" y="${10 + row * (cellH + 10)}" width="${cellW}" height="${cellH}" fill="${colors[row][col]}" rx="4"/>`;
            svg += `<text x="${10 + col * (cellW + 10) + cellW/2}" y="${10 + row * (cellH + 10) + cellH/2 + 5}" fill="white" font-size="12" text-anchor="middle" font-family="Arial">${item}</text>`;
          });
          break;

        case 'basic-pyramid':
        case 'segmented-pyramid':
          const levels = items.length;
          const pyramidHeight = height - 40;
          const levelHeight = pyramidHeight / levels;
          items.forEach((item, i) => {
            const topWidth = ((i + 0.5) / levels) * (width - 40);
            const bottomWidth = ((i + 1.5) / levels) * (width - 40);
            const topY = 20 + i * levelHeight;
            const bottomY = 20 + (i + 1) * levelHeight;
            const topLeft = (width - topWidth) / 2;
            const topRight = (width + topWidth) / 2;
            const bottomLeft = (width - bottomWidth) / 2;
            const bottomRight = (width + bottomWidth) / 2;
            const opacity = 1 - (i * 0.15);
            svg += `<polygon points="${topLeft},${topY} ${topRight},${topY} ${bottomRight},${bottomY} ${bottomLeft},${bottomY}" fill="${color1}" opacity="${Math.max(0.4, opacity)}"/>`;
            svg += `<text x="${width/2}" y="${topY + levelHeight/2 + 5}" fill="white" font-size="12" text-anchor="middle" font-family="Arial">${item}</text>`;
          });
          break;

        default:
          // Default list layout
          items.forEach((item, i) => {
            const y = 20 + i * 45;
            svg += `<rect x="20" y="${y}" width="${width - 40}" height="40" fill="${i % 2 === 0 ? color1 : color2}" rx="4"/>`;
            svg += `<text x="40" y="${y + 25}" fill="white" font-size="14" font-family="Arial">${item}</text>`;
          });
      }

      svg += '</svg>';
      return svg;
    }

    // ==================== CUSTOM SHOWS ====================
    let customShows = [];
    let editingShowIndex = -1;
    let tempShowSlides = [];

    function showCustomShows() {
      document.getElementById('customShowsModal').style.display = 'flex';
      renderCustomShowsList();
    }

    function hideCustomShows() {
      document.getElementById('customShowsModal').style.display = 'none';
    }

    function renderCustomShowsList() {
      const list = document.getElementById('customShowsList');
      if (customShows.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">No custom shows defined. Click "New" to create one.</p>';
        return;
      }
      list.innerHTML = customShows.map((show, i) => `
        <div class="custom-show-item ${i === 0 ? 'selected' : ''}" onclick="selectCustomShow(${i})" data-index="${i}">
          <strong>${show.name}</strong>
          <div style="font-size: 11px; color: #666;">${show.slides.length} slides</div>
        </div>
      `).join('');
    }

    function selectCustomShow(index) {
      document.querySelectorAll('.custom-show-item').forEach(el => el.classList.remove('selected'));
      document.querySelector(`.custom-show-item[data-index="${index}"]`)?.classList.add('selected');
    }

    function getSelectedCustomShowIndex() {
      const selected = document.querySelector('.custom-show-item.selected');
      return selected ? parseInt(selected.dataset.index) : -1;
    }

    function showNewCustomShow() {
      editingShowIndex = -1;
      tempShowSlides = [];
      document.getElementById('editCustomShowTitle').textContent = 'New Custom Show';
      document.getElementById('customShowName').value = 'Custom Show ' + (customShows.length + 1);
      document.getElementById('editCustomShowModal').style.display = 'flex';
      renderAvailableSlides();
      renderShowSlides();
    }

    function hideEditCustomShow() {
      document.getElementById('editCustomShowModal').style.display = 'none';
    }

    function renderAvailableSlides() {
      const container = document.getElementById('availableSlides');
      container.innerHTML = slides.map((slide, i) => `
        <div class="slide-list-item" onclick="toggleAvailableSlide(this, ${i})" data-index="${i}">
          <input type="checkbox" onclick="event.stopPropagation()">
          <span>Slide ${i + 1}</span>
        </div>
      `).join('');
    }

    function renderShowSlides() {
      const container = document.getElementById('showSlides');
      if (tempShowSlides.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic; font-size: 12px;">Add slides from the left</p>';
        return;
      }
      container.innerHTML = tempShowSlides.map((slideIdx, i) => `
        <div class="slide-list-item ${i === 0 ? 'selected' : ''}" onclick="selectShowSlide(${i})" data-pos="${i}">
          <span>Slide ${slideIdx + 1}</span>
        </div>
      `).join('');
    }

    function toggleAvailableSlide(el, index) {
      const checkbox = el.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      el.classList.toggle('selected', checkbox.checked);
    }

    function selectShowSlide(pos) {
      document.querySelectorAll('#showSlides .slide-list-item').forEach(el => el.classList.remove('selected'));
      document.querySelector(`#showSlides .slide-list-item[data-pos="${pos}"]`)?.classList.add('selected');
    }

    function addSlidesToShow() {
      const checked = document.querySelectorAll('#availableSlides .slide-list-item input:checked');
      checked.forEach(checkbox => {
        const item = checkbox.closest('.slide-list-item');
        const index = parseInt(item.dataset.index);
        if (!tempShowSlides.includes(index)) {
          tempShowSlides.push(index);
        }
        checkbox.checked = false;
        item.classList.remove('selected');
      });
      renderShowSlides();
    }

    function removeSlidesFromShow() {
      const selected = document.querySelector('#showSlides .slide-list-item.selected');
      if (selected) {
        const pos = parseInt(selected.dataset.pos);
        tempShowSlides.splice(pos, 1);
        renderShowSlides();
      }
    }

    function moveShowSlideUp() {
      const selected = document.querySelector('#showSlides .slide-list-item.selected');
      if (selected) {
        const pos = parseInt(selected.dataset.pos);
        if (pos > 0) {
          [tempShowSlides[pos], tempShowSlides[pos - 1]] = [tempShowSlides[pos - 1], tempShowSlides[pos]];
          renderShowSlides();
          selectShowSlide(pos - 1);
        }
      }
    }

    function moveShowSlideDown() {
      const selected = document.querySelector('#showSlides .slide-list-item.selected');
      if (selected) {
        const pos = parseInt(selected.dataset.pos);
        if (pos < tempShowSlides.length - 1) {
          [tempShowSlides[pos], tempShowSlides[pos + 1]] = [tempShowSlides[pos + 1], tempShowSlides[pos]];
          renderShowSlides();
          selectShowSlide(pos + 1);
        }
      }
    }

    function saveCustomShow() {
      const name = document.getElementById('customShowName').value.trim();
      if (!name) {
        showToast('Please enter a show name', 'error');
        return;
      }
      if (tempShowSlides.length === 0) {
        showToast('Please add at least one slide', 'error');
        return;
      }

      const show = { name, slides: [...tempShowSlides] };

      if (editingShowIndex >= 0) {
        customShows[editingShowIndex] = show;
      } else {
        customShows.push(show);
      }

      hideEditCustomShow();
      renderCustomShowsList();
      showToast('Custom show saved', 'success');
    }

    function editSelectedCustomShow() {
      const index = getSelectedCustomShowIndex();
      if (index < 0) {
        showToast('Please select a show to edit', 'error');
        return;
      }

      editingShowIndex = index;
      const show = customShows[index];
      tempShowSlides = [...show.slides];
      document.getElementById('editCustomShowTitle').textContent = 'Edit Custom Show';
      document.getElementById('customShowName').value = show.name;
      document.getElementById('editCustomShowModal').style.display = 'flex';
      renderAvailableSlides();
      renderShowSlides();
    }

    function deleteSelectedCustomShow() {
      const index = getSelectedCustomShowIndex();
      if (index < 0) {
        showToast('Please select a show to delete', 'error');
        return;
      }

      const name = customShows[index].name;
      customShows.splice(index, 1);
      renderCustomShowsList();
      showToast(`Custom show "${name}" deleted`, 'success');
    }

    function duplicateSelectedCustomShow() {
      const index = getSelectedCustomShowIndex();
      if (index < 0) {
        showToast('Please select a show to copy', 'error');
        return;
      }

      const original = customShows[index];
      customShows.push({
        name: original.name + ' (Copy)',
        slides: [...original.slides]
      });
      renderCustomShowsList();
      showToast('Custom show copied', 'success');
    }

    function runSelectedCustomShow() {
      const index = getSelectedCustomShowIndex();
      if (index < 0) {
        showToast('Please select a show to run', 'error');
        return;
      }

      const show = customShows[index];
      hideCustomShows();

      // Start presentation with custom show slides
      startCustomPresentation(show.slides);
    }

    // Helper function to render element as HTML for presentations
    function renderElementHTML(el) {
      const baseStyle = `position: absolute; left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px;`;

      if (el.type === 'text') {
        return `<div style="${baseStyle} font-size: ${el.style?.fontSize || '16px'}; font-family: ${el.style?.fontFamily || 'Arial'}; color: ${el.style?.color || 'black'}; padding: 8px;">${el.content || ''}</div>`;
      } else if (el.type === 'shape') {
        const borderRadius = el.shape === 'circle' ? '50%' : el.shape === 'triangle' ? '0' : '4px';
        const clipPath = el.shape === 'triangle' ? 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);' : '';
        return `<div style="${baseStyle} background: ${el.style?.background || '#ccc'}; border-radius: ${borderRadius}; ${clipPath}"></div>`;
      } else if (el.type === 'image') {
        return `<div style="${baseStyle}"><img src="${el.src}" style="width: 100%; height: 100%; object-fit: contain;"></div>`;
      } else if (el.type === 'table') {
        return `<div style="${baseStyle}">${el.html || ''}</div>`;
      } else if (el.type === 'chart') {
        return `<div style="${baseStyle}">${el.chartHtml || ''}</div>`;
      }
      return `<div style="${baseStyle}"></div>`;
    }

    function startCustomPresentation(slideIndices) {
      if (slideIndices.length === 0) return;

      const container = document.createElement('div');
      container.className = 'fullscreen-presenter';
      container.id = 'customPresenter';

      let currentIdx = 0;

      function renderSlide() {
        const slideIndex = slideIndices[currentIdx];
        const slide = slides[slideIndex];

        container.innerHTML = `
          <div class="fullscreen-slide" style="background: ${slide.background || 'white'}">
            ${slide.elements.map(el => renderElementHTML(el)).join('')}
          </div>
        `;
      }

      function navigate(direction) {
        if (direction === 'next' && currentIdx < slideIndices.length - 1) {
          currentIdx++;
          renderSlide();
        } else if (direction === 'prev' && currentIdx > 0) {
          currentIdx--;
          renderSlide();
        } else if (direction === 'next' && currentIdx === slideIndices.length - 1) {
          exitCustomPresentation();
        }
      }

      function exitCustomPresentation() {
        container.remove();
        document.removeEventListener('keydown', handleKey);
      }

      function handleKey(e) {
        if (e.key === 'Escape') exitCustomPresentation();
        else if (e.key === 'ArrowRight' || e.key === ' ') navigate('next');
        else if (e.key === 'ArrowLeft') navigate('prev');
      }

      container.onclick = () => navigate('next');
      document.addEventListener('keydown', handleKey);
      document.body.appendChild(container);
      renderSlide();
    }

    // ==================== PHOTO ALBUM ====================
    let photoAlbumImages = [];

    function showPhotoAlbum() {
      photoAlbumImages = [];
      document.getElementById('photoAlbumFiles').value = '';
      document.getElementById('photoAlbumPreview').innerHTML = '<p style="color: #666; width: 100%; text-align: center; margin: 2rem 0;">No photos selected</p>';
      document.getElementById('photoAlbumModal').style.display = 'flex';
    }

    function hidePhotoAlbum() {
      document.getElementById('photoAlbumModal').style.display = 'none';
    }

    function previewPhotoAlbum() {
      const files = document.getElementById('photoAlbumFiles').files;
      const preview = document.getElementById('photoAlbumPreview');
      photoAlbumImages = [];

      if (files.length === 0) {
        preview.innerHTML = '<p style="color: #666; width: 100%; text-align: center; margin: 2rem 0;">No photos selected</p>';
        return;
      }

      preview.innerHTML = '';

      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          photoAlbumImages.push({
            src: e.target.result,
            name: file.name.replace(/\.[^/.]+$/, '') // Remove extension
          });

          const thumb = document.createElement('div');
          thumb.style.cssText = 'width: 80px; height: 60px; background-size: cover; background-position: center; border-radius: 4px; border: 2px solid #ddd;';
          thumb.style.backgroundImage = `url(${e.target.result})`;
          thumb.title = file.name;
          preview.appendChild(thumb);
        };
        reader.readAsDataURL(file);
      });
    }

    function applyAlbumBgPreset() {
      const preset = document.getElementById('photoAlbumBgPreset').value;
      if (preset && preset !== 'gradient') {
        document.getElementById('photoAlbumBg').value = preset;
      }
    }

    function createPhotoAlbum() {
      if (photoAlbumImages.length === 0) {
        showToast('Please select photos first', 'warning');
        return;
      }

      const layout = document.getElementById('photoAlbumLayout').value;
      const frame = document.getElementById('photoAlbumFrame').value;
      const bgColor = document.getElementById('photoAlbumBg').value;
      const bgPreset = document.getElementById('photoAlbumBgPreset').value;
      const addCaptions = document.getElementById('photoAlbumCaptions').checked;

      const background = bgPreset === 'gradient'
        ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
        : bgColor;

      // Get frame styles
      const frameStyles = {
        none: '',
        simple: 'border: 3px solid #333;',
        rounded: 'border: 3px solid #333; border-radius: 12px;',
        shadow: 'box-shadow: 0 8px 20px rgba(0,0,0,0.4);',
        polaroid: 'border: 8px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);'
      };

      let slidesCreated = 0;

      if (layout === 'title') {
        // Create title slide first
        slides.push({
          elements: [
            {
              type: 'text',
              text: 'Photo Album',
              x: 100, y: 200,
              fontSize: '48px',
              color: bgPreset === 'gradient' || bgColor === '#000000' ? '#ffffff' : '#333333',
              bold: true
            },
            {
              type: 'text',
              text: `${photoAlbumImages.length} photos`,
              x: 100, y: 280,
              fontSize: '24px',
              color: bgPreset === 'gradient' || bgColor === '#000000' ? '#cccccc' : '#666666'
            }
          ],
          background: background,
          transition: 'fade',
          transitionDuration: 0.5,
          speakerNotes: ''
        });
        slidesCreated++;

        // One photo per slide
        photoAlbumImages.forEach((img, idx) => {
          const elements = [{
            type: 'image',
            src: img.src,
            x: 80, y: 60,
            width: 800, height: 450,
            style: frameStyles[frame]
          }];

          if (addCaptions) {
            elements.push({
              type: 'text',
              text: img.name,
              x: 80, y: 520,
              fontSize: '18px',
              color: bgPreset === 'gradient' || bgColor === '#000000' ? '#ffffff' : '#333333'
            });
          }

          slides.push({
            elements,
            background: background,
            transition: 'fade',
            transitionDuration: 0.5,
            speakerNotes: ''
          });
          slidesCreated++;
        });
      } else {
        const photosPerSlide = parseInt(layout);

        for (let i = 0; i < photoAlbumImages.length; i += photosPerSlide) {
          const slidePhotos = photoAlbumImages.slice(i, i + photosPerSlide);
          const elements = [];

          slidePhotos.forEach((img, idx) => {
            let x, y, w, h;

            if (photosPerSlide === 1) {
              x = 80; y = 40; w = 800; h = 480;
            } else if (photosPerSlide === 2) {
              x = idx === 0 ? 40 : 490;
              y = 80; w = 420; h = 400;
            } else { // 4 photos
              x = (idx % 2 === 0) ? 40 : 490;
              y = (idx < 2) ? 40 : 300;
              w = 420; h = 220;
            }

            elements.push({
              type: 'image',
              src: img.src,
              x, y, width: w, height: h,
              style: frameStyles[frame]
            });

            if (addCaptions && photosPerSlide === 1) {
              elements.push({
                type: 'text',
                text: img.name,
                x: 80, y: 530,
                fontSize: '16px',
                color: bgPreset === 'gradient' || bgColor === '#000000' ? '#ffffff' : '#333333'
              });
            }
          });

          slides.push({
            elements,
            background: background,
            transition: 'fade',
            transitionDuration: 0.5,
            speakerNotes: ''
          });
          slidesCreated++;
        }
      }

      currentSlideIndex = slides.length - slidesCreated;
      renderSlideList();
      renderSlide();
      hidePhotoAlbum();
      showToast(`Photo album created: ${slidesCreated} slides`, 'success');
    }

    // ==================== VIDEO CONTROLS ====================
    function showVideoControls() {
      document.getElementById('videoControlsModal').style.display = 'flex';
      // Reset form
      document.getElementById('videoUrl').value = '';
      document.getElementById('videoStartOption').value = 'click';
      document.getElementById('videoStartTime').value = '0';
      document.getElementById('videoEndTime').value = '0';
      document.getElementById('videoVolume').value = '100';
      document.getElementById('videoLoop').checked = false;
      document.getElementById('videoHideControls').checked = false;
      document.getElementById('videoRewind').checked = false;
      document.getElementById('videoWidth').value = '400';
      document.getElementById('videoHeight').value = '300';
    }

    function hideVideoControls() {
      document.getElementById('videoControlsModal').style.display = 'none';
    }

    function insertVideo() {
      const url = document.getElementById('videoUrl').value.trim();
      if (!url) {
        showToast('Please enter a video URL', 'error');
        return;
      }

      const startOption = document.getElementById('videoStartOption').value;
      const startTime = parseInt(document.getElementById('videoStartTime').value) || 0;
      const endTime = parseInt(document.getElementById('videoEndTime').value) || 0;
      const volume = parseInt(document.getElementById('videoVolume').value) || 100;
      const loop = document.getElementById('videoLoop').checked;
      const hideControls = document.getElementById('videoHideControls').checked;
      const rewind = document.getElementById('videoRewind').checked;
      const width = parseInt(document.getElementById('videoWidth').value) || 400;
      const height = parseInt(document.getElementById('videoHeight').value) || 300;

      // Parse YouTube URL
      let embedUrl = url;
      let isYouTube = false;
      let isVimeo = false;

      if (url.includes('youtube.com') || url.includes('youtu.be')) {
        isYouTube = true;
        let videoId = '';
        if (url.includes('youtu.be/')) {
          videoId = url.split('youtu.be/')[1].split('?')[0];
        } else {
          const match = url.match(/[?&]v=([^&]+)/);
          videoId = match ? match[1] : '';
        }
        if (videoId) {
          embedUrl = `https://www.youtube.com/embed/${videoId}?`;
          if (startTime) embedUrl += `start=${startTime}&`;
          if (endTime) embedUrl += `end=${endTime}&`;
          if (startOption === 'auto') embedUrl += 'autoplay=1&';
          if (loop) embedUrl += `loop=1&playlist=${videoId}&`;
          if (hideControls) embedUrl += 'controls=0&';
        }
      } else if (url.includes('vimeo.com')) {
        isVimeo = true;
        const match = url.match(/vimeo.com\/(\d+)/);
        const videoId = match ? match[1] : '';
        if (videoId) {
          embedUrl = `https://player.vimeo.com/video/${videoId}?`;
          if (startOption === 'auto') embedUrl += 'autoplay=1&';
          if (loop) embedUrl += 'loop=1&';
        }
      }

      const element = {
        id: 'element-' + (++elementIdCounter),
        type: 'video',
        x: 100,
        y: 100,
        width: width,
        height: height,
        url: url,
        embedUrl: embedUrl,
        isYouTube: isYouTube,
        isVimeo: isVimeo,
        startOption: startOption,
        startTime: startTime,
        endTime: endTime,
        volume: volume,
        loop: loop,
        hideControls: hideControls,
        rewind: rewind
      };

      slides[currentSlideIndex].elements.push(element);
      saveToHistory();
      renderCurrentSlide();
      hideVideoControls();
      showToast('Video inserted', 'success');
    }

    // Update renderElementHTML to handle video elements
    const originalRenderElementHTML = renderElementHTML;
    renderElementHTML = function(element) {
      if (element.type === 'video') {
        if (element.isYouTube || element.isVimeo) {
          return `
            <div class="slide-element" id="${element.id}"
                 style="left: ${element.x}px; top: ${element.y}px; width: ${element.width}px; height: ${element.height}px;">
              <iframe src="${element.embedUrl}" width="100%" height="100%"
                      frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen style="pointer-events: none;"></iframe>
            </div>
          `;
        } else {
          return `
            <div class="slide-element" id="${element.id}"
                 style="left: ${element.x}px; top: ${element.y}px; width: ${element.width}px; height: ${element.height}px;">
              <video src="${element.url}" width="100%" height="100%"
                     ${element.hideControls ? '' : 'controls'}
                     ${element.loop ? 'loop' : ''}
                     ${element.startOption === 'auto' ? 'autoplay' : ''}
                     style="object-fit: contain;"></video>
            </div>
          `;
        }
      } else if (element.type === 'smartart') {
        return `
          <div class="slide-element" id="${element.id}"
               style="left: ${element.x}px; top: ${element.y}px; width: ${element.width}px; height: ${element.height}px;">
            ${element.svg}
          </div>
        `;
      } else if (element.type === 'slidezoom') {
        const borderClass = element.border === 'none' ? '' : `border-${element.border}`;
        return `
          <div class="slide-element slide-zoom-element ${borderClass}" id="${element.id}"
               style="left: ${element.x}px; top: ${element.y}px; width: ${element.width}px; height: ${element.height}px; background: ${slides[element.targetSlide]?.background || 'white'};"
               data-target="${element.targetSlide}" data-return="${element.returnToSlide}"
               onclick="event.stopPropagation(); handleZoomClick(${element.targetSlide}, ${element.returnToSlide})">
            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; padding: 4px; text-align: center;">
              Slide ${element.targetSlide + 1}
            </div>
          </div>
        `;
      }
      return originalRenderElementHTML(element);
    };

    // ==================== SUMMARY ZOOM ====================
    let selectedZoomSlides = new Set();

    function showSummaryZoom() {
      selectedZoomSlides.clear();
      renderZoomSlideSelector();
      document.getElementById('summaryZoomTitle').value = 'Summary';
      document.getElementById('summaryZoomModal').style.display = 'flex';
    }

    function hideSummaryZoom() {
      document.getElementById('summaryZoomModal').style.display = 'none';
    }

    function renderZoomSlideSelector() {
      const container = document.getElementById('summaryZoomSlides');
      container.innerHTML = slides.map((slide, i) => `
        <div class="zoom-slide-thumb ${selectedZoomSlides.has(i) ? 'selected' : ''}"
             onclick="toggleZoomSlide(${i})" data-index="${i}">
          <div style="width: 100%; height: 100%; background: ${slide.background || 'white'}; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">
            Slide ${i + 1}
          </div>
          <span class="slide-num">${i + 1}</span>
          <span class="check-mark">âœ“</span>
        </div>
      `).join('');
    }

    function toggleZoomSlide(index) {
      if (selectedZoomSlides.has(index)) {
        selectedZoomSlides.delete(index);
      } else {
        selectedZoomSlides.add(index);
      }
      renderZoomSlideSelector();
    }

    function selectAllZoomSlides() {
      slides.forEach((_, i) => selectedZoomSlides.add(i));
      renderZoomSlideSelector();
    }

    function deselectAllZoomSlides() {
      selectedZoomSlides.clear();
      renderZoomSlideSelector();
    }

    function insertSummaryZoom() {
      if (selectedZoomSlides.size === 0) {
        showToast('Please select at least one slide', 'error');
        return;
      }

      const title = document.getElementById('summaryZoomTitle').value || 'Summary';
      const layout = document.getElementById('summaryZoomLayout').value;
      const size = document.getElementById('summaryZoomSize').value;

      // Size mappings
      const sizes = {
        small: { w: 120, h: 68 },
        medium: { w: 180, h: 101 },
        large: { w: 240, h: 135 }
      };
      const thumbSize = sizes[size];

      // Create a new summary slide
      const summarySlide = {
        elements: [],
        background: 'linear-gradient(135deg, #667eea, #764ba2)',
        notes: 'Summary slide with clickable navigation',
        transition: 'fade',
        timing: null
      };

      // Add title
      summarySlide.elements.push({
        id: 'element-' + (++elementIdCounter),
        type: 'text',
        x: 50,
        y: 30,
        width: 860,
        height: 60,
        content: `<h1 style="color: white; text-align: center; margin: 0;">${title}</h1>`
      });

      // Calculate positions based on layout
      const selectedArray = Array.from(selectedZoomSlides).sort((a, b) => a - b);
      const count = selectedArray.length;

      let positions = [];
      const startY = 120;
      const slideWidth = 960;
      const slideHeight = 540;

      if (layout === 'grid') {
        const cols = Math.ceil(Math.sqrt(count));
        const rows = Math.ceil(count / cols);
        const gapX = (slideWidth - cols * thumbSize.w) / (cols + 1);
        const gapY = (slideHeight - startY - rows * thumbSize.h) / (rows + 1);

        for (let i = 0; i < count; i++) {
          const col = i % cols;
          const row = Math.floor(i / cols);
          positions.push({
            x: gapX + col * (thumbSize.w + gapX),
            y: startY + gapY + row * (thumbSize.h + gapY)
          });
        }
      } else if (layout === 'row') {
        const gap = (slideWidth - count * thumbSize.w) / (count + 1);
        const y = (slideHeight - startY - thumbSize.h) / 2 + startY;
        for (let i = 0; i < count; i++) {
          positions.push({
            x: gap + i * (thumbSize.w + gap),
            y: y
          });
        }
      } else if (layout === 'column') {
        const gap = (slideHeight - startY - count * thumbSize.h) / (count + 1);
        const x = (slideWidth - thumbSize.w) / 2;
        for (let i = 0; i < count; i++) {
          positions.push({
            x: x,
            y: startY + gap + i * (thumbSize.h + gap)
          });
        }
      }

      // Add zoom thumbnails
      selectedArray.forEach((slideIdx, i) => {
        summarySlide.elements.push({
          id: 'element-' + (++elementIdCounter),
          type: 'slidezoom',
          x: positions[i].x,
          y: positions[i].y,
          width: thumbSize.w,
          height: thumbSize.h,
          targetSlide: slideIdx + 1, // Adjust for the new summary slide being inserted
          returnToSlide: 0, // Return to summary slide
          border: 'thin'
        });
      });

      // Insert summary slide at the beginning
      slides.unshift(summarySlide);

      // Update target slide indices (they all shift by 1)
      slides[0].elements.forEach(el => {
        if (el.type === 'slidezoom') {
          // Already adjusted above
        }
      });

      saveToHistory();
      goToSlide(0);
      hideSummaryZoom();
      showToast('Summary zoom slide created', 'success');
    }

    // ==================== SLIDE ZOOM ====================
    let selectedZoomTarget = -1;

    function showSlideZoom() {
      selectedZoomTarget = -1;
      renderSlideZoomTargets();
      document.getElementById('slideZoomModal').style.display = 'flex';
    }

    function hideSlideZoom() {
      document.getElementById('slideZoomModal').style.display = 'none';
    }

    function renderSlideZoomTargets() {
      const container = document.getElementById('slideZoomTargets');
      container.innerHTML = slides.map((slide, i) => {
        if (i === currentSlideIndex) return ''; // Can't zoom to current slide
        return `
          <div class="zoom-slide-thumb ${selectedZoomTarget === i ? 'selected' : ''}"
               onclick="selectZoomTarget(${i})" data-index="${i}">
            <div style="width: 100%; height: 100%; background: ${slide.background || 'white'}; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">
              Slide ${i + 1}
            </div>
            <span class="slide-num">${i + 1}</span>
          </div>
        `;
      }).join('');
    }

    function selectZoomTarget(index) {
      selectedZoomTarget = index;
      document.querySelectorAll('#slideZoomTargets .zoom-slide-thumb').forEach(el => {
        el.classList.toggle('selected', parseInt(el.dataset.index) === index);
      });
    }

    function insertSlideZoom() {
      if (selectedZoomTarget < 0) {
        showToast('Please select a target slide', 'error');
        return;
      }

      const width = parseInt(document.getElementById('slideZoomWidth').value) || 200;
      const height = parseInt(document.getElementById('slideZoomHeight').value) || 112;
      const border = document.getElementById('slideZoomBorder').value;
      const returnToSlide = document.getElementById('slideZoomReturn').checked ? currentSlideIndex : -1;

      const element = {
        id: 'element-' + (++elementIdCounter),
        type: 'slidezoom',
        x: 100,
        y: 100,
        width: width,
        height: height,
        targetSlide: selectedZoomTarget,
        returnToSlide: returnToSlide,
        border: border
      };

      slides[currentSlideIndex].elements.push(element);
      saveToHistory();
      renderCurrentSlide();
      hideSlideZoom();
      showToast('Slide zoom inserted', 'success');
    }

    function handleZoomClick(targetSlide, returnSlide) {
      // Store return slide for presentation mode
      window.zoomReturnSlide = returnSlide;
      goToSlide(targetSlide);
    }

    // ==================== DESIGN IDEAS ====================
    const designIdeas = [
      { name: 'Bold Gradient', bg: 'linear-gradient(135deg, #667eea, #764ba2)', textColor: 'white' },
      { name: 'Ocean Blue', bg: 'linear-gradient(135deg, #00c6ff, #0072ff)', textColor: 'white' },
      { name: 'Sunset', bg: 'linear-gradient(135deg, #f093fb, #f5576c)', textColor: 'white' },
      { name: 'Forest', bg: 'linear-gradient(135deg, #11998e, #38ef7d)', textColor: 'white' },
      { name: 'Midnight', bg: 'linear-gradient(135deg, #232526, #414345)', textColor: 'white' },
      { name: 'Fire', bg: 'linear-gradient(135deg, #f12711, #f5af19)', textColor: 'white' },
      { name: 'Clean White', bg: '#ffffff', textColor: '#333' },
      { name: 'Light Gray', bg: '#f5f5f5', textColor: '#333' },
      { name: 'Dark Mode', bg: '#1a1a2e', textColor: 'white' },
      { name: 'Corporate Blue', bg: '#1a73e8', textColor: 'white' },
      { name: 'Minimalist', bg: '#fafafa', textColor: '#222', accent: '#1a73e8' },
      { name: 'Nature', bg: 'linear-gradient(135deg, #134e5e, #71b280)', textColor: 'white' }
    ];

    function showDesignIdeas() {
      renderDesignIdeas();
      document.getElementById('designIdeasModal').style.display = 'flex';
    }

    function hideDesignIdeas() {
      document.getElementById('designIdeasModal').style.display = 'none';
    }

    function renderDesignIdeas() {
      const gallery = document.getElementById('designIdeasGallery');
      // Shuffle for variety
      const shuffled = [...designIdeas].sort(() => Math.random() - 0.5).slice(0, 9);

      gallery.innerHTML = shuffled.map((idea, i) => `
        <div class="design-idea-card" onclick="applyDesignIdea(${i})" data-index="${i}">
          <div class="idea-preview" style="background: ${idea.bg};">
            <div style="text-align: center; color: ${idea.textColor};">
              <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px;">Title</div>
              <div style="font-size: 10px; opacity: 0.8;">Subtitle text here</div>
            </div>
          </div>
          <div class="idea-label">${idea.name}</div>
        </div>
      `).join('');

      // Store for reference
      gallery.shuffledIdeas = shuffled;
    }

    function applyDesignIdea(index) {
      const gallery = document.getElementById('designIdeasGallery');
      const idea = gallery.shuffledIdeas[index];

      if (!idea) return;

      // Apply to current slide
      slides[currentSlideIndex].background = idea.bg;

      // Update text colors if there are text elements
      slides[currentSlideIndex].elements.forEach(el => {
        if (el.type === 'text' && el.content) {
          // Simple color update - in real app would be more sophisticated
          if (idea.textColor === 'white') {
            el.content = el.content.replace(/color:\s*#[0-9a-f]+|color:\s*[a-z]+/gi, 'color: white');
          } else {
            el.content = el.content.replace(/color:\s*white/gi, 'color: #333');
          }
        }
      });

      saveToHistory();
      renderCurrentSlide();
      renderThumbnails();
      hideDesignIdeas();
      showToast(`Applied "${idea.name}" design`, 'success');
    }

    function refreshDesignIdeas() {
      renderDesignIdeas();
      showToast('Showing new design ideas', 'info');
    }

    // Dark Mode
    let darkModeEnabled = localStorage.getItem('ninjaslides-darkmode') === 'true';

    function toggleDarkMode() {
      darkModeEnabled = !darkModeEnabled;
      applyDarkMode();
      localStorage.setItem('ninjaslides-darkmode', darkModeEnabled);
    }

    function applyDarkMode() {
      const btn = document.getElementById('darkModeBtn');
      if (darkModeEnabled) {
        document.body.classList.add('dark-mode');
        btn.classList.add('active');
        btn.innerHTML = 'â˜€ï¸ Light Mode';
      } else {
        document.body.classList.remove('dark-mode');
        btn.classList.remove('active');
        btn.innerHTML = 'ðŸŒ™ Dark Mode';
      }
    }

    // Apply saved dark mode preference on load
    if (darkModeEnabled) {
      applyDarkMode();
    }

    // ==================== PRESENTER COACH ====================
    let coachActive = false;
    let coachTimerInterval = null;
    let coachStartTime = null;
    let coachCurrentSlide = 0;
    let coachSessionData = {
      totalTime: 0,
      slidesCovered: new Set(),
      slideTimes: {},
      fillerCount: 0,
      pacingScores: []
    };

    const presenterTips = [
      "Maintain eye contact with your audience",
      "Vary your vocal tone to keep listeners engaged",
      "Use pauses effectively after key points",
      "Keep slides simple - avoid reading text verbatim",
      "Practice transitions between slides",
      "Speak slower than feels natural",
      "Use hand gestures to emphasize points",
      "Engage with rhetorical questions",
      "Tell stories to illustrate concepts",
      "End with a clear call to action"
    ];

    function startPresenterCoach() {
      coachCurrentSlide = currentSlideIndex;
      coachSessionData = {
        totalTime: 0,
        slidesCovered: new Set(),
        slideTimes: {},
        fillerCount: 0,
        pacingScores: []
      };

      updateCoachSlidePreview();
      updateCoachNotes();
      updateCoachTip();

      document.getElementById('presenterCoachModal').style.display = 'flex';

      // Add keyboard listener
      document.addEventListener('keydown', coachKeyHandler);
    }

    function stopPresenterCoach() {
      if (coachActive) {
        toggleCoachSession();
      }
      document.getElementById('presenterCoachModal').style.display = 'none';
      document.removeEventListener('keydown', coachKeyHandler);
    }

    function coachKeyHandler(e) {
      if (e.key === 'Escape') {
        stopPresenterCoach();
      } else if (e.key === ' ' || e.key === 'ArrowRight') {
        e.preventDefault();
        coachNextSlide();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        coachPrevSlide();
      }
    }

    function toggleCoachSession() {
      coachActive = !coachActive;
      const btn = document.getElementById('coachStartBtn');

      if (coachActive) {
        btn.innerHTML = 'â¸ Pause';
        btn.style.background = '#ff9800';
        coachStartTime = Date.now();

        coachTimerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - coachStartTime) / 1000) + coachSessionData.totalTime;
          updateCoachTimer(elapsed);
          updateCoachMetrics(elapsed);
        }, 1000);

        document.getElementById('coachTips').innerHTML = '<p style="color: #1a73e8; font-weight: 500;">Session in progress... Practice your presentation!</p>';
      } else {
        btn.innerHTML = 'â–¶ Resume';
        btn.style.background = '';
        coachSessionData.totalTime += Math.floor((Date.now() - coachStartTime) / 1000);
        clearInterval(coachTimerInterval);
        updateCoachTip();
      }
    }

    function updateCoachTimer(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      document.getElementById('coachTimer').textContent =
        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateCoachMetrics(elapsed) {
      // Simulated metrics (in real app would use speech recognition)
      const slideCount = coachSessionData.slidesCovered.size || 1;
      const avgTimePerSlide = elapsed / slideCount;

      // Pacing (ideal: 30-90 seconds per slide)
      let pacingScore = 50;
      let pacingLabel = 'Good';
      if (avgTimePerSlide < 20) {
        pacingScore = 20;
        pacingLabel = 'Too Fast';
        document.getElementById('pacingBar').style.background = '#f44336';
      } else if (avgTimePerSlide < 30) {
        pacingScore = 40;
        pacingLabel = 'Slightly Fast';
        document.getElementById('pacingBar').style.background = '#ff9800';
      } else if (avgTimePerSlide > 120) {
        pacingScore = 30;
        pacingLabel = 'Too Slow';
        document.getElementById('pacingBar').style.background = '#f44336';
      } else if (avgTimePerSlide > 90) {
        pacingScore = 60;
        pacingLabel = 'Slightly Slow';
        document.getElementById('pacingBar').style.background = '#ff9800';
      } else {
        pacingScore = 80 + Math.random() * 15;
        pacingLabel = 'Good';
        document.getElementById('pacingBar').style.background = '#4caf50';
      }

      document.getElementById('pacingValue').textContent = pacingLabel;
      document.getElementById('pacingBar').style.width = `${pacingScore}%`;

      // Filler words (simulated - random occasional increments)
      if (Math.random() < 0.03 && coachActive) {
        coachSessionData.fillerCount++;
      }
      const fillerPct = Math.min(100, coachSessionData.fillerCount * 5);
      document.getElementById('fillerValue').textContent = coachSessionData.fillerCount;
      document.getElementById('fillerBar').style.width = `${fillerPct}%`;
      document.getElementById('fillerBar').style.background = fillerPct > 50 ? '#f44336' : fillerPct > 25 ? '#ff9800' : '#4caf50';

      // Repetition (simulated)
      const repetitionPct = Math.min(40, elapsed / 60 * 5);
      document.getElementById('repetitionValue').textContent = repetitionPct < 20 ? 'Low' : repetitionPct < 40 ? 'Medium' : 'High';
      document.getElementById('repetitionBar').style.width = `${repetitionPct}%`;

      coachSessionData.pacingScores.push(pacingScore);
    }

    function updateCoachSlidePreview() {
      const preview = document.getElementById('coachSlidePreview');
      const slide = slides[coachCurrentSlide];

      if (!slide) return;

      let html = `<div style="width: 100%; height: 100%; position: relative; background: ${slide.background || '#ffffff'};">`;

      slide.elements.forEach(el => {
        const scale = 0.4; // Scale down for preview
        const style = `
          position: absolute;
          left: ${el.x * scale}px;
          top: ${el.y * scale}px;
          width: ${el.width * scale}px;
          height: ${el.height * scale}px;
          font-size: ${(parseInt(el.fontSize) || 16) * scale}px;
        `;

        if (el.type === 'text') {
          html += `<div style="${style}">${el.content || ''}</div>`;
        } else if (el.type === 'shape') {
          html += `<div style="${style}; background: ${el.fill || '#ddd'}; border-radius: ${el.shapeType === 'circle' ? '50%' : '0'};"></div>`;
        } else if (el.type === 'image') {
          html += `<img src="${el.src}" style="${style}; object-fit: contain;">`;
        }
      });

      html += '</div>';
      preview.innerHTML = html;

      document.getElementById('coachSlideNumber').textContent = `Slide ${coachCurrentSlide + 1} of ${slides.length}`;

      coachSessionData.slidesCovered.add(coachCurrentSlide);
    }

    function updateCoachNotes() {
      const slide = slides[coachCurrentSlide];
      const notes = slide?.notes || 'No speaker notes for this slide';
      document.getElementById('coachNotes').textContent = notes;
    }

    function updateCoachTip() {
      const tip = presenterTips[Math.floor(Math.random() * presenterTips.length)];
      document.getElementById('coachTips').innerHTML = `<p>${tip}</p>`;
    }

    function coachNextSlide() {
      if (coachCurrentSlide < slides.length - 1) {
        // Record time spent on current slide
        if (coachActive && coachStartTime) {
          const slideTime = Date.now() - coachStartTime;
          coachSessionData.slideTimes[coachCurrentSlide] = (coachSessionData.slideTimes[coachCurrentSlide] || 0) + slideTime;
        }

        coachCurrentSlide++;
        updateCoachSlidePreview();
        updateCoachNotes();

        if (!coachActive) {
          updateCoachTip();
        }
      }
    }

    function coachPrevSlide() {
      if (coachCurrentSlide > 0) {
        coachCurrentSlide--;
        updateCoachSlidePreview();
        updateCoachNotes();

        if (!coachActive) {
          updateCoachTip();
        }
      }
    }

    function showCoachReport() {
      const totalTime = coachSessionData.totalTime || 1;
      const mins = Math.floor(totalTime / 60);
      const secs = totalTime % 60;

      document.getElementById('reportDuration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      document.getElementById('reportSlides').textContent = coachSessionData.slidesCovered.size;

      const avgPace = totalTime / (coachSessionData.slidesCovered.size || 1);
      let paceLabel = 'Good';
      if (avgPace < 30) paceLabel = 'Fast';
      else if (avgPace > 90) paceLabel = 'Slow';
      document.getElementById('reportPace').textContent = paceLabel;

      // Generate suggestions
      const suggestions = [];
      if (coachSessionData.fillerCount > 5) {
        suggestions.push('Try to reduce filler words like "um", "uh", "like"');
      }
      if (avgPace < 30) {
        suggestions.push('Slow down slightly to let key points sink in');
      } else if (avgPace > 90) {
        suggestions.push('Pick up the pace to maintain audience engagement');
      }
      if (coachSessionData.slidesCovered.size < slides.length) {
        suggestions.push(`You covered ${coachSessionData.slidesCovered.size} of ${slides.length} slides - practice the full presentation`);
      }
      if (totalTime < 60) {
        suggestions.push('Try a longer practice session for more accurate feedback');
      }
      suggestions.push('Practice in front of a mirror or record yourself');
      suggestions.push('Review your speaker notes before presenting');

      const suggestionsHtml = suggestions.map(s => `<li>${s}</li>`).join('');
      document.getElementById('reportSuggestions').innerHTML = `
        <h4 style="margin-bottom: 0.5rem;">Suggestions for Improvement</h4>
        <ul style="margin: 0; padding-left: 1.25rem; color: #666;">${suggestionsHtml}</ul>
      `;

      // Set overall score
      const avgPacingScore = coachSessionData.pacingScores.length > 0
        ? coachSessionData.pacingScores.reduce((a, b) => a + b, 0) / coachSessionData.pacingScores.length
        : 50;

      let overallLabel = 'Great Job!';
      if (avgPacingScore < 40) overallLabel = 'Needs Practice';
      else if (avgPacingScore < 60) overallLabel = 'Good Effort!';
      else if (avgPacingScore < 80) overallLabel = 'Well Done!';

      document.getElementById('reportOverallScore').textContent = overallLabel;

      document.getElementById('coachReportModal').style.display = 'flex';
    }

    function hideCoachReport() {
      document.getElementById('coachReportModal').style.display = 'none';
    }

    // ========== Drawing/Ink Tools ==========
    let drawModeActive = false;
    let currentDrawTool = 'pen';
    let drawColor = '#000000';
    let drawSize = 3;
    let isDrawing = false;
    let drawCanvas = null;
    let drawCtx = null;
    let lastX = 0;
    let lastY = 0;
    let drawingHistory = []; // Per-slide drawing history

    // Enhanced Drawing State
    let currentDrawShape = null; // line, arrow, rect, ellipse, triangle, star, polygon, heart, cloud, speech
    let shapeStartX = 0;
    let shapeStartY = 0;
    let brushStyle = 'solid'; // solid, dashed, dotted, soft
    let shapeFill = false;
    let fillColor = '#1a73e8';
    let drawOpacity = 100;
    let lineSmoothing = 3;
    let recentColors = JSON.parse(localStorage.getItem('ninjaslides_recent_colors') || '[]');
    let shiftKeyDown = false;
    let tempCanvas = null;
    let tempCtx = null;

    function initDrawCanvas() {
      const slideCanvas = document.getElementById('slideCanvas');

      // Remove existing draw canvas if any
      const existingCanvas = slideCanvas.querySelector('.draw-canvas');
      if (existingCanvas) {
        existingCanvas.remove();
      }

      // Create canvas element
      drawCanvas = document.createElement('canvas');
      drawCanvas.className = 'draw-canvas';
      drawCanvas.width = slideCanvas.offsetWidth;
      drawCanvas.height = slideCanvas.offsetHeight;
      slideCanvas.appendChild(drawCanvas);

      drawCtx = drawCanvas.getContext('2d');
      drawCtx.lineCap = 'round';
      drawCtx.lineJoin = 'round';

      // Restore any existing drawings for this slide
      restoreDrawings();

      // Set up event listeners
      drawCanvas.addEventListener('mousedown', startDrawing);
      drawCanvas.addEventListener('mousemove', draw);
      drawCanvas.addEventListener('mouseup', stopDrawing);
      drawCanvas.addEventListener('mouseout', stopDrawing);

      // Touch support
      drawCanvas.addEventListener('touchstart', handleTouchStart);
      drawCanvas.addEventListener('touchmove', handleTouchMove);
      drawCanvas.addEventListener('touchend', stopDrawing);
    }

    function toggleDrawMode() {
      drawModeActive = !drawModeActive;
      const btn = document.getElementById('drawModeBtn');

      if (drawModeActive) {
        btn.textContent = 'âœï¸ Draw Mode: ON';
        btn.classList.add('active');
        drawCanvas.classList.add('active');
        if (currentDrawTool === 'eraser') {
          drawCanvas.classList.add('eraser');
        }
        showToast('Draw mode enabled - draw on the slide', 'success');
      } else {
        btn.textContent = 'âœï¸ Draw Mode: OFF';
        btn.classList.remove('active');
        drawCanvas.classList.remove('active', 'eraser');
        showToast('Draw mode disabled', 'info');
      }
    }

    function selectDrawTool(tool) {
      currentDrawTool = tool;

      // Update button states
      document.querySelectorAll('.draw-tool-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tool + 'Btn')?.classList.add('active');
      if (tool === 'select') {
        document.getElementById('selectToolBtn')?.classList.add('active');
      }

      // Update cursor
      if (drawCanvas) {
        drawCanvas.classList.remove('eraser');
        if (tool === 'eraser') {
          drawCanvas.classList.add('eraser');
        }
      }

      // If selecting 'select' tool, disable draw mode
      if (tool === 'select' && drawModeActive) {
        toggleDrawMode();
      }
    }

    function setDrawColor(color) {
      drawColor = color;
      document.getElementById('drawColor').value = color;
    }

    function setDrawSize(size) {
      drawSize = parseInt(size);
      document.getElementById('drawSizeValue').textContent = size;
    }

    function startDrawing(e) {
      if (!drawModeActive) return;
      isDrawing = true;

      const rect = drawCanvas.getBoundingClientRect();
      lastX = e.clientX - rect.left;
      lastY = e.clientY - rect.top;

      // For single click dot
      drawCtx.beginPath();
      drawCtx.arc(lastX, lastY, drawSize / 2, 0, Math.PI * 2);
      if (currentDrawTool === 'eraser') {
        drawCtx.globalCompositeOperation = 'destination-out';
        drawCtx.fillStyle = 'rgba(0,0,0,1)';
      } else {
        drawCtx.globalCompositeOperation = 'source-over';
        if (currentDrawTool === 'highlighter') {
          drawCtx.fillStyle = hexToRgba(drawColor, 0.3);
        } else {
          drawCtx.fillStyle = drawColor;
        }
      }
      drawCtx.fill();
    }

    function draw(e) {
      if (!isDrawing || !drawModeActive) return;

      const rect = drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      drawCtx.beginPath();
      drawCtx.moveTo(lastX, lastY);
      drawCtx.lineTo(x, y);

      if (currentDrawTool === 'eraser') {
        drawCtx.globalCompositeOperation = 'destination-out';
        drawCtx.strokeStyle = 'rgba(0,0,0,1)';
        drawCtx.lineWidth = drawSize * 3;
      } else if (currentDrawTool === 'highlighter') {
        drawCtx.globalCompositeOperation = 'source-over';
        drawCtx.strokeStyle = hexToRgba(drawColor, 0.3);
        drawCtx.lineWidth = drawSize * 3;
      } else {
        drawCtx.globalCompositeOperation = 'source-over';
        drawCtx.strokeStyle = drawColor;
        drawCtx.lineWidth = drawSize;
      }

      drawCtx.stroke();

      lastX = x;
      lastY = y;
    }

    function stopDrawing() {
      if (isDrawing) {
        isDrawing = false;
        saveDrawings();
      }
    }

    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      startDrawing(mouseEvent);
    }

    function handleTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      draw(mouseEvent);
    }

    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function saveDrawings() {
      if (!drawCanvas) return;

      // Initialize storage for this slide if needed
      if (!slides[currentSlideIndex].drawings) {
        slides[currentSlideIndex].drawings = [];
      }

      // Save current canvas state
      slides[currentSlideIndex].drawings.push(drawCanvas.toDataURL());

      // Keep only the latest state (for undo functionality, keep last 10)
      if (slides[currentSlideIndex].drawings.length > 10) {
        slides[currentSlideIndex].drawings.shift();
      }
    }

    function restoreDrawings() {
      if (!drawCanvas || !drawCtx) return;

      const drawings = slides[currentSlideIndex]?.drawings;
      if (drawings && drawings.length > 0) {
        const img = new Image();
        img.onload = function() {
          drawCtx.drawImage(img, 0, 0);
        };
        img.src = drawings[drawings.length - 1];
      }
    }

    function undoDrawing() {
      if (!slides[currentSlideIndex]?.drawings || slides[currentSlideIndex].drawings.length === 0) {
        showToast('Nothing to undo', 'warning');
        return;
      }

      // Remove the last saved state
      slides[currentSlideIndex].drawings.pop();

      // Clear canvas
      drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);

      // Restore previous state if any
      if (slides[currentSlideIndex].drawings.length > 0) {
        const img = new Image();
        img.onload = function() {
          drawCtx.drawImage(img, 0, 0);
        };
        img.src = slides[currentSlideIndex].drawings[slides[currentSlideIndex].drawings.length - 1];
      }

      showToast('Drawing undone', 'success');
    }

    function clearAllDrawings() {
      if (!drawCanvas || !drawCtx) return;

      drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
      slides[currentSlideIndex].drawings = [];
      showToast('All drawings cleared', 'success');
    }

    function convertToShape() {
      showToast('Convert to Shape: Coming soon! This will convert freehand drawings to vector shapes.', 'info');
    }

    // ========== Enhanced Drawing Tools Functions ==========

    function showDrawingPanel() {
      document.getElementById('drawingPanel').classList.add('visible');
      updateRecentColorsDisplay();
      syncPanelWithToolbar();
    }

    function hideDrawingPanel() {
      document.getElementById('drawingPanel').classList.remove('visible');
    }

    function syncPanelWithToolbar() {
      // Sync opacity
      document.getElementById('panelDrawOpacity').value = drawOpacity;
      document.getElementById('panelOpacityValue').textContent = drawOpacity + '%';

      // Sync fill toggle
      document.getElementById('panelFillToggle').checked = shapeFill;
      document.getElementById('fillColorPicker').value = fillColor;

      // Sync brush style
      document.querySelectorAll('.brush-style-btn').forEach(btn => btn.classList.remove('active'));
      const brushBtn = document.getElementById('panelBrush' + brushStyle.charAt(0).toUpperCase() + brushStyle.slice(1));
      if (brushBtn) brushBtn.classList.add('active');
    }

    function selectDrawShape(shape) {
      currentDrawShape = shape;
      currentDrawTool = 'shape';

      // Update shape button states
      document.querySelectorAll('.draw-shape-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(shape + 'Btn')?.classList.add('active');

      // Update tool buttons
      document.querySelectorAll('.draw-tool-btn').forEach(btn => btn.classList.remove('active'));

      // Update canvas cursor
      if (drawCanvas) {
        drawCanvas.classList.remove('eraser');
        drawCanvas.classList.add('shape-' + shape);
      }

      // Auto-enable draw mode
      if (!drawModeActive) {
        toggleDrawMode();
      }

      showToast('Shape tool: ' + shape.charAt(0).toUpperCase() + shape.slice(1), 'info');
    }

    function selectDrawShapeFromPanel(shape) {
      selectDrawShape(shape);
      hideDrawingPanel();
    }

    function selectDrawToolFromPanel(tool) {
      currentDrawShape = null;
      selectDrawTool(tool);

      // Handle special tools
      if (tool === 'spray' || tool === 'calligraphy') {
        currentDrawTool = tool;
        if (!drawModeActive) toggleDrawMode();
        showToast(tool.charAt(0).toUpperCase() + tool.slice(1) + ' tool selected', 'info');
      }

      hideDrawingPanel();
    }

    function setBrushStyle(style) {
      brushStyle = style;

      // Update toolbar buttons
      document.querySelectorAll('#brushSolidBtn, #brushDashedBtn, #brushDottedBtn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('brush' + style.charAt(0).toUpperCase() + style.slice(1) + 'Btn')?.classList.add('active');

      showToast('Brush style: ' + style, 'info');
    }

    function setBrushStyleFromPanel(style) {
      brushStyle = style;

      // Update panel buttons
      document.querySelectorAll('.brush-style-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('panelBrush' + style.charAt(0).toUpperCase() + style.slice(1))?.classList.add('active');

      // Update toolbar
      setBrushStyle(style);
    }

    function toggleShapeFill(filled) {
      shapeFill = filled;
      document.getElementById('panelFillToggle').checked = filled;
    }

    function toggleShapeFillFromPanel(filled) {
      toggleShapeFill(filled);
    }

    function setFillColor(color) {
      fillColor = color;
      addRecentColor(color);
    }

    function setDrawOpacity(opacity) {
      drawOpacity = parseInt(opacity);
      document.getElementById('drawOpacityValue').textContent = opacity + '%';
      document.getElementById('panelDrawOpacity').value = opacity;
      document.getElementById('panelOpacityValue').textContent = opacity + '%';
    }

    function setDrawOpacityFromPanel(opacity) {
      setDrawOpacity(opacity);
    }

    function setLineSmoothing(value) {
      lineSmoothing = parseInt(value);
      document.getElementById('smoothingValue').textContent = value;
    }

    function addRecentColor(color) {
      // Don't add duplicates
      recentColors = recentColors.filter(c => c !== color);
      recentColors.unshift(color);

      // Keep only 10 recent colors
      if (recentColors.length > 10) {
        recentColors = recentColors.slice(0, 10);
      }

      localStorage.setItem('ninjaslides_recent_colors', JSON.stringify(recentColors));
      updateRecentColorsDisplay();
    }

    function updateRecentColorsDisplay() {
      const container = document.getElementById('recentDrawColors');
      if (!container) return;

      container.innerHTML = recentColors.map(color =>
        `<div class="recent-color" style="background: ${color};" onclick="setDrawColor('${color}')" title="${color}"></div>`
      ).join('');

      if (recentColors.length === 0) {
        container.innerHTML = '<span style="font-size: 0.8rem; color: #9aa0a6;">No recent colors</span>';
      }
    }

    // Override setDrawColor to track recent colors
    const originalSetDrawColor = setDrawColor;
    setDrawColor = function(color) {
      drawColor = color;
      document.getElementById('drawColor').value = color;
      addRecentColor(color);
    };

    // Enhanced startDrawing for shapes
    const originalStartDrawing = startDrawing;
    startDrawing = function(e) {
      if (!drawModeActive) return;

      const rect = drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // If shape mode
      if (currentDrawShape) {
        isDrawing = true;
        shapeStartX = x;
        shapeStartY = y;

        // Create temp canvas for shape preview
        if (!tempCanvas) {
          tempCanvas = document.createElement('canvas');
          tempCanvas.width = drawCanvas.width;
          tempCanvas.height = drawCanvas.height;
          tempCanvas.style.cssText = drawCanvas.style.cssText;
          tempCanvas.style.position = 'absolute';
          tempCanvas.style.pointerEvents = 'none';
          tempCanvas.style.zIndex = '100';
          drawCanvas.parentElement.appendChild(tempCanvas);
          tempCtx = tempCanvas.getContext('2d');
        }
        tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
        return;
      }

      // Eyedropper tool
      if (currentDrawTool === 'eyedropper') {
        pickColorAt(e);
        return;
      }

      // Spray or calligraphy
      if (currentDrawTool === 'spray' || currentDrawTool === 'calligraphy') {
        isDrawing = true;
        lastX = x;
        lastY = y;
        return;
      }

      // Original drawing behavior
      originalStartDrawing.call(this, e);
    };

    // Enhanced draw for shapes
    const originalDraw = draw;
    draw = function(e) {
      if (!drawModeActive) return;

      const rect = drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Eyedropper preview
      if (currentDrawTool === 'eyedropper') {
        updateEyedropperPreview(e);
        return;
      }

      // Shape preview
      if (currentDrawShape && isDrawing && tempCtx) {
        tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

        let endX = x;
        let endY = y;

        // Shift for constrained shapes
        if (shiftKeyDown) {
          const dx = endX - shapeStartX;
          const dy = endY - shapeStartY;
          const size = Math.max(Math.abs(dx), Math.abs(dy));
          endX = shapeStartX + (dx > 0 ? size : -size);
          endY = shapeStartY + (dy > 0 ? size : -size);
        }

        drawShapePreview(tempCtx, shapeStartX, shapeStartY, endX, endY);
        return;
      }

      // Spray tool
      if (currentDrawTool === 'spray' && isDrawing) {
        drawSpray(x, y);
        lastX = x;
        lastY = y;
        return;
      }

      // Calligraphy tool
      if (currentDrawTool === 'calligraphy' && isDrawing) {
        drawCalligraphy(x, y);
        lastX = x;
        lastY = y;
        return;
      }

      // Show line assist when shift is held
      if (shiftKeyDown && isDrawing && !currentDrawShape) {
        document.getElementById('lineAssistIndicator').classList.add('visible');
      } else {
        document.getElementById('lineAssistIndicator').classList.remove('visible');
      }

      // Original draw with optional straight line assist
      if (shiftKeyDown && isDrawing && !currentDrawShape) {
        const dx = Math.abs(x - lastX);
        const dy = Math.abs(y - lastY);

        drawCtx.beginPath();
        drawCtx.moveTo(lastX, lastY);

        // Snap to horizontal, vertical, or 45-degree
        if (dx > dy * 2) {
          drawCtx.lineTo(x, lastY); // Horizontal
        } else if (dy > dx * 2) {
          drawCtx.lineTo(lastX, y); // Vertical
        } else {
          // 45 degree
          const dist = Math.min(dx, dy);
          drawCtx.lineTo(lastX + (x > lastX ? dist : -dist), lastY + (y > lastY ? dist : -dist));
        }

        applyBrushStyle(drawCtx);
        drawCtx.globalAlpha = drawOpacity / 100;
        drawCtx.stroke();
        drawCtx.globalAlpha = 1;

        lastX = x;
        lastY = y;
        return;
      }

      originalDraw.call(this, e);
    };

    // Enhanced stopDrawing for shapes
    const originalStopDrawing = stopDrawing;
    stopDrawing = function() {
      if (currentDrawShape && isDrawing) {
        // Finalize the shape on main canvas
        if (tempCtx && drawCtx) {
          // Copy temp canvas to main
          drawCtx.drawImage(tempCanvas, 0, 0);
          tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
        }
        isDrawing = false;
        saveDrawings();
        return;
      }

      document.getElementById('lineAssistIndicator').classList.remove('visible');
      originalStopDrawing.call(this);
    };

    function drawShapePreview(ctx, x1, y1, x2, y2) {
      ctx.beginPath();
      applyBrushStyle(ctx);
      ctx.globalAlpha = drawOpacity / 100;

      const width = x2 - x1;
      const height = y2 - y1;

      switch (currentDrawShape) {
        case 'line':
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();
          break;

        case 'arrow':
          drawArrowShape(ctx, x1, y1, x2, y2);
          break;

        case 'rect':
          if (shapeFill) {
            ctx.fillStyle = fillColor;
            ctx.fillRect(x1, y1, width, height);
          }
          ctx.strokeRect(x1, y1, width, height);
          break;

        case 'ellipse':
          ctx.beginPath();
          ctx.ellipse(x1 + width/2, y1 + height/2, Math.abs(width/2), Math.abs(height/2), 0, 0, Math.PI * 2);
          if (shapeFill) {
            ctx.fillStyle = fillColor;
            ctx.fill();
          }
          ctx.stroke();
          break;

        case 'triangle':
          ctx.beginPath();
          ctx.moveTo(x1 + width/2, y1);
          ctx.lineTo(x2, y2);
          ctx.lineTo(x1, y2);
          ctx.closePath();
          if (shapeFill) {
            ctx.fillStyle = fillColor;
            ctx.fill();
          }
          ctx.stroke();
          break;

        case 'star':
          drawStar(ctx, x1 + width/2, y1 + height/2, 5, Math.min(Math.abs(width), Math.abs(height))/2, Math.min(Math.abs(width), Math.abs(height))/4);
          break;

        case 'polygon':
          drawPolygon(ctx, x1 + width/2, y1 + height/2, 6, Math.min(Math.abs(width), Math.abs(height))/2);
          break;

        case 'heart':
          drawHeart(ctx, x1, y1, Math.abs(width), Math.abs(height));
          break;

        case 'cloud':
          drawCloud(ctx, x1, y1, Math.abs(width), Math.abs(height));
          break;

        case 'speech':
          drawSpeechBubble(ctx, x1, y1, Math.abs(width), Math.abs(height));
          break;
      }

      ctx.globalAlpha = 1;
    }

    function drawArrowShape(ctx, x1, y1, x2, y2) {
      const headLen = 15;
      const angle = Math.atan2(y2 - y1, x2 - x1);

      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();

      // Arrowhead
      ctx.beginPath();
      ctx.moveTo(x2, y2);
      ctx.lineTo(x2 - headLen * Math.cos(angle - Math.PI/6), y2 - headLen * Math.sin(angle - Math.PI/6));
      ctx.lineTo(x2 - headLen * Math.cos(angle + Math.PI/6), y2 - headLen * Math.sin(angle + Math.PI/6));
      ctx.closePath();
      ctx.fillStyle = drawColor;
      ctx.fill();
    }

    function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
      let rot = Math.PI / 2 * 3;
      let x = cx;
      let y = cy;
      const step = Math.PI / spikes;

      ctx.beginPath();
      ctx.moveTo(cx, cy - outerRadius);

      for (let i = 0; i < spikes; i++) {
        x = cx + Math.cos(rot) * outerRadius;
        y = cy + Math.sin(rot) * outerRadius;
        ctx.lineTo(x, y);
        rot += step;

        x = cx + Math.cos(rot) * innerRadius;
        y = cy + Math.sin(rot) * innerRadius;
        ctx.lineTo(x, y);
        rot += step;
      }

      ctx.lineTo(cx, cy - outerRadius);
      ctx.closePath();

      if (shapeFill) {
        ctx.fillStyle = fillColor;
        ctx.fill();
      }
      ctx.stroke();
    }

    function drawPolygon(ctx, cx, cy, sides, radius) {
      const angle = (2 * Math.PI) / sides;

      ctx.beginPath();
      for (let i = 0; i < sides; i++) {
        const x = cx + radius * Math.cos(i * angle - Math.PI / 2);
        const y = cy + radius * Math.sin(i * angle - Math.PI / 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.closePath();

      if (shapeFill) {
        ctx.fillStyle = fillColor;
        ctx.fill();
      }
      ctx.stroke();
    }

    function drawHeart(ctx, x, y, width, height) {
      ctx.beginPath();
      const topCurveHeight = height * 0.3;
      ctx.moveTo(x + width / 2, y + topCurveHeight);

      // Left curve
      ctx.bezierCurveTo(x + width / 2, y, x, y, x, y + topCurveHeight);
      ctx.bezierCurveTo(x, y + (height + topCurveHeight) / 2, x + width / 2, y + (height + topCurveHeight) / 2, x + width / 2, y + height);

      // Right curve
      ctx.bezierCurveTo(x + width / 2, y + (height + topCurveHeight) / 2, x + width, y + (height + topCurveHeight) / 2, x + width, y + topCurveHeight);
      ctx.bezierCurveTo(x + width, y, x + width / 2, y, x + width / 2, y + topCurveHeight);

      ctx.closePath();

      if (shapeFill) {
        ctx.fillStyle = fillColor;
        ctx.fill();
      }
      ctx.stroke();
    }

    function drawCloud(ctx, x, y, width, height) {
      ctx.beginPath();

      // Draw cloud using multiple arcs
      const centerX = x + width / 2;
      const centerY = y + height / 2;
      const r = Math.min(width, height) / 4;

      ctx.arc(centerX - r, centerY, r, 0, Math.PI * 2);
      ctx.arc(centerX + r, centerY, r, 0, Math.PI * 2);
      ctx.arc(centerX, centerY - r * 0.5, r * 1.2, 0, Math.PI * 2);
      ctx.arc(centerX - r * 0.5, centerY + r * 0.5, r * 0.8, 0, Math.PI * 2);
      ctx.arc(centerX + r * 0.5, centerY + r * 0.5, r * 0.8, 0, Math.PI * 2);

      if (shapeFill) {
        ctx.fillStyle = fillColor;
        ctx.fill();
      }
      ctx.stroke();
    }

    function drawSpeechBubble(ctx, x, y, width, height) {
      const radius = 10;
      const tailHeight = height * 0.2;
      const bubbleHeight = height - tailHeight;

      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + bubbleHeight - radius);
      ctx.quadraticCurveTo(x + width, y + bubbleHeight, x + width - radius, y + bubbleHeight);
      ctx.lineTo(x + width * 0.4, y + bubbleHeight);
      ctx.lineTo(x + width * 0.2, y + height);
      ctx.lineTo(x + width * 0.3, y + bubbleHeight);
      ctx.lineTo(x + radius, y + bubbleHeight);
      ctx.quadraticCurveTo(x, y + bubbleHeight, x, y + bubbleHeight - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();

      if (shapeFill) {
        ctx.fillStyle = fillColor;
        ctx.fill();
      }
      ctx.stroke();
    }

    function applyBrushStyle(ctx) {
      ctx.strokeStyle = drawColor;
      ctx.lineWidth = drawSize;

      switch (brushStyle) {
        case 'dashed':
          ctx.setLineDash([drawSize * 3, drawSize * 2]);
          break;
        case 'dotted':
          ctx.setLineDash([drawSize, drawSize * 2]);
          break;
        case 'soft':
          ctx.shadowColor = drawColor;
          ctx.shadowBlur = drawSize;
          ctx.setLineDash([]);
          break;
        default: // solid
          ctx.setLineDash([]);
          ctx.shadowBlur = 0;
      }
    }

    function drawSpray(x, y) {
      const density = 30;
      const radius = drawSize * 3;

      drawCtx.fillStyle = drawColor;
      drawCtx.globalAlpha = (drawOpacity / 100) * 0.3;

      for (let i = 0; i < density; i++) {
        const angle = Math.random() * Math.PI * 2;
        const dist = Math.random() * radius;
        const px = x + Math.cos(angle) * dist;
        const py = y + Math.sin(angle) * dist;

        drawCtx.beginPath();
        drawCtx.arc(px, py, 1, 0, Math.PI * 2);
        drawCtx.fill();
      }

      drawCtx.globalAlpha = 1;
    }

    function drawCalligraphy(x, y) {
      const dx = x - lastX;
      const dy = y - lastY;
      const angle = Math.atan2(dy, dx);

      drawCtx.save();
      drawCtx.translate(x, y);
      drawCtx.rotate(angle + Math.PI / 4);

      drawCtx.fillStyle = drawColor;
      drawCtx.globalAlpha = drawOpacity / 100;
      drawCtx.fillRect(-drawSize / 2, -drawSize * 2, drawSize, drawSize * 4);

      drawCtx.restore();
      drawCtx.globalAlpha = 1;
    }

    function pickColorAt(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const pixel = drawCtx.getImageData(x, y, 1, 1).data;
      const color = `#${pixel[0].toString(16).padStart(2, '0')}${pixel[1].toString(16).padStart(2, '0')}${pixel[2].toString(16).padStart(2, '0')}`;

      setDrawColor(color);
      hideEyedropperPreview();

      // Switch back to pen
      selectDrawTool('pen');
      showToast('Color picked: ' + color, 'success');
    }

    function updateEyedropperPreview(e) {
      const preview = document.getElementById('eyedropperPreview');
      const rect = drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const pixel = drawCtx.getImageData(x, y, 1, 1).data;
      const color = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;

      preview.style.left = e.clientX + 'px';
      preview.style.top = e.clientY + 'px';
      preview.style.background = color;
      preview.classList.add('visible');
    }

    function hideEyedropperPreview() {
      document.getElementById('eyedropperPreview').classList.remove('visible');
    }

    // Keyboard events for shift key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Shift') {
        shiftKeyDown = true;
        if (drawModeActive && isDrawing) {
          document.getElementById('lineAssistIndicator').classList.add('visible');
        }
      }

      // D key to toggle draw mode
      if (e.key === 'd' || e.key === 'D') {
        if (!e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
          const activeTab = document.querySelector('.tab.active');
          if (activeTab && activeTab.dataset.tab === 'draw') {
            toggleDrawMode();
          }
        }
      }
    });

    document.addEventListener('keyup', function(e) {
      if (e.key === 'Shift') {
        shiftKeyDown = false;
        document.getElementById('lineAssistIndicator').classList.remove('visible');
      }
    });

    // Clean up eyedropper on mouse leave
    document.addEventListener('mouseleave', function() {
      hideEyedropperPreview();
    });

    // Re-initialize draw canvas when switching slides
    const originalSelectSlide = selectSlide;
    selectSlide = function(index) {
      originalSelectSlide(index);
      setTimeout(() => {
        initDrawCanvas();
      }, 100);
    };

    // Handle window resize
    window.addEventListener('resize', () => {
      if (drawCanvas) {
        const slideCanvas = document.getElementById('slideCanvas');
        drawCanvas.width = slideCanvas.offsetWidth;
        drawCanvas.height = slideCanvas.offsetHeight;
        restoreDrawings();
      }
    });

    // Initialize draw canvas on load
    setTimeout(() => {
      initDrawCanvas();
    }, 500);

    // ========== Keyboard Shortcuts ==========
    function showKeyboardShortcuts() {
      document.getElementById('shortcutsModal').style.display = 'flex';
    }

    function hideKeyboardShortcuts() {
      document.getElementById('shortcutsModal').style.display = 'none';
    }

    // F1 key to show shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardShortcuts();
      }
    });

    // Click outside modal to close
    document.getElementById('shortcutsModal').addEventListener('click', (e) => {
      if (e.target.id === 'shortcutsModal') {
        hideKeyboardShortcuts();
      }
    });

    // ========== Speaker View ==========
    let svTimerInterval = null;
    let svStartTime = null;
    let svCurrentSlide = 0;

    function startSpeakerView() {
      svCurrentSlide = currentSlideIndex;
      svStartTime = Date.now();

      document.getElementById('speakerView').classList.add('visible');
      document.body.style.overflow = 'hidden';

      // Start timer
      svTimerInterval = setInterval(updateSvTimer, 1000);

      // Render slides
      updateSpeakerView();
    }

    function endSpeakerView() {
      document.getElementById('speakerView').classList.remove('visible');
      document.body.style.overflow = '';

      if (svTimerInterval) {
        clearInterval(svTimerInterval);
        svTimerInterval = null;
      }
    }

    function updateSvTimer() {
      if (!svStartTime) return;
      const elapsed = Math.floor((Date.now() - svStartTime) / 1000);
      const hours = Math.floor(elapsed / 3600);
      const minutes = Math.floor((elapsed % 3600) / 60);
      const seconds = elapsed % 60;
      document.getElementById('svTimer').textContent =
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function svResetTimer() {
      svStartTime = Date.now();
      updateSvTimer();
    }

    function updateSpeakerView() {
      const currentSlide = slides[svCurrentSlide];
      const nextSlide = slides[svCurrentSlide + 1];

      // Update slide numbers
      document.getElementById('svSlideNum').textContent = svCurrentSlide + 1;
      document.getElementById('svTotalSlides').textContent = slides.length;

      // Render current slide
      renderSvSlide('svCurrentSlide', currentSlide);

      // Render next slide preview
      if (nextSlide) {
        renderSvSlide('svNextSlide', nextSlide);
      } else {
        document.getElementById('svNextSlide').innerHTML =
          '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">End of Presentation</div>';
      }

      // Update notes
      const notes = currentSlide.notes || 'No notes for this slide';
      document.getElementById('svNotes').textContent = notes;
    }

    function renderSvSlide(containerId, slide) {
      const container = document.getElementById(containerId);
      container.style.background = slide.background;

      let html = '';
      slide.elements.forEach(el => {
        const scale = containerId === 'svNextSlide' ? 0.15 : 0.4;

        if (el.type === 'text') {
          html += `
            <div style="position: absolute; left: ${el.x * scale}px; top: ${el.y * scale}px;
                        width: ${el.width * scale}px; font-size: calc(${el.style.fontSize} * ${scale});
                        font-weight: ${el.style.fontWeight}; font-family: ${el.style.fontFamily};
                        color: ${el.style.color}; text-align: ${el.style.textAlign};
                        padding: ${4 * scale}px; overflow: hidden;">
              ${el.content}
            </div>
          `;
        } else if (el.type === 'shape') {
          html += `
            <div style="position: absolute; left: ${el.x * scale}px; top: ${el.y * scale}px;
                        width: ${el.width * scale}px; height: ${el.height * scale}px;
                        background: ${el.style.background}; border-radius: ${el.shape === 'circle' ? '50%' : '4px'};
                        ${el.shape === 'triangle' ? 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);' : ''}">
            </div>
          `;
        } else if (el.type === 'image') {
          html += `
            <div style="position: absolute; left: ${el.x * scale}px; top: ${el.y * scale}px;
                        width: ${el.width * scale}px; height: ${el.height * scale}px;">
              <img src="${el.src}" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
          `;
        }
      });

      container.innerHTML = html;
    }

    function svNextSlide() {
      if (svCurrentSlide < slides.length - 1) {
        svCurrentSlide++;
        updateSpeakerView();
      }
    }

    function svPrevSlide() {
      if (svCurrentSlide > 0) {
        svCurrentSlide--;
        updateSpeakerView();
      }
    }

    // Keyboard controls for speaker view
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('speakerView').classList.contains('visible')) return;

      if (e.key === 'Escape') {
        endSpeakerView();
      } else if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
        svNextSlide();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        svPrevSlide();
      }
    });

    // ========== Print Preview ==========
    function showPrintPreview() {
      document.getElementById('printRange').onchange = function() {
        document.getElementById('customRangeGroup').style.display =
          this.value === 'custom' ? 'block' : 'none';
      };
      updatePrintPreview();
      document.getElementById('printPreviewModal').classList.add('active');
    }

    function hidePrintPreview() {
      document.getElementById('printPreviewModal').classList.remove('active');
    }

    function updatePrintPreview() {
      const layout = document.getElementById('printLayout').value;
      const range = document.getElementById('printRange').value;
      const borders = document.getElementById('printBorders').checked;
      const grayscale = document.getElementById('printGrayscale').checked;
      const container = document.getElementById('printPreviewContent');

      // Determine which slides to show
      let slideIndices = [];
      if (range === 'all') {
        slideIndices = slides.map((_, i) => i);
      } else if (range === 'current') {
        slideIndices = [currentSlideIndex];
      } else {
        // Parse custom range like "1-3, 5, 7-9"
        const customRange = document.getElementById('customPrintRange').value;
        customRange.split(',').forEach(part => {
          part = part.trim();
          if (part.includes('-')) {
            const [start, end] = part.split('-').map(n => parseInt(n) - 1);
            for (let i = start; i <= end && i < slides.length; i++) {
              if (i >= 0) slideIndices.push(i);
            }
          } else {
            const idx = parseInt(part) - 1;
            if (idx >= 0 && idx < slides.length) slideIndices.push(idx);
          }
        });
      }

      // Generate preview
      container.innerHTML = '';

      if (layout === 'full') {
        slideIndices.forEach(idx => {
          const slideDiv = createSlidePreview(idx, borders, grayscale, 400);
          container.appendChild(slideDiv);
        });
      } else if (layout === 'notes') {
        slideIndices.forEach(idx => {
          const pageDiv = document.createElement('div');
          pageDiv.style.cssText = 'background: white; padding: 1rem; width: 400px; border-radius: 4px;';
          const slideDiv = createSlidePreview(idx, true, grayscale, 300);
          slideDiv.style.margin = '0 auto 1rem';
          pageDiv.appendChild(slideDiv);
          const notes = document.createElement('div');
          notes.style.cssText = 'font-size: 0.85rem; border-top: 1px solid #ddd; padding-top: 0.5rem;';
          notes.textContent = slides[idx].speakerNotes || 'No notes for this slide';
          pageDiv.appendChild(notes);
          container.appendChild(pageDiv);
        });
      } else if (layout === 'outline') {
        const outlineDiv = document.createElement('div');
        outlineDiv.style.cssText = 'background: white; padding: 1rem; width: 400px; border-radius: 4px;';
        slideIndices.forEach(idx => {
          const slide = slides[idx];
          const slideEntry = document.createElement('div');
          slideEntry.style.marginBottom = '1rem';
          slideEntry.innerHTML = `<strong>Slide ${idx + 1}</strong>`;
          slide.elements.filter(e => e.type === 'text').forEach(el => {
            const p = document.createElement('p');
            p.style.cssText = 'margin: 0.25rem 0 0.25rem 1rem; font-size: 0.85rem;';
            p.textContent = el.text;
            slideEntry.appendChild(p);
          });
          outlineDiv.appendChild(slideEntry);
        });
        container.appendChild(outlineDiv);
      } else {
        // Handouts
        const perPage = parseInt(layout.replace('handouts', ''));
        const pageDiv = document.createElement('div');
        pageDiv.style.cssText = `background: white; padding: 1rem; width: 400px; border-radius: 4px;
          display: grid; grid-template-columns: repeat(${perPage <= 2 ? 1 : 2}, 1fr); gap: 0.5rem;`;
        slideIndices.forEach(idx => {
          const size = perPage <= 2 ? 180 : 120;
          const slideDiv = createSlidePreview(idx, true, grayscale, size);
          pageDiv.appendChild(slideDiv);
        });
        container.appendChild(pageDiv);
      }
    }

    function createSlidePreview(idx, borders, grayscale, width) {
      const slide = slides[idx];
      const aspectRatio = 9/16;
      const height = width * aspectRatio;

      const wrapper = document.createElement('div');
      wrapper.style.cssText = `
        width: ${width}px; height: ${height}px; position: relative;
        background: ${slide.background || '#ffffff'};
        ${borders ? 'border: 1px solid #333;' : ''}
        ${grayscale ? 'filter: grayscale(100%);' : ''}
        overflow: hidden; border-radius: 4px;
      `;

      const label = document.createElement('div');
      label.style.cssText = 'position: absolute; bottom: -20px; left: 0; right: 0; text-align: center; font-size: 0.75rem; color: white;';
      label.textContent = `Slide ${idx + 1}`;

      // Render elements scaled
      const scale = width / 960; // Assuming 960px original width
      slide.elements.forEach(el => {
        const elem = document.createElement('div');
        elem.style.cssText = `
          position: absolute;
          left: ${el.x * scale}px;
          top: ${el.y * scale}px;
          width: ${(el.width || 200) * scale}px;
          font-size: ${(parseInt(el.fontSize) || 16) * scale}px;
          color: ${el.color || '#333'};
          font-weight: ${el.bold ? 'bold' : 'normal'};
        `;
        if (el.type === 'text') {
          elem.textContent = el.text;
        } else if (el.type === 'shape') {
          elem.style.background = el.fill || '#e0e0e0';
          elem.style.height = (el.height || 100) * scale + 'px';
          elem.style.borderRadius = el.shape === 'circle' ? '50%' : '4px';
        }
        wrapper.appendChild(elem);
      });

      const container = document.createElement('div');
      container.style.marginBottom = '1.5rem';
      container.appendChild(wrapper);
      container.appendChild(label);
      return container;
    }

    // ========== Export Speaker Notes ==========
    function exportSpeakerNotes() {
      const presentationName = document.getElementById('fileName').value || 'Untitled';
      let content = `Speaker Notes: ${presentationName}\n`;
      content += `${'='.repeat(50)}\n\n`;
      content += `Exported: ${new Date().toLocaleString()}\n`;
      content += `Total Slides: ${slides.length}\n\n`;

      let hasNotes = false;
      slides.forEach((slide, idx) => {
        content += `${'â”€'.repeat(40)}\n`;
        content += `SLIDE ${idx + 1}`;

        // Get slide title from first text element
        const titleEl = slide.elements.find(el => el.type === 'text');
        if (titleEl && titleEl.text) {
          content += `: ${titleEl.text.substring(0, 50)}${titleEl.text.length > 50 ? '...' : ''}`;
        }
        content += `\n${'â”€'.repeat(40)}\n\n`;

        if (slide.speakerNotes && slide.speakerNotes.trim()) {
          content += slide.speakerNotes.trim();
          hasNotes = true;
        } else {
          content += '(No notes for this slide)';
        }
        content += '\n\n';
      });

      if (!hasNotes) {
        content += '\nâš ï¸ This presentation has no speaker notes.\n';
        content += 'Add notes using the Speaker Notes panel at the bottom of the editor.\n';
      }

      // Create and download the file
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${presentationName.replace(/[^a-z0-9]/gi, '_')}_speaker_notes.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Speaker notes exported', 'success');
      toggleFileMenu();
    }

    // ========== Recent Files ==========
    const RECENT_FILES_KEY = 'ninjaslides_recent';
    const MAX_RECENT_FILES = 10;

    function getRecentFiles() {
      try {
        return JSON.parse(localStorage.getItem(RECENT_FILES_KEY)) || [];
      } catch { return []; }
    }

    function addToRecentFiles(docId, name) {
      let recent = getRecentFiles();
      recent = recent.filter(f => f.id !== docId);
      recent.unshift({ id: docId, name: name, timestamp: Date.now() });
      recent = recent.slice(0, MAX_RECENT_FILES);
      localStorage.setItem(RECENT_FILES_KEY, JSON.stringify(recent));
      updateRecentFilesMenu();
    }

    function toggleRecentFiles(event) {
      event.stopPropagation();
      document.getElementById('recentFilesMenu').classList.toggle('show');
    }

    function updateRecentFilesMenu() {
      const menu = document.getElementById('recentFilesMenu');
      const recent = getRecentFiles();
      const docs = getSavedDocs();

      if (recent.length === 0) {
        menu.innerHTML = '<div class="submenu-empty">No recent files</div>';
        return;
      }

      menu.innerHTML = recent
        .filter(f => docs[f.id])
        .map(f => {
          const date = new Date(f.timestamp);
          return `<div class="submenu-item" onclick="openRecentFile('${f.id}')">
            <span>${f.name}</span>
            <span class="file-date">${date.toLocaleDateString()}</span>
          </div>`;
        }).join('');

      if (menu.innerHTML === '') {
        menu.innerHTML = '<div class="submenu-empty">No recent files</div>';
      }
    }

    function openRecentFile(docId) {
      const docs = getSavedDocs();
      if (docs[docId]) {
        slides = JSON.parse(JSON.stringify(docs[docId].slides));
        currentSlideIndex = 0;
        document.getElementById('fileName').value = docs[docId].name;
        currentPresentationId = docId;
        addToRecentFiles(docId, docs[docId].name);
        renderSlideList();
        renderSlide();
        toggleFileMenu();
        showToast('Presentation opened', 'success');
      } else {
        showToast('Presentation not found', 'error');
      }
    }

    // Initialize recent files on load
    document.addEventListener('DOMContentLoaded', updateRecentFilesMenu);
    document.addEventListener('click', () => {
      document.getElementById('recentFilesMenu')?.classList.remove('show');
    });

    // ==================== SCREEN RECORDING ====================
    let screenRecorder = null;
    let recordedChunks = [];
    let recordingStream = null;
    let recordingTimerInterval = null;
    let recordingStartTime = null;
    let recordedVideoBlob = null;

    function showScreenRecording() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        showToast('Screen recording not supported in this browser', 'error');
        return;
      }
      resetRecordingUI();
      document.getElementById('screenRecordingModal').style.display = 'flex';
    }

    function hideScreenRecording() {
      if (screenRecorder && screenRecorder.state === 'recording') {
        stopScreenRecording();
      }
      if (recordingStream) {
        recordingStream.getTracks().forEach(track => track.stop());
        recordingStream = null;
      }
      document.getElementById('screenRecordingModal').style.display = 'none';
      resetRecordingUI();
    }

    function resetRecordingUI() {
      document.getElementById('startRecordingBtn').style.display = 'inline-block';
      document.getElementById('stopRecordingBtn').style.display = 'none';
      document.getElementById('insertRecordingBtn').style.display = 'none';
      document.getElementById('recordingPreview').style.display = 'none';
      document.getElementById('recordingTimer').style.display = 'none';
      document.getElementById('recordingStatus').innerHTML = '<span style="color: var(--secondary);">Click "Start Recording" to begin</span>';
      document.getElementById('recordingStatus').style.display = 'block';
      recordedChunks = [];
      recordedVideoBlob = null;
      if (recordingTimerInterval) {
        clearInterval(recordingTimerInterval);
        recordingTimerInterval = null;
      }
    }

    async function startScreenRecording() {
      try {
        const sourceType = document.getElementById('recordingSource').value;
        const includeAudio = document.getElementById('recordAudio').checked;

        const displayMediaOptions = {
          video: {
            cursor: 'always'
          },
          audio: includeAudio
        };

        // Request screen capture
        recordingStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);

        // Show preview
        const preview = document.getElementById('screenPreview');
        preview.srcObject = recordingStream;
        preview.play();
        document.getElementById('recordingPreview').style.display = 'block';

        // Set up recorder
        const options = { mimeType: 'video/webm;codecs=vp9' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = 'video/webm;codecs=vp8';
          if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = 'video/webm';
          }
        }

        screenRecorder = new MediaRecorder(recordingStream, options);
        recordedChunks = [];

        screenRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };

        screenRecorder.onstop = () => {
          recordedVideoBlob = new Blob(recordedChunks, { type: 'video/webm' });
          const videoUrl = URL.createObjectURL(recordedVideoBlob);

          // Show recorded video in preview
          const preview = document.getElementById('screenPreview');
          preview.srcObject = null;
          preview.src = videoUrl;
          preview.controls = true;
          preview.muted = false;

          // Update UI
          document.getElementById('stopRecordingBtn').style.display = 'none';
          document.getElementById('insertRecordingBtn').style.display = 'inline-block';
          document.getElementById('recordingStatus').innerHTML = '<span style="color: #34a853;">Recording complete! Review and insert your video.</span>';
          document.getElementById('recordingTimer').style.display = 'none';

          if (recordingTimerInterval) {
            clearInterval(recordingTimerInterval);
            recordingTimerInterval = null;
          }
        };

        // Handle stream ending (user clicks stop sharing in browser)
        recordingStream.getVideoTracks()[0].onended = () => {
          if (screenRecorder && screenRecorder.state === 'recording') {
            stopScreenRecording();
          }
        };

        // Start recording
        screenRecorder.start(1000); // Collect data every second
        recordingStartTime = Date.now();

        // Update UI
        document.getElementById('startRecordingBtn').style.display = 'none';
        document.getElementById('stopRecordingBtn').style.display = 'inline-block';
        document.getElementById('recordingStatus').innerHTML = '<span style="color: #ea4335;">ðŸ”´ Recording in progress...</span>';
        document.getElementById('recordingTimer').style.display = 'block';

        // Start timer
        recordingTimerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
          const seconds = (elapsed % 60).toString().padStart(2, '0');
          document.getElementById('recordingTimer').textContent = `${minutes}:${seconds}`;
        }, 1000);

        showToast('Recording started', 'success');

      } catch (err) {
        console.error('Screen recording error:', err);
        if (err.name === 'NotAllowedError') {
          showToast('Screen sharing was cancelled', 'info');
        } else {
          showToast('Failed to start screen recording: ' + err.message, 'error');
        }
        resetRecordingUI();
      }
    }

    function stopScreenRecording() {
      if (screenRecorder && screenRecorder.state === 'recording') {
        screenRecorder.stop();
        showToast('Recording stopped', 'success');
      }

      if (recordingStream) {
        recordingStream.getTracks().forEach(track => track.stop());
      }
    }

    function insertScreenRecording() {
      if (!recordedVideoBlob) {
        showToast('No recording available', 'error');
        return;
      }

      // Convert blob to data URL for embedding
      const reader = new FileReader();
      reader.onloadend = () => {
        const videoDataUrl = reader.result;

        // Add video element to current slide
        const slide = slides[currentSlideIndex];
        const videoElement = {
          type: 'video',
          x: 100,
          y: 100,
          w: 640,
          h: 360,
          src: videoDataUrl,
          isRecording: true,
          autoplay: false,
          loop: false,
          muted: false
        };

        slide.elements.push(videoElement);
        renderSlide();
        hideScreenRecording();
        showToast('Screen recording inserted', 'success');
      };

      reader.readAsDataURL(recordedVideoBlob);
    }

    // ==================== PRESENTATION TIMER ====================
    let presentationTimerInterval = null;
    let timerTotalSeconds = 0;
    let timerCurrentSeconds = 0;
    let timerMode = 'countdown';
    let timerPaused = false;
    let timerWarningShown = false;
    let perSlideSeconds = 60;
    let timerSlideStartTime = 0;

    function showSlideTimer() {
      document.getElementById('slideTimerModal').style.display = 'flex';
      updateTimerMode();
    }

    function hideSlideTimer() {
      document.getElementById('slideTimerModal').style.display = 'none';
    }

    function updateTimerMode() {
      const mode = document.getElementById('timerMode').value;
      document.getElementById('countdownSettings').style.display = (mode === 'countdown' || mode === 'stopwatch') ? 'block' : 'none';
      document.getElementById('perSlideSettings').style.display = mode === 'perSlide' ? 'block' : 'none';

      if (mode === 'stopwatch') {
        document.getElementById('timerHours').value = 0;
        document.getElementById('timerMinutes').value = 0;
        document.getElementById('timerSeconds').value = 0;
      }
    }

    function startSlideTimer() {
      timerMode = document.getElementById('timerMode').value;
      const position = document.getElementById('timerPosition').value;

      // Get total time
      if (timerMode === 'countdown') {
        const hours = parseInt(document.getElementById('timerHours').value) || 0;
        const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
        timerTotalSeconds = hours * 3600 + minutes * 60 + seconds;
        timerCurrentSeconds = timerTotalSeconds;
      } else if (timerMode === 'stopwatch') {
        timerCurrentSeconds = 0;
        timerTotalSeconds = 0;
      } else if (timerMode === 'perSlide') {
        perSlideSeconds = parseInt(document.getElementById('perSlideTime').value) || 60;
        timerCurrentSeconds = perSlideSeconds;
        timerTotalSeconds = perSlideSeconds;
        timerSlideStartTime = Date.now();
      }

      timerPaused = false;
      timerWarningShown = false;

      // Position the timer
      const timer = document.getElementById('presentationTimer');
      const positions = {
        'top-right': { top: '20px', right: '20px', left: 'auto', bottom: 'auto' },
        'top-left': { top: '20px', left: '20px', right: 'auto', bottom: 'auto' },
        'bottom-right': { bottom: '20px', right: '20px', top: 'auto', left: 'auto' },
        'bottom-left': { bottom: '20px', left: '20px', top: 'auto', right: 'auto' },
        'center-top': { top: '20px', left: '50%', right: 'auto', bottom: 'auto', transform: 'translateX(-50%)' }
      };

      const pos = positions[position] || positions['top-right'];
      Object.assign(timer.style, { top: pos.top || 'auto', left: pos.left || 'auto', right: pos.right || 'auto', bottom: pos.bottom || 'auto', transform: pos.transform || 'none' });

      timer.style.display = 'block';
      updateTimerDisplay();

      // Start interval
      if (presentationTimerInterval) clearInterval(presentationTimerInterval);
      presentationTimerInterval = setInterval(tickTimer, 1000);

      hideSlideTimer();
      showToast('Timer started', 'success');

      // Make timer draggable
      makeTimerDraggable();
    }

    function tickTimer() {
      if (timerPaused) return;

      if (timerMode === 'countdown' || timerMode === 'perSlide') {
        timerCurrentSeconds--;

        // Check warning
        if (timerMode === 'countdown' && document.getElementById('timerWarning').checked && !timerWarningShown) {
          const warningMin = parseInt(document.getElementById('warningMinutes').value) || 2;
          if (timerCurrentSeconds <= warningMin * 60) {
            document.getElementById('presentationTimer').style.background = 'rgba(255, 152, 0, 0.9)';
            timerWarningShown = true;
          }
        }

        if (timerCurrentSeconds <= 0) {
          timerCurrentSeconds = 0;
          document.getElementById('presentationTimer').style.background = 'rgba(234, 67, 53, 0.9)';

          if (document.getElementById('timerSound').checked) {
            playTimerSound();
          }

          if (timerMode === 'perSlide' && document.getElementById('autoAdvance').checked) {
            // Auto advance to next slide
            if (currentSlideIndex < slides.length - 1) {
              currentSlideIndex++;
              renderSlideList();
              renderSlide();
              timerCurrentSeconds = perSlideSeconds;
              document.getElementById('presentationTimer').style.background = 'rgba(0,0,0,0.8)';
            } else {
              clearInterval(presentationTimerInterval);
            }
          } else if (timerMode === 'countdown') {
            clearInterval(presentationTimerInterval);
          }
        }
      } else {
        // Stopwatch mode
        timerCurrentSeconds++;
      }

      updateTimerDisplay();
    }

    function updateTimerDisplay() {
      const hours = Math.floor(timerCurrentSeconds / 3600);
      const minutes = Math.floor((timerCurrentSeconds % 3600) / 60);
      const seconds = timerCurrentSeconds % 60;

      const display = hours > 0
        ? `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
        : `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      document.getElementById('timerDisplay').textContent = display;
    }

    function pauseResumeTimer() {
      timerPaused = !timerPaused;
      document.getElementById('timerPauseBtn').textContent = timerPaused ? 'â–¶' : 'â¸';
    }

    function stopPresentationTimer() {
      if (presentationTimerInterval) {
        clearInterval(presentationTimerInterval);
        presentationTimerInterval = null;
      }
      document.getElementById('presentationTimer').style.display = 'none';
      showToast('Timer stopped', 'info');
    }

    function playTimerSound() {
      // Create a simple beep using Web Audio API
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.value = 0.3;

      oscillator.start();
      setTimeout(() => {
        oscillator.stop();
        audioCtx.close();
      }, 500);
    }

    function makeTimerDraggable() {
      const timer = document.getElementById('presentationTimer');
      let isDragging = false;
      let offsetX, offsetY;

      timer.onmousedown = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        isDragging = true;
        offsetX = e.clientX - timer.getBoundingClientRect().left;
        offsetY = e.clientY - timer.getBoundingClientRect().top;
        timer.style.transform = 'none';
      };

      document.onmousemove = (e) => {
        if (!isDragging) return;
        timer.style.left = (e.clientX - offsetX) + 'px';
        timer.style.top = (e.clientY - offsetY) + 'px';
        timer.style.right = 'auto';
        timer.style.bottom = 'auto';
      };

      document.onmouseup = () => {
        isDragging = false;
      };
    }

    // ========== Handout Master ==========
    let handoutSettings = {
      orientation: 'portrait',
      slidesPerPage: 3,
      showHeader: true,
      showFooter: true,
      showDate: true,
      showPageNum: true,
      showNotes: false,
      headerText: '',
      footerText: '',
      bgColor: '#ffffff'
    };

    function showHandoutMaster() {
      const modal = document.getElementById('handoutMasterModal');
      modal.classList.add('active');

      // Load current settings into form
      document.getElementById('handoutOrientation').value = handoutSettings.orientation;
      document.getElementById('handoutSlidesPerPage').value = handoutSettings.slidesPerPage;
      document.getElementById('handoutShowHeader').checked = handoutSettings.showHeader;
      document.getElementById('handoutShowFooter').checked = handoutSettings.showFooter;
      document.getElementById('handoutShowDate').checked = handoutSettings.showDate;
      document.getElementById('handoutShowPageNum').checked = handoutSettings.showPageNum;
      document.getElementById('handoutShowNotes').checked = handoutSettings.showNotes;
      document.getElementById('handoutHeaderText').value = handoutSettings.headerText;
      document.getElementById('handoutFooterText').value = handoutSettings.footerText;
      document.getElementById('handoutBgColor').value = handoutSettings.bgColor;

      updateHandoutPreview();
    }

    function hideHandoutMaster() {
      document.getElementById('handoutMasterModal').classList.remove('active');
    }

    function updateHandoutPreview() {
      const preview = document.getElementById('handoutPreview');
      const orientation = document.getElementById('handoutOrientation').value;
      const slidesPerPage = parseInt(document.getElementById('handoutSlidesPerPage').value);
      const showHeader = document.getElementById('handoutShowHeader').checked;
      const showFooter = document.getElementById('handoutShowFooter').checked;
      const showDate = document.getElementById('handoutShowDate').checked;
      const showPageNum = document.getElementById('handoutShowPageNum').checked;
      const showNotes = document.getElementById('handoutShowNotes').checked;
      const headerText = document.getElementById('handoutHeaderText').value || presentationName;
      const footerText = document.getElementById('handoutFooterText').value || '';
      const bgColor = document.getElementById('handoutBgColor').value;

      // Set preview size based on orientation
      if (orientation === 'portrait') {
        preview.style.width = '350px';
        preview.style.minHeight = '450px';
      } else {
        preview.style.width = '450px';
        preview.style.minHeight = '300px';
      }

      preview.style.background = bgColor;

      // Calculate grid layout for slides
      let cols = 1, rows = slidesPerPage;
      if (slidesPerPage === 2) { cols = 1; rows = 2; }
      else if (slidesPerPage === 3) { cols = 1; rows = 3; }
      else if (slidesPerPage === 4) { cols = 2; rows = 2; }
      else if (slidesPerPage === 6) { cols = 2; rows = 3; }
      else if (slidesPerPage === 9) { cols = 3; rows = 3; }

      // Generate preview HTML
      let html = '';

      // Header
      if (showHeader || showDate) {
        html += '<div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 10px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px;">';
        html += showHeader ? `<span>${headerText}</span>` : '<span></span>';
        html += showDate ? `<span>${new Date().toLocaleDateString()}</span>` : '';
        html += '</div>';
      }

      // Slides grid
      const slideWidth = orientation === 'portrait' ?
        (cols === 1 ? '150px' : cols === 2 ? '120px' : '80px') :
        (cols === 1 ? '180px' : cols === 2 ? '140px' : '100px');

      html += `<div style="display: grid; grid-template-columns: repeat(${cols}, 1fr); gap: ${showNotes ? '5px' : '10px'}; margin-bottom: 15px;">`;

      for (let i = 0; i < Math.min(slidesPerPage, slides.length); i++) {
        const slide = slides[i] || { background: '#ffffff' };
        html += `
          <div style="display: flex; ${showNotes && cols === 1 ? 'gap: 10px;' : 'flex-direction: column;'}">
            <div style="background: ${slide.background || '#ffffff'}; border: 1px solid #ccc; aspect-ratio: 16/9; width: ${slideWidth}; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #999; flex-shrink: 0;">
              Slide ${i + 1}
            </div>
            ${showNotes && cols === 1 ? '<div style="flex: 1; border-bottom: 1px solid #ddd; height: 20px;"></div>' : ''}
          </div>
        `;

        // Notes lines for multi-column layouts
        if (showNotes && cols > 1) {
          html += `<div style="display: flex; flex-direction: column; gap: 3px; margin-top: 5px; grid-column: span ${cols};">`;
          for (let j = 0; j < 2; j++) {
            html += '<div style="border-bottom: 1px solid #ddd; height: 12px;"></div>';
          }
          html += '</div>';
        }
      }
      html += '</div>';

      // Footer
      if (showFooter || showPageNum) {
        html += '<div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; border-top: 1px solid #eee; padding-top: 5px; position: absolute; bottom: 20px; left: 20px; right: 20px;">';
        html += showFooter ? `<span>${footerText || 'Footer'}</span>` : '<span></span>';
        html += showPageNum ? '<span>Page 1</span>' : '';
        html += '</div>';
      }

      preview.innerHTML = html;
    }

    function resetHandoutDefaults() {
      document.getElementById('handoutOrientation').value = 'portrait';
      document.getElementById('handoutSlidesPerPage').value = '3';
      document.getElementById('handoutShowHeader').checked = true;
      document.getElementById('handoutShowFooter').checked = true;
      document.getElementById('handoutShowDate').checked = true;
      document.getElementById('handoutShowPageNum').checked = true;
      document.getElementById('handoutShowNotes').checked = false;
      document.getElementById('handoutHeaderText').value = '';
      document.getElementById('handoutFooterText').value = '';
      document.getElementById('handoutBgColor').value = '#ffffff';

      updateHandoutPreview();
      showToast('Reset to default settings', 'info');
    }

    function applyHandoutMaster() {
      // Save settings
      handoutSettings = {
        orientation: document.getElementById('handoutOrientation').value,
        slidesPerPage: parseInt(document.getElementById('handoutSlidesPerPage').value),
        showHeader: document.getElementById('handoutShowHeader').checked,
        showFooter: document.getElementById('handoutShowFooter').checked,
        showDate: document.getElementById('handoutShowDate').checked,
        showPageNum: document.getElementById('handoutShowPageNum').checked,
        showNotes: document.getElementById('handoutShowNotes').checked,
        headerText: document.getElementById('handoutHeaderText').value,
        footerText: document.getElementById('handoutFooterText').value,
        bgColor: document.getElementById('handoutBgColor').value
      };

      // Update print layout selector if it exists
      const printLayout = document.getElementById('printLayout');
      if (printLayout) {
        printLayout.value = `handouts${handoutSettings.slidesPerPage}`;
      }

      hideHandoutMaster();
      showToast('Handout master settings applied', 'success');
    }

    // ==================== ACCESSIBILITY CHECKER ====================
    function showAccessibilityChecker() {
      document.getElementById('accessibilityModal').classList.add('active');
      clearAccessibilityResults();
    }

    function hideAccessibilityChecker() {
      document.getElementById('accessibilityModal').classList.remove('active');
    }

    function clearAccessibilityResults() {
      document.getElementById('accessibilityErrors').style.display = 'none';
      document.getElementById('accessibilityWarnings').style.display = 'none';
      document.getElementById('accessibilityTips').style.display = 'none';
      document.getElementById('accessibilitySuccess').style.display = 'none';
      document.getElementById('accessibilityEmpty').style.display = 'block';
      document.getElementById('accessibilityErrorList').innerHTML = '';
      document.getElementById('accessibilityWarningList').innerHTML = '';
      document.getElementById('accessibilityTipList').innerHTML = '';
    }

    function checkCurrentSlide() {
      checkAccessibility([currentSlideIndex]);
    }

    function runAccessibilityCheck() {
      const slideIndices = slides.map((_, i) => i);
      checkAccessibility(slideIndices);
    }

    function checkAccessibility(slideIndices) {
      const errors = [];
      const warnings = [];
      const tips = [];

      slideIndices.forEach(slideIndex => {
        const slide = slides[slideIndex];
        const slideNum = slideIndex + 1;

        // Check for images without alt text
        slide.elements.forEach((element, elemIndex) => {
          if (element.type === 'image') {
            if (!element.alt || element.alt.trim() === '') {
              errors.push({
                type: 'Missing Alt Text',
                description: `Slide ${slideNum}: Image ${elemIndex + 1} is missing alternative text.`,
                slideIndex: slideIndex,
                elementId: element.id,
                fix: 'addAltText'
              });
            } else if (element.alt.toLowerCase() === 'image' || element.alt.toLowerCase() === 'picture') {
              warnings.push({
                type: 'Generic Alt Text',
                description: `Slide ${slideNum}: Image has generic alt text ("${element.alt}").`,
                slideIndex: slideIndex,
                elementId: element.id
              });
            }
          }

          // Check for text elements with very small font
          if (element.type === 'text' && element.content) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = element.content;
            const textContent = tempDiv.textContent.trim();

            // Check font size from content (basic check)
            const fontSizeMatch = element.content.match(/font-size:\s*(\d+)/);
            if (fontSizeMatch && parseInt(fontSizeMatch[1]) < 14) {
              warnings.push({
                type: 'Small Font Size',
                description: `Slide ${slideNum}: Text may be too small (${fontSizeMatch[1]}px) for readability.`,
                slideIndex: slideIndex,
                elementId: element.id
              });
            }

            // Check for empty text boxes
            if (!textContent) {
              tips.push({
                type: 'Empty Text Box',
                description: `Slide ${slideNum}: Empty text box found. Consider removing or adding content.`,
                slideIndex: slideIndex,
                elementId: element.id
              });
            }
          }

          // Check for tables without headers (if table type exists)
          if (element.type === 'table' && element.data) {
            if (!element.hasHeaders) {
              warnings.push({
                type: 'Table Without Headers',
                description: `Slide ${slideNum}: Table doesn't have designated header row.`,
                slideIndex: slideIndex,
                elementId: element.id
              });
            }
          }
        });

        // Check for slide without title
        const hasTitle = slide.elements.some(el =>
          el.type === 'text' &&
          (el.content.includes('<h1') || el.content.includes('<h2') || el.isTitle)
        );
        if (!hasTitle && slide.elements.length > 0) {
          warnings.push({
            type: 'Missing Slide Title',
            description: `Slide ${slideNum}: No title found. Screen readers use titles for navigation.`,
            slideIndex: slideIndex
          });
        }

        // Check slide reading order (basic check)
        if (slide.elements.length > 3) {
          tips.push({
            type: 'Check Reading Order',
            description: `Slide ${slideNum}: Has ${slide.elements.length} elements. Verify reading order for screen readers.`,
            slideIndex: slideIndex
          });
        }

        // Check for videos without captions
        slide.elements.forEach((element, elemIndex) => {
          if (element.type === 'video' && !element.hasCaptions) {
            warnings.push({
              type: 'Video Without Captions',
              description: `Slide ${slideNum}: Video may need captions for deaf/hard of hearing users.`,
              slideIndex: slideIndex,
              elementId: element.id
            });
          }
        });

        // Check for low contrast background + text combinations
        const bgColor = slide.background;
        if (bgColor) {
          const isDarkBg = bgColor.includes('#000') || bgColor.includes('rgb(0') ||
                          bgColor.includes('dark') || bgColor.includes('#1') ||
                          bgColor.includes('#2') || bgColor.includes('#3');
          slide.elements.forEach((element) => {
            if (element.type === 'text' && element.content) {
              const hasLightText = element.content.includes('color: white') ||
                                  element.content.includes('color: #fff') ||
                                  element.content.includes('color:#fff');
              const hasDarkText = element.content.includes('color: black') ||
                                 element.content.includes('color: #000') ||
                                 element.content.includes('color:#000');

              if (isDarkBg && hasDarkText) {
                warnings.push({
                  type: 'Low Contrast',
                  description: `Slide ${slideNum}: Dark text on dark background may be hard to read.`,
                  slideIndex: slideIndex,
                  elementId: element.id
                });
              }
            }
          });
        }
      });

      // Check for too many slides without breaks
      if (slideIndices.length > 20) {
        tips.push({
          type: 'Long Presentation',
          description: `Presentation has ${slides.length} slides. Consider adding section breaks.`,
          slideIndex: 0
        });
      }

      // Display results
      displayAccessibilityResults(errors, warnings, tips);
    }

    function displayAccessibilityResults(errors, warnings, tips) {
      document.getElementById('accessibilityEmpty').style.display = 'none';

      if (errors.length === 0 && warnings.length === 0 && tips.length === 0) {
        document.getElementById('accessibilitySuccess').style.display = 'block';
        showToast('No accessibility issues found!', 'success');
        return;
      }

      window.accessibilityErrors = errors;
      window.accessibilityWarnings = warnings;
      window.accessibilityTips = tips;

      // Display errors
      if (errors.length > 0) {
        document.getElementById('accessibilityErrors').style.display = 'block';
        document.getElementById('accessibilityErrorList').innerHTML = errors.map((e, i) => `
          <div style="padding: 0.75rem; border-bottom: 1px solid #fce8e6; cursor: pointer;" onclick="goToAccessibilityIssue(${e.slideIndex}, '${e.elementId || ''}')">
            <strong style="color: #d93025;">${e.type}</strong>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">${e.description}</p>
            ${e.fix === 'addAltText' ? `<button class="btn btn-sm btn-secondary" style="margin-top: 0.5rem;" onclick="event.stopPropagation(); promptImageAltText('${e.elementId}', ${e.slideIndex})">Add Alt Text</button>` : ''}
          </div>
        `).join('');
      }

      // Display warnings
      if (warnings.length > 0) {
        document.getElementById('accessibilityWarnings').style.display = 'block';
        document.getElementById('accessibilityWarningList').innerHTML = warnings.map((w, i) => `
          <div style="padding: 0.75rem; border-bottom: 1px solid #fef3e0; cursor: pointer;" onclick="goToAccessibilityIssue(${w.slideIndex}, '${w.elementId || ''}')">
            <strong style="color: #f9ab00;">${w.type}</strong>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">${w.description}</p>
          </div>
        `).join('');
      }

      // Display tips
      if (tips.length > 0) {
        document.getElementById('accessibilityTips').style.display = 'block';
        document.getElementById('accessibilityTipList').innerHTML = tips.map((t, i) => `
          <div style="padding: 0.75rem; border-bottom: 1px solid #e8f0fe; cursor: pointer;" onclick="goToAccessibilityIssue(${t.slideIndex}, '${t.elementId || ''}')">
            <strong style="color: #1a73e8;">${t.type}</strong>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">${t.description}</p>
          </div>
        `).join('');
      }

      showToast(`Found ${errors.length} errors, ${warnings.length} warnings, ${tips.length} tips`, errors.length > 0 ? 'error' : 'info');
    }

    function goToAccessibilityIssue(slideIndex, elementId) {
      goToSlide(slideIndex);

      if (elementId) {
        // Highlight the element
        setTimeout(() => {
          const element = document.getElementById(elementId);
          if (element) {
            element.style.outline = '3px solid #d93025';
            element.style.outlineOffset = '2px';
            setTimeout(() => {
              element.style.outline = '';
              element.style.outlineOffset = '';
            }, 3000);
          }
        }, 100);
      }
    }

    function promptImageAltText(elementId, slideIndex) {
      const slide = slides[slideIndex];
      const element = slide.elements.find(el => el.id === elementId);

      if (element) {
        const altText = prompt('Enter alternative text for this image:', element.alt || '');
        if (altText !== null) {
          element.alt = altText;
          saveToHistory();
          showToast('Alt text added successfully', 'success');
          // Re-check current slide
          checkAccessibility([slideIndex]);
        }
      }
    }

    // ==================== DICTATION / VOICE INPUT ====================
    let recognition = null;
    let isDictating = false;

    function toggleDictation() {
      if (isDictating) {
        stopDictation();
      } else {
        startDictation();
      }
    }

    function startDictation() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showToast('Speech recognition not supported in this browser. Try Chrome or Edge.', 'error');
        return;
      }

      // Check if a text element is selected
      if (!selectedElement || selectedElement.type !== 'text') {
        showToast('Please select a text box first, or create one to dictate into.', 'warning');
        return;
      }

      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onstart = () => {
        isDictating = true;
        const btn = document.getElementById('dictationBtn');
        btn.style.background = '#d93025';
        btn.style.color = 'white';
        btn.innerHTML = 'ðŸŽ¤ Stop';
        showToast('Dictation started. Speak now...', 'info');
      };

      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            // Process voice commands
            let processedText = processVoiceCommands(transcript);

            if (processedText !== null && selectedElement) {
              // Append to the selected text element
              const currentContent = selectedElement.content || '';
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = currentContent;
              const textContent = tempDiv.textContent || '';

              selectedElement.content = currentContent + processedText + ' ';
              renderCurrentSlide();
              saveToHistory();
            }
          }
        }
      };

      recognition.onerror = (event) => {
        if (event.error === 'not-allowed') {
          showToast('Microphone access denied. Please allow microphone access.', 'error');
        } else if (event.error !== 'no-speech') {
          showToast(`Dictation error: ${event.error}`, 'error');
        }
        stopDictation();
      };

      recognition.onend = () => {
        if (isDictating) {
          try {
            recognition.start();
          } catch (e) {
            stopDictation();
          }
        }
      };

      try {
        recognition.start();
      } catch (e) {
        showToast('Could not start dictation. Please try again.', 'error');
      }
    }

    function stopDictation() {
      isDictating = false;
      if (recognition) {
        recognition.stop();
        recognition = null;
      }

      const btn = document.getElementById('dictationBtn');
      btn.style.background = '';
      btn.style.color = '';
      btn.innerHTML = 'ðŸŽ¤ Dictate';
      showToast('Dictation stopped', 'info');
    }

    function processVoiceCommands(text) {
      const lowerText = text.toLowerCase().trim();

      // Punctuation commands
      if (lowerText === 'period' || lowerText === 'full stop') return '.';
      if (lowerText === 'comma') return ',';
      if (lowerText === 'question mark') return '?';
      if (lowerText === 'exclamation mark' || lowerText === 'exclamation point') return '!';
      if (lowerText === 'colon') return ':';
      if (lowerText === 'semicolon') return ';';
      if (lowerText === 'new line' || lowerText === 'newline') return '<br>';
      if (lowerText === 'new paragraph') return '<br><br>';

      return text;
    }

    // ==================== STOCK IMAGES ====================
    let selectedStockImage = null;

    function showStockImages() {
      document.getElementById('stockImagesModal').classList.add('active');
      document.getElementById('stockImageSearch').value = '';
      document.getElementById('stockImagesGrid').innerHTML = `
        <div style="grid-column: span 4; text-align: center; padding: 2rem; color: #666;">
          <div style="font-size: 36px;">ðŸ–¼ï¸</div>
          <p>Search for images or click a category</p>
        </div>
      `;
      document.getElementById('stockImagePreview').style.display = 'none';
      document.getElementById('insertStockBtn').disabled = true;
      selectedStockImage = null;
    }

    function hideStockImages() {
      document.getElementById('stockImagesModal').classList.remove('active');
    }

    function searchStockCategory(category) {
      document.getElementById('stockImageSearch').value = category;
      searchStockImages();
    }

    async function searchStockImages() {
      const query = document.getElementById('stockImageSearch').value.trim();
      if (!query) {
        showToast('Please enter a search term', 'warning');
        return;
      }

      const grid = document.getElementById('stockImagesGrid');
      grid.innerHTML = `<div style="grid-column: span 4; text-align: center; padding: 2rem;">â³ Searching...</div>`;

      // Generate images using Lorem Picsum
      const images = [];
      const seedBase = query.split('').reduce((a, b) => a + b.charCodeAt(0), 0);

      for (let i = 0; i < 16; i++) {
        const seed = seedBase + i;
        images.push({
          id: `img-${seed}`,
          thumb: `https://picsum.photos/seed/${seed}/150/150`,
          small: `https://picsum.photos/seed/${seed}/300/200`,
          medium: `https://picsum.photos/seed/${seed}/600/400`,
          large: `https://picsum.photos/seed/${seed}/1200/800`,
          alt: `${query} image ${i + 1}`,
          credit: `Photo from Lorem Picsum`
        });
      }

      await new Promise(r => setTimeout(r, 300));

      grid.innerHTML = images.map((img, i) => `
        <div class="stock-thumb" onclick="selectStockImage(${i})" style="cursor: pointer; border-radius: 4px; overflow: hidden; aspect-ratio: 1; border: 2px solid transparent;" data-index="${i}">
          <img src="${img.thumb}" alt="${img.alt}" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
      `).join('');

      window.stockImageResults = images;
    }

    function selectStockImage(index) {
      selectedStockImage = window.stockImageResults[index];

      document.querySelectorAll('.stock-thumb').forEach(el => el.style.border = '2px solid transparent');
      document.querySelector(`.stock-thumb[data-index="${index}"]`).style.border = '2px solid #1a73e8';

      document.getElementById('stockImagePreview').style.display = 'block';
      document.getElementById('stockPreviewImg').src = selectedStockImage.medium;
      document.getElementById('stockImageCredit').textContent = selectedStockImage.credit;
      document.getElementById('insertStockBtn').disabled = false;
    }

    function insertStockImage() {
      if (!selectedStockImage) return;

      const size = document.getElementById('stockImageSize').value;
      const urls = { small: selectedStockImage.small, medium: selectedStockImage.medium, large: selectedStockImage.large };
      const imageUrl = urls[size] || selectedStockImage.medium;

      // Add image element to current slide
      const element = {
        id: 'element-' + (++elementIdCounter),
        type: 'image',
        x: 100,
        y: 100,
        width: size === 'small' ? 200 : size === 'large' ? 500 : 350,
        height: size === 'small' ? 133 : size === 'large' ? 333 : 233,
        src: imageUrl,
        alt: selectedStockImage.alt
      };

      slides[currentSlideIndex].elements.push(element);
      saveToHistory();
      renderCurrentSlide();
      hideStockImages();
      showToast('Image added to slide', 'success');
    }

    // ========== QR Code Generator ==========
    let currentQRType = 'url';
    let currentQRData = null;

    function showQRCodeGenerator() {
      document.getElementById('qrCodeModal').classList.add('active');
      selectQRType('url');
    }

    function hideQRCodeGenerator() {
      document.getElementById('qrCodeModal').classList.remove('active');
      currentQRData = null;
    }

    function selectQRType(type) {
      currentQRType = type;

      document.querySelectorAll('.qr-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });

      const panels = ['url', 'text', 'email', 'phone', 'wifi'];
      panels.forEach(panel => {
        const el = document.getElementById(`qr${panel.charAt(0).toUpperCase() + panel.slice(1)}Panel`);
        if (el) el.style.display = (panel === type) ? 'block' : 'none';
      });

      generateQRPreview();
    }

    function getQRContent() {
      switch (currentQRType) {
        case 'url':
          return document.getElementById('qrUrl').value.trim();
        case 'text':
          return document.getElementById('qrText').value.trim();
        case 'email':
          const email = document.getElementById('qrEmail').value.trim();
          return email ? `mailto:${email}` : '';
        case 'phone':
          const phone = document.getElementById('qrPhone').value.trim();
          return phone ? `tel:${phone}` : '';
        case 'wifi':
          const ssid = document.getElementById('qrWifiSsid').value.trim();
          const password = document.getElementById('qrWifiPassword').value;
          const security = document.getElementById('qrWifiSecurity').value;
          if (!ssid) return '';
          return `WIFI:T:${security};S:${ssid};P:${password};;`;
        default:
          return '';
      }
    }

    function generateQRPreview() {
      const content = getQRContent();
      const size = parseInt(document.getElementById('qrSize').value);
      const preview = document.getElementById('qrPreview');

      if (!content) {
        preview.innerHTML = '<span style="color: #999;">Enter content to generate QR code</span>';
        currentQRData = null;
        return;
      }

      const qrSvg = generateQRSVG(content, size);
      preview.innerHTML = qrSvg;
      currentQRData = { content, size };
    }

    function generateQRSVG(data, size) {
      const modules = 25;
      const hash = simpleHash(data);
      const bits = [];

      for (let i = 0; i < modules * modules; i++) {
        bits.push(((hash * (i + 1) * 31) % 100) > 50);
      }

      const addFinderPattern = (startRow, startCol) => {
        for (let r = 0; r < 7; r++) {
          for (let c = 0; c < 7; c++) {
            const idx = (startRow + r) * modules + (startCol + c);
            if (r === 0 || r === 6 || c === 0 || c === 6) {
              bits[idx] = true;
            } else if (r >= 1 && r <= 5 && c >= 1 && c <= 5) {
              bits[idx] = false;
            }
            if (r >= 2 && r <= 4 && c >= 2 && c <= 4) {
              bits[idx] = true;
            }
          }
        }
      };

      addFinderPattern(0, 0);
      addFinderPattern(0, modules - 7);
      addFinderPattern(modules - 7, 0);

      for (let i = 8; i < modules - 8; i++) {
        bits[6 * modules + i] = i % 2 === 0;
        bits[i * modules + 6] = i % 2 === 0;
      }

      let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${modules} ${modules}">`;
      svg += `<rect width="${modules}" height="${modules}" fill="white"/>`;

      for (let row = 0; row < modules; row++) {
        for (let col = 0; col < modules; col++) {
          if (bits[row * modules + col]) {
            svg += `<rect x="${col}" y="${row}" width="1" height="1" fill="black"/>`;
          }
        }
      }

      svg += '</svg>';
      return svg;
    }

    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    }

    function insertQRCode() {
      if (!currentQRData) {
        showToast('Please enter content to generate a QR code', 'warning');
        return;
      }

      const preview = document.getElementById('qrPreview');
      const svg = preview.querySelector('svg');

      if (!svg) {
        showToast('No QR code generated', 'error');
        return;
      }

      // Convert SVG to data URL
      const svgData = new XMLSerializer().serializeToString(svg);
      const svgBase64 = btoa(unescape(encodeURIComponent(svgData)));
      const dataUrl = `data:image/svg+xml;base64,${svgBase64}`;

      // Add QR code as image element to current slide
      const element = {
        id: 'element-' + (++elementIdCounter),
        type: 'image',
        x: 500,
        y: 300,
        width: currentQRData.size,
        height: currentQRData.size,
        src: dataUrl,
        alt: `QR Code: ${currentQRType}`
      };

      slides[currentSlideIndex].elements.push(element);
      saveToHistory();
      renderCurrentSlide();
      hideQRCodeGenerator();
      showToast('QR Code added to slide', 'success');
    }

    // ========== Auto-Save & Version History ==========
    // autoSaveEnabled defined in AUTO-SAVE section below
    let autoSaveIntervalMs = 60000;  // Milliseconds between auto-saves
    let autoSaveTimer = null;
    let versionHistory = [];
    const VERSION_STORAGE_KEY = 'ninjaslides_versions';
    const MAX_VERSIONS = 15;

    (function initAutoSave() {
      const saved = localStorage.getItem(VERSION_STORAGE_KEY);
      if (saved) {
        try { versionHistory = JSON.parse(saved); } catch(e) { versionHistory = []; }
      }
      if (localStorage.getItem('ninjaslides_autosave') === 'true') {
        autoSaveEnabled = true;
        startAutoSave();
        setTimeout(updateAutoSaveUI, 100);
      }
    })();

    function toggleAutoSave() {
      autoSaveEnabled = !autoSaveEnabled;
      localStorage.setItem('ninjaslides_autosave', autoSaveEnabled);
      if (autoSaveEnabled) {
        startAutoSave();
        showToast('Auto-Save enabled', 'success');
      } else {
        stopAutoSave();
        showToast('Auto-Save disabled', 'info');
      }
      updateAutoSaveUI();
    }

    function toggleAutoSaveFromModal() {
      autoSaveEnabled = document.getElementById('autoSaveCheckbox').checked;
      localStorage.setItem('ninjaslides_autosave', autoSaveEnabled);
      if (autoSaveEnabled) startAutoSave(); else stopAutoSave();
      updateAutoSaveUI();
    }

    function updateAutoSaveUI() {
      const btn = document.getElementById('autoSaveBtn');
      const status = document.getElementById('autoSaveStatus');
      const checkbox = document.getElementById('autoSaveCheckbox');
      if (btn) {
        btn.innerHTML = autoSaveEnabled ? 'ðŸ’¾ Auto-Save: On' : 'ðŸ’¾ Auto-Save: Off';
        btn.style.background = autoSaveEnabled ? '#e8f5e9' : '';
        btn.style.color = autoSaveEnabled ? '#2e7d32' : '';
      }
      if (status) {
        status.textContent = autoSaveEnabled ? 'Enabled' : 'Disabled';
        status.style.color = autoSaveEnabled ? '#2e7d32' : '#d93025';
      }
      if (checkbox) checkbox.checked = autoSaveEnabled;
    }

    function startAutoSave() {
      stopAutoSave();
      autoSaveTimer = setInterval(() => savePresentationVersion('auto'), autoSaveIntervalMs);
    }

    function stopAutoSave() {
      if (autoSaveTimer) { clearInterval(autoSaveTimer); autoSaveTimer = null; }
    }

    function updateAutoSaveInterval() {
      autoSaveIntervalMs = parseInt(document.getElementById('autoSaveInterval').value);
      if (autoSaveEnabled) startAutoSave();
    }

    function savePresentationVersion(type = 'manual') {
      if (slides.length === 0) return;

      const snapshot = JSON.stringify(slides);
      if (versionHistory.length > 0 && JSON.stringify(versionHistory[0].slides) === snapshot) return;

      versionHistory.unshift({
        id: Date.now(),
        timestamp: new Date().toISOString(),
        type,
        slides: JSON.parse(snapshot),
        slideCount: slides.length
      });

      if (versionHistory.length > MAX_VERSIONS) versionHistory = versionHistory.slice(0, MAX_VERSIONS);
      localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versionHistory));

      if (type === 'auto') {
        const btn = document.getElementById('autoSaveBtn');
        if (btn) {
          const orig = btn.innerHTML;
          btn.innerHTML = 'ðŸ’¾ Saved!';
          setTimeout(() => btn.innerHTML = orig, 1500);
        }
      }
    }

    function createManualVersion() {
      savePresentationVersion('manual');
      showToast('Version saved', 'success');
      renderVersionList();
    }

    function showVersionHistory() {
      document.getElementById('versionHistoryModal').classList.add('active');
      updateAutoSaveUI();
      renderVersionList();
    }

    function hideVersionHistory() {
      document.getElementById('versionHistoryModal').classList.remove('active');
    }

    function renderVersionList() {
      const container = document.getElementById('versionList');
      if (versionHistory.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No versions saved yet</div>';
        return;
      }
      container.innerHTML = versionHistory.map((v, i) => `
        <div style="padding: 0.5rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; ${i === 0 ? 'background: #e8f5e9;' : ''}">
          <div>
            <div style="font-weight: ${i === 0 ? '600' : '400'};">${v.type === 'auto' ? 'ðŸ”„' : 'ðŸ“¸'} ${i === 0 ? '(Current)' : ''}</div>
            <div style="font-size: 0.8rem; color: #666;">${new Date(v.timestamp).toLocaleString()} Â· ${v.slideCount} slides</div>
          </div>
          <div style="display: flex; gap: 0.25rem;">
            <button class="btn btn-sm btn-secondary" onclick="restorePresentationVersion(${i})" title="Restore">â†©</button>
            <button class="btn btn-sm btn-secondary" onclick="deletePresentationVersion(${i})" title="Delete" style="color: #d93025;">ðŸ—‘</button>
          </div>
        </div>
      `).join('');
    }

    function restorePresentationVersion(index) {
      const v = versionHistory[index];
      if (!v || !confirm('Restore this version?')) return;
      savePresentationVersion('manual');
      slides = JSON.parse(JSON.stringify(v.slides));
      currentSlideIndex = 0;
      renderSlideThumbnails();
      renderCurrentSlide();
      showToast('Version restored', 'success');
      hideVersionHistory();
    }

    function deletePresentationVersion(index) {
      if (!confirm('Delete this version?')) return;
      versionHistory.splice(index, 1);
      localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versionHistory));
      renderVersionList();
    }

    function clearVersionHistory() {
      if (!confirm('Clear all version history?')) return;
      versionHistory = [];
      localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versionHistory));
      renderVersionList();
      showToast('History cleared', 'info');
    }

    window.addEventListener('beforeunload', () => { if (autoSaveEnabled) savePresentationVersion('auto'); });

    // ========== Recent Presentations ==========
    const RECENT_PRESENTATIONS_KEY = 'ninjaslides_recent_presentations';
    let recentPresentations = [];

    function loadRecentPresentations() {
      try {
        const stored = localStorage.getItem(RECENT_PRESENTATIONS_KEY);
        recentPresentations = stored ? JSON.parse(stored) : [];
      } catch (e) {
        recentPresentations = [];
      }
    }

    function addToRecentPresentations(name) {
      const presentation = {
        id: Date.now(),
        name: name || document.getElementById('fileName').value || 'Untitled Presentation',
        slides: JSON.parse(JSON.stringify(slides)),
        currentSlideIndex: currentSlideIndex,
        timestamp: new Date().toISOString(),
        slideCount: slides.length,
        preview: slides[0] ? generateSlidePreviewText(slides[0]) : 'Empty presentation'
      };

      // Remove duplicate if exists
      recentPresentations = recentPresentations.filter(p => p.name !== presentation.name);
      recentPresentations.unshift(presentation);

      // Keep max 20 entries
      if (recentPresentations.length > 20) {
        recentPresentations = recentPresentations.slice(0, 20);
      }

      localStorage.setItem(RECENT_PRESENTATIONS_KEY, JSON.stringify(recentPresentations));
    }

    function generateSlidePreviewText(slide) {
      if (!slide || !slide.elements) return 'Empty slide';
      const textElements = slide.elements.filter(e => e.type === 'text');
      if (textElements.length === 0) return 'No text content';
      const firstText = textElements[0].content || '';
      const cleanText = firstText.replace(/<[^>]*>/g, '').trim();
      return cleanText.substring(0, 100) || 'No text content';
    }

    function showRecentPresentations() {
      loadRecentPresentations();
      renderRecentPresentations();
      document.getElementById('recentPresentationsModal').classList.add('active');
    }

    function hideRecentPresentations() {
      document.getElementById('recentPresentationsModal').classList.remove('active');
    }

    function renderRecentPresentations(filter = '') {
      const container = document.getElementById('recentPresentationsList');
      const sortBy = document.getElementById('recentPresentationsSort').value;

      let filteredPresentations = recentPresentations.filter(p =>
        p.name.toLowerCase().includes(filter.toLowerCase()) ||
        p.preview.toLowerCase().includes(filter.toLowerCase())
      );

      // Sort presentations
      filteredPresentations.sort((a, b) => {
        switch (sortBy) {
          case 'oldest': return new Date(a.timestamp) - new Date(b.timestamp);
          case 'name': return a.name.localeCompare(b.name);
          case 'slides': return b.slideCount - a.slideCount;
          default: return new Date(b.timestamp) - new Date(a.timestamp);
        }
      });

      if (filteredPresentations.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: #666;">
            <div style="font-size: 48px; margin-bottom: 1rem;">ðŸ“Š</div>
            <p>${filter ? 'No matching presentations' : 'No recent presentations'}</p>
            <p style="font-size: 0.85rem;">Presentations you work on will appear here</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredPresentations.map((p, index) => {
        const date = new Date(p.timestamp);
        const timeAgo = getTimeAgo(date);
        return `
          <div style="display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;"
               onmouseover="this.style.background='#f0f7ff'"
               onmouseout="this.style.background='transparent'"
               onclick="openRecentPresentation(${index})">
            <div style="width: 60px; height: 45px; background: linear-gradient(135deg, #f57c00, #ff9800); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; margin-right: 1rem; flex-shrink: 0;">
              ðŸ“Š
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 500; color: #333; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(p.name)}</div>
              <div style="font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(p.preview)}</div>
              <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">${timeAgo} Â· ${p.slideCount} slide${p.slideCount !== 1 ? 's' : ''}</div>
            </div>
            <button class="btn btn-sm" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem;"
                    onclick="event.stopPropagation(); deleteRecentPresentation(${index})" title="Remove from history">ðŸ—‘</button>
          </div>
        `;
      }).join('');
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
      if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
      if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function filterRecentPresentations() {
      const filter = document.getElementById('recentPresentationsSearch').value;
      renderRecentPresentations(filter);
    }

    function sortRecentPresentations() {
      const filter = document.getElementById('recentPresentationsSearch').value;
      renderRecentPresentations(filter);
    }

    function openRecentPresentation(index) {
      const presentation = recentPresentations[index];
      if (!presentation) return;

      if (slides.length > 1 || slides[0].elements.length > 0) {
        if (!confirm('Opening this presentation will replace current content. Continue?')) return;
      }

      slides = JSON.parse(JSON.stringify(presentation.slides));
      currentSlideIndex = presentation.currentSlideIndex || 0;
      document.getElementById('fileName').value = presentation.name;

      renderSlideThumbnails();
      renderCurrentSlide();
      hideRecentPresentations();
      showToast('Presentation opened', 'success');
    }

    function deleteRecentPresentation(index) {
      if (!confirm('Remove this presentation from history?')) return;
      recentPresentations.splice(index, 1);
      localStorage.setItem(RECENT_PRESENTATIONS_KEY, JSON.stringify(recentPresentations));
      const filter = document.getElementById('recentPresentationsSearch').value;
      renderRecentPresentations(filter);
      showToast('Removed from history', 'info');
    }

    function clearRecentPresentations() {
      if (!confirm('Clear all recent presentations history?')) return;
      recentPresentations = [];
      localStorage.setItem(RECENT_PRESENTATIONS_KEY, JSON.stringify(recentPresentations));
      renderRecentPresentations();
      showToast('History cleared', 'info');
    }

    // Load recent presentations on startup
    loadRecentPresentations();

    // Initialize
    init();

    // ==================== QUICK ACCESS TOOLBAR ====================
    const qatCommands = [
      { id: 'save', icon: 'ðŸ’¾', label: 'Save', action: 'savePresentation()' },
      { id: 'undo', icon: 'â†¶', label: 'Undo', action: 'undo()' },
      { id: 'redo', icon: 'â†·', label: 'Redo', action: 'redo()' },
      { id: 'pdf', icon: 'ðŸ“„', label: 'Export PDF', action: 'exportPDF()' },
      { id: 'slideshow', icon: 'â–¶ï¸', label: 'Start Slideshow', action: 'startSlideshow()' },
      { id: 'new', icon: 'ðŸ“', label: 'New Presentation', action: 'newPresentation()' },
      { id: 'open', icon: 'ðŸ“‚', label: 'Open', action: 'showOpenDialog()' },
      { id: 'find', icon: 'ðŸ”', label: 'Find', action: 'toggleFindBar()' },
      { id: 'newslide', icon: 'âž•', label: 'New Slide', action: 'addSlide()' },
      { id: 'duplicate', icon: 'ðŸ“‹', label: 'Duplicate Slide', action: 'duplicateSlide()' },
      { id: 'presenter', icon: 'ðŸŽ¤', label: 'Presenter View', action: 'showPresenterView()' },
      { id: 'print', icon: 'ðŸ–¨ï¸', label: 'Print Preview', action: 'showPrintPreview()' },
      { id: 'textbox', icon: 'ðŸ“', label: 'Insert Text Box', action: 'insertTextBox()' },
      { id: 'image', icon: 'ðŸ–¼ï¸', label: 'Insert Image', action: 'insertImage()' },
      { id: 'shape', icon: 'â¬¡', label: 'Insert Shape', action: 'showShapePicker()' },
      { id: 'darkmode', icon: 'ðŸŒ™', label: 'Dark Mode', action: 'toggleDarkMode()' }
    ];

    const defaultQATItems = ['save', 'undo', 'redo', 'pdf', 'slideshow'];
    let qatItems = JSON.parse(localStorage.getItem('ninjaSlidesQAT')) || [...defaultQATItems];

    function renderQAT() {
      const toolbar = document.getElementById('quickAccessToolbar');
      let html = '';

      qatItems.forEach((itemId, index) => {
        const cmd = qatCommands.find(c => c.id === itemId);
        if (cmd) {
          html += `<button class="qat-btn" onclick="${cmd.action}" title="${cmd.label}">${cmd.icon}</button>`;
          if (index === 2 && qatItems.length > 3) {
            html += '<span class="qat-separator"></span>';
          }
        }
      });

      html += '<button class="qat-btn qat-customize" onclick="showQATCustomization()" title="Customize Quick Access Toolbar">â–¼ Customize</button>';
      toolbar.innerHTML = html;
    }

    function showQATCustomization() {
      const list = document.getElementById('qatCommandsList');
      list.innerHTML = qatCommands.map(cmd => `
        <label class="qat-modal-item">
          <input type="checkbox" value="${cmd.id}" ${qatItems.includes(cmd.id) ? 'checked' : ''}>
          <span style="font-size: 1.2rem;">${cmd.icon}</span>
          <span>${cmd.label}</span>
        </label>
      `).join('');
      document.getElementById('qatModal').classList.add('active');
    }

    function hideQATCustomization() {
      document.getElementById('qatModal').classList.remove('active');
    }

    function saveQATCustomization() {
      const checkboxes = document.querySelectorAll('#qatCommandsList input[type="checkbox"]:checked');
      qatItems = Array.from(checkboxes).map(cb => cb.value);
      if (qatItems.length === 0) {
        qatItems = [...defaultQATItems];
        showToast('At least one command is required. Reset to defaults.', 'warning');
      }
      localStorage.setItem('ninjaSlidesQAT', JSON.stringify(qatItems));
      renderQAT();
      hideQATCustomization();
      showToast('Quick Access Toolbar updated', 'success');
    }

    function resetQAT() {
      qatItems = [...defaultQATItems];
      localStorage.setItem('ninjaSlidesQAT', JSON.stringify(qatItems));
      renderQAT();
      hideQATCustomization();
      showToast('Quick Access Toolbar reset to defaults', 'info');
    }

    // Initialize QAT on load
    document.addEventListener('DOMContentLoaded', renderQAT);

    // ==================== DRAG & DROP FILE IMPORT ====================
    const dropOverlay = document.getElementById('dropOverlay');
    let dragCounter = 0;

    document.addEventListener('dragenter', function(e) {
      e.preventDefault();
      dragCounter++;
      if (e.dataTransfer.types.includes('Files')) {
        dropOverlay.classList.add('visible');
      }
    });

    document.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dragCounter--;
      if (dragCounter === 0) {
        dropOverlay.classList.remove('visible');
      }
    });

    document.addEventListener('dragover', function(e) {
      e.preventDefault();
    });

    document.addEventListener('drop', function(e) {
      e.preventDefault();
      dragCounter = 0;
      dropOverlay.classList.remove('visible');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleDroppedFile(files[0]);
      }
    });

    function handleDroppedFile(file) {
      const fileName = file.name.toLowerCase();
      const extension = fileName.split('.').pop();

      if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'].includes(extension)) {
        // Add image to current slide
        const reader = new FileReader();
        reader.onload = function(e) {
          const slide = slides[currentSlide];
          const id = Date.now();

          slide.elements.push({
            id,
            type: 'image',
            x: 100,
            y: 100,
            width: 400,
            height: 300,
            src: e.target.result
          });

          renderSlide();
          saveToHistory();
          showToast(`Added image: ${file.name}`, 'success');
        };
        reader.readAsDataURL(file);
      } else if (extension === 'pptx') {
        showToast('PPTX import coming soon! For now, create slides manually.', 'info');
      } else {
        showToast(`Unsupported file type: .${extension}`, 'error');
      }
    }

    // ==================== AUTO-SAVE ====================
    let autoSaveEnabled = localStorage.getItem('ninjaslides_autosave') !== 'false';
    let autoSaveInterval = null;
    let lastSlidesHash = '';

    function initAutoSave() {
      if (autoSaveEnabled) {
        lastSlidesHash = JSON.stringify(slides);
        autoSaveInterval = setInterval(checkAutoSave, 30000);
      }
    }

    function checkAutoSave() {
      if (!autoSaveEnabled) return;
      const currentHash = JSON.stringify(slides);
      if (currentHash !== lastSlidesHash) {
        performAutoSave();
        lastSlidesHash = currentHash;
      }
    }

    function performAutoSave() {
      const indicator = document.getElementById('autosaveIndicator');
      indicator.classList.add('visible');

      const docId = 'autosave_slides_' + (document.getElementById('fileName').value || 'untitled');
      const saveData = {
        slides: slides,
        currentSlide: currentSlide,
        timestamp: Date.now(),
        name: document.getElementById('fileName').value
      };
      localStorage.setItem(docId, JSON.stringify(saveData));

      setTimeout(() => {
        indicator.classList.remove('visible');
      }, 1500);
    }

    document.addEventListener('DOMContentLoaded', initAutoSave);

    // ==================== CONTEXT MENU ====================
    const contextMenu = document.getElementById('contextMenu');
    const slideCanvas = document.getElementById('slideCanvas');
    let contextMenuClickPos = { x: 0, y: 0 };

    // Show context menu on right-click in slide canvas
    slideCanvas.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      e.stopPropagation();

      // Store click position for adding elements
      const canvasRect = slideCanvas.getBoundingClientRect();
      contextMenuClickPos = {
        x: e.clientX - canvasRect.left,
        y: e.clientY - canvasRect.top
      };

      // Position the menu
      const menuWidth = 220;
      const menuHeight = 450;
      let x = e.clientX;
      let y = e.clientY;

      // Keep menu in viewport
      if (x + menuWidth > window.innerWidth) {
        x = window.innerWidth - menuWidth - 10;
      }
      if (y + menuHeight > window.innerHeight) {
        y = window.innerHeight - menuHeight - 10;
      }

      contextMenu.style.left = x + 'px';
      contextMenu.style.top = y + 'px';
      contextMenu.classList.add('visible');

      // Update menu state based on selection
      updateContextMenuState();
    });

    // Hide context menu on click outside
    document.addEventListener('click', function(e) {
      if (!contextMenu.contains(e.target)) {
        contextMenu.classList.remove('visible');
      }
    });

    // Hide on escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        contextMenu.classList.remove('visible');
      }
    });

    function updateContextMenuState() {
      const hasSelection = selectedElement !== null;
      const menuItems = contextMenu.querySelectorAll('.context-menu-item');

      // Disable element-specific options when nothing selected
      const elementActions = ['cut', 'copy', 'duplicate', 'bringFront', 'sendBack', 'lock', 'group', 'animation', 'delete'];
      menuItems.forEach(item => {
        const onclick = item.getAttribute('onclick') || '';
        elementActions.forEach(action => {
          if (onclick.includes(`'${action}'`)) {
            item.classList.toggle('disabled', !hasSelection);
          }
        });
      });
    }

    function contextMenuAction(action) {
      contextMenu.classList.remove('visible');

      switch(action) {
        case 'cut':
          if (selectedElement) {
            copyElement();
            deleteElement();
            showToast('Cut to clipboard', 'success');
          }
          break;
        case 'copy':
          if (selectedElement) {
            copyElement();
            showToast('Copied to clipboard', 'success');
          }
          break;
        case 'paste':
          pasteElement();
          break;
        case 'duplicate':
          if (selectedElement) {
            duplicateElement();
          }
          break;
        case 'bringFront':
          if (selectedElement) {
            bringToFront();
          }
          break;
        case 'sendBack':
          if (selectedElement) {
            sendToBack();
          }
          break;
        case 'addText':
          addTextBox(contextMenuClickPos.x, contextMenuClickPos.y);
          break;
        case 'addShape':
          addShape('rectangle', contextMenuClickPos.x, contextMenuClickPos.y);
          break;
        case 'addImage':
          addImage();
          break;
        case 'lock':
          if (selectedElement) {
            toggleLockElement();
          }
          break;
        case 'group':
          groupSelected();
          break;
        case 'animation':
          if (selectedElement) {
            showAnimationPanel();
          }
          break;
        case 'delete':
          if (selectedElement) {
            deleteElement();
          }
          break;
        default:
          showToast('Action: ' + action, 'info');
      }
    }

    // Helper function to add text box at specific position
    function addTextBox(x, y) {
      const slide = slides[currentSlide];
      const id = Date.now();

      slide.elements.push({
        id,
        type: 'text',
        x: x || 100,
        y: y || 100,
        width: 200,
        height: 50,
        content: 'Double-click to edit',
        fontSize: 18,
        fontFamily: 'Arial',
        color: '#333333',
        bold: false,
        italic: false,
        align: 'center'
      });

      renderSlide();
      saveToHistory();
      showToast('Text box added', 'success');
    }

    // Helper function to show animation panel
    function showAnimationPanel() {
      const animPanel = document.getElementById('animationModal');
      if (animPanel) {
        animPanel.classList.add('active');
      } else {
        showToast('Select animation from the Animations toolbar', 'info');
      }
    }

    // ==================== FLOATING ACTION BUTTON ====================
    let fabOpen = false;

    function toggleFab() {
      fabOpen = !fabOpen;
      const fabMain = document.getElementById('fabMain');
      const fabMenu = document.getElementById('fabMenu');
      fabMain.classList.toggle('active', fabOpen);
      fabMenu.classList.toggle('visible', fabOpen);
    }

    document.addEventListener('click', function(e) {
      if (fabOpen && !e.target.closest('.fab-container')) {
        toggleFab();
      }
    });

    // ==================== GLOBAL SEARCH SPOTLIGHT ====================
    let spotlightSelectedIndex = 0;
    let spotlightItems = [];

    const spotlightActions = [
      { icon: 'ðŸ“„', title: 'New Presentation', desc: 'Create a blank presentation', action: () => newPresentation(), shortcut: 'Ctrl+N' },
      { icon: 'ðŸ’¾', title: 'Save', desc: 'Save current presentation', action: () => savePresentation(), shortcut: 'Ctrl+S' },
      { icon: 'ðŸ“‚', title: 'Open', desc: 'Open existing presentation', action: () => showOpenDialog && showOpenDialog(), shortcut: 'Ctrl+O' },
      { icon: 'ðŸ–¨ï¸', title: 'Print', desc: 'Print presentation', action: () => window.print(), shortcut: 'Ctrl+P' },
      { icon: 'ðŸ“‹', title: 'Export PPTX', desc: 'Export as PowerPoint', action: () => exportPptx && exportPptx() },
      { icon: 'ðŸ“„', title: 'Export PDF', desc: 'Export as PDF', action: () => exportPDF && exportPDF() },
      { icon: 'â–¶ï¸', title: 'Start Slideshow', desc: 'Begin presentation', action: () => startSlideshow && startSlideshow(), shortcut: 'F5' },
      { icon: 'ðŸŒ™', title: 'Toggle Dark Mode', desc: 'Switch theme', action: () => toggleDarkMode && toggleDarkMode() },
      { icon: 'âž•', title: 'Add Slide', desc: 'Insert new slide', action: () => addSlide() },
      { icon: 'T', title: 'Add Text Box', desc: 'Insert text element', action: () => addTextBox() },
      { icon: 'ðŸ–¼ï¸', title: 'Add Image', desc: 'Insert image', action: () => addImage() },
      { icon: 'â¬¡', title: 'Add Shape', desc: 'Insert shape', action: () => showShapePicker && showShapePicker() },
      { icon: 'ðŸ“‹', title: 'Duplicate Slide', desc: 'Copy current slide', action: () => duplicateSlide && duplicateSlide() },
      { icon: 'ðŸŽ¤', title: 'Presenter View', desc: 'Open presenter mode', action: () => showPresenterView && showPresenterView() },
      { icon: 'âŒ¨ï¸', title: 'Keyboard Shortcuts', desc: 'View all shortcuts', action: () => showKeyboardShortcuts && showKeyboardShortcuts(), shortcut: 'Ctrl+/' },
    ];

    function showSpotlight() {
      document.getElementById('spotlightOverlay').classList.add('visible');
      document.getElementById('spotlightInput').value = '';
      document.getElementById('spotlightInput').focus();
      spotlightSelectedIndex = 0;
      renderSpotlight('');
    }

    function hideSpotlight() {
      document.getElementById('spotlightOverlay').classList.remove('visible');
    }

    function renderSpotlight(query) {
      const actionsContainer = document.getElementById('spotlightActions');
      const slidesContainer = document.getElementById('spotlightSlides');
      const q = query.toLowerCase();

      const filteredActions = spotlightActions
        .filter(a => !q || a.title.toLowerCase().includes(q) || a.desc.toLowerCase().includes(q))
        .slice(0, 8);

      // Generate slide items from current slides
      const slideItems = slides.map((slide, index) => ({
        icon: 'ðŸ“„',
        title: `Slide ${index + 1}`,
        desc: slide.elements.length > 0 ? `${slide.elements.length} element(s)` : 'Empty slide',
        action: () => { goToSlide(index); hideSpotlight(); }
      })).filter(s => !q || s.title.toLowerCase().includes(q) || s.desc.toLowerCase().includes(q))
        .slice(0, 5);

      spotlightItems = [...filteredActions, ...slideItems];

      actionsContainer.innerHTML = filteredActions.map((item, i) => `
        <div class="spotlight-item ${i === spotlightSelectedIndex ? 'selected' : ''}" onclick="executeSpotlightItem(${i})">
          <span class="spotlight-item-icon">${item.icon}</span>
          <div class="spotlight-item-content">
            <div class="spotlight-item-title">${item.title}</div>
            <div class="spotlight-item-desc">${item.desc}</div>
          </div>
          ${item.shortcut ? `<span class="spotlight-item-shortcut">${item.shortcut}</span>` : ''}
        </div>
      `).join('') || '<div style="padding: 10px 16px; color: #888;">No actions found</div>';

      slidesContainer.innerHTML = slideItems.map((item, i) => `
        <div class="spotlight-item ${(i + filteredActions.length) === spotlightSelectedIndex ? 'selected' : ''}" onclick="executeSpotlightItem(${i + filteredActions.length})">
          <span class="spotlight-item-icon">${item.icon}</span>
          <div class="spotlight-item-content">
            <div class="spotlight-item-title">${item.title}</div>
            <div class="spotlight-item-desc">${item.desc}</div>
          </div>
        </div>
      `).join('') || '<div style="padding: 10px 16px; color: #888;">No slides found</div>';
    }

    function executeSpotlightItem(index) {
      if (spotlightItems[index] && spotlightItems[index].action) {
        spotlightItems[index].action();
      }
      hideSpotlight();
    }

    function handleSpotlightKeydown(e) {
      if (e.key === 'Escape') {
        hideSpotlight();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        spotlightSelectedIndex = Math.min(spotlightSelectedIndex + 1, spotlightItems.length - 1);
        renderSpotlight(document.getElementById('spotlightInput').value);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        spotlightSelectedIndex = Math.max(spotlightSelectedIndex - 1, 0);
        renderSpotlight(document.getElementById('spotlightInput').value);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        executeSpotlightItem(spotlightSelectedIndex);
      }
    }

    // Ctrl+K to open spotlight
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        showSpotlight();
      }
    });

    // ==================== STATUS BAR INTERACTIONS ====================
    // currentZoom defined earlier in the file
    let currentSlideTransition = 'none';

    // Auto-save Status Toggle
    function toggleAutoSaveStatus() {
      const autoSaveEnabled = localStorage.getItem('ninjaslides_autosave') !== 'false';
      const newState = !autoSaveEnabled;
      localStorage.setItem('ninjaslides_autosave', newState);

      const icon = document.getElementById('autoSaveStatusIcon');
      const text = document.getElementById('autoSaveStatusText');

      if (newState) {
        icon.textContent = 'ðŸ’¾';
        text.textContent = 'Auto-save On';
        showToast('Auto-save enabled', 'success');
      } else {
        icon.textContent = 'â¸ï¸';
        text.textContent = 'Auto-save Off';
        showToast('Auto-save disabled', 'info');
      }
    }

    // Zoom Popup
    function showZoomPopup() {
      hideAllStatusPopups();
      document.getElementById('zoomPopup').classList.add('visible');
      document.getElementById('zoomSlider').value = currentZoom;
      updateZoomPresetButtons();
    }

    function hideZoomPopup() {
      document.getElementById('zoomPopup').classList.remove('visible');
    }

    function setZoomFromSlider(value) {
      setZoomLevel(parseInt(value));
    }

    function setZoomLevel(level) {
      currentZoom = level;
      document.getElementById('statusZoom').textContent = level + '%';
      document.getElementById('zoomSlider').value = level;

      const slideCanvas = document.querySelector('.slide-canvas');
      if (slideCanvas) {
        slideCanvas.style.transform = `scale(${level / 100})`;
        slideCanvas.style.transformOrigin = 'center center';
      }

      updateZoomPresetButtons();
      localStorage.setItem('ninjaslides_zoom', level);
    }

    function updateZoomPresetButtons() {
      document.querySelectorAll('.zoom-preset-btn').forEach(btn => {
        const btnLevel = parseInt(btn.textContent);
        btn.classList.toggle('active', btnLevel === currentZoom);
      });
    }

    // Transition Popup
    function showTransitionPopup() {
      hideAllStatusPopups();
      document.getElementById('transitionPopup').classList.add('visible');
    }

    function hideTransitionPopup() {
      document.getElementById('transitionPopup').classList.remove('visible');
    }

    function setTransition(transition) {
      currentSlideTransition = transition;
      const displayNames = {
        'none': 'None',
        'fade': 'Fade',
        'slide': 'Slide',
        'zoom': 'Zoom',
        'flip': 'Flip'
      };

      document.getElementById('currentTransition').textContent = displayNames[transition] || 'None';
      document.querySelectorAll('.transition-option').forEach(opt => {
        opt.classList.toggle('active', opt.textContent.toLowerCase().includes(transition));
      });

      // Store transition for current slide
      if (slides[currentSlide]) {
        slides[currentSlide].transition = transition;
      }

      localStorage.setItem('ninjaslides_transition', transition);
      hideTransitionPopup();
      showToast(`Transition set to ${displayNames[transition]}`, 'success');
    }

    // Slide Navigator
    function showSlideNavigator() {
      const slideNum = prompt(`Go to slide (1-${slides.length}):`);
      if (slideNum) {
        const num = parseInt(slideNum);
        if (num >= 1 && num <= slides.length) {
          goToSlide(num - 1);
          showToast(`Navigated to slide ${num}`, 'info');
        } else {
          showToast('Invalid slide number', 'error');
        }
      }
    }

    // Helper to hide all popups
    function hideAllStatusPopups() {
      hideZoomPopup();
      hideTransitionPopup();
    }

    // Close popups when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.zoom-popup') && !e.target.closest('.status-bar-item[onclick*="showZoomPopup"]')) {
        hideZoomPopup();
      }
      if (!e.target.closest('.transition-popup') && !e.target.closest('.status-bar-item[onclick*="showTransitionPopup"]')) {
        hideTransitionPopup();
      }
    });

    // Load saved preferences
    document.addEventListener('DOMContentLoaded', function() {
      // Load zoom
      const savedZoom = localStorage.getItem('ninjaslides_zoom');
      if (savedZoom) {
        setZoomLevel(parseInt(savedZoom));
      }

      // Load auto-save status display
      const savedAutoSave = localStorage.getItem('ninjaslides_autosave');
      if (savedAutoSave === 'false') {
        document.getElementById('autoSaveStatusIcon').textContent = 'â¸ï¸';
        document.getElementById('autoSaveStatusText').textContent = 'Auto-save Off';
      }

      // Load transition
      const savedTransition = localStorage.getItem('ninjaslides_transition');
      if (savedTransition) {
        currentSlideTransition = savedTransition;
        const displayNames = { 'none': 'None', 'fade': 'Fade', 'slide': 'Slide', 'zoom': 'Zoom', 'flip': 'Flip' };
        document.getElementById('currentTransition').textContent = displayNames[savedTransition] || 'None';
      }
    });

    // ==================== WELCOME MODAL ====================
    function showWelcome() {
      document.getElementById('welcomeModal').classList.add('visible');
    }

    function closeWelcome() {
      const dontShow = document.getElementById('dontShowAgain').checked;
      if (dontShow) {
        localStorage.setItem('ninjaslides_welcome_shown', 'true');
      }
      document.getElementById('welcomeModal').classList.remove('visible');
    }

    // Show welcome on first visit
    document.addEventListener('DOMContentLoaded', function() {
      const welcomed = localStorage.getItem('ninjaslides_welcome_shown');
      if (!welcomed) {
        setTimeout(showWelcome, 500);
      }
    });

    // Close welcome with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('welcomeModal').classList.contains('visible')) {
        closeWelcome();
      }
    });

    // Close welcome when clicking outside
    document.getElementById('welcomeModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeWelcome();
      }
    });

    // ==================== LASER POINTER MODE ====================
    let laserPointerEnabled = false;
    let laserTrailEnabled = true;
    let laserLastPos = { x: 0, y: 0 };

    function toggleLaserPointer() {
      laserPointerEnabled = !laserPointerEnabled;
      const dot = document.getElementById('laserDot');
      const indicator = document.getElementById('laserIndicator');

      if (laserPointerEnabled) {
        document.body.classList.add('laser-pointer-active');
        dot.classList.add('visible');
        indicator.classList.add('visible');
        setTimeout(() => indicator.classList.remove('visible'), 2000);
      } else {
        document.body.classList.remove('laser-pointer-active');
        dot.classList.remove('visible');
        indicator.classList.remove('visible');
        // Clean up any remaining trails
        document.querySelectorAll('.laser-trail').forEach(el => el.remove());
      }
    }

    function updateLaserPosition(e) {
      if (!laserPointerEnabled) return;

      const dot = document.getElementById('laserDot');
      dot.style.left = e.clientX + 'px';
      dot.style.top = e.clientY + 'px';

      // Create trail effect
      if (laserTrailEnabled) {
        const distance = Math.hypot(e.clientX - laserLastPos.x, e.clientY - laserLastPos.y);
        if (distance > 10) {
          createLaserTrail(e.clientX, e.clientY);
          laserLastPos = { x: e.clientX, y: e.clientY };
        }
      }
    }

    function createLaserTrail(x, y) {
      const trail = document.createElement('div');
      trail.className = 'laser-trail';
      trail.style.left = x + 'px';
      trail.style.top = y + 'px';
      document.body.appendChild(trail);

      // Remove after animation
      setTimeout(() => trail.remove(), 500);
    }

    // Laser pointer event listeners
    document.addEventListener('mousemove', updateLaserPosition);

    document.addEventListener('keydown', function(e) {
      // Toggle laser with 'L' key (not in input fields)
      if (e.key.toLowerCase() === 'l' && !e.target.matches('input, textarea, [contenteditable="true"]')) {
        e.preventDefault();
        toggleLaserPointer();
      }
    });

    // ==================== SLIDE TIMER ====================
    let slideTimerInterval = null;
    let slideTimerSeconds = 0;
    let slideTimerPaused = false;
    let slideTimerVisible = false;
    let slideTimerWarningTime = 300; // 5 minutes warning
    let slideTimerDangerTime = 600; // 10 minutes danger

    function toggleSlideTimer() {
      slideTimerVisible = !slideTimerVisible;
      const timer = document.getElementById('slideTimer');

      if (slideTimerVisible) {
        timer.classList.add('visible');
        if (!slideTimerInterval && !slideTimerPaused) {
          startSlideTimer();
        }
      } else {
        timer.classList.remove('visible');
      }
    }

    function startSlideTimer() {
      if (slideTimerInterval) return;

      slideTimerInterval = setInterval(() => {
        if (!slideTimerPaused) {
          slideTimerSeconds++;
          updateSlideTimerDisplay();
        }
      }, 1000);
    }

    function updateSlideTimerDisplay() {
      const minutes = Math.floor(slideTimerSeconds / 60);
      const seconds = slideTimerSeconds % 60;
      const display = document.getElementById('slideTimerDisplay');

      display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      // Update warning/danger classes
      display.classList.remove('warning', 'danger');
      if (slideTimerSeconds >= slideTimerDangerTime) {
        display.classList.add('danger');
      } else if (slideTimerSeconds >= slideTimerWarningTime) {
        display.classList.add('warning');
      }
    }

    function resetSlideTimer() {
      slideTimerSeconds = 0;
      slideTimerPaused = false;
      document.getElementById('slideTimerPauseBtn').textContent = 'Pause';
      updateSlideTimerDisplay();
    }

    function toggleSlideTimerPause() {
      slideTimerPaused = !slideTimerPaused;
      const btn = document.getElementById('slideTimerPauseBtn');
      btn.textContent = slideTimerPaused ? 'Resume' : 'Pause';
    }

    // Keyboard shortcut: T to toggle timer
    document.addEventListener('keydown', function(e) {
      if (e.key.toLowerCase() === 't' && !e.target.matches('input, textarea, [contenteditable="true"]') && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        toggleSlideTimer();
      }
    });

    // ==================== QUICK SHAPES TOOLBAR ====================
    let quickShapesVisible = false;

    function toggleQuickShapes() {
      quickShapesVisible = !quickShapesVisible;
      const bar = document.getElementById('quickShapesBar');
      bar.classList.toggle('visible', quickShapesVisible);
    }

    function quickAddShape(shapeType) {
      const slideCanvas = document.querySelector('.slide-canvas');
      if (!slideCanvas) return;

      const shapes = {
        'rectangle': { width: 150, height: 100, bg: '#4285f4', border: '2px solid #1a73e8', borderRadius: '4px' },
        'circle': { width: 100, height: 100, bg: '#ea4335', border: '2px solid #c62828', borderRadius: '50%' },
        'triangle': { width: 120, height: 100, bg: 'transparent', borderLeft: '60px solid transparent', borderRight: '60px solid transparent', borderBottom: '100px solid #fbbc04', special: 'triangle' },
        'diamond': { width: 80, height: 80, bg: '#34a853', border: '2px solid #2e7d32', transform: 'rotate(45deg)' },
        'arrow-right': { width: 150, height: 40, bg: '#4285f4', clipPath: 'polygon(0 25%, 75% 25%, 75% 0, 100% 50%, 75% 100%, 75% 75%, 0 75%)', special: 'arrow' },
        'arrow-down': { width: 40, height: 150, bg: '#4285f4', clipPath: 'polygon(25% 0, 75% 0, 75% 75%, 100% 75%, 50% 100%, 0 75%, 25% 75%)', special: 'arrow' },
        'star': { width: 100, height: 100, bg: '#fbbc04', clipPath: 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)', special: 'star' }
      };

      const shape = shapes[shapeType];
      if (!shape) return;

      const element = document.createElement('div');
      element.className = 'slide-element';
      element.id = `element-${++elementIdCounter}`;

      // Position in center of visible area
      const canvasRect = slideCanvas.getBoundingClientRect();
      const left = (canvasRect.width / 2 - shape.width / 2);
      const top = (canvasRect.height / 2 - shape.height / 2);

      let styleStr = `left: ${left}px; top: ${top}px; width: ${shape.width}px; height: ${shape.height}px;`;

      if (shape.special === 'triangle') {
        styleStr += ` border-left: ${shape.borderLeft}; border-right: ${shape.borderRight}; border-bottom: ${shape.borderBottom}; background: transparent;`;
      } else {
        styleStr += ` background: ${shape.bg};`;
        if (shape.border) styleStr += ` border: ${shape.border};`;
        if (shape.borderRadius) styleStr += ` border-radius: ${shape.borderRadius};`;
        if (shape.transform) styleStr += ` transform: ${shape.transform};`;
        if (shape.clipPath) styleStr += ` clip-path: ${shape.clipPath};`;
      }

      element.style.cssText = styleStr;

      slideCanvas.appendChild(element);
      addResizeHandles(element);
      selectElement(element);

      // Save to current slide
      if (slides[currentSlideIndex]) {
        slides[currentSlideIndex].elements = slides[currentSlideIndex].elements || [];
        slides[currentSlideIndex].elements.push({
          id: element.id,
          type: 'shape',
          shapeType: shapeType,
          style: styleStr
        });
      }

      showToast(`${shapeType} added`, 'success');
    }

    function quickAddText() {
      const slideCanvas = document.querySelector('.slide-canvas');
      if (!slideCanvas) return;

      const element = document.createElement('div');
      element.className = 'slide-element';
      element.id = `element-${++elementIdCounter}`;
      element.contentEditable = 'true';
      element.textContent = 'Click to edit text';

      const canvasRect = slideCanvas.getBoundingClientRect();
      element.style.cssText = `
        left: ${canvasRect.width / 2 - 100}px;
        top: ${canvasRect.height / 2 - 20}px;
        min-width: 100px;
        min-height: 30px;
        padding: 8px 12px;
        font-size: 18px;
        color: #333;
        background: transparent;
        border: 1px dashed #ccc;
      `;

      slideCanvas.appendChild(element);
      addResizeHandles(element);
      selectElement(element);
      element.focus();

      showToast('Text box added', 'success');
    }

    function quickAddLine() {
      const slideCanvas = document.querySelector('.slide-canvas');
      if (!slideCanvas) return;

      const element = document.createElement('div');
      element.className = 'slide-element';
      element.id = `element-${++elementIdCounter}`;

      const canvasRect = slideCanvas.getBoundingClientRect();
      element.style.cssText = `
        left: ${canvasRect.width / 2 - 100}px;
        top: ${canvasRect.height / 2}px;
        width: 200px;
        height: 3px;
        background: #333;
      `;

      slideCanvas.appendChild(element);
      addResizeHandles(element);
      selectElement(element);

      showToast('Line added', 'success');
    }

    // Keyboard shortcut: S to toggle quick shapes
    document.addEventListener('keydown', function(e) {
      if (e.key.toLowerCase() === 's' && !e.target.matches('input, textarea, [contenteditable="true"]') && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        toggleQuickShapes();
      }
    });

    // Initialize: hide timer on load
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('slideTimer').classList.remove('visible');
      document.getElementById('quickShapesBar').classList.remove('visible');
    });
  </script>
</body>
</html>
