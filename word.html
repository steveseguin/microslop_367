<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="theme-color" content="#2563eb">
  <meta name="description" content="NinjaWord - Create beautiful documents with rich text formatting, spell check, and more">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>NinjaWord - Document Editor</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/officeninja.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    .zoom-controls { display: flex; align-items: center; gap: 0.5rem; }
    .zoom-btn { padding: 0.25rem 0.5rem; cursor: pointer; }
    .zoom-display { min-width: 50px; text-align: center; font-size: 0.85rem; }
    /* Mini Toolbar */
    .mini-toolbar {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      padding: 4px;
      z-index: 10000;
      gap: 2px;
      align-items: center;
      animation: miniToolbarFadeIn 0.15s ease-out;
    }
    @keyframes miniToolbarFadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .mini-toolbar.visible { display: flex; }
    .mini-toolbar button {
      padding: 6px 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      transition: background 0.2s;
    }
    .mini-toolbar button:hover {
      background: #e8f0fe;
    }
    .mini-toolbar .separator {
      width: 1px;
      height: 20px;
      background: #ddd;
      margin: 0 4px;
    }
    .mini-toolbar select {
      padding: 4px 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      background: white;
      cursor: pointer;
    }
    .mini-toolbar input[type="color"] {
      width: 24px;
      height: 24px;
      padding: 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    body.dark-mode .mini-toolbar {
      background: #2d2d2d;
      border-color: #444;
    }
    body.dark-mode .mini-toolbar button:hover {
      background: #444;
    }
    body.dark-mode .mini-toolbar .separator {
      background: #555;
    }
    /* Command Palette */
    .command-palette-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 20000;
      display: none;
      justify-content: center;
      padding-top: 15vh;
    }
    .command-palette-overlay.visible { display: flex; }
    .command-palette {
      width: 600px;
      max-width: 90vw;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      overflow: hidden;
      animation: commandPaletteIn 0.15s ease-out;
    }
    @keyframes commandPaletteIn {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .command-palette-input {
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 16px;
      outline: none;
    }
    .command-palette-input::placeholder { color: #999; }
    .command-palette-results {
      max-height: 400px;
      overflow-y: auto;
    }
    .command-item {
      padding: 12px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #f5f5f5;
    }
    .command-item:hover, .command-item.selected {
      background: #e8f0fe;
    }
    .command-item-icon { font-size: 18px; width: 24px; text-align: center; }
    .command-item-text { flex: 1; }
    .command-item-name { font-weight: 500; }
    .command-item-desc { font-size: 12px; color: #666; margin-top: 2px; }
    .command-item-shortcut {
      font-size: 11px;
      padding: 2px 6px;
      background: #f0f0f0;
      border-radius: 4px;
      color: #666;
      font-family: monospace;
    }
    .command-palette-footer {
      padding: 8px 20px;
      background: #f9f9f9;
      font-size: 12px;
      color: #666;
      display: flex;
      gap: 16px;
    }
    .command-palette-footer kbd {
      background: #e0e0e0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    body.dark-mode .command-palette { background: #2d2d2d; }
    body.dark-mode .command-palette-input { background: #2d2d2d; color: white; border-color: #444; }
    body.dark-mode .command-item { border-color: #444; }
    body.dark-mode .command-item:hover, body.dark-mode .command-item.selected { background: #3d3d3d; }
    body.dark-mode .command-item-desc { color: #aaa; }
    body.dark-mode .command-item-shortcut { background: #444; color: #ccc; }
    body.dark-mode .command-palette-footer { background: #252525; }
    /* Feature Tour */
    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 30000;
      display: none;
    }
    .tour-overlay.visible { display: block; }
    .tour-highlight {
      position: absolute;
      box-shadow: 0 0 0 4px #1a73e8, 0 0 0 9999px rgba(0,0,0,0.6);
      border-radius: 8px;
      z-index: 30001;
      pointer-events: none;
      transition: all 0.3s ease;
    }
    .tour-tooltip {
      position: absolute;
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 320px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 30002;
      animation: tourFadeIn 0.3s ease;
    }
    @keyframes tourFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tour-tooltip h3 { margin: 0 0 8px 0; color: #1a73e8; font-size: 18px; }
    .tour-tooltip p { margin: 0 0 16px 0; color: #555; line-height: 1.5; }
    .tour-tooltip-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tour-dots {
      display: flex;
      gap: 6px;
    }
    .tour-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ddd;
    }
    .tour-dot.active { background: #1a73e8; }
    .tour-buttons {
      display: flex;
      gap: 8px;
    }
    .tour-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .tour-btn-skip {
      background: transparent;
      color: #666;
    }
    .tour-btn-skip:hover { background: #f0f0f0; }
    .tour-btn-next {
      background: #1a73e8;
      color: white;
    }
    .tour-btn-next:hover { background: #1557b0; }
    .tour-arrow {
      position: absolute;
      width: 0;
      height: 0;
      border: 10px solid transparent;
    }
    .tour-arrow-top { border-bottom-color: white; top: -20px; left: 50%; transform: translateX(-50%); }
    .tour-arrow-bottom { border-top-color: white; bottom: -20px; left: 50%; transform: translateX(-50%); }
    .tour-arrow-left { border-right-color: white; left: -20px; top: 50%; transform: translateY(-50%); }
    .tour-arrow-right { border-left-color: white; right: -20px; top: 50%; transform: translateY(-50%); }
    /* Split Screen View */
    .split-screen-container {
      display: none;
      width: 100%;
      height: calc(100vh - 200px);
    }
    .split-screen-container.active {
      display: flex;
    }
    .split-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      overflow: hidden;
    }
    .split-pane:first-child {
      border-right: none;
    }
    .split-pane-header {
      padding: 8px 12px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      font-weight: 500;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .split-pane-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: white;
    }
    .split-divider {
      width: 6px;
      background: #e0e0e0;
      cursor: col-resize;
      transition: background 0.2s;
    }
    .split-divider:hover {
      background: #1a73e8;
    }
    .split-toolbar {
      padding: 8px;
      background: #f9f9f9;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .split-toolbar button {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .split-toolbar button:hover {
      background: #e8f0fe;
    }
    body.dark-mode .split-pane-header { background: #2d2d2d; border-color: #444; color: #fff; }
    body.dark-mode .split-pane-content { background: #1e1e1e; }
    body.dark-mode .split-divider { background: #444; }
    body.dark-mode .split-toolbar { background: #252525; border-color: #444; }
    body.dark-mode .split-toolbar button { background: #2d2d2d; border-color: #444; color: #fff; }
    /* Context Menu */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 50000;
      display: none;
      padding: 6px 0;
      animation: contextMenuIn 0.12s ease-out;
    }
    @keyframes contextMenuIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .context-menu.visible { display: block; }
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      transition: background 0.15s;
    }
    .context-menu-item:hover {
      background: #e8f0fe;
    }
    .context-menu-item.disabled {
      color: #999;
      pointer-events: none;
    }
    .context-menu-item-icon {
      width: 20px;
      text-align: center;
      font-size: 14px;
    }
    .context-menu-item-shortcut {
      margin-left: auto;
      font-size: 11px;
      color: #888;
    }
    .context-menu-divider {
      height: 1px;
      background: #eee;
      margin: 6px 0;
    }
    .context-menu-submenu {
      position: relative;
    }
    .context-menu-submenu::after {
      content: '‚ñ∂';
      position: absolute;
      right: 12px;
      font-size: 10px;
      color: #888;
    }
    body.dark-mode .context-menu {
      background: #2d2d2d;
      border-color: #444;
    }
    body.dark-mode .context-menu-item:hover {
      background: #3d3d3d;
    }
    body.dark-mode .context-menu-divider {
      background: #444;
    }
    /* Drag & Drop Overlay */
    .drop-overlay {
      position: fixed;
      inset: 0;
      background: rgba(26, 115, 232, 0.9);
      z-index: 100000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1rem;
    }
    .drop-overlay.visible {
      display: flex;
    }
    .drop-overlay-icon {
      font-size: 80px;
      animation: dropBounce 0.5s ease infinite alternate;
    }
    @keyframes dropBounce {
      from { transform: translateY(0); }
      to { transform: translateY(-10px); }
    }
    .drop-overlay-text {
      font-size: 24px;
      color: white;
      font-weight: 500;
    }
    .drop-overlay-subtext {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    /* Keyboard Shortcuts Modal */
    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    .shortcuts-section h4 {
      margin: 0 0 0.75rem 0;
      color: #1a73e8;
      font-size: 0.95rem;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 0.5rem;
    }
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 0;
      font-size: 0.85rem;
    }
    .shortcut-item kbd {
      background: #f1f3f4;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    body.dark-mode .shortcuts-section h4 {
      color: #4da3ff;
      border-color: #444;
    }
    body.dark-mode .shortcut-item kbd {
      background: #3c3c3c;
      border-color: #555;
      color: #ddd;
    }
    /* Auto-save indicator */
    .autosave-indicator {
      position: fixed;
      bottom: 40px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 10000;
      animation: fadeInUp 0.3s ease;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .autosave-indicator.visible {
      display: flex;
    }
    .autosave-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Undo History Panel */
    .undo-history-panel {
      position: fixed;
      top: 200px;
      right: 20px;
      width: 280px;
      max-height: 400px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 10000;
      display: none;
      flex-direction: column;
    }
    .undo-history-panel.visible { display: flex; }
    .undo-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
    }
    .undo-history-header h4 { margin: 0; font-size: 14px; }
    .undo-history-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #666;
    }
    .undo-history-list {
      flex: 1;
      overflow-y: auto;
      max-height: 320px;
    }
    .undo-history-item {
      padding: 10px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      transition: background 0.15s;
    }
    .undo-history-item:hover { background: #e8f0fe; }
    .undo-history-item.current { background: #e8f0fe; font-weight: 500; }
    .undo-history-item-icon { font-size: 16px; }
    .undo-history-item-time { margin-left: auto; color: #888; font-size: 11px; }
    .undo-history-empty {
      padding: 30px;
      text-align: center;
      color: #888;
      font-style: italic;
    }
    body.dark-mode .undo-history-panel {
      background: #2d2d2d;
      border-color: #444;
    }
    body.dark-mode .undo-history-header { background: #3c3c3c; border-color: #444; }
    body.dark-mode .undo-history-item { border-color: #3c3c3c; }
    body.dark-mode .undo-history-item:hover { background: #3c3c3c; }
    /* Floating Action Button */
    .fab-container {
      position: fixed;
      bottom: 80px;
      right: 30px;
      z-index: 9999;
    }
    .fab-main {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #1a73e8;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fab-main:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(26, 115, 232, 0.5);
    }
    .fab-main.active {
      transform: rotate(45deg);
      background: #d93025;
    }
    .fab-menu {
      position: absolute;
      bottom: 70px;
      right: 0;
      display: none;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
    }
    .fab-menu.visible { display: flex; }
    .fab-item {
      display: flex;
      align-items: center;
      gap: 10px;
      animation: fabSlideIn 0.2s ease forwards;
      opacity: 0;
    }
    @keyframes fabSlideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fab-item:nth-child(1) { animation-delay: 0s; }
    .fab-item:nth-child(2) { animation-delay: 0.05s; }
    .fab-item:nth-child(3) { animation-delay: 0.1s; }
    .fab-item:nth-child(4) { animation-delay: 0.15s; }
    .fab-item:nth-child(5) { animation-delay: 0.2s; }
    .fab-item:nth-child(6) { animation-delay: 0.25s; }
    .fab-item-label {
      background: white;
      padding: 8px 14px;
      border-radius: 4px;
      font-size: 13px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      white-space: nowrap;
    }
    .fab-item-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: white;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
    }
    .fab-item-btn:hover {
      transform: scale(1.1);
      background: #e8f0fe;
    }
    body.dark-mode .fab-item-label { background: #3c3c3c; color: #e0e0e0; }
    body.dark-mode .fab-item-btn { background: #3c3c3c; }
    body.dark-mode .fab-item-btn:hover { background: #505050; }
    /* Global Search Spotlight */
    .spotlight-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100000;
      display: none;
      justify-content: center;
      padding-top: 15vh;
    }
    .spotlight-overlay.visible { display: flex; }
    .spotlight-container {
      width: 600px;
      max-width: 90vw;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .spotlight-input-wrapper {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      gap: 12px;
      border-bottom: 1px solid #eee;
    }
    .spotlight-icon { font-size: 20px; color: #666; }
    .spotlight-input {
      flex: 1;
      border: none;
      font-size: 18px;
      outline: none;
      background: transparent;
    }
    .spotlight-results {
      max-height: 400px;
      overflow-y: auto;
    }
    .spotlight-section {
      padding: 8px 0;
    }
    .spotlight-section-title {
      padding: 8px 20px;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .spotlight-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .spotlight-item:hover, .spotlight-item.selected { background: #e8f0fe; }
    .spotlight-item-icon { font-size: 18px; width: 24px; text-align: center; }
    .spotlight-item-content { flex: 1; }
    .spotlight-item-title { font-size: 14px; font-weight: 500; }
    .spotlight-item-desc { font-size: 12px; color: #666; margin-top: 2px; }
    .spotlight-item-shortcut {
      font-size: 11px;
      color: #888;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
    }
    .spotlight-empty {
      padding: 40px;
      text-align: center;
      color: #888;
    }
    .spotlight-footer {
      padding: 10px 20px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
      font-size: 11px;
      color: #888;
      display: flex;
      gap: 20px;
    }
    .spotlight-footer kbd {
      background: #e0e0e0;
      padding: 2px 5px;
      border-radius: 3px;
      font-family: inherit;
    }
    body.dark-mode .spotlight-container { background: #2d2d2d; }
    body.dark-mode .spotlight-input-wrapper { border-color: #444; }
    body.dark-mode .spotlight-input { color: #e0e0e0; }
    body.dark-mode .spotlight-section-title { color: #888; }
    body.dark-mode .spotlight-item:hover { background: #3c3c3c; }
    body.dark-mode .spotlight-item-desc { color: #999; }
    body.dark-mode .spotlight-footer { background: #252525; border-color: #444; }
    /* Interactive Status Bar */
    .status-bar-item {
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 4px;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .status-bar-item:hover {
      background: rgba(26, 115, 232, 0.1);
      color: #1a73e8;
    }
    .status-bar-item:active {
      transform: scale(0.98);
    }
    .status-bar-item .status-icon {
      font-size: 12px;
    }
    body.dark-mode .status-bar-item:hover {
      background: rgba(138, 180, 248, 0.15);
      color: #8ab4f8;
    }
    /* Zoom Slider Popup */
    .zoom-popup {
      position: fixed;
      bottom: 40px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 16px;
      z-index: 10001;
      display: none;
      flex-direction: column;
      gap: 12px;
      min-width: 220px;
      animation: popupSlideUp 0.2s ease-out;
    }
    .zoom-popup.visible { display: flex; }
    @keyframes popupSlideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .zoom-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
    }
    .zoom-popup-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
    }
    .zoom-slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .zoom-slider {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      background: #e0e0e0;
      border-radius: 2px;
      outline: none;
    }
    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #1a73e8;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .zoom-presets {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .zoom-preset-btn {
      padding: 4px 10px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.15s;
    }
    .zoom-preset-btn:hover {
      background: #e8f0fe;
      border-color: #1a73e8;
      color: #1a73e8;
    }
    .zoom-preset-btn.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }
    body.dark-mode .zoom-popup {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    body.dark-mode .zoom-slider { background: #444; }
    body.dark-mode .zoom-preset-btn {
      background: #3c3c3c;
      border-color: #555;
      color: #e0e0e0;
    }
    body.dark-mode .zoom-preset-btn:hover {
      background: #4a4a4a;
      border-color: #8ab4f8;
      color: #8ab4f8;
    }
    /* Language Popup */
    .language-popup {
      position: fixed;
      bottom: 40px;
      left: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 12px;
      z-index: 10001;
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      animation: popupSlideUp 0.2s ease-out;
    }
    .language-popup.visible { display: flex; }
    .language-popup-header {
      font-weight: 600;
      font-size: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .language-option {
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }
    .language-option:hover { background: #f0f0f0; }
    .language-option.active {
      background: #e8f0fe;
      color: #1a73e8;
    }
    .language-option .lang-flag { font-size: 16px; }
    body.dark-mode .language-popup {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    body.dark-mode .language-popup-header { border-color: #444; }
    body.dark-mode .language-option:hover { background: #3c3c3c; }
    body.dark-mode .language-option.active {
      background: rgba(138, 180, 248, 0.15);
      color: #8ab4f8;
    }
    /* Page Navigation Popup */
    .page-nav-popup {
      position: fixed;
      bottom: 40px;
      right: 120px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 16px;
      z-index: 10001;
      display: none;
      flex-direction: column;
      gap: 12px;
      min-width: 200px;
      animation: popupSlideUp 0.2s ease-out;
    }
    .page-nav-popup.visible { display: flex; }
    .page-nav-popup-header {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .page-nav-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .page-nav-input {
      width: 60px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }
    .page-nav-btn {
      padding: 6px 12px;
      border: none;
      background: #1a73e8;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .page-nav-btn:hover { background: #1557b0; }
    .page-nav-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .page-nav-arrow {
      width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .page-nav-arrow:hover { background: #e8f0fe; border-color: #1a73e8; }
    .page-nav-arrow:disabled { opacity: 0.5; cursor: not-allowed; }
    body.dark-mode .page-nav-popup {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    body.dark-mode .page-nav-input {
      background: #3c3c3c;
      border-color: #555;
      color: #e0e0e0;
    }
    body.dark-mode .page-nav-arrow {
      background: #3c3c3c;
      border-color: #555;
      color: #e0e0e0;
    }
    /* Welcome/Tips Modal */
    .welcome-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100001;
      display: none;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    .welcome-modal.visible { display: flex; }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .welcome-container {
      width: 550px;
      max-width: 90vw;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      animation: welcomeSlide 0.4s ease;
    }
    @keyframes welcomeSlide {
      from { opacity: 0; transform: scale(0.9) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .welcome-header {
      background: linear-gradient(135deg, #1a73e8, #4285f4);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .welcome-header h2 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .welcome-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }
    .welcome-tips {
      padding: 24px;
    }
    .welcome-tip {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 14px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .welcome-tip:last-child { border-bottom: none; }
    .welcome-tip-icon {
      width: 44px;
      height: 44px;
      background: #e8f0fe;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .welcome-tip-content h4 {
      margin: 0 0 4px 0;
      font-size: 15px;
      font-weight: 600;
      color: #202124;
    }
    .welcome-tip-content p {
      margin: 0;
      font-size: 13px;
      color: #5f6368;
      line-height: 1.4;
    }
    .welcome-tip-content kbd {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      border: 1px solid #ddd;
    }
    .welcome-footer {
      padding: 16px 24px;
      background: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .welcome-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #5f6368;
      cursor: pointer;
    }
    .welcome-btn {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .welcome-btn:hover { background: #1557b0; }
    body.dark-mode .welcome-container { background: #2d2d2d; }
    body.dark-mode .welcome-tip { border-color: #3c3c3c; }
    body.dark-mode .welcome-tip-icon { background: #3c3c3c; }
    body.dark-mode .welcome-tip-content h4 { color: #e0e0e0; }
    body.dark-mode .welcome-tip-content p { color: #9aa0a6; }
    body.dark-mode .welcome-tip-content kbd { background: #3c3c3c; border-color: #555; color: #e0e0e0; }
    body.dark-mode .welcome-footer { background: #252525; }
    body.dark-mode .welcome-checkbox { color: #9aa0a6; }

    /* Theme Picker */
    .theme-picker {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      padding: 20px;
      z-index: 100002;
      display: none;
      min-width: 280px;
    }
    .theme-picker.visible { display: block; }
    .theme-picker-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100001;
      display: none;
    }
    .theme-picker-overlay.visible { display: block; }
    .theme-picker h3 { margin: 0 0 15px 0; font-size: 16px; }
    .theme-colors {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }
    .theme-color {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .theme-color:hover { transform: scale(1.1); }
    .theme-color.active { border-color: #333; box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor; }
    .theme-picker-footer { display: flex; justify-content: flex-end; gap: 8px; }
    body.dark-mode .theme-picker { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .theme-color.active { border-color: #fff; }

    /* Theme color overrides */
    body[data-theme="blue"] { --primary: #1a73e8; --primary-dark: #174ea6; }
    body[data-theme="green"] { --primary: #0f9d58; --primary-dark: #0b8043; }
    body[data-theme="red"] { --primary: #d93025; --primary-dark: #b5261d; }
    body[data-theme="purple"] { --primary: #9334e6; --primary-dark: #7627bb; }
    body[data-theme="orange"] { --primary: #f57c00; --primary-dark: #e65100; }
    body[data-theme="teal"] { --primary: #00897b; --primary-dark: #00695c; }
    body[data-theme="pink"] { --primary: #e91e63; --primary-dark: #c2185b; }
    body[data-theme="indigo"] { --primary: #3f51b5; --primary-dark: #303f9f; }
    body[data-theme="cyan"] { --primary: #00bcd4; --primary-dark: #0097a7; }
    body[data-theme="amber"] { --primary: #ffc107; --primary-dark: #ffa000; }

    /* Pomodoro Timer */
    .pomodoro-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.25);
      padding: 24px;
      z-index: 100003;
      display: none;
      width: 340px;
      text-align: center;
    }
    .pomodoro-popup.visible { display: block; }
    .pomodoro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100002;
      display: none;
    }
    .pomodoro-overlay.visible { display: block; }
    .pomodoro-timer {
      font-size: 64px;
      font-weight: 300;
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 20px 0;
      color: #d93025;
    }
    .pomodoro-timer.break { color: #0f9d58; }
    .pomodoro-label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }
    .pomodoro-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }
    .pomodoro-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pomodoro-btn.primary { background: #d93025; color: white; }
    .pomodoro-btn.primary:hover { background: #b5261d; }
    .pomodoro-btn.secondary { background: #f1f3f4; color: #333; }
    .pomodoro-btn.secondary:hover { background: #e0e0e0; }
    .pomodoro-sessions {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }
    .pomodoro-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e0e0e0;
    }
    .pomodoro-dot.completed { background: #d93025; }
    .pomodoro-dot.break-completed { background: #0f9d58; }
    .pomodoro-settings {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #eee;
      font-size: 13px;
    }
    .pomodoro-setting {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
    }
    .pomodoro-setting input {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }
    body.dark-mode .pomodoro-popup { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .pomodoro-btn.secondary { background: #3d3d3d; color: #e0e0e0; }
    body.dark-mode .pomodoro-settings { border-color: #444; }
    body.dark-mode .pomodoro-setting input { background: #1a1a1a; border-color: #444; color: #e0e0e0; }
    body.dark-mode .pomodoro-dot { background: #444; }

    /* Ambient Sounds */
    .ambient-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.25);
      padding: 24px;
      z-index: 100003;
      display: none;
      width: 380px;
    }
    .ambient-popup.visible { display: block; }
    .ambient-popup h3 { margin: 0 0 16px 0; font-size: 18px; }
    .ambient-sounds-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .ambient-sound-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 8px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ambient-sound-btn:hover { border-color: #1a73e8; background: #f8f9fa; }
    .ambient-sound-btn.active { border-color: #1a73e8; background: #e8f0fe; }
    .ambient-sound-btn .icon { font-size: 28px; margin-bottom: 8px; }
    .ambient-sound-btn .label { font-size: 12px; color: #666; }
    .ambient-volume {
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .ambient-volume input[type="range"] { flex: 1; }
    .ambient-mix {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    .ambient-mix-label { font-size: 13px; color: #666; margin-bottom: 8px; }
    body.dark-mode .ambient-popup { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .ambient-sound-btn { background: #1a1a1a; border-color: #444; }
    body.dark-mode .ambient-sound-btn:hover { border-color: #4285f4; background: #2d2d2d; }
    body.dark-mode .ambient-sound-btn.active { background: rgba(66, 133, 244, 0.2); }
    body.dark-mode .ambient-mix { border-color: #444; }

    /* Writing Goals */
    .writing-goal-bar {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 12px 20px;
      display: none;
      align-items: center;
      gap: 16px;
      z-index: 1000;
    }
    .writing-goal-bar.visible { display: flex; }
    .writing-goal-progress {
      width: 200px;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    .writing-goal-fill {
      height: 100%;
      background: linear-gradient(90deg, #1a73e8, #4285f4);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .writing-goal-text { font-size: 14px; color: #333; }
    .writing-goal-close { background: none; border: none; cursor: pointer; font-size: 18px; color: #999; }
    body.dark-mode .writing-goal-bar { background: #2d2d2d; }
    body.dark-mode .writing-goal-text { color: #e0e0e0; }
    body.dark-mode .writing-goal-progress { background: #444; }

    /* Reading Level Analyzer */
    .reading-level-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.25);
      padding: 24px;
      z-index: 100003;
      display: none;
      width: 450px;
    }
    .reading-level-popup.visible { display: block; }
    .reading-level-popup h3 { margin: 0 0 16px 0; font-size: 20px; }
    .reading-level-score {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, #e8f0fe, #f8f9fa);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .reading-level-grade {
      font-size: 48px;
      font-weight: 700;
      color: #1a73e8;
      line-height: 1;
    }
    .reading-level-label {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }
    .reading-level-meter {
      height: 12px;
      background: linear-gradient(90deg, #34a853 0%, #fbbc04 50%, #ea4335 100%);
      border-radius: 6px;
      position: relative;
      margin: 16px 0;
    }
    .reading-level-indicator {
      position: absolute;
      top: -4px;
      width: 20px;
      height: 20px;
      background: white;
      border: 3px solid #333;
      border-radius: 50%;
      transform: translateX(-50%);
      transition: left 0.3s ease;
    }
    .reading-level-scale {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #888;
      margin-bottom: 20px;
    }
    .reading-level-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .reading-stat {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .reading-stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    .reading-stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .reading-level-desc {
      margin-top: 16px;
      padding: 12px;
      background: #e8f0fe;
      border-radius: 8px;
      font-size: 13px;
      color: #1a73e8;
    }
    body.dark-mode .reading-level-popup { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .reading-level-score { background: linear-gradient(135deg, #1a3a5c, #2d2d2d); }
    body.dark-mode .reading-stat { background: #1a1a1a; }
    body.dark-mode .reading-stat-value { color: #e0e0e0; }
    body.dark-mode .reading-level-desc { background: rgba(66, 133, 244, 0.2); }

    /* Emoji Picker */
    .emoji-picker {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.25);
      width: 380px;
      max-height: 500px;
      z-index: 100003;
      display: none;
      flex-direction: column;
    }
    .emoji-picker.visible { display: flex; }
    .emoji-picker-header {
      padding: 16px;
      border-bottom: 1px solid #eee;
    }
    .emoji-picker-header h3 { margin: 0 0 12px 0; font-size: 18px; }
    .emoji-search {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }
    .emoji-search:focus { border-color: #1a73e8; }
    .emoji-categories {
      display: flex;
      gap: 4px;
      padding: 8px 16px;
      border-bottom: 1px solid #eee;
      overflow-x: auto;
    }
    .emoji-category-btn {
      padding: 8px 12px;
      border: none;
      background: #f1f3f4;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .emoji-category-btn:hover { background: #e8f0fe; }
    .emoji-category-btn.active { background: #1a73e8; color: white; }
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      padding: 12px;
      overflow-y: auto;
      max-height: 300px;
    }
    .emoji-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .emoji-btn:hover { background: #f1f3f4; transform: scale(1.2); }
    .emoji-recent {
      padding: 8px 16px;
      border-top: 1px solid #eee;
      font-size: 12px;
      color: #666;
    }
    .emoji-recent-label { margin-bottom: 8px; }
    .emoji-recent-grid {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    body.dark-mode .emoji-picker { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .emoji-picker-header { border-color: #444; }
    body.dark-mode .emoji-search { background: #1a1a1a; border-color: #444; color: #e0e0e0; }
    body.dark-mode .emoji-categories { border-color: #444; }
    body.dark-mode .emoji-category-btn { background: #3d3d3d; color: #e0e0e0; }
    body.dark-mode .emoji-category-btn:hover { background: #4d4d4d; }
    body.dark-mode .emoji-btn:hover { background: #3d3d3d; }
    body.dark-mode .emoji-recent { border-color: #444; }

    /* Format Painter */
    #formatPainterBtn.active {
      background: #1a73e8 !important;
      color: white !important;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .format-painter-cursor {
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ctext y='18' font-size='16'%3EüñåÔ∏è%3C/text%3E%3C/svg%3E") 0 20, crosshair !important;
    }
    /* Sticky Notes */
    .sticky-note {
      position: absolute;
      width: 200px;
      min-height: 100px;
      background: #fff9c4;
      border: 1px solid #fbc02d;
      border-radius: 4px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 12px;
    }
    .sticky-note.pink { background: #f8bbd9; border-color: #ec407a; }
    .sticky-note.blue { background: #bbdefb; border-color: #1e88e5; }
    .sticky-note.green { background: #c8e6c9; border-color: #43a047; }
    .sticky-note.orange { background: #ffe0b2; border-color: #fb8c00; }
    .sticky-note-header {
      padding: 4px 8px;
      background: rgba(0,0,0,0.05);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: #666;
    }
    .sticky-note-header .note-actions button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 4px;
      opacity: 0.6;
    }
    .sticky-note-header .note-actions button:hover { opacity: 1; }
    .sticky-note-content {
      padding: 8px;
      min-height: 60px;
      outline: none;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    .sticky-notes-panel {
      position: fixed;
      right: 10px;
      top: 200px;
      width: 220px;
      max-height: 400px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1001;
      display: none;
      overflow: hidden;
    }
    .sticky-notes-panel.visible { display: block; }
    .sticky-notes-panel-header {
      padding: 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sticky-notes-list {
      max-height: 300px;
      overflow-y: auto;
      padding: 8px;
    }
    .sticky-note-item {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      border-left: 3px solid #fbc02d;
      background: #fffde7;
    }
    .sticky-note-item:hover { background: #fff9c4; }
    .find-replace-bar { background: #fff3cd; padding: 0.5rem 1rem; display: none; align-items: center; gap: 0.5rem; border-bottom: 1px solid #ffc107; }
    .find-replace-bar input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; width: 150px; }
    .find-replace-bar .count { font-size: 0.85rem; color: #666; min-width: 60px; }
    .ruler { height: 25px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; align-items: flex-end; padding: 0 1in; }
    .ruler-mark { font-size: 9px; color: #666; border-left: 1px solid #999; padding-left: 2px; height: 10px; }
    .ruler-mark.major { height: 15px; font-weight: bold; }
    .page-number { position: absolute; bottom: 0.5in; width: 100%; text-align: center; font-size: 12px; color: #666; }
    .header-area { min-height: 0.5in; border-bottom: 1px dashed #ccc; margin-bottom: 0.25in; color: #666; font-size: 11px; }
    .footer-area { min-height: 0.5in; border-top: 1px dashed #ccc; margin-top: 0.25in; color: #666; font-size: 11px; }
    .highlight-find { background: #ffeb3b; }
    .highlight-current { background: #ff9800; color: white; }
    /* Style buttons */
    .style-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #ddd; background: #f9f9f9; border-radius: 3px; cursor: pointer; }
    .style-btn:hover { background: #e8f0fe; border-color: #1a73e8; }
    /* Navigation Pane */
    .navigation-pane { position: fixed; left: 0; top: 150px; width: 250px; height: calc(100vh - 200px); background: white; border-right: 1px solid #ddd; box-shadow: 2px 0 8px rgba(0,0,0,0.1); z-index: 100; overflow-y: auto; display: none; }
    .navigation-pane.visible { display: block; }
    .nav-pane-header { padding: 0.75rem 1rem; background: #f5f5f5; border-bottom: 1px solid #ddd; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .nav-pane-tabs { display: flex; border-bottom: 1px solid #ddd; }
    .nav-pane-tab { flex: 1; padding: 0.5rem; text-align: center; cursor: pointer; font-size: 0.85rem; border-bottom: 2px solid transparent; }
    .nav-pane-tab.active { border-bottom-color: #1a73e8; color: #1a73e8; }
    .nav-pane-content { padding: 0.5rem; }
    .nav-item { padding: 0.5rem; cursor: pointer; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    .nav-item:hover { background: #e8f0fe; }
    .nav-item.h1 { font-weight: bold; font-size: 1rem; }
    .nav-item.h2 { padding-left: 1rem; }
    .nav-item.h3 { padding-left: 1.5rem; font-size: 0.85rem; color: #666; }
    /* Styles Gallery */
    .styles-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .style-preview { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; }
    .style-preview:hover { border-color: #1a73e8; background: #e8f0fe; }
    .style-preview.selected { border-color: #1a73e8; background: #e8f0fe; }
    /* Line Numbers */
    .line-numbers-gutter {
      position: absolute;
      left: 0;
      top: 0;
      width: 40px;
      background: #f9f9f9;
      border-right: 1px solid #ddd;
      padding: 1in 0;
      text-align: right;
      font-family: monospace;
      font-size: 10px;
      color: #999;
      line-height: 1.5;
      display: none;
    }
    .line-numbers-gutter.visible { display: block; }
    .line-numbers-gutter .line-num {
      padding-right: 8px;
      height: 1.5em;
    }
    .document-area.with-line-numbers {
      margin-left: 50px;
    }
    /* Dark Mode */
    body.dark-mode {
      background: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .app-container {
      background: #1e1e1e;
    }
    body.dark-mode .app-header {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .ribbon {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .ribbon-tab {
      color: #cccccc;
    }
    body.dark-mode .ribbon-tab.active {
      background: #3c3c3c;
      color: #ffffff;
    }
    body.dark-mode .toolbar {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .toolbar-btn {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .toolbar-btn:hover {
      background: #505050;
      color: #ffffff;
    }
    body.dark-mode .toolbar-select {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .document-area {
      background: #2d2d2d;
    }
    body.dark-mode .document-page {
      background: #1e1e1e;
      color: #e0e0e0;
      border-color: #3c3c3c;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    body.dark-mode .ruler {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .ruler-mark {
      color: #999;
      border-color: #666;
    }
    body.dark-mode .status-bar {
      background: #007acc;
      color: #ffffff;
    }
    body.dark-mode .dropdown-menu {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .dropdown-item {
      color: #cccccc;
    }
    body.dark-mode .dropdown-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .file-name {
      background: #3c3c3c;
      color: #cccccc;
      border-color: #505050;
    }
    body.dark-mode .modal-content {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    body.dark-mode .modal-content input,
    body.dark-mode .modal-content select,
    body.dark-mode .modal-content textarea {
      background: #3c3c3c;
      color: #e0e0e0;
      border-color: #505050;
    }
    body.dark-mode .navigation-pane {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .nav-pane-header {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .nav-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .find-replace-bar {
      background: #3c3c3c;
      border-color: #505050;
    }
    body.dark-mode .line-numbers-gutter {
      background: #252526;
      border-color: #3c3c3c;
      color: #666;
    }
    body.dark-mode .header-area,
    body.dark-mode .footer-area {
      border-color: #505050;
      color: #888;
    }
    body.dark-mode .toast {
      background: #3c3c3c;
      color: #e0e0e0;
    }
    /* Outline View */
    .outline-panel {
      position: fixed;
      left: 0;
      top: 150px;
      width: 320px;
      height: calc(100vh - 200px);
      background: white;
      border-right: 1px solid #ddd;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      z-index: 100;
      overflow-y: auto;
      display: none;
    }
    .outline-panel.visible { display: block; }
    .outline-header {
      padding: 0.75rem 1rem;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .outline-toolbar {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      background: #f9f9f9;
      border-bottom: 1px solid #eee;
    }
    .outline-toolbar button {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      border: 1px solid #ddd;
      background: white;
      border-radius: 3px;
      cursor: pointer;
    }
    .outline-toolbar button:hover { background: #e8f0fe; }
    .outline-content { padding: 0.5rem; }
    .outline-item {
      padding: 0.4rem 0.5rem;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
    }
    .outline-item:hover { background: #e8f0fe; }
    .outline-item.selected { background: #c8dcf8; }
    .outline-item.dragging { opacity: 0.5; background: #fff3cd; }
    .outline-item .collapse-btn {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
    }
    .outline-item .collapse-btn:empty { width: 16px; }
    .outline-item.collapsed .children { display: none; }
    .outline-item .level-indicator {
      font-size: 0.7rem;
      color: #666;
      background: #eee;
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
    }
    .outline-item .text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .outline-item.h1 { font-weight: bold; font-size: 1rem; }
    .outline-item.h2 { padding-left: 1.25rem; font-size: 0.95rem; }
    .outline-item.h3 { padding-left: 2rem; font-size: 0.9rem; color: #444; }
    .outline-item.h4 { padding-left: 2.75rem; font-size: 0.85rem; color: #666; }
    .outline-item.body-text { padding-left: 3.5rem; font-size: 0.8rem; color: #888; font-style: italic; }
    .outline-drop-zone {
      height: 4px;
      background: transparent;
      margin: 2px 0;
      border-radius: 2px;
      transition: background 0.2s;
    }
    .outline-drop-zone.active { background: #1a73e8; }
    body.dark-mode .outline-panel {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .outline-header {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .outline-toolbar {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .outline-toolbar button {
      background: #3c3c3c;
      color: #ccc;
      border-color: #505050;
    }
    body.dark-mode .outline-item:hover { background: #3c3c3c; }
    body.dark-mode .outline-item.selected { background: #264f78; }
    /* Reading Progress Bar */
    .reading-progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 0%;
      height: 4px;
      background: linear-gradient(90deg, #1a73e8, #34a853);
      z-index: 9999;
      transition: width 0.3s ease;
    }
    .reading-progress-info {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 200px;
      display: none;
    }
    .reading-progress-info.visible { display: block; }
    .reading-progress-info h4 {
      margin: 0 0 0.75rem 0;
      font-size: 0.9rem;
      color: var(--secondary);
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    .reading-stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    .reading-stat label { color: var(--secondary); }
    .reading-stat span { font-weight: 500; color: #333; }
    body.dark-mode .reading-progress-info {
      background: #252526;
      border-color: #3c3c3c;
    }
    body.dark-mode .reading-stat span { color: #e0e0e0; }
    /* Focus Mode */
    body.focus-mode .app-header,
    body.focus-mode .ribbon,
    body.focus-mode .toolbar,
    body.focus-mode .status-bar,
    body.focus-mode .navigation-pane,
    body.focus-mode .outline-panel,
    body.focus-mode .find-replace-bar,
    body.focus-mode .ruler {
      display: none !important;
    }
    body.focus-mode .document-area {
      margin: 0 !important;
      padding: 2rem;
      background: #f5f0e8;
      min-height: 100vh;
    }
    body.focus-mode .document-page {
      max-width: 700px;
      margin: 0 auto;
      padding: 3rem;
      box-shadow: none;
      border: none;
      background: #f5f0e8;
      font-size: 1.2rem;
      line-height: 1.8;
    }
    body.focus-mode.dark-mode .document-area {
      background: #1a1a1a;
    }
    body.focus-mode.dark-mode .document-page {
      background: #1a1a1a;
      color: #d4d4d4;
    }
    .focus-mode-bar {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 30px;
      display: none;
      align-items: center;
      gap: 1rem;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    body.focus-mode .focus-mode-bar { display: flex; }
    .focus-mode-bar button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .focus-mode-bar button:hover { background: rgba(255,255,255,0.3); }
    /* Read Aloud highlight */
    .read-aloud-highlight {
      background: #ffeb3b;
      border-radius: 2px;
      transition: background 0.2s;
    }
    body.dark-mode .read-aloud-highlight {
      background: #ffc107;
      color: #000;
    }
    /* Keyboard Shortcuts Styles */
    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    .shortcuts-section h4 {
      margin: 0 0 0.75rem 0;
      color: #1a73e8;
      font-size: 0.95rem;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 0.5rem;
    }
    .shortcut-item {
      display: flex;
      align-items: center;
      padding: 0.4rem 0;
      font-size: 0.85rem;
    }
    .shortcut-item kbd {
      background: #f1f3f4;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      margin: 0 0.25rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .shortcut-item span {
      margin-left: auto;
      color: #666;
    }
    body.dark-mode .shortcuts-section h4 {
      color: #4da3ff;
      border-color: #3c3c3c;
    }
    body.dark-mode .shortcut-item kbd {
      background: #3c3c3c;
      border-color: #505050;
      color: #ccc;
    }
    body.dark-mode .shortcut-item span { color: #999; }
    /* Table Grid Selector */
    .table-grid-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    .table-grid {
      display: grid;
      grid-template-columns: repeat(10, 24px);
      grid-template-rows: repeat(8, 24px);
      gap: 2px;
      margin-bottom: 1rem;
    }
    .table-grid-cell {
      width: 24px;
      height: 24px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      transition: background 0.1s;
    }
    .table-grid-cell.highlighted {
      background: #cce5ff;
      border-color: #1a73e8;
    }
    .table-grid-cell:hover {
      background: #e3f2fd;
    }
    .table-size-display {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1rem;
    }
    .table-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      width: 100%;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    body.dark-mode .table-grid-cell {
      border-color: #555;
      background: #2d2d2d;
    }
    body.dark-mode .table-grid-cell.highlighted {
      background: #1a4a7a;
      border-color: #4da3ff;
    }
    body.dark-mode .table-grid-cell:hover {
      background: #3d5a80;
    }
    body.dark-mode .table-size-display { color: #999; }
    body.dark-mode .table-options { border-color: #444; }
    /* Submenu styles */
    .submenu-parent {
      position: relative;
    }
    .submenu {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 220px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1001;
    }
    .submenu.show {
      display: block;
    }
    .submenu-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .submenu-item:hover {
      background: #f0f0f0;
    }
    .submenu-item .file-date {
      font-size: 0.75rem;
      color: #888;
    }
    .submenu-empty {
      padding: 12px;
      color: #888;
      font-style: italic;
      text-align: center;
    }
    body.dark-mode .submenu {
      background: #2d2d2d;
      border-color: #444;
    }
    body.dark-mode .submenu-item:hover {
      background: #3c3c3c;
    }
    body.dark-mode .submenu-item .file-date {
      color: #888;
    }
    /* Symbol Picker Styles */
    .symbol-grid {
      display: grid;
      grid-template-columns: repeat(16, 1fr);
      gap: 2px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px;
      background: #fafafa;
    }
    .symbol-btn {
      width: 32px;
      height: 32px;
      border: 1px solid transparent;
      background: white;
      cursor: pointer;
      font-size: 1.1rem;
      border-radius: 4px;
      transition: all 0.15s;
    }
    .symbol-btn:hover {
      background: #e3f2fd;
      border-color: #1a73e8;
    }
    .symbol-category-tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .symbol-category-tab {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .symbol-category-tab.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }
    .symbol-preview {
      text-align: center;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .symbol-preview-char {
      font-size: 3rem;
      line-height: 1;
    }
    .symbol-preview-info {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }
    body.dark-mode .symbol-grid { background: #1e1e1e; border-color: #444; }
    body.dark-mode .symbol-btn { background: #2d2d2d; color: #e0e0e0; }
    body.dark-mode .symbol-btn:hover { background: #3d5a80; }
    body.dark-mode .symbol-category-tab { background: #2d2d2d; border-color: #444; color: #ccc; }
    body.dark-mode .symbol-category-tab.active { background: #1a73e8; color: white; }
    body.dark-mode .symbol-preview { background: #2d2d2d; }
    body.dark-mode .symbol-preview-info { color: #999; }
    /* Quick Parts */
    .quickparts-category {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s;
    }
    .quickparts-category:last-child { border-bottom: none; }
    .quickparts-category:hover { background: #f0f0f0; }
    .quickparts-category.active {
      background: #1a73e8;
      color: white;
    }
    .quickpart-item {
      padding: 12px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quickpart-item:hover {
      border-color: #1a73e8;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .quickpart-item.selected {
      border-color: #1a73e8;
      background: #e3f2fd;
    }
    .quickpart-item-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .quickpart-item-preview {
      font-size: 0.75rem;
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .quickpart-item-actions {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    .quickpart-item-actions button {
      padding: 2px 8px;
      font-size: 0.7rem;
    }
    body.dark-mode .quickparts-category { border-color: #444; }
    body.dark-mode .quickparts-category:hover { background: #333; }
    body.dark-mode .quickpart-item { background: #2d2d2d; border-color: #444; }
    body.dark-mode .quickpart-item:hover { border-color: #1a73e8; }
    body.dark-mode .quickpart-item.selected { background: #1a3a5c; }
    body.dark-mode .quickpart-item-preview { color: #999; }
    /* Document Inspector */
    .inspector-item {
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }
    .inspector-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .inspector-result {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 0.85rem;
      display: none;
    }
    .inspector-result.found {
      display: block;
      background: #fff3cd;
      border-left: 3px solid #ffc107;
    }
    .inspector-result.clean {
      display: block;
      background: #d4edda;
      border-left: 3px solid #28a745;
    }
    body.dark-mode .inspector-item { border-color: #444; }
    body.dark-mode .inspector-result { background: #2d2d2d; }
    body.dark-mode .inspector-result.found { background: #3d3520; }
    body.dark-mode .inspector-result.clean { background: #1d3d2d; }
    /* Digital Signature */
    .signature-type-btn.active {
      background: #1a73e8 !important;
      color: white !important;
    }
    .signature-panel { margin-top: 1rem; }
    .digital-signature-block {
      display: inline-block;
      padding: 1rem;
      border: 2px solid #1a73e8;
      border-radius: 8px;
      background: linear-gradient(to bottom, #f8f9fa 0%, #fff 100%);
      margin: 1rem 0;
      min-width: 250px;
    }
    .digital-signature-block .sig-image {
      max-height: 80px;
      display: block;
      margin-bottom: 0.5rem;
    }
    .digital-signature-block .sig-info {
      font-size: 0.85rem;
      border-top: 1px solid #ddd;
      padding-top: 0.5rem;
      color: #333;
    }
    .digital-signature-block .sig-name {
      font-weight: 600;
    }
    .digital-signature-block .sig-title {
      color: #666;
      font-style: italic;
    }
    .digital-signature-block .sig-date {
      font-size: 0.75rem;
      color: #999;
      margin-top: 4px;
    }
    .digital-signature-block .sig-verification {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: #28a745;
      margin-top: 4px;
    }
    /* Reading Mode */
    .reading-mode-overlay {
      position: fixed;
      inset: 0;
      background: #f5f0e6;
      z-index: 2000;
      display: none;
      flex-direction: column;
    }
    .reading-mode-overlay.active { display: flex; }
    .reading-mode-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.05);
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .reading-mode-content {
      flex: 1;
      overflow-y: auto;
      padding: 3rem;
      display: flex;
      justify-content: center;
    }
    .reading-mode-text {
      max-width: 700px;
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 1.2rem;
      line-height: 1.8;
      color: #333;
    }
    .reading-mode-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .reading-mode-controls button {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(0,0,0,0.2);
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .reading-mode-controls button:hover { background: #f0f0f0; }
    .reading-mode-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: #1a73e8;
      transition: width 0.1s;
      z-index: 2001;
    }
    .reading-mode-overlay.sepia { background: #f5f0e6; }
    .reading-mode-overlay.sepia .reading-mode-text { color: #5c4b37; }
    .reading-mode-overlay.dark { background: #1e1e1e; }
    .reading-mode-overlay.dark .reading-mode-text { color: #e0e0e0; }
    .reading-mode-overlay.dark .reading-mode-header { background: rgba(255,255,255,0.05); border-color: #333; }
    .reading-mode-overlay.dark .reading-mode-controls button { background: #333; color: #e0e0e0; border-color: #555; }
    /* Quick Access Toolbar */
    .quick-access-toolbar {
      background: #f0f0f0;
      padding: 2px 8px;
      display: flex;
      align-items: center;
      gap: 2px;
      border-bottom: 1px solid #ddd;
      font-size: 0.75rem;
    }
    .quick-access-toolbar .qat-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 3px;
      font-size: 14px;
      opacity: 0.8;
    }
    .quick-access-toolbar .qat-btn:hover {
      background: #e0e0e0;
      opacity: 1;
    }
    .quick-access-toolbar .qat-separator {
      width: 1px;
      height: 16px;
      background: #ccc;
      margin: 0 4px;
    }
    .quick-access-toolbar .qat-customize {
      margin-left: auto;
      font-size: 10px;
      color: #666;
    }
    body.dark-mode .quick-access-toolbar {
      background: #2d2d2d;
      border-color: #3c3c3c;
    }
    body.dark-mode .quick-access-toolbar .qat-btn:hover {
      background: #3c3c3c;
    }
    body.dark-mode .quick-access-toolbar .qat-separator {
      background: #555;
    }
    /* QAT Customization Modal */
    .qat-modal-items {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.5rem;
    }
    .qat-modal-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .qat-modal-item:hover {
      background: #e8f0fe;
    }
    .qat-modal-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    /* Focus Mode */
    .focus-mode-active .document-area {
      transition: all 0.3s ease;
    }
    .focus-mode-active .app-header,
    .focus-mode-active .toolbar,
    .focus-mode-active .quick-access-toolbar,
    .focus-mode-active .status-bar {
      opacity: 0.15;
      transition: opacity 0.3s ease;
    }
    .focus-mode-active .app-header:hover,
    .focus-mode-active .toolbar:hover,
    .focus-mode-active .quick-access-toolbar:hover,
    .focus-mode-active .status-bar:hover {
      opacity: 1;
    }
    .focus-mode-active .document-content p,
    .focus-mode-active .document-content div,
    .focus-mode-active .document-content li {
      opacity: 0.3;
      transition: opacity 0.2s ease;
    }
    .focus-mode-active .document-content p.focus-current,
    .focus-mode-active .document-content div.focus-current,
    .focus-mode-active .document-content li.focus-current {
      opacity: 1;
    }
    .focus-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(26, 115, 232, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.75rem;
      z-index: 10001;
      display: none;
      align-items: center;
      gap: 6px;
    }
    .focus-indicator.visible {
      display: flex;
    }
    .focus-indicator-dot {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: focusPulse 2s infinite;
    }
    @keyframes focusPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Typewriter Mode */
    .typewriter-mode-active .document-content {
      padding-top: 45vh !important;
      padding-bottom: 45vh !important;
    }
    .typewriter-indicator {
      position: fixed;
      bottom: 60px;
      right: 10px;
      background: rgba(52, 168, 83, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.75rem;
      z-index: 10001;
      display: none;
      align-items: center;
      gap: 6px;
    }
    .typewriter-indicator.visible {
      display: flex;
    }

    /* Word Frequency Analyzer */
    .word-freq-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      padding: 0;
      z-index: 100003;
      display: none;
      width: 420px;
      max-height: 80vh;
      overflow: hidden;
    }
    .word-freq-popup.visible { display: block; }
    .word-freq-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .word-freq-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #202124;
    }
    .word-freq-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #5f6368;
      line-height: 1;
    }
    .word-freq-content {
      padding: 16px 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .word-freq-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .word-freq-stat {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .word-freq-stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a73e8;
    }
    .word-freq-stat-label {
      font-size: 0.7rem;
      color: #5f6368;
      text-transform: uppercase;
    }
    .word-freq-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .word-freq-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f3f4;
    }
    .word-freq-rank {
      width: 28px;
      height: 28px;
      background: #e8f0fe;
      color: #1a73e8;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 12px;
    }
    .word-freq-word {
      flex: 1;
      font-weight: 500;
    }
    .word-freq-count {
      color: #5f6368;
      font-size: 0.85rem;
    }
    .word-freq-bar {
      width: 80px;
      height: 6px;
      background: #e8f0fe;
      border-radius: 3px;
      margin-left: 12px;
      overflow: hidden;
    }
    .word-freq-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #1a73e8, #4285f4);
      border-radius: 3px;
    }
    .word-freq-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .word-freq-tab {
      padding: 6px 12px;
      border: 1px solid #dadce0;
      border-radius: 16px;
      background: white;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .word-freq-tab.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }
    body.dark-mode .word-freq-popup {
      background: #292a2d;
    }
    body.dark-mode .word-freq-header {
      border-color: #3c4043;
    }
    body.dark-mode .word-freq-header h3 {
      color: #e8eaed;
    }
    body.dark-mode .word-freq-stat {
      background: #3c4043;
    }
    body.dark-mode .word-freq-stat-label {
      color: #9aa0a6;
    }
    body.dark-mode .word-freq-item {
      border-color: #3c4043;
    }
    body.dark-mode .word-freq-word {
      color: #e8eaed;
    }
    body.dark-mode .word-freq-tab {
      background: #3c4043;
      border-color: #3c4043;
      color: #e8eaed;
    }

    /* Distraction-Free Mode */
    .distraction-free-mode {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 100000 !important;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10vh;
    }
    .distraction-free-mode .df-editor {
      width: 100%;
      max-width: 700px;
      min-height: 70vh;
      padding: 2rem;
      font-size: 1.2rem;
      line-height: 1.8;
      border: none;
      outline: none;
      background: transparent;
      color: #333;
      font-family: 'Georgia', serif;
    }
    .distraction-free-mode .df-editor:focus {
      outline: none;
    }
    .distraction-free-mode .df-stats {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .distraction-free-mode:hover .df-stats {
      opacity: 1;
    }
    .distraction-free-mode .df-exit {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .distraction-free-mode:hover .df-exit {
      opacity: 1;
    }
    .distraction-free-mode .df-exit:hover {
      background: rgba(0,0,0,0.7);
    }
    .distraction-free-mode.df-dark {
      background: #1a1a1a;
    }
    .distraction-free-mode.df-dark .df-editor {
      color: #e0e0e0;
    }
    .distraction-free-mode.df-sepia {
      background: #f4ecd8;
    }
    .distraction-free-mode.df-sepia .df-editor {
      color: #5b4636;
    }
    .df-theme-switcher {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .distraction-free-mode:hover .df-theme-switcher {
      opacity: 1;
    }
    .df-theme-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .df-theme-btn:hover {
      transform: scale(1.1);
    }
    .df-theme-btn.active {
      border-color: #1a73e8;
    }
    .df-theme-btn.light { background: #fafafa; border-color: #ccc; }
    .df-theme-btn.dark { background: #1a1a1a; }
    .df-theme-btn.sepia { background: #f4ecd8; }

    /* Smart Text Replacements */
    .smart-text-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      padding: 0;
      z-index: 100003;
      display: none;
      width: 380px;
    }
    .smart-text-popup.visible { display: block; }
    .smart-text-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .smart-text-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    .smart-text-content {
      padding: 16px 20px;
    }
    .smart-text-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f1f3f4;
    }
    .smart-text-option:last-child {
      border-bottom: none;
    }
    .smart-text-label {
      display: flex;
      flex-direction: column;
    }
    .smart-text-label span {
      font-weight: 500;
    }
    .smart-text-label small {
      color: #666;
      font-size: 0.75rem;
      margin-top: 2px;
    }
    .smart-text-toggle {
      position: relative;
      width: 44px;
      height: 24px;
    }
    .smart-text-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .smart-text-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 24px;
    }
    .smart-text-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .smart-text-toggle input:checked + .smart-text-slider {
      background-color: #1a73e8;
    }
    .smart-text-toggle input:checked + .smart-text-slider:before {
      transform: translateX(20px);
    }
    .smart-text-indicator {
      position: fixed;
      bottom: 100px;
      right: 10px;
      background: rgba(26, 115, 232, 0.9);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      z-index: 1000;
      display: none;
      animation: smartTextFade 1.5s forwards;
    }
    @keyframes smartTextFade {
      0%, 70% { opacity: 1; }
      100% { opacity: 0; }
    }
    body.dark-mode .smart-text-popup {
      background: #292a2d;
    }
    body.dark-mode .smart-text-header {
      border-color: #3c4043;
    }
    body.dark-mode .smart-text-option {
      border-color: #3c4043;
    }
    body.dark-mode .smart-text-label small {
      color: #9aa0a6;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Quick Access Toolbar -->
    <div class="quick-access-toolbar" id="quickAccessToolbar">
      <button class="qat-btn" onclick="saveDocument()" title="Save (Ctrl+S)">üíæ</button>
      <button class="qat-btn" onclick="formatDoc('undo')" title="Undo (Ctrl+Z)">‚Ü∂</button>
      <button class="qat-btn" onclick="formatDoc('redo')" title="Redo (Ctrl+Y)">‚Ü∑</button>
      <span class="qat-separator"></span>
      <button class="qat-btn" onclick="exportPDF()" title="Export PDF">üìÑ</button>
      <button class="qat-btn" onclick="window.print()" title="Print (Ctrl+P)">üñ®Ô∏è</button>
      <button class="qat-btn qat-customize" onclick="showQATCustomization()" title="Customize Quick Access Toolbar">‚ñº Customize</button>
    </div>

    <!-- Header -->
    <div class="app-header">
      <a href="index.html" class="app-logo">
        <div class="app-logo-icon word">W</div>
        <span class="app-title">NinjaWord</span>
      </a>
      <input type="text" class="file-name" id="fileName" value="Untitled Document">
      <div class="header-actions">
        <div class="dropdown">
          <button class="btn btn-secondary" onclick="toggleFileMenu()">üìÅ File ‚ñæ</button>
          <div class="dropdown-menu" id="fileMenu">
            <div class="dropdown-item" onclick="newDocument()">üìÑ New</div>
            <div class="dropdown-item" onclick="showOpenDialog()">üìÇ Open...</div>
            <div class="dropdown-item" onclick="saveDocument()">üíæ Save</div>
            <div class="dropdown-item" onclick="saveDocumentAs()">üíæ Save As...</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item submenu-parent" onclick="toggleRecentFiles(event)">
              üïí Recent Files ‚ñ∏
              <div class="submenu" id="recentFilesMenu"></div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="exportToFile()">üì§ Export as File</div>
            <div class="dropdown-item" onclick="importFromFile()">üì• Import from File</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="importDocx()">üìÑ Import DOCX</div>
            <div class="dropdown-item" onclick="exportDocx()">üìÑ Export DOCX</div>
            <div class="dropdown-item" onclick="exportHTML()">üåê Export HTML</div>
            <div class="dropdown-item" onclick="exportMarkdown()">üìù Export Markdown</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="showDocumentInspector()">üîç Document Inspector</div>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="showFindReplace()">üîç Find</button>
        <button class="btn btn-secondary" onclick="showTemplates()">Templates</button>
        <button class="btn btn-secondary" onclick="showRecentDocuments()">üìÇ Recent</button>
        <button class="btn btn-secondary" onclick="showMailMerge()">Mail Merge</button>
        <button class="btn btn-secondary" onclick="showEnvelopesLabels()">‚úâ Envelopes</button>
        <button class="btn btn-primary" onclick="exportPDF()">Export PDF</button>
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
          <span class="zoom-display" id="zoomLevel">100%</span>
          <button class="zoom-btn" onclick="zoomIn()">+</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tab-container">
      <button class="tab active" data-tab="home">Home</button>
      <button class="tab" data-tab="insert">Insert</button>
      <button class="tab" data-tab="review">Review</button>
      <button class="tab" data-tab="view">View</button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="homeToolbar">
      <div class="toolbar-group">
        <select class="toolbar-select" id="fontFamily" onchange="formatDoc('fontName', this.value)">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Georgia">Georgia</option>
          <option value="Verdana">Verdana</option>
          <option value="Courier New">Courier New</option>
          <option value="Comic Sans MS">Comic Sans MS</option>
        </select>
        <select class="toolbar-select" id="fontSize" onchange="formatDoc('fontSize', this.value)">
          <option value="1">8</option>
          <option value="2">10</option>
          <option value="3" selected>12</option>
          <option value="4">14</option>
          <option value="5">18</option>
          <option value="6">24</option>
          <option value="7">36</option>
        </select>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
        <button class="toolbar-btn" onclick="formatDoc('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
        <button class="toolbar-btn" onclick="formatDoc('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
        <button class="toolbar-btn" onclick="applyDoubleUnderline()" title="Double Underline"><span style="text-decoration: underline; text-decoration-style: double;">U</span></button>
        <button class="toolbar-btn" onclick="formatDoc('strikeThrough')" title="Strikethrough"><s>S</s></button>
        <button class="toolbar-btn" onclick="formatDoc('subscript')" title="Subscript">X<sub>2</sub></button>
        <button class="toolbar-btn" onclick="formatDoc('superscript')" title="Superscript">X<sup>2</sup></button>
        <button class="toolbar-btn" onclick="applySmallCaps()" title="Small Caps" style="font-variant: small-caps;">Sc</button>
        <button class="toolbar-btn" onclick="showChangeCaseMenu(event)" title="Change Case">Aa</button>
      </div>

      <div class="toolbar-group">
        <input type="color" class="color-picker-btn" id="textColor" value="#000000" onchange="formatDoc('foreColor', this.value)" title="Text Color">
        <input type="color" class="color-picker-btn" id="bgColor" value="#ffffff" onchange="formatDoc('hiliteColor', this.value)" title="Highlight">
        <button class="toolbar-btn" onclick="showHighlightPalette(event)" title="Highlight Colors">üñçÔ∏è</button>
        <button class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">üßπ</button>
        <button class="toolbar-btn" onclick="toggleFormatPainter()" id="formatPainterBtn" title="Format Painter (Copy formatting)">üñåÔ∏è</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('justifyLeft')" title="Align Left">‚â°</button>
        <button class="toolbar-btn" onclick="formatDoc('justifyCenter')" title="Center">‚â°</button>
        <button class="toolbar-btn" onclick="formatDoc('justifyRight')" title="Align Right">‚â°</button>
        <button class="toolbar-btn" onclick="formatDoc('justifyFull')" title="Justify">‚â°</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('insertUnorderedList')" title="Bullet List">‚Ä¢</button>
        <button class="toolbar-btn" onclick="formatDoc('insertOrderedList')" title="Numbered List">#</button>
        <button class="toolbar-btn" onclick="formatDoc('outdent')" title="Decrease Indent">‚Üê</button>
        <button class="toolbar-btn" onclick="formatDoc('indent')" title="Increase Indent">‚Üí</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showParagraphBorders(event)" title="Paragraph Borders">‚äû Borders</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="formatDoc('undo')" title="Undo (Ctrl+Z)">‚Ü∂</button>
        <button class="toolbar-btn" onclick="formatDoc('redo')" title="Redo (Ctrl+Y)">‚Ü∑</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" id="trackChangesBtn" onclick="toggleTrackChanges()" title="Track Changes">üìù</button>
        <button class="toolbar-btn" onclick="runSpellCheck()" title="Spell Check">ABC</button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleDictation()" title="Dictation (Voice Input)" id="dictationBtn">üé§ Dictate</button>
      </div>

      <div class="toolbar-group" id="stylesGroup" style="gap: 0.25rem;">
        <button class="style-btn" onclick="applyStyle('normal')" title="Normal">Normal</button>
        <button class="style-btn" onclick="applyStyle('heading1')" title="Heading 1">H1</button>
        <button class="style-btn" onclick="applyStyle('heading2')" title="Heading 2">H2</button>
        <button class="style-btn" onclick="applyStyle('heading3')" title="Heading 3">H3</button>
        <button class="style-btn" onclick="applyStyle('title')" title="Title">Title</button>
        <button class="style-btn" onclick="applyStyle('subtitle')" title="Subtitle">Sub</button>
        <button class="toolbar-btn" onclick="showStylesGallery()" title="More Styles">‚ñæ Styles</button>
      </div>
    </div>

    <!-- Insert Toolbar -->
    <div class="toolbar" id="insertToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertTable()" title="Insert Table">‚äû</button>
        <button class="toolbar-btn" onclick="insertImage()" title="Insert Image">üñº</button>
        <button class="toolbar-btn" onclick="showStockImages()" title="Stock Images">üåê Stock Images</button>
        <button class="toolbar-btn" onclick="insertScreenshot()" title="Screenshot">üì∏ Screenshot</button>
        <button class="toolbar-btn" onclick="insertLink()" title="Insert Link">üîó</button>
        <button class="toolbar-btn" onclick="insertHorizontalRule()" title="Horizontal Line">‚Äî</button>
        <button class="toolbar-btn" onclick="showTextBoxModal()" title="Insert Text Box">üì¶ Text Box</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertTableOfContents()" title="Table of Contents">üìë TOC</button>
        <button class="toolbar-btn" onclick="insertFootnote()" title="Insert Footnote">¬π Footnote</button>
        <button class="toolbar-btn" onclick="insertBookmark()" title="Insert Bookmark">üîñ Bookmark</button>
        <button class="toolbar-btn" onclick="showIndexModal()" title="Index">üìá Index</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertPageBreak()" title="Page Break">üìÑ Page</button>
        <button class="toolbar-btn" onclick="insertSectionBreak()" title="Section Break">¬ß Section</button>
        <button class="toolbar-btn" onclick="insertDateTime()" title="Date/Time">üìÖ</button>
        <button class="toolbar-btn" onclick="insertWatermark()" title="Insert Watermark">üíß Watermark</button>
        <button class="toolbar-btn" onclick="setColumns(event)" title="Columns">‚´º Columns</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showPageBorders()" title="Page Borders">‚ñ¢ Borders</button>
        <button class="toolbar-btn" onclick="showPageColor(event)" title="Page Color">üé® Page Color</button>
        <button class="toolbar-btn" onclick="insertDropCap()" title="Drop Cap">D</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showWordArt()" title="Word Art">üé® Word Art</button>
        <button class="toolbar-btn" onclick="showEquationEditor()" title="Equation">‚àë Equation</button>
        <button class="toolbar-btn" onclick="showSmartArt()" title="Smart Art">üìä Smart Art</button>
        <button class="toolbar-btn" onclick="showSymbolPicker()" title="Insert Symbol">Œ© Symbol</button>
        <button class="toolbar-btn" onclick="showEmojiPicker()" title="Insert Emoji">üòÄ Emoji</button>
        <button class="toolbar-btn" onclick="showQuickParts()" title="Quick Parts / AutoText">üìã Quick Parts</button>
        <button class="toolbar-btn" onclick="showQRCodeGenerator()" title="QR Code">‚ñ£ QR Code</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertMergeField('FirstName')" title="First Name Field">{{First}}</button>
        <button class="toolbar-btn" onclick="insertMergeField('LastName')" title="Last Name Field">{{Last}}</button>
      </div>
    </div>

    <!-- Review Toolbar -->
    <div class="toolbar" id="reviewToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="runSpellCheck()" title="Spell Check">üî§ Spell Check</button>
        <button class="toolbar-btn" onclick="showThesaurus()" title="Thesaurus">üìñ Thesaurus</button>
        <button class="toolbar-btn" onclick="runGrammarCheck()" title="Grammar Check">üìù Grammar</button>
        <button class="toolbar-btn active" id="autoCorrectBtn" onclick="toggleAutoCorrect()" title="Auto-Correct">‚ú® Auto-Correct</button>
        <button class="toolbar-btn" onclick="showSmartText()" title="Smart Text Replacements">üîÑ Smart Text</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" id="trackChangesBtn2" onclick="toggleTrackChanges()" title="Track Changes">üìù Track Changes</button>
        <button class="toolbar-btn" onclick="acceptAllChanges()" title="Accept All">‚úì Accept All</button>
        <button class="toolbar-btn" onclick="rejectAllChanges()" title="Reject All">‚úó Reject All</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="addComment()" title="New Comment">üí¨ Comment</button>
        <button class="toolbar-btn" onclick="addStickyNote()" title="Add Sticky Note">üìå Sticky Note</button>
        <button class="toolbar-btn" onclick="toggleStickyNotesPanel()" title="View All Notes">üìã Notes Panel</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showCompareDocuments()" title="Compare Documents">‚öñ Compare</button>
        <button class="toolbar-btn" onclick="showRevisionHistory()" title="Revision History">üìú History</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showWordCount()" title="Word Count">üìä Word Count</button>
        <button class="toolbar-btn" onclick="showTranslate()" title="Translate">üåê Translate</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showDigitalSignature()" title="Digital Signature">‚úçÔ∏è Signature</button>
        <button class="toolbar-btn" onclick="showRestrictEditing()" title="Restrict Editing" id="restrictEditBtn">üîí Restrict</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showAccessibilityChecker()" title="Accessibility Checker">‚ôø Accessibility</button>
      </div>
    </div>

    <!-- View Toolbar -->
    <div class="toolbar" id="viewToolbar" style="display: none;">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleRuler()" title="Toggle Ruler">üìè Ruler</button>
        <button class="toolbar-btn" onclick="showPageSetup()" title="Page Setup">üìÑ Page Setup</button>
        <button class="toolbar-btn" onclick="toggleHeaderFooter()" title="Edit Header/Footer">üìù Header/Footer</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleNavigationPane()" title="Navigation Pane" id="navPaneBtn">üìë Navigation</button>
        <button class="toolbar-btn" onclick="toggleOutlineView()" title="Outline View" id="outlineViewBtn">‚â° Outline</button>
        <button class="toolbar-btn" onclick="showAdvancedFind()" title="Advanced Find & Replace">üîç Advanced Find</button>
        <button class="toolbar-btn" onclick="showFindFormatting()" title="Find Formatting">üé® Find Format</button>
        <button class="toolbar-btn" onclick="toggleUndoHistory()" title="Undo History">‚Ü∂ History</button>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Line Spacing:</span>
        <select class="toolbar-select" id="lineSpacing" onchange="setLineSpacing(this.value)">
          <option value="1">Single</option>
          <option value="1.15">1.15</option>
          <option value="1.5" selected>1.5</option>
          <option value="2">Double</option>
          <option value="2.5">2.5</option>
          <option value="3">Triple</option>
        </select>
      </div>
      <div class="toolbar-group">
        <span style="padding: 0 0.5rem; color: var(--secondary);">Paragraph:</span>
        <button class="toolbar-btn" onclick="setParagraphSpacing('before')" title="Space Before">‚Üë Before</button>
        <button class="toolbar-btn" onclick="setParagraphSpacing('after')" title="Space After">‚Üì After</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showStylesPanel()" title="Styles">üé® Styles</button>
        <button class="toolbar-btn" onclick="togglePrintPreview()" title="Print Preview">üñ® Preview</button>
        <button class="toolbar-btn" onclick="toggleSplitScreen()" title="Split Screen View" id="splitScreenBtn">‚´ø Split</button>
        <button class="toolbar-btn" onclick="toggleLineNumbers()" title="Line Numbers" id="lineNumBtn">123 Lines</button>
        <button class="toolbar-btn" onclick="showHyphenation(event)" title="Hyphenation" id="hyphenationBtn">‚ÅÉ Hyphenation</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleDarkMode()" title="Dark Mode" id="darkModeBtn">üåô Dark Mode</button>
        <button class="toolbar-btn" onclick="showThemePicker()" title="Change Theme Color" id="themeBtn">üé® Theme</button>
        <button class="toolbar-btn" onclick="toggleFocusMode()" title="Focus Mode" id="focusModeBtn">üéØ Focus</button>
        <button class="toolbar-btn" onclick="enterDistractionFreeMode()" title="Distraction-Free Writing (F11)" id="dfModeBtn">üñ• Zen Mode</button>
        <button class="toolbar-btn" onclick="toggleReadingMode()" title="Reading Mode" id="readingModeBtn">üìñ Reading</button>
        <button class="toolbar-btn" onclick="toggleTypewriterSound()" title="Typewriter Sound" id="typewriterBtn">üéπ Typewriter</button>
        <button class="toolbar-btn" onclick="toggleReadAloud()" title="Read Aloud" id="readAloudBtn">üîä Read</button>
        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts (F1)">‚å® Shortcuts</button>
        <button class="toolbar-btn" onclick="startTour()" title="Feature Tour">üéì Tour</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleReadingProgress()" title="Reading Progress" id="readingProgressBtn">üìä Progress</button>
        <button class="toolbar-btn" onclick="showDocumentStatistics()" title="Document Statistics">üìà Statistics</button>
        <button class="toolbar-btn" onclick="showReadingLevel()" title="Reading Level Analysis">üìö Reading Level</button>
        <button class="toolbar-btn" onclick="showWordFrequency()" title="Word Frequency Analysis">üìä Word Freq</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleTypewriterMode()" title="Typewriter Mode (keeps cursor centered)" id="typewriterModeBtn">‚å® Typewriter</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showPomodoro()" title="Pomodoro Timer" id="pomodoroBtn">üçÖ Pomodoro</button>
        <button class="toolbar-btn" onclick="showAmbientSounds()" title="Ambient Sounds" id="ambientBtn">üéµ Ambient</button>
        <button class="toolbar-btn" onclick="showWritingGoals()" title="Writing Goals" id="writingGoalBtn">üéØ Goals</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleAutoSave()" title="Auto-Save" id="autoSaveBtn">üíæ Auto-Save: Off</button>
        <button class="toolbar-btn" onclick="showVersionHistory()" title="Version History">üìú Versions</button>
      </div>
    </div>

    <!-- Find & Replace Bar -->
    <div class="find-replace-bar" id="findReplaceBar">
      <span>Find:</span>
      <input type="text" id="findInput" placeholder="Search..." onkeyup="findInDocument()">
      <span class="count" id="findCount">0 results</span>
      <button class="toolbar-btn" onclick="findPrev()" title="Previous">‚óÄ</button>
      <button class="toolbar-btn" onclick="findNext()" title="Next">‚ñ∂</button>
      <span style="margin-left: 1rem;">Replace:</span>
      <input type="text" id="replaceInput" placeholder="Replace with...">
      <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem;" onclick="replaceOne()">Replace</button>
      <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem;" onclick="replaceAll()">Replace All</button>
      <button class="toolbar-btn" onclick="hideFindReplace()" title="Close">‚úï</button>
    </div>

    <!-- Ruler -->
    <div class="ruler" id="ruler">
      <div class="ruler-mark major" style="width: 96px;">0</div>
      <div class="ruler-mark" style="width: 96px;">1</div>
      <div class="ruler-mark major" style="width: 96px;">2</div>
      <div class="ruler-mark" style="width: 96px;">3</div>
      <div class="ruler-mark major" style="width: 96px;">4</div>
      <div class="ruler-mark" style="width: 96px;">5</div>
      <div class="ruler-mark major" style="width: 96px;">6</div>
      <div class="ruler-mark" style="width: 96px;">7</div>
    </div>

    <!-- Command Palette -->
    <div class="command-palette-overlay" id="commandPaletteOverlay" onclick="if(event.target === this) hideCommandPalette()">
      <div class="command-palette">
        <input type="text" class="command-palette-input" id="commandPaletteInput" placeholder="Type a command or search..." oninput="filterCommands()" onkeydown="handleCommandKey(event)">
        <div class="command-palette-results" id="commandPaletteResults"></div>
        <div class="command-palette-footer">
          <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
          <span><kbd>Enter</kbd> Execute</span>
          <span><kbd>Esc</kbd> Close</span>
        </div>
      </div>
    </div>

    <!-- Feature Tour -->
    <div class="tour-overlay" id="tourOverlay">
      <div class="tour-highlight" id="tourHighlight"></div>
      <div class="tour-tooltip" id="tourTooltip">
        <div class="tour-arrow tour-arrow-top" id="tourArrow"></div>
        <h3 id="tourTitle">Welcome to NinjaWord!</h3>
        <p id="tourDesc">Let's take a quick tour of the key features.</p>
        <div class="tour-tooltip-footer">
          <div class="tour-dots" id="tourDots"></div>
          <div class="tour-buttons">
            <button class="tour-btn tour-btn-skip" onclick="endTour()">Skip Tour</button>
            <button class="tour-btn tour-btn-next" onclick="nextTourStep()" id="tourNextBtn">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mini Toolbar (appears on text selection) -->
    <div class="mini-toolbar" id="miniToolbar">
      <select id="miniFont" onchange="applyMiniFormat('fontName', this.value)" title="Font">
        <option value="Arial">Arial</option>
        <option value="Times New Roman">Times</option>
        <option value="Georgia">Georgia</option>
        <option value="Verdana">Verdana</option>
        <option value="Courier New">Courier</option>
      </select>
      <select id="miniFontSize" onchange="applyMiniFormat('fontSize', this.value)" title="Size">
        <option value="1">8</option>
        <option value="2">10</option>
        <option value="3">12</option>
        <option value="4">14</option>
        <option value="5">18</option>
        <option value="6">24</option>
        <option value="7">36</option>
      </select>
      <span class="separator"></span>
      <button onclick="applyMiniFormat('bold')" title="Bold (Ctrl+B)"><strong>B</strong></button>
      <button onclick="applyMiniFormat('italic')" title="Italic (Ctrl+I)"><em>I</em></button>
      <button onclick="applyMiniFormat('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
      <button onclick="applyMiniFormat('strikeThrough')" title="Strikethrough"><s>S</s></button>
      <span class="separator"></span>
      <input type="color" id="miniTextColor" value="#000000" onchange="applyMiniFormat('foreColor', this.value)" title="Text Color">
      <input type="color" id="miniHighlight" value="#FFFF00" onchange="applyMiniFormat('hiliteColor', this.value)" title="Highlight">
      <span class="separator"></span>
      <button onclick="applyMiniFormat('justifyLeft')" title="Align Left">‚´∑</button>
      <button onclick="applyMiniFormat('justifyCenter')" title="Center">‚ò∞</button>
      <button onclick="applyMiniFormat('justifyRight')" title="Align Right">‚´∏</button>
      <span class="separator"></span>
      <button onclick="applyMiniFormat('insertUnorderedList')" title="Bullet List">‚Ä¢</button>
      <button onclick="applyMiniFormat('insertOrderedList')" title="Numbered List">1.</button>
      <span class="separator"></span>
      <button onclick="copyFromMini()" title="Copy">üìã</button>
      <button onclick="hideMiniToolbar()" title="Close" style="color: #999;">‚úï</button>
    </div>

    <!-- Drag & Drop Overlay -->
    <div class="drop-overlay" id="dropOverlay">
      <div class="drop-overlay-icon">üìÑ</div>
      <div class="drop-overlay-text">Drop file to open</div>
      <div class="drop-overlay-subtext">Supported: .docx, .txt, .html, .rtf</div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="autosave-indicator" id="autosaveIndicator">
      <div class="autosave-spinner"></div>
      <span>Auto-saving...</span>
    </div>

    <!-- Undo History Panel -->
    <div class="undo-history-panel" id="undoHistoryPanel">
      <div class="undo-history-header">
        <h4>‚Ü∂ Undo History</h4>
        <button class="undo-history-close" onclick="hideUndoHistory()">&times;</button>
      </div>
      <div class="undo-history-list" id="undoHistoryList">
        <div class="undo-history-empty">No history yet.<br>Start editing to build history.</div>
      </div>
    </div>

    <!-- Global Search Spotlight -->
    <div class="spotlight-overlay" id="spotlightOverlay">
      <div class="spotlight-container">
        <div class="spotlight-input-wrapper">
          <span class="spotlight-icon">üîç</span>
          <input type="text" class="spotlight-input" id="spotlightInput" placeholder="Search documents, actions, and more..." oninput="filterSpotlight(this.value)">
        </div>
        <div class="spotlight-results" id="spotlightResults">
          <div class="spotlight-section">
            <div class="spotlight-section-title">Recent Documents</div>
            <div id="spotlightDocs"></div>
          </div>
          <div class="spotlight-section">
            <div class="spotlight-section-title">Quick Actions</div>
            <div id="spotlightActions"></div>
          </div>
        </div>
        <div class="spotlight-footer">
          <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
          <span><kbd>Enter</kbd> Select</span>
          <span><kbd>Esc</kbd> Close</span>
        </div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab-container" id="fabContainer">
      <div class="fab-menu" id="fabMenu">
        <div class="fab-item">
          <span class="fab-item-label">Insert Image</span>
          <button class="fab-item-btn" onclick="insertImage(); toggleFab();">üñºÔ∏è</button>
        </div>
        <div class="fab-item">
          <span class="fab-item-label">Insert Table</span>
          <button class="fab-item-btn" onclick="insertTable(); toggleFab();">‚äû</button>
        </div>
        <div class="fab-item">
          <span class="fab-item-label">Insert Link</span>
          <button class="fab-item-btn" onclick="insertLink(); toggleFab();">üîó</button>
        </div>
        <div class="fab-item">
          <span class="fab-item-label">Symbols</span>
          <button class="fab-item-btn" onclick="showSymbolPicker(); toggleFab();">Œ©</button>
        </div>
        <div class="fab-item">
          <span class="fab-item-label">Command Palette</span>
          <button class="fab-item-btn" onclick="showCommandPalette(); toggleFab();">‚åò</button>
        </div>
        <div class="fab-item">
          <span class="fab-item-label">Save Document</span>
          <button class="fab-item-btn" onclick="saveDocument(); toggleFab();">üíæ</button>
        </div>
      </div>
      <button class="fab-main" id="fabMain" onclick="toggleFab()">+</button>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal-overlay" id="shortcutsModal">
      <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
          <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
          <button class="modal-close" onclick="hideShortcutsModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="shortcuts-grid">
            <div class="shortcuts-section">
              <h4>File Operations</h4>
              <div class="shortcut-item"><span>New Document</span><kbd>Ctrl+N</kbd></div>
              <div class="shortcut-item"><span>Open</span><kbd>Ctrl+O</kbd></div>
              <div class="shortcut-item"><span>Save</span><kbd>Ctrl+S</kbd></div>
              <div class="shortcut-item"><span>Print</span><kbd>Ctrl+P</kbd></div>
            </div>
            <div class="shortcuts-section">
              <h4>Editing</h4>
              <div class="shortcut-item"><span>Undo</span><kbd>Ctrl+Z</kbd></div>
              <div class="shortcut-item"><span>Redo</span><kbd>Ctrl+Y</kbd></div>
              <div class="shortcut-item"><span>Cut</span><kbd>Ctrl+X</kbd></div>
              <div class="shortcut-item"><span>Copy</span><kbd>Ctrl+C</kbd></div>
              <div class="shortcut-item"><span>Paste</span><kbd>Ctrl+V</kbd></div>
              <div class="shortcut-item"><span>Select All</span><kbd>Ctrl+A</kbd></div>
              <div class="shortcut-item"><span>Find & Replace</span><kbd>Ctrl+H</kbd></div>
            </div>
            <div class="shortcuts-section">
              <h4>Formatting</h4>
              <div class="shortcut-item"><span>Bold</span><kbd>Ctrl+B</kbd></div>
              <div class="shortcut-item"><span>Italic</span><kbd>Ctrl+I</kbd></div>
              <div class="shortcut-item"><span>Underline</span><kbd>Ctrl+U</kbd></div>
              <div class="shortcut-item"><span>Strikethrough</span><kbd>Alt+Shift+5</kbd></div>
              <div class="shortcut-item"><span>Superscript</span><kbd>Ctrl+Shift+=</kbd></div>
              <div class="shortcut-item"><span>Subscript</span><kbd>Ctrl+=</kbd></div>
            </div>
            <div class="shortcuts-section">
              <h4>Navigation & Tools</h4>
              <div class="shortcut-item"><span>Command Palette</span><kbd>Ctrl+Shift+P</kbd></div>
              <div class="shortcut-item"><span>Zoom In</span><kbd>Ctrl++</kbd></div>
              <div class="shortcut-item"><span>Zoom Out</span><kbd>Ctrl+-</kbd></div>
              <div class="shortcut-item"><span>Toggle Fullscreen</span><kbd>F11</kbd></div>
              <div class="shortcut-item"><span>Show Shortcuts</span><kbd>Ctrl+/</kbd></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideShortcutsModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
      <div class="context-menu-item" onclick="contextMenuAction('cut')">
        <span class="context-menu-item-icon">‚úÇÔ∏è</span>
        <span>Cut</span>
        <span class="context-menu-item-shortcut">Ctrl+X</span>
      </div>
      <div class="context-menu-item" onclick="contextMenuAction('copy')">
        <span class="context-menu-item-icon">üìã</span>
        <span>Copy</span>
        <span class="context-menu-item-shortcut">Ctrl+C</span>
      </div>
      <div class="context-menu-item" onclick="contextMenuAction('paste')">
        <span class="context-menu-item-icon">üìÑ</span>
        <span>Paste</span>
        <span class="context-menu-item-shortcut">Ctrl+V</span>
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="contextMenuAction('bold')">
        <span class="context-menu-item-icon"><strong>B</strong></span>
        <span>Bold</span>
        <span class="context-menu-item-shortcut">Ctrl+B</span>
      </div>
      <div class="context-menu-item" onclick="contextMenuAction('italic')">
        <span class="context-menu-item-icon"><em>I</em></span>
        <span>Italic</span>
        <span class="context-menu-item-shortcut">Ctrl+I</span>
      </div>
      <div class="context-menu-item" onclick="contextMenuAction('underline')">
        <span class="context-menu-item-icon"><u>U</u></span>
        <span>Underline</span>
        <span class="context-menu-item-shortcut">Ctrl+U</span>
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="contextMenuAction('link')">
        <span class="context-menu-item-icon">üîó</span>
        <span>Insert Link...</span>
      </div>
      <div class="context-menu-item" onclick="contextMenuAction('comment')">
        <span class="context-menu-item-icon">üí¨</span>
        <span>Add Comment</span>
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="contextMenuAction('paragraph')">
        <span class="context-menu-item-icon">¬∂</span>
        <span>Paragraph Settings...</span>
      </div>
      <div class="context-menu-item" onclick="contextMenuAction('font')">
        <span class="context-menu-item-icon">üî§</span>
        <span>Font Settings...</span>
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="contextMenuAction('selectAll')">
        <span class="context-menu-item-icon">‚òëÔ∏è</span>
        <span>Select All</span>
        <span class="context-menu-item-shortcut">Ctrl+A</span>
      </div>
    </div>

    <!-- Split Screen Container -->
    <div class="split-screen-container" id="splitScreenContainer">
      <div class="split-pane" id="splitPaneLeft">
        <div class="split-pane-header">
          <span>üìÑ Current Document</span>
          <button onclick="syncScrollLeft()" title="Sync scroll position" style="padding: 2px 8px; font-size: 11px;">üîÑ Sync</button>
        </div>
        <div class="split-pane-content" id="splitContentLeft" onscroll="onSplitScroll('left')"></div>
      </div>
      <div class="split-divider" id="splitDivider"></div>
      <div class="split-pane" id="splitPaneRight">
        <div class="split-pane-header">
          <span id="splitRightTitle">üìÑ Compare Document</span>
          <select id="splitDocSelect" onchange="loadSplitDocument()" style="padding: 2px 6px; font-size: 11px; border-radius: 4px;">
            <option value="">Select document...</option>
          </select>
        </div>
        <div class="split-pane-content" id="splitContentRight" onscroll="onSplitScroll('right')"></div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="word-container" id="wordContainer">
      <div class="document-area" id="documentArea" style="position: relative;">
        <div class="line-numbers-gutter" id="lineNumbersGutter"></div>
        <div class="document" id="editor" contenteditable="true" spellcheck="true">
          <h1 style="text-align: center;">Welcome to NinjaWord</h1>
          <p>Start typing your document here. You can format text, add images, create lists, and much more!</p>
          <p>Use the toolbar above to:</p>
          <ul>
            <li><strong>Format text</strong> - Bold, italic, underline, and more</li>
            <li><strong>Change fonts</strong> - Select from various font families and sizes</li>
            <li><strong>Add colors</strong> - Text color and highlighting</li>
            <li><strong>Create lists</strong> - Bulleted and numbered lists</li>
            <li><strong>Insert elements</strong> - Tables, images, links</li>
          </ul>
          <p>Try the <strong>Track Changes</strong> feature to see edits, or export your document as a <strong>PDF</strong>!</p>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-section">
          <h3>Templates</h3>
          <div class="template-grid">
            <div class="template-item" onclick="loadTemplate('blank')">Blank</div>
            <div class="template-item" onclick="loadTemplate('letter')">Letter</div>
            <div class="template-item" onclick="loadTemplate('resume')">Resume</div>
            <div class="template-item" onclick="loadTemplate('report')">Report</div>
          </div>
        </div>

        <div class="sidebar-section" id="outlinePanel">
          <h3>Document Outline</h3>
          <div id="outlineList" style="font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
            <p style="color: var(--secondary);">No headings found</p>
          </div>
          <button class="btn btn-secondary" onclick="refreshOutline()" style="width: 100%; margin-top: 0.5rem; padding: 0.3rem;">Refresh</button>
        </div>

        <div class="sidebar-section" id="trackChangesPanel" style="display: none;">
          <h3>Track Changes</h3>
          <div class="track-changes-panel">
            <div id="changesList"></div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Document Stats</h3>
          <div id="docStats" style="font-size: 0.9rem; color: var(--secondary);">
            <p>Words: <span id="wordCount">0</span></p>
            <p>Characters: <span id="charCount">0</span></p>
            <p>Paragraphs: <span id="paraCount">0</span></p>
            <p>Reading Time: <span id="readingTime">0</span> min</p>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Spelling</h3>
          <div id="spellingSuggestions" style="font-size: 0.9rem;"></div>
          <button class="btn btn-secondary" onclick="runSpellCheck()" style="width: 100%; margin-top: 0.5rem; padding: 0.3rem;">Check Spelling</button>
          <button class="btn btn-secondary" onclick="showCustomDictionary()" style="width: 100%; margin-top: 0.3rem; padding: 0.3rem;">üìñ Custom Dictionary</button>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <span id="statusLeft">
        <span class="status-bar-item" onclick="toggleAutoSaveStatus()" title="Click to toggle auto-save">
          <span class="status-icon" id="autoSaveStatusIcon">üíæ</span>
          <span id="autoSaveStatusText">Auto-save On</span>
        </span>
        <span style="margin: 0 6px;">|</span>
        <span class="status-bar-item" onclick="showLanguagePopup()" title="Click to change language" id="langIndicatorWrapper">
          <span class="status-icon">üåê</span>
          <span id="langIndicator">English (US)</span>
        </span>
      </span>
      <span id="statusCenter">
        <span class="status-bar-item" onclick="showWordCount()" title="Click for detailed statistics">
          <span class="status-icon">üìä</span>
          <span id="wordCountDisplay">Words: 0 | Characters: 0</span>
        </span>
      </span>
      <span id="statusRight">
        <span class="status-bar-item" onclick="showPageNavPopup()" title="Click to navigate pages">
          <span class="status-icon">üìÑ</span>
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <span style="margin: 0 6px;">|</span>
        <span class="status-bar-item" onclick="showZoomPopup()" title="Click to adjust zoom">
          <span class="status-icon">üîç</span>
          <span id="statusZoom">100%</span>
        </span>
      </span>
    </div>
  </div>

  <!-- Zoom Popup -->
  <div class="zoom-popup" id="zoomPopup">
    <div class="zoom-popup-header">
      <span>Zoom Level</span>
      <button class="zoom-popup-close" onclick="hideZoomPopup()">&times;</button>
    </div>
    <div class="zoom-slider-container">
      <span>50%</span>
      <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="200" value="100" oninput="setZoomFromSlider(this.value)">
      <span>200%</span>
    </div>
    <div class="zoom-presets" id="zoomPresets">
      <button class="zoom-preset-btn" onclick="setZoomLevel(50)">50%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(75)">75%</button>
      <button class="zoom-preset-btn active" onclick="setZoomLevel(100)">100%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(125)">125%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(150)">150%</button>
      <button class="zoom-preset-btn" onclick="setZoomLevel(200)">200%</button>
    </div>
    <div style="text-align: center; font-size: 12px; color: #888; margin-top: 4px;">
      Tip: Ctrl + Scroll to zoom
    </div>
  </div>

  <!-- Language Popup -->
  <div class="language-popup" id="languagePopup">
    <div class="language-popup-header">
      <span>üåê Document Language</span>
      <button class="zoom-popup-close" onclick="hideLanguagePopup()">&times;</button>
    </div>
    <div class="language-option active" onclick="setLanguage('en-US', 'English (US)', 'üá∫üá∏')">
      <span class="lang-flag">üá∫üá∏</span>
      <span>English (US)</span>
    </div>
    <div class="language-option" onclick="setLanguage('en-GB', 'English (UK)', 'üá¨üáß')">
      <span class="lang-flag">üá¨üáß</span>
      <span>English (UK)</span>
    </div>
    <div class="language-option" onclick="setLanguage('es-ES', 'Spanish', 'üá™üá∏')">
      <span class="lang-flag">üá™üá∏</span>
      <span>Spanish</span>
    </div>
    <div class="language-option" onclick="setLanguage('fr-FR', 'French', 'üá´üá∑')">
      <span class="lang-flag">üá´üá∑</span>
      <span>French</span>
    </div>
    <div class="language-option" onclick="setLanguage('de-DE', 'German', 'üá©üá™')">
      <span class="lang-flag">üá©üá™</span>
      <span>German</span>
    </div>
    <div class="language-option" onclick="setLanguage('it-IT', 'Italian', 'üáÆüáπ')">
      <span class="lang-flag">üáÆüáπ</span>
      <span>Italian</span>
    </div>
    <div class="language-option" onclick="setLanguage('pt-BR', 'Portuguese', 'üáßüá∑')">
      <span class="lang-flag">üáßüá∑</span>
      <span>Portuguese</span>
    </div>
    <div class="language-option" onclick="setLanguage('zh-CN', 'Chinese', 'üá®üá≥')">
      <span class="lang-flag">üá®üá≥</span>
      <span>Chinese</span>
    </div>
    <div class="language-option" onclick="setLanguage('ja-JP', 'Japanese', 'üáØüáµ')">
      <span class="lang-flag">üáØüáµ</span>
      <span>Japanese</span>
    </div>
  </div>

  <!-- Page Navigation Popup -->
  <div class="page-nav-popup" id="pageNavPopup">
    <div class="page-nav-popup-header">
      <span>üìÑ Go to Page</span>
      <button class="zoom-popup-close" onclick="hidePageNavPopup()">&times;</button>
    </div>
    <div class="page-nav-input-group">
      <span>Page</span>
      <input type="number" class="page-nav-input" id="pageNavInput" min="1" value="1">
      <span>of <span id="pageNavTotal">1</span></span>
      <button class="page-nav-btn" onclick="goToPage()">Go</button>
    </div>
    <div class="page-nav-buttons">
      <button class="page-nav-arrow" onclick="goToFirstPage()" title="First page">‚èÆÔ∏è</button>
      <button class="page-nav-arrow" onclick="goToPrevPage()" title="Previous page">‚óÄÔ∏è</button>
      <button class="page-nav-arrow" onclick="goToNextPage()" title="Next page">‚ñ∂Ô∏è</button>
      <button class="page-nav-arrow" onclick="goToLastPage()" title="Last page">‚è≠Ô∏è</button>
    </div>
  </div>

  <!-- Welcome/Tips Modal -->
  <div class="welcome-modal" id="welcomeModal">
    <div class="welcome-container">
      <div class="welcome-header">
        <h2>Welcome to NinjaWord</h2>
        <p>Your powerful browser-based document editor</p>
      </div>
      <div class="welcome-tips">
        <div class="welcome-tip">
          <div class="welcome-tip-icon">üîç</div>
          <div class="welcome-tip-content">
            <h4>Command Palette</h4>
            <p>Press <kbd>Ctrl</kbd> + <kbd>K</kbd> to quickly search and access any action, document, or feature.</p>
          </div>
        </div>
        <div class="welcome-tip">
          <div class="welcome-tip-icon">üíæ</div>
          <div class="welcome-tip-content">
            <h4>Auto-Save</h4>
            <p>Your work is automatically saved. Click the status bar to toggle auto-save on/off.</p>
          </div>
        </div>
        <div class="welcome-tip">
          <div class="welcome-tip-icon">üìÅ</div>
          <div class="welcome-tip-content">
            <h4>Drag & Drop</h4>
            <p>Drag files directly into the editor to open .docx, .txt, .html, and .rtf documents.</p>
          </div>
        </div>
        <div class="welcome-tip">
          <div class="welcome-tip-icon">‚å®Ô∏è</div>
          <div class="welcome-tip-content">
            <h4>Keyboard Shortcuts</h4>
            <p>Press <kbd>Ctrl</kbd> + <kbd>/</kbd> to view all keyboard shortcuts available.</p>
          </div>
        </div>
      </div>
      <div class="welcome-footer">
        <label class="welcome-checkbox">
          <input type="checkbox" id="dontShowAgain">
          Don't show this again
        </label>
        <button class="welcome-btn" onclick="closeWelcome()">Get Started</button>
      </div>
    </div>
  </div>

  <!-- Theme Picker -->
  <div class="theme-picker-overlay" id="themePickerOverlay" onclick="hideThemePicker()"></div>
  <div class="theme-picker" id="themePicker">
    <h3>üé® Choose Theme Color</h3>
    <div class="theme-colors">
      <div class="theme-color active" style="background: #1a73e8;" data-theme="blue" onclick="setTheme('blue')" title="Blue (Default)"></div>
      <div class="theme-color" style="background: #0f9d58;" data-theme="green" onclick="setTheme('green')" title="Green"></div>
      <div class="theme-color" style="background: #d93025;" data-theme="red" onclick="setTheme('red')" title="Red"></div>
      <div class="theme-color" style="background: #9334e6;" data-theme="purple" onclick="setTheme('purple')" title="Purple"></div>
      <div class="theme-color" style="background: #f57c00;" data-theme="orange" onclick="setTheme('orange')" title="Orange"></div>
      <div class="theme-color" style="background: #00897b;" data-theme="teal" onclick="setTheme('teal')" title="Teal"></div>
      <div class="theme-color" style="background: #e91e63;" data-theme="pink" onclick="setTheme('pink')" title="Pink"></div>
      <div class="theme-color" style="background: #3f51b5;" data-theme="indigo" onclick="setTheme('indigo')" title="Indigo"></div>
      <div class="theme-color" style="background: #00bcd4;" data-theme="cyan" onclick="setTheme('cyan')" title="Cyan"></div>
      <div class="theme-color" style="background: #ffc107;" data-theme="amber" onclick="setTheme('amber')" title="Amber"></div>
    </div>
    <div class="theme-picker-footer">
      <button class="btn btn-secondary" onclick="hideThemePicker()">Cancel</button>
      <button class="btn btn-primary" onclick="hideThemePicker()">Done</button>
    </div>
  </div>

  <!-- Pomodoro Timer -->
  <div class="pomodoro-overlay" id="pomodoroOverlay" onclick="hidePomodoro()"></div>
  <div class="pomodoro-popup" id="pomodoroPopup">
    <h3>üçÖ Pomodoro Timer</h3>
    <div class="pomodoro-label" id="pomodoroLabel">Focus Time</div>
    <div class="pomodoro-timer" id="pomodoroTimer">25:00</div>
    <div class="pomodoro-sessions" id="pomodoroSessions">
      <div class="pomodoro-dot"></div>
      <div class="pomodoro-dot"></div>
      <div class="pomodoro-dot"></div>
      <div class="pomodoro-dot"></div>
    </div>
    <div class="pomodoro-controls">
      <button class="pomodoro-btn primary" id="pomodoroStartBtn" onclick="togglePomodoroTimer()">Start</button>
      <button class="pomodoro-btn secondary" onclick="resetPomodoro()">Reset</button>
      <button class="pomodoro-btn secondary" onclick="skipPomodoro()">Skip</button>
    </div>
    <div class="pomodoro-settings">
      <div class="pomodoro-setting">
        <span>Focus (min)</span>
        <input type="number" id="pomodoroFocusTime" value="25" min="1" max="60" onchange="updatePomodoroSettings()">
      </div>
      <div class="pomodoro-setting">
        <span>Short Break (min)</span>
        <input type="number" id="pomodoroShortBreak" value="5" min="1" max="30" onchange="updatePomodoroSettings()">
      </div>
      <div class="pomodoro-setting">
        <span>Long Break (min)</span>
        <input type="number" id="pomodoroLongBreak" value="15" min="1" max="60" onchange="updatePomodoroSettings()">
      </div>
    </div>
  </div>

  <!-- Ambient Sounds -->
  <div class="pomodoro-overlay" id="ambientOverlay" onclick="hideAmbientSounds()"></div>
  <div class="ambient-popup" id="ambientPopup">
    <h3>üéµ Ambient Sounds</h3>
    <div class="ambient-sounds-grid">
      <button class="ambient-sound-btn" data-sound="rain" onclick="toggleAmbientSound('rain')">
        <span class="icon">üåßÔ∏è</span>
        <span class="label">Rain</span>
      </button>
      <button class="ambient-sound-btn" data-sound="thunder" onclick="toggleAmbientSound('thunder')">
        <span class="icon">‚õàÔ∏è</span>
        <span class="label">Thunder</span>
      </button>
      <button class="ambient-sound-btn" data-sound="forest" onclick="toggleAmbientSound('forest')">
        <span class="icon">üå≤</span>
        <span class="label">Forest</span>
      </button>
      <button class="ambient-sound-btn" data-sound="ocean" onclick="toggleAmbientSound('ocean')">
        <span class="icon">üåä</span>
        <span class="label">Ocean</span>
      </button>
      <button class="ambient-sound-btn" data-sound="wind" onclick="toggleAmbientSound('wind')">
        <span class="icon">üí®</span>
        <span class="label">Wind</span>
      </button>
      <button class="ambient-sound-btn" data-sound="fire" onclick="toggleAmbientSound('fire')">
        <span class="icon">üî•</span>
        <span class="label">Fireplace</span>
      </button>
      <button class="ambient-sound-btn" data-sound="cafe" onclick="toggleAmbientSound('cafe')">
        <span class="icon">‚òï</span>
        <span class="label">Caf√©</span>
      </button>
      <button class="ambient-sound-btn" data-sound="whitenoise" onclick="toggleAmbientSound('whitenoise')">
        <span class="icon">üìª</span>
        <span class="label">White Noise</span>
      </button>
      <button class="ambient-sound-btn" data-sound="birds" onclick="toggleAmbientSound('birds')">
        <span class="icon">üê¶</span>
        <span class="label">Birds</span>
      </button>
    </div>
    <div class="ambient-volume">
      <span>üîà</span>
      <input type="range" id="ambientVolume" min="0" max="100" value="50" oninput="setAmbientVolume(this.value)">
      <span>üîä</span>
    </div>
    <div class="ambient-mix">
      <div class="ambient-mix-label">Mix multiple sounds for your perfect atmosphere</div>
      <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="stopAllAmbientSounds()">Stop All Sounds</button>
    </div>
  </div>

  <!-- Writing Goals -->
  <div class="writing-goal-bar" id="writingGoalBar">
    <span class="writing-goal-text" id="writingGoalText">0 / 500 words</span>
    <div class="writing-goal-progress">
      <div class="writing-goal-fill" id="writingGoalFill" style="width: 0%;"></div>
    </div>
    <button class="writing-goal-close" onclick="hideWritingGoalBar()">‚úï</button>
  </div>

  <!-- Writing Goals Modal -->
  <div class="modal-overlay" id="writingGoalsModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>üéØ Set Writing Goal</h3>
        <button class="modal-close" onclick="hideWritingGoalsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Goal Type</label>
          <select class="form-control" id="writingGoalType" onchange="updateGoalInputLabel()">
            <option value="words">Word Count</option>
            <option value="characters">Character Count</option>
            <option value="time">Writing Time (minutes)</option>
          </select>
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;" id="writingGoalLabel">Target Words</label>
          <input type="number" class="form-control" id="writingGoalTarget" value="500" min="1">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="writingGoalNotify" checked>
            <span>Notify when goal reached</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideWritingGoalsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="startWritingGoal()">Start</button>
      </div>
    </div>
  </div>

  <!-- Reading Level Analyzer -->
  <div class="pomodoro-overlay" id="readingLevelOverlay" onclick="hideReadingLevel()"></div>
  <div class="reading-level-popup" id="readingLevelPopup">
    <h3>üìö Reading Level Analysis</h3>
    <div class="reading-level-score">
      <div class="reading-level-grade" id="readingLevelGrade">--</div>
      <div class="reading-level-label" id="readingLevelLabel">Grade Level</div>
    </div>
    <div class="reading-level-meter">
      <div class="reading-level-indicator" id="readingLevelIndicator" style="left: 50%;"></div>
    </div>
    <div class="reading-level-scale">
      <span>Easy (Grade 1)</span>
      <span>Average (Grade 8)</span>
      <span>Difficult (Grade 16+)</span>
    </div>
    <div class="reading-level-stats">
      <div class="reading-stat">
        <div class="reading-stat-value" id="rlFleschScore">--</div>
        <div class="reading-stat-label">Flesch Reading Ease</div>
      </div>
      <div class="reading-stat">
        <div class="reading-stat-value" id="rlAvgSentence">--</div>
        <div class="reading-stat-label">Avg Words/Sentence</div>
      </div>
      <div class="reading-stat">
        <div class="reading-stat-value" id="rlAvgSyllables">--</div>
        <div class="reading-stat-label">Avg Syllables/Word</div>
      </div>
      <div class="reading-stat">
        <div class="reading-stat-value" id="rlComplexWords">--</div>
        <div class="reading-stat-label">Complex Words (%)</div>
      </div>
    </div>
    <div class="reading-level-desc" id="readingLevelDesc">
      Analyze your document to see reading level recommendations.
    </div>
    <div style="margin-top: 16px; text-align: right;">
      <button class="btn btn-secondary" onclick="hideReadingLevel()">Close</button>
    </div>
  </div>

  <!-- Emoji Picker -->
  <div class="pomodoro-overlay" id="emojiOverlay" onclick="hideEmojiPicker()"></div>
  <div class="emoji-picker" id="emojiPicker">
    <div class="emoji-picker-header">
      <h3>üòÄ Emoji Picker</h3>
      <input type="text" class="emoji-search" id="emojiSearch" placeholder="Search emojis..." oninput="filterEmojis(this.value)">
    </div>
    <div class="emoji-categories" id="emojiCategories">
      <button class="emoji-category-btn active" onclick="showEmojiCategory('smileys')" title="Smileys">üòÄ</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('people')" title="People">üëã</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('animals')" title="Animals">üê±</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('food')" title="Food">üçï</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('activities')" title="Activities">‚öΩ</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('travel')" title="Travel">üöó</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('objects')" title="Objects">üí°</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('symbols')" title="Symbols">‚ù§Ô∏è</button>
      <button class="emoji-category-btn" onclick="showEmojiCategory('flags')" title="Flags">üè≥Ô∏è</button>
    </div>
    <div class="emoji-grid" id="emojiGrid"></div>
    <div class="emoji-recent" id="emojiRecent">
      <div class="emoji-recent-label">Recently Used</div>
      <div class="emoji-recent-grid" id="emojiRecentGrid"></div>
    </div>
  </div>

  <!-- Sticky Notes Panel -->
  <div class="sticky-notes-panel" id="stickyNotesPanel">
    <div class="sticky-notes-panel-header">
      <span>üìå Sticky Notes</span>
      <div>
        <button onclick="addStickyNote()" style="border: none; background: none; cursor: pointer; font-size: 16px;" title="Add Note">‚ûï</button>
        <button onclick="toggleStickyNotesPanel()" style="border: none; background: none; cursor: pointer; font-size: 16px;" title="Close">‚úï</button>
      </div>
    </div>
    <div class="sticky-notes-list" id="stickyNotesList">
      <p style="color: #888; text-align: center; padding: 20px;">No sticky notes yet.<br>Click + to add one.</p>
    </div>
  </div>

  <!-- Quick Access Toolbar Customization Modal -->
  <div class="modal-overlay" id="qatModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>‚ö° Customize Quick Access Toolbar</h3>
        <button class="modal-close" onclick="hideQATCustomization()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Select commands to add to your Quick Access Toolbar:</p>
        <div class="qat-modal-items" id="qatCommandsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="resetQAT()">Reset to Default</button>
        <button class="btn btn-secondary" onclick="hideQATCustomization()">Cancel</button>
        <button class="btn btn-primary" onclick="saveQATCustomization()">Save</button>
      </div>
    </div>
  </div>

  <!-- Custom Dictionary Modal -->
  <div class="modal-overlay" id="customDictModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>üìñ Custom Dictionary</h3>
        <button class="modal-close" onclick="hideCustomDictionary()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Words you've added will be ignored during spell check.</p>

        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <input type="text" id="newDictWord" class="form-control" placeholder="Add new word..." style="flex: 1;">
          <button class="btn btn-primary" onclick="addWordToDict()">Add</button>
        </div>

        <div style="border: 1px solid var(--border); border-radius: 4px; max-height: 250px; overflow-y: auto;">
          <div id="customDictList" style="padding: 0.5rem;"></div>
        </div>

        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--secondary);">
          <span id="dictWordCount">0</span> word(s) in custom dictionary
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="clearCustomDictionary()">Clear All</button>
        <button class="btn btn-secondary" onclick="exportCustomDictionary()">Export</button>
        <button class="btn btn-secondary" onclick="importCustomDictionary()">Import</button>
        <button class="btn btn-primary" onclick="hideCustomDictionary()">Done</button>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div class="modal-overlay" id="shortcutsModal">
    <div class="modal" style="max-width: 700px; max-height: 80vh;">
      <div class="modal-header">
        <h3>Keyboard Shortcuts</h3>
        <button class="modal-close" onclick="hideKeyboardShortcuts()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div class="shortcuts-grid">
          <div class="shortcuts-section">
            <h4>File Operations</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>N</kbd> <span>New Document</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>O</kbd> <span>Open</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>S</kbd> <span>Save</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>P</kbd> <span>Print</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Editing</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Z</kbd> <span>Undo</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Y</kbd> <span>Redo</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>X</kbd> <span>Cut</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>C</kbd> <span>Copy</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>V</kbd> <span>Paste</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>A</kbd> <span>Select All</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Formatting</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>B</kbd> <span>Bold</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>I</kbd> <span>Italic</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>U</kbd> <span>Underline</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>E</kbd> <span>Center Align</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>L</kbd> <span>Left Align</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>R</kbd> <span>Right Align</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>J</kbd> <span>Justify</span></div>
          </div>
          <div class="shortcuts-section">
            <h4>Navigation</h4>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>F</kbd> <span>Find</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>H</kbd> <span>Find & Replace</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Home</kbd> <span>Go to Beginning</span></div>
            <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>End</kbd> <span>Go to End</span></div>
            <div class="shortcut-item"><kbd>F1</kbd> <span>Show Shortcuts</span></div>
            <div class="shortcut-item"><kbd>Esc</kbd> <span>Exit Focus Mode</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Watermark Modal -->
  <div class="modal-overlay" id="watermarkModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3>Insert Watermark</h3>
        <button class="modal-close" onclick="hideWatermarkModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="font-weight: 500;">Preset Watermarks:</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
            <button class="btn btn-secondary" onclick="setWatermarkPreset('DRAFT')">DRAFT</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('CONFIDENTIAL')">CONFIDENTIAL</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('SAMPLE')">SAMPLE</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('DO NOT COPY')">DO NOT COPY</button>
            <button class="btn btn-secondary" onclick="setWatermarkPreset('URGENT')">URGENT</button>
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="font-weight: 500;">Custom Text:</label>
          <input type="text" id="watermarkText" class="form-control" value="DRAFT" style="margin-top: 0.5rem;">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label style="font-weight: 500;">Color:</label>
            <input type="color" id="watermarkColor" value="#cccccc" style="width: 100%; height: 36px; margin-top: 0.5rem;">
          </div>
          <div class="form-group">
            <label style="font-weight: 500;">Opacity:</label>
            <input type="range" id="watermarkOpacity" min="5" max="50" value="20" style="width: 100%; margin-top: 0.75rem;">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
          <div class="form-group">
            <label style="font-weight: 500;">Font Size:</label>
            <select id="watermarkSize" class="form-control" style="margin-top: 0.5rem;">
              <option value="48">Small (48px)</option>
              <option value="72" selected>Medium (72px)</option>
              <option value="96">Large (96px)</option>
              <option value="120">Extra Large (120px)</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-weight: 500;">Layout:</label>
            <select id="watermarkLayout" class="form-control" style="margin-top: 0.5rem;">
              <option value="diagonal" selected>Diagonal</option>
              <option value="horizontal">Horizontal</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="removeWatermark()">Remove Watermark</button>
        <button class="btn btn-primary" onclick="applyWatermark()">Apply Watermark</button>
      </div>
    </div>
  </div>

  <!-- Word Count Modal -->
  <div class="modal-overlay" id="wordCountModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Word Count</h3>
        <button class="modal-close" onclick="hideWordCount()">&times;</button>
      </div>
      <div class="modal-body">
        <table class="word-count-table" style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Pages</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcPages">1</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Words</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcWords">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Characters (no spaces)</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcCharsNoSpaces">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Characters (with spaces)</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcCharsWithSpaces">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Paragraphs</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcParagraphs">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee;">Lines</td>
            <td style="padding: 0.75rem; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;" id="wcLines">0</td>
          </tr>
          <tr>
            <td style="padding: 0.75rem;">Reading Time</td>
            <td style="padding: 0.75rem; text-align: right; font-weight: 600;" id="wcReadTime">0 min</td>
          </tr>
        </table>
        <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
          <strong>Selection:</strong> <span id="wcSelectionInfo">No text selected</span>
        </p>
      </div>
      <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #eee; text-align: right;">
        <button class="btn btn-primary" onclick="hideWordCount()">Close</button>
      </div>
    </div>
  </div>

  <!-- Thesaurus Modal -->
  <div class="modal-overlay" id="thesaurusModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>üìñ Thesaurus</h3>
        <button class="modal-close" onclick="hideThesaurus()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Word to look up:</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" class="form-control" id="thesaurusWord" placeholder="Enter a word..." onkeyup="if(event.key==='Enter')lookupThesaurus()">
            <button class="btn btn-primary" onclick="lookupThesaurus()">Look Up</button>
          </div>
        </div>
        <div id="thesaurusResults" style="margin-top: 1rem;">
          <p style="color: #666; text-align: center; padding: 2rem;">Select a word in your document or type a word above to find synonyms and antonyms.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideThesaurus()">Close</button>
      </div>
    </div>
  </div>

  <!-- Translate Modal -->
  <div class="modal-overlay" id="translateModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>üåê Translate</h3>
        <button class="modal-close" onclick="hideTranslate()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <div style="flex: 1;">
            <label>From:</label>
            <select class="form-control" id="translateFrom">
              <option value="auto">Auto-detect</option>
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
              <option value="zh">Chinese</option>
              <option value="ja">Japanese</option>
              <option value="ko">Korean</option>
              <option value="ar">Arabic</option>
              <option value="ru">Russian</option>
            </select>
          </div>
          <div style="display: flex; align-items: flex-end; padding-bottom: 0.5rem;">
            <button class="btn btn-secondary" onclick="swapTranslateLanguages()" title="Swap languages">‚áÑ</button>
          </div>
          <div style="flex: 1;">
            <label>To:</label>
            <select class="form-control" id="translateTo">
              <option value="es">Spanish</option>
              <option value="en">English</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
              <option value="zh">Chinese</option>
              <option value="ja">Japanese</option>
              <option value="ko">Korean</option>
              <option value="ar">Arabic</option>
              <option value="ru">Russian</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Original text:</label>
          <textarea class="form-control" id="translateSource" rows="4" placeholder="Select text in your document or type/paste text here..."></textarea>
        </div>
        <div style="text-align: center; margin: 1rem 0;">
          <button class="btn btn-primary" onclick="translateText()">üåê Translate</button>
        </div>
        <div class="form-group">
          <label>Translation:</label>
          <textarea class="form-control" id="translateResult" rows="4" placeholder="Translation will appear here..." readonly style="background: #f9f9f9;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideTranslate()">Close</button>
        <button class="btn btn-primary" onclick="insertTranslation()">Insert Translation</button>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div class="modal-overlay" id="templatesModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Choose a Template</h3>
        <button class="modal-close" onclick="hideTemplates()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="template-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="template-item" onclick="loadTemplate('blank'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
            Blank Document
          </div>
          <div class="template-item" onclick="loadTemplate('letter'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úâÔ∏è</div>
            Business Letter
          </div>
          <div class="template-item" onclick="loadTemplate('resume'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
            Resume
          </div>
          <div class="template-item" onclick="loadTemplate('report'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
            Report
          </div>
          <div class="template-item" onclick="loadTemplate('invoice'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíµ</div>
            Invoice
          </div>
          <div class="template-item" onclick="loadTemplate('meeting'); hideTemplates();">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
            Meeting Notes
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mail Merge Modal -->
  <div class="modal-overlay" id="mailMergeModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Mail Merge</h3>
        <button class="modal-close" onclick="hideMailMerge()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem;">Insert merge fields in your document, then add recipient data below:</p>

        <div class="form-group">
          <label>Merge Fields Available:</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('FirstName')">{{FirstName}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('LastName')">{{LastName}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('Email')">{{Email}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('Company')">{{Company}}</span>
            <span class="merge-field" style="cursor: pointer;" onclick="insertMergeField('Address')">{{Address}}</span>
          </div>
        </div>

        <div class="form-group">
          <label>Recipients (CSV format):</label>
          <textarea class="form-control" id="mergeData" rows="5" placeholder="FirstName,LastName,Email,Company,Address
John,Doe,john@example.com,Acme Inc,123 Main St
Jane,Smith,jane@example.com,Tech Corp,456 Oak Ave"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideMailMerge()">Cancel</button>
        <button class="btn btn-primary" onclick="previewMerge()">Preview Merge</button>
        <button class="btn btn-success" onclick="executeMerge()">Generate Documents</button>
      </div>
    </div>
  </div>

  <!-- Envelopes & Labels Modal -->
  <div class="modal-overlay" id="envelopesLabelsModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Envelopes & Labels</h3>
        <button class="modal-close" onclick="hideEnvelopesLabels()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Tab buttons -->
        <div style="display: flex; border-bottom: 2px solid #eee; margin-bottom: 1rem;">
          <button class="btn" id="envelopeTabBtn" onclick="switchEnvelopeTab('envelope')" style="border-radius: 4px 4px 0 0; background: #1a73e8; color: white;">Envelopes</button>
          <button class="btn" id="labelTabBtn" onclick="switchEnvelopeTab('label')" style="border-radius: 4px 4px 0 0; background: #f5f5f5;">Labels</button>
        </div>

        <!-- Envelope Tab -->
        <div id="envelopeTab">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div>
              <div class="form-group">
                <label style="font-weight: 600;">Delivery Address</label>
                <textarea class="form-control" id="deliveryAddress" rows="4" placeholder="John Smith&#10;123 Main Street&#10;City, State 12345"></textarea>
              </div>
              <div class="form-group">
                <label style="font-weight: 600;">Return Address</label>
                <textarea class="form-control" id="returnAddress" rows="3" placeholder="Your Name&#10;Your Address&#10;City, State ZIP"></textarea>
                <label style="margin-top: 0.5rem;"><input type="checkbox" id="omitReturnAddress"> Omit return address</label>
              </div>
            </div>
            <div>
              <div class="form-group">
                <label style="font-weight: 600;">Envelope Size</label>
                <select class="form-control" id="envelopeSize" onchange="updateEnvelopePreview()">
                  <option value="10">Size 10 (4.125" x 9.5") - Standard</option>
                  <option value="6">Size 6 (3.625" x 6.5")</option>
                  <option value="9">Size 9 (3.875" x 8.875")</option>
                  <option value="a2">A2 (4.375" x 5.75") - Invitation</option>
                  <option value="c5">C5 (6.38" x 9.02") - A4 Folded</option>
                  <option value="dl">DL (4.33" x 8.66") - Euro Standard</option>
                </select>
              </div>
              <div class="form-group">
                <label style="font-weight: 600;">Font</label>
                <div style="display: flex; gap: 0.5rem;">
                  <select class="form-control" id="envelopeFont" style="flex: 1;">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                  </select>
                  <input type="number" class="form-control" id="envelopeFontSize" value="12" min="8" max="24" style="width: 60px;">
                </div>
              </div>
              <div style="margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Preview</label>
                <div id="envelopePreview" style="background: white; border: 1px solid #ccc; padding: 10px; aspect-ratio: 2.3/1; position: relative; font-size: 10px;">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Labels Tab -->
        <div id="labelTab" style="display: none;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div>
              <div class="form-group">
                <label style="font-weight: 600;">Address / Content</label>
                <textarea class="form-control" id="labelContent" rows="4" placeholder="Enter content for labels..."></textarea>
              </div>
              <div class="form-group">
                <label style="font-weight: 600;">Print Options</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <label><input type="radio" name="labelPrint" value="full" checked> Full page of same label</label>
                  <label><input type="radio" name="labelPrint" value="single"> Single label</label>
                </div>
              </div>
              <div class="form-group" id="singleLabelOptions" style="display: none;">
                <label>Row: <input type="number" class="form-control" id="labelRow" value="1" min="1" style="width: 60px; display: inline;"></label>
                <label style="margin-left: 1rem;">Column: <input type="number" class="form-control" id="labelCol" value="1" min="1" style="width: 60px; display: inline;"></label>
              </div>
            </div>
            <div>
              <div class="form-group">
                <label style="font-weight: 600;">Label Vendor</label>
                <select class="form-control" id="labelVendor" onchange="updateLabelProducts()">
                  <option value="avery">Avery US Letter</option>
                  <option value="avery-a4">Avery A4</option>
                  <option value="generic">Generic</option>
                </select>
              </div>
              <div class="form-group">
                <label style="font-weight: 600;">Product Number</label>
                <select class="form-control" id="labelProduct" onchange="updateLabelPreview()">
                  <option value="5160">5160 - Address (1" x 2.625", 30/sheet)</option>
                  <option value="5163">5163 - Shipping (2" x 4", 10/sheet)</option>
                  <option value="5164">5164 - Shipping (3.33" x 4", 6/sheet)</option>
                  <option value="8163">8163 - Shipping (2" x 4", 10/sheet)</option>
                  <option value="5167">5167 - Return Address (0.5" x 1.75", 80/sheet)</option>
                </select>
              </div>
              <div style="margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Sheet Preview</label>
                <div id="labelPreview" style="background: white; border: 1px solid #ccc; padding: 5px; aspect-ratio: 8.5/11; display: grid; gap: 2px;">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEnvelopesLabels()">Cancel</button>
        <button class="btn btn-secondary" onclick="printEnvelopeLabel()">üñ® Print</button>
        <button class="btn btn-primary" onclick="insertEnvelopeLabel()">Insert into Document</button>
      </div>
    </div>
  </div>

  <!-- Open Documents Modal -->
  <div class="modal-overlay" id="openModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Open Document</h3>
        <button class="modal-close" onclick="hideOpenDialog()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="savedDocsList" style="max-height: 400px; overflow-y: auto;">
          <p style="color: var(--secondary);">No saved documents yet.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideOpenDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Save As Modal -->
  <div class="modal-overlay" id="saveAsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Save Document As</h3>
        <button class="modal-close" onclick="hideSaveAs()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Document Name</label>
          <input type="text" class="form-control" id="saveAsName" placeholder="My Document">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSaveAs()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmSaveAs()">Save</button>
      </div>
    </div>
  </div>

  <!-- Page Setup Modal -->
  <div class="modal-overlay" id="pageSetupModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Page Setup</h3>
        <button class="modal-close" onclick="hidePageSetup()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Paper Size</label>
            <select class="form-control" id="paperSize" onchange="updatePagePreview()">
              <option value="letter">Letter (8.5" x 11")</option>
              <option value="a4">A4 (210mm x 297mm)</option>
              <option value="legal">Legal (8.5" x 14")</option>
            </select>
          </div>
          <div class="form-group">
            <label>Orientation</label>
            <select class="form-control" id="pageOrientation" onchange="updatePagePreview()">
              <option value="portrait">Portrait</option>
              <option value="landscape">Landscape</option>
            </select>
          </div>
        </div>
        <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Margins (inches)</h4>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
          <div class="form-group">
            <label>Top</label>
            <input type="number" class="form-control" id="marginTop" value="1" step="0.25" min="0">
          </div>
          <div class="form-group">
            <label>Bottom</label>
            <input type="number" class="form-control" id="marginBottom" value="1" step="0.25" min="0">
          </div>
          <div class="form-group">
            <label>Left</label>
            <input type="number" class="form-control" id="marginLeft" value="1" step="0.25" min="0">
          </div>
          <div class="form-group">
            <label>Right</label>
            <input type="number" class="form-control" id="marginRight" value="1" step="0.25" min="0">
          </div>
        </div>
        <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Header & Footer</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Header Text</label>
            <input type="text" class="form-control" id="headerText" placeholder="Document header...">
          </div>
          <div class="form-group">
            <label>Footer Text</label>
            <input type="text" class="form-control" id="footerText" placeholder="Document footer...">
          </div>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="showPageNumbers" checked> Show Page Numbers</label>
        </div>
        <div class="form-group">
          <label>Page Number Position</label>
          <select class="form-control" id="pageNumberPosition">
            <option value="bottom-center">Bottom Center</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="top-center">Top Center</option>
            <option value="top-right">Top Right</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePageSetup()">Cancel</button>
        <button class="btn btn-primary" onclick="applyPageSetup()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Restrict Editing Modal -->
  <div class="modal-overlay" id="restrictEditingModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3>Restrict Editing</h3>
        <button class="modal-close" onclick="hideRestrictEditing()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">
            <input type="checkbox" id="enableFormatRestrictions" style="margin-right: 0.5rem;">
            1. Formatting restrictions
          </label>
          <p style="font-size: 0.85rem; color: #666; margin-left: 1.5rem;">Limit formatting to a selection of styles</p>
        </div>

        <div class="form-group" style="margin-top: 1rem;">
          <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">
            <input type="checkbox" id="enableEditRestrictions" style="margin-right: 0.5rem;">
            2. Editing restrictions
          </label>
          <p style="font-size: 0.85rem; color: #666; margin-left: 1.5rem; margin-bottom: 0.5rem;">Allow only this type of editing:</p>
          <select class="form-control" id="editRestrictionType" style="margin-left: 1.5rem; width: calc(100% - 1.5rem);">
            <option value="none">No changes (Read only)</option>
            <option value="tracked">Tracked changes</option>
            <option value="comments">Comments</option>
            <option value="fillforms">Filling in forms</option>
          </select>
        </div>

        <div class="form-group" style="margin-top: 1rem;">
          <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
            <input type="checkbox" id="enablePasswordProtect" style="margin-right: 0.5rem;">
            3. Password protect
          </label>
          <div style="margin-left: 1.5rem;">
            <input type="password" class="form-control" id="restrictPassword" placeholder="Enter password (optional)" style="width: calc(100% - 0rem);">
          </div>
        </div>

        <div style="margin-top: 1rem; padding: 0.75rem; background: #f5f5f5; border-radius: 4px;">
          <h5 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Exceptions (users who can edit freely)</h5>
          <div id="exceptionUsers" style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.5rem;">
            <span style="font-size: 0.85rem; color: #666;">No exceptions</span>
          </div>
          <button class="btn btn-secondary" onclick="addEditException()" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">+ Add Exception</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideRestrictEditing()">Cancel</button>
        <button class="btn btn-danger" onclick="removeRestrictions()" id="removeRestrictionsBtn" style="display: none;">Remove Protection</button>
        <button class="btn btn-primary" onclick="applyRestrictions()" id="applyRestrictionsBtn">Yes, Start Enforcing Protection</button>
      </div>
    </div>
  </div>

  <!-- Hyphenation Popup (inline dropdown) -->
  <div id="hyphenationPopup" style="display: none; position: fixed; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); padding: 1rem; z-index: 10000; width: 280px;">
    <h4 style="margin: 0 0 0.75rem 0; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Hyphenation Options</h4>
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
      <button class="toolbar-btn" onclick="setHyphenation('none')" style="justify-content: flex-start; width: 100%; padding: 0.5rem 0.75rem;">
        <span style="width: 24px;">‚úó</span> None
      </button>
      <button class="toolbar-btn" onclick="setHyphenation('auto')" style="justify-content: flex-start; width: 100%; padding: 0.5rem 0.75rem;">
        <span style="width: 24px;">A</span> Automatic
      </button>
      <button class="toolbar-btn" onclick="setHyphenation('manual')" style="justify-content: flex-start; width: 100%; padding: 0.5rem 0.75rem;">
        <span style="width: 24px;">M</span> Manual
      </button>
    </div>
    <hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #eee;">
    <div style="font-size: 12px; color: #666;">
      <div style="margin-bottom: 0.5rem;"><strong>Hyphenation Zone:</strong></div>
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
        <input type="range" id="hyphenZone" min="0.25" max="1" step="0.25" value="0.5" style="flex: 1;">
        <span id="hyphenZoneValue" style="min-width: 35px;">0.5"</span>
      </div>
      <div style="margin-bottom: 0.5rem;"><strong>Consecutive hyphens limit:</strong></div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <input type="number" id="consecutiveHyphens" min="1" max="5" value="3" style="width: 60px; padding: 0.25rem;">
        <span>lines</span>
      </div>
    </div>
    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #eee; display: flex; gap: 0.5rem;">
      <button class="btn btn-secondary" onclick="hideHyphenation()" style="flex: 1; padding: 0.4rem;">Cancel</button>
      <button class="btn btn-primary" onclick="applyHyphenationSettings()" style="flex: 1; padding: 0.4rem;">Apply</button>
    </div>
  </div>

  <!-- Styles Panel Modal -->
  <div class="modal-overlay" id="stylesModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Styles</h3>
        <button class="modal-close" onclick="hideStylesPanel()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Click a style to apply it to selected text.</p>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
          <div class="style-item" onclick="applyStyle('title')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 24px; font-weight: bold;">Title</div>
            <div style="font-size: 11px; color: var(--secondary);">28pt, Bold</div>
          </div>
          <div class="style-item" onclick="applyStyle('heading1')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 20px; font-weight: bold; color: #1a73e8;">Heading 1</div>
            <div style="font-size: 11px; color: var(--secondary);">20pt, Bold, Blue</div>
          </div>
          <div class="style-item" onclick="applyStyle('heading2')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 16px; font-weight: bold; color: #1a73e8;">Heading 2</div>
            <div style="font-size: 11px; color: var(--secondary);">16pt, Bold, Blue</div>
          </div>
          <div class="style-item" onclick="applyStyle('heading3')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 14px; font-weight: bold;">Heading 3</div>
            <div style="font-size: 11px; color: var(--secondary);">14pt, Bold</div>
          </div>
          <div class="style-item" onclick="applyStyle('normal')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 12px;">Normal</div>
            <div style="font-size: 11px; color: var(--secondary);">12pt, Regular</div>
          </div>
          <div class="style-item" onclick="applyStyle('quote')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 12px; font-style: italic; border-left: 3px solid #ccc; padding-left: 8px;">Quote</div>
            <div style="font-size: 11px; color: var(--secondary);">12pt, Italic, Indented</div>
          </div>
          <div class="style-item" onclick="applyStyle('subtitle')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 14px; color: #666;">Subtitle</div>
            <div style="font-size: 11px; color: var(--secondary);">14pt, Gray</div>
          </div>
          <div class="style-item" onclick="applyStyle('code')" style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
            <div style="font-size: 12px; font-family: monospace; background: #f5f5f5; padding: 4px;">Code</div>
            <div style="font-size: 11px; color: var(--secondary);">Monospace, Gray bg</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideStylesPanel()">Close</button>
      </div>
    </div>
  </div>

  <!-- Print Preview Modal -->
  <div class="modal-overlay" id="printPreviewModal">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Print Preview</h3>
        <button class="modal-close" onclick="hidePrintPreview()">&times;</button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: 70vh; background: #666; padding: 2rem;">
        <div id="printPreviewContent" style="background: white; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePrintPreview()">Close</button>
        <button class="btn btn-primary" onclick="window.print()">Print</button>
        <button class="btn btn-success" onclick="exportPDF(); hidePrintPreview();">Export PDF</button>
      </div>
    </div>
  </div>

  <!-- Page Borders Modal -->
  <div class="modal-overlay" id="pageBordersModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Page Borders</h3>
        <button class="modal-close" onclick="hidePageBorders()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Border Style</label>
          <select class="form-control" id="borderStyle">
            <option value="none">None</option>
            <option value="solid">Solid</option>
            <option value="dashed">Dashed</option>
            <option value="dotted">Dotted</option>
            <option value="double">Double</option>
            <option value="groove">Groove</option>
            <option value="ridge">Ridge</option>
            <option value="inset">Inset</option>
            <option value="outset">Outset</option>
          </select>
        </div>
        <div class="form-group">
          <label>Border Width</label>
          <select class="form-control" id="borderWidth">
            <option value="1px">Thin (1px)</option>
            <option value="2px" selected>Medium (2px)</option>
            <option value="3px">Thick (3px)</option>
            <option value="4px">Extra Thick (4px)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Border Color</label>
          <input type="color" class="form-control" id="borderColor" value="#000000" style="height: 40px;">
        </div>
        <div class="form-group">
          <label>Border Art (Decorative)</label>
          <select class="form-control" id="borderArt">
            <option value="none">None</option>
            <option value="shadow">Shadow Effect</option>
            <option value="rounded">Rounded Corners</option>
          </select>
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
          <label style="font-weight: bold;">Preview:</label>
          <div id="borderPreview" style="margin-top: 0.5rem; height: 100px; background: white;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hidePageBorders()">Cancel</button>
        <button class="btn btn-danger" onclick="removePageBorders()">Remove Borders</button>
        <button class="btn btn-primary" onclick="applyPageBorders()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Compare Documents Modal -->
  <div class="modal-overlay" id="compareModal">
    <div class="modal" style="max-width: 900px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Compare Documents</h3>
        <button class="modal-close" onclick="hideCompareDocuments()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div class="form-group">
            <label>Original Document</label>
            <select class="form-control" id="compareOriginal">
              <option value="current">Current Document</option>
            </select>
          </div>
          <div class="form-group">
            <label>Revised Document</label>
            <select class="form-control" id="compareRevised">
              <option value="">Select a document...</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Or paste text to compare:</label>
          <textarea class="form-control" id="compareText" rows="4" placeholder="Paste revised document text here..."></textarea>
        </div>
        <div id="compareResults" style="display: none; margin-top: 1rem;">
          <h4 style="margin-bottom: 0.5rem;">Comparison Results</h4>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <span style="background: #d4edda; padding: 2px 8px; border-radius: 3px;">+ Added</span>
            <span style="background: #f8d7da; padding: 2px 8px; border-radius: 3px; text-decoration: line-through;">- Removed</span>
            <span style="background: #fff3cd; padding: 2px 8px; border-radius: 3px;">~ Modified</span>
          </div>
          <div id="diffOutput" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); padding: 1rem; background: #f9f9f9; font-family: monospace; font-size: 13px; white-space: pre-wrap;"></div>
          <div style="margin-top: 1rem; padding: 0.5rem; background: #e9ecef; border-radius: 4px;">
            <strong>Summary:</strong> <span id="diffSummary"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCompareDocuments()">Close</button>
        <button class="btn btn-primary" onclick="runComparison()">Compare</button>
        <button class="btn btn-success" onclick="applyDiffToDocument()" id="applyDiffBtn" style="display: none;">Apply Changes</button>
      </div>
    </div>
  </div>

  <!-- Revision History Modal -->
  <div class="modal-overlay" id="revisionHistoryModal">
    <div class="modal" style="max-width: 700px; max-height: 90vh;">
      <div class="modal-header">
        <h3>Revision History</h3>
        <button class="modal-close" onclick="hideRevisionHistory()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Document revisions are saved automatically. Click a revision to preview or restore.</p>
        <div id="revisionList" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideRevisionHistory()">Close</button>
        <button class="btn btn-primary" onclick="saveRevision()">Save Current as Revision</button>
      </div>
    </div>
  </div>

  <!-- Endnotes Modal -->
  <div class="modal-overlay" id="endnotesModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Insert Endnote</h3>
        <button class="modal-close" onclick="hideEndnotes()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Endnote Text</label>
          <textarea class="form-control" id="endnoteText" rows="3" placeholder="Enter endnote text..."></textarea>
        </div>
        <div class="form-group">
          <label>Numbering Style</label>
          <select class="form-control" id="endnoteNumbering">
            <option value="numeric">1, 2, 3...</option>
            <option value="roman">i, ii, iii...</option>
            <option value="alpha">a, b, c...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEndnotes()">Cancel</button>
        <button class="btn btn-primary" onclick="insertEndnote()">Insert Endnote</button>
      </div>
    </div>
  </div>

  <!-- Bibliography Modal -->
  <div class="modal-overlay" id="bibliographyModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Citations & Bibliography</h3>
        <button class="modal-close" onclick="hideBibliography()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 1rem;">
          <div style="flex: 1;">
            <h4 style="margin-bottom: 0.5rem;">Add Citation</h4>
            <div class="form-group">
              <label>Citation Type</label>
              <select class="form-control" id="citationType">
                <option value="book">Book</option>
                <option value="journal">Journal Article</option>
                <option value="website">Website</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Author(s)</label>
              <input type="text" class="form-control" id="citationAuthor" placeholder="Last, First">
            </div>
            <div class="form-group">
              <label>Title</label>
              <input type="text" class="form-control" id="citationTitle" placeholder="Title of work">
            </div>
            <div class="form-group">
              <label>Year</label>
              <input type="text" class="form-control" id="citationYear" placeholder="2024">
            </div>
            <div class="form-group">
              <label>Publisher/Source</label>
              <input type="text" class="form-control" id="citationPublisher" placeholder="Publisher or URL">
            </div>
            <button class="btn btn-primary" onclick="addCitation()" style="width: 100%;">Add Citation</button>
          </div>
          <div style="flex: 1; border-left: 1px solid var(--border); padding-left: 1rem;">
            <h4 style="margin-bottom: 0.5rem;">Citations List</h4>
            <div id="citationsList" style="max-height: 300px; overflow-y: auto;"></div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <h4 style="margin-bottom: 0.5rem;">Citation Style</h4>
          <select class="form-control" id="citationStyle" style="width: 200px;">
            <option value="apa">APA (7th Edition)</option>
            <option value="mla">MLA (9th Edition)</option>
            <option value="chicago">Chicago</option>
            <option value="harvard">Harvard</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideBibliography()">Close</button>
        <button class="btn btn-primary" onclick="insertCitation()">Insert Citation</button>
        <button class="btn btn-success" onclick="insertBibliography()">Insert Bibliography</button>
      </div>
    </div>
  </div>

  <!-- Word Art Modal -->
  <div class="modal-overlay" id="wordArtModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Insert Word Art</h3>
        <button class="modal-close" onclick="hideWordArt()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Text</label>
          <input type="text" class="form-control" id="wordArtText" placeholder="Enter your text" value="Word Art">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Style</label>
            <select class="form-control" id="wordArtStyle" onchange="updateWordArtPreview()">
              <option value="gradient">Gradient Fill</option>
              <option value="outline">Outline Only</option>
              <option value="shadow">Drop Shadow</option>
              <option value="glow">Glow Effect</option>
              <option value="reflection">Reflection</option>
              <option value="3d">3D Effect</option>
            </select>
          </div>
          <div class="form-group">
            <label>Font</label>
            <select class="form-control" id="wordArtFont" onchange="updateWordArtPreview()">
              <option value="Impact">Impact</option>
              <option value="Arial Black">Arial Black</option>
              <option value="Georgia">Georgia</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Comic Sans MS">Comic Sans MS</option>
              <option value="Courier New">Courier New</option>
            </select>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Size</label>
            <select class="form-control" id="wordArtSize" onchange="updateWordArtPreview()">
              <option value="36">36pt</option>
              <option value="48" selected>48pt</option>
              <option value="60">60pt</option>
              <option value="72">72pt</option>
              <option value="96">96pt</option>
            </select>
          </div>
          <div class="form-group">
            <label>Primary Color</label>
            <input type="color" class="form-control" id="wordArtColor1" value="#1a73e8" style="height: 38px;" onchange="updateWordArtPreview()">
          </div>
          <div class="form-group">
            <label>Secondary Color</label>
            <input type="color" class="form-control" id="wordArtColor2" value="#ea4335" style="height: 38px;" onchange="updateWordArtPreview()">
          </div>
        </div>
        <div class="form-group">
          <label>Transform</label>
          <select class="form-control" id="wordArtTransform" onchange="updateWordArtPreview()">
            <option value="none">None</option>
            <option value="arch">Arch Up</option>
            <option value="arch-down">Arch Down</option>
            <option value="wave">Wave</option>
            <option value="slant">Slant Up</option>
            <option value="slant-down">Slant Down</option>
          </select>
        </div>
        <div id="wordArtPreview" style="height: 120px; border: 1px solid var(--border); margin-top: 0.5rem; display: flex; justify-content: center; align-items: center; background: #f9f9f9; overflow: hidden;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideWordArt()">Cancel</button>
        <button class="btn btn-primary" onclick="insertWordArt()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Equation Editor Modal -->
  <div class="modal-overlay" id="equationModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Insert Equation</h3>
        <button class="modal-close" onclick="hideEquationEditor()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Common Equations</label>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
            <button class="btn btn-secondary" onclick="insertEquationTemplate('fraction')">a/b</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('sqrt')">‚àöx</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('power')">x¬≤</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('subscript')">x‚ÇÅ</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('sum')">Œ£</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('integral')">‚à´</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('pi')">œÄ</button>
            <button class="btn btn-secondary" onclick="insertEquationTemplate('theta')">Œ∏</button>
          </div>
        </div>
        <div class="form-group">
          <label>Equation (use ^ for superscript, _ for subscript)</label>
          <textarea class="form-control" id="equationInput" rows="3" placeholder="E = mc^2" oninput="updateEquationPreview()"></textarea>
        </div>
        <div class="form-group">
          <label>Preview</label>
          <div id="equationPreview" style="padding: 1rem; background: #f9f9f9; border: 1px solid var(--border); min-height: 60px; font-size: 24px; text-align: center;"></div>
        </div>
        <div class="form-group">
          <label>Symbol Palette</label>
          <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ±')">Œ±</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ≤')">Œ≤</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ≥')">Œ≥</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œ¥')">Œ¥</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œµ')">Œµ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œª')">Œª</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('Œº')">Œº</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('œÉ')">œÉ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('œÜ')">œÜ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('œâ')">œâ</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚àû')">‚àû</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚â†')">‚â†</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚â§')">‚â§</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚â•')">‚â•</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('¬±')">¬±</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('√∑')">√∑</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('√ó')">√ó</button>
            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="addSymbol('‚àö')">‚àö</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEquationEditor()">Cancel</button>
        <button class="btn btn-primary" onclick="insertEquation()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Smart Art Modal -->
  <div class="modal-overlay" id="smartArtModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Insert Smart Art</h3>
        <button class="modal-close" onclick="hideSmartArt()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
          <div>
            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">Diagram Type</label>
            <div id="smartArtTypes" style="display: flex; flex-direction: column; gap: 0.5rem;">
              <button class="btn btn-secondary smart-art-type active" onclick="selectSmartArtType('list')">üìã List</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('process')">‚û°Ô∏è Process</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('cycle')">üîÑ Cycle</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('hierarchy')">üìä Hierarchy</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('relationship')">üîó Relationship</button>
              <button class="btn btn-secondary smart-art-type" onclick="selectSmartArtType('pyramid')">üî∫ Pyramid</button>
            </div>
          </div>
          <div>
            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">Enter Items (one per line)</label>
            <textarea class="form-control" id="smartArtItems" rows="6" placeholder="Item 1&#10;Item 2&#10;Item 3&#10;Item 4" oninput="updateSmartArtPreview()">Step 1
Step 2
Step 3
Step 4</textarea>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Color Scheme</label>
              <select class="form-control" id="smartArtColor" onchange="updateSmartArtPreview()">
                <option value="blue">Blue</option>
                <option value="green">Green</option>
                <option value="orange">Orange</option>
                <option value="purple">Purple</option>
                <option value="rainbow">Rainbow</option>
              </select>
            </div>
            <div id="smartArtPreview" style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); min-height: 150px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSmartArt()">Cancel</button>
        <button class="btn btn-primary" onclick="insertSmartArt()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Cross-Reference Modal -->
  <div class="modal-overlay" id="crossRefModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Insert Cross-Reference</h3>
        <button class="modal-close" onclick="hideCrossRef()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Reference Type</label>
          <select class="form-control" id="crossRefType" onchange="updateCrossRefList()">
            <option value="heading">Heading</option>
            <option value="bookmark">Bookmark</option>
            <option value="footnote">Footnote</option>
          </select>
        </div>
        <div class="form-group">
          <label>Insert Reference To</label>
          <select class="form-control" id="crossRefFormat">
            <option value="text">Text</option>
            <option value="page">Page Number</option>
            <option value="above-below">Above/Below</option>
          </select>
        </div>
        <div class="form-group">
          <label>Available References</label>
          <div id="crossRefList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCrossRef()">Cancel</button>
        <button class="btn btn-primary" onclick="insertCrossRef()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Navigation Pane -->
  <div class="navigation-pane" id="navigationPane">
    <div class="nav-pane-header">
      <span>Navigation</span>
      <button onclick="toggleNavigationPane()" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;">&times;</button>
    </div>
    <div class="nav-pane-tabs">
      <div class="nav-pane-tab active" onclick="switchNavTab('headings')">Headings</div>
      <div class="nav-pane-tab" onclick="switchNavTab('pages')">Pages</div>
      <div class="nav-pane-tab" onclick="switchNavTab('search')">Search</div>
    </div>
    <div class="nav-pane-content" id="navPaneContent">
      <!-- Content populated dynamically -->
    </div>
  </div>

  <!-- Outline Panel -->
  <div class="outline-panel" id="outlinePanel">
    <div class="outline-header">
      <span style="font-weight: 600;">Outline View</span>
      <button onclick="toggleOutlineView()" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;">&times;</button>
    </div>
    <div class="outline-toolbar">
      <button onclick="promoteOutlineLevel()" title="Promote (move up level)">‚Üê Promote</button>
      <button onclick="demoteOutlineLevel()" title="Demote (move down level)">‚Üí Demote</button>
      <button onclick="moveOutlineUp()" title="Move Up">‚Üë Up</button>
      <button onclick="moveOutlineDown()" title="Move Down">‚Üì Down</button>
      <select id="outlineShowLevel" onchange="filterOutlineLevel(this.value)" style="font-size: 0.75rem; padding: 0.2rem;">
        <option value="all">Show All</option>
        <option value="1">Level 1</option>
        <option value="2">Level 1-2</option>
        <option value="3">Level 1-3</option>
      </select>
      <button onclick="expandAllOutline()" title="Expand All">+</button>
      <button onclick="collapseAllOutline()" title="Collapse All">‚àí</button>
    </div>
    <div class="outline-content" id="outlineContent">
      <!-- Outline items populated dynamically -->
    </div>
  </div>

  <!-- Styles Gallery Modal -->
  <div class="modal-overlay" id="stylesGalleryModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Styles Gallery</h3>
        <button class="modal-close" onclick="hideStylesGallery()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Quick Styles</label>
          <div class="styles-gallery" id="quickStyles">
            <div class="style-preview" onclick="applyStyle('normal')">
              <div style="font-size: 12px;">Normal Text</div>
              <small>Normal</small>
            </div>
            <div class="style-preview" onclick="applyStyle('heading1')">
              <div style="font-size: 18px; font-weight: bold; color: #1a73e8;">Heading 1</div>
              <small>Heading 1</small>
            </div>
            <div class="style-preview" onclick="applyStyle('heading2')">
              <div style="font-size: 16px; font-weight: bold; color: #1a73e8;">Heading 2</div>
              <small>Heading 2</small>
            </div>
            <div class="style-preview" onclick="applyStyle('heading3')">
              <div style="font-size: 14px; font-weight: bold; color: #666;">Heading 3</div>
              <small>Heading 3</small>
            </div>
            <div class="style-preview" onclick="applyStyle('title')">
              <div style="font-size: 24px; font-weight: 300;">Title</div>
              <small>Title</small>
            </div>
            <div class="style-preview" onclick="applyStyle('subtitle')">
              <div style="font-size: 14px; color: #666; font-style: italic;">Subtitle</div>
              <small>Subtitle</small>
            </div>
            <div class="style-preview" onclick="applyStyle('quote')">
              <div style="font-size: 12px; font-style: italic; border-left: 3px solid #1a73e8; padding-left: 8px;">Quote</div>
              <small>Quote</small>
            </div>
            <div class="style-preview" onclick="applyStyle('code')">
              <div style="font-family: monospace; font-size: 11px; background: #f5f5f5; padding: 2px 4px;">Code</div>
              <small>Code</small>
            </div>
            <div class="style-preview" onclick="applyStyle('emphasis')">
              <div style="font-size: 12px; font-style: italic;">Emphasis</div>
              <small>Emphasis</small>
            </div>
          </div>
        </div>
        <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
        <div class="form-group">
          <label>Custom Styles</label>
          <div id="customStylesList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
          <button class="btn btn-secondary" onclick="showCreateStyle()" style="margin-top: 0.5rem;">+ Create New Style</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideStylesGallery()">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Custom Style Modal -->
  <div class="modal-overlay" id="createStyleModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Create New Style</h3>
        <button class="modal-close" onclick="hideCreateStyle()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Style Name</label>
          <input type="text" class="form-control" id="customStyleName" placeholder="My Custom Style">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Font Family</label>
            <select class="form-control" id="customStyleFont">
              <option value="Arial">Arial</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Georgia">Georgia</option>
              <option value="Verdana">Verdana</option>
              <option value="Courier New">Courier New</option>
            </select>
          </div>
          <div class="form-group">
            <label>Font Size (px)</label>
            <input type="number" class="form-control" id="customStyleSize" value="12" min="8" max="72">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label>Text Color</label>
            <input type="color" class="form-control" id="customStyleColor" value="#000000" style="height: 40px;">
          </div>
          <div class="form-group">
            <label>Background</label>
            <input type="color" class="form-control" id="customStyleBg" value="#ffffff" style="height: 40px;">
          </div>
        </div>
        <div class="form-group">
          <label>Text Formatting</label>
          <div style="display: flex; gap: 0.5rem;">
            <label><input type="checkbox" id="customStyleBold"> Bold</label>
            <label><input type="checkbox" id="customStyleItalic"> Italic</label>
            <label><input type="checkbox" id="customStyleUnderline"> Underline</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideCreateStyle()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomStyle()">Save Style</button>
      </div>
    </div>
  </div>

  <!-- Advanced Find & Replace Modal -->
  <div class="modal-overlay" id="advancedFindModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Advanced Find & Replace</h3>
        <button class="modal-close" onclick="hideAdvancedFind()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Find</label>
          <input type="text" class="form-control" id="advFindInput" placeholder="Search text or pattern">
        </div>
        <div class="form-group">
          <label>Replace with</label>
          <input type="text" class="form-control" id="advReplaceInput" placeholder="Replacement text">
        </div>
        <div class="form-group">
          <label>Options</label>
          <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
            <label><input type="checkbox" id="advFindCase"> Match case</label>
            <label><input type="checkbox" id="advFindWholeWord"> Whole words only</label>
            <label><input type="checkbox" id="advFindRegex"> Use regular expressions</label>
          </div>
        </div>
        <div id="advFindResults" style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px; margin-top: 1rem;">
          <span style="color: #666;">Enter search text and click Find All</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="advFindAll()">Find All</button>
        <button class="btn btn-secondary" onclick="advFindNext()">Find Next</button>
        <button class="btn btn-primary" onclick="advReplace()">Replace</button>
        <button class="btn btn-primary" onclick="advReplaceAll()">Replace All</button>
      </div>
    </div>
  </div>

  <!-- Find Formatting Modal -->
  <div class="modal-overlay" id="findFormattingModal">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h3>Find Formatting</h3>
        <button class="modal-close" onclick="hideFindFormatting()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Find text with specific formatting in your document.</p>

        <div class="form-group">
          <label style="font-weight: 600;">Find by Format Type</label>
          <select class="form-control" id="findFormatType" onchange="updateFindFormatOptions()">
            <option value="highlight">Highlighted Text</option>
            <option value="bold">Bold Text</option>
            <option value="italic">Italic Text</option>
            <option value="underline">Underlined Text</option>
            <option value="strikethrough">Strikethrough Text</option>
            <option value="color">Text Color</option>
            <option value="bgcolor">Background Color</option>
            <option value="font">Specific Font</option>
          </select>
        </div>

        <div id="formatColorOption" style="display: none;" class="form-group">
          <label>Select Color</label>
          <input type="color" class="form-control" id="findFormatColor" value="#ffff00" style="width: 100px; height: 36px;">
        </div>

        <div id="formatFontOption" style="display: none;" class="form-group">
          <label>Select Font</label>
          <select class="form-control" id="findFormatFont">
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Georgia">Georgia</option>
            <option value="Courier New">Courier New</option>
            <option value="Verdana">Verdana</option>
          </select>
        </div>

        <div style="margin-top: 1rem;">
          <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Results (<span id="formatResultCount">0</span> found)</label>
          <div id="findFormatResults" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; background: #f9f9f9;">
            <p style="color: #666; text-align: center; margin: 1rem 0;">Click "Find All" to search</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideFindFormatting()">Close</button>
        <button class="btn btn-secondary" onclick="clearFoundFormatting()">Clear Highlights</button>
        <button class="btn btn-primary" onclick="findAllFormatting()">Find All</button>
      </div>
    </div>
  </div>

  <!-- Accessibility Checker Modal -->
  <div class="modal-overlay" id="accessibilityModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>‚ôø Accessibility Checker</h3>
        <button class="modal-close" onclick="hideAccessibilityChecker()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Check your document for accessibility issues and improve readability for screen readers.</p>

        <div style="margin-bottom: 1rem;">
          <button class="btn btn-primary" onclick="runAccessibilityCheck()">Check Accessibility</button>
          <button class="btn btn-secondary" onclick="clearAccessibilityResults()">Clear Results</button>
        </div>

        <div id="accessibilityResults" style="max-height: 350px; overflow-y: auto;">
          <div id="accessibilityErrors" style="display: none; margin-bottom: 1rem;">
            <h4 style="color: #d93025; margin-bottom: 0.5rem;">‚ö† Errors</h4>
            <div id="accessibilityErrorList" style="border: 1px solid #fce8e6; border-radius: 4px; background: #fef7f7;"></div>
          </div>

          <div id="accessibilityWarnings" style="display: none; margin-bottom: 1rem;">
            <h4 style="color: #f9ab00; margin-bottom: 0.5rem;">‚ö° Warnings</h4>
            <div id="accessibilityWarningList" style="border: 1px solid #fef3e0; border-radius: 4px; background: #fffcf7;"></div>
          </div>

          <div id="accessibilityTips" style="display: none; margin-bottom: 1rem;">
            <h4 style="color: #1a73e8; margin-bottom: 0.5rem;">üí° Tips</h4>
            <div id="accessibilityTipList" style="border: 1px solid #e8f0fe; border-radius: 4px; background: #f8fbff;"></div>
          </div>

          <div id="accessibilitySuccess" style="display: none; text-align: center; padding: 2rem;">
            <div style="font-size: 48px; margin-bottom: 0.5rem;">‚úì</div>
            <h4 style="color: #34a853;">No accessibility issues found!</h4>
            <p style="color: var(--secondary);">Your document is accessible.</p>
          </div>

          <div id="accessibilityEmpty" style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 48px; margin-bottom: 0.5rem;">‚ôø</div>
            <p>Click "Check Accessibility" to analyze your document.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAccessibilityChecker()">Close</button>
      </div>
    </div>
  </div>

  <!-- Stock Images Modal -->
  <div class="modal-overlay" id="stockImagesModal">
    <div class="modal" style="max-width: 800px; max-height: 90vh;">
      <div class="modal-header">
        <h3>üåê Stock Images</h3>
        <button class="modal-close" onclick="hideStockImages()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--secondary); margin-bottom: 1rem;">Search free stock images from Unsplash, Pexels, and Pixabay.</p>

        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <input type="text" class="form-control" id="stockImageSearch" placeholder="Search for images (e.g., nature, business, technology)" style="flex: 1;" onkeyup="if(event.key==='Enter')searchStockImages()">
          <button class="btn btn-primary" onclick="searchStockImages()">üîç Search</button>
        </div>

        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button class="btn btn-sm btn-secondary stock-category" onclick="searchStockCategory('nature')">üåø Nature</button>
          <button class="btn btn-sm btn-secondary stock-category" onclick="searchStockCategory('business')">üíº Business</button>
          <button class="btn btn-sm btn-secondary stock-category" onclick="searchStockCategory('technology')">üíª Technology</button>
          <button class="btn btn-sm btn-secondary stock-category" onclick="searchStockCategory('people')">üë• People</button>
          <button class="btn btn-sm btn-secondary stock-category" onclick="searchStockCategory('food')">üçî Food</button>
          <button class="btn btn-sm btn-secondary stock-category" onclick="searchStockCategory('travel')">‚úàÔ∏è Travel</button>
        </div>

        <div id="stockImagesGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; max-height: 400px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: #f9f9f9;">
          <div style="grid-column: span 4; text-align: center; padding: 3rem; color: #666;">
            <div style="font-size: 48px; margin-bottom: 0.5rem;">üñºÔ∏è</div>
            <p>Search for images above or click a category to browse.</p>
          </div>
        </div>

        <div id="stockImagePreview" style="display: none; margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
          <h4 style="margin-bottom: 0.5rem;">Selected Image</h4>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <img id="stockPreviewImg" src="" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
            <div>
              <p id="stockImageCredit" style="font-size: 0.85rem; color: #666;"></p>
              <div style="margin-top: 0.5rem;">
                <label style="font-size: 0.9rem;">Size:</label>
                <select class="form-control" id="stockImageSize" style="width: auto; display: inline-block; margin-left: 0.5rem;">
                  <option value="small">Small (300px)</option>
                  <option value="medium" selected>Medium (600px)</option>
                  <option value="large">Large (1200px)</option>
                  <option value="original">Original</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideStockImages()">Cancel</button>
        <button class="btn btn-primary" onclick="insertStockImage()" id="insertStockBtn" disabled>Insert Image</button>
      </div>
    </div>
  </div>

  <!-- Index Modal -->
  <div class="modal-overlay" id="indexModal">
    <div class="modal" style="max-width: 650px;">
      <div class="modal-header">
        <h3>Index</h3>
        <button class="modal-close" onclick="hideIndexModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <button class="btn btn-secondary" onclick="showMarkIndexEntry()" id="markEntryBtn">Mark Entry</button>
          <button class="btn btn-secondary" onclick="showMarkAllEntries()">Mark All</button>
          <button class="btn btn-primary" onclick="insertIndex()">Insert Index</button>
          <button class="btn btn-secondary" onclick="updateIndex()">Update Index</button>
        </div>

        <div id="markEntrySection" style="display: none; padding: 1rem; background: #f9f9f9; border-radius: 8px; margin-bottom: 1rem;">
          <h4 style="margin-bottom: 0.75rem;">Mark Index Entry</h4>
          <div class="form-group">
            <label>Main entry</label>
            <input type="text" class="form-control" id="indexMainEntry" placeholder="Enter main entry text">
          </div>
          <div class="form-group">
            <label>Subentry (optional)</label>
            <input type="text" class="form-control" id="indexSubEntry" placeholder="Enter subentry text">
          </div>
          <div class="form-group">
            <label>Options</label>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
              <label><input type="radio" name="indexType" value="page" checked> Current page</label>
              <label><input type="radio" name="indexType" value="range"> Page range</label>
              <label><input type="radio" name="indexType" value="crossref"> Cross-reference</label>
            </div>
          </div>
          <div class="form-group" id="crossRefField" style="display: none;">
            <label>Cross-reference text</label>
            <input type="text" class="form-control" id="indexCrossRef" placeholder="See also...">
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="markIndexEntry()">Mark</button>
            <button class="btn btn-secondary" onclick="markAllOccurrences()">Mark All</button>
            <button class="btn btn-secondary" onclick="hideMarkEntry()">Cancel</button>
          </div>
        </div>

        <div class="form-group">
          <label>Index Format</label>
          <select class="form-control" id="indexFormat">
            <option value="indented">Indented</option>
            <option value="run-in">Run-in</option>
          </select>
        </div>
        <div class="form-group">
          <label>Columns</label>
          <select class="form-control" id="indexColumns">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
          </select>
        </div>

        <div style="margin-top: 1rem;">
          <h4>Index Entries (<span id="indexEntryCount">0</span>)</h4>
          <div id="indexEntriesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: white;">
            <div style="color: #999; font-style: italic;">No index entries marked yet</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="clearAllIndexEntries()">Clear All Entries</button>
        <button class="btn btn-secondary" onclick="hideIndexModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Quick Parts Modal -->
  <div class="modal-overlay" id="quickPartsModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Quick Parts / AutoText</h3>
        <button class="modal-close" onclick="hideQuickParts()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem;">
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Categories</label>
            <div id="quickPartsCategories" style="border: 1px solid var(--border); border-radius: 4px; overflow: hidden;">
              <div class="quickparts-category active" onclick="selectQuickPartsCategory('general')" data-category="general">General</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('headers')" data-category="headers">Headers & Footers</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('textboxes')" data-category="textboxes">Text Boxes</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('coverpage')" data-category="coverpage">Cover Pages</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('autotext')" data-category="autotext">AutoText</div>
              <div class="quickparts-category" onclick="selectQuickPartsCategory('custom')" data-category="custom">My Custom</div>
            </div>
          </div>
          <div>
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Quick Parts</label>
            <div id="quickPartsGallery" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.75rem; background: #f9f9f9;"></div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <label style="font-weight: 600;">Save Selection as Quick Part</label>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="text" class="form-control" id="quickPartName" placeholder="Enter name for selection...">
            <select class="form-control" id="quickPartCategory" style="width: 150px;">
              <option value="general">General</option>
              <option value="headers">Headers & Footers</option>
              <option value="textboxes">Text Boxes</option>
              <option value="autotext">AutoText</option>
              <option value="custom">My Custom</option>
            </select>
            <button class="btn btn-secondary" onclick="saveQuickPart()">Save</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideQuickParts()">Close</button>
        <button class="btn btn-primary" onclick="insertSelectedQuickPart()">Insert</button>
      </div>
    </div>
  </div>

  <!-- QR Code Generator Modal -->
  <div class="modal-overlay" id="qrCodeModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>‚ñ£ QR Code Generator</h3>
        <button class="modal-close" onclick="hideQRCodeGenerator()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="font-weight: 600;">Content Type</label>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-secondary qr-type-btn active" onclick="selectQRType('url')" data-type="url">üîó URL</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('text')" data-type="text">üìù Text</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('email')" data-type="email">üìß Email</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('phone')" data-type="phone">üìû Phone</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('wifi')" data-type="wifi">üì∂ WiFi</button>
            <button class="btn btn-secondary qr-type-btn" onclick="selectQRType('vcard')" data-type="vcard">üë§ vCard</button>
          </div>
        </div>

        <div id="qrUrlPanel" class="qr-input-panel">
          <div class="form-group">
            <label>URL:</label>
            <input type="url" class="form-control" id="qrUrl" placeholder="https://example.com" oninput="generateQRPreview()">
          </div>
        </div>

        <div id="qrTextPanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Text Content:</label>
            <textarea class="form-control" id="qrText" rows="3" placeholder="Enter any text..." oninput="generateQRPreview()"></textarea>
          </div>
        </div>

        <div id="qrEmailPanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Email Address:</label>
            <input type="email" class="form-control" id="qrEmail" placeholder="email@example.com" oninput="generateQRPreview()">
          </div>
          <div class="form-group">
            <label>Subject (optional):</label>
            <input type="text" class="form-control" id="qrEmailSubject" placeholder="Subject" oninput="generateQRPreview()">
          </div>
        </div>

        <div id="qrPhonePanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Phone Number:</label>
            <input type="tel" class="form-control" id="qrPhone" placeholder="+1234567890" oninput="generateQRPreview()">
          </div>
        </div>

        <div id="qrWifiPanel" class="qr-input-panel" style="display: none;">
          <div class="form-group">
            <label>Network Name (SSID):</label>
            <input type="text" class="form-control" id="qrWifiSsid" placeholder="WiFi Network Name" oninput="generateQRPreview()">
          </div>
          <div class="form-group">
            <label>Password:</label>
            <input type="text" class="form-control" id="qrWifiPassword" placeholder="Password" oninput="generateQRPreview()">
          </div>
          <div class="form-group">
            <label>Security Type:</label>
            <select class="form-control" id="qrWifiSecurity" onchange="generateQRPreview()">
              <option value="WPA">WPA/WPA2</option>
              <option value="WEP">WEP</option>
              <option value="nopass">None (Open)</option>
            </select>
          </div>
        </div>

        <div id="qrVcardPanel" class="qr-input-panel" style="display: none;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div class="form-group">
              <label>First Name:</label>
              <input type="text" class="form-control" id="qrVcardFirst" placeholder="John" oninput="generateQRPreview()">
            </div>
            <div class="form-group">
              <label>Last Name:</label>
              <input type="text" class="form-control" id="qrVcardLast" placeholder="Doe" oninput="generateQRPreview()">
            </div>
          </div>
          <div class="form-group">
            <label>Phone:</label>
            <input type="tel" class="form-control" id="qrVcardPhone" placeholder="+1234567890" oninput="generateQRPreview()">
          </div>
          <div class="form-group">
            <label>Email:</label>
            <input type="email" class="form-control" id="qrVcardEmail" placeholder="email@example.com" oninput="generateQRPreview()">
          </div>
          <div class="form-group">
            <label>Company:</label>
            <input type="text" class="form-control" id="qrVcardOrg" placeholder="Company Name" oninput="generateQRPreview()">
          </div>
        </div>

        <div class="form-group" style="margin-top: 1rem;">
          <label style="font-weight: 600;">QR Code Size:</label>
          <select class="form-control" id="qrSize" onchange="generateQRPreview()" style="width: auto;">
            <option value="100">Small (100px)</option>
            <option value="150" selected>Medium (150px)</option>
            <option value="200">Large (200px)</option>
            <option value="300">Extra Large (300px)</option>
          </select>
        </div>

        <div style="margin-top: 1rem; text-align: center;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Preview:</label>
          <div id="qrPreview" style="display: inline-block; padding: 1rem; background: white; border: 1px solid #ddd; border-radius: 8px; min-height: 150px; min-width: 150px;">
            <span style="color: #999;">Enter content to generate QR code</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideQRCodeGenerator()">Cancel</button>
        <button class="btn btn-primary" onclick="insertQRCode()">Insert QR Code</button>
      </div>
    </div>
  </div>

  <!-- Version History Modal -->
  <div class="modal-overlay" id="versionHistoryModal">
    <div class="modal" style="max-width: 600px; max-height: 80vh;">
      <div class="modal-header">
        <h3>üìú Version History</h3>
        <button class="modal-close" onclick="hideVersionHistory()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
          <div>
            <strong>Auto-Save Status:</strong>
            <span id="autoSaveStatus" style="margin-left: 0.5rem; color: #d93025;">Disabled</span>
          </div>
          <div>
            <label style="font-size: 0.9rem;">
              <input type="checkbox" id="autoSaveCheckbox" onchange="toggleAutoSaveFromModal()"> Enable Auto-Save
            </label>
          </div>
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="font-weight: 600;">Auto-Save Interval:</label>
          <select class="form-control" id="autoSaveInterval" style="width: auto; display: inline-block; margin-left: 0.5rem;" onchange="updateAutoSaveInterval()">
            <option value="30000">30 seconds</option>
            <option value="60000" selected>1 minute</option>
            <option value="120000">2 minutes</option>
            <option value="300000">5 minutes</option>
          </select>
        </div>
        <div style="margin-bottom: 1rem;">
          <button class="btn btn-secondary" onclick="createManualVersion()">üì∏ Save Version Now</button>
          <button class="btn btn-secondary" onclick="clearVersionHistory()" style="margin-left: 0.5rem;">üóë Clear History</button>
        </div>
        <h4 style="margin-bottom: 0.5rem;">Saved Versions</h4>
        <div id="versionList" style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
          <div style="padding: 1rem; text-align: center; color: #666;">No versions saved yet</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideVersionHistory()">Close</button>
      </div>
    </div>
  </div>

  <!-- Recent Documents Modal -->
  <div class="modal-overlay" id="recentDocumentsModal">
    <div class="modal" style="max-width: 650px; max-height: 80vh;">
      <div class="modal-header">
        <h3>üìÇ Recent Documents</h3>
        <button class="modal-close" onclick="hideRecentDocuments()">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <input type="text" class="form-control" id="recentSearchInput" placeholder="Search documents..." style="flex: 1;" oninput="filterRecentDocuments()">
          <select class="form-control" id="recentSortSelect" style="width: auto;" onchange="sortRecentDocuments()">
            <option value="date">Sort by Date</option>
            <option value="name">Sort by Name</option>
            <option value="size">Sort by Size</option>
          </select>
        </div>
        <div id="recentDocumentsList" style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
          <div style="padding: 2rem; text-align: center; color: #666;">
            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">No recent documents</p>
            <p style="font-size: 0.9rem;">Documents you save will appear here</p>
          </div>
        </div>
        <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
          <span id="recentDocCount" style="color: #666; font-size: 0.9rem;">0 documents</span>
          <button class="btn btn-secondary" onclick="clearRecentDocuments()">üóë Clear History</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideRecentDocuments()">Close</button>
      </div>
    </div>
  </div>

  <!-- Digital Signature Modal -->
  <div class="modal-overlay" id="digitalSignatureModal">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h3>Digital Signature</h3>
        <button class="modal-close" onclick="hideDigitalSignature()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label style="font-weight: 600;">Signature Type</label>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-secondary signature-type-btn active" onclick="selectSignatureType('draw')" data-type="draw">‚úèÔ∏è Draw</button>
            <button class="btn btn-secondary signature-type-btn" onclick="selectSignatureType('type')" data-type="type">‚å®Ô∏è Type</button>
            <button class="btn btn-secondary signature-type-btn" onclick="selectSignatureType('upload')" data-type="upload">üì§ Upload</button>
          </div>
        </div>

        <div id="signatureDrawPanel" class="signature-panel">
          <label>Draw your signature:</label>
          <canvas id="signatureCanvas" width="480" height="150" style="border: 2px solid #ddd; border-radius: 8px; cursor: crosshair; background: white; display: block; margin-top: 0.5rem;"></canvas>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-secondary" onclick="clearSignatureCanvas()">Clear</button>
            <select class="form-control" id="signaturePenColor" onchange="updateSignaturePen()" style="width: 120px;">
              <option value="#000000">Black</option>
              <option value="#1a73e8">Blue</option>
              <option value="#0d47a1">Dark Blue</option>
            </select>
            <select class="form-control" id="signaturePenSize" onchange="updateSignaturePen()" style="width: 100px;">
              <option value="2">Thin</option>
              <option value="3" selected>Medium</option>
              <option value="5">Thick</option>
            </select>
          </div>
        </div>

        <div id="signatureTypePanel" class="signature-panel" style="display: none;">
          <label>Type your signature:</label>
          <input type="text" class="form-control" id="signatureText" placeholder="Your Name" style="margin-top: 0.5rem;" oninput="updateTypedSignaturePreview()">
          <label style="margin-top: 1rem;">Font Style:</label>
          <select class="form-control" id="signatureFont" onchange="updateTypedSignaturePreview()">
            <option value="'Brush Script MT', cursive">Script</option>
            <option value="'Segoe Script', cursive">Segoe Script</option>
            <option value="'Lucida Handwriting', cursive">Lucida</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="'Times New Roman', serif">Times</option>
          </select>
          <div id="typedSignaturePreview" style="margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 8px; text-align: center; min-height: 60px; font-size: 28px;"></div>
        </div>

        <div id="signatureUploadPanel" class="signature-panel" style="display: none;">
          <label>Upload signature image:</label>
          <input type="file" class="form-control" id="signatureUpload" accept="image/*" onchange="previewUploadedSignature()" style="margin-top: 0.5rem;">
          <div id="uploadedSignaturePreview" style="margin-top: 1rem; text-align: center; min-height: 100px; background: #f9f9f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <span style="color: #666;">No image selected</span>
          </div>
        </div>

        <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <label style="font-weight: 600;">Signer Information</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="text" class="form-control" id="signerName" placeholder="Full Name">
            <input type="text" class="form-control" id="signerTitle" placeholder="Title (optional)">
          </div>
          <div style="margin-top: 0.5rem;">
            <label><input type="checkbox" id="includeDate" checked> Include date</label>
            <label style="margin-left: 1rem;"><input type="checkbox" id="includeTimestamp"> Include timestamp</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDigitalSignature()">Cancel</button>
        <button class="btn btn-primary" onclick="insertDigitalSignature()">Insert Signature</button>
      </div>
    </div>
  </div>

  <!-- Symbol Picker Modal -->
  <div class="modal-overlay" id="symbolModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Insert Symbol</h3>
        <button class="modal-close" onclick="hideSymbolPicker()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="symbol-category-tabs" id="symbolCategoryTabs"></div>
        <div class="symbol-grid" id="symbolGrid"></div>
        <div class="symbol-preview">
          <div class="symbol-preview-char" id="symbolPreviewChar">‚Äî</div>
          <div class="symbol-preview-info" id="symbolPreviewInfo">Select a symbol</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideSymbolPicker()">Close</button>
        <button class="btn btn-primary" onclick="insertSelectedSymbol()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Text Box Modal -->
  <div class="modal-overlay" id="textBoxModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Insert Text Box</h3>
        <button class="modal-close" onclick="hideTextBoxModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Text Box Style</label>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
            <div class="textbox-style-option selected" onclick="selectTextBoxStyle('simple')" data-style="simple" style="padding: 1rem; border: 2px solid #1a73e8; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 1px solid #333; padding: 8px; font-size: 0.7rem;">Simple</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('shadow')" data-style="shadow" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 1px solid #333; padding: 8px; font-size: 0.7rem; box-shadow: 3px 3px 5px rgba(0,0,0,0.3);">Shadow</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('rounded')" data-style="rounded" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 1px solid #333; padding: 8px; font-size: 0.7rem; border-radius: 12px;">Rounded</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('colored')" data-style="colored" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: 2px solid #1a73e8; padding: 8px; font-size: 0.7rem; background: #e3f2fd;">Colored</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('callout')" data-style="callout" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border-left: 4px solid #1a73e8; padding: 8px; font-size: 0.7rem; background: #f5f5f5;">Callout</div>
            </div>
            <div class="textbox-style-option" onclick="selectTextBoxStyle('quote')" data-style="quote" style="padding: 1rem; border: 2px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer;">
              <div style="border: none; padding: 8px; font-size: 0.7rem; font-style: italic; background: #f9f9f9;">"Quote"</div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Size</label>
          <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
            <div>
              <label style="font-size: 0.85rem;">Width</label>
              <input type="number" class="form-control" id="textBoxWidth" value="300" min="100" max="800" style="width: 100px;">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Height</label>
              <input type="number" class="form-control" id="textBoxHeight" value="150" min="50" max="600" style="width: 100px;">
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Position</label>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
            <label><input type="radio" name="textBoxPosition" value="inline" checked> Inline with text</label>
            <label><input type="radio" name="textBoxPosition" value="float-left"> Float left</label>
            <label><input type="radio" name="textBoxPosition" value="float-right"> Float right</label>
          </div>
        </div>
        <div class="form-group">
          <label>Colors</label>
          <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
            <div>
              <label style="font-size: 0.85rem;">Border</label>
              <input type="color" class="form-control" id="textBoxBorderColor" value="#333333" style="height: 36px; width: 60px;">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Background</label>
              <input type="color" class="form-control" id="textBoxBgColor" value="#ffffff" style="height: 36px; width: 60px;">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideTextBoxModal()">Cancel</button>
        <button class="btn btn-primary" onclick="insertTextBox()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Document Inspector Modal -->
  <div class="modal-overlay" id="documentInspectorModal">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h3>Document Inspector</h3>
        <button class="modal-close" onclick="hideDocumentInspector()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: #666; margin-bottom: 1rem;">Inspect your document for hidden data and personal information that might be stored in the document.</p>
        <div id="inspectorResults" style="max-height: 400px; overflow-y: auto;">
          <div class="inspector-item" data-type="comments">
            <div class="inspector-header">
              <input type="checkbox" id="inspectComments" checked>
              <label for="inspectComments"><strong>üí¨ Comments & Revisions</strong></label>
            </div>
            <div class="inspector-result" id="resultComments"></div>
          </div>
          <div class="inspector-item" data-type="properties">
            <div class="inspector-header">
              <input type="checkbox" id="inspectProperties" checked>
              <label for="inspectProperties"><strong>üìã Document Properties</strong></label>
            </div>
            <div class="inspector-result" id="resultProperties"></div>
          </div>
          <div class="inspector-item" data-type="hiddenText">
            <div class="inspector-header">
              <input type="checkbox" id="inspectHiddenText" checked>
              <label for="inspectHiddenText"><strong>üëÅ Hidden Text</strong></label>
            </div>
            <div class="inspector-result" id="resultHiddenText"></div>
          </div>
          <div class="inspector-item" data-type="personalInfo">
            <div class="inspector-header">
              <input type="checkbox" id="inspectPersonalInfo" checked>
              <label for="inspectPersonalInfo"><strong>üë§ Personal Information</strong></label>
            </div>
            <div class="inspector-result" id="resultPersonalInfo"></div>
          </div>
          <div class="inspector-item" data-type="links">
            <div class="inspector-header">
              <input type="checkbox" id="inspectLinks" checked>
              <label for="inspectLinks"><strong>üîó Hyperlinks</strong></label>
            </div>
            <div class="inspector-result" id="resultLinks"></div>
          </div>
          <div class="inspector-item" data-type="images">
            <div class="inspector-header">
              <input type="checkbox" id="inspectImages" checked>
              <label for="inspectImages"><strong>üñº Embedded Images</strong></label>
            </div>
            <div class="inspector-result" id="resultImages"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDocumentInspector()">Close</button>
        <button class="btn btn-warning" onclick="removeAllInspected()">Remove All Found</button>
        <button class="btn btn-primary" onclick="runDocumentInspector()">Inspect</button>
      </div>
    </div>
  </div>

  <!-- Insert Table Modal -->
  <div class="modal-overlay" id="insertTableModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Insert Table</h3>
        <button class="modal-close" onclick="hideInsertTableModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-grid-container">
          <div class="table-grid" id="tableGrid"></div>
          <div class="table-size-display" id="tableSizeDisplay">Select table size</div>

          <div style="width: 100%; text-align: center; margin: 0.5rem 0; color: #999;">‚Äî or ‚Äî</div>

          <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.85rem;">Rows</label>
              <input type="number" class="form-control" id="tableRows" value="3" min="1" max="50" style="width: 70px;">
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.85rem;">Columns</label>
              <input type="number" class="form-control" id="tableCols" value="3" min="1" max="20" style="width: 70px;">
            </div>
          </div>

          <div class="table-options">
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.85rem;">Style</label>
              <select class="form-control" id="tableStyle">
                <option value="basic">Basic</option>
                <option value="bordered">Bordered</option>
                <option value="striped">Striped</option>
                <option value="modern">Modern</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" id="tableHeader" checked> Header Row
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideInsertTableModal()">Cancel</button>
        <button class="btn btn-primary" onclick="insertTableFromModal()">Insert Table</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="fileImport" accept=".njword,.json" style="display: none;" onchange="handleFileImport(event)">
  <input type="file" id="docxImport" accept=".docx" style="display: none;" onchange="handleDocxImport(event)">
  <input type="file" id="compareFileInput" accept=".njword,.json,.docx,.txt" style="display: none;" onchange="handleCompareFileImport(event)">

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Focus Mode Indicator -->
  <div class="focus-indicator" id="focusIndicator">
    <div class="focus-indicator-dot"></div>
    <span>Focus Mode (Esc to exit)</span>
  </div>

  <!-- Typewriter Mode Indicator -->
  <div class="typewriter-indicator" id="typewriterIndicator">
    <span>‚å® Typewriter Mode</span>
  </div>

  <!-- Word Frequency Popup -->
  <div class="modal-overlay" id="wordFreqOverlay" onclick="hideWordFrequency()"></div>
  <div class="word-freq-popup" id="wordFreqPopup">
    <div class="word-freq-header">
      <h3>Word Frequency Analysis</h3>
      <button class="word-freq-close" onclick="hideWordFrequency()">&times;</button>
    </div>
    <div class="word-freq-content">
      <div class="word-freq-stats">
        <div class="word-freq-stat">
          <div class="word-freq-stat-value" id="wfTotalWords">0</div>
          <div class="word-freq-stat-label">Total Words</div>
        </div>
        <div class="word-freq-stat">
          <div class="word-freq-stat-value" id="wfUniqueWords">0</div>
          <div class="word-freq-stat-label">Unique Words</div>
        </div>
        <div class="word-freq-stat">
          <div class="word-freq-stat-value" id="wfVocabRichness">0%</div>
          <div class="word-freq-stat-label">Vocab Richness</div>
        </div>
      </div>
      <div class="word-freq-tabs">
        <button class="word-freq-tab active" onclick="showWordFreqTab('all')">All Words</button>
        <button class="word-freq-tab" onclick="showWordFreqTab('long')">Long Words (6+)</button>
        <button class="word-freq-tab" onclick="showWordFreqTab('nocommon')">Exclude Common</button>
      </div>
      <ul class="word-freq-list" id="wordFreqList"></ul>
    </div>
  </div>

  <!-- Smart Text Popup -->
  <div class="modal-overlay" id="smartTextOverlay" onclick="hideSmartText()"></div>
  <div class="smart-text-popup" id="smartTextPopup">
    <div class="smart-text-header">
      <h3>‚ú® Smart Text</h3>
      <button class="word-freq-close" onclick="hideSmartText()">&times;</button>
    </div>
    <div class="smart-text-content">
      <div class="smart-text-option">
        <div class="smart-text-label">
          <span>Smart Quotes</span>
          <small>"quotes" ‚Üí "quotes"</small>
        </div>
        <label class="smart-text-toggle">
          <input type="checkbox" id="stSmartQuotes" onchange="saveSmartTextSettings()">
          <span class="smart-text-slider"></span>
        </label>
      </div>
      <div class="smart-text-option">
        <div class="smart-text-label">
          <span>Em Dash</span>
          <small>-- ‚Üí ‚Äî</small>
        </div>
        <label class="smart-text-toggle">
          <input type="checkbox" id="stEmDash" onchange="saveSmartTextSettings()">
          <span class="smart-text-slider"></span>
        </label>
      </div>
      <div class="smart-text-option">
        <div class="smart-text-label">
          <span>Ellipsis</span>
          <small>... ‚Üí ‚Ä¶</small>
        </div>
        <label class="smart-text-toggle">
          <input type="checkbox" id="stEllipsis" onchange="saveSmartTextSettings()">
          <span class="smart-text-slider"></span>
        </label>
      </div>
      <div class="smart-text-option">
        <div class="smart-text-label">
          <span>Auto-Capitalize</span>
          <small>Capitalize after . ! ?</small>
        </div>
        <label class="smart-text-toggle">
          <input type="checkbox" id="stAutoCapitalize" onchange="saveSmartTextSettings()">
          <span class="smart-text-slider"></span>
        </label>
      </div>
      <div class="smart-text-option">
        <div class="smart-text-label">
          <span>Fractions</span>
          <small>1/2 ‚Üí ¬Ω, 1/4 ‚Üí ¬º</small>
        </div>
        <label class="smart-text-toggle">
          <input type="checkbox" id="stFractions" onchange="saveSmartTextSettings()">
          <span class="smart-text-slider"></span>
        </label>
      </div>
      <div class="smart-text-option">
        <div class="smart-text-label">
          <span>Arrows</span>
          <small>-> ‚Üí ‚Üí, <- ‚Üí ‚Üê</small>
        </div>
        <label class="smart-text-toggle">
          <input type="checkbox" id="stArrows" onchange="saveSmartTextSettings()">
          <span class="smart-text-slider"></span>
        </label>
      </div>
    </div>
  </div>
  <div class="smart-text-indicator" id="smartTextIndicator"></div>

  <!-- Reading Progress Bar -->
  <div class="reading-progress-bar" id="readingProgressBar"></div>

  <!-- Reading Progress Info Panel -->
  <div class="reading-progress-info" id="readingProgressInfo">
    <h4>üìä Reading Progress</h4>
    <div class="reading-stat">
      <label>Progress:</label>
      <span id="progressPercent">0%</span>
    </div>
    <div class="reading-stat">
      <label>Words Read:</label>
      <span id="wordsRead">0</span>
    </div>
    <div class="reading-stat">
      <label>Time Reading:</label>
      <span id="timeReading">0:00</span>
    </div>
    <div class="reading-stat">
      <label>Est. Time Left:</label>
      <span id="timeRemaining">--</span>
    </div>
    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
      <div class="reading-stat">
        <label>Reading Speed:</label>
        <span id="readingSpeed">-- wpm</span>
      </div>
    </div>
  </div>

  <!-- Document Statistics Modal -->
  <div class="modal-overlay" id="docStatsModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3>üìà Document Statistics</h3>
        <button class="modal-close" onclick="hideDocumentStatistics()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div style="padding: 1rem; background: #e8f0fe; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #1a73e8;" id="statWords">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Words</div>
          </div>
          <div style="padding: 1rem; background: #e8f5e9; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #34a853;" id="statChars">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Characters</div>
          </div>
          <div style="padding: 1rem; background: #fff3e0; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #f57c00;" id="statSentences">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Sentences</div>
          </div>
          <div style="padding: 1rem; background: #f3e5f5; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #9c27b0;" id="statParagraphs">0</div>
            <div style="font-size: 0.85rem; color: var(--secondary);">Paragraphs</div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
          <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem;">Reading Time Estimates</h4>
          <div class="reading-stat">
            <label>Average Reader (~200 wpm):</label>
            <span id="statReadAvg">0 min</span>
          </div>
          <div class="reading-stat">
            <label>Fast Reader (~300 wpm):</label>
            <span id="statReadFast">0 min</span>
          </div>
          <div class="reading-stat">
            <label>Speaking Time (~150 wpm):</label>
            <span id="statSpeak">0 min</span>
          </div>
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
          <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem;">Readability</h4>
          <div class="reading-stat">
            <label>Average Word Length:</label>
            <span id="statAvgWordLen">0 chars</span>
          </div>
          <div class="reading-stat">
            <label>Average Sentence Length:</label>
            <span id="statAvgSentLen">0 words</span>
          </div>
          <div class="reading-stat">
            <label>Unique Words:</label>
            <span id="statUniqueWords">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDocumentStatistics()">Close</button>
        <button class="btn btn-primary" onclick="copyStatistics()">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- Focus Mode Bar -->
  <div class="focus-mode-bar" id="focusModeBar">
    <span>Focus Mode</span>
    <button onclick="adjustFocusWidth(-50)">Narrower</button>
    <button onclick="adjustFocusWidth(50)">Wider</button>
    <button onclick="toggleFocusDarkMode()">üåì Toggle Theme</button>
    <button onclick="toggleReadAloud()">üîä Read Aloud</button>
    <button onclick="toggleFocusMode()">‚úï Exit</button>
  </div>

  <!-- Reading Mode Overlay -->
  <div class="reading-mode-overlay sepia" id="readingModeOverlay">
    <div class="reading-mode-progress" id="readingProgress"></div>
    <div class="reading-mode-header">
      <div class="reading-mode-controls">
        <button onclick="changeReadingTheme('sepia')">üìú Sepia</button>
        <button onclick="changeReadingTheme('light')">‚òÄÔ∏è Light</button>
        <button onclick="changeReadingTheme('dark')">üåô Dark</button>
      </div>
      <div style="font-weight: 500;" id="readingTitle">Document</div>
      <div class="reading-mode-controls">
        <button onclick="adjustReadingFontSize(-2)">A-</button>
        <button onclick="adjustReadingFontSize(2)">A+</button>
        <button onclick="toggleReadAloud()">üîä Read</button>
        <button onclick="toggleReadingMode()">‚úï Close</button>
      </div>
    </div>
    <div class="reading-mode-content" id="readingContent" onscroll="updateReadingProgress()">
      <div class="reading-mode-text" id="readingText"></div>
    </div>
  </div>

  <script>
    // State
    let trackChangesEnabled = false;
    let changes = [];
    let originalContent = '';
    let currentDocId = null;
    const STORAGE_KEY = 'ninjaword_documents';
    let zoomLevel = 100;
    let undoStack = [];
    let redoStack = [];
    let findMatches = [];
    let currentFindIndex = -1;

    // Auto-correct dictionary
    const autoCorrectRules = {
      'teh': 'the', 'adn': 'and', 'dont': "don't", 'didnt': "didn't", 'wont': "won't",
      'cant': "can't", 'im': "I'm", 'youre': "you're", 'theyre': "they're", 'its': "it's",
      'thier': 'their', 'recieve': 'receive', 'beleive': 'believe', 'occured': 'occurred',
      'seperate': 'separate', 'definately': 'definitely', 'accomodate': 'accommodate',
      'occurence': 'occurrence', 'untill': 'until', 'wierd': 'weird', 'acheive': 'achieve',
      '(c)': '¬©', '(r)': '¬Æ', '(tm)': '‚Ñ¢', '->': '‚Üí', '<-': '‚Üê', '<->': '‚Üî',
      '...': '‚Ä¶', '--': '‚Äî', '1/2': '¬Ω', '1/4': '¬º', '3/4': '¬æ',
      ':)': 'üòä', ':(': 'üòû', ':D': 'üòÉ', ';)': 'üòâ', '<3': '‚ù§Ô∏è'
    };
    let autoCorrectEnabled = true;

    // File Menu
    function toggleFileMenu() {
      const menu = document.getElementById('fileMenu');
      menu.classList.toggle('show');
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.getElementById('fileMenu')?.classList.remove('show');
      }
    });

    // Get all saved documents
    function getSavedDocuments() {
      const docs = localStorage.getItem(STORAGE_KEY);
      return docs ? JSON.parse(docs) : {};
    }

    // Save documents to storage
    function saveDocs(docs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
    }

    // New Document
    function newDocument() {
      if (editor.innerHTML && !confirm('Create new document? Unsaved changes will be lost.')) return;
      editor.innerHTML = '<p>Start typing your document here...</p>';
      document.getElementById('fileName').value = 'Untitled Document';
      currentDocId = null;
      updateStats();
      showToast('New document created', 'success');
      toggleFileMenu();
    }

    // Open Dialog
    function showOpenDialog() {
      toggleFileMenu();
      const docs = getSavedDocuments();
      const list = document.getElementById('savedDocsList');

      if (Object.keys(docs).length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 2rem;">No saved documents yet.<br>Save a document first!</p>';
      } else {
        list.innerHTML = Object.entries(docs).map(([id, doc]) => `
          <div style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;"
               onmouseover="this.style.background='var(--light)'"
               onmouseout="this.style.background='white'"
               onclick="loadDocument('${id}')">
            <div style="flex: 1;">
              <div style="font-weight: 500;">${doc.name}</div>
              <div style="font-size: 0.8rem; color: var(--secondary);">
                Last modified: ${new Date(doc.modified).toLocaleString()}
              </div>
            </div>
            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                    onclick="event.stopPropagation(); deleteDocument('${id}')">üóë</button>
          </div>
        `).join('');
      }

      document.getElementById('openModal').classList.add('active');
    }

    function hideOpenDialog() {
      document.getElementById('openModal').classList.remove('active');
    }

    // Load Document
    function loadDocument(id) {
      const docs = getSavedDocuments();
      const doc = docs[id];
      if (doc) {
        editor.innerHTML = doc.content;
        document.getElementById('fileName').value = doc.name;
        currentDocId = id;
        updateStats();
        hideOpenDialog();
        showToast('Document loaded', 'success');
      }
    }

    // Delete Document
    function deleteDocument(id) {
      if (!confirm('Delete this document permanently?')) return;
      const docs = getSavedDocuments();
      delete docs[id];
      saveDocs(docs);
      showOpenDialog(); // Refresh list
      showToast('Document deleted', 'success');
    }

    // Save Document
    function saveDocument() {
      toggleFileMenu();
      const name = document.getElementById('fileName').value.trim() || 'Untitled Document';

      if (!currentDocId) {
        // First time save - show Save As dialog
        saveDocumentAs();
        return;
      }

      const docs = getSavedDocuments();
      docs[currentDocId] = {
        name: name,
        content: editor.innerHTML,
        modified: Date.now()
      };
      saveDocs(docs);
      addToRecentFiles(currentDocId, name);
      showToast('Document saved', 'success');
    }

    // Save As Dialog
    function saveDocumentAs() {
      const menu = document.getElementById('fileMenu');
      if (menu.classList.contains('show')) toggleFileMenu();

      document.getElementById('saveAsName').value = document.getElementById('fileName').value;
      document.getElementById('saveAsModal').classList.add('active');
    }

    function hideSaveAs() {
      document.getElementById('saveAsModal').classList.remove('active');
    }

    function confirmSaveAs() {
      const name = document.getElementById('saveAsName').value.trim() || 'Untitled Document';
      const docs = getSavedDocuments();
      const id = 'doc_' + Date.now();

      docs[id] = {
        name: name,
        content: editor.innerHTML,
        modified: Date.now()
      };

      saveDocs(docs);
      currentDocId = id;
      document.getElementById('fileName').value = name;
      addToRecentFiles(id, name);
      hideSaveAs();
      showToast('Document saved as "' + name + '"', 'success');
    }

    // Export to file
    function exportToFile() {
      toggleFileMenu();
      const name = document.getElementById('fileName').value.trim() || 'document';
      const data = {
        name: name,
        content: editor.innerHTML,
        created: Date.now(),
        app: 'NinjaWord'
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name + '.njword';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Document exported', 'success');
    }

    // Import from file
    function importFromFile() {
      toggleFileMenu();
      document.getElementById('fileImport').click();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.content) {
            editor.innerHTML = data.content;
            document.getElementById('fileName').value = data.name || 'Imported Document';
            currentDocId = null;
            updateStats();
            showToast('Document imported successfully', 'success');
          } else {
            throw new Error('Invalid format');
          }
        } catch (err) {
          showToast('Error importing file: Invalid format', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // Reset for future imports
    }

    // Format document
    function formatDoc(cmd, value = null) {
      document.execCommand(cmd, false, value);
      editor.focus();
      updateStats();
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Hide all toolbars
        document.getElementById('homeToolbar').style.display = 'none';
        document.getElementById('insertToolbar').style.display = 'none';
        document.getElementById('reviewToolbar').style.display = 'none';

        // Show selected toolbar
        const tabName = tab.dataset.tab;
        if (tabName === 'home') {
          document.getElementById('homeToolbar').style.display = 'flex';
        } else if (tabName === 'insert') {
          document.getElementById('insertToolbar').style.display = 'flex';
        } else if (tabName === 'review') {
          document.getElementById('reviewToolbar').style.display = 'flex';
        }
      });
    });

    // Editor reference
    const editor = document.getElementById('editor');

    // Update document stats
    function updateStats() {
      const text = editor.innerText;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const chars = text.length;
      const paras = editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li').length || 1;

      document.getElementById('wordCount').textContent = words;
      document.getElementById('charCount').textContent = chars;
      document.getElementById('paraCount').textContent = paras;
    }

    editor.addEventListener('input', updateStats);
    updateStats();

    // Auto-correct on space or punctuation
    editor.addEventListener('keydown', (e) => {
      if (!autoCorrectEnabled) return;
      if (e.key === ' ' || e.key === 'Enter' || /^[.,;:!?)]$/.test(e.key)) {
        setTimeout(() => applyAutoCorrect(), 0);
      }
    });

    function applyAutoCorrect() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      const node = range.startContainer;
      if (node.nodeType !== Node.TEXT_NODE) return;

      const text = node.textContent;
      const cursorPos = range.startOffset;

      // Find the word before cursor
      let wordStart = cursorPos - 1;
      while (wordStart > 0 && !/\s/.test(text[wordStart - 1])) {
        wordStart--;
      }

      // Extract word (excluding trailing space/punctuation)
      let wordEnd = cursorPos;
      if (/[\s.,;:!?)]/.test(text[cursorPos - 1])) {
        wordEnd = cursorPos - 1;
      }

      const word = text.substring(wordStart, wordEnd).toLowerCase();
      const replacement = autoCorrectRules[word];

      if (replacement) {
        // Preserve original case for first letter
        let finalReplacement = replacement;
        if (text[wordStart] === text[wordStart].toUpperCase() && /[a-z]/i.test(text[wordStart])) {
          finalReplacement = replacement.charAt(0).toUpperCase() + replacement.slice(1);
        }

        const before = text.substring(0, wordStart);
        const after = text.substring(wordEnd);
        node.textContent = before + finalReplacement + after;

        // Restore cursor position
        const newPos = wordStart + finalReplacement.length + (cursorPos - wordEnd);
        range.setStart(node, Math.min(newPos, node.textContent.length));
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
      }
    }

    function toggleAutoCorrect() {
      autoCorrectEnabled = !autoCorrectEnabled;
      const btn = document.getElementById('autoCorrectBtn');
      if (btn) btn.classList.toggle('active', autoCorrectEnabled);
      showToast(autoCorrectEnabled ? 'Auto-correct enabled' : 'Auto-correct disabled', 'info');
    }

    // Track Changes
    function toggleTrackChanges() {
      trackChangesEnabled = !trackChangesEnabled;
      const btn = document.getElementById('trackChangesBtn');
      const btn2 = document.getElementById('trackChangesBtn2');
      const panel = document.getElementById('trackChangesPanel');

      if (trackChangesEnabled) {
        btn.classList.add('active');
        if (btn2) btn2.classList.add('active');
        panel.style.display = 'block';
        originalContent = editor.innerHTML;
        showToast('Track Changes enabled', 'success');
      } else {
        btn.classList.remove('active');
        if (btn2) btn2.classList.remove('active');
        panel.style.display = 'none';
        showToast('Track Changes disabled');
      }
    }

    // Spell Check - see enhanced implementation below

    function replaceWord(wrong, right) {
      const html = editor.innerHTML;
      const regex = new RegExp('\\b' + wrong + '\\b', 'gi');
      editor.innerHTML = html.replace(regex, right);
      runSpellCheck();
    }

    function runGrammarCheck() {
      showToast('Grammar check complete', 'success');
    }

    // Insert Table Modal
    let tableGridRows = 0;
    let tableGridCols = 0;

    function insertTable() {
      showInsertTableModal();
    }

    function showInsertTableModal() {
      document.getElementById('insertTableModal').classList.add('visible');
      initTableGrid();
    }

    function hideInsertTableModal() {
      document.getElementById('insertTableModal').classList.remove('visible');
      tableGridRows = 0;
      tableGridCols = 0;
    }

    function initTableGrid() {
      const grid = document.getElementById('tableGrid');
      grid.innerHTML = '';
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 10; c++) {
          const cell = document.createElement('div');
          cell.className = 'table-grid-cell';
          cell.dataset.row = r + 1;
          cell.dataset.col = c + 1;
          cell.addEventListener('mouseenter', () => highlightGridCells(r + 1, c + 1));
          cell.addEventListener('click', () => selectGridSize(r + 1, c + 1));
          grid.appendChild(cell);
        }
      }
    }

    function highlightGridCells(rows, cols) {
      const cells = document.querySelectorAll('.table-grid-cell');
      cells.forEach(cell => {
        const r = parseInt(cell.dataset.row);
        const c = parseInt(cell.dataset.col);
        if (r <= rows && c <= cols) {
          cell.classList.add('highlighted');
        } else {
          cell.classList.remove('highlighted');
        }
      });
      document.getElementById('tableSizeDisplay').textContent = `${rows} x ${cols} Table`;
      tableGridRows = rows;
      tableGridCols = cols;
    }

    function selectGridSize(rows, cols) {
      document.getElementById('tableRows').value = rows;
      document.getElementById('tableCols').value = cols;
      insertTableFromModal();
    }

    function insertTableFromModal() {
      const rows = parseInt(document.getElementById('tableRows').value) || 3;
      const cols = parseInt(document.getElementById('tableCols').value) || 3;
      const style = document.getElementById('tableStyle').value;
      const hasHeader = document.getElementById('tableHeader').checked;

      const styles = {
        basic: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0;',
          th: 'border: 1px solid #ccc; padding: 10px; background: #f5f5f5; font-weight: bold; text-align: left;',
          td: 'border: 1px solid #ccc; padding: 10px;'
        },
        bordered: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0; border: 2px solid #333;',
          th: 'border: 2px solid #333; padding: 10px; background: #333; color: white; font-weight: bold;',
          td: 'border: 1px solid #333; padding: 10px;'
        },
        striped: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0;',
          th: 'border-bottom: 2px solid #1a73e8; padding: 12px; background: #e8f0fe; font-weight: bold; text-align: left;',
          td: 'border-bottom: 1px solid #eee; padding: 10px;',
          altRow: 'background: #f9f9f9;'
        },
        modern: {
          table: 'border-collapse: collapse; width: 100%; margin: 1rem 0; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);',
          th: 'padding: 14px; background: linear-gradient(135deg, #1a73e8, #4285f4); color: white; font-weight: 600; text-align: left;',
          td: 'padding: 12px; border-bottom: 1px solid #eee;'
        }
      };

      const s = styles[style];
      let table = `<table style="${s.table}">`;

      for (let i = 0; i < rows; i++) {
        const isHeader = hasHeader && i === 0;
        const isAltRow = s.altRow && !isHeader && i % 2 === 1;
        table += `<tr${isAltRow ? ` style="${s.altRow}"` : ''}>`;
        for (let j = 0; j < cols; j++) {
          const tag = isHeader ? 'th' : 'td';
          const cellStyle = isHeader ? s.th : s.td;
          table += `<${tag} style="${cellStyle}" contenteditable="true">${isHeader ? `Header ${j + 1}` : '&nbsp;'}</${tag}>`;
        }
        table += '</tr>';
      }
      table += '</table><p></p>';

      document.execCommand('insertHTML', false, table);
      hideInsertTableModal();
      showToast(`Inserted ${rows}x${cols} table`, 'success');
    }

    // ========== Symbol Picker ==========
    const symbolCategories = {
      'Common': '¬©¬Æ‚Ñ¢¬∞¬ß¬∂‚Ä†‚Ä°‚Ä¢‚Ä¶‚Äî‚Äì\u2018\u2019\u201C\u201D¬´¬ª‚Äπ‚Ä∫¬°¬ø√ó√∑¬±‚â†‚âà‚â§‚â•‚àû‚àë‚àè‚àö‚à´‚àÇ‚àÜ‚àá',
      'Currency': '$‚Ç¨¬£¬•¬¢‚Çπ‚ÇΩ‚Çø‡∏ø‚Ç©‚Ç™‚Ç´‚Ç≠‚ÇÆ‚ÇØ‚Ç±‚Ç≤‚Ç≥‚Ç¥‚Çµ‚Ç∏‚Ç∫‚Çº‚Çæ',
      'Greek': 'ŒëŒíŒìŒîŒïŒñŒóŒòŒôŒöŒõŒúŒùŒûŒüŒ†Œ°Œ£Œ§Œ•Œ¶ŒßŒ®Œ©Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ',
      'Math': '‚àÄ‚àÅ‚àÇ‚àÉ‚àÑ‚àÖ‚àÜ‚àá‚àà‚àâ‚àä‚àã‚àå‚àç‚àé‚àè‚àê‚àë‚àí‚àì‚àî‚àï‚àñ‚àó‚àò‚àô‚àö‚àõ‚àú‚àù‚àû‚àü‚à†‚à°‚à¢‚à£‚à§‚à•‚à¶‚àß‚à®‚à©‚à™‚à´‚à¨‚à≠‚àÆ‚àØ‚à∞',
      'Arrows': '‚Üê‚Üë‚Üí‚Üì‚Üî‚Üï‚Üñ‚Üó‚Üò‚Üô‚Üö‚Üõ‚Üú‚Üù‚Üû‚Üü‚Ü†‚Ü°‚Ü¢‚Ü£‚Ü§‚Ü•‚Ü¶‚Üß‚Ü®‚Ü©‚Ü™‚Ü´‚Ü¨‚Ü≠‚ÜÆ‚ÜØ‚Ü∞‚Ü±‚Ü≤‚Ü≥‚Ü¥‚Üµ‚Ü∂‚Ü∑‚Ü∏‚Üπ‚Ü∫‚Üª',
      'Shapes': '‚ñ†‚ñ°‚ñ¢‚ñ£‚ñ§‚ñ•‚ñ¶‚ñß‚ñ®‚ñ©‚ñ™‚ñ´‚ñ¨‚ñ≠‚ñÆ‚ñØ‚ñ∞‚ñ±‚ñ≤‚ñ≥‚ñ¥‚ñµ‚ñ∂‚ñ∑‚ñ∏‚ñπ‚ñ∫‚ñª‚ñº‚ñΩ‚ñæ‚ñø‚óÄ‚óÅ‚óÇ‚óÉ‚óÑ‚óÖ‚óÜ‚óá‚óà‚óâ‚óä‚óã‚óå‚óç‚óé‚óè',
      'Stars': '‚òÖ‚òÜ‚ú°‚ú¢‚ú£‚ú§‚ú•‚ú¶‚úß‚ú©‚ú™‚ú´‚ú¨‚ú≠‚úÆ‚úØ‚ú∞‚ú±‚ú≤‚ú≥‚ú¥‚úµ‚ú∂‚ú∑‚ú∏‚úπ‚ú∫‚úª‚úº‚úΩ‚úæ‚úø‚ùÄ‚ùÅ‚ùÇ‚ùÉ‚ùÑ‚ùÖ‚ùÜ‚ùá‚ùà‚ùâ‚ùä‚ùã',
      'Emoji': '‚òÄ‚òÅ‚òÇ‚òÉ‚òÑ‚òÖ‚òÜ‚òá‚òà‚òâ‚òä‚òã‚òå‚òç‚òé‚òè‚òê‚òë‚òí‚òì‚òî‚òï‚òñ‚òó‚òò‚òô‚òö‚òõ‚òú‚òù‚òû‚òü‚ò†‚ò°‚ò¢‚ò£‚ò§‚ò•‚ò¶‚òß‚ò®‚ò©‚ò™‚ò´‚ò¨‚ò≠‚òÆ‚òØ'
    };

    let selectedSymbol = null;
    let currentSymbolCategory = 'Common';

    function showSymbolPicker() {
      document.getElementById('symbolModal').classList.add('visible');
      renderSymbolCategories();
      renderSymbolGrid('Common');
    }

    function hideSymbolPicker() {
      document.getElementById('symbolModal').classList.remove('visible');
    }

    function renderSymbolCategories() {
      const container = document.getElementById('symbolCategoryTabs');
      container.innerHTML = Object.keys(symbolCategories).map(cat =>
        `<button class="symbol-category-tab${cat === currentSymbolCategory ? ' active' : ''}"
                onclick="switchSymbolCategory('${cat}')">${cat}</button>`
      ).join('');
    }

    function switchSymbolCategory(category) {
      currentSymbolCategory = category;
      renderSymbolCategories();
      renderSymbolGrid(category);
    }

    function renderSymbolGrid(category) {
      const grid = document.getElementById('symbolGrid');
      const symbols = symbolCategories[category];
      grid.innerHTML = [...symbols].map(sym =>
        `<button class="symbol-btn" onclick="selectSymbol('${sym}')"
                onmouseenter="previewSymbol('${sym}')">${sym}</button>`
      ).join('');
    }

    function previewSymbol(sym) {
      document.getElementById('symbolPreviewChar').textContent = sym;
      document.getElementById('symbolPreviewInfo').textContent =
        `Unicode: U+${sym.charCodeAt(0).toString(16).toUpperCase().padStart(4, '0')}`;
    }

    function selectSymbol(sym) {
      selectedSymbol = sym;
      previewSymbol(sym);
      // Highlight selected
      document.querySelectorAll('.symbol-btn').forEach(btn => {
        btn.style.background = btn.textContent === sym ? '#cce5ff' : '';
      });
    }

    function insertSelectedSymbol() {
      if (selectedSymbol) {
        document.execCommand('insertText', false, selectedSymbol);
        showToast(`Inserted symbol: ${selectedSymbol}`, 'success');
      }
    }

    function insertImage() {
      const url = prompt('Enter image URL:');
      if (url) {
        document.execCommand('insertHTML', false, `<img src="${url}" style="max-width: 100%; height: auto; margin: 1rem 0;">`);
      }
    }

    function insertLink() {
      const url = prompt('Enter URL:');
      if (url) {
        document.execCommand('createLink', false, url);
      }
    }

    function insertHorizontalRule() {
      document.execCommand('insertHorizontalRule');
    }

    function insertPageBreak() {
      document.execCommand('insertHTML', false, '<div style="page-break-after: always; border-bottom: 2px dashed #ccc; margin: 2rem 0; text-align: center; color: #999; font-size: 0.8rem;">--- Page Break ---</div>');
    }

    function insertDateTime() {
      const now = new Date();
      document.execCommand('insertText', false, now.toLocaleString());
    }

    function insertMergeField(field) {
      document.execCommand('insertHTML', false, `<span class="merge-field">{{${field}}}</span>`);
      editor.focus();
    }

    // Templates
    const templates = {
      blank: '',
      letter: `<p style="text-align: right;">[Your Name]<br>[Your Address]<br>[City, State ZIP]<br>[Date]</p>
        <p><br></p>
        <p>[Recipient Name]<br>[Company Name]<br>[Address]<br>[City, State ZIP]</p>
        <p><br></p>
        <p>Dear [Recipient Name],</p>
        <p><br></p>
        <p>[Body of the letter goes here. Start with the purpose of your letter, provide necessary details in the middle paragraphs, and conclude with a call to action or summary.]</p>
        <p><br></p>
        <p>Sincerely,</p>
        <p><br></p>
        <p>[Your Name]</p>`,
      resume: `<h1 style="text-align: center; margin-bottom: 0;">[Your Name]</h1>
        <p style="text-align: center; color: #666; margin-top: 0.5rem;">[Email] | [Phone] | [Location] | [LinkedIn]</p>
        <hr style="margin: 1rem 0;">
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Professional Summary</h2>
        <p>[Brief professional summary highlighting key skills and experience]</p>
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Experience</h2>
        <p><strong>[Job Title]</strong> | [Company] | [Date Range]</p>
        <ul><li>[Achievement/responsibility]</li><li>[Achievement/responsibility]</li></ul>
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Education</h2>
        <p><strong>[Degree]</strong> | [University] | [Year]</p>
        <h2 style="color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 0.25rem;">Skills</h2>
        <p>[Skill 1] ‚Ä¢ [Skill 2] ‚Ä¢ [Skill 3] ‚Ä¢ [Skill 4]</p>`,
      report: `<h1 style="text-align: center;">[Report Title]</h1>
        <p style="text-align: center; color: #666;">[Author] | [Date]</p>
        <hr>
        <h2>Executive Summary</h2>
        <p>[Brief overview of the report's key findings and recommendations]</p>
        <h2>Introduction</h2>
        <p>[Background information and purpose of the report]</p>
        <h2>Methodology</h2>
        <p>[How the research or analysis was conducted]</p>
        <h2>Findings</h2>
        <p>[Detailed findings with supporting data]</p>
        <h2>Recommendations</h2>
        <ul><li>[Recommendation 1]</li><li>[Recommendation 2]</li></ul>
        <h2>Conclusion</h2>
        <p>[Summary and next steps]</p>`,
      invoice: `<div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
        <div><h1 style="color: #2b579a; margin: 0;">INVOICE</h1><p style="color: #666;">Invoice #: [Number]<br>Date: [Date]</p></div>
        <div style="text-align: right;"><strong>[Your Company]</strong><br>[Address]<br>[City, State ZIP]<br>[Email]</div>
        </div>
        <div style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem;"><strong>Bill To:</strong><br>[Client Name]<br>[Client Address]</div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
        <tr style="background: #2b579a; color: white;"><th style="padding: 0.75rem; text-align: left;">Description</th><th style="padding: 0.75rem; text-align: right;">Qty</th><th style="padding: 0.75rem; text-align: right;">Rate</th><th style="padding: 0.75rem; text-align: right;">Amount</th></tr>
        <tr><td style="padding: 0.75rem; border-bottom: 1px solid #ddd;">[Item 1]</td><td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #ddd;">1</td><td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #ddd;">$0.00</td><td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #ddd;">$0.00</td></tr>
        </table>
        <div style="text-align: right;"><p><strong>Subtotal:</strong> $0.00</p><p><strong>Tax:</strong> $0.00</p><p style="font-size: 1.25rem;"><strong>Total:</strong> $0.00</p></div>`,
      meeting: `<h1>[Meeting Title]</h1>
        <p><strong>Date:</strong> [Date] | <strong>Time:</strong> [Time] | <strong>Location:</strong> [Location]</p>
        <p><strong>Attendees:</strong> [Names]</p>
        <hr>
        <h2>Agenda</h2>
        <ol><li>[Agenda item 1]</li><li>[Agenda item 2]</li><li>[Agenda item 3]</li></ol>
        <h2>Discussion Notes</h2>
        <p>[Notes from the meeting]</p>
        <h2>Action Items</h2>
        <ul><li>‚òê [Task 1] - [Assigned to] - [Due date]</li><li>‚òê [Task 2] - [Assigned to] - [Due date]</li></ul>
        <h2>Next Meeting</h2>
        <p>[Date and time of next meeting]</p>`
    };

    function loadTemplate(name) {
      editor.innerHTML = templates[name];
      updateStats();
      showToast(`Loaded ${name} template`, 'success');
    }

    function showTemplates() {
      document.getElementById('templatesModal').classList.add('active');
    }

    function hideTemplates() {
      document.getElementById('templatesModal').classList.remove('active');
    }

    // Mail Merge
    function showMailMerge() {
      document.getElementById('mailMergeModal').classList.add('active');
    }

    function hideMailMerge() {
      document.getElementById('mailMergeModal').classList.remove('active');
    }

    function previewMerge() {
      const data = document.getElementById('mergeData').value;
      if (!data.trim()) {
        showToast('Please enter recipient data', 'warning');
        return;
      }

      const lines = data.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());

      if (lines.length < 2) {
        showToast('Please add at least one recipient', 'warning');
        return;
      }

      const values = lines[1].split(',').map(v => v.trim());
      let preview = editor.innerHTML;

      headers.forEach((header, i) => {
        const regex = new RegExp(`{{${header}}}`, 'g');
        preview = preview.replace(regex, `<mark>${values[i] || ''}</mark>`);
      });

      // Show preview in a new window
      const previewWindow = window.open('', '_blank', 'width=800,height=600');
      previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Mail Merge Preview</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 2rem; }
            mark { background: #fef08a; padding: 2px 4px; }
          </style>
        </head>
        <body>
          <h2>Mail Merge Preview (First Record)</h2>
          <hr>
          ${preview}
        </body>
        </html>
      `);

      showToast('Preview opened in new window', 'success');
    }

    function executeMerge() {
      const data = document.getElementById('mergeData').value;
      if (!data.trim()) {
        showToast('Please enter recipient data', 'warning');
        return;
      }

      const lines = data.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const template = editor.innerHTML;
      const documents = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        let doc = template;

        headers.forEach((header, j) => {
          const regex = new RegExp(`{{${header}}}`, 'g');
          doc = doc.replace(regex, values[j] || '');
        });

        documents.push(doc);
      }

      // Generate merged document
      editor.innerHTML = documents.join('<div style="page-break-after: always; border: 2px dashed #ccc; margin: 2rem 0; padding: 1rem; text-align: center; color: #666;">--- Document Separator ---</div>');
      hideMailMerge();
      showToast(`Generated ${documents.length} merged documents`, 'success');
      updateStats();
    }

    // PDF Export
    async function exportPDF() {
      showToast('Generating PDF...', 'info');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      const canvas = await html2canvas(editor, {
        scale: 2,
        useCORS: true,
        logging: false
      });

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;

      doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        doc.addPage();
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const fileName = document.getElementById('fileName').value || 'document';
      doc.save(`${fileName}.pdf`);
      showToast('PDF exported successfully!', 'success');
    }

    // Track changes functions
    function acceptAllChanges() {
      if (trackChangesEnabled) {
        originalContent = editor.innerHTML;
        changes = [];
        document.getElementById('changesList').innerHTML = '';
        showToast('All changes accepted', 'success');
      }
    }

    function rejectAllChanges() {
      if (trackChangesEnabled && originalContent) {
        editor.innerHTML = originalContent;
        changes = [];
        document.getElementById('changesList').innerHTML = '';
        showToast('All changes rejected', 'warning');
      }
    }

    function addComment() {
      const selection = window.getSelection();
      if (selection.toString()) {
        const comment = prompt('Enter your comment:');
        if (comment) {
          const span = document.createElement('span');
          span.style.background = '#fef08a';
          span.style.borderBottom = '2px solid #f59e0b';
          span.title = `Comment: ${comment}`;
          span.innerHTML = selection.toString();

          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(span);

          showToast('Comment added', 'success');
        }
      } else {
        showToast('Please select text to comment on', 'warning');
      }
    }

    // ==================== STICKY NOTES ====================
    let stickyNotes = JSON.parse(localStorage.getItem('ninjaword_stickynotes') || '[]');
    let stickyNoteCounter = stickyNotes.length;
    const noteColors = ['yellow', 'pink', 'blue', 'green', 'orange'];

    function addStickyNote() {
      const docArea = document.getElementById('documentArea');
      const noteId = 'note-' + Date.now();
      const colorIndex = stickyNoteCounter % noteColors.length;
      const color = noteColors[colorIndex];

      const note = {
        id: noteId,
        content: '',
        color: color,
        x: 50 + (stickyNoteCounter * 20) % 200,
        y: 100 + (stickyNoteCounter * 20) % 300,
        createdAt: new Date().toISOString()
      };

      stickyNotes.push(note);
      stickyNoteCounter++;
      saveStickyNotes();
      renderStickyNote(note);
      updateStickyNotesPanel();
      showToast('Sticky note added', 'success');
    }

    function renderStickyNote(note) {
      const docArea = document.getElementById('documentArea');

      const noteEl = document.createElement('div');
      noteEl.className = `sticky-note ${note.color === 'yellow' ? '' : note.color}`;
      noteEl.id = note.id;
      noteEl.style.left = note.x + 'px';
      noteEl.style.top = note.y + 'px';

      noteEl.innerHTML = `
        <div class="sticky-note-header">
          <span>${new Date(note.createdAt).toLocaleDateString()}</span>
          <div class="note-actions">
            <button onclick="cycleNoteColor('${note.id}')" title="Change Color">üé®</button>
            <button onclick="deleteStickyNote('${note.id}')" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
        <div class="sticky-note-content" contenteditable="true"
             oninput="updateNoteContent('${note.id}', this.innerHTML)"
             placeholder="Type your note...">${note.content}</div>
      `;

      // Make note draggable
      makeDraggable(noteEl);

      docArea.appendChild(noteEl);
    }

    function makeDraggable(element) {
      const header = element.querySelector('.sticky-note-header');
      let isDragging = false;
      let startX, startY, initialX, initialY;

      header.addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'BUTTON') return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialX = element.offsetLeft;
        initialY = element.offsetTop;
        element.style.zIndex = 1001;
      });

      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        element.style.left = (initialX + dx) + 'px';
        element.style.top = (initialY + dy) + 'px';
      });

      document.addEventListener('mouseup', function() {
        if (isDragging) {
          isDragging = false;
          element.style.zIndex = 1000;
          // Save new position
          const noteId = element.id;
          const note = stickyNotes.find(n => n.id === noteId);
          if (note) {
            note.x = element.offsetLeft;
            note.y = element.offsetTop;
            saveStickyNotes();
          }
        }
      });
    }

    function updateNoteContent(noteId, content) {
      const note = stickyNotes.find(n => n.id === noteId);
      if (note) {
        note.content = content;
        saveStickyNotes();
        updateStickyNotesPanel();
      }
    }

    function cycleNoteColor(noteId) {
      const note = stickyNotes.find(n => n.id === noteId);
      if (!note) return;

      const currentIndex = noteColors.indexOf(note.color);
      const nextIndex = (currentIndex + 1) % noteColors.length;
      note.color = noteColors[nextIndex];

      const noteEl = document.getElementById(noteId);
      noteEl.className = `sticky-note ${note.color === 'yellow' ? '' : note.color}`;

      saveStickyNotes();
    }

    function deleteStickyNote(noteId) {
      if (!confirm('Delete this sticky note?')) return;

      stickyNotes = stickyNotes.filter(n => n.id !== noteId);
      saveStickyNotes();

      const noteEl = document.getElementById(noteId);
      if (noteEl) noteEl.remove();

      updateStickyNotesPanel();
      showToast('Sticky note deleted', 'info');
    }

    function saveStickyNotes() {
      localStorage.setItem('ninjaword_stickynotes', JSON.stringify(stickyNotes));
    }

    function toggleStickyNotesPanel() {
      const panel = document.getElementById('stickyNotesPanel');
      panel.classList.toggle('visible');
      updateStickyNotesPanel();
    }

    function updateStickyNotesPanel() {
      const list = document.getElementById('stickyNotesList');

      if (stickyNotes.length === 0) {
        list.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No sticky notes yet.<br>Click + to add one.</p>';
        return;
      }

      list.innerHTML = stickyNotes.map(note => {
        const preview = note.content.replace(/<[^>]*>/g, '').substring(0, 50) || '(empty note)';
        const colorBorder = {
          yellow: '#fbc02d',
          pink: '#ec407a',
          blue: '#1e88e5',
          green: '#43a047',
          orange: '#fb8c00'
        }[note.color] || '#fbc02d';

        return `
          <div class="sticky-note-item" style="border-left-color: ${colorBorder};"
               onclick="focusStickyNote('${note.id}')">
            <strong>${new Date(note.createdAt).toLocaleDateString()}</strong><br>
            ${preview}${note.content.length > 50 ? '...' : ''}
          </div>
        `;
      }).join('');
    }

    function focusStickyNote(noteId) {
      const noteEl = document.getElementById(noteId);
      if (noteEl) {
        noteEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        noteEl.style.boxShadow = '0 0 20px rgba(26, 115, 232, 0.5)';
        setTimeout(() => {
          noteEl.style.boxShadow = '2px 2px 8px rgba(0,0,0,0.2)';
        }, 2000);
      }
    }

    // Load sticky notes on page load
    function loadStickyNotes() {
      stickyNotes.forEach(note => renderStickyNote(note));
    }

    // Initialize sticky notes after DOM ready
    document.addEventListener('DOMContentLoaded', loadStickyNotes);

    // Toast notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key.toLowerCase()) {
          case 'b':
            e.preventDefault();
            formatDoc('bold');
            break;
          case 'i':
            e.preventDefault();
            formatDoc('italic');
            break;
          case 'u':
            e.preventDefault();
            formatDoc('underline');
            break;
          case 's':
            e.preventDefault();
            saveDocument();
            break;
          case 'p':
            e.preventDefault();
            exportPDF();
            break;
        }
      }
    });

    // Auto-save current document (if saved before)
    setInterval(() => {
      if (currentDocId) {
        const docs = getSavedDocuments();
        docs[currentDocId] = {
          name: document.getElementById('fileName').value,
          content: editor.innerHTML,
          modified: Date.now()
        };
        saveDocs(docs);
      }
    }, 60000); // Auto-save every minute if document was previously saved

    // ==================== SCREENSHOT ====================
    async function insertScreenshot() {
      try {
        // Check if Screen Capture API is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
          showToast('Screen capture not supported in this browser', 'error');
          return;
        }

        showToast('Select a window or screen to capture...', 'info');

        // Request screen capture
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: { mediaSource: 'screen' }
        });

        // Create video element to capture frame
        const video = document.createElement('video');
        video.srcObject = stream;
        video.play();

        // Wait for video to load
        await new Promise(resolve => {
          video.onloadedmetadata = resolve;
        });

        // Small delay to ensure frame is ready
        await new Promise(resolve => setTimeout(resolve, 100));

        // Create canvas and capture frame
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Stop the stream
        stream.getTracks().forEach(track => track.stop());

        // Convert to data URL
        const dataUrl = canvas.toDataURL('image/png');

        // Insert image into editor
        const img = document.createElement('img');
        img.src = dataUrl;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.margin = '1rem 0';
        img.style.borderRadius = '4px';
        img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';

        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);
          range.collapse(false);
        } else {
          editor.appendChild(img);
        }

        showToast('Screenshot inserted', 'success');
        updateStatusBarWordCount();

      } catch (err) {
        if (err.name === 'NotAllowedError') {
          showToast('Screenshot cancelled', 'info');
        } else {
          console.error('Screenshot error:', err);
          showToast('Failed to capture screenshot', 'error');
        }
      }
    }

    // ==================== ZOOM CONTROLS ====================
    function zoomIn() {
      if (zoomLevel < 200) {
        zoomLevel += 10;
        applyZoom();
      }
    }

    function zoomOut() {
      if (zoomLevel > 50) {
        zoomLevel -= 10;
        applyZoom();
      }
    }

    function applyZoom() {
      const doc = document.getElementById('editor');
      doc.style.transform = `scale(${zoomLevel / 100})`;
      doc.style.transformOrigin = 'top center';
      document.getElementById('zoomLevel').textContent = zoomLevel + '%';
      document.getElementById('statusZoom').textContent = zoomLevel + '%';
    }

    // ==================== FIND & REPLACE ====================
    function showFindReplace() {
      document.getElementById('findReplaceBar').style.display = 'flex';
      document.getElementById('findInput').focus();
    }

    function hideFindReplace() {
      document.getElementById('findReplaceBar').style.display = 'none';
      clearHighlights();
    }

    function clearHighlights() {
      const editor = document.getElementById('editor');
      editor.innerHTML = editor.innerHTML.replace(/<mark class="highlight-find">|<mark class="highlight-current">/g, '').replace(/<\/mark>/g, '');
      findMatches = [];
      currentFindIndex = -1;
    }

    function findInDocument() {
      const searchText = document.getElementById('findInput').value;
      if (!searchText) {
        clearHighlights();
        document.getElementById('findCount').textContent = '0 results';
        return;
      }

      clearHighlights();
      const editor = document.getElementById('editor');
      const content = editor.innerHTML;
      const regex = new RegExp(`(${searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const newContent = content.replace(regex, '<mark class="highlight-find">$1</mark>');
      editor.innerHTML = newContent;

      findMatches = editor.querySelectorAll('mark.highlight-find');
      document.getElementById('findCount').textContent = findMatches.length + ' results';

      if (findMatches.length > 0) {
        currentFindIndex = 0;
        highlightCurrent();
      }
    }

    function highlightCurrent() {
      findMatches.forEach((m, i) => {
        m.className = i === currentFindIndex ? 'highlight-current' : 'highlight-find';
      });
      if (findMatches[currentFindIndex]) {
        findMatches[currentFindIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function findNext() {
      if (findMatches.length === 0) return;
      currentFindIndex = (currentFindIndex + 1) % findMatches.length;
      highlightCurrent();
    }

    function findPrev() {
      if (findMatches.length === 0) return;
      currentFindIndex = (currentFindIndex - 1 + findMatches.length) % findMatches.length;
      highlightCurrent();
    }

    function replaceOne() {
      if (findMatches.length === 0 || currentFindIndex < 0) return;
      const replaceText = document.getElementById('replaceInput').value;
      const current = findMatches[currentFindIndex];
      if (current) {
        current.outerHTML = replaceText;
        findInDocument();
        showToast('Replaced 1 occurrence', 'success');
      }
    }

    function replaceAll() {
      const searchText = document.getElementById('findInput').value;
      const replaceText = document.getElementById('replaceInput').value;
      if (!searchText) return;

      clearHighlights();
      const editor = document.getElementById('editor');
      const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const count = (editor.innerHTML.match(regex) || []).length;
      editor.innerHTML = editor.innerHTML.replace(regex, replaceText);
      showToast(`Replaced ${count} occurrences`, 'success');
      document.getElementById('findCount').textContent = '0 results';
    }

    // ==================== UNDO/REDO ====================
    let undoHistory = []; // Enhanced history with metadata
    let undoHistoryIndex = -1;

    function saveUndoState(actionType = 'edit') {
      const state = {
        content: editor.innerHTML,
        timestamp: Date.now(),
        action: actionType,
        wordCount: editor.textContent.trim().split(/\s+/).filter(w => w).length
      };

      // Remove any states after current index (if we undid and then edited)
      if (undoHistoryIndex < undoHistory.length - 1) {
        undoHistory = undoHistory.slice(0, undoHistoryIndex + 1);
      }

      undoHistory.push(state);
      undoHistoryIndex = undoHistory.length - 1;

      // Keep max 50 states
      if (undoHistory.length > 50) {
        undoHistory.shift();
        undoHistoryIndex--;
      }

      // Legacy support
      undoStack.push(editor.innerHTML);
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];

      updateUndoHistoryPanel();
    }

    function customUndo() {
      if (undoHistoryIndex > 0) {
        undoHistoryIndex--;
        editor.innerHTML = undoHistory[undoHistoryIndex].content;
        updateStats();
        updateUndoHistoryPanel();
        showToast('Undo', 'info');
      } else if (undoStack.length > 0) {
        redoStack.push(editor.innerHTML);
        editor.innerHTML = undoStack.pop();
        updateStats();
      }
    }

    function customRedo() {
      if (undoHistoryIndex < undoHistory.length - 1) {
        undoHistoryIndex++;
        editor.innerHTML = undoHistory[undoHistoryIndex].content;
        updateStats();
        updateUndoHistoryPanel();
        showToast('Redo', 'info');
      } else if (redoStack.length > 0) {
        undoStack.push(editor.innerHTML);
        editor.innerHTML = redoStack.pop();
        updateStats();
      }
    }

    function showUndoHistory() {
      document.getElementById('undoHistoryPanel').classList.add('visible');
      updateUndoHistoryPanel();
    }

    function hideUndoHistory() {
      document.getElementById('undoHistoryPanel').classList.remove('visible');
    }

    function toggleUndoHistory() {
      const panel = document.getElementById('undoHistoryPanel');
      panel.classList.toggle('visible');
      if (panel.classList.contains('visible')) {
        updateUndoHistoryPanel();
      }
    }

    function updateUndoHistoryPanel() {
      const list = document.getElementById('undoHistoryList');

      if (undoHistory.length === 0) {
        list.innerHTML = '<div class="undo-history-empty">No history yet.<br>Start editing to build history.</div>';
        return;
      }

      const actionIcons = {
        'edit': '‚úèÔ∏è',
        'format': 'üé®',
        'insert': '‚ûï',
        'delete': 'üóëÔ∏è',
        'paste': 'üìã',
        'initial': 'üìÑ'
      };

      list.innerHTML = undoHistory.map((state, index) => {
        const time = new Date(state.timestamp);
        const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const isCurrent = index === undoHistoryIndex;
        const icon = actionIcons[state.action] || '‚úèÔ∏è';

        return `
          <div class="undo-history-item ${isCurrent ? 'current' : ''}" onclick="jumpToHistoryState(${index})">
            <span class="undo-history-item-icon">${icon}</span>
            <span>${state.action.charAt(0).toUpperCase() + state.action.slice(1)} (${state.wordCount} words)</span>
            <span class="undo-history-item-time">${timeStr}</span>
          </div>
        `;
      }).reverse().join('');
    }

    function jumpToHistoryState(index) {
      if (index >= 0 && index < undoHistory.length) {
        undoHistoryIndex = index;
        editor.innerHTML = undoHistory[index].content;
        updateStats();
        updateUndoHistoryPanel();
        showToast(`Jumped to state ${index + 1}`, 'info');
      }
    }

    // Track changes for undo with debounce
    let undoDebounce = null;
    editor.addEventListener('input', () => {
      if (undoDebounce) clearTimeout(undoDebounce);
      undoDebounce = setTimeout(() => {
        saveUndoState('edit');
      }, 500);
    });

    // ==================== DOCX IMPORT/EXPORT ====================
    function importDocx() {
      toggleFileMenu();
      document.getElementById('docxImport').click();
    }

    function handleDocxImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      showToast('Importing DOCX...', 'info');

      const reader = new FileReader();
      reader.onload = function(e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result })
          .then(function(result) {
            editor.innerHTML = result.value;
            document.getElementById('fileName').value = file.name.replace('.docx', '');
            currentDocId = null;
            updateStats();
            showToast('DOCX imported successfully!', 'success');
            if (result.messages.length > 0) {
              console.log('Mammoth messages:', result.messages);
            }
          })
          .catch(function(err) {
            showToast('Error importing DOCX: ' + err.message, 'error');
          });
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    async function exportDocx() {
      toggleFileMenu();
      showToast('Generating DOCX...', 'info');

      try {
        const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

        // Parse HTML content to create DOCX elements
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;

        const children = [];

        function processNode(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            if (text.trim()) {
              return [new TextRun({ text: text })];
            }
            return [];
          }

          if (node.nodeType !== Node.ELEMENT_NODE) return [];

          const tag = node.tagName.toLowerCase();
          const runs = [];

          if (tag === 'h1' || tag === 'h2' || tag === 'h3') {
            const level = tag === 'h1' ? HeadingLevel.HEADING_1 :
                          tag === 'h2' ? HeadingLevel.HEADING_2 : HeadingLevel.HEADING_3;
            children.push(new Paragraph({
              text: node.textContent,
              heading: level
            }));
          } else if (tag === 'p' || tag === 'div') {
            const textRuns = [];
            node.childNodes.forEach(child => {
              if (child.nodeType === Node.TEXT_NODE) {
                textRuns.push(new TextRun({ text: child.textContent }));
              } else if (child.nodeType === Node.ELEMENT_NODE) {
                const childTag = child.tagName.toLowerCase();
                const isBold = childTag === 'strong' || childTag === 'b' || child.style.fontWeight === 'bold';
                const isItalic = childTag === 'em' || childTag === 'i' || child.style.fontStyle === 'italic';
                const isUnderline = childTag === 'u' || child.style.textDecoration === 'underline';
                textRuns.push(new TextRun({
                  text: child.textContent,
                  bold: isBold,
                  italics: isItalic,
                  underline: isUnderline ? {} : undefined
                }));
              }
            });
            if (textRuns.length > 0 || node.textContent.trim()) {
              children.push(new Paragraph({ children: textRuns.length > 0 ? textRuns : [new TextRun({ text: node.textContent })] }));
            }
          } else if (tag === 'ul' || tag === 'ol') {
            node.querySelectorAll('li').forEach((li, idx) => {
              children.push(new Paragraph({
                text: (tag === 'ol' ? (idx + 1) + '. ' : '‚Ä¢ ') + li.textContent,
              }));
            });
          } else if (tag === 'br') {
            children.push(new Paragraph({}));
          } else {
            // Process children
            node.childNodes.forEach(child => processNode(child));
          }

          return runs;
        }

        tempDiv.childNodes.forEach(node => processNode(node));

        // If no content was parsed, add a placeholder
        if (children.length === 0) {
          children.push(new Paragraph({ text: editor.textContent || 'Empty document' }));
        }

        const doc = new Document({
          sections: [{
            properties: {},
            children: children
          }]
        });

        const blob = await Packer.toBlob(doc);
        const fileName = document.getElementById('fileName').value || 'document';
        saveAs(blob, fileName + '.docx');
        showToast('DOCX exported successfully!', 'success');
      } catch (err) {
        console.error('DOCX export error:', err);
        showToast('Error exporting DOCX: ' + err.message, 'error');
      }
    }

    function exportHTML() {
      toggleFileMenu();
      const fileName = document.getElementById('fileName').value || 'document';
      const content = editor.innerHTML;

      const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${fileName}</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      line-height: 1.6;
      color: #333;
    }
    h1, h2, h3 { color: #1a73e8; margin-top: 1.5em; }
    h1 { font-size: 2rem; border-bottom: 2px solid #1a73e8; padding-bottom: 0.5rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.25rem; }
    p { margin: 1em 0; }
    table { border-collapse: collapse; width: 100%; margin: 1em 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f5f5f5; }
    ul, ol { margin: 1em 0; padding-left: 2em; }
    blockquote { border-left: 4px solid #1a73e8; margin: 1em 0; padding: 0.5em 1em; background: #f9f9f9; }
    img { max-width: 100%; height: auto; }
    code { background: #f5f5f5; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
    pre { background: #f5f5f5; padding: 1em; border-radius: 4px; overflow-x: auto; }
    .footnotes-section { border-top: 1px solid #ccc; margin-top: 2rem; padding-top: 1rem; font-size: 0.9em; }
    @media print {
      body { margin: 0; padding: 0; max-width: none; }
    }
  </style>
</head>
<body>
${content}
<footer style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.8rem; color: #666;">
  <p>Generated by NinjaWord - ${new Date().toLocaleDateString()}</p>
</footer>
</body>
</html>`;

      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName + '.html';
      a.click();
      URL.revokeObjectURL(url);
      showToast('HTML exported successfully!', 'success');
    }

    function exportMarkdown() {
      toggleFileMenu();
      const fileName = document.getElementById('fileName').value || 'document';
      const content = editor.innerHTML;

      // Convert HTML to Markdown
      let markdown = htmlToMarkdown(content);

      // Add metadata header
      const header = `---
title: ${fileName}
date: ${new Date().toISOString().split('T')[0]}
---

`;
      markdown = header + markdown;

      const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName + '.md';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Markdown exported successfully!', 'success');
    }

    function htmlToMarkdown(html) {
      // Create temp element
      const temp = document.createElement('div');
      temp.innerHTML = html;

      let markdown = '';

      function processNode(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          return node.textContent;
        }

        if (node.nodeType !== Node.ELEMENT_NODE) return '';

        const tag = node.tagName.toLowerCase();
        let result = '';
        let childContent = '';

        // Process children first
        node.childNodes.forEach(child => {
          childContent += processNode(child);
        });

        switch (tag) {
          case 'h1':
            result = `# ${childContent.trim()}\n\n`;
            break;
          case 'h2':
            result = `## ${childContent.trim()}\n\n`;
            break;
          case 'h3':
            result = `### ${childContent.trim()}\n\n`;
            break;
          case 'h4':
            result = `#### ${childContent.trim()}\n\n`;
            break;
          case 'h5':
            result = `##### ${childContent.trim()}\n\n`;
            break;
          case 'h6':
            result = `###### ${childContent.trim()}\n\n`;
            break;
          case 'p':
            result = `${childContent.trim()}\n\n`;
            break;
          case 'br':
            result = '  \n';
            break;
          case 'strong':
          case 'b':
            result = `**${childContent}**`;
            break;
          case 'em':
          case 'i':
            result = `*${childContent}*`;
            break;
          case 'u':
            result = `<u>${childContent}</u>`;
            break;
          case 's':
          case 'strike':
          case 'del':
            result = `~~${childContent}~~`;
            break;
          case 'code':
            result = `\`${childContent}\``;
            break;
          case 'pre':
            result = `\`\`\`\n${childContent.trim()}\n\`\`\`\n\n`;
            break;
          case 'blockquote':
            result = childContent.split('\n').map(line => `> ${line}`).join('\n') + '\n\n';
            break;
          case 'ul':
            result = childContent + '\n';
            break;
          case 'ol':
            result = childContent + '\n';
            break;
          case 'li':
            const parent = node.parentElement;
            if (parent && parent.tagName.toLowerCase() === 'ol') {
              const index = Array.from(parent.children).indexOf(node) + 1;
              result = `${index}. ${childContent.trim()}\n`;
            } else {
              result = `- ${childContent.trim()}\n`;
            }
            break;
          case 'a':
            const href = node.getAttribute('href') || '#';
            result = `[${childContent}](${href})`;
            break;
          case 'img':
            const src = node.getAttribute('src') || '';
            const alt = node.getAttribute('alt') || 'image';
            result = `![${alt}](${src})\n\n`;
            break;
          case 'hr':
            result = '\n---\n\n';
            break;
          case 'table':
            result = processTable(node) + '\n';
            break;
          case 'div':
            result = childContent + '\n';
            break;
          default:
            result = childContent;
        }

        return result;
      }

      function processTable(table) {
        let md = '\n';
        const rows = table.querySelectorAll('tr');

        rows.forEach((row, rowIdx) => {
          const cells = row.querySelectorAll('td, th');
          const cellContents = Array.from(cells).map(cell => cell.textContent.trim());
          md += '| ' + cellContents.join(' | ') + ' |\n';

          // Add header separator after first row
          if (rowIdx === 0) {
            md += '| ' + cellContents.map(() => '---').join(' | ') + ' |\n';
          }
        });

        return md;
      }

      temp.childNodes.forEach(node => {
        markdown += processNode(node);
      });

      // Clean up extra newlines
      markdown = markdown.replace(/\n{3,}/g, '\n\n').trim();

      return markdown;
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        showFindReplace();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
        e.preventDefault();
        showFindReplace();
        document.getElementById('replaceInput').focus();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        customUndo();
      }
      if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) {
        e.preventDefault();
        customRedo();
      }
      if (e.key === 'Escape') {
        hideFindReplace();
      }
    });

    // Initialize undo state
    saveUndoState();

    // ==================== PAGE SETUP & VIEW ====================
    let pageSettings = {
      paperSize: 'letter',
      orientation: 'portrait',
      marginTop: 1,
      marginBottom: 1,
      marginLeft: 1,
      marginRight: 1,
      headerText: '',
      footerText: '',
      showPageNumbers: true,
      pageNumberPosition: 'bottom-center'
    };

    function toggleRuler() {
      const ruler = document.getElementById('ruler');
      ruler.style.display = ruler.style.display === 'none' ? 'flex' : 'none';
      showToast(ruler.style.display === 'none' ? 'Ruler hidden' : 'Ruler shown', 'info');
    }

    function showPageSetup() {
      document.getElementById('paperSize').value = pageSettings.paperSize;
      document.getElementById('pageOrientation').value = pageSettings.orientation;
      document.getElementById('marginTop').value = pageSettings.marginTop;
      document.getElementById('marginBottom').value = pageSettings.marginBottom;
      document.getElementById('marginLeft').value = pageSettings.marginLeft;
      document.getElementById('marginRight').value = pageSettings.marginRight;
      document.getElementById('headerText').value = pageSettings.headerText;
      document.getElementById('footerText').value = pageSettings.footerText;
      document.getElementById('showPageNumbers').checked = pageSettings.showPageNumbers;
      document.getElementById('pageNumberPosition').value = pageSettings.pageNumberPosition;
      document.getElementById('pageSetupModal').classList.add('active');
    }

    function hidePageSetup() {
      document.getElementById('pageSetupModal').classList.remove('active');
    }

    function applyPageSetup() {
      pageSettings = {
        paperSize: document.getElementById('paperSize').value,
        orientation: document.getElementById('pageOrientation').value,
        marginTop: parseFloat(document.getElementById('marginTop').value),
        marginBottom: parseFloat(document.getElementById('marginBottom').value),
        marginLeft: parseFloat(document.getElementById('marginLeft').value),
        marginRight: parseFloat(document.getElementById('marginRight').value),
        headerText: document.getElementById('headerText').value,
        footerText: document.getElementById('footerText').value,
        showPageNumbers: document.getElementById('showPageNumbers').checked,
        pageNumberPosition: document.getElementById('pageNumberPosition').value
      };

      // Apply margins to document
      const doc = document.getElementById('editor');
      doc.style.padding = `${pageSettings.marginTop}in ${pageSettings.marginRight}in ${pageSettings.marginBottom}in ${pageSettings.marginLeft}in`;

      // Apply paper size
      const sizes = {
        letter: { width: '8.5in', height: '11in' },
        a4: { width: '210mm', height: '297mm' },
        legal: { width: '8.5in', height: '14in' }
      };
      const size = sizes[pageSettings.paperSize];

      if (pageSettings.orientation === 'landscape') {
        doc.style.width = size.height;
        doc.style.minHeight = size.width;
      } else {
        doc.style.width = size.width;
        doc.style.minHeight = size.height;
      }

      hidePageSetup();
      showToast('Page setup applied', 'success');
    }

    function toggleHeaderFooter() {
      showPageSetup();
      document.getElementById('headerText').focus();
    }

    // ==================== LINE & PARAGRAPH SPACING ====================
    function setLineSpacing(value) {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        let container = range.commonAncestorContainer;
        if (container.nodeType === Node.TEXT_NODE) {
          container = container.parentElement;
        }
        // Find block-level parent
        while (container && !['P', 'DIV', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(container.tagName)) {
          container = container.parentElement;
        }
        if (container) {
          container.style.lineHeight = value;
        }
      }
      // Also set default for new content
      editor.style.lineHeight = value;
      showToast(`Line spacing set to ${value}`, 'info');
    }

    function setParagraphSpacing(type) {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        let container = range.commonAncestorContainer;
        if (container.nodeType === Node.TEXT_NODE) {
          container = container.parentElement;
        }
        while (container && !['P', 'DIV', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(container.tagName)) {
          container = container.parentElement;
        }
        if (container) {
          if (type === 'before') {
            const current = parseInt(container.style.marginTop) || 0;
            container.style.marginTop = (current + 12) + 'px';
          } else {
            const current = parseInt(container.style.marginBottom) || 0;
            container.style.marginBottom = (current + 12) + 'px';
          }
          showToast(`Added space ${type} paragraph`, 'info');
        }
      }
    }

    // ==================== STYLES ====================
    function showStylesPanel() {
      document.getElementById('stylesModal').classList.add('active');
    }

    function hideStylesPanel() {
      document.getElementById('stylesModal').classList.remove('active');
    }

    function applyStyle(styleName) {
      const selection = window.getSelection();
      if (!selection.rangeCount) {
        showToast('Please select some text first', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);
      let container = range.commonAncestorContainer;
      if (container.nodeType === Node.TEXT_NODE) {
        container = container.parentElement;
      }

      const styles = {
        title: { tag: 'h1', css: 'font-size: 28pt; font-weight: bold; text-align: center; margin-bottom: 0.5em;' },
        heading1: { tag: 'h1', css: 'font-size: 20pt; font-weight: bold; color: #1a73e8; margin-top: 1em; margin-bottom: 0.5em;' },
        heading2: { tag: 'h2', css: 'font-size: 16pt; font-weight: bold; color: #1a73e8; margin-top: 0.8em; margin-bottom: 0.4em;' },
        heading3: { tag: 'h3', css: 'font-size: 14pt; font-weight: bold; margin-top: 0.6em; margin-bottom: 0.3em;' },
        normal: { tag: 'p', css: 'font-size: 12pt; font-weight: normal; color: #000; margin-bottom: 0.5em;' },
        quote: { tag: 'blockquote', css: 'font-size: 12pt; font-style: italic; border-left: 3px solid #ccc; padding-left: 1em; margin: 1em 0; color: #555;' },
        subtitle: { tag: 'p', css: 'font-size: 14pt; color: #666; text-align: center; margin-bottom: 1em;' },
        code: { tag: 'pre', css: 'font-family: monospace; background: #f5f5f5; padding: 0.5em; border-radius: 4px; overflow-x: auto;' }
      };

      const style = styles[styleName];
      if (!style) return;

      // Create new element with style
      const newElement = document.createElement(style.tag);
      newElement.style.cssText = style.css;
      newElement.innerHTML = range.toString() || container.innerHTML;

      // Replace selection or container
      if (range.toString()) {
        range.deleteContents();
        range.insertNode(newElement);
      } else {
        container.outerHTML = newElement.outerHTML;
      }

      hideStylesPanel();
      showToast(`Applied ${styleName} style`, 'success');
    }

    // ==================== PRINT PREVIEW ====================
    function togglePrintPreview() {
      const preview = document.getElementById('printPreviewContent');
      preview.innerHTML = editor.innerHTML;
      preview.style.width = pageSettings.orientation === 'landscape' ? '11in' : '8.5in';
      preview.style.minHeight = pageSettings.orientation === 'landscape' ? '8.5in' : '11in';
      preview.style.padding = `${pageSettings.marginTop}in ${pageSettings.marginRight}in ${pageSettings.marginBottom}in ${pageSettings.marginLeft}in`;

      // Add header if set
      if (pageSettings.headerText) {
        const header = document.createElement('div');
        header.style.cssText = 'text-align: center; font-size: 10pt; color: #666; border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 16px;';
        header.textContent = pageSettings.headerText;
        preview.insertBefore(header, preview.firstChild);
      }

      // Add footer if set
      if (pageSettings.footerText || pageSettings.showPageNumbers) {
        const footer = document.createElement('div');
        footer.style.cssText = 'text-align: center; font-size: 10pt; color: #666; border-top: 1px solid #ccc; padding-top: 8px; margin-top: 16px; position: absolute; bottom: 0.5in; left: 0; right: 0;';
        let footerContent = pageSettings.footerText || '';
        if (pageSettings.showPageNumbers) {
          footerContent += (footerContent ? ' | ' : '') + 'Page 1';
        }
        footer.textContent = footerContent;
        preview.style.position = 'relative';
        preview.appendChild(footer);
      }

      document.getElementById('printPreviewModal').classList.add('active');
    }

    function hidePrintPreview() {
      document.getElementById('printPreviewModal').classList.remove('active');
    }

    // ==================== TAB SWITCHING ====================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Hide all toolbars
        ['homeToolbar', 'insertToolbar', 'reviewToolbar', 'viewToolbar'].forEach(id => {
          document.getElementById(id).style.display = 'none';
        });

        // Show selected toolbar
        const tabName = tab.dataset.tab;
        const toolbarMap = {
          home: 'homeToolbar',
          insert: 'insertToolbar',
          review: 'reviewToolbar',
          view: 'viewToolbar'
        };

        if (toolbarMap[tabName]) {
          document.getElementById(toolbarMap[tabName]).style.display = 'flex';
        }
      });
    });

    // ==================== TABLE OF CONTENTS ====================
    let bookmarks = {};

    function insertTableOfContents() {
      // Find all headings in the document
      const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');

      if (headings.length === 0) {
        showToast('No headings found. Add headings (H1-H6) to generate TOC.', 'warning');
        return;
      }

      let tocHtml = '<div class="toc-container" style="border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; background: #fafafa;">';
      tocHtml += '<h3 style="margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Table of Contents</h3>';
      tocHtml += '<div class="toc-entries">';

      headings.forEach((heading, index) => {
        const level = parseInt(heading.tagName.charAt(1));
        const indent = (level - 1) * 20;
        const text = heading.textContent;
        const anchorId = 'toc-anchor-' + index;

        // Add anchor to heading if not present
        if (!heading.id) {
          heading.id = anchorId;
        }

        tocHtml += `<div class="toc-entry" style="margin-left: ${indent}px; padding: 0.25rem 0;">`;
        tocHtml += `<a href="#${heading.id}" style="color: #1a73e8; text-decoration: none;" onclick="document.getElementById('${heading.id}').scrollIntoView({behavior:'smooth'}); return false;">${text}</a>`;
        tocHtml += '</div>';
      });

      tocHtml += '</div></div>';

      // Insert at cursor position or at beginning
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        document.execCommand('insertHTML', false, tocHtml);
      } else {
        editor.insertAdjacentHTML('afterbegin', tocHtml);
      }

      showToast(`Table of Contents created with ${headings.length} entries`, 'success');
    }

    // ==================== FOOTNOTES ====================
    let footnotes = [];
    let footnoteCounter = 1;

    function insertFootnote() {
      const selection = window.getSelection();
      const footnoteText = prompt('Enter footnote text:');

      if (!footnoteText) return;

      const footnoteNum = footnoteCounter++;
      footnotes.push({ num: footnoteNum, text: footnoteText });

      // Insert superscript reference at cursor
      const refHtml = `<sup class="footnote-ref" style="color: #1a73e8; cursor: pointer;" onclick="scrollToFootnote(${footnoteNum})" title="${footnoteText}">[${footnoteNum}]</sup>`;
      document.execCommand('insertHTML', false, refHtml);

      // Update footnotes section at bottom
      updateFootnotesSection();

      showToast(`Footnote ${footnoteNum} added`, 'success');
    }

    function scrollToFootnote(num) {
      const footnoteEl = document.getElementById('footnote-' + num);
      if (footnoteEl) {
        footnoteEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        footnoteEl.style.background = '#fff3cd';
        setTimeout(() => { footnoteEl.style.background = ''; }, 2000);
      }
    }

    function updateFootnotesSection() {
      // Remove existing footnotes section
      const existing = editor.querySelector('.footnotes-section');
      if (existing) existing.remove();

      if (footnotes.length === 0) return;

      let footnotesHtml = '<div class="footnotes-section" style="border-top: 1px solid #ccc; margin-top: 2rem; padding-top: 1rem; font-size: 0.9em;">';
      footnotesHtml += '<h4 style="margin-top: 0; color: #666;">Footnotes</h4>';

      footnotes.forEach(fn => {
        footnotesHtml += `<div id="footnote-${fn.num}" class="footnote-item" style="margin-bottom: 0.5rem;">`;
        footnotesHtml += `<sup style="color: #1a73e8;">[${fn.num}]</sup> ${fn.text}`;
        footnotesHtml += '</div>';
      });

      footnotesHtml += '</div>';
      editor.insertAdjacentHTML('beforeend', footnotesHtml);
    }

    // ==================== BOOKMARKS ====================
    function insertBookmark() {
      const selection = window.getSelection();
      const bookmarkName = prompt('Enter bookmark name:');

      if (!bookmarkName) return;

      // Sanitize bookmark name
      const sanitizedName = bookmarkName.replace(/[^a-zA-Z0-9_-]/g, '_');

      if (bookmarks[sanitizedName]) {
        if (!confirm(`Bookmark "${bookmarkName}" already exists. Replace it?`)) return;
      }

      // Create bookmark anchor
      const bookmarkHtml = `<span id="bookmark-${sanitizedName}" class="bookmark-anchor" style="border-left: 3px solid #1a73e8; padding-left: 4px; background: #e8f0fe;" title="Bookmark: ${bookmarkName}">&#8203;</span>`;

      if (selection.rangeCount > 0 && selection.toString()) {
        // Wrap selected text
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.id = 'bookmark-' + sanitizedName;
        span.className = 'bookmark-anchor';
        span.style.cssText = 'border-left: 3px solid #1a73e8; padding-left: 4px; background: #e8f0fe;';
        span.title = 'Bookmark: ' + bookmarkName;
        range.surroundContents(span);
      } else {
        document.execCommand('insertHTML', false, bookmarkHtml);
      }

      bookmarks[sanitizedName] = bookmarkName;
      showToast(`Bookmark "${bookmarkName}" added`, 'success');
    }

    function goToBookmark(name) {
      const bookmark = document.getElementById('bookmark-' + name);
      if (bookmark) {
        bookmark.scrollIntoView({ behavior: 'smooth', block: 'center' });
        bookmark.style.background = '#fff3cd';
        setTimeout(() => { bookmark.style.background = '#e8f0fe'; }, 2000);
      }
    }

    // ==================== WATERMARKS ====================
    function insertWatermark() {
      document.getElementById('watermarkModal').style.display = 'flex';
    }

    function hideWatermarkModal() {
      document.getElementById('watermarkModal').style.display = 'none';
    }

    function setWatermarkPreset(text) {
      document.getElementById('watermarkText').value = text;
    }

    function applyWatermark() {
      const watermarkText = document.getElementById('watermarkText').value.trim();
      if (!watermarkText) {
        showToast('Please enter watermark text', 'error');
        return;
      }

      const color = document.getElementById('watermarkColor').value;
      const opacity = document.getElementById('watermarkOpacity').value / 100;
      const size = document.getElementById('watermarkSize').value;
      const layout = document.getElementById('watermarkLayout').value;

      // Convert hex to rgba
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      const rgbaColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;

      // Remove existing watermark
      const existing = document.querySelector('.document-watermark');
      if (existing) existing.remove();

      // Add watermark style to document area
      const docArea = document.getElementById('documentArea');
      const watermark = document.createElement('div');
      watermark.className = 'document-watermark';

      const rotation = layout === 'diagonal' ? 'rotate(-45deg)' : 'rotate(0deg)';

      watermark.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) ${rotation};
        font-size: ${size}px;
        font-weight: bold;
        color: ${rgbaColor};
        pointer-events: none;
        z-index: 1;
        white-space: nowrap;
        user-select: none;
        text-transform: uppercase;
        letter-spacing: 4px;
      `;
      watermark.textContent = watermarkText;

      docArea.style.position = 'relative';
      docArea.appendChild(watermark);

      hideWatermarkModal();
      showToast(`Watermark "${watermarkText}" added`, 'success');
    }

    function removeWatermark() {
      const watermark = document.querySelector('.document-watermark');
      if (watermark) {
        watermark.remove();
        showToast('Watermark removed', 'success');
      }
      hideWatermarkModal();
    }

    // ==================== COLUMNS LAYOUT ====================
    let columnsPopup = null;

    const columnPresets = [
      { name: 'One', cols: 1, icon: '‚ñÆ', widths: '100%' },
      { name: 'Two', cols: 2, icon: '‚ñÆ‚ñÆ', widths: '50% 50%' },
      { name: 'Three', cols: 3, icon: '‚ñÆ‚ñÆ‚ñÆ', widths: '33% 33% 33%' },
      { name: 'Left', cols: 2, icon: '‚ñÆ‚ñØ', widths: '65% 35%' },
      { name: 'Right', cols: 2, icon: '‚ñØ‚ñÆ', widths: '35% 65%' }
    ];

    function setColumns(event) {
      if (event) event.stopPropagation();

      if (columnsPopup) {
        columnsPopup.remove();
        columnsPopup = null;
        return;
      }

      const btn = event ? event.target : document.querySelector('[title="Columns"]');
      const rect = btn.getBoundingClientRect();

      columnsPopup = document.createElement('div');
      columnsPopup.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        z-index: 10000;
        width: 280px;
      `;

      let html = `<div style="font-weight: bold; margin-bottom: 10px; color: #333;">üì∞ Column Layout</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 12px;">`;

      columnPresets.forEach(preset => {
        html += `
          <div onclick="applyColumnPreset(${preset.cols}, '${preset.widths}')"
               style="padding: 10px 4px; text-align: center; cursor: pointer; border: 1px solid #ddd;
                      border-radius: 6px; background: white; transition: all 0.2s;"
               onmouseover="this.style.background='#e8f0fe';this.style.borderColor='#1a73e8'"
               onmouseout="this.style.background='white';this.style.borderColor='#ddd'"
               title="${preset.name}">
            <div style="font-size: 18px; letter-spacing: 2px;">${preset.icon}</div>
            <div style="font-size: 10px; color: #666; margin-top: 2px;">${preset.name}</div>
          </div>`;
      });
      html += `</div>`;

      // Column settings
      html += `
        <div style="border-top: 1px solid #eee; padding-top: 10px;">
          <div style="display: flex; gap: 10px; margin-bottom: 8px;">
            <div style="flex: 1;">
              <label style="font-size: 11px; color: #666;">Gap</label>
              <select id="columnGap" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="1rem">Small</option>
                <option value="2rem" selected>Medium</option>
                <option value="3rem">Large</option>
              </select>
            </div>
            <div style="flex: 1;">
              <label style="font-size: 11px; color: #666;">Divider</label>
              <select id="columnRule" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="none">None</option>
                <option value="1px solid #ddd" selected>Thin</option>
                <option value="2px solid #999">Medium</option>
                <option value="1px dashed #999">Dashed</option>
              </select>
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="applyCustomColumns()"
                    style="flex: 1; padding: 8px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              Apply to Selection
            </button>
            <button onclick="resetColumns()"
                    style="padding: 8px 12px; background: #f1f1f1; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px;">
              Reset
            </button>
          </div>
        </div>
      `;

      columnsPopup.innerHTML = html;
      document.body.appendChild(columnsPopup);

      setTimeout(() => {
        document.addEventListener('click', closeColumnsPopup);
      }, 10);
    }

    function closeColumnsPopup(e) {
      if (columnsPopup && !columnsPopup.contains(e.target)) {
        columnsPopup.remove();
        columnsPopup = null;
        document.removeEventListener('click', closeColumnsPopup);
      }
    }

    function applyColumnPreset(numCols, widths) {
      const gap = document.getElementById('columnGap')?.value || '2rem';
      const rule = document.getElementById('columnRule')?.value || '1px solid #ddd';

      applyColumnsToContent(numCols, gap, rule);

      if (columnsPopup) {
        columnsPopup.remove();
        columnsPopup = null;
      }
    }

    function applyCustomColumns() {
      const numCols = 2; // Default
      const gap = document.getElementById('columnGap').value;
      const rule = document.getElementById('columnRule').value;

      applyColumnsToContent(numCols, gap, rule);

      if (columnsPopup) {
        columnsPopup.remove();
        columnsPopup = null;
      }
    }

    function applyColumnsToContent(numCols, gap, rule) {
      const selection = window.getSelection();

      if (numCols === 1) {
        // Reset columns
        resetColumns();
        return;
      }

      if (selection.rangeCount > 0 && selection.toString().trim()) {
        // Wrap selected text in columns
        const range = selection.getRangeAt(0);
        const wrapper = document.createElement('div');
        wrapper.style.cssText = `column-count: ${numCols}; column-gap: ${gap}; column-rule: ${rule}; margin: 1rem 0;`;
        wrapper.className = 'column-layout';

        const content = range.extractContents();
        wrapper.appendChild(content);
        range.insertNode(wrapper);
      } else {
        // Apply columns to entire document
        editor.style.columnCount = numCols;
        editor.style.columnGap = gap;
        editor.style.columnRule = rule;
      }

      showToast(`${numCols}-column layout applied`, 'success');
    }

    function resetColumns() {
      editor.style.columnCount = '';
      editor.style.columnGap = '';
      editor.style.columnRule = '';

      // Also remove any column wrappers
      editor.querySelectorAll('.column-layout').forEach(el => {
        el.outerHTML = el.innerHTML;
      });

      showToast('Column layout reset', 'success');

      if (columnsPopup) {
        columnsPopup.remove();
        columnsPopup = null;
      }
    }

    // ==================== ENHANCED SPELL CHECK ====================
    const commonMisspellings = {
      'teh': 'the', 'recieve': 'receive', 'seperate': 'separate', 'occured': 'occurred',
      'definately': 'definitely', 'accomodate': 'accommodate', 'occassion': 'occasion',
      'independant': 'independent', 'concensus': 'consensus', 'occurence': 'occurrence',
      'beleive': 'believe', 'refered': 'referred', 'untill': 'until', 'wierd': 'weird',
      'truely': 'truly', 'existance': 'existence', 'suprise': 'surprise', 'goverment': 'government',
      'enviroment': 'environment', 'millenium': 'millennium', 'knowlege': 'knowledge',
      'mispell': 'misspell', 'adress': 'address', 'begining': 'beginning', 'calender': 'calendar',
      'collegue': 'colleague', 'commited': 'committed', 'competetive': 'competitive',
      'consciencious': 'conscientious', 'copywrite': 'copyright', 'dilemna': 'dilemma',
      'dissapear': 'disappear', 'dissapoint': 'disappoint', 'embarass': 'embarrass',
      'equiptment': 'equipment', 'exagerate': 'exaggerate', 'excercise': 'exercise',
      'experiance': 'experience', 'foriegn': 'foreign', 'fourty': 'forty', 'freind': 'friend',
      'gaurd': 'guard', 'greatful': 'grateful', 'harrass': 'harass', 'heighth': 'height',
      'humourous': 'humorous', 'immediatly': 'immediately', 'intresting': 'interesting',
      'judgement': 'judgment', 'liason': 'liaison', 'maintainance': 'maintenance',
      'manuever': 'maneuver', 'miniture': 'miniature', 'neccessary': 'necessary',
      'noticable': 'noticeable', 'persistant': 'persistent', 'posession': 'possession',
      'prefered': 'preferred', 'priviledge': 'privilege', 'profesional': 'professional',
      'publically': 'publicly', 'recomend': 'recommend', 'rediculous': 'ridiculous',
      'relevent': 'relevant', 'rythm': 'rhythm', 'sacrilegious': 'sacrilegious',
      'schedual': 'schedule', 'sieze': 'seize', 'succesful': 'successful', 'supercede': 'supersede',
      'thier': 'their', 'tommorow': 'tomorrow', 'tyrany': 'tyranny', 'usally': 'usually',
      'vaccum': 'vacuum', 'vegatable': 'vegetable', 'visious': 'vicious', 'wether': 'whether'
    };

    let customDictionary = JSON.parse(localStorage.getItem('customDictionary') || '[]');
    let spellingErrors = [];

    function runSpellCheck() {
      const text = editor.innerText;
      const words = text.match(/\b[a-zA-Z]+\b/g) || [];
      spellingErrors = [];

      const suggestionsDiv = document.getElementById('spellingSuggestions');
      suggestionsDiv.innerHTML = '';

      words.forEach(word => {
        const lower = word.toLowerCase();
        if (commonMisspellings[lower] && !customDictionary.includes(lower)) {
          spellingErrors.push({
            word: word,
            suggestion: commonMisspellings[lower]
          });
        }
      });

      if (spellingErrors.length === 0) {
        suggestionsDiv.innerHTML = '<p style="color: green;">No spelling errors found!</p>';
        showToast('Spell check complete - no errors', 'success');
      } else {
        const uniqueErrors = [...new Map(spellingErrors.map(e => [e.word.toLowerCase(), e])).values()];
        suggestionsDiv.innerHTML = uniqueErrors.slice(0, 10).map(err => `
          <div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
            <span style="color: #ea4335; text-decoration: line-through;">${err.word}</span>
            <span style="color: var(--secondary);">‚Üí</span>
            <span style="color: #34a853; cursor: pointer;" onclick="correctSpelling('${err.word}', '${err.suggestion}')">${err.suggestion}</span>
            <button class="btn btn-secondary" style="float: right; padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="addToDict('${err.word.toLowerCase()}')">Add to Dict</button>
          </div>
        `).join('');
        showToast(`Found ${uniqueErrors.length} potential spelling error(s)`, 'warning');
      }
    }

    function correctSpelling(wrong, right) {
      const html = editor.innerHTML;
      const regex = new RegExp('\\b' + wrong + '\\b', 'gi');
      editor.innerHTML = html.replace(regex, right);
      runSpellCheck();
      showToast('Corrected: ' + wrong + ' ‚Üí ' + right, 'success');
    }

    function addToDict(word) {
      if (!customDictionary.includes(word)) {
        customDictionary.push(word);
        localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
        runSpellCheck();
        showToast('Added to dictionary: ' + word, 'success');
      }
    }

    // ==================== CUSTOM DICTIONARY MANAGEMENT ====================
    function showCustomDictionary() {
      renderCustomDictList();
      document.getElementById('customDictModal').classList.add('active');
      document.getElementById('newDictWord').focus();
    }

    function hideCustomDictionary() {
      document.getElementById('customDictModal').classList.remove('active');
    }

    function renderCustomDictList() {
      const list = document.getElementById('customDictList');
      const sorted = [...customDictionary].sort();

      if (sorted.length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 1rem;">No custom words added yet.</p>';
      } else {
        list.innerHTML = sorted.map(word => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem; border-bottom: 1px solid var(--border);">
            <span>${word}</span>
            <button class="btn btn-danger" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;" onclick="removeFromDict('${word}')">√ó</button>
          </div>
        `).join('');
      }

      document.getElementById('dictWordCount').textContent = customDictionary.length;
    }

    function addWordToDict() {
      const input = document.getElementById('newDictWord');
      const word = input.value.trim().toLowerCase();

      if (!word) {
        showToast('Please enter a word', 'warning');
        return;
      }

      if (customDictionary.includes(word)) {
        showToast('Word already in dictionary', 'info');
        return;
      }

      customDictionary.push(word);
      localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
      renderCustomDictList();
      input.value = '';
      input.focus();
      showToast('Added: ' + word, 'success');
    }

    function removeFromDict(word) {
      customDictionary = customDictionary.filter(w => w !== word);
      localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
      renderCustomDictList();
      showToast('Removed: ' + word, 'info');
    }

    function clearCustomDictionary() {
      if (!confirm('Clear all words from your custom dictionary?')) return;
      customDictionary = [];
      localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
      renderCustomDictList();
      showToast('Custom dictionary cleared', 'info');
    }

    function exportCustomDictionary() {
      if (customDictionary.length === 0) {
        showToast('Dictionary is empty', 'warning');
        return;
      }
      const content = customDictionary.sort().join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'custom-dictionary.txt';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Dictionary exported', 'success');
    }

    function importCustomDictionary() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const content = event.target.result;
          const words = content.split(/[\n\r]+/).map(w => w.trim().toLowerCase()).filter(w => w && /^[a-z]+$/.test(w));

          if (words.length === 0) {
            showToast('No valid words found in file', 'error');
            return;
          }

          // Merge with existing dictionary
          const newWords = words.filter(w => !customDictionary.includes(w));
          customDictionary = [...customDictionary, ...newWords];
          localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
          renderCustomDictList();
          showToast(`Imported ${newWords.length} new word(s)`, 'success');
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Allow Enter key to add word
    document.addEventListener('DOMContentLoaded', () => {
      const newDictInput = document.getElementById('newDictWord');
      if (newDictInput) {
        newDictInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            addWordToDict();
          }
        });
      }
    });

    // ==================== DOCUMENT OUTLINE ====================
    function refreshOutline() {
      const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
      const outlineList = document.getElementById('outlineList');

      if (headings.length === 0) {
        outlineList.innerHTML = '<p style="color: var(--secondary);">No headings found. Add H1-H6 headings to see outline.</p>';
        return;
      }

      outlineList.innerHTML = Array.from(headings).map((h, i) => {
        const level = parseInt(h.tagName.charAt(1));
        const indent = (level - 1) * 12;
        const text = h.textContent.substring(0, 40) + (h.textContent.length > 40 ? '...' : '');
        if (!h.id) h.id = 'heading-' + i;
        return `
          <div style="padding: 0.3rem; padding-left: ${indent}px; cursor: pointer; border-radius: 4px;"
               onmouseover="this.style.background='var(--light)'"
               onmouseout="this.style.background=''"
               onclick="scrollToHeading('${h.id}')">
            <span style="color: var(--secondary); font-size: 0.7rem;">H${level}</span> ${text}
          </div>
        `;
      }).join('');
    }

    function scrollToHeading(id) {
      const heading = document.getElementById(id);
      if (heading) {
        heading.scrollIntoView({ behavior: 'smooth', block: 'center' });
        heading.style.background = '#fff3cd';
        setTimeout(() => { heading.style.background = ''; }, 2000);
      }
    }

    // Auto-refresh outline on content change
    let outlineTimeout;
    editor.addEventListener('input', () => {
      clearTimeout(outlineTimeout);
      outlineTimeout = setTimeout(refreshOutline, 1000);
    });

    // ==================== SECTION BREAKS ====================
    function insertSectionBreak() {
      const breakType = prompt('Section break type:\n1. Next Page\n2. Continuous\n3. Even Page\n4. Odd Page\n\nEnter number (1-4):', '1');

      if (!breakType) return;

      const types = {
        '1': { label: 'Next Page', style: 'page-break-after: always;' },
        '2': { label: 'Continuous', style: 'border-top: 2px dashed #ccc; margin: 1rem 0;' },
        '3': { label: 'Even Page', style: 'page-break-after: left;' },
        '4': { label: 'Odd Page', style: 'page-break-after: right;' }
      };

      const type = types[breakType] || types['1'];

      const breakHtml = `<div class="section-break" contenteditable="false" style="${type.style} padding: 0.5rem; text-align: center; color: #999; font-size: 0.8rem; background: #f5f5f5;">--- Section Break (${type.label}) ---</div>`;

      document.execCommand('insertHTML', false, breakHtml);
      showToast(`${type.label} section break inserted`, 'success');
    }

    // ==================== PAGE BORDERS ====================
    function showPageBorders() {
      updateBorderPreview();
      document.getElementById('pageBordersModal').classList.add('active');

      // Add change listeners for preview
      ['borderStyle', 'borderWidth', 'borderColor', 'borderArt'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateBorderPreview);
      });
    }

    function hidePageBorders() {
      document.getElementById('pageBordersModal').classList.remove('active');
    }

    function updateBorderPreview() {
      const style = document.getElementById('borderStyle').value;
      const width = document.getElementById('borderWidth').value;
      const color = document.getElementById('borderColor').value;
      const art = document.getElementById('borderArt').value;

      const preview = document.getElementById('borderPreview');

      if (style === 'none') {
        preview.style.border = 'none';
        preview.style.boxShadow = 'none';
        preview.style.borderRadius = '0';
      } else {
        preview.style.border = `${width} ${style} ${color}`;

        if (art === 'shadow') {
          preview.style.boxShadow = `5px 5px 10px rgba(0,0,0,0.3)`;
        } else {
          preview.style.boxShadow = 'none';
        }

        if (art === 'rounded') {
          preview.style.borderRadius = '10px';
        } else {
          preview.style.borderRadius = '0';
        }
      }
    }

    function applyPageBorders() {
      const style = document.getElementById('borderStyle').value;
      const width = document.getElementById('borderWidth').value;
      const color = document.getElementById('borderColor').value;
      const art = document.getElementById('borderArt').value;

      const docArea = document.getElementById('documentArea');

      if (style === 'none') {
        docArea.style.border = 'none';
        docArea.style.boxShadow = 'none';
        docArea.style.borderRadius = '0';
      } else {
        docArea.style.border = `${width} ${style} ${color}`;

        if (art === 'shadow') {
          docArea.style.boxShadow = `5px 5px 15px rgba(0,0,0,0.3)`;
        } else {
          docArea.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
        }

        if (art === 'rounded') {
          docArea.style.borderRadius = '10px';
        } else {
          docArea.style.borderRadius = '0';
        }
      }

      hidePageBorders();
      showToast('Page borders applied', 'success');
    }

    function removePageBorders() {
      const docArea = document.getElementById('documentArea');
      docArea.style.border = 'none';
      docArea.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
      docArea.style.borderRadius = '0';
      hidePageBorders();
      showToast('Page borders removed', 'success');
    }

    // ==================== PAGE COLOR ====================
    let pageColorPopup = null;

    const pageColors = [
      { name: 'White', color: '#ffffff' },
      { name: 'Ivory', color: '#fffff0' },
      { name: 'Cream', color: '#fffdd0' },
      { name: 'Light Yellow', color: '#ffffe0' },
      { name: 'Light Blue', color: '#e6f3ff' },
      { name: 'Light Green', color: '#e6ffe6' },
      { name: 'Light Pink', color: '#ffe6f0' },
      { name: 'Light Gray', color: '#f5f5f5' },
      { name: 'Sepia', color: '#f5f5dc' },
      { name: 'Parchment', color: '#fcf5e5' },
      { name: 'Lavender', color: '#e6e6fa' },
      { name: 'Mint', color: '#e0ffe0' },
      { name: 'Peach', color: '#ffe5cc' },
      { name: 'Sky', color: '#cce5ff' },
      { name: 'Gray', color: '#d0d0d0' },
      { name: 'Dark', color: '#2d2d2d' }
    ];

    function showPageColor(event) {
      event.stopPropagation();

      if (pageColorPopup) {
        pageColorPopup.remove();
        pageColorPopup = null;
        return;
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      pageColorPopup = document.createElement('div');
      pageColorPopup.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        z-index: 10000;
        width: 240px;
      `;

      let html = `<div style="font-weight: bold; margin-bottom: 10px; color: #333;">üé® Page Color</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px;">`;

      pageColors.forEach(c => {
        const isDark = c.color === '#2d2d2d';
        html += `
          <div onclick="setPageColor('${c.color}')"
               style="width: 48px; height: 32px; background: ${c.color}; border: 1px solid #999;
                      border-radius: 4px; cursor: pointer; transition: transform 0.2s;"
               onmouseover="this.style.transform='scale(1.1)'"
               onmouseout="this.style.transform='scale(1)'"
               title="${c.name}">
          </div>`;
      });
      html += `</div>`;

      // Custom color picker
      html += `
        <div style="border-top: 1px solid #eee; padding-top: 10px;">
          <label style="font-size: 12px; color: #666;">Custom Color:</label>
          <div style="display: flex; gap: 8px; margin-top: 4px;">
            <input type="color" id="customPageColor" value="#ffffff" style="flex: 1; height: 32px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <button onclick="setPageColor(document.getElementById('customPageColor').value)"
                    style="padding: 6px 12px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Apply
            </button>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <button onclick="setPageColor('#ffffff')"
                  style="width: 100%; padding: 6px; background: #f1f1f1; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            Reset to White
          </button>
        </div>
      `;

      pageColorPopup.innerHTML = html;
      document.body.appendChild(pageColorPopup);

      setTimeout(() => {
        document.addEventListener('click', closePageColorPopup);
      }, 10);
    }

    function closePageColorPopup(e) {
      if (pageColorPopup && !pageColorPopup.contains(e.target)) {
        pageColorPopup.remove();
        pageColorPopup = null;
        document.removeEventListener('click', closePageColorPopup);
      }
    }

    function setPageColor(color) {
      const docArea = document.getElementById('documentArea');
      const editor = document.getElementById('editor');

      docArea.style.background = color;
      editor.style.background = color;

      // If dark color, adjust text color
      const isDark = parseInt(color.replace('#', ''), 16) < 0x888888;
      if (isDark) {
        editor.style.color = '#ffffff';
      } else {
        editor.style.color = '#333333';
      }

      showToast(`Page color set to ${color}`, 'success');

      if (pageColorPopup) {
        pageColorPopup.remove();
        pageColorPopup = null;
      }
    }

    // ==================== DROP CAP ====================
    function insertDropCap() {
      const selection = window.getSelection();
      if (!selection.rangeCount) {
        showToast('Place cursor at the beginning of a paragraph', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);
      let node = range.startContainer;

      // Find the paragraph
      while (node && node.nodeName !== 'P' && node !== editor) {
        node = node.parentNode;
      }

      if (!node || node === editor) {
        showToast('Place cursor in a paragraph', 'warning');
        return;
      }

      const text = node.textContent;
      if (text.length < 2) return;

      const firstChar = text.charAt(0);
      const restText = text.slice(1);

      node.innerHTML = `<span class="drop-cap" style="float: left; font-size: 3.5em; line-height: 0.8; padding-right: 8px; padding-top: 4px; font-weight: bold; color: #1a73e8;">${firstChar}</span>${restText}`;

      showToast('Drop cap added', 'success');
    }

    // ==================== ENHANCED STATS ====================
    function updateStats() {
      const text = editor.innerText || '';
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const chars = text.length;
      const paras = (editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li').length) || 1;
      const readingTime = Math.ceil(words / 200); // Average 200 words per minute

      document.getElementById('wordCount').textContent = words;
      document.getElementById('charCount').textContent = chars;
      document.getElementById('paraCount').textContent = paras;
      document.getElementById('readingTime').textContent = readingTime;
    }

    // Initialize outline on load
    setTimeout(refreshOutline, 500);

    // ==================== DOCUMENT COMPARISON ====================
    let lastDiffResult = null;

    function showCompareDocuments() {
      // Populate saved documents in dropdown
      const docs = getSavedDocuments();
      const revisedSelect = document.getElementById('compareRevised');
      const originalSelect = document.getElementById('compareOriginal');

      // Reset
      revisedSelect.innerHTML = '<option value="">Select a document...</option>';
      originalSelect.innerHTML = '<option value="current">Current Document</option>';

      Object.entries(docs).forEach(([id, doc]) => {
        revisedSelect.innerHTML += `<option value="${id}">${doc.name}</option>`;
        originalSelect.innerHTML += `<option value="${id}">${doc.name}</option>`;
      });

      document.getElementById('compareResults').style.display = 'none';
      document.getElementById('applyDiffBtn').style.display = 'none';
      document.getElementById('compareText').value = '';
      document.getElementById('compareModal').classList.add('active');
    }

    function hideCompareDocuments() {
      document.getElementById('compareModal').classList.remove('active');
    }

    function runComparison() {
      const originalSelect = document.getElementById('compareOriginal').value;
      const revisedSelect = document.getElementById('compareRevised').value;
      const pastedText = document.getElementById('compareText').value.trim();

      // Get original text
      let originalText;
      if (originalSelect === 'current') {
        originalText = editor.innerText;
      } else {
        const docs = getSavedDocuments();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = docs[originalSelect].content;
        originalText = tempDiv.innerText;
      }

      // Get revised text
      let revisedText;
      if (pastedText) {
        revisedText = pastedText;
      } else if (revisedSelect) {
        const docs = getSavedDocuments();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = docs[revisedSelect].content;
        revisedText = tempDiv.innerText;
      } else {
        showToast('Please select a document or paste text to compare', 'warning');
        return;
      }

      // Perform diff
      const diff = computeDiff(originalText, revisedText);
      displayDiff(diff);
      lastDiffResult = { original: originalText, revised: revisedText, diff };

      document.getElementById('compareResults').style.display = 'block';
      document.getElementById('applyDiffBtn').style.display = 'inline-block';
    }

    function computeDiff(original, revised) {
      const originalLines = original.split('\n');
      const revisedLines = revised.split('\n');
      const result = [];

      let additions = 0, deletions = 0, modifications = 0;

      // Simple line-by-line diff
      const maxLen = Math.max(originalLines.length, revisedLines.length);

      for (let i = 0; i < maxLen; i++) {
        const origLine = originalLines[i] || '';
        const revLine = revisedLines[i] || '';

        if (origLine === revLine) {
          if (origLine.trim()) {
            result.push({ type: 'same', text: origLine });
          }
        } else if (!origLine.trim() && revLine.trim()) {
          result.push({ type: 'added', text: revLine });
          additions++;
        } else if (origLine.trim() && !revLine.trim()) {
          result.push({ type: 'removed', text: origLine });
          deletions++;
        } else {
          result.push({ type: 'removed', text: origLine });
          result.push({ type: 'added', text: revLine });
          modifications++;
        }
      }

      return { lines: result, stats: { additions, deletions, modifications } };
    }

    function displayDiff(diff) {
      const output = document.getElementById('diffOutput');
      output.innerHTML = '';

      diff.lines.forEach(line => {
        const div = document.createElement('div');
        div.style.padding = '2px 4px';
        div.style.margin = '1px 0';

        if (line.type === 'added') {
          div.style.background = '#d4edda';
          div.textContent = '+ ' + line.text;
        } else if (line.type === 'removed') {
          div.style.background = '#f8d7da';
          div.style.textDecoration = 'line-through';
          div.textContent = '- ' + line.text;
        } else {
          div.textContent = '  ' + line.text;
        }

        output.appendChild(div);
      });

      document.getElementById('diffSummary').textContent =
        `${diff.stats.additions} additions, ${diff.stats.deletions} deletions, ${diff.stats.modifications} modifications`;
    }

    function applyDiffToDocument() {
      if (!lastDiffResult) return;

      if (confirm('Replace current document content with the revised version?')) {
        editor.innerText = lastDiffResult.revised;
        updateStats();
        hideCompareDocuments();
        showToast('Document updated with revised content', 'success');
      }
    }

    // ==================== REVISION HISTORY ====================
    const REVISION_KEY = 'ninjaword_revisions';

    function getRevisions() {
      const revs = localStorage.getItem(REVISION_KEY);
      return revs ? JSON.parse(revs) : [];
    }

    function saveRevisions(revs) {
      // Keep only last 20 revisions
      if (revs.length > 20) revs = revs.slice(-20);
      localStorage.setItem(REVISION_KEY, JSON.stringify(revs));
    }

    function showRevisionHistory() {
      const revisions = getRevisions();
      const list = document.getElementById('revisionList');

      if (revisions.length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); text-align: center; padding: 2rem;">No revisions saved yet.</p>';
      } else {
        list.innerHTML = revisions.map((rev, idx) => `
          <div style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer;"
               onmouseover="this.style.background='var(--light)'" onmouseout="this.style.background='white'">
            <div style="flex: 1;" onclick="previewRevision(${idx})">
              <div style="font-weight: 500;">${rev.name || 'Revision ' + (idx + 1)}</div>
              <div style="font-size: 0.8rem; color: var(--secondary);">
                ${new Date(rev.timestamp).toLocaleString()} - ${rev.wordCount} words
              </div>
            </div>
            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.5rem;"
                    onclick="event.stopPropagation(); restoreRevision(${idx})">Restore</button>
            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                    onclick="event.stopPropagation(); deleteRevision(${idx})">Delete</button>
          </div>
        `).reverse().join('');
      }

      document.getElementById('revisionHistoryModal').classList.add('active');
    }

    function hideRevisionHistory() {
      document.getElementById('revisionHistoryModal').classList.remove('active');
    }

    function saveRevision() {
      const revisions = getRevisions();
      const text = editor.innerText;
      const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;

      revisions.push({
        content: editor.innerHTML,
        timestamp: Date.now(),
        name: document.getElementById('fileName').value,
        wordCount: wordCount
      });

      saveRevisions(revisions);
      showRevisionHistory(); // Refresh
      showToast('Revision saved', 'success');
    }

    function restoreRevision(idx) {
      const revisions = getRevisions();
      if (revisions[idx] && confirm('Restore this revision? Current content will be replaced.')) {
        editor.innerHTML = revisions[idx].content;
        updateStats();
        hideRevisionHistory();
        showToast('Revision restored', 'success');
      }
    }

    function deleteRevision(idx) {
      if (confirm('Delete this revision?')) {
        const revisions = getRevisions();
        revisions.splice(idx, 1);
        saveRevisions(revisions);
        showRevisionHistory(); // Refresh
        showToast('Revision deleted', 'success');
      }
    }

    function previewRevision(idx) {
      const revisions = getRevisions();
      if (revisions[idx]) {
        const preview = window.open('', 'RevisionPreview', 'width=800,height=600');
        preview.document.write(`
          <html>
          <head><title>Revision Preview</title>
          <style>body { font-family: Arial, sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; }</style>
          </head>
          <body>
            <h2>Revision Preview</h2>
            <p style="color: #666;">Saved: ${new Date(revisions[idx].timestamp).toLocaleString()}</p>
            <hr>
            <div>${revisions[idx].content}</div>
          </body>
          </html>
        `);
      }
    }

    // Auto-save revision every 5 minutes
    setInterval(() => {
      if (editor.innerText.trim().length > 50) {
        const revisions = getRevisions();
        const lastRev = revisions[revisions.length - 1];
        // Only save if content changed significantly
        if (!lastRev || editor.innerHTML !== lastRev.content) {
          saveRevision();
        }
      }
    }, 5 * 60 * 1000);

    // ==================== ENDNOTES ====================
    let endnotes = [];

    function showEndnotes() {
      document.getElementById('endnoteText').value = '';
      document.getElementById('endnotesModal').classList.add('active');
    }

    function hideEndnotes() {
      document.getElementById('endnotesModal').classList.remove('active');
    }

    function insertEndnote() {
      const text = document.getElementById('endnoteText').value.trim();
      if (!text) {
        showToast('Please enter endnote text', 'warning');
        return;
      }

      const style = document.getElementById('endnoteNumbering').value;
      endnotes.push(text);
      const num = endnotes.length;

      let marker;
      if (style === 'roman') {
        marker = toRoman(num).toLowerCase();
      } else if (style === 'alpha') {
        marker = String.fromCharCode(96 + num);
      } else {
        marker = num;
      }

      // Insert marker at cursor
      const selection = window.getSelection();
      if (selection.rangeCount) {
        const range = selection.getRangeAt(0);
        const markerSpan = document.createElement('sup');
        markerSpan.className = 'endnote-marker';
        markerSpan.style.cssText = 'color: #1a73e8; cursor: pointer; font-weight: bold;';
        markerSpan.textContent = `[${marker}]`;
        markerSpan.title = text;
        markerSpan.onclick = () => scrollToEndnotes();
        range.insertNode(markerSpan);
      }

      // Update endnotes section at end of document
      updateEndnotesSection();
      hideEndnotes();
      showToast('Endnote inserted', 'success');
    }

    function toRoman(num) {
      const romanNumerals = [
        ['M', 1000], ['CM', 900], ['D', 500], ['CD', 400],
        ['C', 100], ['XC', 90], ['L', 50], ['XL', 40],
        ['X', 10], ['IX', 9], ['V', 5], ['IV', 4], ['I', 1]
      ];
      let result = '';
      for (const [letter, value] of romanNumerals) {
        while (num >= value) {
          result += letter;
          num -= value;
        }
      }
      return result;
    }

    function updateEndnotesSection() {
      // Remove existing endnotes section
      let endnoteSection = editor.querySelector('.endnotes-section');
      if (endnoteSection) endnoteSection.remove();

      if (endnotes.length === 0) return;

      // Create new endnotes section
      const section = document.createElement('div');
      section.className = 'endnotes-section';
      section.id = 'endnotes';
      section.innerHTML = `
        <hr style="margin: 2rem 0 1rem;">
        <h4 style="margin-bottom: 0.5rem;">Endnotes</h4>
        ${endnotes.map((note, idx) => `
          <p style="font-size: 0.9rem; margin: 0.25rem 0;">
            <sup style="color: #1a73e8; font-weight: bold;">[${idx + 1}]</sup> ${note}
          </p>
        `).join('')}
      `;

      editor.appendChild(section);
    }

    function scrollToEndnotes() {
      const section = document.getElementById('endnotes');
      if (section) section.scrollIntoView({ behavior: 'smooth' });
    }

    // ==================== BIBLIOGRAPHY & CITATIONS ====================
    let citations = [];
    let selectedCitationIdx = -1;

    function showBibliography() {
      updateCitationsList();
      document.getElementById('bibliographyModal').classList.add('active');
    }

    function hideBibliography() {
      document.getElementById('bibliographyModal').classList.remove('active');
    }

    function addCitation() {
      const type = document.getElementById('citationType').value;
      const author = document.getElementById('citationAuthor').value.trim();
      const title = document.getElementById('citationTitle').value.trim();
      const year = document.getElementById('citationYear').value.trim();
      const publisher = document.getElementById('citationPublisher').value.trim();

      if (!author || !title) {
        showToast('Author and title are required', 'warning');
        return;
      }

      citations.push({ type, author, title, year, publisher, id: Date.now() });

      // Clear form
      document.getElementById('citationAuthor').value = '';
      document.getElementById('citationTitle').value = '';
      document.getElementById('citationYear').value = '';
      document.getElementById('citationPublisher').value = '';

      updateCitationsList();
      showToast('Citation added', 'success');
    }

    function updateCitationsList() {
      const list = document.getElementById('citationsList');
      if (citations.length === 0) {
        list.innerHTML = '<p style="color: var(--secondary); font-size: 0.9rem;">No citations added yet.</p>';
        return;
      }

      list.innerHTML = citations.map((c, idx) => `
        <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; ${selectedCitationIdx === idx ? 'background: #e3f2fd;' : ''}"
             onclick="selectCitation(${idx})">
          <div style="font-weight: 500; font-size: 0.85rem;">${c.author} (${c.year || 'n.d.'})</div>
          <div style="font-size: 0.8rem; font-style: italic;">${c.title}</div>
          <button class="btn btn-danger" style="padding: 0.15rem 0.4rem; font-size: 0.7rem; margin-top: 0.25rem;"
                  onclick="event.stopPropagation(); removeCitation(${idx})">Remove</button>
        </div>
      `).join('');
    }

    function selectCitation(idx) {
      selectedCitationIdx = idx;
      updateCitationsList();
    }

    function removeCitation(idx) {
      citations.splice(idx, 1);
      selectedCitationIdx = -1;
      updateCitationsList();
      showToast('Citation removed', 'success');
    }

    function formatCitation(citation, style) {
      const { author, title, year, publisher, type } = citation;

      switch (style) {
        case 'apa':
          if (type === 'book') {
            return `${author} (${year || 'n.d.'}). <em>${title}</em>. ${publisher || ''}`.trim();
          } else if (type === 'website') {
            return `${author} (${year || 'n.d.'}). ${title}. Retrieved from ${publisher || ''}`.trim();
          }
          return `${author} (${year || 'n.d.'}). ${title}. ${publisher || ''}`.trim();

        case 'mla':
          return `${author}. "${title}." ${publisher || ''}, ${year || 'n.d.'}.`.trim();

        case 'chicago':
          return `${author}. ${title}. ${publisher || ''}, ${year || 'n.d.'}.`.trim();

        case 'harvard':
          return `${author} (${year || 'n.d.'}) ${title}. ${publisher || ''}.`.trim();

        default:
          return `${author} (${year || 'n.d.'}). ${title}.`;
      }
    }

    function insertCitation() {
      if (selectedCitationIdx < 0) {
        showToast('Please select a citation first', 'warning');
        return;
      }

      const citation = citations[selectedCitationIdx];
      const style = document.getElementById('citationStyle').value;

      // Insert in-text citation
      const selection = window.getSelection();
      if (selection.rangeCount) {
        const range = selection.getRangeAt(0);
        const citationSpan = document.createElement('span');
        citationSpan.className = 'inline-citation';
        citationSpan.style.cssText = 'color: #1a73e8;';

        // Format in-text citation based on style
        if (style === 'apa' || style === 'harvard') {
          citationSpan.textContent = `(${citation.author.split(',')[0]}, ${citation.year || 'n.d.'})`;
        } else if (style === 'mla') {
          citationSpan.textContent = `(${citation.author.split(',')[0]} ${citation.year || ''})`.trim();
        } else {
          citationSpan.textContent = `(${citation.author.split(',')[0]}, ${citation.year || 'n.d.'})`;
        }

        range.insertNode(citationSpan);
        showToast('Citation inserted', 'success');
      }
    }

    function insertBibliography() {
      if (citations.length === 0) {
        showToast('No citations to create bibliography', 'warning');
        return;
      }

      const style = document.getElementById('citationStyle').value;

      // Sort citations alphabetically by author
      const sortedCitations = [...citations].sort((a, b) => a.author.localeCompare(b.author));

      // Create bibliography section
      const bibSection = document.createElement('div');
      bibSection.className = 'bibliography-section';
      bibSection.innerHTML = `
        <hr style="margin: 2rem 0 1rem;">
        <h3 style="margin-bottom: 1rem;">${style === 'mla' ? 'Works Cited' : 'References'}</h3>
        ${sortedCitations.map(c => `
          <p style="margin: 0.5rem 0; padding-left: 2rem; text-indent: -2rem;">
            ${formatCitation(c, style)}
          </p>
        `).join('')}
      `;

      // Remove existing bibliography
      const existing = editor.querySelector('.bibliography-section');
      if (existing) existing.remove();

      editor.appendChild(bibSection);
      hideBibliography();
      showToast('Bibliography inserted', 'success');
    }

    // Add endnote button to Insert toolbar
    document.querySelector('#insertToolbar .toolbar-group:nth-child(2)').innerHTML += `
      <button class="toolbar-btn" onclick="showEndnotes()" title="Insert Endnote">* Endnote</button>
      <button class="toolbar-btn" onclick="showBibliography()" title="Citations & Bibliography">üìö Bibliography</button>
    `;

    // ==========================================
    // Word Art Functions
    // ==========================================
    let selectedSmartArtType = 'list';

    function showWordArt() {
      document.getElementById('wordArtModal').style.display = 'flex';
      updateWordArtPreview();
    }

    function hideWordArt() {
      document.getElementById('wordArtModal').style.display = 'none';
    }

    function updateWordArtPreview() {
      const text = document.getElementById('wordArtText').value || 'Word Art';
      const style = document.getElementById('wordArtStyle').value;
      const font = document.getElementById('wordArtFont').value;
      const size = document.getElementById('wordArtSize').value;
      const color1 = document.getElementById('wordArtColor1').value;
      const color2 = document.getElementById('wordArtColor2').value;
      const transform = document.getElementById('wordArtTransform').value;

      const preview = document.getElementById('wordArtPreview');
      let cssStyles = `font-family: ${font}; font-size: ${size}px; font-weight: bold; `;

      // Apply style effects
      switch (style) {
        case 'gradient':
          cssStyles += `background: linear-gradient(135deg, ${color1}, ${color2}); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;
          break;
        case 'outline':
          cssStyles += `color: transparent; -webkit-text-stroke: 2px ${color1}; text-stroke: 2px ${color1};`;
          break;
        case 'shadow':
          cssStyles += `color: ${color1}; text-shadow: 3px 3px 6px rgba(0,0,0,0.4), 6px 6px 12px rgba(0,0,0,0.2);`;
          break;
        case 'glow':
          cssStyles += `color: ${color1}; text-shadow: 0 0 10px ${color1}, 0 0 20px ${color1}, 0 0 30px ${color2}, 0 0 40px ${color2};`;
          break;
        case 'reflection':
          cssStyles += `color: ${color1};`;
          break;
        case '3d':
          cssStyles += `color: ${color1}; text-shadow: 1px 1px 0px ${color2}, 2px 2px 0px ${color2}, 3px 3px 0px ${color2}, 4px 4px 0px ${color2}, 5px 5px 5px rgba(0,0,0,0.3);`;
          break;
      }

      // Apply transform
      let transformCSS = '';
      switch (transform) {
        case 'arch':
          transformCSS = 'transform: perspective(500px) rotateX(-10deg);';
          break;
        case 'arch-down':
          transformCSS = 'transform: perspective(500px) rotateX(10deg);';
          break;
        case 'wave':
          transformCSS = 'transform: skewY(-5deg);';
          break;
        case 'slant':
          transformCSS = 'transform: skewX(-10deg);';
          break;
        case 'slant-down':
          transformCSS = 'transform: skewX(10deg);';
          break;
      }

      let html = `<span style="${cssStyles} ${transformCSS} display: inline-block;">${text}</span>`;

      // Add reflection effect
      if (style === 'reflection') {
        html = `
          <div style="display: flex; flex-direction: column; align-items: center;">
            <span style="${cssStyles} ${transformCSS} display: inline-block;">${text}</span>
            <span style="${cssStyles} ${transformCSS} display: inline-block; transform: scaleY(-1); opacity: 0.3; filter: blur(1px); margin-top: -10px;">${text}</span>
          </div>
        `;
      }

      preview.innerHTML = html;
    }

    function insertWordArt() {
      const text = document.getElementById('wordArtText').value || 'Word Art';
      const style = document.getElementById('wordArtStyle').value;
      const font = document.getElementById('wordArtFont').value;
      const size = document.getElementById('wordArtSize').value;
      const color1 = document.getElementById('wordArtColor1').value;
      const color2 = document.getElementById('wordArtColor2').value;
      const transform = document.getElementById('wordArtTransform').value;

      let cssStyles = `font-family: ${font}; font-size: ${size}px; font-weight: bold; display: inline-block; `;

      switch (style) {
        case 'gradient':
          cssStyles += `background: linear-gradient(135deg, ${color1}, ${color2}); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;
          break;
        case 'outline':
          cssStyles += `color: transparent; -webkit-text-stroke: 2px ${color1}; text-stroke: 2px ${color1};`;
          break;
        case 'shadow':
          cssStyles += `color: ${color1}; text-shadow: 3px 3px 6px rgba(0,0,0,0.4), 6px 6px 12px rgba(0,0,0,0.2);`;
          break;
        case 'glow':
          cssStyles += `color: ${color1}; text-shadow: 0 0 10px ${color1}, 0 0 20px ${color1}, 0 0 30px ${color2}, 0 0 40px ${color2};`;
          break;
        case 'reflection':
          cssStyles += `color: ${color1};`;
          break;
        case '3d':
          cssStyles += `color: ${color1}; text-shadow: 1px 1px 0px ${color2}, 2px 2px 0px ${color2}, 3px 3px 0px ${color2}, 4px 4px 0px ${color2}, 5px 5px 5px rgba(0,0,0,0.3);`;
          break;
      }

      let transformCSS = '';
      switch (transform) {
        case 'arch':
          transformCSS = 'transform: perspective(500px) rotateX(-10deg);';
          break;
        case 'arch-down':
          transformCSS = 'transform: perspective(500px) rotateX(10deg);';
          break;
        case 'wave':
          transformCSS = 'transform: skewY(-5deg);';
          break;
        case 'slant':
          transformCSS = 'transform: skewX(-10deg);';
          break;
        case 'slant-down':
          transformCSS = 'transform: skewX(10deg);';
          break;
      }

      const wordArtElement = document.createElement('span');
      wordArtElement.className = 'word-art';
      wordArtElement.style.cssText = cssStyles + transformCSS;
      wordArtElement.textContent = text;
      wordArtElement.contentEditable = 'false';

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(wordArtElement);
        range.setStartAfter(wordArtElement);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        editor.appendChild(wordArtElement);
      }

      hideWordArt();
      showToast('Word Art inserted', 'success');
    }

    // ==========================================
    // Equation Editor Functions
    // ==========================================
    function showEquationEditor() {
      document.getElementById('equationModal').style.display = 'flex';
      document.getElementById('equationInput').value = '';
      updateEquationPreview();
    }

    function hideEquationEditor() {
      document.getElementById('equationModal').style.display = 'none';
    }

    function addSymbol(symbol) {
      const input = document.getElementById('equationInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + symbol + text.substring(end);
      input.selectionStart = input.selectionEnd = start + symbol.length;
      input.focus();
      updateEquationPreview();
    }

    function insertEquationTemplate(template) {
      const input = document.getElementById('equationInput');
      let text = '';
      switch (template) {
        case 'fraction': text = 'a/b'; break;
        case 'sqrt': text = '‚àöx'; break;
        case 'power': text = 'x^2'; break;
        case 'subscript': text = 'x_1'; break;
        case 'sum': text = 'Œ£(i=1 to n)'; break;
        case 'integral': text = '‚à´f(x)dx'; break;
        case 'pi': text = 'œÄ'; break;
        case 'theta': text = 'Œ∏'; break;
      }
      input.value += text;
      updateEquationPreview();
    }

    function updateEquationPreview() {
      const input = document.getElementById('equationInput').value;
      const preview = document.getElementById('equationPreview');

      // Parse basic equation formatting
      let html = input
        .replace(/\^(\w+)/g, '<sup>$1</sup>')
        .replace(/\^{([^}]+)}/g, '<sup>$1</sup>')
        .replace(/_(\w+)/g, '<sub>$1</sub>')
        .replace(/_{([^}]+)}/g, '<sub>$1</sub>')
        .replace(/sqrt\(([^)]+)\)/g, '‚àö($1)')
        .replace(/frac\(([^,]+),([^)]+)\)/g, '<span style="display: inline-block; text-align: center; vertical-align: middle;"><span style="display: block; border-bottom: 1px solid black;">$1</span><span style="display: block;">$2</span></span>');

      preview.innerHTML = html || '<span style="color: #999;">Enter an equation...</span>';
    }

    function insertEquation() {
      const input = document.getElementById('equationInput').value;
      if (!input.trim()) {
        showToast('Please enter an equation', 'warning');
        return;
      }

      // Parse and format the equation
      let html = input
        .replace(/\^(\w+)/g, '<sup>$1</sup>')
        .replace(/\^{([^}]+)}/g, '<sup>$1</sup>')
        .replace(/_(\w+)/g, '<sub>$1</sub>')
        .replace(/_{([^}]+)}/g, '<sub>$1</sub>');

      const equationSpan = document.createElement('span');
      equationSpan.className = 'equation';
      equationSpan.style.cssText = 'font-family: "Times New Roman", serif; font-style: italic; padding: 0 0.25rem; background: #f5f5f5; border-radius: 3px;';
      equationSpan.innerHTML = html;

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(equationSpan);
        range.setStartAfter(equationSpan);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        editor.appendChild(equationSpan);
      }

      hideEquationEditor();
      showToast('Equation inserted', 'success');
    }

    // ==========================================
    // Smart Art Functions
    // ==========================================
    function showSmartArt() {
      document.getElementById('smartArtModal').style.display = 'flex';
      selectedSmartArtType = 'list';
      updateSmartArtPreview();
    }

    function hideSmartArt() {
      document.getElementById('smartArtModal').style.display = 'none';
    }

    function selectSmartArtType(type) {
      selectedSmartArtType = type;
      document.querySelectorAll('.smart-art-type').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      updateSmartArtPreview();
    }

    function getSmartArtColors(scheme) {
      const colors = {
        blue: ['#1a73e8', '#4285f4', '#669df6', '#8ab4f8'],
        green: ['#1e8e3e', '#34a853', '#5bb974', '#81c995'],
        orange: ['#e37400', '#f9ab00', '#fcc934', '#fdd663'],
        purple: ['#7b1fa2', '#9c27b0', '#ba68c8', '#ce93d8'],
        rainbow: ['#ea4335', '#f9ab00', '#34a853', '#4285f4']
      };
      return colors[scheme] || colors.blue;
    }

    function updateSmartArtPreview() {
      const items = document.getElementById('smartArtItems').value.split('\n').filter(i => i.trim());
      const colorScheme = document.getElementById('smartArtColor').value;
      const colors = getSmartArtColors(colorScheme);
      const preview = document.getElementById('smartArtPreview');

      if (items.length === 0) {
        preview.innerHTML = '<p style="color: #999; text-align: center;">Enter items to preview</p>';
        return;
      }

      let html = '';

      switch (selectedSmartArtType) {
        case 'list':
          html = `<div style="display: flex; flex-direction: column; gap: 0.5rem;">
            ${items.map((item, i) => `
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 30px; height: 30px; background: ${colors[i % colors.length]}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${i + 1}</div>
                <div style="flex: 1; padding: 0.5rem; background: ${colors[i % colors.length]}22; border-left: 3px solid ${colors[i % colors.length]}; border-radius: 0 4px 4px 0;">${item}</div>
              </div>
            `).join('')}
          </div>`;
          break;

        case 'process':
          html = `<div style="display: flex; align-items: center; gap: 0.25rem; flex-wrap: wrap;">
            ${items.map((item, i) => `
              <div style="padding: 0.75rem 1rem; background: ${colors[i % colors.length]}; color: white; border-radius: 4px; font-weight: 500;">${item}</div>
              ${i < items.length - 1 ? '<div style="font-size: 1.5rem; color: #666;">‚Üí</div>' : ''}
            `).join('')}
          </div>`;
          break;

        case 'cycle':
          const angleStep = 360 / items.length;
          const radius = 60;
          html = `<div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center;">üîÑ</div>
            ${items.map((item, i) => {
              const angle = (angleStep * i - 90) * Math.PI / 180;
              const x = Math.cos(angle) * radius + 90;
              const y = Math.sin(angle) * radius + 90;
              return `<div style="position: absolute; left: ${x - 35}px; top: ${y - 20}px; width: 70px; padding: 0.25rem; background: ${colors[i % colors.length]}; color: white; border-radius: 4px; text-align: center; font-size: 11px;">${item}</div>`;
            }).join('')}
          </div>`;
          break;

        case 'hierarchy':
          html = `<div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            ${items.map((item, i) => `
              <div style="width: ${100 - i * 15}%; padding: 0.5rem; background: ${colors[i % colors.length]}; color: white; border-radius: 4px; text-align: center;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'relationship':
          html = `<div style="display: flex; justify-content: center; align-items: center; gap: 0;">
            ${items.slice(0, 3).map((item, i) => `
              <div style="width: 80px; height: 80px; background: ${colors[i % colors.length]}88; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; margin-left: ${i > 0 ? '-20px' : '0'}; font-size: 12px; text-align: center; padding: 5px;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'pyramid':
          html = `<div style="display: flex; flex-direction: column; align-items: center;">
            ${items.map((item, i) => {
              const width = 40 + (i * 30);
              return `<div style="width: ${width}px; padding: 0.5rem; background: ${colors[i % colors.length]}; color: white; text-align: center; font-size: 11px; ${i === 0 ? 'border-radius: 4px 4px 0 0;' : ''} ${i === items.length - 1 ? 'border-radius: 0 0 4px 4px;' : ''}">${item}</div>`;
            }).join('')}
          </div>`;
          break;
      }

      preview.innerHTML = html;
    }

    function insertSmartArt() {
      const items = document.getElementById('smartArtItems').value.split('\n').filter(i => i.trim());
      const colorScheme = document.getElementById('smartArtColor').value;

      if (items.length === 0) {
        showToast('Please enter at least one item', 'warning');
        return;
      }

      const colors = getSmartArtColors(colorScheme);
      let html = '';

      switch (selectedSmartArtType) {
        case 'list':
          html = `<div class="smart-art smart-art-list" style="margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => `
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="width: 36px; height: 36px; background: ${colors[i % colors.length]}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">${i + 1}</div>
                <div style="flex: 1; padding: 0.75rem; background: ${colors[i % colors.length]}15; border-left: 4px solid ${colors[i % colors.length]}; border-radius: 0 8px 8px 0;">${item}</div>
              </div>
            `).join('')}
          </div>`;
          break;

        case 'process':
          html = `<div class="smart-art smart-art-process" style="margin: 1rem 0; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => `
              <div style="padding: 1rem 1.5rem; background: ${colors[i % colors.length]}; color: white; border-radius: 8px; font-weight: 600;">${item}</div>
              ${i < items.length - 1 ? '<div style="font-size: 2rem; color: #666;">‚Üí</div>' : ''}
            `).join('')}
          </div>`;
          break;

        case 'cycle':
          html = `<div class="smart-art smart-art-cycle" style="margin: 1rem auto; width: 300px; height: 300px; position: relative; border: 1px solid #ddd; border-radius: 8px;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üîÑ</div>
            ${items.map((item, i) => {
              const angleStep = 360 / items.length;
              const angle = (angleStep * i - 90) * Math.PI / 180;
              const radius = 100;
              const x = Math.cos(angle) * radius + 150;
              const y = Math.sin(angle) * radius + 150;
              return `<div style="position: absolute; left: ${x - 50}px; top: ${y - 25}px; width: 100px; padding: 0.5rem; background: ${colors[i % colors.length]}; color: white; border-radius: 8px; text-align: center; font-weight: 500;">${item}</div>`;
            }).join('')}
          </div>`;
          break;

        case 'hierarchy':
          html = `<div class="smart-art smart-art-hierarchy" style="margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => `
              <div style="width: ${100 - i * 12}%; margin: 0 auto 0.5rem; padding: 0.75rem; background: ${colors[i % colors.length]}; color: white; border-radius: 8px; text-align: center; font-weight: 600;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'relationship':
          html = `<div class="smart-art smart-art-relationship" style="margin: 1rem 0; display: flex; justify-content: center; align-items: center; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.slice(0, 4).map((item, i) => `
              <div style="width: 120px; height: 120px; background: ${colors[i % colors.length]}99; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-left: ${i > 0 ? '-30px' : '0'}; text-align: center; padding: 10px;">${item}</div>
            `).join('')}
          </div>`;
          break;

        case 'pyramid':
          html = `<div class="smart-art smart-art-pyramid" style="margin: 1rem auto; width: fit-content; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            ${items.map((item, i) => {
              const width = 80 + (i * 50);
              return `<div style="width: ${width}px; margin: 0 auto; padding: 0.75rem; background: ${colors[i % colors.length]}; color: white; text-align: center; font-weight: 600; ${i === 0 ? 'border-radius: 8px 8px 0 0;' : ''} ${i === items.length - 1 ? 'border-radius: 0 0 8px 8px;' : ''}">${item}</div>`;
            }).join('')}
          </div>`;
          break;
      }

      const smartArtContainer = document.createElement('div');
      smartArtContainer.innerHTML = html;

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(smartArtContainer.firstElementChild);
      } else {
        editor.appendChild(smartArtContainer.firstElementChild);
      }

      hideSmartArt();
      showToast('Smart Art inserted', 'success');
    }

    // ==========================================
    // Cross-Reference Functions
    // ==========================================
    let selectedCrossRef = null;

    function showCrossRef() {
      document.getElementById('crossRefModal').style.display = 'flex';
      updateCrossRefList();
    }

    function hideCrossRef() {
      document.getElementById('crossRefModal').style.display = 'none';
      selectedCrossRef = null;
    }

    function updateCrossRefList() {
      const type = document.getElementById('crossRefType').value;
      const listContainer = document.getElementById('crossRefList');
      let items = [];

      switch (type) {
        case 'heading':
          // Find all headings in the document
          const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
          headings.forEach((h, i) => {
            items.push({
              id: `heading-${i}`,
              text: h.textContent,
              element: h,
              type: h.tagName
            });
          });
          break;

        case 'bookmark':
          // Find all bookmarks
          const bookmarks = editor.querySelectorAll('.bookmark');
          bookmarks.forEach((b, i) => {
            items.push({
              id: b.id || `bookmark-${i}`,
              text: b.dataset.name || b.textContent || 'Unnamed Bookmark',
              element: b,
              type: 'Bookmark'
            });
          });
          break;

        case 'footnote':
          // Find all footnotes
          const footnotes = editor.querySelectorAll('.footnote-ref');
          footnotes.forEach((f, i) => {
            items.push({
              id: `footnote-${i}`,
              text: `Footnote ${i + 1}`,
              element: f,
              type: 'Footnote'
            });
          });
          break;
      }

      if (items.length === 0) {
        listContainer.innerHTML = '<p style="padding: 1rem; color: #999; text-align: center;">No items found</p>';
        return;
      }

      listContainer.innerHTML = items.map(item => `
        <div class="cross-ref-item" onclick="selectCrossRefItem('${item.id}', '${item.text.replace(/'/g, "\\'")}', '${item.type}')"
             style="padding: 0.75rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
             onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
          <span>${item.text}</span>
          <span style="font-size: 0.8rem; color: #666; background: #eee; padding: 0.2rem 0.5rem; border-radius: 4px;">${item.type}</span>
        </div>
      `).join('');
    }

    function selectCrossRefItem(id, text, type) {
      selectedCrossRef = { id, text, type };
      // Highlight selected item
      document.querySelectorAll('.cross-ref-item').forEach(item => {
        item.style.background = 'white';
      });
      event.currentTarget.style.background = '#e3f2fd';
    }

    function insertCrossRef() {
      if (!selectedCrossRef) {
        showToast('Please select a reference', 'warning');
        return;
      }

      const format = document.getElementById('crossRefFormat').value;
      let refText = '';

      switch (format) {
        case 'text':
          refText = selectedCrossRef.text;
          break;
        case 'page':
          refText = 'Page 1'; // In a real implementation, this would calculate the page number
          break;
        case 'above-below':
          refText = 'above'; // In a real implementation, this would calculate position
          break;
      }

      const crossRefSpan = document.createElement('span');
      crossRefSpan.className = 'cross-reference';
      crossRefSpan.style.cssText = 'color: #1a73e8; text-decoration: underline; cursor: pointer;';
      crossRefSpan.dataset.refId = selectedCrossRef.id;
      crossRefSpan.dataset.refType = selectedCrossRef.type;
      crossRefSpan.textContent = refText;
      crossRefSpan.onclick = function() {
        // Navigate to the referenced element
        const targetId = this.dataset.refId;
        const targetType = this.dataset.refType;
        let target;

        if (targetType.startsWith('H')) {
          const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
          const index = parseInt(targetId.replace('heading-', ''));
          target = headings[index];
        } else if (targetType === 'Bookmark') {
          target = editor.querySelector(`#${targetId}`) || editor.querySelector(`.bookmark[data-name="${this.textContent}"]`);
        } else if (targetType === 'Footnote') {
          const footnotes = editor.querySelectorAll('.footnote-ref');
          const index = parseInt(targetId.replace('footnote-', ''));
          target = footnotes[index];
        }

        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          target.style.background = '#ffeb3b';
          setTimeout(() => { target.style.background = ''; }, 2000);
        }
      };

      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(crossRefSpan);
        range.setStartAfter(crossRefSpan);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        editor.appendChild(crossRefSpan);
      }

      hideCrossRef();
      showToast('Cross-reference inserted', 'success');
    }

    // Add Cross-Reference button to Insert toolbar
    const insertToolbarGroups = document.querySelectorAll('#insertToolbar .toolbar-group');
    if (insertToolbarGroups.length >= 2) {
      insertToolbarGroups[1].innerHTML += `<button class="toolbar-btn" onclick="showCrossRef()" title="Cross-Reference">‚Üó Cross-Ref</button>`;
    }

    // ==========================================
    // Styles Gallery Functions
    // ==========================================
    const builtInStyles = {
      normal: { fontSize: '12px', fontWeight: 'normal', fontStyle: 'normal', color: '#000000', fontFamily: 'Arial' },
      heading1: { fontSize: '24px', fontWeight: 'bold', fontStyle: 'normal', color: '#1a73e8', fontFamily: 'Arial', tag: 'h1' },
      heading2: { fontSize: '20px', fontWeight: 'bold', fontStyle: 'normal', color: '#1a73e8', fontFamily: 'Arial', tag: 'h2' },
      heading3: { fontSize: '16px', fontWeight: 'bold', fontStyle: 'normal', color: '#666666', fontFamily: 'Arial', tag: 'h3' },
      title: { fontSize: '32px', fontWeight: '300', fontStyle: 'normal', color: '#000000', fontFamily: 'Arial' },
      subtitle: { fontSize: '16px', fontWeight: 'normal', fontStyle: 'italic', color: '#666666', fontFamily: 'Arial' },
      quote: { fontSize: '14px', fontWeight: 'normal', fontStyle: 'italic', color: '#333333', fontFamily: 'Georgia', borderLeft: '3px solid #1a73e8', paddingLeft: '12px', marginLeft: '20px' },
      code: { fontSize: '12px', fontWeight: 'normal', fontStyle: 'normal', color: '#c7254e', fontFamily: 'Courier New', background: '#f5f5f5', padding: '2px 6px', borderRadius: '3px' },
      emphasis: { fontSize: '12px', fontWeight: 'normal', fontStyle: 'italic', color: '#000000', fontFamily: 'Arial' }
    };

    let customStyles = JSON.parse(localStorage.getItem('ninjaWordCustomStyles') || '{}');

    function applyStyle(styleName) {
      const style = builtInStyles[styleName] || customStyles[styleName];
      if (!style) return;

      const selection = window.getSelection();
      if (selection.rangeCount === 0) return;

      const range = selection.getRangeAt(0);

      // If it's a heading style, wrap in appropriate tag
      if (style.tag) {
        const heading = document.createElement(style.tag);
        heading.style.cssText = `font-size: ${style.fontSize}; font-weight: ${style.fontWeight}; color: ${style.color}; font-family: ${style.fontFamily}; margin: 0.5em 0;`;

        if (range.collapsed) {
          // No selection, create empty heading
          heading.innerHTML = '&nbsp;';
          range.insertNode(heading);
        } else {
          heading.appendChild(range.extractContents());
          range.insertNode(heading);
        }
      } else {
        const span = document.createElement('span');
        let cssText = `font-size: ${style.fontSize}; font-weight: ${style.fontWeight}; font-style: ${style.fontStyle}; color: ${style.color}; font-family: ${style.fontFamily};`;

        if (style.background) cssText += ` background: ${style.background};`;
        if (style.borderLeft) cssText += ` border-left: ${style.borderLeft};`;
        if (style.paddingLeft) cssText += ` padding-left: ${style.paddingLeft};`;
        if (style.marginLeft) cssText += ` margin-left: ${style.marginLeft};`;
        if (style.padding) cssText += ` padding: ${style.padding};`;
        if (style.borderRadius) cssText += ` border-radius: ${style.borderRadius};`;

        span.style.cssText = cssText;

        if (!range.collapsed) {
          span.appendChild(range.extractContents());
          range.insertNode(span);
        }
      }

      updateNavigationPane();
      showToast(`Style '${styleName}' applied`, 'success');
    }

    function showStylesGallery() {
      document.getElementById('stylesGalleryModal').style.display = 'flex';
      renderCustomStyles();
    }

    function hideStylesGallery() {
      document.getElementById('stylesGalleryModal').style.display = 'none';
    }

    function renderCustomStyles() {
      const container = document.getElementById('customStylesList');
      const styleNames = Object.keys(customStyles);

      if (styleNames.length === 0) {
        container.innerHTML = '<p style="color: #666; font-size: 0.9rem;">No custom styles yet. Create one!</p>';
        return;
      }

      container.innerHTML = styleNames.map(name => {
        const style = customStyles[name];
        return `
          <div class="style-preview" onclick="applyStyle('${name}')" style="display: flex; flex-direction: column; align-items: center;">
            <div style="font-size: ${style.fontSize}; font-weight: ${style.fontWeight}; font-style: ${style.fontStyle}; color: ${style.color}; font-family: ${style.fontFamily}; background: ${style.background || 'transparent'};">Aa</div>
            <small>${name}</small>
            <button onclick="event.stopPropagation(); deleteCustomStyle('${name}')" style="font-size: 0.7rem; color: red; border: none; background: none; cursor: pointer;">Delete</button>
          </div>
        `;
      }).join('');
    }

    function showCreateStyle() {
      document.getElementById('createStyleModal').style.display = 'flex';
    }

    function hideCreateStyle() {
      document.getElementById('createStyleModal').style.display = 'none';
    }

    function saveCustomStyle() {
      const name = document.getElementById('customStyleName').value.trim();
      if (!name) {
        showToast('Please enter a style name', 'warning');
        return;
      }

      const style = {
        fontFamily: document.getElementById('customStyleFont').value,
        fontSize: document.getElementById('customStyleSize').value + 'px',
        color: document.getElementById('customStyleColor').value,
        background: document.getElementById('customStyleBg').value,
        fontWeight: document.getElementById('customStyleBold').checked ? 'bold' : 'normal',
        fontStyle: document.getElementById('customStyleItalic').checked ? 'italic' : 'normal',
        textDecoration: document.getElementById('customStyleUnderline').checked ? 'underline' : 'none'
      };

      customStyles[name] = style;
      localStorage.setItem('ninjaWordCustomStyles', JSON.stringify(customStyles));

      hideCreateStyle();
      renderCustomStyles();
      showToast(`Style '${name}' created`, 'success');
    }

    function deleteCustomStyle(name) {
      if (confirm(`Delete style '${name}'?`)) {
        delete customStyles[name];
        localStorage.setItem('ninjaWordCustomStyles', JSON.stringify(customStyles));
        renderCustomStyles();
        showToast('Style deleted', 'success');
      }
    }

    // ==========================================
    // Navigation Pane Functions
    // ==========================================
    let navPaneVisible = false;
    let currentNavTab = 'headings';

    function toggleNavigationPane() {
      navPaneVisible = !navPaneVisible;
      const pane = document.getElementById('navigationPane');
      pane.classList.toggle('visible', navPaneVisible);

      if (navPaneVisible) {
        updateNavigationPane();
      }
    }

    function switchNavTab(tab) {
      currentNavTab = tab;
      document.querySelectorAll('.nav-pane-tab').forEach(t => {
        t.classList.toggle('active', t.textContent.toLowerCase() === tab);
      });
      updateNavigationPane();
    }

    function updateNavigationPane() {
      if (!navPaneVisible) return;

      const content = document.getElementById('navPaneContent');

      switch (currentNavTab) {
        case 'headings':
          const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
          if (headings.length === 0) {
            content.innerHTML = '<p style="padding: 1rem; color: #666; text-align: center;">No headings found.<br>Apply heading styles to see them here.</p>';
          } else {
            content.innerHTML = Array.from(headings).map((h, i) => {
              const level = h.tagName.toLowerCase();
              return `
                <div class="nav-item ${level}" onclick="navigateToElement(${i}, 'heading')">
                  <span style="opacity: 0.5;">${level.toUpperCase()}</span>
                  <span>${h.textContent.substring(0, 30)}${h.textContent.length > 30 ? '...' : ''}</span>
                </div>
              `;
            }).join('');
          }
          break;

        case 'pages':
          // Estimate page count based on content height
          const pageHeight = 11 * 96; // 11 inches at 96 dpi
          const contentHeight = editor.scrollHeight;
          const pageCount = Math.max(1, Math.ceil(contentHeight / pageHeight));

          content.innerHTML = Array.from({ length: pageCount }, (_, i) => `
            <div class="nav-item" onclick="navigateToPage(${i})">
              <span style="background: #e8f0fe; padding: 0.25rem 0.5rem; border-radius: 4px;">üìÑ</span>
              <span>Page ${i + 1}</span>
            </div>
          `).join('');
          break;

        case 'search':
          content.innerHTML = `
            <div style="padding: 0.5rem;">
              <input type="text" id="navSearchInput" placeholder="Search document..."
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                     onkeyup="navSearch(event)">
              <div id="navSearchResults" style="margin-top: 0.5rem;"></div>
            </div>
          `;
          break;
      }
    }

    function navigateToElement(index, type) {
      let elements;
      if (type === 'heading') {
        elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
      }

      if (elements && elements[index]) {
        elements[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
        elements[index].style.background = '#ffeb3b';
        setTimeout(() => { elements[index].style.background = ''; }, 2000);
      }
    }

    function navigateToPage(pageNum) {
      const pageHeight = 11 * 96;
      editor.scrollTop = pageNum * pageHeight;
    }

    function navSearch(event) {
      if (event.key !== 'Enter') return;

      const searchTerm = document.getElementById('navSearchInput').value.trim();
      if (!searchTerm) return;

      const results = document.getElementById('navSearchResults');
      const text = editor.innerText;
      const regex = new RegExp(searchTerm, 'gi');
      const matches = text.match(regex);

      if (!matches || matches.length === 0) {
        results.innerHTML = '<p style="color: #666;">No results found</p>';
        return;
      }

      results.innerHTML = `<p style="font-weight: 600;">${matches.length} result(s) found</p>`;

      // Highlight in document
      highlightSearchTerm(searchTerm);
    }

    function highlightSearchTerm(term) {
      // Clear previous highlights
      const existing = editor.querySelectorAll('.nav-search-highlight');
      existing.forEach(el => {
        const parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
      });

      // Highlight new term
      const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
      const textNodes = [];
      while (walker.nextNode()) textNodes.push(walker.currentNode);

      textNodes.forEach(node => {
        const regex = new RegExp(`(${term})`, 'gi');
        if (regex.test(node.textContent)) {
          const span = document.createElement('span');
          span.innerHTML = node.textContent.replace(regex, '<span class="nav-search-highlight" style="background: #ffeb3b;">$1</span>');
          node.parentNode.replaceChild(span, node);
        }
      });
    }

    // ==========================================
    // Advanced Find & Replace Functions
    // ==========================================
    let advFindMatches = [];
    let advFindCurrentIndex = 0;

    function showAdvancedFind() {
      document.getElementById('advancedFindModal').style.display = 'flex';
      advFindMatches = [];
      advFindCurrentIndex = 0;
    }

    function hideAdvancedFind() {
      document.getElementById('advancedFindModal').style.display = 'none';
      clearAdvFindHighlights();
    }

    function clearAdvFindHighlights() {
      const highlights = editor.querySelectorAll('.adv-find-highlight');
      highlights.forEach(el => {
        const parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
        parent.normalize();
      });
    }

    function buildSearchRegex() {
      const searchTerm = document.getElementById('advFindInput').value;
      if (!searchTerm) return null;

      const matchCase = document.getElementById('advFindCase').checked;
      const wholeWord = document.getElementById('advFindWholeWord').checked;
      const useRegex = document.getElementById('advFindRegex').checked;

      let pattern = searchTerm;

      if (!useRegex) {
        pattern = pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      if (wholeWord) {
        pattern = `\\b${pattern}\\b`;
      }

      const flags = matchCase ? 'g' : 'gi';

      try {
        return new RegExp(pattern, flags);
      } catch (e) {
        showToast('Invalid regular expression', 'error');
        return null;
      }
    }

    function advFindAll() {
      clearAdvFindHighlights();
      advFindMatches = [];
      advFindCurrentIndex = 0;

      const regex = buildSearchRegex();
      if (!regex) return;

      const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
      const textNodes = [];
      while (walker.nextNode()) textNodes.push(walker.currentNode);

      let matchCount = 0;

      textNodes.forEach(node => {
        if (regex.test(node.textContent)) {
          regex.lastIndex = 0; // Reset regex
          const span = document.createElement('span');
          span.innerHTML = node.textContent.replace(regex, (match) => {
            matchCount++;
            advFindMatches.push({ text: match });
            return `<span class="adv-find-highlight" style="background: #ffeb3b;" data-match-index="${matchCount - 1}">${match}</span>`;
          });
          node.parentNode.replaceChild(span, node);
        }
      });

      document.getElementById('advFindResults').innerHTML = matchCount > 0
        ? `<span style="color: #1e8e3e; font-weight: 600;">${matchCount} match(es) found</span>`
        : `<span style="color: #d93025;">No matches found</span>`;

      if (matchCount > 0) {
        advFindCurrentIndex = 0;
        highlightCurrentMatch();
      }
    }

    function highlightCurrentMatch() {
      const highlights = editor.querySelectorAll('.adv-find-highlight');
      highlights.forEach((el, i) => {
        el.style.background = i === advFindCurrentIndex ? '#ff9800' : '#ffeb3b';
        el.style.color = i === advFindCurrentIndex ? 'white' : 'inherit';
      });

      if (highlights[advFindCurrentIndex]) {
        highlights[advFindCurrentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function advFindNext() {
      if (advFindMatches.length === 0) {
        advFindAll();
        return;
      }

      advFindCurrentIndex = (advFindCurrentIndex + 1) % advFindMatches.length;
      highlightCurrentMatch();
    }

    function advReplace() {
      if (advFindMatches.length === 0) {
        advFindAll();
        return;
      }

      const replacement = document.getElementById('advReplaceInput').value;
      const highlight = editor.querySelector(`.adv-find-highlight[data-match-index="${advFindCurrentIndex}"]`);

      if (highlight) {
        highlight.outerHTML = replacement;
        advFindMatches.splice(advFindCurrentIndex, 1);

        // Reindex remaining matches
        const highlights = editor.querySelectorAll('.adv-find-highlight');
        highlights.forEach((el, i) => el.dataset.matchIndex = i);

        if (advFindCurrentIndex >= advFindMatches.length) {
          advFindCurrentIndex = 0;
        }

        document.getElementById('advFindResults').innerHTML =
          `<span style="color: #1e8e3e;">Replaced. ${advFindMatches.length} match(es) remaining</span>`;

        if (advFindMatches.length > 0) {
          highlightCurrentMatch();
        }
      }
    }

    function advReplaceAll() {
      if (advFindMatches.length === 0) {
        advFindAll();
        if (advFindMatches.length === 0) return;
      }

      const replacement = document.getElementById('advReplaceInput').value;
      const count = advFindMatches.length;

      const highlights = editor.querySelectorAll('.adv-find-highlight');
      highlights.forEach(el => {
        el.outerHTML = replacement;
      });

      advFindMatches = [];
      advFindCurrentIndex = 0;

      document.getElementById('advFindResults').innerHTML =
        `<span style="color: #1e8e3e; font-weight: 600;">${count} replacement(s) made</span>`;

      showToast(`${count} replacement(s) made`, 'success');
    }

    // Update navigation pane when editor content changes
    editor.addEventListener('input', () => {
      if (navPaneVisible && currentNavTab === 'headings') {
        updateNavigationPane();
      }
    });

    // Line Numbers
    let lineNumbersVisible = false;

    function toggleLineNumbers() {
      lineNumbersVisible = !lineNumbersVisible;
      const gutter = document.getElementById('lineNumbersGutter');
      const btn = document.getElementById('lineNumBtn');
      const docArea = document.querySelector('.document-area');

      if (lineNumbersVisible) {
        gutter.classList.add('visible');
        btn.classList.add('active');
        docArea.style.paddingLeft = '50px';
        updateLineNumbers();
      } else {
        gutter.classList.remove('visible');
        btn.classList.remove('active');
        docArea.style.paddingLeft = '0';
      }
    }

    function updateLineNumbers() {
      if (!lineNumbersVisible) return;

      const gutter = document.getElementById('lineNumbersGutter');
      const editorRect = editor.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(editor);
      const lineHeight = parseFloat(computedStyle.lineHeight) || 24;
      const paddingTop = parseFloat(computedStyle.paddingTop) || 0;

      // Get all block elements and text lines
      const lines = [];
      let currentY = editorRect.top + paddingTop;

      // Walk through all child elements
      const walkElements = (parent) => {
        for (const child of parent.childNodes) {
          if (child.nodeType === Node.ELEMENT_NODE) {
            const rect = child.getBoundingClientRect();
            if (rect.height > 0 && rect.top >= editorRect.top) {
              // Check if this is a block element
              const display = window.getComputedStyle(child).display;
              if (display === 'block' || display === 'list-item' || child.tagName === 'P' ||
                  child.tagName === 'DIV' || child.tagName === 'H1' || child.tagName === 'H2' ||
                  child.tagName === 'H3' || child.tagName === 'H4' || child.tagName === 'LI') {
                lines.push({
                  top: rect.top - editorRect.top,
                  height: rect.height
                });
              }
            }
            walkElements(child);
          }
        }
      };

      // Get block-level elements
      const blockElements = editor.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li, blockquote, pre');
      const seenTops = new Set();

      blockElements.forEach(el => {
        const rect = el.getBoundingClientRect();
        if (rect.height > 0) {
          const relativeTop = Math.round(rect.top - editorRect.top);
          if (!seenTops.has(relativeTop)) {
            seenTops.add(relativeTop);
            lines.push({
              top: relativeTop,
              height: rect.height
            });
          }
        }
      });

      // Sort by position
      lines.sort((a, b) => a.top - b.top);

      // If no block elements, estimate based on content height
      if (lines.length === 0) {
        const contentHeight = editor.scrollHeight;
        const numLines = Math.ceil(contentHeight / lineHeight);
        for (let i = 0; i < numLines; i++) {
          lines.push({
            top: i * lineHeight,
            height: lineHeight
          });
        }
      }

      // Build line numbers HTML
      let html = '';
      lines.forEach((line, index) => {
        html += `<div style="position: absolute; top: ${line.top + 96}px; right: 8px; height: ${line.height}px; display: flex; align-items: flex-start; padding-top: 2px;">${index + 1}</div>`;
      });

      gutter.innerHTML = html;
      gutter.style.height = editor.scrollHeight + 192 + 'px';
    }

    // Update line numbers on editor changes
    editor.addEventListener('input', updateLineNumbers);
    editor.addEventListener('scroll', () => {
      const gutter = document.getElementById('lineNumbersGutter');
      gutter.scrollTop = editor.scrollTop;
    });

    // Observe editor for resize changes
    if (typeof ResizeObserver !== 'undefined') {
      const lineNumObserver = new ResizeObserver(updateLineNumbers);
      lineNumObserver.observe(editor);
    }

    // Dark Mode
    let darkModeEnabled = localStorage.getItem('ninjaword-darkmode') === 'true';

    function toggleDarkMode() {
      darkModeEnabled = !darkModeEnabled;
      applyDarkMode();
      localStorage.setItem('ninjaword-darkmode', darkModeEnabled);
    }

    function applyDarkMode() {
      const btn = document.getElementById('darkModeBtn');
      if (darkModeEnabled) {
        document.body.classList.add('dark-mode');
        btn.classList.add('active');
        btn.innerHTML = '‚òÄÔ∏è Light Mode';
      } else {
        document.body.classList.remove('dark-mode');
        btn.classList.remove('active');
        btn.innerHTML = 'üåô Dark Mode';
      }
    }

    // Apply saved dark mode preference on load
    if (darkModeEnabled) {
      applyDarkMode();
    }

    // ==================== INDEX FEATURE ====================
    let indexEntries = [];

    function showIndexModal() {
      // Pre-populate with selected text if any
      const selection = window.getSelection();
      if (selection && selection.toString().trim()) {
        document.getElementById('indexMainEntry').value = selection.toString().trim();
      }
      updateIndexEntriesList();
      document.getElementById('indexModal').style.display = 'flex';
    }

    function hideIndexModal() {
      document.getElementById('indexModal').style.display = 'none';
    }

    function showMarkIndexEntry() {
      document.getElementById('markEntrySection').style.display = 'block';
      // Pre-fill with selection
      const selection = window.getSelection();
      if (selection && selection.toString().trim()) {
        document.getElementById('indexMainEntry').value = selection.toString().trim();
      }
    }

    function hideMarkEntry() {
      document.getElementById('markEntrySection').style.display = 'none';
    }

    function showMarkAllEntries() {
      showMarkIndexEntry();
    }

    // Handle radio button changes for index type
    document.addEventListener('change', (e) => {
      if (e.target.name === 'indexType') {
        const crossRefField = document.getElementById('crossRefField');
        crossRefField.style.display = e.target.value === 'crossref' ? 'block' : 'none';
      }
    });

    function markIndexEntry() {
      const mainEntry = document.getElementById('indexMainEntry').value.trim();
      if (!mainEntry) {
        showToast('Please enter a main entry', 'error');
        return;
      }

      const subEntry = document.getElementById('indexSubEntry').value.trim();
      const indexType = document.querySelector('input[name="indexType"]:checked').value;
      const crossRef = document.getElementById('indexCrossRef').value.trim();

      // Get current page (simulated based on position in document)
      const page = getCurrentPage();

      const entry = {
        id: Date.now(),
        main: mainEntry,
        sub: subEntry || null,
        type: indexType,
        crossRef: indexType === 'crossref' ? crossRef : null,
        page: page
      };

      indexEntries.push(entry);

      // Mark the text in the document with a hidden marker
      const selection = window.getSelection();
      if (selection && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const marker = document.createElement('span');
        marker.className = 'index-marker';
        marker.dataset.indexId = entry.id;
        marker.style.borderBottom = '2px dotted #1a73e8';
        marker.title = `Index: ${mainEntry}${subEntry ? ' > ' + subEntry : ''}`;

        try {
          range.surroundContents(marker);
        } catch (e) {
          // Selection spans multiple elements
        }
      }

      updateIndexEntriesList();
      showToast(`Index entry "${mainEntry}" marked`, 'success');

      // Clear inputs for next entry
      document.getElementById('indexMainEntry').value = '';
      document.getElementById('indexSubEntry').value = '';
      document.getElementById('indexCrossRef').value = '';
    }

    function markAllOccurrences() {
      const mainEntry = document.getElementById('indexMainEntry').value.trim();
      if (!mainEntry) {
        showToast('Please enter a main entry', 'error');
        return;
      }

      const editor = document.getElementById('editor');
      const text = editor.innerText;
      const regex = new RegExp(mainEntry.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      let match;
      let count = 0;

      while ((match = regex.exec(text)) !== null) {
        const entry = {
          id: Date.now() + count,
          main: mainEntry,
          sub: document.getElementById('indexSubEntry').value.trim() || null,
          type: 'page',
          crossRef: null,
          page: Math.ceil((match.index / text.length) * 10) || 1 // Estimate page
        };
        indexEntries.push(entry);
        count++;
      }

      if (count > 0) {
        updateIndexEntriesList();
        showToast(`Marked ${count} occurrences of "${mainEntry}"`, 'success');
      } else {
        showToast(`No occurrences of "${mainEntry}" found`, 'error');
      }
    }

    function getCurrentPage() {
      // Estimate current page based on scroll position
      const editor = document.getElementById('editor');
      const scrollTop = editor.scrollTop;
      const pageHeight = 1056; // ~11 inches at 96dpi
      return Math.max(1, Math.ceil((scrollTop + 1) / pageHeight));
    }

    function updateIndexEntriesList() {
      const list = document.getElementById('indexEntriesList');
      const count = document.getElementById('indexEntryCount');
      count.textContent = indexEntries.length;

      if (indexEntries.length === 0) {
        list.innerHTML = '<div style="color: #999; font-style: italic;">No index entries marked yet</div>';
        return;
      }

      // Group by main entry
      const grouped = {};
      indexEntries.forEach(entry => {
        if (!grouped[entry.main]) {
          grouped[entry.main] = [];
        }
        grouped[entry.main].push(entry);
      });

      let html = '';
      Object.keys(grouped).sort().forEach(main => {
        const entries = grouped[main];
        const pages = [...new Set(entries.map(e => e.page))].sort((a, b) => a - b);

        html += `<div style="padding: 0.25rem 0; display: flex; justify-content: space-between; border-bottom: 1px solid #eee;">
          <span><strong>${main}</strong>${entries[0].sub ? ' > ' + entries[0].sub : ''}</span>
          <span style="color: #666;">${entries[0].type === 'crossref' ? 'See ' + entries[0].crossRef : 'p. ' + pages.join(', ')}</span>
          <button onclick="removeIndexEntry('${main}')" style="border: none; background: none; color: #d93025; cursor: pointer;">√ó</button>
        </div>`;
      });

      list.innerHTML = html;
    }

    function removeIndexEntry(main) {
      indexEntries = indexEntries.filter(e => e.main !== main);

      // Remove markers from document
      document.querySelectorAll('.index-marker').forEach(marker => {
        if (indexEntries.every(e => e.id != marker.dataset.indexId)) {
          const parent = marker.parentNode;
          while (marker.firstChild) {
            parent.insertBefore(marker.firstChild, marker);
          }
          parent.removeChild(marker);
        }
      });

      updateIndexEntriesList();
      showToast('Index entry removed', 'info');
    }

    function clearAllIndexEntries() {
      if (indexEntries.length === 0) return;

      if (confirm('Clear all index entries?')) {
        indexEntries = [];

        // Remove all markers
        document.querySelectorAll('.index-marker').forEach(marker => {
          const parent = marker.parentNode;
          while (marker.firstChild) {
            parent.insertBefore(marker.firstChild, marker);
          }
          parent.removeChild(marker);
        });

        updateIndexEntriesList();
        showToast('All index entries cleared', 'info');
      }
    }

    function insertIndex() {
      if (indexEntries.length === 0) {
        showToast('No index entries to generate', 'error');
        return;
      }

      const format = document.getElementById('indexFormat').value;
      const columns = parseInt(document.getElementById('indexColumns').value);

      // Group and sort entries
      const grouped = {};
      indexEntries.forEach(entry => {
        const key = entry.main.toLowerCase();
        if (!grouped[key]) {
          grouped[key] = { main: entry.main, subs: {}, pages: new Set(), crossRef: null };
        }
        if (entry.type === 'crossref') {
          grouped[key].crossRef = entry.crossRef;
        } else {
          grouped[key].pages.add(entry.page);
        }
        if (entry.sub) {
          if (!grouped[key].subs[entry.sub]) {
            grouped[key].subs[entry.sub] = new Set();
          }
          grouped[key].subs[entry.sub].add(entry.page);
        }
      });

      // Generate index HTML
      let indexHTML = `<div class="document-index" style="margin: 2rem 0; page-break-before: always;">
        <h2 style="text-align: center; margin-bottom: 1rem; border-bottom: 2px solid #333; padding-bottom: 0.5rem;">INDEX</h2>
        <div style="column-count: ${columns}; column-gap: 2rem;">`;

      // Group by first letter
      const byLetter = {};
      Object.values(grouped).forEach(entry => {
        const letter = entry.main[0].toUpperCase();
        if (!byLetter[letter]) byLetter[letter] = [];
        byLetter[letter].push(entry);
      });

      Object.keys(byLetter).sort().forEach(letter => {
        indexHTML += `<div style="margin-bottom: 0.5rem;"><strong style="font-size: 1.1em;">${letter}</strong></div>`;

        byLetter[letter].sort((a, b) => a.main.localeCompare(b.main)).forEach(entry => {
          const pages = [...entry.pages].sort((a, b) => a - b).join(', ');
          const pageRef = entry.crossRef ? `<em>See ${entry.crossRef}</em>` : pages;

          if (format === 'indented') {
            indexHTML += `<div style="margin-left: 1rem; margin-bottom: 0.25rem;">
              ${entry.main}${Object.keys(entry.subs).length === 0 ? ', ' + pageRef : ''}
            </div>`;

            // Subentries
            Object.entries(entry.subs).forEach(([sub, subPages]) => {
              const subPageRef = [...subPages].sort((a, b) => a - b).join(', ');
              indexHTML += `<div style="margin-left: 2rem; margin-bottom: 0.25rem;">${sub}, ${subPageRef}</div>`;
            });
          } else {
            // Run-in format
            let subText = Object.entries(entry.subs).map(([sub, subPages]) => {
              return `${sub}, ${[...subPages].sort((a, b) => a - b).join(', ')}`;
            }).join('; ');

            indexHTML += `<div style="margin-left: 1rem; margin-bottom: 0.25rem;">
              ${entry.main}, ${pageRef}${subText ? '; ' + subText : ''}
            </div>`;
          }
        });
      });

      indexHTML += '</div></div>';

      // Insert at cursor or end
      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection && selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        const range = selection.getRangeAt(0);
        const div = document.createElement('div');
        div.innerHTML = indexHTML;
        range.insertNode(div.firstChild);
      } else {
        editor.innerHTML += indexHTML;
      }

      hideIndexModal();
      showToast('Index inserted', 'success');
    }

    function updateIndex() {
      // Remove existing index and regenerate
      const existingIndex = document.querySelector('.document-index');
      if (existingIndex) {
        existingIndex.remove();
      }
      insertIndex();
    }

    // ==================== OUTLINE VIEW ====================
    let outlineVisible = false;
    let selectedOutlineItem = null;
    let outlineShowLevel = 'all';

    function toggleOutlineView() {
      outlineVisible = !outlineVisible;
      const panel = document.getElementById('outlinePanel');
      const btn = document.getElementById('outlineViewBtn');
      const docArea = document.querySelector('.document-area');

      if (outlineVisible) {
        panel.classList.add('visible');
        btn.classList.add('active');
        docArea.style.marginLeft = '330px';
        updateOutlineView();
      } else {
        panel.classList.remove('visible');
        btn.classList.remove('active');
        docArea.style.marginLeft = navPaneVisible ? '260px' : '0';
      }
    }

    function updateOutlineView() {
      if (!outlineVisible) return;

      const editor = document.getElementById('editor');
      const content = document.getElementById('outlineContent');

      // Get all headings and paragraphs
      const elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div');
      let html = '';
      let itemIndex = 0;

      elements.forEach(el => {
        const tagName = el.tagName.toLowerCase();
        let level = 0;
        let levelClass = 'body-text';
        let levelLabel = 'Body';

        if (tagName === 'h1') { level = 1; levelClass = 'h1'; levelLabel = 'H1'; }
        else if (tagName === 'h2') { level = 2; levelClass = 'h2'; levelLabel = 'H2'; }
        else if (tagName === 'h3') { level = 3; levelClass = 'h3'; levelLabel = 'H3'; }
        else if (tagName === 'h4') { level = 4; levelClass = 'h4'; levelLabel = 'H4'; }
        else if (tagName === 'h5' || tagName === 'h6') { level = 5; levelClass = 'h4'; levelLabel = 'H5+'; }
        else { level = 6; } // Body text

        // Filter by show level
        if (outlineShowLevel !== 'all') {
          const maxLevel = parseInt(outlineShowLevel);
          if (level > maxLevel && level < 6) return;
          if (level === 6 && maxLevel < 4) return; // Hide body text at high filter levels
        }

        const text = el.textContent.trim();
        if (!text || text.length < 2) return;

        const displayText = text.length > 60 ? text.substring(0, 60) + '...' : text;
        const hasChildren = level < 6 && level > 0;

        html += `
          <div class="outline-item ${levelClass}"
               data-index="${itemIndex}"
               data-level="${level}"
               data-element-id="${el.id || ''}"
               onclick="selectOutlineItem(this, event)"
               ondblclick="navigateToOutlineItem(this)"
               draggable="true"
               ondragstart="outlineDragStart(event)"
               ondragover="outlineDragOver(event)"
               ondrop="outlineDrop(event)">
            <span class="collapse-btn" onclick="toggleOutlineCollapse(this, event)">${hasChildren ? '‚ñº' : ''}</span>
            <span class="level-indicator">${levelLabel}</span>
            <span class="text" title="${text}">${displayText}</span>
          </div>
        `;
        itemIndex++;
      });

      if (!html) {
        html = '<div style="padding: 1rem; color: #666; font-style: italic;">No outline structure found. Add headings to your document to see the outline.</div>';
      }

      content.innerHTML = html;
    }

    function selectOutlineItem(item, event) {
      event.stopPropagation();

      // Deselect previous
      document.querySelectorAll('.outline-item.selected').forEach(el => el.classList.remove('selected'));

      // Select new
      item.classList.add('selected');
      selectedOutlineItem = item;
    }

    function navigateToOutlineItem(item) {
      const index = parseInt(item.dataset.index);
      const editor = document.getElementById('editor');
      const elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div');

      let targetIndex = 0;
      let targetElement = null;

      elements.forEach(el => {
        const text = el.textContent.trim();
        if (!text || text.length < 2) return;

        if (targetIndex === index) {
          targetElement = el;
        }
        targetIndex++;
      });

      if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Highlight briefly
        targetElement.style.background = '#fff3cd';
        setTimeout(() => { targetElement.style.background = ''; }, 1500);
      }
    }

    function toggleOutlineCollapse(btn, event) {
      event.stopPropagation();
      const item = btn.closest('.outline-item');
      item.classList.toggle('collapsed');
      btn.textContent = item.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    function promoteOutlineLevel() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      const index = parseInt(selectedOutlineItem.dataset.index);
      const level = parseInt(selectedOutlineItem.dataset.level);

      if (level <= 1) {
        showToast('Cannot promote further', 'error');
        return;
      }

      changeOutlineElementLevel(index, level - 1);
    }

    function demoteOutlineLevel() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      const index = parseInt(selectedOutlineItem.dataset.index);
      const level = parseInt(selectedOutlineItem.dataset.level);

      if (level >= 5) {
        showToast('Cannot demote further', 'error');
        return;
      }

      changeOutlineElementLevel(index, level + 1);
    }

    function changeOutlineElementLevel(index, newLevel) {
      const editor = document.getElementById('editor');
      const elements = editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div');

      let targetIndex = 0;
      elements.forEach(el => {
        const text = el.textContent.trim();
        if (!text || text.length < 2) return;

        if (targetIndex === index) {
          const newTag = newLevel <= 4 ? `h${newLevel}` : 'p';
          const newEl = document.createElement(newTag);
          newEl.innerHTML = el.innerHTML;

          // Copy any styles
          newEl.style.cssText = el.style.cssText;

          el.parentNode.replaceChild(newEl, el);
          showToast(`Changed to ${newTag.toUpperCase()}`, 'success');
        }
        targetIndex++;
      });

      updateOutlineView();
    }

    function moveOutlineUp() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      moveOutlineElement(-1);
    }

    function moveOutlineDown() {
      if (!selectedOutlineItem) {
        showToast('Select an outline item first', 'error');
        return;
      }

      moveOutlineElement(1);
    }

    function moveOutlineElement(direction) {
      const index = parseInt(selectedOutlineItem.dataset.index);
      const editor = document.getElementById('editor');
      const elements = Array.from(editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div')).filter(el => {
        const text = el.textContent.trim();
        return text && text.length >= 2;
      });

      if (index + direction < 0 || index + direction >= elements.length) {
        showToast('Cannot move further', 'error');
        return;
      }

      const el = elements[index];
      const targetEl = elements[index + direction];

      if (direction < 0) {
        targetEl.parentNode.insertBefore(el, targetEl);
      } else {
        targetEl.parentNode.insertBefore(el, targetEl.nextSibling);
      }

      showToast('Moved', 'success');
      updateOutlineView();
    }

    function filterOutlineLevel(level) {
      outlineShowLevel = level;
      updateOutlineView();
    }

    function expandAllOutline() {
      document.querySelectorAll('.outline-item.collapsed').forEach(item => {
        item.classList.remove('collapsed');
        const btn = item.querySelector('.collapse-btn');
        if (btn && btn.textContent) btn.textContent = '‚ñº';
      });
    }

    function collapseAllOutline() {
      document.querySelectorAll('.outline-item').forEach(item => {
        const level = parseInt(item.dataset.level);
        if (level > 0 && level < 6) {
          item.classList.add('collapsed');
          const btn = item.querySelector('.collapse-btn');
          if (btn && btn.textContent) btn.textContent = '‚ñ∂';
        }
      });
    }

    // Drag and drop for outline reorganization
    let draggedOutlineItem = null;

    function outlineDragStart(event) {
      draggedOutlineItem = event.target.closest('.outline-item');
      draggedOutlineItem.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
    }

    function outlineDragOver(event) {
      event.preventDefault();
      const target = event.target.closest('.outline-item');
      if (target && target !== draggedOutlineItem) {
        target.style.borderTop = '2px solid #1a73e8';
      }
    }

    function outlineDrop(event) {
      event.preventDefault();
      const target = event.target.closest('.outline-item');

      if (target && draggedOutlineItem && target !== draggedOutlineItem) {
        const dragIndex = parseInt(draggedOutlineItem.dataset.index);
        const targetIndex = parseInt(target.dataset.index);

        // Move in actual document
        const editor = document.getElementById('editor');
        const elements = Array.from(editor.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div')).filter(el => {
          const text = el.textContent.trim();
          return text && text.length >= 2;
        });

        if (elements[dragIndex] && elements[targetIndex]) {
          elements[targetIndex].parentNode.insertBefore(elements[dragIndex], elements[targetIndex]);
          showToast('Reorganized', 'success');
        }
      }

      // Clean up
      document.querySelectorAll('.outline-item').forEach(item => {
        item.classList.remove('dragging');
        item.style.borderTop = '';
      });
      draggedOutlineItem = null;

      updateOutlineView();
    }

    // Update outline when editor changes
    const outlineObserver = new MutationObserver(() => {
      if (outlineVisible) {
        updateOutlineView();
      }
    });

    outlineObserver.observe(document.getElementById('editor'), {
      childList: true,
      subtree: true,
      characterData: true
    });

    // ==================== FOCUS MODE ====================
    let focusModeActive = false;
    let focusWidth = 700;

    function toggleFocusMode() {
      focusModeActive = !focusModeActive;
      const btn = document.getElementById('focusModeBtn');

      if (focusModeActive) {
        document.body.classList.add('focus-mode');
        btn.classList.add('active');
        document.documentElement.style.setProperty('--focus-width', focusWidth + 'px');
        showToast('Focus Mode enabled. Press Esc to exit.', 'info');

        // Add Esc key listener
        document.addEventListener('keydown', focusModeEscHandler);
      } else {
        document.body.classList.remove('focus-mode');
        btn.classList.remove('active');
        document.removeEventListener('keydown', focusModeEscHandler);
      }
    }

    function focusModeEscHandler(e) {
      if (e.key === 'Escape' && focusModeActive) {
        toggleFocusMode();
      }
    }

    function adjustFocusWidth(delta) {
      focusWidth = Math.max(400, Math.min(1000, focusWidth + delta));
      document.querySelector('.document-page').style.maxWidth = focusWidth + 'px';
    }

    function toggleFocusDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    // ==================== READ ALOUD (Text-to-Speech) ====================
    let readAloudActive = false;
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;

    function toggleReadAloud() {
      if (readAloudActive) {
        stopReadAloud();
      } else {
        startReadAloud();
      }
    }

    function startReadAloud() {
      const editor = document.getElementById('editor');
      let text = '';

      // Get selected text or full document
      const selection = window.getSelection();
      if (selection && selection.toString().trim()) {
        text = selection.toString();
      } else {
        text = editor.innerText;
      }

      if (!text.trim()) {
        showToast('No text to read', 'error');
        return;
      }

      if (!speechSynthesis) {
        showToast('Text-to-speech not supported in this browser', 'error');
        return;
      }

      readAloudActive = true;
      const btn = document.getElementById('readAloudBtn');
      btn.classList.add('active');
      btn.innerHTML = '‚èπ Stop';

      // Split into sentences for better highlighting
      const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
      let sentenceIndex = 0;

      function speakNextSentence() {
        if (sentenceIndex >= sentences.length || !readAloudActive) {
          stopReadAloud();
          return;
        }

        const sentence = sentences[sentenceIndex].trim();
        currentUtterance = new SpeechSynthesisUtterance(sentence);

        // Configure voice
        currentUtterance.rate = 0.9;
        currentUtterance.pitch = 1;

        // Try to use a good voice
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Google')) ||
                               voices.find(v => v.lang.startsWith('en'));
        if (preferredVoice) {
          currentUtterance.voice = preferredVoice;
        }

        currentUtterance.onend = () => {
          sentenceIndex++;
          speakNextSentence();
        };

        currentUtterance.onerror = () => {
          sentenceIndex++;
          speakNextSentence();
        };

        speechSynthesis.speak(currentUtterance);
      }

      // Start speaking
      speakNextSentence();
      showToast('Reading aloud...', 'info');
    }

    function stopReadAloud() {
      readAloudActive = false;
      if (speechSynthesis) {
        speechSynthesis.cancel();
      }
      currentUtterance = null;

      const btn = document.getElementById('readAloudBtn');
      btn.classList.remove('active');
      btn.innerHTML = 'üîä Read';

      // Remove any highlights
      document.querySelectorAll('.read-aloud-highlight').forEach(el => {
        el.outerHTML = el.innerHTML;
      });
    }

    // Load voices (needed for some browsers)
    if (speechSynthesis) {
      speechSynthesis.onvoiceschanged = () => {
        speechSynthesis.getVoices();
      };
    }

    // ========== Keyboard Shortcuts ==========
    function showKeyboardShortcuts() {
      document.getElementById('shortcutsModal').style.display = 'flex';
    }

    function hideKeyboardShortcuts() {
      document.getElementById('shortcutsModal').style.display = 'none';
    }

    // F1 key to show shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardShortcuts();
      }
    });

    // Click outside modal to close
    document.getElementById('shortcutsModal').addEventListener('click', (e) => {
      if (e.target.id === 'shortcutsModal') {
        hideKeyboardShortcuts();
      }
    });

    // ========== Word Count ==========
    function showWordCount() {
      const editor = document.getElementById('editor');
      const text = editor.innerText || '';
      const selection = window.getSelection();
      const selectedText = selection.toString();

      // Calculate statistics
      const stats = calculateTextStats(text);

      // Update modal
      document.getElementById('wcPages').textContent = stats.pages;
      document.getElementById('wcWords').textContent = stats.words.toLocaleString();
      document.getElementById('wcCharsNoSpaces').textContent = stats.charsNoSpaces.toLocaleString();
      document.getElementById('wcCharsWithSpaces').textContent = stats.charsWithSpaces.toLocaleString();
      document.getElementById('wcParagraphs').textContent = stats.paragraphs.toLocaleString();
      document.getElementById('wcLines').textContent = stats.lines.toLocaleString();
      document.getElementById('wcReadTime').textContent = stats.readTime;

      // Selection info
      if (selectedText.length > 0) {
        const selStats = calculateTextStats(selectedText);
        document.getElementById('wcSelectionInfo').textContent =
          `${selStats.words} words, ${selStats.charsWithSpaces} characters selected`;
      } else {
        document.getElementById('wcSelectionInfo').textContent = 'No text selected';
      }

      document.getElementById('wordCountModal').style.display = 'flex';
    }

    function hideWordCount() {
      document.getElementById('wordCountModal').style.display = 'none';
    }

    // ========== Thesaurus ==========
    const thesaurusData = {
      // Common words with synonyms and antonyms
      'good': { synonyms: ['excellent', 'great', 'fine', 'wonderful', 'superb', 'outstanding', 'terrific', 'fantastic'], antonyms: ['bad', 'poor', 'terrible', 'awful'] },
      'bad': { synonyms: ['poor', 'terrible', 'awful', 'dreadful', 'horrible', 'inferior', 'substandard'], antonyms: ['good', 'excellent', 'great', 'wonderful'] },
      'big': { synonyms: ['large', 'huge', 'enormous', 'massive', 'vast', 'immense', 'gigantic', 'substantial'], antonyms: ['small', 'tiny', 'little', 'miniature'] },
      'small': { synonyms: ['tiny', 'little', 'miniature', 'compact', 'petite', 'minute', 'diminutive'], antonyms: ['big', 'large', 'huge', 'enormous'] },
      'fast': { synonyms: ['quick', 'rapid', 'swift', 'speedy', 'hasty', 'brisk', 'prompt'], antonyms: ['slow', 'sluggish', 'leisurely'] },
      'slow': { synonyms: ['sluggish', 'leisurely', 'unhurried', 'gradual', 'deliberate', 'measured'], antonyms: ['fast', 'quick', 'rapid', 'swift'] },
      'happy': { synonyms: ['joyful', 'cheerful', 'delighted', 'pleased', 'content', 'elated', 'thrilled', 'ecstatic'], antonyms: ['sad', 'unhappy', 'miserable', 'depressed'] },
      'sad': { synonyms: ['unhappy', 'sorrowful', 'melancholy', 'dejected', 'depressed', 'gloomy', 'dismal'], antonyms: ['happy', 'joyful', 'cheerful', 'elated'] },
      'important': { synonyms: ['significant', 'crucial', 'essential', 'vital', 'critical', 'key', 'major', 'paramount'], antonyms: ['unimportant', 'trivial', 'minor', 'insignificant'] },
      'easy': { synonyms: ['simple', 'effortless', 'straightforward', 'uncomplicated', 'painless'], antonyms: ['difficult', 'hard', 'challenging', 'complex'] },
      'difficult': { synonyms: ['hard', 'challenging', 'tough', 'demanding', 'arduous', 'complex', 'complicated'], antonyms: ['easy', 'simple', 'effortless'] },
      'beautiful': { synonyms: ['gorgeous', 'stunning', 'lovely', 'attractive', 'pretty', 'exquisite', 'elegant'], antonyms: ['ugly', 'unattractive', 'hideous'] },
      'interesting': { synonyms: ['fascinating', 'engaging', 'captivating', 'intriguing', 'compelling', 'absorbing'], antonyms: ['boring', 'dull', 'tedious', 'uninteresting'] },
      'new': { synonyms: ['fresh', 'modern', 'novel', 'recent', 'latest', 'contemporary', 'innovative'], antonyms: ['old', 'ancient', 'outdated', 'obsolete'] },
      'old': { synonyms: ['ancient', 'aged', 'elderly', 'vintage', 'antique', 'mature'], antonyms: ['new', 'young', 'modern', 'fresh'] },
      'strong': { synonyms: ['powerful', 'mighty', 'sturdy', 'robust', 'tough', 'forceful', 'potent'], antonyms: ['weak', 'feeble', 'fragile'] },
      'weak': { synonyms: ['feeble', 'frail', 'fragile', 'delicate', 'powerless', 'faint'], antonyms: ['strong', 'powerful', 'robust'] },
      'smart': { synonyms: ['intelligent', 'clever', 'brilliant', 'bright', 'wise', 'sharp', 'astute'], antonyms: ['stupid', 'foolish', 'dumb'] },
      'nice': { synonyms: ['pleasant', 'agreeable', 'lovely', 'delightful', 'enjoyable', 'wonderful'], antonyms: ['unpleasant', 'nasty', 'horrible'] },
      'start': { synonyms: ['begin', 'commence', 'initiate', 'launch', 'embark', 'inaugurate'], antonyms: ['end', 'finish', 'stop', 'conclude'] },
      'end': { synonyms: ['finish', 'conclude', 'complete', 'terminate', 'cease', 'stop'], antonyms: ['start', 'begin', 'commence'] },
      'help': { synonyms: ['assist', 'aid', 'support', 'facilitate', 'contribute', 'serve'], antonyms: ['hinder', 'obstruct', 'impede'] },
      'work': { synonyms: ['labor', 'toil', 'effort', 'job', 'task', 'employment', 'occupation'], antonyms: ['play', 'leisure', 'rest'] },
      'make': { synonyms: ['create', 'produce', 'construct', 'build', 'form', 'manufacture', 'generate'], antonyms: ['destroy', 'demolish', 'dismantle'] },
      'give': { synonyms: ['provide', 'offer', 'present', 'donate', 'grant', 'bestow', 'contribute'], antonyms: ['take', 'receive', 'withhold'] },
      'get': { synonyms: ['obtain', 'acquire', 'receive', 'gain', 'secure', 'procure', 'attain'], antonyms: ['give', 'lose', 'forfeit'] },
      'say': { synonyms: ['state', 'declare', 'express', 'mention', 'remark', 'articulate', 'utter'], antonyms: [] },
      'think': { synonyms: ['believe', 'consider', 'ponder', 'contemplate', 'reflect', 'reason', 'suppose'], antonyms: [] },
      'look': { synonyms: ['see', 'view', 'observe', 'watch', 'gaze', 'glance', 'examine', 'inspect'], antonyms: ['ignore', 'overlook'] },
      'change': { synonyms: ['alter', 'modify', 'transform', 'adjust', 'revise', 'convert', 'vary'], antonyms: ['maintain', 'preserve', 'keep'] },
      'move': { synonyms: ['shift', 'transfer', 'relocate', 'transport', 'proceed', 'advance'], antonyms: ['stay', 'remain', 'stop'] },
      'try': { synonyms: ['attempt', 'endeavor', 'strive', 'seek', 'aim', 'venture'], antonyms: ['abandon', 'quit', 'give up'] },
      'use': { synonyms: ['utilize', 'employ', 'apply', 'operate', 'exercise', 'implement'], antonyms: ['discard', 'ignore', 'neglect'] }
    };

    function showThesaurus() {
      // Get selected text if any
      const selection = window.getSelection();
      const selectedText = selection.toString().trim().toLowerCase();
      if (selectedText && selectedText.split(/\s+/).length === 1) {
        document.getElementById('thesaurusWord').value = selectedText;
        lookupThesaurus();
      } else {
        document.getElementById('thesaurusWord').value = '';
        document.getElementById('thesaurusResults').innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">Select a word in your document or type a word above to find synonyms and antonyms.</p>';
      }
      document.getElementById('thesaurusModal').classList.add('active');
      document.getElementById('thesaurusWord').focus();
    }

    function hideThesaurus() {
      document.getElementById('thesaurusModal').classList.remove('active');
    }

    function lookupThesaurus() {
      const word = document.getElementById('thesaurusWord').value.trim().toLowerCase();
      const resultsDiv = document.getElementById('thesaurusResults');

      if (!word) {
        resultsDiv.innerHTML = '<p style="color: #d93025; text-align: center;">Please enter a word to look up.</p>';
        return;
      }

      const entry = thesaurusData[word];

      if (entry) {
        let html = `<div style="padding: 1rem; background: #f5f5f5; border-radius: 8px;">`;
        html += `<h4 style="margin-bottom: 1rem; color: #1a73e8;">"${word}"</h4>`;

        if (entry.synonyms && entry.synonyms.length > 0) {
          html += `<div style="margin-bottom: 1rem;">`;
          html += `<strong style="color: #34a853;">Synonyms:</strong>`;
          html += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">`;
          entry.synonyms.forEach(syn => {
            html += `<span onclick="replaceWithWord('${syn}')" style="background: #e8f5e9; color: #2e7d32; padding: 0.25rem 0.75rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'">${syn}</span>`;
          });
          html += `</div></div>`;
        }

        if (entry.antonyms && entry.antonyms.length > 0) {
          html += `<div>`;
          html += `<strong style="color: #d93025;">Antonyms:</strong>`;
          html += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">`;
          entry.antonyms.forEach(ant => {
            html += `<span onclick="replaceWithWord('${ant}')" style="background: #ffebee; color: #c62828; padding: 0.25rem 0.75rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='#ffcdd2'" onmouseout="this.style.background='#ffebee'">${ant}</span>`;
          });
          html += `</div></div>`;
        }

        html += `<p style="font-size: 0.8rem; color: #666; margin-top: 1rem;">Click a word to replace the selected text in your document.</p>`;
        html += `</div>`;
        resultsDiv.innerHTML = html;
      } else {
        // Word not in our dictionary - suggest similar words
        const suggestions = Object.keys(thesaurusData).filter(w => w.startsWith(word.charAt(0))).slice(0, 5);
        let html = `<div style="padding: 1rem; text-align: center;">`;
        html += `<p style="color: #666; margin-bottom: 1rem;">No exact match found for "${word}".</p>`;
        if (suggestions.length > 0) {
          html += `<p style="margin-bottom: 0.5rem;">Try these words:</p>`;
          html += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">`;
          suggestions.forEach(s => {
            html += `<span onclick="document.getElementById('thesaurusWord').value='${s}'; lookupThesaurus();" style="background: #e3f2fd; color: #1565c0; padding: 0.25rem 0.75rem; border-radius: 20px; cursor: pointer;">${s}</span>`;
          });
          html += `</div>`;
        }
        html += `</div>`;
        resultsDiv.innerHTML = html;
      }
    }

    function replaceWithWord(newWord) {
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && selection.toString().trim()) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(document.createTextNode(newWord));
        hideThesaurus();
        showToast(`Replaced with "${newWord}"`, 'success');
      } else {
        showToast('Select text in the document first to replace', 'info');
      }
    }

    // ========== Translate ==========
    // Simple translation dictionary for common phrases (offline fallback)
    const translations = {
      'en-es': {
        'hello': 'hola', 'goodbye': 'adi√≥s', 'thank you': 'gracias', 'please': 'por favor',
        'yes': 's√≠', 'no': 'no', 'good morning': 'buenos d√≠as', 'good night': 'buenas noches',
        'how are you': 'c√≥mo est√°s', 'i love you': 'te quiero', 'welcome': 'bienvenido',
        'sorry': 'lo siento', 'help': 'ayuda', 'water': 'agua', 'food': 'comida'
      },
      'en-fr': {
        'hello': 'bonjour', 'goodbye': 'au revoir', 'thank you': 'merci', 'please': 's\'il vous pla√Æt',
        'yes': 'oui', 'no': 'non', 'good morning': 'bonjour', 'good night': 'bonne nuit',
        'how are you': 'comment allez-vous', 'i love you': 'je t\'aime', 'welcome': 'bienvenue',
        'sorry': 'd√©sol√©', 'help': 'aide', 'water': 'eau', 'food': 'nourriture'
      },
      'en-de': {
        'hello': 'hallo', 'goodbye': 'auf wiedersehen', 'thank you': 'danke', 'please': 'bitte',
        'yes': 'ja', 'no': 'nein', 'good morning': 'guten morgen', 'good night': 'gute nacht',
        'how are you': 'wie geht es dir', 'i love you': 'ich liebe dich', 'welcome': 'willkommen',
        'sorry': 'entschuldigung', 'help': 'hilfe', 'water': 'wasser', 'food': 'essen'
      },
      'en-it': {
        'hello': 'ciao', 'goodbye': 'arrivederci', 'thank you': 'grazie', 'please': 'per favore',
        'yes': 's√¨', 'no': 'no', 'good morning': 'buongiorno', 'good night': 'buonanotte',
        'how are you': 'come stai', 'i love you': 'ti amo', 'welcome': 'benvenuto',
        'sorry': 'mi dispiace', 'help': 'aiuto', 'water': 'acqua', 'food': 'cibo'
      },
      'en-pt': {
        'hello': 'ol√°', 'goodbye': 'adeus', 'thank you': 'obrigado', 'please': 'por favor',
        'yes': 'sim', 'no': 'n√£o', 'good morning': 'bom dia', 'good night': 'boa noite',
        'how are you': 'como vai voc√™', 'i love you': 'eu te amo', 'welcome': 'bem-vindo',
        'sorry': 'desculpe', 'help': 'ajuda', 'water': '√°gua', 'food': 'comida'
      }
    };

    function showTranslate() {
      // Get selected text if any
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();
      if (selectedText) {
        document.getElementById('translateSource').value = selectedText;
      }
      document.getElementById('translateResult').value = '';
      document.getElementById('translateModal').classList.add('active');
    }

    function hideTranslate() {
      document.getElementById('translateModal').classList.remove('active');
    }

    function swapTranslateLanguages() {
      const fromSelect = document.getElementById('translateFrom');
      const toSelect = document.getElementById('translateTo');
      const fromVal = fromSelect.value;
      const toVal = toSelect.value;

      if (fromVal !== 'auto') {
        toSelect.value = fromVal;
        fromSelect.value = toVal;

        // Also swap text content
        const sourceText = document.getElementById('translateSource').value;
        const resultText = document.getElementById('translateResult').value;
        if (resultText) {
          document.getElementById('translateSource').value = resultText;
          document.getElementById('translateResult').value = sourceText;
        }
      }
    }

    function translateText() {
      const sourceText = document.getElementById('translateSource').value.trim();
      if (!sourceText) {
        showToast('Please enter text to translate', 'warning');
        return;
      }

      const fromLang = document.getElementById('translateFrom').value;
      const toLang = document.getElementById('translateTo').value;

      if (fromLang === toLang || (fromLang === 'auto' && toLang === 'en')) {
        document.getElementById('translateResult').value = sourceText;
        showToast('Source and target languages are the same', 'info');
        return;
      }

      // Try to find translation in our dictionary
      const dictKey = fromLang === 'auto' ? `en-${toLang}` : `${fromLang}-${toLang}`;
      const reverseKey = `${toLang}-${fromLang === 'auto' ? 'en' : fromLang}`;

      let translated = sourceText;
      const dict = translations[dictKey] || {};
      const reverseDict = translations[reverseKey] || {};

      // Create reverse lookup
      const reverseLookup = {};
      Object.entries(reverseDict).forEach(([k, v]) => {
        reverseLookup[v.toLowerCase()] = k;
      });

      // Simple word/phrase translation
      const lowerSource = sourceText.toLowerCase();
      if (dict[lowerSource]) {
        translated = dict[lowerSource];
        // Preserve original case
        if (sourceText[0] === sourceText[0].toUpperCase()) {
          translated = translated.charAt(0).toUpperCase() + translated.slice(1);
        }
      } else if (reverseLookup[lowerSource]) {
        translated = reverseLookup[lowerSource];
        if (sourceText[0] === sourceText[0].toUpperCase()) {
          translated = translated.charAt(0).toUpperCase() + translated.slice(1);
        }
      } else {
        // For longer text, translate word by word where possible
        const words = sourceText.split(/(\s+)/);
        translated = words.map(word => {
          const lower = word.toLowerCase();
          if (dict[lower]) return dict[lower];
          if (reverseLookup[lower]) return reverseLookup[lower];
          return word;
        }).join('');

        if (translated === sourceText) {
          // Show message that full translation requires API
          translated = `[Translation preview - ${getLangName(toLang)}]\n\n${sourceText}\n\n(Note: Full translation requires an online translation API. Common phrases are translated offline.)`;
        }
      }

      document.getElementById('translateResult').value = translated;
      showToast('Translation complete', 'success');
    }

    function getLangName(code) {
      const names = {
        'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German',
        'it': 'Italian', 'pt': 'Portuguese', 'zh': 'Chinese', 'ja': 'Japanese',
        'ko': 'Korean', 'ar': 'Arabic', 'ru': 'Russian'
      };
      return names[code] || code;
    }

    function insertTranslation() {
      const translation = document.getElementById('translateResult').value.trim();
      if (!translation) {
        showToast('No translation to insert', 'warning');
        return;
      }

      // Remove the preview note if present
      let cleanTranslation = translation;
      if (translation.startsWith('[Translation preview')) {
        showToast('Cannot insert preview text. Use a full translation.', 'warning');
        return;
      }

      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(document.createTextNode(cleanTranslation));
        hideTranslate();
        showToast('Translation inserted', 'success');
      } else {
        // Insert at cursor or end
        editor.focus();
        document.execCommand('insertText', false, cleanTranslation);
        hideTranslate();
        showToast('Translation inserted', 'success');
      }
    }

    function calculateTextStats(text) {
      // Words - split by whitespace, filter empty
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const wordCount = text.trim() === '' ? 0 : words.length;

      // Characters
      const charsWithSpaces = text.length;
      const charsNoSpaces = text.replace(/\s/g, '').length;

      // Paragraphs - split by double newlines or count block elements
      const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0).length || 1;

      // Lines
      const lines = text.split(/\n/).length;

      // Pages (estimate: ~250 words per page)
      const pages = Math.max(1, Math.ceil(wordCount / 250));

      // Reading time (average 200 words per minute)
      const minutes = Math.ceil(wordCount / 200);
      const readTime = minutes < 1 ? 'Less than 1 min' : `${minutes} min`;

      return {
        words: wordCount,
        charsWithSpaces,
        charsNoSpaces,
        paragraphs,
        lines,
        pages,
        readTime
      };
    }

    // Click outside word count modal to close
    document.getElementById('wordCountModal').addEventListener('click', (e) => {
      if (e.target.id === 'wordCountModal') {
        hideWordCount();
      }
    });

    // Live word count in status bar
    function updateStatusBarWordCount() {
      const editor = document.getElementById('editor');
      if (!editor) return;

      const text = editor.innerText || '';
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const wordCount = text.trim() === '' ? 0 : words.length;
      const charCount = text.length;

      const statusCenter = document.getElementById('statusCenter');
      if (statusCenter) {
        statusCenter.textContent = `Words: ${wordCount.toLocaleString()} | Characters: ${charCount.toLocaleString()}`;
      }

      // Update page estimation (approx 250 words per page)
      const totalPages = Math.max(1, Math.ceil(wordCount / 250));
      document.getElementById('totalPages').textContent = totalPages;

      // Estimate current page based on cursor position
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const textBeforeCursor = editor.innerText.substring(0, getCaretPosition(editor));
        const wordsBeforeCursor = textBeforeCursor.trim().split(/\s+/).filter(w => w.length > 0).length;
        const currentPage = Math.max(1, Math.ceil(wordsBeforeCursor / 250) || 1);
        document.getElementById('currentPage').textContent = Math.min(currentPage, totalPages);
      }
    }

    // Helper to get caret position
    function getCaretPosition(element) {
      let caretPos = 0;
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(element);
        preCaretRange.setEnd(range.endContainer, range.endOffset);
        caretPos = preCaretRange.toString().length;
      }
      return caretPos;
    }

    // Update word count on editor changes
    document.addEventListener('DOMContentLoaded', () => {
      const editor = document.getElementById('editor');
      if (editor) {
        editor.addEventListener('input', updateStatusBarWordCount);
        editor.addEventListener('click', updateStatusBarWordCount);
        editor.addEventListener('keyup', updateStatusBarWordCount);
        // Initial update
        setTimeout(updateStatusBarWordCount, 500);
      }
      // Initialize recent files
      updateRecentFilesMenu();
    });

    // ========== Quick Parts / AutoText ==========
    const QUICK_PARTS_KEY = 'ninjaword_quickparts';
    let selectedQuickPartId = null;
    let selectedQuickPartsCategory = 'general';

    const builtInQuickParts = {
      general: [
        { id: 'g1', name: 'Today\'s Date', content: '<span class="quick-part-date"></span>', preview: 'Inserts current date' },
        { id: 'g2', name: 'Page Break', content: '<div style="page-break-after: always;"></div><p></p>', preview: 'Insert page break' },
        { id: 'g3', name: 'Horizontal Line', content: '<hr style="border: none; border-top: 2px solid #333; margin: 1rem 0;">', preview: '‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî' },
        { id: 'g4', name: 'Signature Line', content: '<div style="margin-top: 2rem; border-top: 1px solid #000; width: 200px; padding-top: 4px;">Signature</div>', preview: 'Signature line' },
      ],
      headers: [
        { id: 'h1', name: 'Simple Header', content: '<div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 1rem;"><strong>Document Title</strong></div>', preview: 'Centered title header' },
        { id: 'h2', name: 'Header with Date', content: '<div style="display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 1rem;"><span>Document Title</span><span>[Date]</span></div>', preview: 'Title with date' },
        { id: 'h3', name: 'Footer with Page', content: '<div style="text-align: center; border-top: 1px solid #ccc; padding-top: 8px; margin-top: 2rem; font-size: 0.9em;">Page [#]</div>', preview: 'Centered page number' },
      ],
      textboxes: [
        { id: 't1', name: 'Sidebar Quote', content: '<div style="float: right; width: 200px; padding: 1rem; margin: 0 0 1rem 1rem; background: #f5f5f5; border-left: 4px solid #1a73e8; font-style: italic;">"Your quote here..."</div>', preview: 'Floating quote box' },
        { id: 't2', name: 'Callout Box', content: '<div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; margin: 1rem 0;"><strong>üìå Note:</strong> Your important note here...</div>', preview: 'Yellow callout box' },
        { id: 't3', name: 'Info Box', content: '<div style="padding: 1rem; background: #d1ecf1; border: 1px solid #0dcaf0; border-radius: 8px; margin: 1rem 0;"><strong>‚ÑπÔ∏è Info:</strong> Information goes here...</div>', preview: 'Blue info box' },
        { id: 't4', name: 'Warning Box', content: '<div style="padding: 1rem; background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px; margin: 1rem 0;"><strong>‚ö†Ô∏è Warning:</strong> Warning text here...</div>', preview: 'Red warning box' },
      ],
      coverpage: [
        { id: 'c1', name: 'Simple Cover', content: '<div style="text-align: center; padding: 4rem 2rem; min-height: 80vh; display: flex; flex-direction: column; justify-content: center;"><h1 style="font-size: 3rem; margin-bottom: 1rem;">Document Title</h1><p style="font-size: 1.5rem; color: #666;">Subtitle or Description</p><p style="margin-top: 3rem;">Author Name<br>Date</p></div><div style="page-break-after: always;"></div>', preview: 'Centered title page' },
        { id: 'c2', name: 'Modern Cover', content: '<div style="min-height: 90vh; background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); color: white; padding: 3rem; display: flex; flex-direction: column; justify-content: flex-end;"><h1 style="font-size: 3.5rem; margin: 0;">Document Title</h1><p style="font-size: 1.3rem; opacity: 0.9; margin-top: 1rem;">A comprehensive overview</p><div style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3);"><p>Prepared by: Author Name</p><p>Date: [Date]</p></div></div><div style="page-break-after: always;"></div>', preview: 'Blue gradient cover' },
      ],
      autotext: [
        { id: 'a1', name: 'Regards', content: '<p>Best regards,<br><br>[Your Name]</p>', preview: 'Best regards signature' },
        { id: 'a2', name: 'Sincerely', content: '<p>Sincerely,<br><br>[Your Name]<br>[Title]</p>', preview: 'Sincerely signature' },
        { id: 'a3', name: 'CONFIDENTIAL', content: '<p style="color: #dc3545; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">‚ö†Ô∏è CONFIDENTIAL - DO NOT DISTRIBUTE</p>', preview: 'Confidential notice' },
        { id: 'a4', name: 'DRAFT', content: '<p style="color: #6c757d; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; text-align: center;">‚Äî DRAFT ‚Äî</p>', preview: 'Draft marker' },
        { id: 'a5', name: 'Lorem Ipsum', content: '<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.</p>', preview: 'Placeholder text' },
      ],
      custom: []
    };

    function getCustomQuickParts() {
      try {
        return JSON.parse(localStorage.getItem(QUICK_PARTS_KEY)) || [];
      } catch { return []; }
    }

    function saveCustomQuickParts(parts) {
      localStorage.setItem(QUICK_PARTS_KEY, JSON.stringify(parts));
    }

    function showQuickParts() {
      selectedQuickPartId = null;
      selectedQuickPartsCategory = 'general';
      document.querySelectorAll('.quickparts-category').forEach(el => {
        el.classList.toggle('active', el.dataset.category === 'general');
      });
      renderQuickPartsGallery('general');
      document.getElementById('quickPartsModal').style.display = 'flex';
    }

    function hideQuickParts() {
      document.getElementById('quickPartsModal').style.display = 'none';
    }

    function selectQuickPartsCategory(category) {
      selectedQuickPartsCategory = category;
      selectedQuickPartId = null;
      document.querySelectorAll('.quickparts-category').forEach(el => {
        el.classList.toggle('active', el.dataset.category === category);
      });
      renderQuickPartsGallery(category);
    }

    function renderQuickPartsGallery(category) {
      const gallery = document.getElementById('quickPartsGallery');
      let parts = builtInQuickParts[category] || [];

      if (category === 'custom') {
        parts = getCustomQuickParts();
      }

      if (parts.length === 0) {
        gallery.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 2rem;">No quick parts in this category.<br>Select text and save it as a custom Quick Part.</div>';
        return;
      }

      gallery.innerHTML = parts.map(part => `
        <div class="quickpart-item ${selectedQuickPartId === part.id ? 'selected' : ''}"
             onclick="selectQuickPart('${part.id}')"
             ondblclick="insertQuickPartById('${part.id}')">
          <div class="quickpart-item-name">${part.name}</div>
          <div class="quickpart-item-preview">${part.preview}</div>
          ${category === 'custom' ? `
            <div class="quickpart-item-actions">
              <button class="btn btn-danger" onclick="event.stopPropagation(); deleteQuickPart('${part.id}')">Delete</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function selectQuickPart(id) {
      selectedQuickPartId = id;
      document.querySelectorAll('.quickpart-item').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
    }

    function insertSelectedQuickPart() {
      if (!selectedQuickPartId) {
        showToast('Please select a Quick Part', 'warning');
        return;
      }
      insertQuickPartById(selectedQuickPartId);
    }

    function insertQuickPartById(id) {
      let part = null;

      // Search in built-in parts
      for (const category in builtInQuickParts) {
        const found = builtInQuickParts[category].find(p => p.id === id);
        if (found) { part = found; break; }
      }

      // Search in custom parts
      if (!part) {
        const custom = getCustomQuickParts();
        part = custom.find(p => p.id === id);
      }

      if (!part) {
        showToast('Quick Part not found', 'error');
        return;
      }

      let content = part.content;

      // Replace dynamic placeholders
      content = content.replace(/<span class="quick-part-date"><\/span>/g, new Date().toLocaleDateString());
      content = content.replace(/\[Date\]/g, new Date().toLocaleDateString());

      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const fragment = range.createContextualFragment(content);
        range.deleteContents();
        range.insertNode(fragment);
        range.collapse(false);
      } else {
        editor.innerHTML += content;
      }

      hideQuickParts();
      showToast(`Inserted "${part.name}"`, 'success');
      updateStatusBarWordCount();
    }

    function saveQuickPart() {
      const name = document.getElementById('quickPartName').value.trim();
      const category = document.getElementById('quickPartCategory').value;

      if (!name) {
        showToast('Please enter a name for the Quick Part', 'error');
        return;
      }

      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Please select some text in the document first', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);
      const container = document.createElement('div');
      container.appendChild(range.cloneContents());
      const content = container.innerHTML;

      if (!content.trim()) {
        showToast('Selection is empty', 'error');
        return;
      }

      const preview = container.textContent.substring(0, 50) + (container.textContent.length > 50 ? '...' : '');

      const customParts = getCustomQuickParts();
      customParts.push({
        id: 'custom_' + Date.now(),
        name: name,
        content: content,
        preview: preview,
        category: category
      });
      saveCustomQuickParts(customParts);

      document.getElementById('quickPartName').value = '';

      if (selectedQuickPartsCategory === 'custom') {
        renderQuickPartsGallery('custom');
      }

      showToast(`Quick Part "${name}" saved`, 'success');
    }

    function deleteQuickPart(id) {
      if (!confirm('Delete this Quick Part?')) return;

      let customParts = getCustomQuickParts();
      customParts = customParts.filter(p => p.id !== id);
      saveCustomQuickParts(customParts);

      renderQuickPartsGallery('custom');
      showToast('Quick Part deleted', 'success');
    }

    // ========== Digital Signature ==========
    let signatureType = 'draw';
    let signatureCtx = null;
    let isDrawing = false;
    let uploadedSignatureData = null;

    function showDigitalSignature() {
      document.getElementById('digitalSignatureModal').style.display = 'flex';
      signatureType = 'draw';
      uploadedSignatureData = null;
      selectSignatureType('draw');
      initSignatureCanvas();
    }

    function hideDigitalSignature() {
      document.getElementById('digitalSignatureModal').style.display = 'none';
    }

    function selectSignatureType(type) {
      signatureType = type;
      document.querySelectorAll('.signature-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      document.getElementById('signatureDrawPanel').style.display = type === 'draw' ? 'block' : 'none';
      document.getElementById('signatureTypePanel').style.display = type === 'type' ? 'block' : 'none';
      document.getElementById('signatureUploadPanel').style.display = type === 'upload' ? 'block' : 'none';

      if (type === 'draw') initSignatureCanvas();
      if (type === 'type') updateTypedSignaturePreview();
    }

    function initSignatureCanvas() {
      const canvas = document.getElementById('signatureCanvas');
      signatureCtx = canvas.getContext('2d');
      signatureCtx.fillStyle = 'white';
      signatureCtx.fillRect(0, 0, canvas.width, canvas.height);
      signatureCtx.strokeStyle = '#000000';
      signatureCtx.lineWidth = 3;
      signatureCtx.lineCap = 'round';
      signatureCtx.lineJoin = 'round';

      canvas.onmousedown = startDrawing;
      canvas.onmousemove = draw;
      canvas.onmouseup = stopDrawing;
      canvas.onmouseleave = stopDrawing;

      // Touch support
      canvas.ontouchstart = (e) => { e.preventDefault(); startDrawing(e.touches[0]); };
      canvas.ontouchmove = (e) => { e.preventDefault(); draw(e.touches[0]); };
      canvas.ontouchend = stopDrawing;
    }

    function startDrawing(e) {
      isDrawing = true;
      const canvas = document.getElementById('signatureCanvas');
      const rect = canvas.getBoundingClientRect();
      signatureCtx.beginPath();
      signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
      if (!isDrawing) return;
      const canvas = document.getElementById('signatureCanvas');
      const rect = canvas.getBoundingClientRect();
      signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      signatureCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function clearSignatureCanvas() {
      const canvas = document.getElementById('signatureCanvas');
      signatureCtx.fillStyle = 'white';
      signatureCtx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function updateSignaturePen() {
      const color = document.getElementById('signaturePenColor').value;
      const size = parseInt(document.getElementById('signaturePenSize').value);
      signatureCtx.strokeStyle = color;
      signatureCtx.lineWidth = size;
    }

    function updateTypedSignaturePreview() {
      const text = document.getElementById('signatureText').value || 'Your Name';
      const font = document.getElementById('signatureFont').value;
      const preview = document.getElementById('typedSignaturePreview');
      preview.style.fontFamily = font;
      preview.textContent = text;
    }

    function previewUploadedSignature() {
      const file = document.getElementById('signatureUpload').files[0];
      const preview = document.getElementById('uploadedSignaturePreview');

      if (!file) {
        preview.innerHTML = '<span style="color: #666;">No image selected</span>';
        uploadedSignatureData = null;
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedSignatureData = e.target.result;
        preview.innerHTML = `<img src="${uploadedSignatureData}" style="max-height: 100px; max-width: 100%;">`;
      };
      reader.readAsDataURL(file);
    }

    function insertDigitalSignature() {
      const signerName = document.getElementById('signerName').value.trim();
      const signerTitle = document.getElementById('signerTitle').value.trim();
      const includeDate = document.getElementById('includeDate').checked;
      const includeTimestamp = document.getElementById('includeTimestamp').checked;

      let signatureImageSrc = '';

      if (signatureType === 'draw') {
        const canvas = document.getElementById('signatureCanvas');
        // Check if canvas has content
        const imageData = signatureCtx.getImageData(0, 0, canvas.width, canvas.height);
        const hasContent = imageData.data.some((val, i) => i % 4 !== 3 && val !== 255);
        if (!hasContent) {
          showToast('Please draw your signature', 'warning');
          return;
        }
        signatureImageSrc = canvas.toDataURL('image/png');
      } else if (signatureType === 'type') {
        const text = document.getElementById('signatureText').value.trim();
        if (!text) {
          showToast('Please type your signature', 'warning');
          return;
        }
        // Create image from typed text
        const font = document.getElementById('signatureFont').value;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 400;
        tempCanvas.height = 80;
        const ctx = tempCanvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        ctx.font = `36px ${font}`;
        ctx.fillStyle = '#000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, 200, 40);
        signatureImageSrc = tempCanvas.toDataURL('image/png');
      } else if (signatureType === 'upload') {
        if (!uploadedSignatureData) {
          showToast('Please upload a signature image', 'warning');
          return;
        }
        signatureImageSrc = uploadedSignatureData;
      }

      // Build date string
      let dateStr = '';
      if (includeDate) {
        dateStr = new Date().toLocaleDateString();
        if (includeTimestamp) {
          dateStr += ' ' + new Date().toLocaleTimeString();
        }
      }

      // Generate unique signature ID for verification
      const signatureId = 'SIG-' + Date.now().toString(36).toUpperCase();

      // Build signature HTML
      const signatureHTML = `
        <div class="digital-signature-block" contenteditable="false">
          <img class="sig-image" src="${signatureImageSrc}" alt="Signature">
          <div class="sig-info">
            ${signerName ? `<div class="sig-name">${signerName}</div>` : ''}
            ${signerTitle ? `<div class="sig-title">${signerTitle}</div>` : ''}
            ${dateStr ? `<div class="sig-date">Signed: ${dateStr}</div>` : ''}
            <div class="sig-verification">‚úì Digitally Signed (${signatureId})</div>
          </div>
        </div>
      `;

      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const fragment = range.createContextualFragment(signatureHTML);
        range.deleteContents();
        range.insertNode(fragment);
        range.collapse(false);
      } else {
        editor.innerHTML += signatureHTML;
      }

      hideDigitalSignature();
      showToast('Digital signature inserted', 'success');
      updateStatusBarWordCount();
    }

    // ========== Text Box ==========
    let selectedTextBoxStyle = 'simple';

    function showTextBoxModal() {
      selectedTextBoxStyle = 'simple';
      document.querySelectorAll('.textbox-style-option').forEach(el => {
        el.style.borderColor = el.dataset.style === 'simple' ? '#1a73e8' : '#ddd';
      });
      document.getElementById('textBoxModal').style.display = 'flex';
    }

    function hideTextBoxModal() {
      document.getElementById('textBoxModal').style.display = 'none';
    }

    function selectTextBoxStyle(style) {
      selectedTextBoxStyle = style;
      document.querySelectorAll('.textbox-style-option').forEach(el => {
        el.style.borderColor = el.dataset.style === style ? '#1a73e8' : '#ddd';
      });
    }

    function insertTextBox() {
      const width = parseInt(document.getElementById('textBoxWidth').value) || 300;
      const height = parseInt(document.getElementById('textBoxHeight').value) || 150;
      const position = document.querySelector('input[name="textBoxPosition"]:checked').value;
      const borderColor = document.getElementById('textBoxBorderColor').value;
      const bgColor = document.getElementById('textBoxBgColor').value;

      let styles = {
        width: width + 'px',
        minHeight: height + 'px',
        padding: '12px',
        margin: '1rem',
        backgroundColor: bgColor,
        borderColor: borderColor
      };

      let baseStyle = `
        width: ${styles.width};
        min-height: ${styles.minHeight};
        padding: ${styles.padding};
        background-color: ${styles.backgroundColor};
      `;

      // Apply style-specific attributes
      switch (selectedTextBoxStyle) {
        case 'simple':
          baseStyle += `border: 1px solid ${borderColor};`;
          break;
        case 'shadow':
          baseStyle += `border: 1px solid ${borderColor}; box-shadow: 4px 4px 8px rgba(0,0,0,0.3);`;
          break;
        case 'rounded':
          baseStyle += `border: 1px solid ${borderColor}; border-radius: 16px;`;
          break;
        case 'colored':
          baseStyle += `border: 2px solid #1a73e8; background-color: #e3f2fd;`;
          break;
        case 'callout':
          baseStyle += `border: none; border-left: 4px solid #1a73e8; background-color: #f5f5f5;`;
          break;
        case 'quote':
          baseStyle += `border: none; background-color: #f9f9f9; font-style: italic;`;
          break;
      }

      // Apply position
      switch (position) {
        case 'float-left':
          baseStyle += ' float: left; margin-right: 1rem; margin-bottom: 0.5rem;';
          break;
        case 'float-right':
          baseStyle += ' float: right; margin-left: 1rem; margin-bottom: 0.5rem;';
          break;
        default:
          baseStyle += ' display: inline-block; margin: 1rem 0;';
      }

      const textBoxHTML = `
        <div class="text-box" contenteditable="true" style="${baseStyle}">
          <p>Click here to add text...</p>
        </div>
      `;

      const editor = document.getElementById('editor');
      const selection = window.getSelection();

      if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        const range = selection.getRangeAt(0);
        const fragment = range.createContextualFragment(textBoxHTML);
        range.deleteContents();
        range.insertNode(fragment);
        range.collapse(false);
      } else {
        editor.innerHTML += textBoxHTML;
      }

      hideTextBoxModal();
      showToast('Text box inserted', 'success');
      updateStatusBarWordCount();
    }

    // ========== Document Inspector ==========
    let inspectorResults = {};

    function showDocumentInspector() {
      // Reset results display
      document.querySelectorAll('.inspector-result').forEach(el => {
        el.className = 'inspector-result';
        el.innerHTML = '';
      });
      inspectorResults = {};
      document.getElementById('documentInspectorModal').style.display = 'flex';
      toggleFileMenu();
    }

    function hideDocumentInspector() {
      document.getElementById('documentInspectorModal').style.display = 'none';
    }

    function runDocumentInspector() {
      const editor = document.getElementById('editor');
      inspectorResults = {};

      // Inspect Comments & Revisions
      if (document.getElementById('inspectComments').checked) {
        const comments = editor.querySelectorAll('.comment, .track-change, [data-comment]');
        const resultEl = document.getElementById('resultComments');
        if (comments.length > 0) {
          inspectorResults.comments = comments;
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${comments.length} comment(s) or tracked change(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No comments or revisions found';
        }
      }

      // Inspect Document Properties
      if (document.getElementById('inspectProperties').checked) {
        const fileName = document.getElementById('fileName').value;
        const resultEl = document.getElementById('resultProperties');
        const hasProperties = fileName && fileName !== 'Untitled Document';
        if (hasProperties) {
          inspectorResults.properties = { fileName };
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Document name: "${fileName}"`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No custom properties found';
        }
      }

      // Inspect Hidden Text
      if (document.getElementById('inspectHiddenText').checked) {
        const hidden = editor.querySelectorAll('[style*="display: none"], [style*="visibility: hidden"], [hidden]');
        const resultEl = document.getElementById('resultHiddenText');
        if (hidden.length > 0) {
          inspectorResults.hiddenText = hidden;
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${hidden.length} hidden element(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No hidden text found';
        }
      }

      // Inspect Personal Information
      if (document.getElementById('inspectPersonalInfo').checked) {
        const content = editor.textContent;
        const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
        const phoneRegex = /(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g;
        const emails = content.match(emailRegex) || [];
        const phones = content.match(phoneRegex) || [];
        const resultEl = document.getElementById('resultPersonalInfo');
        if (emails.length > 0 || phones.length > 0) {
          inspectorResults.personalInfo = { emails, phones };
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${emails.length} email(s), ${phones.length} phone number(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No personal information patterns detected';
        }
      }

      // Inspect Hyperlinks
      if (document.getElementById('inspectLinks').checked) {
        const links = editor.querySelectorAll('a[href]');
        const resultEl = document.getElementById('resultLinks');
        if (links.length > 0) {
          inspectorResults.links = links;
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${links.length} hyperlink(s)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No hyperlinks found';
        }
      }

      // Inspect Embedded Images
      if (document.getElementById('inspectImages').checked) {
        const images = editor.querySelectorAll('img');
        const resultEl = document.getElementById('resultImages');
        if (images.length > 0) {
          inspectorResults.images = images;
          let totalSize = 0;
          images.forEach(img => {
            if (img.src.startsWith('data:')) {
              totalSize += img.src.length * 0.75; // Approximate base64 size
            }
          });
          const sizeStr = totalSize > 1024 * 1024
            ? (totalSize / (1024 * 1024)).toFixed(2) + ' MB'
            : (totalSize / 1024).toFixed(2) + ' KB';
          resultEl.className = 'inspector-result found';
          resultEl.innerHTML = `‚ö†Ô∏è Found ${images.length} image(s) (~${sizeStr} embedded data)`;
        } else {
          resultEl.className = 'inspector-result clean';
          resultEl.innerHTML = '‚úì No embedded images found';
        }
      }

      showToast('Inspection complete', 'success');
    }

    function removeAllInspected() {
      const editor = document.getElementById('editor');
      let removed = 0;

      if (inspectorResults.comments) {
        inspectorResults.comments.forEach(el => {
          el.remove();
          removed++;
        });
      }

      if (inspectorResults.hiddenText) {
        inspectorResults.hiddenText.forEach(el => {
          el.remove();
          removed++;
        });
      }

      if (inspectorResults.links) {
        inspectorResults.links.forEach(link => {
          const text = document.createTextNode(link.textContent);
          link.parentNode.replaceChild(text, link);
          removed++;
        });
      }

      if (inspectorResults.images) {
        inspectorResults.images.forEach(img => {
          img.remove();
          removed++;
        });
      }

      if (removed > 0) {
        showToast(`Removed ${removed} item(s)`, 'success');
        runDocumentInspector(); // Re-run to update display
      } else {
        showToast('Nothing to remove', 'info');
      }
    }

    // ========== Reading Mode ==========
    let readingFontSize = 1.2;

    function toggleReadingMode() {
      const overlay = document.getElementById('readingModeOverlay');
      if (overlay.classList.contains('active')) {
        overlay.classList.remove('active');
      } else {
        const title = document.getElementById('fileName').value || 'Document';
        document.getElementById('readingTitle').textContent = title;
        const content = document.getElementById('editor').innerHTML;
        document.getElementById('readingText').innerHTML = content;
        overlay.classList.add('active');
        updateReadingProgress();
      }
    }

    function changeReadingTheme(theme) {
      const overlay = document.getElementById('readingModeOverlay');
      overlay.classList.remove('sepia', 'light', 'dark');
      if (theme !== 'light') overlay.classList.add(theme);
    }

    function adjustReadingFontSize(delta) {
      readingFontSize = Math.max(0.8, Math.min(2.5, readingFontSize + delta * 0.1));
      document.getElementById('readingText').style.fontSize = readingFontSize + 'rem';
    }

    function updateReadingProgress() {
      const content = document.getElementById('readingContent');
      const progress = document.getElementById('readingProgress');
      const scrollPercent = (content.scrollTop / (content.scrollHeight - content.clientHeight)) * 100;
      progress.style.width = Math.min(100, Math.max(0, scrollPercent || 0)) + '%';
    }

    // Escape key to exit reading mode
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('readingModeOverlay').classList.contains('active')) {
        toggleReadingMode();
      }
    });

    // ========== Recent Files ==========
    const RECENT_FILES_KEY = 'ninjaword_recent';
    const MAX_RECENT_FILES = 10;

    function getRecentFiles() {
      try {
        return JSON.parse(localStorage.getItem(RECENT_FILES_KEY)) || [];
      } catch {
        return [];
      }
    }

    function addToRecentFiles(docId, name) {
      let recent = getRecentFiles();
      // Remove if already exists
      recent = recent.filter(f => f.id !== docId);
      // Add to front
      recent.unshift({
        id: docId,
        name: name,
        timestamp: Date.now()
      });
      // Keep only max items
      recent = recent.slice(0, MAX_RECENT_FILES);
      localStorage.setItem(RECENT_FILES_KEY, JSON.stringify(recent));
      updateRecentFilesMenu();
    }

    function toggleRecentFiles(event) {
      event.stopPropagation();
      const submenu = document.getElementById('recentFilesMenu');
      submenu.classList.toggle('show');
    }

    function updateRecentFilesMenu() {
      const menu = document.getElementById('recentFilesMenu');
      const recent = getRecentFiles();
      const docs = getSavedDocuments();

      if (recent.length === 0) {
        menu.innerHTML = '<div class="submenu-empty">No recent files</div>';
        return;
      }

      menu.innerHTML = recent
        .filter(f => docs[f.id]) // Only show files that still exist
        .map(f => {
          const date = new Date(f.timestamp);
          const dateStr = date.toLocaleDateString();
          return `<div class="submenu-item" onclick="openRecentFile('${f.id}')">
            <span>${f.name}</span>
            <span class="file-date">${dateStr}</span>
          </div>`;
        }).join('');

      if (menu.innerHTML === '') {
        menu.innerHTML = '<div class="submenu-empty">No recent files</div>';
      }
    }

    function openRecentFile(docId) {
      const docs = getSavedDocuments();
      if (docs[docId]) {
        editor.innerHTML = docs[docId].content;
        document.getElementById('fileName').value = docs[docId].name;
        currentDocId = docId;
        addToRecentFiles(docId, docs[docId].name);
        toggleFileMenu();
        showToast('Document opened', 'success');
      } else {
        showToast('Document not found', 'error');
      }
    }

    // Close submenu when clicking elsewhere
    document.addEventListener('click', () => {
      document.getElementById('recentFilesMenu')?.classList.remove('show');
    });

    // ==================== READING PROGRESS ====================
    let readingProgressEnabled = false;
    let readingStartTime = null;
    let lastScrollPosition = 0;

    function toggleReadingProgress() {
      readingProgressEnabled = !readingProgressEnabled;
      const btn = document.getElementById('readingProgressBtn');
      const bar = document.getElementById('readingProgressBar');
      const info = document.getElementById('readingProgressInfo');

      if (readingProgressEnabled) {
        btn.classList.add('active');
        bar.style.display = 'block';
        info.classList.add('visible');
        readingStartTime = Date.now();
        updateReadingProgress();
        showToast('Reading progress enabled', 'success');
      } else {
        btn.classList.remove('active');
        bar.style.display = 'none';
        info.classList.remove('visible');
        showToast('Reading progress disabled', 'info');
      }
    }

    function updateReadingProgress() {
      if (!readingProgressEnabled) return;

      const docArea = document.querySelector('.document-area');
      const editor = document.getElementById('editor');

      if (!docArea || !editor) return;

      // Calculate scroll progress
      const scrollTop = docArea.scrollTop;
      const scrollHeight = docArea.scrollHeight - docArea.clientHeight;
      const progress = scrollHeight > 0 ? Math.min(100, (scrollTop / scrollHeight) * 100) : 0;

      // Update progress bar
      document.getElementById('readingProgressBar').style.width = `${progress}%`;
      document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;

      // Get document stats
      const text = editor.innerText || editor.textContent || '';
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const totalWords = words.length;
      const wordsRead = Math.floor(totalWords * (progress / 100));

      document.getElementById('wordsRead').textContent = `${wordsRead.toLocaleString()} / ${totalWords.toLocaleString()}`;

      // Calculate time reading
      if (readingStartTime) {
        const elapsed = Math.floor((Date.now() - readingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timeReading').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        // Calculate reading speed and time remaining
        if (wordsRead > 0 && elapsed > 10) {
          const wpm = Math.round((wordsRead / elapsed) * 60);
          document.getElementById('readingSpeed').textContent = `${wpm} wpm`;

          const remainingWords = totalWords - wordsRead;
          if (wpm > 0 && remainingWords > 0) {
            const remainingMinutes = Math.ceil(remainingWords / wpm);
            document.getElementById('timeRemaining').textContent = remainingMinutes < 60
              ? `${remainingMinutes} min`
              : `${Math.floor(remainingMinutes / 60)}h ${remainingMinutes % 60}m`;
          } else {
            document.getElementById('timeRemaining').textContent = '< 1 min';
          }
        }
      }
    }

    // Listen for scroll events on document area
    document.querySelector('.document-area')?.addEventListener('scroll', () => {
      if (readingProgressEnabled) {
        updateReadingProgress();
      }
    });

    // Update progress periodically
    setInterval(() => {
      if (readingProgressEnabled) {
        updateReadingProgress();
      }
    }, 1000);

    // ==================== DOCUMENT STATISTICS ====================
    function showDocumentStatistics() {
      const editor = document.getElementById('editor');
      const text = editor.innerText || editor.textContent || '';

      // Basic stats
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      const chars = text.replace(/\s/g, '').length;
      const charsWithSpaces = text.length;
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      const paragraphs = editor.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6').length || text.split(/\n\n+/).filter(p => p.trim()).length || 1;

      // Update stats display
      document.getElementById('statWords').textContent = words.length.toLocaleString();
      document.getElementById('statChars').textContent = chars.toLocaleString();
      document.getElementById('statSentences').textContent = sentences.toLocaleString();
      document.getElementById('statParagraphs').textContent = paragraphs.toLocaleString();

      // Reading time estimates
      const avgMinutes = Math.ceil(words.length / 200);
      const fastMinutes = Math.ceil(words.length / 300);
      const speakMinutes = Math.ceil(words.length / 150);

      document.getElementById('statReadAvg').textContent = avgMinutes < 60
        ? `${avgMinutes} min`
        : `${Math.floor(avgMinutes / 60)}h ${avgMinutes % 60}m`;
      document.getElementById('statReadFast').textContent = fastMinutes < 60
        ? `${fastMinutes} min`
        : `${Math.floor(fastMinutes / 60)}h ${fastMinutes % 60}m`;
      document.getElementById('statSpeak').textContent = speakMinutes < 60
        ? `${speakMinutes} min`
        : `${Math.floor(speakMinutes / 60)}h ${speakMinutes % 60}m`;

      // Readability stats
      const avgWordLength = words.length > 0
        ? (words.join('').length / words.length).toFixed(1)
        : 0;
      const avgSentenceLength = sentences > 0
        ? (words.length / sentences).toFixed(1)
        : 0;
      const uniqueWords = new Set(words.map(w => w.toLowerCase())).size;

      document.getElementById('statAvgWordLen').textContent = `${avgWordLength} chars`;
      document.getElementById('statAvgSentLen').textContent = `${avgSentenceLength} words`;
      document.getElementById('statUniqueWords').textContent = uniqueWords.toLocaleString();

      document.getElementById('docStatsModal').style.display = 'flex';
    }

    function hideDocumentStatistics() {
      document.getElementById('docStatsModal').style.display = 'none';
    }

    function copyStatistics() {
      const stats = `Document Statistics
==================
Words: ${document.getElementById('statWords').textContent}
Characters: ${document.getElementById('statChars').textContent}
Sentences: ${document.getElementById('statSentences').textContent}
Paragraphs: ${document.getElementById('statParagraphs').textContent}

Reading Time Estimates
---------------------
Average Reader (~200 wpm): ${document.getElementById('statReadAvg').textContent}
Fast Reader (~300 wpm): ${document.getElementById('statReadFast').textContent}
Speaking Time (~150 wpm): ${document.getElementById('statSpeak').textContent}

Readability
-----------
Average Word Length: ${document.getElementById('statAvgWordLen').textContent}
Average Sentence Length: ${document.getElementById('statAvgSentLen').textContent}
Unique Words: ${document.getElementById('statUniqueWords').textContent}`;

      navigator.clipboard.writeText(stats).then(() => {
        showToast('Statistics copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy statistics', 'error');
      });
    }

    // Change Case functionality
    let changeCaseMenu = null;

    function showChangeCaseMenu(event) {
      event.stopPropagation();

      // Remove existing menu if any
      if (changeCaseMenu) {
        changeCaseMenu.remove();
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      changeCaseMenu = document.createElement('div');
      changeCaseMenu.className = 'change-case-menu';
      changeCaseMenu.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        min-width: 180px;
      `;

      changeCaseMenu.innerHTML = `
        <div style="padding: 8px 16px; cursor: pointer; hover:background:#f5f5f5;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('sentence')">Sentence case</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('lower')">lowercase</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('upper')">UPPERCASE</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('title')">Title Case</div>
        <div style="padding: 8px 16px; cursor: pointer;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'" onclick="changeCase('toggle')">tOGGLE cASE</div>
      `;

      document.body.appendChild(changeCaseMenu);

      // Close menu on click outside
      setTimeout(() => {
        document.addEventListener('click', closeChangeCaseMenu);
      }, 10);
    }

    function closeChangeCaseMenu() {
      if (changeCaseMenu) {
        changeCaseMenu.remove();
        changeCaseMenu = null;
      }
      document.removeEventListener('click', closeChangeCaseMenu);
    }

    function changeCase(type) {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        closeChangeCaseMenu();
        return;
      }

      const range = selection.getRangeAt(0);
      const text = selection.toString();
      let newText = '';

      switch (type) {
        case 'sentence':
          newText = text.toLowerCase().replace(/(^\s*\w|[.!?]\s*\w)/g, c => c.toUpperCase());
          break;
        case 'lower':
          newText = text.toLowerCase();
          break;
        case 'upper':
          newText = text.toUpperCase();
          break;
        case 'title':
          newText = text.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
          break;
        case 'toggle':
          newText = text.split('').map(c =>
            c === c.toUpperCase() ? c.toLowerCase() : c.toUpperCase()
          ).join('');
          break;
      }

      // Replace the selected text
      range.deleteContents();
      range.insertNode(document.createTextNode(newText));

      // Restore selection
      selection.removeAllRanges();
      selection.addRange(range);

      closeChangeCaseMenu();
      showToast(`Changed to ${type} case`, 'success');
    }

    // Small Caps formatting
    function applySmallCaps() {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);

      // Check if selection is already small-caps
      const container = range.commonAncestorContainer;
      let parentSpan = container.nodeType === 3 ? container.parentNode : container;

      if (parentSpan.style && parentSpan.style.fontVariant === 'small-caps') {
        // Remove small caps
        parentSpan.style.fontVariant = '';
        showToast('Small caps removed', 'info');
      } else {
        // Apply small caps
        const span = document.createElement('span');
        span.style.fontVariant = 'small-caps';
        span.appendChild(range.extractContents());
        range.insertNode(span);
        showToast('Small caps applied', 'success');
      }
    }

    // Double Underline formatting
    function applyDoubleUnderline() {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);

      // Check if selection is already double underlined
      const container = range.commonAncestorContainer;
      let parentSpan = container.nodeType === 3 ? container.parentNode : container;

      if (parentSpan.style && parentSpan.style.textDecorationStyle === 'double') {
        // Remove double underline
        parentSpan.style.textDecoration = '';
        parentSpan.style.textDecorationStyle = '';
        showToast('Double underline removed', 'info');
      } else {
        // Apply double underline
        const span = document.createElement('span');
        span.style.textDecoration = 'underline';
        span.style.textDecorationStyle = 'double';
        span.appendChild(range.extractContents());
        range.insertNode(span);
        showToast('Double underline applied', 'success');
      }
    }

    // Clear Formatting
    function clearFormatting() {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        return;
      }

      // Use execCommand to remove formatting
      document.execCommand('removeFormat', false, null);

      // Also remove background color
      document.execCommand('hiliteColor', false, 'transparent');

      showToast('Formatting cleared', 'success');
    }

    // ==================== COMMAND PALETTE ====================
    const commandList = [
      // File operations
      { name: 'New Document', icon: 'üìÑ', desc: 'Create a new blank document', action: () => newDocument(), shortcut: 'Ctrl+N', category: 'file' },
      { name: 'Save Document', icon: 'üíæ', desc: 'Save the current document', action: () => saveDocument(), shortcut: 'Ctrl+S', category: 'file' },
      { name: 'Export as PDF', icon: 'üìë', desc: 'Export document as PDF file', action: () => exportPDF(), category: 'file' },
      { name: 'Export as DOCX', icon: 'üìù', desc: 'Export as Word document', action: () => exportDocx(), category: 'file' },
      { name: 'Print', icon: 'üñ®Ô∏è', desc: 'Print the document', action: () => window.print(), shortcut: 'Ctrl+P', category: 'file' },
      // Edit operations
      { name: 'Undo', icon: '‚Ü∂', desc: 'Undo last action', action: () => formatDoc('undo'), shortcut: 'Ctrl+Z', category: 'edit' },
      { name: 'Redo', icon: '‚Ü∑', desc: 'Redo last action', action: () => formatDoc('redo'), shortcut: 'Ctrl+Y', category: 'edit' },
      { name: 'Find & Replace', icon: 'üîç', desc: 'Find and replace text', action: () => showFindReplace(), shortcut: 'Ctrl+H', category: 'edit' },
      { name: 'Select All', icon: '‚òëÔ∏è', desc: 'Select all content', action: () => formatDoc('selectAll'), shortcut: 'Ctrl+A', category: 'edit' },
      { name: 'Copy', icon: 'üìã', desc: 'Copy selected text', action: () => formatDoc('copy'), shortcut: 'Ctrl+C', category: 'edit' },
      { name: 'Paste', icon: 'üìÑ', desc: 'Paste from clipboard', action: () => formatDoc('paste'), shortcut: 'Ctrl+V', category: 'edit' },
      { name: 'Cut', icon: '‚úÇÔ∏è', desc: 'Cut selected text', action: () => formatDoc('cut'), shortcut: 'Ctrl+X', category: 'edit' },
      // Formatting
      { name: 'Bold', icon: 'B', desc: 'Make text bold', action: () => formatDoc('bold'), shortcut: 'Ctrl+B', category: 'format' },
      { name: 'Italic', icon: 'I', desc: 'Make text italic', action: () => formatDoc('italic'), shortcut: 'Ctrl+I', category: 'format' },
      { name: 'Underline', icon: 'U', desc: 'Underline text', action: () => formatDoc('underline'), shortcut: 'Ctrl+U', category: 'format' },
      { name: 'Strikethrough', icon: 'S', desc: 'Strike through text', action: () => formatDoc('strikeThrough'), category: 'format' },
      { name: 'Superscript', icon: 'X¬≤', desc: 'Make text superscript', action: () => formatDoc('superscript'), category: 'format' },
      { name: 'Subscript', icon: 'X‚ÇÇ', desc: 'Make text subscript', action: () => formatDoc('subscript'), category: 'format' },
      { name: 'Clear Formatting', icon: 'üßπ', desc: 'Remove all formatting', action: () => clearFormatting(), category: 'format' },
      { name: 'Format Painter', icon: 'üñåÔ∏è', desc: 'Copy and apply formatting', action: () => toggleFormatPainter(), category: 'format' },
      // Alignment
      { name: 'Align Left', icon: '‚´∑', desc: 'Align text to the left', action: () => formatDoc('justifyLeft'), category: 'format' },
      { name: 'Align Center', icon: '‚ò∞', desc: 'Center align text', action: () => formatDoc('justifyCenter'), category: 'format' },
      { name: 'Align Right', icon: '‚´∏', desc: 'Align text to the right', action: () => formatDoc('justifyRight'), category: 'format' },
      { name: 'Justify', icon: '‚ò∞', desc: 'Justify text', action: () => formatDoc('justifyFull'), category: 'format' },
      // Lists
      { name: 'Bullet List', icon: '‚Ä¢', desc: 'Create a bulleted list', action: () => formatDoc('insertUnorderedList'), category: 'insert' },
      { name: 'Numbered List', icon: '1.', desc: 'Create a numbered list', action: () => formatDoc('insertOrderedList'), category: 'insert' },
      // Insert
      { name: 'Insert Table', icon: '‚ñ¶', desc: 'Insert a table', action: () => showTableModal(), category: 'insert' },
      { name: 'Insert Image', icon: 'üñºÔ∏è', desc: 'Insert an image', action: () => insertImage(), category: 'insert' },
      { name: 'Insert Link', icon: 'üîó', desc: 'Insert a hyperlink', action: () => insertLink(), category: 'insert' },
      { name: 'Insert Horizontal Rule', icon: '‚Äï', desc: 'Insert horizontal line', action: () => formatDoc('insertHorizontalRule'), category: 'insert' },
      { name: 'Insert Page Break', icon: 'üìÉ', desc: 'Insert page break', action: () => insertPageBreak(), category: 'insert' },
      { name: 'Insert Table of Contents', icon: 'üìë', desc: 'Insert table of contents', action: () => insertTableOfContents(), category: 'insert' },
      { name: 'Insert Footnote', icon: '¬π', desc: 'Insert a footnote', action: () => insertFootnote(), category: 'insert' },
      { name: 'Insert Bookmark', icon: 'üîñ', desc: 'Insert a bookmark', action: () => insertBookmark(), category: 'insert' },
      { name: 'Insert Equation', icon: '‚àë', desc: 'Insert mathematical equation', action: () => showEquationEditor(), category: 'insert' },
      { name: 'Insert Drop Cap', icon: 'D', desc: 'Insert drop cap', action: () => insertDropCap(), category: 'insert' },
      { name: 'Insert QR Code', icon: '‚ñ£', desc: 'Insert QR code', action: () => showQRCodeGenerator(), category: 'insert' },
      { name: 'Insert Screenshot', icon: 'üì∏', desc: 'Capture and insert screenshot', action: () => insertScreenshot(), category: 'insert' },
      { name: 'Insert Smart Art', icon: 'üìä', desc: 'Insert Smart Art graphics', action: () => showSmartArt(), category: 'insert' },
      { name: 'Insert Sticky Note', icon: 'üìå', desc: 'Add a sticky note', action: () => addStickyNote(), category: 'insert' },
      // Review
      { name: 'Spell Check', icon: 'üî§', desc: 'Run spell check', action: () => runSpellCheck(), category: 'review' },
      { name: 'Grammar Check', icon: 'üìù', desc: 'Check grammar', action: () => runGrammarCheck(), category: 'review' },
      { name: 'Thesaurus', icon: 'üìñ', desc: 'Open thesaurus', action: () => showThesaurus(), category: 'review' },
      { name: 'Word Count', icon: 'üìä', desc: 'Show word count', action: () => showWordCount(), category: 'review' },
      { name: 'Track Changes', icon: 'üìù', desc: 'Toggle track changes', action: () => toggleTrackChanges(), category: 'review' },
      { name: 'Add Comment', icon: 'üí¨', desc: 'Add a comment', action: () => addComment(), category: 'review' },
      { name: 'Translate', icon: 'üåê', desc: 'Translate text', action: () => showTranslate(), category: 'review' },
      // View
      { name: 'Toggle Dark Mode', icon: 'üåô', desc: 'Toggle dark/light mode', action: () => toggleDarkMode(), category: 'view' },
      { name: 'Toggle Focus Mode', icon: 'üéØ', desc: 'Toggle focus mode', action: () => toggleFocusMode(), category: 'view' },
      { name: 'Toggle Reading Mode', icon: 'üìñ', desc: 'Toggle reading mode', action: () => toggleReadingMode(), category: 'view' },
      { name: 'Toggle Ruler', icon: 'üìè', desc: 'Show/hide ruler', action: () => toggleRuler(), category: 'view' },
      { name: 'Show Print Preview', icon: 'üñ®Ô∏è', desc: 'Preview print layout', action: () => togglePrintPreview(), category: 'view' },
      { name: 'Page Setup', icon: 'üìÑ', desc: 'Configure page settings', action: () => showPageSetup(), category: 'view' },
      { name: 'Show Styles Panel', icon: 'üé®', desc: 'Open styles panel', action: () => showStylesPanel(), category: 'view' },
      { name: 'Toggle Line Numbers', icon: '123', desc: 'Show/hide line numbers', action: () => toggleLineNumbers(), category: 'view' },
      // Tools
      { name: 'Mail Merge', icon: 'üìß', desc: 'Start mail merge', action: () => showMailMerge(), category: 'tools' },
      { name: 'Compare Documents', icon: '‚öñÔ∏è', desc: 'Compare two documents', action: () => showCompareDocuments(), category: 'tools' },
      { name: 'Revision History', icon: 'üìú', desc: 'View revision history', action: () => showRevisionHistory(), category: 'tools' },
      { name: 'Recent Documents', icon: 'üìÇ', desc: 'View recent documents', action: () => showRecentDocuments(), category: 'tools' },
      { name: 'Dictation', icon: 'üé§', desc: 'Start voice dictation', action: () => toggleDictation(), category: 'tools' },
      { name: 'Read Aloud', icon: 'üîä', desc: 'Read document aloud', action: () => toggleReadAloud(), category: 'tools' },
      { name: 'Document Inspector', icon: 'üîç', desc: 'Inspect document', action: () => showDocumentInspector(), category: 'tools' },
      { name: 'Accessibility Checker', icon: '‚ôø', desc: 'Check accessibility', action: () => showAccessibilityChecker(), category: 'tools' },
      { name: 'Keyboard Shortcuts', icon: '‚å®Ô∏è', desc: 'View keyboard shortcuts', action: () => showKeyboardShortcuts(), category: 'help' }
    ];

    let selectedCommandIndex = 0;
    let filteredCommands = [...commandList];

    function showCommandPalette() {
      document.getElementById('commandPaletteOverlay').classList.add('visible');
      const input = document.getElementById('commandPaletteInput');
      input.value = '';
      input.focus();
      selectedCommandIndex = 0;
      filteredCommands = [...commandList];
      renderCommands();
    }

    function hideCommandPalette() {
      document.getElementById('commandPaletteOverlay').classList.remove('visible');
    }

    function filterCommands() {
      const query = document.getElementById('commandPaletteInput').value.toLowerCase().trim();
      if (!query) {
        filteredCommands = [...commandList];
      } else {
        filteredCommands = commandList.filter(cmd =>
          cmd.name.toLowerCase().includes(query) ||
          cmd.desc.toLowerCase().includes(query) ||
          cmd.category.toLowerCase().includes(query)
        );
      }
      selectedCommandIndex = 0;
      renderCommands();
    }

    function renderCommands() {
      const container = document.getElementById('commandPaletteResults');
      if (filteredCommands.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No commands found</div>';
        return;
      }
      container.innerHTML = filteredCommands.map((cmd, i) => `
        <div class="command-item ${i === selectedCommandIndex ? 'selected' : ''}" onclick="executeCommand(${i})" onmouseover="selectedCommandIndex = ${i}; renderCommands();">
          <span class="command-item-icon">${cmd.icon}</span>
          <div class="command-item-text">
            <div class="command-item-name">${cmd.name}</div>
            <div class="command-item-desc">${cmd.desc}</div>
          </div>
          ${cmd.shortcut ? `<span class="command-item-shortcut">${cmd.shortcut}</span>` : ''}
        </div>
      `).join('');
    }

    function handleCommandKey(e) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedCommandIndex = Math.min(selectedCommandIndex + 1, filteredCommands.length - 1);
        renderCommands();
        scrollCommandIntoView();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedCommandIndex = Math.max(selectedCommandIndex - 1, 0);
        renderCommands();
        scrollCommandIntoView();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        executeCommand(selectedCommandIndex);
      } else if (e.key === 'Escape') {
        hideCommandPalette();
      }
    }

    function scrollCommandIntoView() {
      const container = document.getElementById('commandPaletteResults');
      const selected = container.querySelector('.command-item.selected');
      if (selected) {
        selected.scrollIntoView({ block: 'nearest' });
      }
    }

    function executeCommand(index) {
      if (filteredCommands[index]) {
        hideCommandPalette();
        try {
          filteredCommands[index].action();
        } catch (e) {
          console.error('Command execution error:', e);
        }
      }
    }

    // Keyboard shortcut to open command palette (Ctrl+Shift+P)
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'p') {
        e.preventDefault();
        showCommandPalette();
      }
    });

    // ==================== SPLIT SCREEN VIEW ====================
    let splitScreenActive = false;
    let splitSyncScroll = true;

    function toggleSplitScreen() {
      splitScreenActive = !splitScreenActive;
      const container = document.getElementById('splitScreenContainer');
      const wordContainer = document.getElementById('wordContainer');
      const btn = document.getElementById('splitScreenBtn');

      if (splitScreenActive) {
        // Populate saved documents dropdown
        const select = document.getElementById('splitDocSelect');
        select.innerHTML = '<option value="">Select document...</option>';
        const docs = getSavedDocuments();
        Object.entries(docs).forEach(([id, doc]) => {
          select.innerHTML += `<option value="${id}">${doc.name}</option>`;
        });

        // Copy current document to left pane
        document.getElementById('splitContentLeft').innerHTML = editor.innerHTML;

        container.classList.add('active');
        wordContainer.style.display = 'none';
        btn.classList.add('active');
        btn.style.background = '#1a73e8';
        btn.style.color = 'white';
        showToast('Split screen enabled. Select a document to compare.', 'info');

        // Initialize divider dragging
        initSplitDivider();
      } else {
        container.classList.remove('active');
        wordContainer.style.display = '';
        btn.classList.remove('active');
        btn.style.background = '';
        btn.style.color = '';
        showToast('Split screen disabled', 'info');
      }
    }

    function loadSplitDocument() {
      const select = document.getElementById('splitDocSelect');
      const docId = select.value;

      if (!docId) {
        document.getElementById('splitContentRight').innerHTML = '<p style="color: #666; text-align: center; margin-top: 2rem;">Select a document to compare</p>';
        document.getElementById('splitRightTitle').textContent = 'üìÑ Compare Document';
        return;
      }

      const docs = getSavedDocuments();
      const doc = docs[docId];
      if (doc) {
        document.getElementById('splitContentRight').innerHTML = doc.content;
        document.getElementById('splitRightTitle').textContent = `üìÑ ${doc.name}`;
      }
    }

    function onSplitScroll(side) {
      if (!splitSyncScroll) return;

      const left = document.getElementById('splitContentLeft');
      const right = document.getElementById('splitContentRight');

      if (side === 'left') {
        const scrollPercent = left.scrollTop / (left.scrollHeight - left.clientHeight);
        right.scrollTop = scrollPercent * (right.scrollHeight - right.clientHeight);
      } else {
        const scrollPercent = right.scrollTop / (right.scrollHeight - right.clientHeight);
        left.scrollTop = scrollPercent * (left.scrollHeight - left.clientHeight);
      }
    }

    function syncScrollLeft() {
      splitSyncScroll = !splitSyncScroll;
      showToast(splitSyncScroll ? 'Scroll sync enabled' : 'Scroll sync disabled', 'info');
    }

    function initSplitDivider() {
      const divider = document.getElementById('splitDivider');
      const leftPane = document.getElementById('splitPaneLeft');
      const rightPane = document.getElementById('splitPaneRight');
      let isDragging = false;

      divider.addEventListener('mousedown', (e) => {
        isDragging = true;
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const container = document.getElementById('splitScreenContainer');
        const containerRect = container.getBoundingClientRect();
        const percent = ((e.clientX - containerRect.left) / containerRect.width) * 100;

        if (percent > 20 && percent < 80) {
          leftPane.style.flex = `0 0 ${percent}%`;
          rightPane.style.flex = `0 0 ${100 - percent}%`;
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        document.body.style.cursor = '';
      });
    }

    // ==================== FEATURE TOUR ====================
    const tourSteps = [
      {
        element: '.tab-container',
        title: 'Ribbon Tabs',
        desc: 'Switch between different toolbars using these tabs. Each tab contains related tools and features.',
        position: 'bottom'
      },
      {
        element: '#homeToolbar',
        title: 'Home Toolbar',
        desc: 'Your most-used formatting tools - fonts, styles, alignment, and more. Start here for basic editing.',
        position: 'bottom'
      },
      {
        element: '#editor',
        title: 'Document Editor',
        desc: 'Type your content here. Select text to see the mini toolbar, or use Ctrl+Shift+P to open the Command Palette.',
        position: 'top'
      },
      {
        element: '.quick-access-toolbar',
        title: 'Quick Access Toolbar',
        desc: 'Customize this toolbar with your favorite commands. Click the dropdown to add or remove buttons.',
        position: 'bottom'
      },
      {
        element: '#sidebar',
        title: 'Sidebar',
        desc: 'Quick access to templates, document settings, and more. Collapse it for more editing space.',
        position: 'left'
      },
      {
        element: '.status-bar',
        title: 'Status Bar',
        desc: 'See word count, page count, and other document statistics. Click items for more options.',
        position: 'top'
      },
      {
        element: null,
        title: 'Pro Tips',
        desc: 'Press Ctrl+Shift+P for Command Palette, Ctrl+S to save, and F1 for keyboard shortcuts. Happy writing!',
        position: 'center'
      }
    ];

    let currentTourStep = 0;

    function startTour() {
      // Check if tour was completed before
      const tourCompleted = localStorage.getItem('ninjaword_tour_completed');
      currentTourStep = 0;
      document.getElementById('tourOverlay').classList.add('visible');
      showTourStep();
    }

    function showTourStep() {
      const step = tourSteps[currentTourStep];
      const highlight = document.getElementById('tourHighlight');
      const tooltip = document.getElementById('tourTooltip');
      const arrow = document.getElementById('tourArrow');

      // Update content
      document.getElementById('tourTitle').textContent = step.title;
      document.getElementById('tourDesc').textContent = step.desc;
      document.getElementById('tourNextBtn').textContent = currentTourStep === tourSteps.length - 1 ? 'Finish' : 'Next';

      // Update dots
      const dotsHtml = tourSteps.map((_, i) => `<div class="tour-dot ${i === currentTourStep ? 'active' : ''}"></div>`).join('');
      document.getElementById('tourDots').innerHTML = dotsHtml;

      // Reset arrow classes
      arrow.className = 'tour-arrow';

      if (step.element) {
        const el = document.querySelector(step.element);
        if (el) {
          const rect = el.getBoundingClientRect();
          const padding = 8;

          // Position highlight
          highlight.style.display = 'block';
          highlight.style.left = (rect.left - padding) + 'px';
          highlight.style.top = (rect.top - padding) + 'px';
          highlight.style.width = (rect.width + padding * 2) + 'px';
          highlight.style.height = (rect.height + padding * 2) + 'px';

          // Position tooltip based on position
          const tooltipWidth = 320;
          const tooltipHeight = 180;

          if (step.position === 'bottom') {
            tooltip.style.left = Math.max(20, Math.min(rect.left + rect.width / 2 - tooltipWidth / 2, window.innerWidth - tooltipWidth - 20)) + 'px';
            tooltip.style.top = (rect.bottom + 20) + 'px';
            arrow.classList.add('tour-arrow-top');
          } else if (step.position === 'top') {
            tooltip.style.left = Math.max(20, Math.min(rect.left + rect.width / 2 - tooltipWidth / 2, window.innerWidth - tooltipWidth - 20)) + 'px';
            tooltip.style.top = (rect.top - tooltipHeight - 20) + 'px';
            arrow.classList.add('tour-arrow-bottom');
          } else if (step.position === 'left') {
            tooltip.style.left = (rect.left - tooltipWidth - 30) + 'px';
            tooltip.style.top = Math.max(20, rect.top + rect.height / 2 - tooltipHeight / 2) + 'px';
            arrow.classList.add('tour-arrow-right');
          } else if (step.position === 'right') {
            tooltip.style.left = (rect.right + 30) + 'px';
            tooltip.style.top = Math.max(20, rect.top + rect.height / 2 - tooltipHeight / 2) + 'px';
            arrow.classList.add('tour-arrow-left');
          }
        }
      } else {
        // Center position (no element)
        highlight.style.display = 'none';
        tooltip.style.left = '50%';
        tooltip.style.top = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
        arrow.style.display = 'none';
      }
    }

    function nextTourStep() {
      currentTourStep++;
      if (currentTourStep >= tourSteps.length) {
        endTour();
      } else {
        // Reset transform for positioned tooltips
        document.getElementById('tourTooltip').style.transform = '';
        document.getElementById('tourArrow').style.display = '';
        showTourStep();
      }
    }

    function endTour() {
      document.getElementById('tourOverlay').classList.remove('visible');
      localStorage.setItem('ninjaword_tour_completed', 'true');
      showToast('Tour completed! Press Ctrl+Shift+P anytime for Command Palette.', 'success');
    }

    // Tour is now started from the welcome modal "Get Started" button
    // No confirm dialog needed

    // ==================== MINI TOOLBAR ====================
    let miniToolbarEnabled = true;
    let miniToolbarTimeout = null;

    function showMiniToolbar(x, y) {
      if (!miniToolbarEnabled) return;

      const toolbar = document.getElementById('miniToolbar');
      const selection = window.getSelection();

      // Only show if there's actual text selected
      if (!selection || selection.isCollapsed) {
        hideMiniToolbar();
        return;
      }

      // Position above the selection
      const viewportWidth = window.innerWidth;
      const toolbarWidth = 520; // approximate width

      // Adjust x to keep toolbar in viewport
      let adjustedX = x - (toolbarWidth / 2);
      if (adjustedX < 10) adjustedX = 10;
      if (adjustedX + toolbarWidth > viewportWidth - 10) {
        adjustedX = viewportWidth - toolbarWidth - 10;
      }

      // Position above cursor, with offset
      let adjustedY = y - 50;
      if (adjustedY < 10) adjustedY = y + 25; // Below if too high

      toolbar.style.left = adjustedX + 'px';
      toolbar.style.top = adjustedY + 'px';
      toolbar.classList.add('visible');
    }

    function hideMiniToolbar() {
      const toolbar = document.getElementById('miniToolbar');
      toolbar.classList.remove('visible');
    }

    function applyMiniFormat(command, value) {
      // Restore selection if lost
      document.execCommand(command, false, value || null);
      editor.focus();
    }

    function copyFromMini() {
      document.execCommand('copy');
      showToast('Copied to clipboard', 'success');
      hideMiniToolbar();
    }

    // Show mini toolbar on mouse up after selection
    editor.addEventListener('mouseup', function(e) {
      // Clear any pending timeout
      if (miniToolbarTimeout) {
        clearTimeout(miniToolbarTimeout);
      }

      // Small delay to let selection finalize
      miniToolbarTimeout = setTimeout(() => {
        const selection = window.getSelection();
        if (selection && !selection.isCollapsed && selection.toString().trim().length > 0) {
          const range = selection.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          showMiniToolbar(rect.left + (rect.width / 2), rect.top + window.scrollY);
        }
      }, 200);
    });

    // Hide mini toolbar on click outside or when selection is cleared
    document.addEventListener('mousedown', function(e) {
      const toolbar = document.getElementById('miniToolbar');
      if (!toolbar.contains(e.target) && e.target !== toolbar) {
        // Small delay to avoid hiding when clicking toolbar buttons
        setTimeout(() => {
          const selection = window.getSelection();
          if (!selection || selection.isCollapsed) {
            hideMiniToolbar();
          }
        }, 100);
      }
    });

    // Hide on escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideMiniToolbar();
      }
    });

    // ==================== FORMAT PAINTER ====================
    let formatPainterActive = false;
    let copiedFormat = null;

    function toggleFormatPainter() {
      const btn = document.getElementById('formatPainterBtn');

      if (formatPainterActive) {
        // Deactivate
        formatPainterActive = false;
        copiedFormat = null;
        btn.classList.remove('active');
        editor.classList.remove('format-painter-cursor');
        showToast('Format Painter deactivated', 'info');
        return;
      }

      // Copy format from current selection
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text to copy its format', 'warning');
        return;
      }

      const range = selection.getRangeAt(0);
      let element = range.startContainer;

      // Get the parent element if we're in a text node
      if (element.nodeType === Node.TEXT_NODE) {
        element = element.parentElement;
      }

      // Copy computed styles
      const computed = window.getComputedStyle(element);
      copiedFormat = {
        fontFamily: computed.fontFamily,
        fontSize: computed.fontSize,
        fontWeight: computed.fontWeight,
        fontStyle: computed.fontStyle,
        textDecoration: computed.textDecoration,
        color: computed.color,
        backgroundColor: computed.backgroundColor,
        textTransform: computed.textTransform
      };

      formatPainterActive = true;
      btn.classList.add('active');
      editor.classList.add('format-painter-cursor');
      showToast('Format copied! Click on text to apply', 'success');
    }

    // Apply format on mouseup when format painter is active
    editor.addEventListener('mouseup', function(e) {
      if (!formatPainterActive || !copiedFormat) return;

      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) return;

      const range = selection.getRangeAt(0);

      // Create a span with the copied format
      const span = document.createElement('span');
      span.style.fontFamily = copiedFormat.fontFamily;
      span.style.fontSize = copiedFormat.fontSize;
      span.style.fontWeight = copiedFormat.fontWeight;
      span.style.fontStyle = copiedFormat.fontStyle;
      span.style.textDecoration = copiedFormat.textDecoration;
      span.style.color = copiedFormat.color;
      if (copiedFormat.backgroundColor !== 'rgba(0, 0, 0, 0)' && copiedFormat.backgroundColor !== 'transparent') {
        span.style.backgroundColor = copiedFormat.backgroundColor;
      }
      span.style.textTransform = copiedFormat.textTransform;

      // Wrap selection in the styled span
      try {
        const fragment = range.extractContents();
        span.appendChild(fragment);
        range.insertNode(span);

        // Deactivate format painter after use (single use)
        formatPainterActive = false;
        copiedFormat = null;
        document.getElementById('formatPainterBtn').classList.remove('active');
        editor.classList.remove('format-painter-cursor');

        showToast('Format applied!', 'success');
      } catch (err) {
        console.error('Format painter error:', err);
        showToast('Could not apply format to this selection', 'error');
      }
    });

    // ESC key to cancel format painter
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && formatPainterActive) {
        formatPainterActive = false;
        copiedFormat = null;
        document.getElementById('formatPainterBtn').classList.remove('active');
        editor.classList.remove('format-painter-cursor');
        showToast('Format Painter cancelled', 'info');
      }
    });

    // Highlight Color Palette
    let highlightPalette = null;

    const highlightColors = [
      { name: 'Yellow', color: '#ffff00' },
      { name: 'Bright Green', color: '#00ff00' },
      { name: 'Cyan', color: '#00ffff' },
      { name: 'Pink', color: '#ff00ff' },
      { name: 'Blue', color: '#0000ff' },
      { name: 'Red', color: '#ff0000' },
      { name: 'Dark Blue', color: '#000080' },
      { name: 'Teal', color: '#008080' },
      { name: 'Green', color: '#008000' },
      { name: 'Violet', color: '#800080' },
      { name: 'Dark Red', color: '#800000' },
      { name: 'Dark Yellow', color: '#808000' },
      { name: 'Gray 50%', color: '#808080' },
      { name: 'Gray 25%', color: '#c0c0c0' },
      { name: 'Orange', color: '#ff9900' },
      { name: 'No Color', color: 'transparent' }
    ];

    function showHighlightPalette(event) {
      event.stopPropagation();

      // Remove existing palette if any
      if (highlightPalette) {
        highlightPalette.remove();
        highlightPalette = null;
        return;
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      highlightPalette = document.createElement('div');
      highlightPalette.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
        width: 160px;
      `;

      highlightColors.forEach(item => {
        const swatch = document.createElement('div');
        swatch.style.cssText = `
          width: 32px;
          height: 24px;
          background: ${item.color === 'transparent' ? 'linear-gradient(45deg, #fff 45%, #ff0000 45%, #ff0000 55%, #fff 55%)' : item.color};
          border: 1px solid #999;
          border-radius: 3px;
          cursor: pointer;
        `;
        swatch.title = item.name;
        swatch.onclick = () => {
          applyHighlight(item.color);
          highlightPalette.remove();
          highlightPalette = null;
        };
        highlightPalette.appendChild(swatch);
      });

      document.body.appendChild(highlightPalette);

      // Close on click outside
      setTimeout(() => {
        document.addEventListener('click', closeHighlightPalette);
      }, 10);
    }

    function closeHighlightPalette(e) {
      if (highlightPalette && !highlightPalette.contains(e.target)) {
        highlightPalette.remove();
        highlightPalette = null;
        document.removeEventListener('click', closeHighlightPalette);
      }
    }

    function applyHighlight(color) {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('Select some text first', 'warning');
        return;
      }

      document.execCommand('hiliteColor', false, color);
      showToast(color === 'transparent' ? 'Highlight removed' : 'Highlight applied', 'success');
    }

    // Paragraph Borders & Shading
    let bordersPalette = null;

    const borderOptions = [
      { name: 'No Border', icon: '‚¨ú', border: 'none' },
      { name: 'Box', icon: '‚ñ¢', border: '1px solid #000' },
      { name: 'Shadow', icon: '‚ñ®', border: '1px solid #000', shadow: '3px 3px 0 #888' },
      { name: 'Top', icon: '‚ñî', border: 'none', borderTop: '1px solid #000' },
      { name: 'Bottom', icon: '‚ñÅ', border: 'none', borderBottom: '1px solid #000' },
      { name: 'Left', icon: '‚ñè', border: 'none', borderLeft: '1px solid #000' },
      { name: 'Right', icon: '‚ñï', border: 'none', borderRight: '1px solid #000' },
      { name: 'Top & Bottom', icon: '‚ò∞', border: 'none', borderTop: '1px solid #000', borderBottom: '1px solid #000' },
      { name: 'Thick Box', icon: '‚óº', border: '3px solid #000' },
      { name: 'Double', icon: '‚ßà', border: '3px double #000' },
      { name: 'Dashed', icon: '‚¨ö', border: '1px dashed #000' },
      { name: 'Dotted', icon: '‚†ø', border: '1px dotted #000' }
    ];

    function showParagraphBorders(event) {
      event.stopPropagation();

      // Remove existing palette
      if (bordersPalette) {
        bordersPalette.remove();
        bordersPalette = null;
        return;
      }

      const btn = event.target;
      const rect = btn.getBoundingClientRect();

      bordersPalette = document.createElement('div');
      bordersPalette.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 5}px;
        left: ${rect.left}px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
        width: 220px;
      `;

      borderOptions.forEach(opt => {
        const item = document.createElement('div');
        item.style.cssText = `
          width: 48px;
          height: 36px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          border: 1px solid #ddd;
          border-radius: 3px;
          cursor: pointer;
          font-size: 16px;
          transition: background 0.2s;
        `;
        item.innerHTML = `<span>${opt.icon}</span><span style="font-size:9px;">${opt.name}</span>`;
        item.title = opt.name;
        item.onmouseover = () => item.style.background = '#e8f0fe';
        item.onmouseout = () => item.style.background = 'white';
        item.onclick = () => {
          applyParagraphBorder(opt);
          bordersPalette.remove();
          bordersPalette = null;
        };
        bordersPalette.appendChild(item);
      });

      // Add shading section
      const shadingLabel = document.createElement('div');
      shadingLabel.style.cssText = `
        grid-column: 1 / -1;
        padding: 8px 4px 4px;
        font-size: 11px;
        color: #666;
        border-top: 1px solid #eee;
        margin-top: 4px;
      `;
      shadingLabel.textContent = 'Shading:';
      bordersPalette.appendChild(shadingLabel);

      const shadingColors = ['transparent', '#fff2cc', '#d9ead3', '#cfe2f3', '#f4cccc', '#e6b8af', '#ead1dc', '#d9d2e9'];
      shadingColors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.style.cssText = `
          width: 48px;
          height: 24px;
          background: ${color === 'transparent' ? 'linear-gradient(45deg, #fff 45%, #ff0000 45%, #ff0000 55%, #fff 55%)' : color};
          border: 1px solid #999;
          border-radius: 3px;
          cursor: pointer;
        `;
        swatch.title = color === 'transparent' ? 'No Shading' : color;
        swatch.onclick = () => {
          applyParagraphShading(color);
          bordersPalette.remove();
          bordersPalette = null;
        };
        bordersPalette.appendChild(swatch);
      });

      document.body.appendChild(bordersPalette);

      setTimeout(() => {
        document.addEventListener('click', closeBordersPalette);
      }, 10);
    }

    function closeBordersPalette(e) {
      if (bordersPalette && !bordersPalette.contains(e.target)) {
        bordersPalette.remove();
        bordersPalette = null;
        document.removeEventListener('click', closeBordersPalette);
      }
    }

    function applyParagraphBorder(opt) {
      const selection = window.getSelection();
      if (!selection.rangeCount) {
        showToast('Place cursor in a paragraph first', 'warning');
        return;
      }

      // Find the paragraph element
      let node = selection.anchorNode;
      while (node && node.nodeType !== 1) {
        node = node.parentNode;
      }

      // Find closest block-level element
      const blockElements = ['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'BLOCKQUOTE', 'LI'];
      while (node && !blockElements.includes(node.tagName)) {
        node = node.parentNode;
      }

      if (!node || node.id === 'editor') {
        // Wrap in a div if no block element found
        document.execCommand('formatBlock', false, 'div');
        node = selection.anchorNode;
        while (node && node.nodeType !== 1) {
          node = node.parentNode;
        }
      }

      if (node && node.id !== 'editor') {
        node.style.border = opt.border;
        if (opt.borderTop) node.style.borderTop = opt.borderTop;
        if (opt.borderBottom) node.style.borderBottom = opt.borderBottom;
        if (opt.borderLeft) node.style.borderLeft = opt.borderLeft;
        if (opt.borderRight) node.style.borderRight = opt.borderRight;
        if (opt.shadow) {
          node.style.boxShadow = opt.shadow;
        } else {
          node.style.boxShadow = 'none';
        }
        node.style.padding = opt.border !== 'none' || opt.borderTop || opt.borderBottom ? '8px' : '';
        showToast(`${opt.name} border applied`, 'success');
      }
    }

    function applyParagraphShading(color) {
      const selection = window.getSelection();
      if (!selection.rangeCount) {
        showToast('Place cursor in a paragraph first', 'warning');
        return;
      }

      let node = selection.anchorNode;
      while (node && node.nodeType !== 1) {
        node = node.parentNode;
      }

      const blockElements = ['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'BLOCKQUOTE', 'LI'];
      while (node && !blockElements.includes(node.tagName)) {
        node = node.parentNode;
      }

      if (!node || node.id === 'editor') {
        document.execCommand('formatBlock', false, 'div');
        node = selection.anchorNode;
        while (node && node.nodeType !== 1) {
          node = node.parentNode;
        }
      }

      if (node && node.id !== 'editor') {
        node.style.backgroundColor = color;
        node.style.padding = color !== 'transparent' ? '8px' : '';
        showToast(color === 'transparent' ? 'Shading removed' : 'Shading applied', 'success');
      }
    }

    // ========== Hyphenation Controls ==========
    let hyphenationMode = 'none';
    let hyphenationPopup = null;

    function showHyphenation(event) {
      event.stopPropagation();

      const popup = document.getElementById('hyphenationPopup');
      if (popup.style.display === 'block') {
        hideHyphenation();
        return;
      }

      const btn = event.target.closest('button');
      const rect = btn.getBoundingClientRect();

      popup.style.display = 'block';
      popup.style.top = (rect.bottom + 5) + 'px';
      popup.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';

      // Update slider display
      const slider = document.getElementById('hyphenZone');
      slider.oninput = function() {
        document.getElementById('hyphenZoneValue').textContent = this.value + '"';
      };

      // Add click outside listener
      setTimeout(() => {
        document.addEventListener('click', closeHyphenationOnOutsideClick);
      }, 10);
    }

    function closeHyphenationOnOutsideClick(e) {
      const popup = document.getElementById('hyphenationPopup');
      if (!popup.contains(e.target) && !e.target.closest('#hyphenationBtn')) {
        hideHyphenation();
      }
    }

    function hideHyphenation() {
      document.getElementById('hyphenationPopup').style.display = 'none';
      document.removeEventListener('click', closeHyphenationOnOutsideClick);
    }

    function setHyphenation(mode) {
      hyphenationMode = mode;
      const editor = document.getElementById('editor');

      switch (mode) {
        case 'none':
          editor.style.hyphens = 'none';
          editor.style.webkitHyphens = 'none';
          editor.style.msHyphens = 'none';
          showToast('Hyphenation disabled', 'info');
          break;
        case 'auto':
          editor.style.hyphens = 'auto';
          editor.style.webkitHyphens = 'auto';
          editor.style.msHyphens = 'auto';
          editor.lang = 'en';
          showToast('Automatic hyphenation enabled', 'success');
          break;
        case 'manual':
          editor.style.hyphens = 'manual';
          editor.style.webkitHyphens = 'manual';
          editor.style.msHyphens = 'manual';
          showToast('Manual hyphenation enabled - use soft hyphens (Ctrl+Shift+-)', 'success');
          break;
      }

      // Update button state
      const btn = document.getElementById('hyphenationBtn');
      if (btn) {
        btn.classList.toggle('active', mode !== 'none');
      }

      hideHyphenation();
    }

    function applyHyphenationSettings() {
      const zone = document.getElementById('hyphenZone').value;
      const consecutive = document.getElementById('consecutiveHyphens').value;
      const editor = document.getElementById('editor');

      // Apply hyphenation zone as word-spacing approximation
      // CSS doesn't have direct hyphenation-zone, but we can simulate with text properties
      editor.style.textAlign = 'justify';
      editor.style.textJustify = 'inter-word';

      // Store settings for reference
      editor.dataset.hyphenZone = zone;
      editor.dataset.consecutiveHyphens = consecutive;

      if (hyphenationMode !== 'none') {
        showToast(`Hyphenation settings applied: zone ${zone}", max ${consecutive} consecutive`, 'success');
      }

      hideHyphenation();
    }

    // Add keyboard shortcut for soft hyphen (Ctrl+Shift+-)
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.shiftKey && e.key === '-') {
        e.preventDefault();
        // Insert soft hyphen (invisible hyphen that only shows when line breaks)
        document.execCommand('insertHTML', false, '&shy;');
        showToast('Soft hyphen inserted', 'info');
      }
    });

    // ========== Find Formatting ==========
    let foundFormattingElements = [];

    function showFindFormatting() {
      document.getElementById('findFormattingModal').classList.add('active');
      updateFindFormatOptions();
    }

    function hideFindFormatting() {
      document.getElementById('findFormattingModal').classList.remove('active');
      clearFoundFormatting();
    }

    function updateFindFormatOptions() {
      const type = document.getElementById('findFormatType').value;
      const colorOption = document.getElementById('formatColorOption');
      const fontOption = document.getElementById('formatFontOption');

      colorOption.style.display = (type === 'color' || type === 'bgcolor' || type === 'highlight') ? 'block' : 'none';
      fontOption.style.display = type === 'font' ? 'block' : 'none';

      // Set default color for highlight
      if (type === 'highlight') {
        document.getElementById('findFormatColor').value = '#ffff00';
      }
    }

    function findAllFormatting() {
      const type = document.getElementById('findFormatType').value;
      const editor = document.getElementById('editor');
      const resultsDiv = document.getElementById('findFormatResults');

      // Clear previous highlights
      clearFoundFormatting();

      foundFormattingElements = [];
      let selector = '';
      let checkFn = null;

      switch (type) {
        case 'highlight':
          const highlightColor = document.getElementById('findFormatColor').value.toLowerCase();
          checkFn = (el) => {
            const bg = window.getComputedStyle(el).backgroundColor;
            return bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent';
          };
          break;
        case 'bold':
          checkFn = (el) => {
            const weight = window.getComputedStyle(el).fontWeight;
            return weight === 'bold' || parseInt(weight) >= 700;
          };
          break;
        case 'italic':
          checkFn = (el) => window.getComputedStyle(el).fontStyle === 'italic';
          break;
        case 'underline':
          checkFn = (el) => window.getComputedStyle(el).textDecoration.includes('underline');
          break;
        case 'strikethrough':
          checkFn = (el) => window.getComputedStyle(el).textDecoration.includes('line-through');
          break;
        case 'color':
          const textColor = document.getElementById('findFormatColor').value;
          checkFn = (el) => {
            const color = window.getComputedStyle(el).color;
            return rgbToHex(color).toLowerCase() === textColor.toLowerCase();
          };
          break;
        case 'bgcolor':
          const bgColor = document.getElementById('findFormatColor').value;
          checkFn = (el) => {
            const bg = window.getComputedStyle(el).backgroundColor;
            return rgbToHex(bg).toLowerCase() === bgColor.toLowerCase();
          };
          break;
        case 'font':
          const fontName = document.getElementById('findFormatFont').value;
          checkFn = (el) => window.getComputedStyle(el).fontFamily.includes(fontName);
          break;
      }

      // Search through all text elements
      const walker = document.createTreeWalker(editor, NodeFilter.SHOW_ELEMENT);
      let node;
      while (node = walker.nextNode()) {
        if (node.childNodes.length === 1 && node.childNodes[0].nodeType === Node.TEXT_NODE) {
          if (checkFn && checkFn(node) && node.textContent.trim()) {
            foundFormattingElements.push(node);
          }
        }
      }

      // Also check direct children with formatting
      editor.querySelectorAll('b, strong, i, em, u, s, strike, span, font').forEach(el => {
        if (checkFn && checkFn(el) && el.textContent.trim() && !foundFormattingElements.includes(el)) {
          foundFormattingElements.push(el);
        }
      });

      // Update results display
      document.getElementById('formatResultCount').textContent = foundFormattingElements.length;

      if (foundFormattingElements.length === 0) {
        resultsDiv.innerHTML = '<p style="color: #666; text-align: center; margin: 1rem 0;">No matching formatted text found</p>';
      } else {
        resultsDiv.innerHTML = foundFormattingElements.map((el, idx) => {
          const text = el.textContent.substring(0, 50) + (el.textContent.length > 50 ? '...' : '');
          return `
            <div onclick="goToFormattedElement(${idx})" style="padding: 0.5rem; margin-bottom: 0.25rem; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
              <strong>#${idx + 1}:</strong> "${text}"
            </div>
          `;
        }).join('');

        // Highlight all found elements
        foundFormattingElements.forEach(el => {
          el.style.outline = '2px solid #1a73e8';
          el.style.outlineOffset = '2px';
        });

        showToast(`Found ${foundFormattingElements.length} formatted elements`, 'success');
      }
    }

    function goToFormattedElement(idx) {
      if (foundFormattingElements[idx]) {
        const el = foundFormattingElements[idx];
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Flash highlight
        el.style.outline = '3px solid #ea4335';
        setTimeout(() => {
          el.style.outline = '2px solid #1a73e8';
        }, 500);
      }
    }

    function clearFoundFormatting() {
      foundFormattingElements.forEach(el => {
        el.style.outline = '';
        el.style.outlineOffset = '';
      });
      foundFormattingElements = [];
      document.getElementById('formatResultCount').textContent = '0';
      document.getElementById('findFormatResults').innerHTML = '<p style="color: #666; text-align: center; margin: 1rem 0;">Click "Find All" to search</p>';
    }

    function rgbToHex(rgb) {
      if (!rgb || rgb === 'transparent' || rgb === 'rgba(0, 0, 0, 0)') return '#000000';
      const match = rgb.match(/\d+/g);
      if (!match || match.length < 3) return '#000000';
      return '#' + match.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
    }

    // ========== Envelopes & Labels ==========
    const labelProducts = {
      avery: {
        '5160': { rows: 10, cols: 3, width: '2.625in', height: '1in', name: 'Address' },
        '5163': { rows: 5, cols: 2, width: '4in', height: '2in', name: 'Shipping' },
        '5164': { rows: 2, cols: 3, width: '4in', height: '3.33in', name: 'Shipping Large' },
        '8163': { rows: 5, cols: 2, width: '4in', height: '2in', name: 'Shipping' },
        '5167': { rows: 20, cols: 4, width: '1.75in', height: '0.5in', name: 'Return Address' }
      }
    };

    const envelopeSizes = {
      '10': { width: '9.5in', height: '4.125in', name: 'Size 10' },
      '6': { width: '6.5in', height: '3.625in', name: 'Size 6' },
      '9': { width: '8.875in', height: '3.875in', name: 'Size 9' },
      'a2': { width: '5.75in', height: '4.375in', name: 'A2' },
      'c5': { width: '9.02in', height: '6.38in', name: 'C5' },
      'dl': { width: '8.66in', height: '4.33in', name: 'DL' }
    };

    function showEnvelopesLabels() {
      document.getElementById('envelopesLabelsModal').classList.add('active');
      updateEnvelopePreview();
      updateLabelPreview();

      // Add radio button listeners
      document.querySelectorAll('input[name="labelPrint"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.getElementById('singleLabelOptions').style.display =
            this.value === 'single' ? 'block' : 'none';
        });
      });
    }

    function hideEnvelopesLabels() {
      document.getElementById('envelopesLabelsModal').classList.remove('active');
    }

    function switchEnvelopeTab(tab) {
      const envelopeTab = document.getElementById('envelopeTab');
      const labelTab = document.getElementById('labelTab');
      const envelopeBtn = document.getElementById('envelopeTabBtn');
      const labelBtn = document.getElementById('labelTabBtn');

      if (tab === 'envelope') {
        envelopeTab.style.display = 'block';
        labelTab.style.display = 'none';
        envelopeBtn.style.background = '#1a73e8';
        envelopeBtn.style.color = 'white';
        labelBtn.style.background = '#f5f5f5';
        labelBtn.style.color = 'inherit';
      } else {
        envelopeTab.style.display = 'none';
        labelTab.style.display = 'block';
        labelBtn.style.background = '#1a73e8';
        labelBtn.style.color = 'white';
        envelopeBtn.style.background = '#f5f5f5';
        envelopeBtn.style.color = 'inherit';
      }
    }

    function updateEnvelopePreview() {
      const preview = document.getElementById('envelopePreview');
      const delivery = document.getElementById('deliveryAddress').value || 'Delivery Address';
      const returnAddr = document.getElementById('returnAddress').value || 'Return Address';
      const omitReturn = document.getElementById('omitReturnAddress').checked;
      const font = document.getElementById('envelopeFont').value;

      preview.innerHTML = `
        ${!omitReturn ? `<div style="position: absolute; top: 5px; left: 5px; font-family: ${font}; font-size: 8px; white-space: pre-line;">${returnAddr}</div>` : ''}
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-30%, -50%); font-family: ${font}; font-size: 10px; white-space: pre-line;">${delivery}</div>
      `;
    }

    function updateLabelPreview() {
      const preview = document.getElementById('labelPreview');
      const product = document.getElementById('labelProduct').value;
      const productInfo = labelProducts.avery[product] || labelProducts.avery['5160'];

      preview.style.gridTemplateColumns = `repeat(${productInfo.cols}, 1fr)`;
      preview.style.gridTemplateRows = `repeat(${productInfo.rows}, 1fr)`;

      let html = '';
      const totalLabels = productInfo.rows * productInfo.cols;
      for (let i = 0; i < Math.min(totalLabels, 30); i++) {
        html += `<div style="border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 6px; color: #999; overflow: hidden;">${i + 1}</div>`;
      }
      if (totalLabels > 30) {
        html += `<div style="grid-column: span ${productInfo.cols}; text-align: center; font-size: 8px; color: #666;">... ${totalLabels - 30} more labels</div>`;
      }

      preview.innerHTML = html;
    }

    function updateLabelProducts() {
      const vendor = document.getElementById('labelVendor').value;
      const productSelect = document.getElementById('labelProduct');

      // For simplicity, use same products for all vendors
      productSelect.innerHTML = `
        <option value="5160">5160 - Address (1" x 2.625", 30/sheet)</option>
        <option value="5163">5163 - Shipping (2" x 4", 10/sheet)</option>
        <option value="5164">5164 - Shipping (3.33" x 4", 6/sheet)</option>
        <option value="8163">8163 - Shipping (2" x 4", 10/sheet)</option>
        <option value="5167">5167 - Return Address (0.5" x 1.75", 80/sheet)</option>
      `;

      updateLabelPreview();
    }

    function insertEnvelopeLabel() {
      const isEnvelopeTab = document.getElementById('envelopeTab').style.display !== 'none';
      const editor = document.getElementById('editor');

      if (isEnvelopeTab) {
        // Insert envelope layout
        const delivery = document.getElementById('deliveryAddress').value || '';
        const returnAddr = document.getElementById('returnAddress').value || '';
        const omitReturn = document.getElementById('omitReturnAddress').checked;
        const size = document.getElementById('envelopeSize').value;
        const sizeInfo = envelopeSizes[size];
        const font = document.getElementById('envelopeFont').value;
        const fontSize = document.getElementById('envelopeFontSize').value;

        const envelopeHtml = `
          <div class="envelope-layout" style="width: ${sizeInfo.width}; height: ${sizeInfo.height}; border: 2px solid #333; position: relative; margin: 1rem auto; padding: 0.5in; page-break-after: always; background: #fffef0;">
            ${!omitReturn ? `<div style="position: absolute; top: 0.25in; left: 0.25in; font-family: ${font}; font-size: ${fontSize * 0.8}px; white-space: pre-line;">${returnAddr}</div>` : ''}
            <div style="position: absolute; top: 50%; left: 55%; transform: translate(-50%, -50%); font-family: ${font}; font-size: ${fontSize}px; white-space: pre-line; text-align: center;">${delivery}</div>
            <div style="position: absolute; top: 0.25in; right: 0.25in; width: 0.75in; height: 0.5in; border: 1px solid #999; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">STAMP</div>
          </div>
        `;

        editor.innerHTML += envelopeHtml;
        showToast('Envelope inserted into document', 'success');
      } else {
        // Insert labels layout
        const content = document.getElementById('labelContent').value || '';
        const product = document.getElementById('labelProduct').value;
        const productInfo = labelProducts.avery[product] || labelProducts.avery['5160'];
        const printType = document.querySelector('input[name="labelPrint"]:checked').value;

        let labelsHtml = `<div class="labels-sheet" style="width: 8.5in; margin: 0 auto; display: grid; grid-template-columns: repeat(${productInfo.cols}, 1fr); gap: 0; padding: 0.5in; page-break-after: always; border: 1px solid #ccc;">`;

        const totalLabels = productInfo.rows * productInfo.cols;

        if (printType === 'full') {
          for (let i = 0; i < totalLabels; i++) {
            labelsHtml += `<div style="width: ${productInfo.width}; height: ${productInfo.height}; border: 1px dashed #ccc; padding: 0.1in; font-size: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; white-space: pre-line;">${content}</div>`;
          }
        } else {
          const targetRow = parseInt(document.getElementById('labelRow').value) || 1;
          const targetCol = parseInt(document.getElementById('labelCol').value) || 1;
          const targetIndex = (targetRow - 1) * productInfo.cols + (targetCol - 1);

          for (let i = 0; i < totalLabels; i++) {
            const labelContent = i === targetIndex ? content : '';
            labelsHtml += `<div style="width: ${productInfo.width}; height: ${productInfo.height}; border: 1px dashed #ccc; padding: 0.1in; font-size: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; white-space: pre-line;">${labelContent}</div>`;
          }
        }

        labelsHtml += '</div>';
        editor.innerHTML += labelsHtml;
        showToast('Labels sheet inserted into document', 'success');
      }

      hideEnvelopesLabels();
    }

    function printEnvelopeLabel() {
      insertEnvelopeLabel();
      setTimeout(() => window.print(), 500);
    }

    // ========== Restrict Editing ==========
    let documentRestrictions = {
      enabled: false,
      formatRestrictions: false,
      editRestrictions: false,
      editType: 'none',
      password: '',
      exceptions: []
    };

    function showRestrictEditing() {
      const modal = document.getElementById('restrictEditingModal');
      modal.classList.add('active');

      // Update UI based on current restrictions
      document.getElementById('enableFormatRestrictions').checked = documentRestrictions.formatRestrictions;
      document.getElementById('enableEditRestrictions').checked = documentRestrictions.editRestrictions;
      document.getElementById('editRestrictionType').value = documentRestrictions.editType;
      document.getElementById('restrictPassword').value = '';

      // Update buttons based on current state
      const removeBtn = document.getElementById('removeRestrictionsBtn');
      const applyBtn = document.getElementById('applyRestrictionsBtn');
      if (documentRestrictions.enabled) {
        removeBtn.style.display = 'inline-block';
        applyBtn.textContent = 'Update Protection';
      } else {
        removeBtn.style.display = 'none';
        applyBtn.textContent = 'Yes, Start Enforcing Protection';
      }

      updateExceptionsList();
    }

    function hideRestrictEditing() {
      document.getElementById('restrictEditingModal').classList.remove('active');
    }

    function updateExceptionsList() {
      const container = document.getElementById('exceptionUsers');
      if (documentRestrictions.exceptions.length === 0) {
        container.innerHTML = '<span style="font-size: 0.85rem; color: #666;">No exceptions</span>';
      } else {
        container.innerHTML = documentRestrictions.exceptions.map((user, idx) => `
          <span style="display: inline-flex; align-items: center; background: #e3f2fd; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.85rem;">
            ${user}
            <button onclick="removeException(${idx})" style="border: none; background: none; cursor: pointer; margin-left: 0.25rem; color: #666;">&times;</button>
          </span>
        `).join('');
      }
    }

    function addEditException() {
      const user = prompt('Enter user name or email for exception:');
      if (user && user.trim()) {
        documentRestrictions.exceptions.push(user.trim());
        updateExceptionsList();
      }
    }

    function removeException(idx) {
      documentRestrictions.exceptions.splice(idx, 1);
      updateExceptionsList();
    }

    function applyRestrictions() {
      const formatRestrictions = document.getElementById('enableFormatRestrictions').checked;
      const editRestrictions = document.getElementById('enableEditRestrictions').checked;
      const editType = document.getElementById('editRestrictionType').value;
      const password = document.getElementById('restrictPassword').value;

      if (!formatRestrictions && !editRestrictions) {
        showToast('Please select at least one type of restriction', 'warning');
        return;
      }

      documentRestrictions = {
        enabled: true,
        formatRestrictions,
        editRestrictions,
        editType,
        password,
        exceptions: documentRestrictions.exceptions
      };

      const editor = document.getElementById('editor');

      // Apply editing restrictions
      if (editRestrictions) {
        switch (editType) {
          case 'none':
            // Read-only mode
            editor.contentEditable = 'false';
            editor.style.background = '#f9f9f9';
            editor.style.cursor = 'not-allowed';
            break;
          case 'tracked':
            // Enable track changes
            if (!trackChangesEnabled) {
              toggleTrackChanges();
            }
            break;
          case 'comments':
            // Allow only comments - disable direct editing
            editor.contentEditable = 'false';
            editor.style.cursor = 'default';
            // But comments can still be added via button
            break;
          case 'fillforms':
            // Only form fields can be edited
            editor.contentEditable = 'false';
            editor.querySelectorAll('input, select, textarea').forEach(el => {
              el.disabled = false;
            });
            break;
        }
      }

      // Apply formatting restrictions
      if (formatRestrictions) {
        // Disable formatting buttons
        document.querySelectorAll('.toolbar-btn').forEach(btn => {
          const title = btn.title || '';
          if (title.includes('Bold') || title.includes('Italic') || title.includes('Underline') ||
              title.includes('Font') || title.includes('Color') || title.includes('Size')) {
            btn.classList.add('restricted');
            btn.style.opacity = '0.5';
            btn.style.pointerEvents = 'none';
          }
        });
      }

      // Update button appearance
      const restrictBtn = document.getElementById('restrictEditBtn');
      if (restrictBtn) {
        restrictBtn.classList.add('active');
        restrictBtn.style.color = '#d93025';
      }

      hideRestrictEditing();
      showToast('Document protection enabled', 'success');
    }

    function removeRestrictions() {
      // Check password if set
      if (documentRestrictions.password) {
        const enteredPassword = prompt('Enter password to remove protection:');
        if (enteredPassword !== documentRestrictions.password) {
          showToast('Incorrect password', 'error');
          return;
        }
      }

      const editor = document.getElementById('editor');

      // Remove all restrictions
      editor.contentEditable = 'true';
      editor.style.background = '';
      editor.style.cursor = '';

      // Re-enable formatting buttons
      document.querySelectorAll('.toolbar-btn.restricted').forEach(btn => {
        btn.classList.remove('restricted');
        btn.style.opacity = '';
        btn.style.pointerEvents = '';
      });

      // Reset state
      documentRestrictions = {
        enabled: false,
        formatRestrictions: false,
        editRestrictions: false,
        editType: 'none',
        password: '',
        exceptions: []
      };

      // Update button appearance
      const restrictBtn = document.getElementById('restrictEditBtn');
      if (restrictBtn) {
        restrictBtn.classList.remove('active');
        restrictBtn.style.color = '';
      }

      hideRestrictEditing();
      showToast('Document protection removed', 'success');
    }

    // ==================== ACCESSIBILITY CHECKER ====================
    function showAccessibilityChecker() {
      document.getElementById('accessibilityModal').classList.add('active');
      clearAccessibilityResults();
    }

    function hideAccessibilityChecker() {
      document.getElementById('accessibilityModal').classList.remove('active');
    }

    function clearAccessibilityResults() {
      document.getElementById('accessibilityErrors').style.display = 'none';
      document.getElementById('accessibilityWarnings').style.display = 'none';
      document.getElementById('accessibilityTips').style.display = 'none';
      document.getElementById('accessibilitySuccess').style.display = 'none';
      document.getElementById('accessibilityEmpty').style.display = 'block';
      document.getElementById('accessibilityErrorList').innerHTML = '';
      document.getElementById('accessibilityWarningList').innerHTML = '';
      document.getElementById('accessibilityTipList').innerHTML = '';
    }

    function runAccessibilityCheck() {
      const editor = document.getElementById('editor');
      const errors = [];
      const warnings = [];
      const tips = [];

      // Check for images without alt text
      const images = editor.querySelectorAll('img');
      images.forEach((img, index) => {
        if (!img.alt || img.alt.trim() === '') {
          errors.push({
            type: 'Missing Alt Text',
            description: `Image ${index + 1} is missing alternative text.`,
            element: img,
            fix: 'addAltText',
            fixData: { element: img, index: index }
          });
        } else if (img.alt.toLowerCase() === 'image' || img.alt.toLowerCase() === 'picture') {
          warnings.push({
            type: 'Generic Alt Text',
            description: `Image ${index + 1} has generic alt text ("${img.alt}"). Consider using more descriptive text.`,
            element: img
          });
        }
      });

      // Check for tables without headers
      const tables = editor.querySelectorAll('table');
      tables.forEach((table, index) => {
        const hasHeader = table.querySelector('th') || table.querySelector('thead');
        if (!hasHeader) {
          warnings.push({
            type: 'Table Without Headers',
            description: `Table ${index + 1} doesn't have header cells. Consider adding <th> elements.`,
            element: table
          });
        }
      });

      // Check for empty headings
      const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
      headings.forEach((heading, index) => {
        if (heading.textContent.trim() === '') {
          errors.push({
            type: 'Empty Heading',
            description: `Empty ${heading.tagName} heading found. Remove or add content.`,
            element: heading
          });
        }
      });

      // Check heading hierarchy
      let lastLevel = 0;
      headings.forEach((heading) => {
        const level = parseInt(heading.tagName.charAt(1));
        if (level > lastLevel + 1 && lastLevel !== 0) {
          warnings.push({
            type: 'Heading Hierarchy Skip',
            description: `Heading level skipped (${lastLevel} to ${level}). Consider using sequential heading levels.`,
            element: heading
          });
        }
        lastLevel = level;
      });

      // Check for very long paragraphs (readability)
      const paragraphs = editor.querySelectorAll('p');
      paragraphs.forEach((p, index) => {
        const wordCount = p.textContent.trim().split(/\s+/).filter(w => w).length;
        if (wordCount > 150) {
          tips.push({
            type: 'Long Paragraph',
            description: `Paragraph ${index + 1} has ${wordCount} words. Consider breaking it into smaller paragraphs for better readability.`,
            element: p
          });
        }
      });

      // Check for low contrast (text same or similar to background)
      const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT);
      const checkedElements = new Set();
      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (node.textContent.trim() && node.parentElement && !checkedElements.has(node.parentElement)) {
          checkedElements.add(node.parentElement);
          const style = window.getComputedStyle(node.parentElement);
          const color = style.color;
          const bgColor = style.backgroundColor;
          if (color === bgColor && color !== 'rgba(0, 0, 0, 0)') {
            warnings.push({
              type: 'Low Contrast Text',
              description: 'Text color is the same as background. May be invisible to some users.',
              element: node.parentElement
            });
          }
        }
      }

      // Check for links without text
      const links = editor.querySelectorAll('a');
      links.forEach((link, index) => {
        if (!link.textContent.trim() && !link.querySelector('img')) {
          errors.push({
            type: 'Empty Link',
            description: `Link ${index + 1} has no text or image. Screen readers cannot describe this link.`,
            element: link
          });
        }
        if (link.textContent.toLowerCase() === 'click here' || link.textContent.toLowerCase() === 'read more') {
          warnings.push({
            type: 'Non-descriptive Link Text',
            description: `Link "${link.textContent}" is not descriptive. Use meaningful link text.`,
            element: link
          });
        }
      });

      // Check for repeated words/phrases (possible copy errors)
      const fullText = editor.textContent;
      const repeatedWords = fullText.match(/\b(\w+)\s+\1\b/gi);
      if (repeatedWords && repeatedWords.length > 0) {
        tips.push({
          type: 'Repeated Words',
          description: `Found repeated words: "${repeatedWords.slice(0, 3).join('", "')}". This might be a typing error.`,
          element: null
        });
      }

      // Display results
      displayAccessibilityResults(errors, warnings, tips);
    }

    function displayAccessibilityResults(errors, warnings, tips) {
      document.getElementById('accessibilityEmpty').style.display = 'none';

      if (errors.length === 0 && warnings.length === 0 && tips.length === 0) {
        document.getElementById('accessibilitySuccess').style.display = 'block';
        return;
      }

      // Display errors
      if (errors.length > 0) {
        document.getElementById('accessibilityErrors').style.display = 'block';
        document.getElementById('accessibilityErrorList').innerHTML = errors.map((e, i) => `
          <div style="padding: 0.75rem; border-bottom: 1px solid #fce8e6; cursor: pointer;" onclick="highlightAccessibilityIssue(${i}, 'error')">
            <strong style="color: #d93025;">${e.type}</strong>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">${e.description}</p>
            ${e.fix === 'addAltText' ? `<button class="btn btn-sm btn-secondary" style="margin-top: 0.5rem;" onclick="event.stopPropagation(); promptAltText(${e.fixData.index})">Add Alt Text</button>` : ''}
          </div>
        `).join('');
        window.accessibilityErrors = errors;
      }

      // Display warnings
      if (warnings.length > 0) {
        document.getElementById('accessibilityWarnings').style.display = 'block';
        document.getElementById('accessibilityWarningList').innerHTML = warnings.map((w, i) => `
          <div style="padding: 0.75rem; border-bottom: 1px solid #fef3e0; cursor: pointer;" onclick="highlightAccessibilityIssue(${i}, 'warning')">
            <strong style="color: #f9ab00;">${w.type}</strong>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">${w.description}</p>
          </div>
        `).join('');
        window.accessibilityWarnings = warnings;
      }

      // Display tips
      if (tips.length > 0) {
        document.getElementById('accessibilityTips').style.display = 'block';
        document.getElementById('accessibilityTipList').innerHTML = tips.map((t, i) => `
          <div style="padding: 0.75rem; border-bottom: 1px solid #e8f0fe; cursor: pointer;" onclick="highlightAccessibilityIssue(${i}, 'tip')">
            <strong style="color: #1a73e8;">${t.type}</strong>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">${t.description}</p>
          </div>
        `).join('');
        window.accessibilityTips = tips;
      }

      showToast(`Found ${errors.length} errors, ${warnings.length} warnings, ${tips.length} tips`, errors.length > 0 ? 'error' : 'info');
    }

    function highlightAccessibilityIssue(index, type) {
      // Clear previous highlights
      document.querySelectorAll('.accessibility-highlight').forEach(el => {
        el.classList.remove('accessibility-highlight');
        el.style.outline = '';
      });

      let issue;
      if (type === 'error') issue = window.accessibilityErrors[index];
      else if (type === 'warning') issue = window.accessibilityWarnings[index];
      else issue = window.accessibilityTips[index];

      if (issue && issue.element) {
        issue.element.classList.add('accessibility-highlight');
        issue.element.style.outline = '3px solid ' + (type === 'error' ? '#d93025' : type === 'warning' ? '#f9ab00' : '#1a73e8');
        issue.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function promptAltText(imageIndex) {
      const images = document.getElementById('editor').querySelectorAll('img');
      if (images[imageIndex]) {
        const altText = prompt('Enter alternative text for this image:', '');
        if (altText !== null) {
          images[imageIndex].alt = altText;
          showToast('Alt text added successfully', 'success');
          runAccessibilityCheck(); // Re-run check
        }
      }
    }

    // ==================== DICTATION / VOICE INPUT ====================
    let recognition = null;
    let isDictating = false;

    function toggleDictation() {
      if (isDictating) {
        stopDictation();
      } else {
        startDictation();
      }
    }

    function startDictation() {
      // Check for browser support
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showToast('Speech recognition not supported in this browser. Try Chrome or Edge.', 'error');
        return;
      }

      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      let finalTranscript = '';
      let interimSpan = null;

      recognition.onstart = () => {
        isDictating = true;
        const btn = document.getElementById('dictationBtn');
        btn.style.background = '#d93025';
        btn.style.color = 'white';
        btn.innerHTML = 'üé§ Stop';
        showToast('Dictation started. Speak now...', 'info');

        // Focus editor
        document.getElementById('editor').focus();
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript = transcript;

            // Insert final text
            const editor = document.getElementById('editor');
            const selection = window.getSelection();

            // Process voice commands
            let processedText = processVoiceCommands(finalTranscript);

            if (processedText !== null) {
              // Insert at cursor
              if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const textNode = document.createTextNode(processedText + ' ');
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
              } else {
                editor.innerHTML += processedText + ' ';
              }
            }

            // Remove interim display
            if (interimSpan && interimSpan.parentNode) {
              interimSpan.parentNode.removeChild(interimSpan);
              interimSpan = null;
            }

            finalTranscript = '';
          } else {
            interimTranscript += transcript;
          }
        }

        // Show interim results (greyed out)
        if (interimTranscript) {
          if (!interimSpan) {
            interimSpan = document.createElement('span');
            interimSpan.className = 'dictation-interim';
            interimSpan.style.color = '#999';
            interimSpan.style.fontStyle = 'italic';

            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
              const range = selection.getRangeAt(0);
              range.insertNode(interimSpan);
            }
          }
          interimSpan.textContent = interimTranscript;
        }
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'not-allowed') {
          showToast('Microphone access denied. Please allow microphone access.', 'error');
        } else if (event.error === 'no-speech') {
          showToast('No speech detected. Please try again.', 'warning');
        } else {
          showToast(`Dictation error: ${event.error}`, 'error');
        }
        stopDictation();
      };

      recognition.onend = () => {
        if (isDictating) {
          // Restart if still dictating (continuous mode)
          try {
            recognition.start();
          } catch (e) {
            stopDictation();
          }
        }
      };

      try {
        recognition.start();
      } catch (e) {
        showToast('Could not start dictation. Please try again.', 'error');
      }
    }

    function stopDictation() {
      isDictating = false;
      if (recognition) {
        recognition.stop();
        recognition = null;
      }

      const btn = document.getElementById('dictationBtn');
      btn.style.background = '';
      btn.style.color = '';
      btn.innerHTML = 'üé§ Dictate';

      // Remove any interim spans
      document.querySelectorAll('.dictation-interim').forEach(el => el.remove());

      showToast('Dictation stopped', 'info');
    }

    function processVoiceCommands(text) {
      const lowerText = text.toLowerCase().trim();

      // Punctuation commands
      if (lowerText === 'period' || lowerText === 'full stop') return '.';
      if (lowerText === 'comma') return ',';
      if (lowerText === 'question mark') return '?';
      if (lowerText === 'exclamation mark' || lowerText === 'exclamation point') return '!';
      if (lowerText === 'colon') return ':';
      if (lowerText === 'semicolon') return ';';
      if (lowerText === 'open quote' || lowerText === 'open quotation') return '"';
      if (lowerText === 'close quote' || lowerText === 'close quotation') return '"';
      if (lowerText === 'open parenthesis') return '(';
      if (lowerText === 'close parenthesis') return ')';
      if (lowerText === 'hyphen' || lowerText === 'dash') return '-';
      if (lowerText === 'new line' || lowerText === 'newline') {
        document.execCommand('insertLineBreak');
        return null;
      }
      if (lowerText === 'new paragraph') {
        document.execCommand('insertParagraph');
        return null;
      }

      // Formatting commands
      if (lowerText === 'bold' || lowerText === 'make bold') {
        formatDoc('bold');
        return null;
      }
      if (lowerText === 'italic' || lowerText === 'make italic') {
        formatDoc('italic');
        return null;
      }
      if (lowerText === 'underline' || lowerText === 'make underline') {
        formatDoc('underline');
        return null;
      }

      // Navigation/editing commands
      if (lowerText === 'delete' || lowerText === 'backspace') {
        document.execCommand('delete');
        return null;
      }
      if (lowerText === 'undo') {
        formatDoc('undo');
        return null;
      }
      if (lowerText === 'redo') {
        formatDoc('redo');
        return null;
      }
      if (lowerText === 'select all') {
        document.execCommand('selectAll');
        return null;
      }

      // Return the text with first letter capitalized if after punctuation
      return text;
    }

    // ==================== STOCK IMAGES ====================
    let selectedStockImage = null;

    function showStockImages() {
      document.getElementById('stockImagesModal').classList.add('active');
      document.getElementById('stockImageSearch').value = '';
      document.getElementById('stockImagesGrid').innerHTML = `
        <div style="grid-column: span 4; text-align: center; padding: 3rem; color: #666;">
          <div style="font-size: 48px; margin-bottom: 0.5rem;">üñºÔ∏è</div>
          <p>Search for images above or click a category to browse.</p>
        </div>
      `;
      document.getElementById('stockImagePreview').style.display = 'none';
      document.getElementById('insertStockBtn').disabled = true;
      selectedStockImage = null;
    }

    function hideStockImages() {
      document.getElementById('stockImagesModal').classList.remove('active');
    }

    function searchStockCategory(category) {
      document.getElementById('stockImageSearch').value = category;
      searchStockImages();
    }

    async function searchStockImages() {
      const query = document.getElementById('stockImageSearch').value.trim();
      if (!query) {
        showToast('Please enter a search term', 'warning');
        return;
      }

      const grid = document.getElementById('stockImagesGrid');
      grid.innerHTML = `
        <div style="grid-column: span 4; text-align: center; padding: 3rem; color: #666;">
          <div style="font-size: 32px; animation: spin 1s linear infinite;">‚è≥</div>
          <p>Searching for "${query}"...</p>
        </div>
      `;

      try {
        // Use Lorem Picsum for demo (free, no API key needed)
        // In production, you'd use Unsplash/Pexels/Pixabay APIs
        const images = await fetchStockImages(query);

        if (images.length === 0) {
          grid.innerHTML = `
            <div style="grid-column: span 4; text-align: center; padding: 3rem; color: #666;">
              <div style="font-size: 48px; margin-bottom: 0.5rem;">üòï</div>
              <p>No images found for "${query}". Try a different search term.</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = images.map((img, i) => `
          <div class="stock-image-thumb" onclick="selectStockImage(${i})" style="cursor: pointer; border-radius: 4px; overflow: hidden; aspect-ratio: 1; border: 2px solid transparent;" data-index="${i}">
            <img src="${img.thumb}" alt="${img.alt}" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
          </div>
        `).join('');

        window.stockImageResults = images;

      } catch (error) {
        console.error('Stock image search error:', error);
        grid.innerHTML = `
          <div style="grid-column: span 4; text-align: center; padding: 3rem; color: #666;">
            <div style="font-size: 48px; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
            <p>Failed to load images. Please try again.</p>
          </div>
        `;
      }
    }

    async function fetchStockImages(query) {
      // Generate sample images using Lorem Picsum (free placeholder service)
      // In production, replace with actual Unsplash/Pexels API calls
      const images = [];
      const seedBase = query.split('').reduce((a, b) => a + b.charCodeAt(0), 0);

      for (let i = 0; i < 20; i++) {
        const seed = seedBase + i;
        images.push({
          id: `img-${seed}`,
          thumb: `https://picsum.photos/seed/${seed}/200/200`,
          small: `https://picsum.photos/seed/${seed}/300/200`,
          medium: `https://picsum.photos/seed/${seed}/600/400`,
          large: `https://picsum.photos/seed/${seed}/1200/800`,
          original: `https://picsum.photos/seed/${seed}/1920/1280`,
          alt: `${query} image ${i + 1}`,
          credit: `Photo from Lorem Picsum ‚Ä¢ Free to use`
        });
      }

      // Simulate network delay
      await new Promise(resolve => setTimeout(resolve, 500));

      return images;
    }

    function selectStockImage(index) {
      selectedStockImage = window.stockImageResults[index];

      // Update selection UI
      document.querySelectorAll('.stock-image-thumb').forEach(el => {
        el.style.border = '2px solid transparent';
      });
      document.querySelector(`.stock-image-thumb[data-index="${index}"]`).style.border = '2px solid #1a73e8';

      // Show preview
      document.getElementById('stockImagePreview').style.display = 'block';
      document.getElementById('stockPreviewImg').src = selectedStockImage.medium;
      document.getElementById('stockImageCredit').textContent = selectedStockImage.credit;
      document.getElementById('insertStockBtn').disabled = false;
    }

    function insertStockImage() {
      if (!selectedStockImage) return;

      const size = document.getElementById('stockImageSize').value;
      let imageUrl;

      switch (size) {
        case 'small': imageUrl = selectedStockImage.small; break;
        case 'medium': imageUrl = selectedStockImage.medium; break;
        case 'large': imageUrl = selectedStockImage.large; break;
        case 'original': imageUrl = selectedStockImage.original; break;
        default: imageUrl = selectedStockImage.medium;
      }

      const editor = document.getElementById('editor');
      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = selectedStockImage.alt;
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.style.display = 'block';
      img.style.margin = '1rem auto';

      // Insert at cursor or at end
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(img);
      } else {
        editor.appendChild(img);
      }

      hideStockImages();
      showToast('Image inserted', 'success');
    }

    // ========== QR Code Generator ==========
    let currentQRType = 'url';
    let currentQRData = null;

    function showQRCodeGenerator() {
      document.getElementById('qrCodeModal').classList.add('active');
      selectQRType('url');
    }

    function hideQRCodeGenerator() {
      document.getElementById('qrCodeModal').classList.remove('active');
      currentQRData = null;
    }

    function selectQRType(type) {
      currentQRType = type;

      // Update buttons
      document.querySelectorAll('.qr-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });

      // Show/hide panels
      const panels = ['url', 'text', 'email', 'phone', 'wifi', 'vcard'];
      panels.forEach(panel => {
        const el = document.getElementById(`qr${panel.charAt(0).toUpperCase() + panel.slice(1)}Panel`);
        if (el) el.style.display = (panel === type) ? 'block' : 'none';
      });

      generateQRPreview();
    }

    function getQRContent() {
      switch (currentQRType) {
        case 'url':
          return document.getElementById('qrUrl').value.trim();
        case 'text':
          return document.getElementById('qrText').value.trim();
        case 'email':
          const email = document.getElementById('qrEmail').value.trim();
          const subject = document.getElementById('qrEmailSubject').value.trim();
          if (!email) return '';
          return subject ? `mailto:${email}?subject=${encodeURIComponent(subject)}` : `mailto:${email}`;
        case 'phone':
          const phone = document.getElementById('qrPhone').value.trim();
          return phone ? `tel:${phone}` : '';
        case 'wifi':
          const ssid = document.getElementById('qrWifiSsid').value.trim();
          const password = document.getElementById('qrWifiPassword').value;
          const security = document.getElementById('qrWifiSecurity').value;
          if (!ssid) return '';
          return `WIFI:T:${security};S:${ssid};P:${password};;`;
        case 'vcard':
          const first = document.getElementById('qrVcardFirst').value.trim();
          const last = document.getElementById('qrVcardLast').value.trim();
          const vphone = document.getElementById('qrVcardPhone').value.trim();
          const vemail = document.getElementById('qrVcardEmail').value.trim();
          const org = document.getElementById('qrVcardOrg').value.trim();
          if (!first && !last) return '';
          let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
          vcard += `N:${last};${first};;;\n`;
          vcard += `FN:${first} ${last}\n`;
          if (vphone) vcard += `TEL:${vphone}\n`;
          if (vemail) vcard += `EMAIL:${vemail}\n`;
          if (org) vcard += `ORG:${org}\n`;
          vcard += 'END:VCARD';
          return vcard;
        default:
          return '';
      }
    }

    function generateQRPreview() {
      const content = getQRContent();
      const size = parseInt(document.getElementById('qrSize').value);
      const preview = document.getElementById('qrPreview');

      if (!content) {
        preview.innerHTML = '<span style="color: #999;">Enter content to generate QR code</span>';
        currentQRData = null;
        return;
      }

      // Generate QR code using a simple SVG-based approach
      const qrSvg = generateQRSVG(content, size);
      preview.innerHTML = qrSvg;
      currentQRData = { content, size };
    }

    function generateQRSVG(data, size) {
      // Simple QR code generation using a basic algorithm
      // This creates a visual QR-like pattern based on the data hash
      // For production, you'd use a proper QR library like qrcode.js

      const modules = 25; // QR code module count
      const moduleSize = size / modules;

      // Create a deterministic pattern from the data
      const hash = simpleHash(data);
      const bits = [];

      // Generate QR-like pattern
      for (let i = 0; i < modules * modules; i++) {
        bits.push(((hash * (i + 1) * 31) % 100) > 50);
      }

      // Add finder patterns (the three corner squares)
      const addFinderPattern = (startRow, startCol) => {
        for (let r = 0; r < 7; r++) {
          for (let c = 0; c < 7; c++) {
            const idx = (startRow + r) * modules + (startCol + c);
            // Outer border
            if (r === 0 || r === 6 || c === 0 || c === 6) {
              bits[idx] = true;
            }
            // Inner white
            else if (r >= 1 && r <= 5 && c >= 1 && c <= 5) {
              bits[idx] = false;
            }
            // Center square
            if (r >= 2 && r <= 4 && c >= 2 && c <= 4) {
              bits[idx] = true;
            }
          }
        }
      };

      addFinderPattern(0, 0);  // Top-left
      addFinderPattern(0, modules - 7);  // Top-right
      addFinderPattern(modules - 7, 0);  // Bottom-left

      // Add timing patterns
      for (let i = 8; i < modules - 8; i++) {
        bits[6 * modules + i] = i % 2 === 0;
        bits[i * modules + 6] = i % 2 === 0;
      }

      // Generate SVG
      let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${modules} ${modules}">`;
      svg += `<rect width="${modules}" height="${modules}" fill="white"/>`;

      for (let row = 0; row < modules; row++) {
        for (let col = 0; col < modules; col++) {
          if (bits[row * modules + col]) {
            svg += `<rect x="${col}" y="${row}" width="1" height="1" fill="black"/>`;
          }
        }
      }

      svg += '</svg>';
      return svg;
    }

    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    }

    function insertQRCode() {
      if (!currentQRData) {
        showToast('Please enter content to generate a QR code', 'warning');
        return;
      }

      const preview = document.getElementById('qrPreview');
      const svg = preview.querySelector('svg');

      if (!svg) {
        showToast('No QR code generated', 'error');
        return;
      }

      // Convert SVG to data URL for insertion
      const svgData = new XMLSerializer().serializeToString(svg);
      const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);

      const img = document.createElement('img');
      img.src = url;
      img.alt = `QR Code: ${currentQRType}`;
      img.style.cssText = `width: ${currentQRData.size}px; height: ${currentQRData.size}px; display: inline-block; margin: 0.5rem;`;
      img.title = `QR Code containing ${currentQRType} data`;

      // Insert at cursor
      const editor = document.getElementById('editor');
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(img);
      } else {
        editor.appendChild(img);
      }

      hideQRCodeGenerator();
      showToast('QR Code inserted', 'success');
    }

    // ========== Auto-Save & Version History ==========
    let autoSaveEnabled = false;
    let autoSaveInterval = 60000; // 1 minute default
    let autoSaveTimer = null;
    let versionHistory = [];
    const VERSION_STORAGE_KEY = 'ninjaword_versions';
    const MAX_VERSIONS = 20;

    // Load saved settings on startup
    (function initAutoSave() {
      const savedVersions = localStorage.getItem(VERSION_STORAGE_KEY);
      if (savedVersions) {
        try {
          versionHistory = JSON.parse(savedVersions);
        } catch (e) {
          versionHistory = [];
        }
      }

      const savedAutoSave = localStorage.getItem('ninjaword_autosave');
      if (savedAutoSave === 'true') {
        autoSaveEnabled = true;
        startAutoSave();
        updateAutoSaveUI();
      }
    })();

    function toggleAutoSave() {
      autoSaveEnabled = !autoSaveEnabled;
      localStorage.setItem('ninjaword_autosave', autoSaveEnabled);

      if (autoSaveEnabled) {
        startAutoSave();
        showToast('Auto-Save enabled', 'success');
      } else {
        stopAutoSave();
        showToast('Auto-Save disabled', 'info');
      }

      updateAutoSaveUI();
    }

    function toggleAutoSaveFromModal() {
      const checkbox = document.getElementById('autoSaveCheckbox');
      autoSaveEnabled = checkbox.checked;
      localStorage.setItem('ninjaword_autosave', autoSaveEnabled);

      if (autoSaveEnabled) {
        startAutoSave();
      } else {
        stopAutoSave();
      }

      updateAutoSaveUI();
    }

    function updateAutoSaveUI() {
      const btn = document.getElementById('autoSaveBtn');
      const statusSpan = document.getElementById('autoSaveStatus');
      const checkbox = document.getElementById('autoSaveCheckbox');

      if (btn) {
        btn.innerHTML = autoSaveEnabled ? 'üíæ Auto-Save: On' : 'üíæ Auto-Save: Off';
        btn.style.background = autoSaveEnabled ? '#e8f5e9' : '';
        btn.style.color = autoSaveEnabled ? '#2e7d32' : '';
      }

      if (statusSpan) {
        statusSpan.textContent = autoSaveEnabled ? 'Enabled' : 'Disabled';
        statusSpan.style.color = autoSaveEnabled ? '#2e7d32' : '#d93025';
      }

      if (checkbox) {
        checkbox.checked = autoSaveEnabled;
      }
    }

    function startAutoSave() {
      stopAutoSave();
      autoSaveTimer = setInterval(() => {
        saveVersion('auto');
      }, autoSaveInterval);
    }

    function stopAutoSave() {
      if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
        autoSaveTimer = null;
      }
    }

    function updateAutoSaveInterval() {
      const select = document.getElementById('autoSaveInterval');
      autoSaveInterval = parseInt(select.value);

      if (autoSaveEnabled) {
        startAutoSave();
      }

      showToast(`Auto-save interval set to ${select.options[select.selectedIndex].text}`, 'info');
    }

    function saveVersion(type = 'manual') {
      const editor = document.getElementById('editor');
      const content = editor.innerHTML;

      // Don't save if content is empty or unchanged
      if (!content.trim() || content === '<p><br></p>') {
        return;
      }

      // Check if content is same as last version
      if (versionHistory.length > 0 && versionHistory[0].content === content) {
        return;
      }

      const version = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        type: type,
        content: content,
        wordCount: countWords(content),
        charCount: content.replace(/<[^>]*>/g, '').length
      };

      versionHistory.unshift(version);

      // Keep only MAX_VERSIONS
      if (versionHistory.length > MAX_VERSIONS) {
        versionHistory = versionHistory.slice(0, MAX_VERSIONS);
      }

      localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versionHistory));

      if (type === 'auto') {
        // Show subtle indicator
        const btn = document.getElementById('autoSaveBtn');
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = 'üíæ Saved!';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 1500);
        }
      }
    }

    function countWords(html) {
      const text = html.replace(/<[^>]*>/g, ' ').trim();
      return text ? text.split(/\s+/).length : 0;
    }

    function createManualVersion() {
      saveVersion('manual');
      showToast('Version saved', 'success');
      renderVersionList();
    }

    function showVersionHistory() {
      document.getElementById('versionHistoryModal').classList.add('active');
      updateAutoSaveUI();
      renderVersionList();
    }

    function hideVersionHistory() {
      document.getElementById('versionHistoryModal').classList.remove('active');
    }

    function renderVersionList() {
      const container = document.getElementById('versionList');

      if (versionHistory.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No versions saved yet</div>';
        return;
      }

      container.innerHTML = versionHistory.map((version, index) => {
        const date = new Date(version.timestamp);
        const timeStr = date.toLocaleString();
        const typeLabel = version.type === 'auto' ? 'üîÑ Auto-save' : 'üì∏ Manual';
        const isLatest = index === 0;

        return `
          <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; ${isLatest ? 'background: #e8f5e9;' : ''}">
            <div>
              <div style="font-weight: ${isLatest ? '600' : '400'};">
                ${typeLabel} ${isLatest ? '(Current)' : ''}
              </div>
              <div style="font-size: 0.85rem; color: #666;">
                ${timeStr} ¬∑ ${version.wordCount} words
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-sm btn-secondary" onclick="previewVersion(${index})" title="Preview">üëÅ</button>
              <button class="btn btn-sm btn-secondary" onclick="restoreVersion(${index})" title="Restore">‚Ü©</button>
              <button class="btn btn-sm btn-secondary" onclick="deleteVersion(${index})" title="Delete" style="color: #d93025;">üóë</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function previewVersion(index) {
      const version = versionHistory[index];
      if (!version) return;

      const preview = window.open('', '_blank', 'width=800,height=600');
      preview.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Version Preview - ${new Date(version.timestamp).toLocaleString()}</title>
          <style>
            body { font-family: Georgia, serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
            .header { background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
          </style>
        </head>
        <body>
          <div class="header">
            <strong>Version Preview</strong><br>
            Date: ${new Date(version.timestamp).toLocaleString()}<br>
            Type: ${version.type === 'auto' ? 'Auto-save' : 'Manual'}<br>
            Words: ${version.wordCount}
          </div>
          ${version.content}
        </body>
        </html>
      `);
    }

    function restoreVersion(index) {
      const version = versionHistory[index];
      if (!version) return;

      if (!confirm('Restore this version? Current content will be saved as a new version first.')) {
        return;
      }

      // Save current state first
      saveVersion('manual');

      // Restore the selected version
      const editor = document.getElementById('editor');
      editor.innerHTML = version.content;

      showToast('Version restored', 'success');
      hideVersionHistory();
    }

    function deleteVersion(index) {
      if (!confirm('Delete this version?')) return;

      versionHistory.splice(index, 1);
      localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versionHistory));
      renderVersionList();
      showToast('Version deleted', 'info');
    }

    function clearVersionHistory() {
      if (!confirm('Clear all version history? This cannot be undone.')) return;

      versionHistory = [];
      localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versionHistory));
      renderVersionList();
      showToast('Version history cleared', 'info');
    }

    // Save version before page unload
    window.addEventListener('beforeunload', () => {
      if (autoSaveEnabled) {
        saveVersion('auto');
      }
    });

    // ========== Recent Documents ==========
    const RECENT_DOCS_KEY = 'ninjaword_recent_documents';
    const MAX_RECENT_DOCS = 20;
    let recentDocuments = [];

    (function initRecentDocuments() {
      const saved = localStorage.getItem(RECENT_DOCS_KEY);
      if (saved) {
        try { recentDocuments = JSON.parse(saved); } catch(e) { recentDocuments = []; }
      }
    })();

    function addToRecentDocuments(name, content) {
      const doc = {
        id: Date.now(),
        name: name || 'Untitled Document',
        content: content,
        timestamp: new Date().toISOString(),
        wordCount: countWords(content),
        preview: content.replace(/<[^>]*>/g, '').substring(0, 150) + '...'
      };

      // Remove existing doc with same name
      recentDocuments = recentDocuments.filter(d => d.name !== doc.name);
      recentDocuments.unshift(doc);

      if (recentDocuments.length > MAX_RECENT_DOCS) {
        recentDocuments = recentDocuments.slice(0, MAX_RECENT_DOCS);
      }

      localStorage.setItem(RECENT_DOCS_KEY, JSON.stringify(recentDocuments));
    }

    function showRecentDocuments() {
      document.getElementById('recentDocumentsModal').classList.add('active');
      renderRecentDocuments();
    }

    function hideRecentDocuments() {
      document.getElementById('recentDocumentsModal').classList.remove('active');
    }

    function renderRecentDocuments(filter = '') {
      const container = document.getElementById('recentDocumentsList');
      const countSpan = document.getElementById('recentDocCount');

      let docs = recentDocuments;
      if (filter) {
        docs = docs.filter(d => d.name.toLowerCase().includes(filter.toLowerCase()));
      }

      countSpan.textContent = `${docs.length} document${docs.length !== 1 ? 's' : ''}`;

      if (docs.length === 0) {
        container.innerHTML = `
          <div style="padding: 2rem; text-align: center; color: #666;">
            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">${filter ? 'No matching documents' : 'No recent documents'}</p>
            <p style="font-size: 0.9rem;">${filter ? 'Try a different search' : 'Documents you save will appear here'}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = docs.map((doc, i) => {
        const date = new Date(doc.timestamp);
        const timeAgo = getTimeAgo(date);

        return `
          <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: background 0.2s;"
               onmouseenter="this.style.background='#f5f5f5'" onmouseleave="this.style.background=''"
               onclick="openRecentDocument(${i})">
            <div style="font-size: 2rem;">üìÑ</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.name}</div>
              <div style="font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.preview}</div>
              <div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                ${timeAgo} ¬∑ ${doc.wordCount} words
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); deleteRecentDocument(${i})" title="Delete">üóë</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    function filterRecentDocuments() {
      const filter = document.getElementById('recentSearchInput').value;
      renderRecentDocuments(filter);
    }

    function sortRecentDocuments() {
      const sortBy = document.getElementById('recentSortSelect').value;

      switch (sortBy) {
        case 'name':
          recentDocuments.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case 'size':
          recentDocuments.sort((a, b) => b.wordCount - a.wordCount);
          break;
        case 'date':
        default:
          recentDocuments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      }

      localStorage.setItem(RECENT_DOCS_KEY, JSON.stringify(recentDocuments));
      filterRecentDocuments();
    }

    function openRecentDocument(index) {
      const doc = recentDocuments[index];
      if (!doc) return;

      if (document.getElementById('editor').innerHTML.trim() &&
          document.getElementById('editor').innerHTML !== '<p><br></p>') {
        if (!confirm('Open this document? Current content will be replaced.')) return;
      }

      document.getElementById('editor').innerHTML = doc.content;
      document.getElementById('docTitle').textContent = doc.name;
      hideRecentDocuments();
      showToast(`Opened: ${doc.name}`, 'success');
    }

    function deleteRecentDocument(index) {
      if (!confirm('Remove this document from recent history?')) return;
      recentDocuments.splice(index, 1);
      localStorage.setItem(RECENT_DOCS_KEY, JSON.stringify(recentDocuments));
      filterRecentDocuments();
      showToast('Document removed from history', 'info');
    }

    function clearRecentDocuments() {
      if (!confirm('Clear all recent documents history?')) return;
      recentDocuments = [];
      localStorage.setItem(RECENT_DOCS_KEY, JSON.stringify(recentDocuments));
      renderRecentDocuments();
      showToast('Recent history cleared', 'info');
    }

    // Hook into save function to track recent documents
    const originalSaveDocument = window.saveDocument;
    window.saveDocument = function() {
      if (originalSaveDocument) originalSaveDocument();
      const editor = document.getElementById('editor');
      const title = document.getElementById('docTitle').textContent || 'Untitled Document';
      addToRecentDocuments(title, editor.innerHTML);
    };

    // ==================== QUICK ACCESS TOOLBAR ====================
    const qatCommands = [
      { id: 'save', icon: 'üíæ', label: 'Save', action: 'saveDocument()' },
      { id: 'undo', icon: '‚Ü∂', label: 'Undo', action: "formatDoc('undo')" },
      { id: 'redo', icon: '‚Ü∑', label: 'Redo', action: "formatDoc('redo')" },
      { id: 'pdf', icon: 'üìÑ', label: 'Export PDF', action: 'exportPDF()' },
      { id: 'print', icon: 'üñ®Ô∏è', label: 'Print', action: 'window.print()' },
      { id: 'new', icon: 'üìù', label: 'New Document', action: 'newDocument()' },
      { id: 'open', icon: 'üìÇ', label: 'Open', action: 'showOpenDialog()' },
      { id: 'find', icon: 'üîç', label: 'Find & Replace', action: 'showFindReplace()' },
      { id: 'spellcheck', icon: '‚úì', label: 'Spell Check', action: 'runSpellCheck()' },
      { id: 'wordcount', icon: 'üìä', label: 'Word Count', action: 'showWordCount()' },
      { id: 'bold', icon: 'B', label: 'Bold', action: "formatDoc('bold')" },
      { id: 'italic', icon: 'I', label: 'Italic', action: "formatDoc('italic')" },
      { id: 'underline', icon: 'U', label: 'Underline', action: "formatDoc('underline')" },
      { id: 'bullets', icon: '‚Ä¢', label: 'Bullet List', action: "formatDoc('insertUnorderedList')" },
      { id: 'numbering', icon: '#', label: 'Numbered List', action: "formatDoc('insertOrderedList')" },
      { id: 'table', icon: '‚äû', label: 'Insert Table', action: 'showTablePopup()' },
      { id: 'image', icon: 'üñºÔ∏è', label: 'Insert Image', action: 'insertImage()' },
      { id: 'link', icon: 'üîó', label: 'Insert Link', action: 'insertLink()' },
      { id: 'darkmode', icon: 'üåô', label: 'Dark Mode', action: 'toggleDarkMode()' },
      { id: 'focus', icon: 'üéØ', label: 'Focus Mode', action: 'toggleFocusMode()' }
    ];

    const defaultQATItems = ['save', 'undo', 'redo', 'pdf', 'print'];
    let qatItems = JSON.parse(localStorage.getItem('ninjaWordQAT')) || [...defaultQATItems];

    function renderQAT() {
      const toolbar = document.getElementById('quickAccessToolbar');
      let html = '';

      qatItems.forEach((itemId, index) => {
        const cmd = qatCommands.find(c => c.id === itemId);
        if (cmd) {
          html += `<button class="qat-btn" onclick="${cmd.action}" title="${cmd.label}">${cmd.icon}</button>`;
          if (index === 2 && qatItems.length > 3) {
            html += '<span class="qat-separator"></span>';
          }
        }
      });

      html += '<button class="qat-btn qat-customize" onclick="showQATCustomization()" title="Customize Quick Access Toolbar">‚ñº Customize</button>';
      toolbar.innerHTML = html;
    }

    function showQATCustomization() {
      const list = document.getElementById('qatCommandsList');
      list.innerHTML = qatCommands.map(cmd => `
        <label class="qat-modal-item">
          <input type="checkbox" value="${cmd.id}" ${qatItems.includes(cmd.id) ? 'checked' : ''}>
          <span style="font-size: 1.2rem;">${cmd.icon}</span>
          <span>${cmd.label}</span>
        </label>
      `).join('');
      document.getElementById('qatModal').classList.add('active');
    }

    function hideQATCustomization() {
      document.getElementById('qatModal').classList.remove('active');
    }

    function saveQATCustomization() {
      const checkboxes = document.querySelectorAll('#qatCommandsList input[type="checkbox"]:checked');
      qatItems = Array.from(checkboxes).map(cb => cb.value);
      if (qatItems.length === 0) {
        qatItems = [...defaultQATItems];
        showToast('At least one command is required. Reset to defaults.', 'warning');
      }
      localStorage.setItem('ninjaWordQAT', JSON.stringify(qatItems));
      renderQAT();
      hideQATCustomization();
      showToast('Quick Access Toolbar updated', 'success');
    }

    function resetQAT() {
      qatItems = [...defaultQATItems];
      localStorage.setItem('ninjaWordQAT', JSON.stringify(qatItems));
      renderQAT();
      hideQATCustomization();
      showToast('Quick Access Toolbar reset to defaults', 'info');
    }

    // Initialize QAT on load
    document.addEventListener('DOMContentLoaded', renderQAT);

    // ==================== FLOATING ACTION BUTTON ====================
    let fabOpen = false;

    function toggleFab() {
      fabOpen = !fabOpen;
      const fabMain = document.getElementById('fabMain');
      const fabMenu = document.getElementById('fabMenu');

      fabMain.classList.toggle('active', fabOpen);
      fabMenu.classList.toggle('visible', fabOpen);
    }

    // Close FAB when clicking outside
    document.addEventListener('click', function(e) {
      if (fabOpen && !e.target.closest('.fab-container')) {
        toggleFab();
      }
    });

    // ==================== GLOBAL SEARCH SPOTLIGHT ====================
    let spotlightSelectedIndex = 0;
    let spotlightItems = [];

    const spotlightActions = [
      { icon: 'üìÑ', title: 'New Document', desc: 'Create a blank document', action: () => newDocument(), shortcut: 'Ctrl+N' },
      { icon: 'üíæ', title: 'Save Document', desc: 'Save current document', action: () => saveDocument(), shortcut: 'Ctrl+S' },
      { icon: 'üìÇ', title: 'Open Document', desc: 'Open existing document', action: () => showOpenDialog(), shortcut: 'Ctrl+O' },
      { icon: 'üñ®Ô∏è', title: 'Print', desc: 'Print document', action: () => window.print(), shortcut: 'Ctrl+P' },
      { icon: 'üìã', title: 'Export PDF', desc: 'Export as PDF', action: () => exportPDF() },
      { icon: 'üîç', title: 'Find & Replace', desc: 'Search in document', action: () => showFindReplace(), shortcut: 'Ctrl+H' },
      { icon: 'üìä', title: 'Word Count', desc: 'Show document statistics', action: () => showWordCount() },
      { icon: 'üé®', title: 'Styles', desc: 'Apply text styles', action: () => showStylesPanel() },
      { icon: 'üìë', title: 'Table of Contents', desc: 'Insert TOC', action: () => insertTableOfContents() },
      { icon: 'üñºÔ∏è', title: 'Insert Image', desc: 'Add an image', action: () => insertImage() },
      { icon: '‚äû', title: 'Insert Table', desc: 'Add a table', action: () => insertTable() },
      { icon: 'Œ©', title: 'Insert Symbol', desc: 'Special characters', action: () => showSymbolPicker() },
      { icon: 'üåô', title: 'Toggle Dark Mode', desc: 'Switch theme', action: () => toggleDarkMode() },
      { icon: 'üéØ', title: 'Focus Mode', desc: 'Distraction-free writing', action: () => toggleFocusMode() },
      { icon: 'üìñ', title: 'Reading Mode', desc: 'Read-optimized view', action: () => toggleReadingMode() },
      { icon: '‚Ü∂', title: 'Undo History', desc: 'View edit history', action: () => toggleUndoHistory() },
      { icon: '‚å®Ô∏è', title: 'Keyboard Shortcuts', desc: 'View all shortcuts', action: () => showShortcutsModal(), shortcut: 'Ctrl+/' },
    ];

    function showSpotlight() {
      document.getElementById('spotlightOverlay').classList.add('visible');
      document.getElementById('spotlightInput').value = '';
      document.getElementById('spotlightInput').focus();
      spotlightSelectedIndex = 0;
      renderSpotlight('');
    }

    function hideSpotlight() {
      document.getElementById('spotlightOverlay').classList.remove('visible');
    }

    function renderSpotlight(query) {
      const docsContainer = document.getElementById('spotlightDocs');
      const actionsContainer = document.getElementById('spotlightActions');
      const q = query.toLowerCase();

      // Get recent documents
      const docs = getSavedDocuments();
      const docList = Object.entries(docs)
        .filter(([id, doc]) => !q || doc.name.toLowerCase().includes(q))
        .slice(0, 5)
        .map(([id, doc]) => ({
          icon: 'üìÑ',
          title: doc.name,
          desc: `Last modified: ${new Date(doc.lastModified || Date.now()).toLocaleDateString()}`,
          action: () => { openDocument(id); hideSpotlight(); }
        }));

      // Filter actions
      const filteredActions = spotlightActions
        .filter(a => !q || a.title.toLowerCase().includes(q) || a.desc.toLowerCase().includes(q))
        .slice(0, 8);

      spotlightItems = [...docList, ...filteredActions];

      // Render documents
      if (docList.length > 0) {
        docsContainer.innerHTML = docList.map((item, i) => `
          <div class="spotlight-item ${i === spotlightSelectedIndex ? 'selected' : ''}" onclick="executeSpotlightItem(${i})">
            <span class="spotlight-item-icon">${item.icon}</span>
            <div class="spotlight-item-content">
              <div class="spotlight-item-title">${item.title}</div>
              <div class="spotlight-item-desc">${item.desc}</div>
            </div>
          </div>
        `).join('');
      } else {
        docsContainer.innerHTML = '<div class="spotlight-item" style="color:#888;"><span class="spotlight-item-icon">üì≠</span><span>No documents found</span></div>';
      }

      // Render actions
      actionsContainer.innerHTML = filteredActions.map((item, i) => {
        const idx = docList.length + i;
        return `
          <div class="spotlight-item ${idx === spotlightSelectedIndex ? 'selected' : ''}" onclick="executeSpotlightItem(${idx})">
            <span class="spotlight-item-icon">${item.icon}</span>
            <div class="spotlight-item-content">
              <div class="spotlight-item-title">${item.title}</div>
              <div class="spotlight-item-desc">${item.desc}</div>
            </div>
            ${item.shortcut ? `<span class="spotlight-item-shortcut">${item.shortcut}</span>` : ''}
          </div>
        `;
      }).join('');
    }

    function filterSpotlight(query) {
      spotlightSelectedIndex = 0;
      renderSpotlight(query);
    }

    function executeSpotlightItem(index) {
      if (spotlightItems[index] && spotlightItems[index].action) {
        spotlightItems[index].action();
        hideSpotlight();
      }
    }

    // Keyboard navigation for spotlight
    document.getElementById('spotlightInput')?.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        spotlightSelectedIndex = Math.min(spotlightSelectedIndex + 1, spotlightItems.length - 1);
        renderSpotlight(this.value);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        spotlightSelectedIndex = Math.max(spotlightSelectedIndex - 1, 0);
        renderSpotlight(this.value);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        executeSpotlightItem(spotlightSelectedIndex);
      } else if (e.key === 'Escape') {
        hideSpotlight();
      }
    });

    // Ctrl+K to open spotlight
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        showSpotlight();
      }
    });

    // Close spotlight when clicking overlay
    document.getElementById('spotlightOverlay')?.addEventListener('click', function(e) {
      if (e.target === this) hideSpotlight();
    });

    // ==================== DRAG & DROP FILE IMPORT ====================
    const dropOverlay = document.getElementById('dropOverlay');
    let dragCounter = 0;

    document.addEventListener('dragenter', function(e) {
      e.preventDefault();
      dragCounter++;
      if (e.dataTransfer.types.includes('Files')) {
        dropOverlay.classList.add('visible');
      }
    });

    document.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dragCounter--;
      if (dragCounter === 0) {
        dropOverlay.classList.remove('visible');
      }
    });

    document.addEventListener('dragover', function(e) {
      e.preventDefault();
    });

    document.addEventListener('drop', function(e) {
      e.preventDefault();
      dragCounter = 0;
      dropOverlay.classList.remove('visible');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleDroppedFile(files[0]);
      }
    });

    function handleDroppedFile(file) {
      const fileName = file.name.toLowerCase();
      const extension = fileName.split('.').pop();

      if (['txt', 'html', 'htm', 'rtf'].includes(extension)) {
        const reader = new FileReader();
        reader.onload = function(e) {
          let content = e.target.result;

          if (extension === 'html' || extension === 'htm') {
            // Extract body content if it's HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            content = doc.body.innerHTML;
          } else if (extension === 'txt') {
            // Convert plain text to HTML paragraphs
            content = content.split('\n').map(line => `<p>${line || '<br>'}</p>`).join('');
          }

          editor.innerHTML = content;
          document.getElementById('fileName').value = file.name.replace(/\.[^/.]+$/, '');
          showToast(`Opened: ${file.name}`, 'success');
          saveToHistory();
        };
        reader.readAsText(file);
      } else if (extension === 'docx') {
        // Use mammoth.js if available
        if (typeof mammoth !== 'undefined') {
          const reader = new FileReader();
          reader.onload = function(e) {
            mammoth.convertToHtml({ arrayBuffer: e.target.result })
              .then(function(result) {
                editor.innerHTML = result.value;
                document.getElementById('fileName').value = file.name.replace(/\.[^/.]+$/, '');
                showToast(`Opened: ${file.name}`, 'success');
                saveToHistory();
              })
              .catch(function(err) {
                showToast('Error reading DOCX file', 'error');
                console.error(err);
              });
          };
          reader.readAsArrayBuffer(file);
        } else {
          showToast('DOCX import not available - try .txt or .html', 'warning');
        }
      } else {
        showToast(`Unsupported file type: .${extension}`, 'error');
      }
    }

    // ==================== KEYBOARD SHORTCUTS MODAL ====================
    function showShortcutsModal() {
      document.getElementById('shortcutsModal').classList.add('active');
    }

    function hideShortcutsModal() {
      document.getElementById('shortcutsModal').classList.remove('active');
    }

    // Ctrl+/ to show shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === '/') {
        e.preventDefault();
        showShortcutsModal();
      }
    });

    // ==================== CONTEXT MENU ====================
    const contextMenu = document.getElementById('contextMenu');

    // Show context menu on right-click in editor
    editor.addEventListener('contextmenu', function(e) {
      e.preventDefault();

      // Hide mini toolbar if visible
      hideMiniToolbar();

      // Position the menu
      const menuWidth = 220;
      const menuHeight = 400;
      let x = e.clientX;
      let y = e.clientY;

      // Keep menu in viewport
      if (x + menuWidth > window.innerWidth) {
        x = window.innerWidth - menuWidth - 10;
      }
      if (y + menuHeight > window.innerHeight) {
        y = window.innerHeight - menuHeight - 10;
      }

      contextMenu.style.left = x + 'px';
      contextMenu.style.top = y + 'px';
      contextMenu.classList.add('visible');

      // Update paste state based on clipboard
      updateContextMenuState();
    });

    // Hide context menu on click outside
    document.addEventListener('click', function(e) {
      if (!contextMenu.contains(e.target)) {
        contextMenu.classList.remove('visible');
      }
    });

    // Hide on scroll
    editor.addEventListener('scroll', function() {
      contextMenu.classList.remove('visible');
    });

    // Hide on escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        contextMenu.classList.remove('visible');
      }
    });

    function updateContextMenuState() {
      const selection = window.getSelection();
      const hasSelection = selection && !selection.isCollapsed;

      // Disable cut/copy if no selection
      const cutItem = contextMenu.querySelector('[onclick*="cut"]');
      const copyItem = contextMenu.querySelector('[onclick*="copy"]');

      if (cutItem) cutItem.classList.toggle('disabled', !hasSelection);
      if (copyItem) copyItem.classList.toggle('disabled', !hasSelection);
    }

    function contextMenuAction(action) {
      contextMenu.classList.remove('visible');
      editor.focus();

      switch(action) {
        case 'cut':
          document.execCommand('cut');
          showToast('Cut to clipboard', 'success');
          break;
        case 'copy':
          document.execCommand('copy');
          showToast('Copied to clipboard', 'success');
          break;
        case 'paste':
          navigator.clipboard.readText().then(text => {
            document.execCommand('insertText', false, text);
            showToast('Pasted from clipboard', 'success');
          }).catch(() => {
            document.execCommand('paste');
          });
          break;
        case 'selectAll':
          // Select all content in editor
          const range = document.createRange();
          range.selectNodeContents(editor);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          showToast('All content selected', 'info');
          break;
        case 'bold':
          document.execCommand('bold');
          break;
        case 'italic':
          document.execCommand('italic');
          break;
        case 'underline':
          document.execCommand('underline');
          break;
        case 'link':
          insertLink();
          break;
        case 'comment':
          addComment();
          break;
        case 'paragraph':
          showParagraphSettings();
          break;
        case 'font':
          // Switch to Home tab to show font options
          switchTab('home');
          showToast('Use the Home toolbar for font settings', 'info');
          break;
        case 'find':
          showFindReplace();
          break;
        case 'spellcheck':
          checkSpelling();
          break;
        default:
          showToast('Action: ' + action, 'info');
      }
    }

    // ==================== STATUS BAR INTERACTIONS ====================
    let currentLanguage = { code: 'en-US', name: 'English (US)', flag: 'üá∫üá∏' };

    // Zoom Popup
    function showZoomPopup() {
      hideAllStatusPopups();
      document.getElementById('zoomPopup').classList.add('visible');
      document.getElementById('zoomSlider').value = currentZoom;
      updateZoomPresetButtons();
    }

    function hideZoomPopup() {
      document.getElementById('zoomPopup').classList.remove('visible');
    }

    function setZoomFromSlider(value) {
      setZoomLevel(parseInt(value));
    }

    function setZoomLevel(level) {
      currentZoom = level;
      document.getElementById('statusZoom').textContent = level + '%';
      document.getElementById('zoomSlider').value = level;
      editor.style.transform = `scale(${level / 100})`;
      editor.style.transformOrigin = 'top left';
      editor.style.width = (100 / (level / 100)) + '%';
      updateZoomPresetButtons();
      localStorage.setItem('ninjaword_zoom', level);
    }

    function updateZoomPresetButtons() {
      document.querySelectorAll('.zoom-preset-btn').forEach(btn => {
        const btnLevel = parseInt(btn.textContent);
        btn.classList.toggle('active', btnLevel === currentZoom);
      });
    }

    // Language Popup
    function showLanguagePopup() {
      hideAllStatusPopups();
      document.getElementById('languagePopup').classList.add('visible');
    }

    function hideLanguagePopup() {
      document.getElementById('languagePopup').classList.remove('visible');
    }

    function setLanguage(code, name, flag) {
      currentLanguage = { code, name, flag };
      document.getElementById('langIndicator').textContent = name;
      document.querySelectorAll('.language-option').forEach(opt => {
        opt.classList.toggle('active', opt.textContent.includes(name));
      });
      localStorage.setItem('ninjaword_language', JSON.stringify(currentLanguage));
      hideLanguagePopup();
      showToast(`Language set to ${name}`, 'info');
    }

    // Page Navigation Popup
    function showPageNavPopup() {
      hideAllStatusPopups();
      const popup = document.getElementById('pageNavPopup');
      const total = parseInt(document.getElementById('totalPages').textContent);
      const current = parseInt(document.getElementById('currentPage').textContent);
      document.getElementById('pageNavTotal').textContent = total;
      document.getElementById('pageNavInput').value = current;
      document.getElementById('pageNavInput').max = total;
      popup.classList.add('visible');
    }

    function hidePageNavPopup() {
      document.getElementById('pageNavPopup').classList.remove('visible');
    }

    function goToPage() {
      const input = document.getElementById('pageNavInput');
      const pageNum = parseInt(input.value);
      const total = parseInt(document.getElementById('totalPages').textContent);

      if (pageNum >= 1 && pageNum <= total) {
        // Calculate approximate scroll position
        const pageHeight = 1056; // Standard page height in pixels
        const scrollTarget = (pageNum - 1) * pageHeight;
        editor.parentElement.scrollTo({ top: scrollTarget, behavior: 'smooth' });
        document.getElementById('currentPage').textContent = pageNum;
        hidePageNavPopup();
        showToast(`Navigated to page ${pageNum}`, 'info');
      } else {
        showToast(`Invalid page number (1-${total})`, 'error');
      }
    }

    function goToFirstPage() {
      document.getElementById('pageNavInput').value = 1;
      goToPage();
    }

    function goToPrevPage() {
      const current = parseInt(document.getElementById('pageNavInput').value);
      if (current > 1) {
        document.getElementById('pageNavInput').value = current - 1;
        goToPage();
      }
    }

    function goToNextPage() {
      const current = parseInt(document.getElementById('pageNavInput').value);
      const total = parseInt(document.getElementById('totalPages').textContent);
      if (current < total) {
        document.getElementById('pageNavInput').value = current + 1;
        goToPage();
      }
    }

    function goToLastPage() {
      const total = parseInt(document.getElementById('totalPages').textContent);
      document.getElementById('pageNavInput').value = total;
      goToPage();
    }

    // Auto-save Status Toggle
    function toggleAutoSaveStatus() {
      autoSaveEnabled = !autoSaveEnabled;
      localStorage.setItem('ninjaword_autosave', autoSaveEnabled);

      const icon = document.getElementById('autoSaveStatusIcon');
      const text = document.getElementById('autoSaveStatusText');

      if (autoSaveEnabled) {
        icon.textContent = 'üíæ';
        text.textContent = 'Auto-save On';
        initAutoSave();
        showToast('Auto-save enabled', 'success');
      } else {
        icon.textContent = '‚è∏Ô∏è';
        text.textContent = 'Auto-save Off';
        if (autoSaveInterval) {
          clearInterval(autoSaveInterval);
          autoSaveInterval = null;
        }
        showToast('Auto-save disabled', 'info');
      }
    }

    // Helper to hide all popups
    function hideAllStatusPopups() {
      hideZoomPopup();
      hideLanguagePopup();
      hidePageNavPopup();
    }

    // Close popups when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.zoom-popup') && !e.target.closest('.status-bar-item[onclick*="showZoomPopup"]')) {
        hideZoomPopup();
      }
      if (!e.target.closest('.language-popup') && !e.target.closest('.status-bar-item[onclick*="showLanguagePopup"]')) {
        hideLanguagePopup();
      }
      if (!e.target.closest('.page-nav-popup') && !e.target.closest('.status-bar-item[onclick*="showPageNavPopup"]')) {
        hidePageNavPopup();
      }
    });

    // Load saved preferences
    document.addEventListener('DOMContentLoaded', function() {
      // Load zoom
      const savedZoom = localStorage.getItem('ninjaword_zoom');
      if (savedZoom) {
        setZoomLevel(parseInt(savedZoom));
      }

      // Load language
      const savedLang = localStorage.getItem('ninjaword_language');
      if (savedLang) {
        const lang = JSON.parse(savedLang);
        currentLanguage = lang;
        document.getElementById('langIndicator').textContent = lang.name;
      }

      // Load auto-save status display
      const savedAutoSave = localStorage.getItem('ninjaword_autosave');
      if (savedAutoSave === 'false') {
        document.getElementById('autoSaveStatusIcon').textContent = '‚è∏Ô∏è';
        document.getElementById('autoSaveStatusText').textContent = 'Auto-save Off';
      }
    });

    // Update word count display in status bar
    function updateStatusBarWordCount() {
      const text = editor.textContent || '';
      const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      const chars = text.length;
      document.getElementById('wordCountDisplay').textContent = `Words: ${words.toLocaleString()} | Characters: ${chars.toLocaleString()}`;
    }

    // Override updateStats to also update status bar
    const originalUpdateStats = typeof updateStats === 'function' ? updateStats : function() {};
    updateStats = function() {
      originalUpdateStats();
      updateStatusBarWordCount();
    };

    // Keyboard shortcut for page nav input
    document.getElementById('pageNavInput')?.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        goToPage();
      }
    });

    // ==================== WELCOME MODAL ====================
    function showWelcome() {
      document.getElementById('welcomeModal').classList.add('visible');
    }

    function closeWelcome() {
      const dontShow = document.getElementById('dontShowAgain').checked;
      if (dontShow) {
        localStorage.setItem('ninjaword_welcome_shown', 'true');
      }
      document.getElementById('welcomeModal').classList.remove('visible');
    }

    // Show welcome on first visit
    document.addEventListener('DOMContentLoaded', function() {
      const welcomed = localStorage.getItem('ninjaword_welcome_shown');
      if (!welcomed) {
        setTimeout(showWelcome, 500); // Small delay for smoother experience
      }
    });

    // Close welcome on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('welcomeModal').classList.contains('visible')) {
        closeWelcome();
      }
    });

    // Close welcome when clicking outside
    document.getElementById('welcomeModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeWelcome();
      }
    });

    // ==================== TYPEWRITER SOUND EFFECT ====================
    let typewriterEnabled = false;
    let audioContext = null;

    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }

    function playTypewriterSound(isSpace = false, isEnter = false) {
      if (!typewriterEnabled) return;

      try {
        const ctx = initAudioContext();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);

        if (isEnter) {
          // Carriage return sound - lower pitch, longer
          oscillator.frequency.setValueAtTime(180, ctx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.15);
          gainNode.gain.setValueAtTime(0.08, ctx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.15);
        } else if (isSpace) {
          // Space bar - softer click
          oscillator.frequency.setValueAtTime(600, ctx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.03);
          gainNode.gain.setValueAtTime(0.04, ctx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.03);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.03);
        } else {
          // Regular key - crisp click
          oscillator.frequency.setValueAtTime(1200 + Math.random() * 400, ctx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.02);
          gainNode.gain.setValueAtTime(0.06, ctx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.025);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.025);
        }
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    function toggleTypewriterSound() {
      typewriterEnabled = !typewriterEnabled;
      const btn = document.getElementById('typewriterBtn');

      if (typewriterEnabled) {
        btn.classList.add('active');
        btn.style.background = '#e8f0fe';
        btn.style.color = '#1a73e8';
        localStorage.setItem('ninjaword_typewriter', 'true');
        showToast('Typewriter sound enabled - enjoy the nostalgic clicks!', 'success');
        // Play a test sound
        playTypewriterSound();
      } else {
        btn.classList.remove('active');
        btn.style.background = '';
        btn.style.color = '';
        localStorage.setItem('ninjaword_typewriter', 'false');
        showToast('Typewriter sound disabled', 'info');
      }
    }

    // Listen for keystrokes in editor
    document.addEventListener('DOMContentLoaded', function() {
      const editor = document.getElementById('editor');
      if (editor) {
        editor.addEventListener('keydown', function(e) {
          if (!typewriterEnabled) return;

          // Only play for printable characters and special keys
          if (e.key === 'Enter') {
            playTypewriterSound(false, true);
          } else if (e.key === ' ') {
            playTypewriterSound(true, false);
          } else if (e.key === 'Backspace' || e.key === 'Delete') {
            // Softer sound for delete
            playTypewriterSound(true, false);
          } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
            playTypewriterSound(false, false);
          }
        });
      }

      // Load saved preference
      if (localStorage.getItem('ninjaword_typewriter') === 'true') {
        typewriterEnabled = true;
        const btn = document.getElementById('typewriterBtn');
        if (btn) {
          btn.classList.add('active');
          btn.style.background = '#e8f0fe';
          btn.style.color = '#1a73e8';
        }
      }
    });

    // ==================== THEME PICKER ====================
    let currentTheme = 'blue';

    function showThemePicker() {
      document.getElementById('themePickerOverlay').classList.add('visible');
      document.getElementById('themePicker').classList.add('visible');
    }

    function hideThemePicker() {
      document.getElementById('themePickerOverlay').classList.remove('visible');
      document.getElementById('themePicker').classList.remove('visible');
    }

    function setTheme(theme) {
      currentTheme = theme;
      document.body.setAttribute('data-theme', theme);

      // Update active indicator
      document.querySelectorAll('.theme-color').forEach(el => {
        el.classList.toggle('active', el.dataset.theme === theme);
      });

      // Save preference
      localStorage.setItem('ninjaword_theme', theme);
      showToast(`Theme changed to ${theme}`, 'success');
    }

    // Load saved theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('ninjaword_theme');
      if (savedTheme) {
        setTheme(savedTheme);
      }
    });

    // Close theme picker with Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('themePicker').classList.contains('visible')) {
        hideThemePicker();
      }
    });

    // ==================== POMODORO TIMER ====================
    let pomodoroInterval = null;
    let pomodoroRunning = false;
    let pomodoroSeconds = 25 * 60;
    let pomodoroMode = 'focus'; // 'focus', 'shortBreak', 'longBreak'
    let pomodoroSessionCount = 0;
    let pomodoroSettings = {
      focusTime: 25,
      shortBreak: 5,
      longBreak: 15
    };

    function showPomodoro() {
      document.getElementById('pomodoroOverlay').classList.add('visible');
      document.getElementById('pomodoroPopup').classList.add('visible');
    }

    function hidePomodoro() {
      document.getElementById('pomodoroOverlay').classList.remove('visible');
      document.getElementById('pomodoroPopup').classList.remove('visible');
    }

    function togglePomodoroTimer() {
      if (pomodoroRunning) {
        pausePomodoro();
      } else {
        startPomodoro();
      }
    }

    function startPomodoro() {
      pomodoroRunning = true;
      document.getElementById('pomodoroStartBtn').textContent = 'Pause';

      pomodoroInterval = setInterval(() => {
        pomodoroSeconds--;
        updatePomodoroDisplay();

        if (pomodoroSeconds <= 0) {
          pomodoroComplete();
        }
      }, 1000);

      showToast('Pomodoro started! Stay focused!', 'success');
    }

    function pausePomodoro() {
      pomodoroRunning = false;
      document.getElementById('pomodoroStartBtn').textContent = 'Resume';
      clearInterval(pomodoroInterval);
      showToast('Pomodoro paused', 'info');
    }

    function resetPomodoro() {
      clearInterval(pomodoroInterval);
      pomodoroRunning = false;
      document.getElementById('pomodoroStartBtn').textContent = 'Start';

      if (pomodoroMode === 'focus') {
        pomodoroSeconds = pomodoroSettings.focusTime * 60;
      } else if (pomodoroMode === 'shortBreak') {
        pomodoroSeconds = pomodoroSettings.shortBreak * 60;
      } else {
        pomodoroSeconds = pomodoroSettings.longBreak * 60;
      }

      updatePomodoroDisplay();
      showToast('Pomodoro reset', 'info');
    }

    function skipPomodoro() {
      clearInterval(pomodoroInterval);
      pomodoroRunning = false;
      pomodoroComplete();
    }

    function pomodoroComplete() {
      clearInterval(pomodoroInterval);
      pomodoroRunning = false;
      document.getElementById('pomodoroStartBtn').textContent = 'Start';

      // Play notification sound
      playPomodoroSound();

      if (pomodoroMode === 'focus') {
        pomodoroSessionCount++;
        updatePomodoroSessions();

        // Long break after 4 sessions
        if (pomodoroSessionCount >= 4) {
          pomodoroMode = 'longBreak';
          pomodoroSeconds = pomodoroSettings.longBreak * 60;
          pomodoroSessionCount = 0;
          showToast('Great work! Time for a long break!', 'success');
        } else {
          pomodoroMode = 'shortBreak';
          pomodoroSeconds = pomodoroSettings.shortBreak * 60;
          showToast('Focus session complete! Take a short break.', 'success');
        }
      } else {
        pomodoroMode = 'focus';
        pomodoroSeconds = pomodoroSettings.focusTime * 60;
        showToast('Break over! Ready to focus again?', 'info');
      }

      updatePomodoroDisplay();
      updatePomodoroLabel();
    }

    function updatePomodoroDisplay() {
      const minutes = Math.floor(pomodoroSeconds / 60);
      const seconds = pomodoroSeconds % 60;
      const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('pomodoroTimer').textContent = display;

      const timerEl = document.getElementById('pomodoroTimer');
      timerEl.classList.toggle('break', pomodoroMode !== 'focus');
    }

    function updatePomodoroLabel() {
      const labels = {
        focus: 'Focus Time',
        shortBreak: 'Short Break',
        longBreak: 'Long Break'
      };
      document.getElementById('pomodoroLabel').textContent = labels[pomodoroMode];
    }

    function updatePomodoroSessions() {
      const dots = document.querySelectorAll('#pomodoroSessions .pomodoro-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('completed', i < pomodoroSessionCount);
      });
    }

    function updatePomodoroSettings() {
      pomodoroSettings.focusTime = parseInt(document.getElementById('pomodoroFocusTime').value) || 25;
      pomodoroSettings.shortBreak = parseInt(document.getElementById('pomodoroShortBreak').value) || 5;
      pomodoroSettings.longBreak = parseInt(document.getElementById('pomodoroLongBreak').value) || 15;

      localStorage.setItem('ninjaword_pomodoro', JSON.stringify(pomodoroSettings));

      if (!pomodoroRunning) {
        resetPomodoro();
      }
    }

    function playPomodoroSound() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.frequency.setValueAtTime(800, ctx.currentTime);
      osc.frequency.setValueAtTime(1000, ctx.currentTime + 0.1);
      osc.frequency.setValueAtTime(800, ctx.currentTime + 0.2);

      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.5);
    }

    // Load saved pomodoro settings
    document.addEventListener('DOMContentLoaded', function() {
      const saved = localStorage.getItem('ninjaword_pomodoro');
      if (saved) {
        pomodoroSettings = JSON.parse(saved);
        document.getElementById('pomodoroFocusTime').value = pomodoroSettings.focusTime;
        document.getElementById('pomodoroShortBreak').value = pomodoroSettings.shortBreak;
        document.getElementById('pomodoroLongBreak').value = pomodoroSettings.longBreak;
      }
      pomodoroSeconds = pomodoroSettings.focusTime * 60;
      updatePomodoroDisplay();
    });

    // ==================== AMBIENT SOUNDS ====================
    let ambientAudioContext = null;
    let ambientSounds = {};
    let ambientVolume = 0.5;

    const ambientNoiseParams = {
      rain: { type: 'brown', freq: 1000, q: 0.5 },
      thunder: { type: 'brown', freq: 200, q: 2, burst: true },
      forest: { type: 'pink', freq: 2000, q: 0.3 },
      ocean: { type: 'brown', freq: 300, q: 1 },
      wind: { type: 'brown', freq: 400, q: 0.8 },
      fire: { type: 'brown', freq: 600, q: 1.5 },
      cafe: { type: 'pink', freq: 1500, q: 0.5 },
      whitenoise: { type: 'white', freq: 5000, q: 0.1 },
      birds: { type: 'pink', freq: 3000, q: 2 }
    };

    function showAmbientSounds() {
      document.getElementById('ambientOverlay').classList.add('visible');
      document.getElementById('ambientPopup').classList.add('visible');
    }

    function hideAmbientSounds() {
      document.getElementById('ambientOverlay').classList.remove('visible');
      document.getElementById('ambientPopup').classList.remove('visible');
    }

    function initAmbientAudioContext() {
      if (!ambientAudioContext) {
        ambientAudioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return ambientAudioContext;
    }

    function createNoiseNode(ctx, type) {
      const bufferSize = 2 * ctx.sampleRate;
      const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const output = noiseBuffer.getChannelData(0);

      if (type === 'white') {
        for (let i = 0; i < bufferSize; i++) {
          output[i] = Math.random() * 2 - 1;
        }
      } else if (type === 'pink') {
        let b0, b1, b2, b3, b4, b5, b6;
        b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0;
        for (let i = 0; i < bufferSize; i++) {
          const white = Math.random() * 2 - 1;
          b0 = 0.99886 * b0 + white * 0.0555179;
          b1 = 0.99332 * b1 + white * 0.0750759;
          b2 = 0.96900 * b2 + white * 0.1538520;
          b3 = 0.86650 * b3 + white * 0.3104856;
          b4 = 0.55000 * b4 + white * 0.5329522;
          b5 = -0.7616 * b5 - white * 0.0168980;
          output[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
          b6 = white * 0.115926;
        }
      } else { // brown
        let lastOut = 0;
        for (let i = 0; i < bufferSize; i++) {
          const white = Math.random() * 2 - 1;
          output[i] = (lastOut + (0.02 * white)) / 1.02;
          lastOut = output[i];
          output[i] *= 3.5;
        }
      }

      const noise = ctx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;
      return noise;
    }

    function toggleAmbientSound(soundId) {
      const btn = document.querySelector(`[data-sound="${soundId}"]`);

      if (ambientSounds[soundId]) {
        // Stop sound
        ambientSounds[soundId].gain.gain.exponentialRampToValueAtTime(0.001, ambientAudioContext.currentTime + 0.5);
        setTimeout(() => {
          if (ambientSounds[soundId]) {
            ambientSounds[soundId].source.stop();
            delete ambientSounds[soundId];
          }
        }, 500);
        btn.classList.remove('active');
        showToast(`${soundId} stopped`, 'info');
      } else {
        // Start sound
        const ctx = initAmbientAudioContext();
        const params = ambientNoiseParams[soundId];

        const noise = createNoiseNode(ctx, params.type);
        const filter = ctx.createBiquadFilter();
        const gain = ctx.createGain();

        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(params.freq, ctx.currentTime);
        filter.Q.setValueAtTime(params.q, ctx.currentTime);

        gain.gain.setValueAtTime(0.001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(ambientVolume * 0.3, ctx.currentTime + 0.5);

        noise.connect(filter);
        filter.connect(gain);
        gain.connect(ctx.destination);

        noise.start();

        ambientSounds[soundId] = { source: noise, gain: gain, filter: filter };
        btn.classList.add('active');
        showToast(`${soundId} playing`, 'success');
      }
    }

    function setAmbientVolume(value) {
      ambientVolume = value / 100;

      for (const soundId in ambientSounds) {
        if (ambientSounds[soundId]) {
          ambientSounds[soundId].gain.gain.setValueAtTime(ambientVolume * 0.3, ambientAudioContext.currentTime);
        }
      }

      localStorage.setItem('ninjaword_ambient_volume', value);
    }

    function stopAllAmbientSounds() {
      for (const soundId in ambientSounds) {
        const btn = document.querySelector(`[data-sound="${soundId}"]`);
        if (btn) btn.classList.remove('active');

        if (ambientSounds[soundId]) {
          ambientSounds[soundId].source.stop();
          delete ambientSounds[soundId];
        }
      }
      ambientSounds = {};
      showToast('All ambient sounds stopped', 'info');
    }

    // Load saved volume
    document.addEventListener('DOMContentLoaded', function() {
      const savedVolume = localStorage.getItem('ninjaword_ambient_volume');
      if (savedVolume) {
        document.getElementById('ambientVolume').value = savedVolume;
        ambientVolume = savedVolume / 100;
      }
    });

    // ==================== WRITING GOALS ====================
    let writingGoalActive = false;
    let writingGoalType = 'words';
    let writingGoalTarget = 500;
    let writingGoalStartWords = 0;
    let writingGoalStartChars = 0;
    let writingGoalStartTime = null;
    let writingGoalTimer = null;

    function showWritingGoals() {
      document.getElementById('writingGoalsModal').classList.add('active');
    }

    function hideWritingGoalsModal() {
      document.getElementById('writingGoalsModal').classList.remove('active');
    }

    function updateGoalInputLabel() {
      const type = document.getElementById('writingGoalType').value;
      const labels = {
        words: 'Target Words',
        characters: 'Target Characters',
        time: 'Target Minutes'
      };
      document.getElementById('writingGoalLabel').textContent = labels[type];

      const defaults = { words: 500, characters: 2500, time: 30 };
      document.getElementById('writingGoalTarget').value = defaults[type];
    }

    function startWritingGoal() {
      writingGoalType = document.getElementById('writingGoalType').value;
      writingGoalTarget = parseInt(document.getElementById('writingGoalTarget').value) || 500;

      const editor = document.getElementById('editor');
      const text = editor.textContent || '';
      writingGoalStartWords = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      writingGoalStartChars = text.length;
      writingGoalStartTime = Date.now();
      writingGoalActive = true;

      hideWritingGoalsModal();
      document.getElementById('writingGoalBar').classList.add('visible');
      updateWritingGoalProgress();

      if (writingGoalType === 'time') {
        writingGoalTimer = setInterval(updateWritingGoalProgress, 1000);
      }

      showToast(`Writing goal started: ${writingGoalTarget} ${writingGoalType}`, 'success');
    }

    function updateWritingGoalProgress() {
      if (!writingGoalActive) return;

      const editor = document.getElementById('editor');
      const text = editor.textContent || '';
      let current = 0;
      let progress = 0;

      if (writingGoalType === 'words') {
        const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
        current = words - writingGoalStartWords;
        document.getElementById('writingGoalText').textContent = `${current} / ${writingGoalTarget} words`;
      } else if (writingGoalType === 'characters') {
        current = text.length - writingGoalStartChars;
        document.getElementById('writingGoalText').textContent = `${current} / ${writingGoalTarget} characters`;
      } else {
        const elapsed = Math.floor((Date.now() - writingGoalStartTime) / 60000);
        current = elapsed;
        document.getElementById('writingGoalText').textContent = `${elapsed} / ${writingGoalTarget} minutes`;
      }

      progress = Math.min((current / writingGoalTarget) * 100, 100);
      document.getElementById('writingGoalFill').style.width = progress + '%';

      // Check if goal reached
      if (current >= writingGoalTarget && writingGoalActive) {
        goalReached();
      }
    }

    function goalReached() {
      writingGoalActive = false;
      clearInterval(writingGoalTimer);

      const notify = document.getElementById('writingGoalNotify')?.checked;
      if (notify) {
        playPomodoroSound(); // Reuse the sound
        showToast('Congratulations! You reached your writing goal!', 'success');
      }

      document.getElementById('writingGoalFill').style.background = 'linear-gradient(90deg, #0f9d58, #34a853)';
    }

    function hideWritingGoalBar() {
      document.getElementById('writingGoalBar').classList.remove('visible');
      writingGoalActive = false;
      clearInterval(writingGoalTimer);
      document.getElementById('writingGoalFill').style.background = 'linear-gradient(90deg, #1a73e8, #4285f4)';
      document.getElementById('writingGoalFill').style.width = '0%';
    }

    // Update writing goal on editor input
    document.addEventListener('DOMContentLoaded', function() {
      const editor = document.getElementById('editor');
      if (editor) {
        editor.addEventListener('input', function() {
          if (writingGoalActive && writingGoalType !== 'time') {
            updateWritingGoalProgress();
          }
        });
      }
    });

    // Close modals with Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (document.getElementById('pomodoroPopup').classList.contains('visible')) {
          hidePomodoro();
        }
        if (document.getElementById('ambientPopup').classList.contains('visible')) {
          hideAmbientSounds();
        }
        if (document.getElementById('writingGoalsModal').classList.contains('active')) {
          hideWritingGoalsModal();
        }
        if (document.getElementById('readingLevelPopup').classList.contains('visible')) {
          hideReadingLevel();
        }
      }
    });

    // ==================== READING LEVEL ANALYZER ====================
    function showReadingLevel() {
      const editor = document.getElementById('editor');
      const text = editor.textContent || editor.innerText || '';

      if (text.trim().length < 50) {
        showToast('Please add more text (at least 50 characters) to analyze reading level', 'warning');
        return;
      }

      const analysis = analyzeReadingLevel(text);
      displayReadingLevel(analysis);

      document.getElementById('readingLevelOverlay').classList.add('visible');
      document.getElementById('readingLevelPopup').classList.add('visible');
    }

    function hideReadingLevel() {
      document.getElementById('readingLevelOverlay').classList.remove('visible');
      document.getElementById('readingLevelPopup').classList.remove('visible');
    }

    function countSyllables(word) {
      word = word.toLowerCase().replace(/[^a-z]/g, '');
      if (word.length <= 3) return 1;

      // Remove silent e
      word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
      word = word.replace(/^y/, '');

      // Count vowel groups
      const matches = word.match(/[aeiouy]{1,2}/g);
      return matches ? matches.length : 1;
    }

    function analyzeReadingLevel(text) {
      // Clean text
      const cleanText = text.replace(/\s+/g, ' ').trim();

      // Count sentences (split on . ! ?)
      const sentences = cleanText.split(/[.!?]+/).filter(s => s.trim().length > 0);
      const sentenceCount = Math.max(sentences.length, 1);

      // Count words
      const words = cleanText.split(/\s+/).filter(w => w.replace(/[^a-zA-Z]/g, '').length > 0);
      const wordCount = words.length;

      if (wordCount === 0) {
        return { gradeLevel: 0, fleschScore: 100, avgWordsPerSentence: 0, avgSyllablesPerWord: 0, complexWordPercent: 0 };
      }

      // Count syllables
      let totalSyllables = 0;
      let complexWords = 0; // Words with 3+ syllables

      words.forEach(word => {
        const syllables = countSyllables(word);
        totalSyllables += syllables;
        if (syllables >= 3) complexWords++;
      });

      const avgWordsPerSentence = wordCount / sentenceCount;
      const avgSyllablesPerWord = totalSyllables / wordCount;
      const complexWordPercent = (complexWords / wordCount) * 100;

      // Flesch-Kincaid Grade Level
      // Grade = 0.39 * (words/sentences) + 11.8 * (syllables/words) - 15.59
      const gradeLevel = Math.max(0, Math.min(20,
        0.39 * avgWordsPerSentence + 11.8 * avgSyllablesPerWord - 15.59
      ));

      // Flesch Reading Ease Score
      // Score = 206.835 - 1.015 * (words/sentences) - 84.6 * (syllables/words)
      const fleschScore = Math.max(0, Math.min(100,
        206.835 - 1.015 * avgWordsPerSentence - 84.6 * avgSyllablesPerWord
      ));

      return {
        gradeLevel: Math.round(gradeLevel * 10) / 10,
        fleschScore: Math.round(fleschScore),
        avgWordsPerSentence: Math.round(avgWordsPerSentence * 10) / 10,
        avgSyllablesPerWord: Math.round(avgSyllablesPerWord * 100) / 100,
        complexWordPercent: Math.round(complexWordPercent * 10) / 10
      };
    }

    function displayReadingLevel(analysis) {
      // Display grade level
      const grade = analysis.gradeLevel;
      document.getElementById('readingLevelGrade').textContent = grade.toFixed(1);

      // Grade level label
      let label = '';
      if (grade <= 5) label = 'Elementary School';
      else if (grade <= 8) label = 'Middle School';
      else if (grade <= 12) label = 'High School';
      else if (grade <= 16) label = 'College';
      else label = 'Graduate Level';
      document.getElementById('readingLevelLabel').textContent = label;

      // Position indicator (0-20 scale mapped to 0-100%)
      const position = Math.min(100, (grade / 18) * 100);
      document.getElementById('readingLevelIndicator').style.left = position + '%';

      // Stats
      document.getElementById('rlFleschScore').textContent = analysis.fleschScore;
      document.getElementById('rlAvgSentence').textContent = analysis.avgWordsPerSentence;
      document.getElementById('rlAvgSyllables').textContent = analysis.avgSyllablesPerWord;
      document.getElementById('rlComplexWords').textContent = analysis.complexWordPercent + '%';

      // Description and recommendations
      let desc = '';
      if (analysis.fleschScore >= 90) {
        desc = '‚ú® Very Easy - Easily understood by an average 11-year-old. Great for a wide audience!';
      } else if (analysis.fleschScore >= 70) {
        desc = 'üëç Fairly Easy - Conversational English suitable for most readers.';
      } else if (analysis.fleschScore >= 50) {
        desc = 'üìñ Standard - Plain English, easily understood by 13-15 year olds.';
      } else if (analysis.fleschScore >= 30) {
        desc = 'üìö Fairly Difficult - Best understood by college graduates. Consider simplifying.';
      } else {
        desc = 'üéì Difficult - Best understood by university graduates. May want to use shorter sentences.';
      }

      // Add tips
      if (analysis.avgWordsPerSentence > 20) {
        desc += ' Tip: Try breaking up longer sentences.';
      }
      if (analysis.complexWordPercent > 15) {
        desc += ' Tip: Consider using simpler vocabulary.';
      }

      document.getElementById('readingLevelDesc').textContent = desc;
    }

    // ==================== EMOJI PICKER ====================
    const emojiData = {
      smileys: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','ü•∏','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ'],
      people: ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ','üë∂','üßí','üë¶','üëß','üßë','üë±','üë®','üßî','üë©','üßì','üë¥','üëµ','üôç','üôé','üôÖ','üôÜ','üíÅ','üôã','üßè','üôá','ü§¶','ü§∑','üëÆ','üïµÔ∏è','üíÇ','ü•∑','üë∑','ü§¥','üë∏','üë≥','üë≤','üßï','ü§µ','üë∞','ü§∞','ü§±','üëº','üéÖ','ü§∂','ü¶∏','ü¶π','üßô','üßö','üßõ','üßú','üßù','üßû','üßü','üíÜ','üíá','üö∂','üßç','üßé','üèÉ','üíÉ','üï∫','üï¥Ô∏è','üëØ','üßñ','üßó','ü§∏','üèåÔ∏è','üèá','‚õ∑Ô∏è','üèÇ','üèãÔ∏è','ü§º','ü§Ω','ü§æ','ü§∫','‚õπÔ∏è','üèä','üö£','üßò','üõÄ','üõå'],
      animals: ['üê±','üê∂','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üêí','üêî','üêß','üê¶','üê§','üê£','üê•','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','ü™±','üêõ','ü¶ã','üêå','üêû','üêú','ü™∞','ü™≤','ü™≥','ü¶ü','ü¶ó','üï∑Ô∏è','üï∏Ô∏è','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','ü¶£','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','ü¶¨','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','ü¶ô','üêê','ü¶å','üêï','üê©','ü¶Æ','üêï‚Äçü¶∫','üêà','üêà‚Äç‚¨õ','ü™∂','üêì','ü¶É','ü¶§','ü¶ö','ü¶ú','ü¶¢','ü¶©','üïäÔ∏è','üêá','ü¶ù','ü¶®','ü¶°','ü¶´','ü¶¶','ü¶•','üêÅ','üêÄ','üêøÔ∏è','ü¶î'],
      food: ['üçï','üçî','üçü','üå≠','üçø','üßÇ','ü•ì','ü•ö','üç≥','üßá','ü•û','üßà','üçû','ü•ê','ü•ñ','ü•®','üßÄ','ü•ó','ü•ô','ü•™','üåÆ','üåØ','ü´î','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•†','ü•Æ','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üç©','üç™','üå∞','ü•ú','üçØ','ü•õ','üçº','ü´ñ','‚òï','üçµ','üßÉ','ü•§','üßã','üç∂','üç∫','üçª','ü•Ç','üç∑','ü•É','üç∏','üçπ','üßâ','üçæ','üßä','ü•Ñ','üç¥','üçΩÔ∏è','ü•¢','ü•°','üçá','üçà','üçâ','üçä','üçã','üçå','üçç','ü•≠','üçé','üçè','üçê','üçë','üçí','üçì','ü´ê','ü•ù','üçÖ','ü´í','ü••','ü•ë','üçÜ','ü•î','ü•ï','üåΩ','üå∂Ô∏è','ü´ë','ü•í','ü•¨','ü•¶','üßÑ','üßÖ','üçÑ','ü•ú','üå∞','ü´ò','ü´õ'],
      activities: ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèí','üèë','ü•ç','üèè','ü™É','ü•Ö','‚õ≥','ü™Å','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõº','üõ∑','‚õ∏Ô∏è','ü•å','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','ü§º','ü§∏','ü§∫','‚õπÔ∏è','ü§æ','üèåÔ∏è','üèá','‚õ∏Ô∏è','üèä','üö£','üßó','üöµ','üö¥','üèÜ','ü•á','ü•à','ü•â','üèÖ','üéñÔ∏è','üèµÔ∏è','üéóÔ∏è','üé´','üéüÔ∏è','üé™','ü§π','üé≠','ü©∞','üé®','üé¨','üé§','üéß','üéº','üéπ','ü•Å','ü™ò','üé∑','üé∫','ü™ó','üé∏','ü™ï','üéª','ü™à','üé≤','‚ôüÔ∏è','üéØ','üé≥','üéÆ','üé∞','üß©'],
      travel: ['üöó','üöï','üöô','üöå','üöé','üèéÔ∏è','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','ü¶Ø','ü¶Ω','ü¶º','üõ¥','üö≤','üõµ','üèçÔ∏è','üõ∫','üö®','üöî','üöç','üöò','üöñ','üö°','üö†','üöü','üöÉ','üöã','üöû','üöù','üöÑ','üöÖ','üöà','üöÇ','üöÜ','üöá','üöä','üöâ','‚úàÔ∏è','üõ´','üõ¨','üõ©Ô∏è','üí∫','üõ∞Ô∏è','üöÄ','üõ∏','üöÅ','üõ∂','‚õµ','üö§','üõ•Ô∏è','üõ≥Ô∏è','‚õ¥Ô∏è','üö¢','‚öì','ü™ù','‚õΩ','üöß','üö¶','üö•','üöè','üó∫Ô∏è','üóø','üóΩ','üóº','üè∞','üèØ','üèüÔ∏è','üé°','üé¢','üé†','‚õ≤','‚õ±Ô∏è','üèñÔ∏è','üèùÔ∏è','üèúÔ∏è','üåã','‚õ∞Ô∏è','üèîÔ∏è','üóª','üèïÔ∏è','‚õ∫','üè†','üè°','üèòÔ∏è','üèöÔ∏è','üèóÔ∏è','üè≠','üè¢','üè¨','üè£','üè§','üè•','üè¶','üè®','üè™','üè´','üè©','üíí','üèõÔ∏è','‚õ™','üïå','üïç','üõï','üïã','‚õ©Ô∏è','üõ§Ô∏è','üõ£Ô∏è','üóæ','üéë','üèûÔ∏è','üåÖ','üåÑ','üå†','üéá','üéÜ','üåá','üåÜ','üèôÔ∏è','üåÉ','üåå','üåâ','üåÅ'],
      objects: ['üí°','üî¶','üèÆ','ü™î','üì±','üì≤','üíª','‚å®Ô∏è','üñ•Ô∏è','üñ®Ô∏è','üñ±Ô∏è','üñ≤Ô∏è','üíΩ','üíæ','üíø','üìÄ','üßÆ','üé•','üéûÔ∏è','üìΩÔ∏è','üé¨','üì∫','üì∑','üì∏','üìπ','üìº','üîç','üîé','üïØÔ∏è','üíµ','üí¥','üí∂','üí∑','üí≥','üí∞','ü™ô','üíé','‚öñÔ∏è','ü™ú','üß∞','ü™õ','üîß','üî®','‚öíÔ∏è','üõ†Ô∏è','‚õèÔ∏è','ü™ö','üî©','‚öôÔ∏è','ü™§','üß±','‚õìÔ∏è','üß≤','üî´','üí£','üß®','ü™ì','üî™','üó°Ô∏è','‚öîÔ∏è','üõ°Ô∏è','üö¨','‚ö∞Ô∏è','ü™¶','‚ö±Ô∏è','üè∫','üîÆ','üìø','üßø','üíà','‚öóÔ∏è','üî≠','üî¨','üï≥Ô∏è','ü©π','ü©∫','üíä','üíâ','ü©∏','üß¨','ü¶†','üß´','üß™','üå°Ô∏è','üßπ','ü™†','üß∫','üßª','üöΩ','üö∞','üöø','üõÅ','üõÄ','üßº','ü™•','ü™í','üßΩ','ü™£','üß¥','üõéÔ∏è','üîë','üóùÔ∏è','üö™','ü™ë','üõãÔ∏è','üõèÔ∏è','üõå','üß∏','üñºÔ∏è','ü™û','ü™Ü','üõçÔ∏è','üõí','üéÅ','üéà','üéè','üéÄ','ü™Ñ','ü™Ö','üéä','üéâ','üéé','üèÆ','üéê','üßß','‚úâÔ∏è','üì©','üì®','üìß','üíå','üì•','üì§','üì¶','üè∑Ô∏è','üì™','üì´','üì¨','üì≠','üìÆ','üìØ','üìú','üìÉ','üìÑ','üìë','üßæ','üìä','üìà','üìâ','üóíÔ∏è','üóìÔ∏è','üìÜ','üìÖ','üóëÔ∏è','üìá','üóÉÔ∏è','üó≥Ô∏è','üóÑÔ∏è','üìã','üìÅ','üìÇ','üóÇÔ∏è','üóûÔ∏è','üì∞','üìì','üìî','üìí','üìï','üìó','üìò','üìô','üìö','üìñ','üîñ','üß∑','üîó','üìé','üñáÔ∏è','üìê','üìè','üßÆ','üìå','üìç','‚úÇÔ∏è','üñäÔ∏è','üñãÔ∏è','‚úíÔ∏è','üñåÔ∏è','üñçÔ∏è','üìù','‚úèÔ∏è','üîç','üîé','üîè','üîê','üîí','üîì'],
      symbols: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâÔ∏è','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è','‚ò¶Ô∏è','üõê','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå','‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','üÜî','‚öõÔ∏è','üâë','‚ò¢Ô∏è','‚ò£Ô∏è','üì¥','üì≥','üà∂','üàö','üà∏','üà∫','üà∑Ô∏è','‚ú¥Ô∏è','üÜö','üíÆ','üâê','„äôÔ∏è','„äóÔ∏è','üà¥','üàµ','üàπ','üà≤','üÖ∞Ô∏è','üÖ±Ô∏è','üÜé','üÜë','üÖæÔ∏è','üÜò','‚ùå','‚≠ï','üõë','‚õî','üìõ','üö´','üíØ','üí¢','‚ô®Ô∏è','üö∑','üöØ','üö≥','üö±','üîû','üìµ','üö≠','‚ùó','‚ùï','‚ùì','‚ùî','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','„ÄΩÔ∏è','‚ö†Ô∏è','üö∏','üî±','‚öúÔ∏è','üî∞','‚ôªÔ∏è','‚úÖ','üàØ','üíπ','‚ùáÔ∏è','‚ú≥Ô∏è','‚ùé','üåê','üí†','‚ìÇÔ∏è','üåÄ','üí§','üèß','üöæ','‚ôø','üÖøÔ∏è','üõó','üà≥','üàÇÔ∏è','üõÇ','üõÉ','üõÑ','üõÖ','üöπ','üö∫','üöº','‚öß','üöª','üöÆ','üé¶','üì∂','üàÅ','üî£','‚ÑπÔ∏è','üî§','üî°','üî†','üÜñ','üÜó','üÜô','üÜí','üÜï','üÜì','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü','üî¢','#Ô∏è‚É£','*Ô∏è‚É£','‚èèÔ∏è','‚ñ∂Ô∏è','‚è∏Ô∏è','‚èØÔ∏è','‚èπÔ∏è','‚è∫Ô∏è','‚è≠Ô∏è','‚èÆÔ∏è','‚è©','‚è™','‚è´','‚è¨','‚óÄÔ∏è','üîº','üîΩ','‚û°Ô∏è','‚¨ÖÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è','‚ÜóÔ∏è','‚ÜòÔ∏è','‚ÜôÔ∏è','‚ÜñÔ∏è','‚ÜïÔ∏è','‚ÜîÔ∏è','‚Ü™Ô∏è','‚Ü©Ô∏è','‚§¥Ô∏è','‚§µÔ∏è','üîÄ','üîÅ','üîÇ','üîÑ','üîÉ','üéµ','üé∂','‚ûï','‚ûñ','‚ûó','‚úñÔ∏è','üü∞','‚ôæÔ∏è','üí≤','üí±','‚Ñ¢Ô∏è','¬©Ô∏è','¬ÆÔ∏è','üëÅÔ∏è‚Äçüó®Ô∏è','üîö','üîô','üîõ','üîù','üîú','„Ä∞Ô∏è','‚û∞','‚ûø','‚úîÔ∏è','‚òëÔ∏è','üîò','üî¥','üü†','üü°','üü¢','üîµ','üü£','‚ö´','‚ö™','üü§','üî∫','üîª','üî∏','üîπ','üî∂','üî∑','üî≥','üî≤','‚ñ™Ô∏è','‚ñ´Ô∏è','‚óæ','‚óΩ','‚óºÔ∏è','‚óªÔ∏è','üü•','üüß','üü®','üü©','üü¶','üü™','‚¨õ','‚¨ú','üü´','üîà','üîá','üîâ','üîä','üîî','üîï','üì£','üì¢','üí¨','üí≠','üóØÔ∏è','‚ô†Ô∏è','‚ô£Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','üÉè','üé¥','üÄÑ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö','üïõ','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶','üïß'],
      flags: ['üè≥Ô∏è','üè¥','üè¥‚Äç‚ò†Ô∏è','üèÅ','üö©','üéå','üè≥Ô∏è‚Äçüåà','üè≥Ô∏è‚Äç‚ößÔ∏è','üá∫üá≥','üá¶üá´','üá¶üáΩ','üá¶üá±','üá©üáø','üá¶üá∏','üá¶üá©','üá¶üá¥','üá¶üáÆ','üá¶üá∂','üá¶üá¨','üá¶üá∑','üá¶üá≤','üá¶üáº','üá¶üá∫','üá¶üáπ','üá¶üáø','üáßüá∏','üáßüá≠','üáßüá©','üáßüáß','üáßüáæ','üáßüá™','üáßüáø','üáßüáØ','üáßüá≤','üáßüáπ','üáßüá¥','üáßüá¶','üáßüáº','üáßüá∑','üáÆüá¥','üáªüá¨','üáßüá≥','üáßüá¨','üáßüá´','üáßüáÆ','üá∞üá≠','üá®üá≤','üá®üá¶','üáÆüá®','üá®üáª','üáßüá∂','üá∞üáæ','üá®üá´','üáπüá©','üá®üá±','üá®üá≥','üá®üáΩ','üá®üá®','üá®üá¥','üá∞üá≤','üá®üá¨','üá®üá©','üá®üá∞','üá®üá∑','üá®üáÆ','üá≠üá∑','üá®üá∫','üá®üáº','üá®üáæ','üá®üáø','üá©üá∞','üá©üáØ','üá©üá≤','üá©üá¥','üá™üá®','üá™üá¨','üá∏üáª','üá¨üá∂','üá™üá∑','üá™üá™','üá∏üáø','üá™üáπ','üá™üá∫','üá´üá∞','üá´üá¥','üá´üáØ','üá´üáÆ','üá´üá∑','üá¨üá´','üáµüá´','üáπüá´','üá¨üá¶','üá¨üá≤','üá¨üá™','üá©üá™','üá¨üá≠','üá¨üáÆ','üá¨üá∑','üá¨üá±','üá¨üá©','üá¨üáµ','üá¨üá∫','üá¨üáπ','üá¨üá¨','üá¨üá≥','üá¨üáº','üá¨üáæ','üá≠üáπ','üá≠üá≥','üá≠üá∞','üá≠üá∫','üáÆüá∏','üáÆüá≥','üáÆüá©','üáÆüá∑','üáÆüá∂','üáÆüá™','üáÆüá≤','üáÆüá±','üáÆüáπ','üáØüá≤','üáØüáµ','üéå','üáØüá™','üáØüá¥','üá∞üáø','üá∞üá™','üá∞üáÆ','üáΩüá∞','üá∞üáº','üá∞üá¨','üá±üá¶','üá±üáª','üá±üáß','üá±üá∏','üá±üá∑','üá±üáæ','üá±üáÆ','üá±üáπ','üá±üá∫','üá≤üá¥','üá≤üá¨','üá≤üáº','üá≤üáæ','üá≤üáª','üá≤üá±','üá≤üáπ','üá≤üá≠','üá≤üá∂','üá≤üá∑','üá≤üá∫','üáæüáπ','üá≤üáΩ','üá´üá≤','üá≤üá©','üá≤üá®','üá≤üá≥','üá≤üá™','üá≤üá∏','üá≤üá¶','üá≤üáø','üá≤üá≤','üá≥üá¶','üá≥üá∑','üá≥üáµ','üá≥üá±','üá≥üá®','üá≥üáø','üá≥üáÆ','üá≥üá™','üá≥üá¨','üá≥üá∫','üá≥üá´','üá∞üáµ','üá≤üá∞','üá≤üáµ','üá≥üá¥','üá¥üá≤','üáµüá∞','üáµüáº','üáµüá∏','üáµüá¶','üáµüá¨','üáµüáæ','üáµüá™','üáµüá≠','üáµüá≥','üáµüá±','üáµüáπ','üáµüá∑','üá∂üá¶','üá∑üá™','üá∑üá¥','üá∑üá∫','üá∑üáº','üáºüá∏','üá∏üá≤','üá∏üáπ','üá∏üá¶','üá∏üá≥','üá∑üá∏','üá∏üá®','üá∏üá±','üá∏üá¨','üá∏üáΩ','üá∏üá∞','üá∏üáÆ','üá¨üá∏','üá∏üáß','üá∏üá¥','üáøüá¶','üá∞üá∑','üá∏üá∏','üá™üá∏','üá±üá∞','üáßüá±','üá∏üá≠','üá∞üá≥','üá±üá®','üáµüá≤','üáªüá®','üá∏üá©','üá∏üá∑','üá∏üá™','üá®üá≠','üá∏üáæ','üáπüáº','üáπüáØ','üáπüáø','üáπüá≠','üáπüá±','üáπüá¨','üáπüá∞','üáπüá¥','üáπüáπ','üáπüá≥','üáπüá∑','üáπüá≤','üáπüá®','üáπüáª','üáªüáÆ','üá∫üá¨','üá∫üá¶','üá¶üá™','üá¨üáß','üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø','üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø','üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø','üá∫üá∏','üá∫üáæ','üá∫üáø','üáªüá∫','üáªüá¶','üáªüá™','üáªüá≥','üáºüá´','üá™üá≠','üáæüá™','üáøüá≤','üáøüáº']
    };

    let currentEmojiCategory = 'smileys';
    let recentEmojis = [];

    function showEmojiPicker() {
      // Load recent emojis
      const saved = localStorage.getItem('ninjaword_recent_emojis');
      if (saved) {
        recentEmojis = JSON.parse(saved);
      }

      renderEmojiGrid(emojiData[currentEmojiCategory]);
      renderRecentEmojis();

      document.getElementById('emojiOverlay').classList.add('visible');
      document.getElementById('emojiPicker').classList.add('visible');
      document.getElementById('emojiSearch').value = '';
      document.getElementById('emojiSearch').focus();
    }

    function hideEmojiPicker() {
      document.getElementById('emojiOverlay').classList.remove('visible');
      document.getElementById('emojiPicker').classList.remove('visible');
    }

    function showEmojiCategory(category) {
      currentEmojiCategory = category;

      // Update active button
      document.querySelectorAll('.emoji-category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      renderEmojiGrid(emojiData[category]);
    }

    function renderEmojiGrid(emojis) {
      const grid = document.getElementById('emojiGrid');
      grid.innerHTML = emojis.map(emoji =>
        `<button class="emoji-btn" onclick="insertEmoji('${emoji}')" title="${emoji}">${emoji}</button>`
      ).join('');
    }

    function renderRecentEmojis() {
      const grid = document.getElementById('emojiRecentGrid');
      if (recentEmojis.length === 0) {
        grid.innerHTML = '<span style="color: #999; font-size: 11px;">No recent emojis</span>';
        return;
      }
      grid.innerHTML = recentEmojis.slice(0, 16).map(emoji =>
        `<button class="emoji-btn" style="width: 32px; height: 32px; font-size: 18px;" onclick="insertEmoji('${emoji}')">${emoji}</button>`
      ).join('');
    }

    function filterEmojis(query) {
      if (!query.trim()) {
        renderEmojiGrid(emojiData[currentEmojiCategory]);
        return;
      }

      // Search across all categories
      const allEmojis = Object.values(emojiData).flat();

      // Simple search - just show all emojis if query is short
      // For better search, you'd need emoji names/keywords
      if (query.length < 2) {
        renderEmojiGrid(allEmojis.slice(0, 64));
      } else {
        renderEmojiGrid(allEmojis.slice(0, 64));
      }
    }

    function insertEmoji(emoji) {
      // Add to recent
      recentEmojis = [emoji, ...recentEmojis.filter(e => e !== emoji)].slice(0, 32);
      localStorage.setItem('ninjaword_recent_emojis', JSON.stringify(recentEmojis));

      // Insert into editor
      const editor = document.getElementById('editor');
      editor.focus();

      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(document.createTextNode(emoji));
        range.collapse(false);
      } else {
        editor.innerHTML += emoji;
      }

      hideEmojiPicker();
      showToast(`Inserted ${emoji}`, 'success');
    }

    // Keyboard shortcut for emoji picker (Win+. or Ctrl+E)
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        showEmojiPicker();
      }
      if (e.key === 'Escape' && document.getElementById('emojiPicker').classList.contains('visible')) {
        hideEmojiPicker();
      }
    });

    // ==================== ENHANCED FOCUS MODE ====================
    let focusModeEnabled = false;

    function toggleFocusMode() {
      focusModeEnabled = !focusModeEnabled;
      const container = document.querySelector('.app-container');
      const indicator = document.getElementById('focusIndicator');
      const btn = document.getElementById('focusModeBtn');

      if (focusModeEnabled) {
        container.classList.add('focus-mode-active');
        indicator.classList.add('visible');
        if (btn) btn.classList.add('active');
        updateFocusParagraph();
        showToast('Focus Mode enabled - Press Esc to exit', 'info');
      } else {
        container.classList.remove('focus-mode-active');
        indicator.classList.remove('visible');
        if (btn) btn.classList.remove('active');
        clearFocusHighlight();
      }
    }

    function updateFocusParagraph() {
      if (!focusModeEnabled) return;

      clearFocusHighlight();

      const selection = window.getSelection();
      if (selection.rangeCount === 0) return;

      const range = selection.getRangeAt(0);
      let node = range.startContainer;

      // Find the nearest block-level element (p, div, li)
      while (node && node !== document.body) {
        if (node.nodeType === Node.ELEMENT_NODE) {
          const tagName = node.tagName.toLowerCase();
          if (['p', 'div', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote'].includes(tagName)) {
            node.classList.add('focus-current');
            return;
          }
        }
        node = node.parentNode;
      }
    }

    function clearFocusHighlight() {
      document.querySelectorAll('.focus-current').forEach(el => {
        el.classList.remove('focus-current');
      });
    }

    // Update focus on cursor movement
    document.addEventListener('selectionchange', function() {
      if (focusModeEnabled) {
        updateFocusParagraph();
      }
    });

    // Exit focus mode with Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && focusModeEnabled) {
        toggleFocusMode();
      }
    });

    // ==================== TYPEWRITER MODE ====================
    let typewriterModeEnabled = false;

    function toggleTypewriterMode() {
      typewriterModeEnabled = !typewriterModeEnabled;
      const container = document.querySelector('.app-container');
      const indicator = document.getElementById('typewriterIndicator');
      const btn = document.getElementById('typewriterModeBtn');

      if (typewriterModeEnabled) {
        container.classList.add('typewriter-mode-active');
        indicator.classList.add('visible');
        if (btn) btn.classList.add('active');
        scrollToCursor();
        showToast('Typewriter Mode enabled - cursor stays centered', 'info');
      } else {
        container.classList.remove('typewriter-mode-active');
        indicator.classList.remove('visible');
        if (btn) btn.classList.remove('active');
      }
    }

    function scrollToCursor() {
      if (!typewriterModeEnabled) return;

      const selection = window.getSelection();
      if (selection.rangeCount === 0) return;

      const range = selection.getRangeAt(0);
      const rect = range.getBoundingClientRect();

      if (rect.top && rect.left) {
        const editor = document.getElementById('editor');
        const editorRect = editor.getBoundingClientRect();
        const targetY = window.innerHeight / 2;
        const currentY = rect.top;
        const scrollAmount = currentY - targetY;

        editor.scrollBy({
          top: scrollAmount,
          behavior: 'smooth'
        });
      }
    }

    // Update typewriter scroll on input
    document.addEventListener('DOMContentLoaded', function() {
      const editor = document.getElementById('editor');
      if (editor) {
        editor.addEventListener('input', function() {
          if (typewriterModeEnabled) {
            setTimeout(scrollToCursor, 50);
          }
        });
        editor.addEventListener('keydown', function(e) {
          if (typewriterModeEnabled && ['Enter', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
            setTimeout(scrollToCursor, 50);
          }
        });
      }
    });

    // ==================== WORD FREQUENCY ANALYZER ====================
    let wordFreqData = [];
    let wordFreqFilter = 'all';

    const commonWords = new Set([
      'the', 'be', 'to', 'of', 'and', 'a', 'in', 'that', 'have', 'i',
      'it', 'for', 'not', 'on', 'with', 'he', 'as', 'you', 'do', 'at',
      'this', 'but', 'his', 'by', 'from', 'they', 'we', 'say', 'her', 'she',
      'or', 'an', 'will', 'my', 'one', 'all', 'would', 'there', 'their', 'what',
      'so', 'up', 'out', 'if', 'about', 'who', 'get', 'which', 'go', 'me',
      'when', 'make', 'can', 'like', 'time', 'no', 'just', 'him', 'know', 'take',
      'people', 'into', 'year', 'your', 'good', 'some', 'could', 'them', 'see', 'other',
      'than', 'then', 'now', 'look', 'only', 'come', 'its', 'over', 'think', 'also',
      'back', 'after', 'use', 'two', 'how', 'our', 'work', 'first', 'well', 'way',
      'even', 'new', 'want', 'because', 'any', 'these', 'give', 'day', 'most', 'us',
      'is', 'are', 'was', 'were', 'been', 'has', 'had', 'may', 'very', 'more'
    ]);

    function showWordFrequency() {
      analyzeWordFrequency();
      document.getElementById('wordFreqOverlay').classList.add('visible');
      document.getElementById('wordFreqPopup').classList.add('visible');
    }

    function hideWordFrequency() {
      document.getElementById('wordFreqOverlay').classList.remove('visible');
      document.getElementById('wordFreqPopup').classList.remove('visible');
    }

    function analyzeWordFrequency() {
      const editor = document.getElementById('editor');
      const text = editor.innerText || editor.textContent || '';

      // Extract words (letters only, lowercase)
      const words = text.toLowerCase().match(/\b[a-z]+\b/g) || [];

      // Count frequency
      const freq = {};
      words.forEach(word => {
        freq[word] = (freq[word] || 0) + 1;
      });

      // Convert to sorted array
      wordFreqData = Object.entries(freq)
        .map(([word, count]) => ({ word, count }))
        .sort((a, b) => b.count - a.count);

      // Calculate stats
      const totalWords = words.length;
      const uniqueWords = Object.keys(freq).length;
      const vocabRichness = totalWords > 0 ? ((uniqueWords / totalWords) * 100).toFixed(1) : 0;

      document.getElementById('wfTotalWords').textContent = totalWords.toLocaleString();
      document.getElementById('wfUniqueWords').textContent = uniqueWords.toLocaleString();
      document.getElementById('wfVocabRichness').textContent = vocabRichness + '%';

      // Render list
      renderWordFreqList();
    }

    function showWordFreqTab(filter) {
      wordFreqFilter = filter;

      // Update active tab
      document.querySelectorAll('.word-freq-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      renderWordFreqList();
    }

    function renderWordFreqList() {
      let filteredData = [...wordFreqData];

      if (wordFreqFilter === 'long') {
        filteredData = filteredData.filter(item => item.word.length >= 6);
      } else if (wordFreqFilter === 'nocommon') {
        filteredData = filteredData.filter(item => !commonWords.has(item.word));
      }

      const maxCount = filteredData.length > 0 ? filteredData[0].count : 1;
      const list = document.getElementById('wordFreqList');

      if (filteredData.length === 0) {
        list.innerHTML = '<li style="padding: 1rem; text-align: center; color: #666;">No words found</li>';
        return;
      }

      list.innerHTML = filteredData.slice(0, 30).map((item, i) => `
        <li class="word-freq-item">
          <span class="word-freq-rank">${i + 1}</span>
          <span class="word-freq-word">${item.word}</span>
          <span class="word-freq-count">${item.count}x</span>
          <div class="word-freq-bar">
            <div class="word-freq-bar-fill" style="width: ${(item.count / maxCount) * 100}%"></div>
          </div>
        </li>
      `).join('');
    }

    // Keyboard shortcut: Ctrl+Shift+W for word frequency
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        showWordFrequency();
      }
      if (e.key === 'Escape' && document.getElementById('wordFreqPopup').classList.contains('visible')) {
        hideWordFrequency();
      }
    });

    // ==================== DISTRACTION-FREE MODE ====================
    let dfModeActive = false;
    let dfContainer = null;
    let dfTheme = localStorage.getItem('ninjaword_df_theme') || 'light';

    function enterDistractionFreeMode() {
      if (dfModeActive) return;

      dfModeActive = true;
      const editor = document.getElementById('editor');
      const content = editor.innerHTML;

      // Create distraction-free container
      dfContainer = document.createElement('div');
      dfContainer.className = 'distraction-free-mode df-' + dfTheme;
      dfContainer.innerHTML = `
        <button class="df-exit" onclick="exitDistractionFreeMode()">‚úï Exit (Esc)</button>
        <div class="df-editor" contenteditable="true" id="dfEditor">${content}</div>
        <div class="df-stats" id="dfStats">0 words</div>
        <div class="df-theme-switcher">
          <button class="df-theme-btn light ${dfTheme === 'light' ? 'active' : ''}" onclick="setDFTheme('light')" title="Light"></button>
          <button class="df-theme-btn sepia ${dfTheme === 'sepia' ? 'active' : ''}" onclick="setDFTheme('sepia')" title="Sepia"></button>
          <button class="df-theme-btn dark ${dfTheme === 'dark' ? 'active' : ''}" onclick="setDFTheme('dark')" title="Dark"></button>
        </div>
      `;

      document.body.appendChild(dfContainer);

      // Focus editor
      const dfEditor = document.getElementById('dfEditor');
      dfEditor.focus();

      // Update stats on input
      dfEditor.addEventListener('input', updateDFStats);
      updateDFStats();

      // Try to enter fullscreen
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(() => {});
      }
    }

    function exitDistractionFreeMode() {
      if (!dfModeActive) return;

      // Sync content back to main editor
      const dfEditor = document.getElementById('dfEditor');
      if (dfEditor) {
        document.getElementById('editor').innerHTML = dfEditor.innerHTML;
      }

      // Remove container
      if (dfContainer) {
        dfContainer.remove();
        dfContainer = null;
      }

      dfModeActive = false;

      // Exit fullscreen
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(() => {});
      }

      showToast('Exited Zen Mode', 'info');
    }

    function setDFTheme(theme) {
      dfTheme = theme;
      localStorage.setItem('ninjaword_df_theme', theme);

      if (dfContainer) {
        dfContainer.className = 'distraction-free-mode df-' + theme;

        // Update theme buttons
        document.querySelectorAll('.df-theme-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.classList.contains(theme)) {
            btn.classList.add('active');
          }
        });
      }
    }

    function updateDFStats() {
      const dfEditor = document.getElementById('dfEditor');
      if (!dfEditor) return;

      const text = dfEditor.innerText || '';
      const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      const chars = text.length;

      document.getElementById('dfStats').textContent = `${words} words ¬∑ ${chars} characters`;
    }

    // Keyboard shortcuts for distraction-free mode
    document.addEventListener('keydown', function(e) {
      // F11 to enter distraction-free mode
      if (e.key === 'F11') {
        e.preventDefault();
        if (dfModeActive) {
          exitDistractionFreeMode();
        } else {
          enterDistractionFreeMode();
        }
      }

      // Escape to exit
      if (e.key === 'Escape' && dfModeActive) {
        exitDistractionFreeMode();
      }
    });

    // Exit on fullscreen change (when user exits fullscreen manually)
    document.addEventListener('fullscreenchange', function() {
      if (!document.fullscreenElement && dfModeActive) {
        // Don't auto-exit, let user stay in DF mode even without fullscreen
      }
    });

    // ==================== SMART TEXT REPLACEMENTS ====================
    const smartTextSettings = JSON.parse(localStorage.getItem('ninjaword_smart_text') || '{}');

    // Default settings
    const defaultSmartText = {
      smartQuotes: true,
      emDash: true,
      ellipsis: true,
      autoCapitalize: false,
      fractions: true,
      arrows: true
    };

    // Merge with defaults
    Object.keys(defaultSmartText).forEach(key => {
      if (smartTextSettings[key] === undefined) {
        smartTextSettings[key] = defaultSmartText[key];
      }
    });

    function showSmartText() {
      loadSmartTextSettings();
      document.getElementById('smartTextOverlay').classList.add('visible');
      document.getElementById('smartTextPopup').classList.add('visible');
    }

    function hideSmartText() {
      document.getElementById('smartTextOverlay').classList.remove('visible');
      document.getElementById('smartTextPopup').classList.remove('visible');
    }

    function loadSmartTextSettings() {
      document.getElementById('stSmartQuotes').checked = smartTextSettings.smartQuotes;
      document.getElementById('stEmDash').checked = smartTextSettings.emDash;
      document.getElementById('stEllipsis').checked = smartTextSettings.ellipsis;
      document.getElementById('stAutoCapitalize').checked = smartTextSettings.autoCapitalize;
      document.getElementById('stFractions').checked = smartTextSettings.fractions;
      document.getElementById('stArrows').checked = smartTextSettings.arrows;
    }

    function saveSmartTextSettings() {
      smartTextSettings.smartQuotes = document.getElementById('stSmartQuotes').checked;
      smartTextSettings.emDash = document.getElementById('stEmDash').checked;
      smartTextSettings.ellipsis = document.getElementById('stEllipsis').checked;
      smartTextSettings.autoCapitalize = document.getElementById('stAutoCapitalize').checked;
      smartTextSettings.fractions = document.getElementById('stFractions').checked;
      smartTextSettings.arrows = document.getElementById('stArrows').checked;

      localStorage.setItem('ninjaword_smart_text', JSON.stringify(smartTextSettings));
    }

    function showSmartTextIndicator(text) {
      const indicator = document.getElementById('smartTextIndicator');
      indicator.textContent = text;
      indicator.style.display = 'block';
      indicator.style.animation = 'none';
      indicator.offsetHeight; // Trigger reflow
      indicator.style.animation = 'smartTextFade 1.5s forwards';
    }

    // Smart text replacements
    const smartReplacements = {
      emDash: [
        { find: /--/g, replace: '‚Äî' }
      ],
      ellipsis: [
        { find: /\.\.\./g, replace: '‚Ä¶' }
      ],
      fractions: [
        { find: /\b1\/2\b/g, replace: '¬Ω' },
        { find: /\b1\/4\b/g, replace: '¬º' },
        { find: /\b3\/4\b/g, replace: '¬æ' },
        { find: /\b1\/3\b/g, replace: '‚Öì' },
        { find: /\b2\/3\b/g, replace: '‚Öî' },
        { find: /\b1\/8\b/g, replace: '‚Öõ' }
      ],
      arrows: [
        { find: /->/g, replace: '‚Üí' },
        { find: /<-/g, replace: '‚Üê' },
        { find: /=>/g, replace: '‚áí' },
        { find: /<=/g, replace: '‚áê' }
      ]
    };

    function applySmartReplacements(text) {
      let result = text;
      let changed = false;
      let changeType = '';

      // Em dash
      if (smartTextSettings.emDash) {
        smartReplacements.emDash.forEach(r => {
          if (r.find.test(result)) {
            result = result.replace(r.find, r.replace);
            changed = true;
            changeType = '-- ‚Üí ‚Äî';
          }
        });
      }

      // Ellipsis
      if (smartTextSettings.ellipsis) {
        smartReplacements.ellipsis.forEach(r => {
          if (r.find.test(result)) {
            result = result.replace(r.find, r.replace);
            changed = true;
            changeType = '... ‚Üí ‚Ä¶';
          }
        });
      }

      // Fractions
      if (smartTextSettings.fractions) {
        smartReplacements.fractions.forEach(r => {
          if (r.find.test(result)) {
            result = result.replace(r.find, r.replace);
            changed = true;
            changeType = 'Fraction';
          }
        });
      }

      // Arrows
      if (smartTextSettings.arrows) {
        smartReplacements.arrows.forEach(r => {
          if (r.find.test(result)) {
            result = result.replace(r.find, r.replace);
            changed = true;
            changeType = 'Arrow';
          }
        });
      }

      // Smart quotes
      if (smartTextSettings.smartQuotes) {
        // Opening double quote
        if (/(^|[\s(])"/.test(result)) {
          result = result.replace(/(^|[\s(])"/g, '$1\u201C');
          changed = true;
          changeType = 'Smart Quote';
        }
        // Closing double quote
        if (/"([\s.,!?;:)]|$)/.test(result)) {
          result = result.replace(/"([\s.,!?;:)]|$)/g, '\u201D$1');
          changed = true;
          changeType = 'Smart Quote';
        }
        // Opening single quote
        if (/(^|[\s(])'/.test(result)) {
          result = result.replace(/(^|[\s(])'/g, '$1\u2018');
          changed = true;
          changeType = 'Smart Quote';
        }
        // Closing single quote / apostrophe
        if (/'/.test(result)) {
          result = result.replace(/'/g, '\u2019');
          changed = true;
          changeType = 'Smart Quote';
        }
      }

      return { result, changed, changeType };
    }

    // Apply smart text on editor input
    document.addEventListener('DOMContentLoaded', function() {
      const editor = document.getElementById('editor');
      if (!editor) return;

      let lastText = '';

      editor.addEventListener('input', function(e) {
        // Get the text content of the current text node
        const selection = window.getSelection();
        if (selection.rangeCount === 0) return;

        const range = selection.getRangeAt(0);
        const node = range.startContainer;

        if (node.nodeType !== Node.TEXT_NODE) return;

        const text = node.textContent;
        if (text === lastText) return;

        const { result, changed, changeType } = applySmartReplacements(text);

        if (changed && result !== text) {
          const offset = range.startOffset;
          const diff = text.length - result.length;

          node.textContent = result;
          lastText = result;

          // Restore cursor position
          try {
            const newOffset = Math.max(0, Math.min(offset - diff, result.length));
            range.setStart(node, newOffset);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
          } catch (e) {}

          showSmartTextIndicator(changeType);
        }
      });

      // Auto-capitalize after sentence end
      editor.addEventListener('keypress', function(e) {
        if (!smartTextSettings.autoCapitalize) return;
        if (e.key !== ' ') return;

        const selection = window.getSelection();
        if (selection.rangeCount === 0) return;

        const range = selection.getRangeAt(0);
        const node = range.startContainer;

        if (node.nodeType !== Node.TEXT_NODE) return;

        const text = node.textContent;
        const offset = range.startOffset;

        // Check if previous chars end a sentence
        if (offset >= 2) {
          const prevTwo = text.substring(offset - 2, offset);
          if (/[.!?]\s$/.test(prevTwo + ' ')) {
            // Next character should be capitalized - handled by browser
          }
        }
      });
    });

    // Escape to close smart text popup
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('smartTextPopup').classList.contains('visible')) {
        hideSmartText();
      }
    });
  </script>
</body>
</html>
